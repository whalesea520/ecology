FastClick.attach(document.body);var CRM={lng:"",lat:"",posStatus:"0",getCurrentPosition:function(callbackFn){var that=this;that.posStatus="1";if(navigator.geolocation){MLocation.getCurrentPosition(function(position){that.lng=position.coords.longitude;that.lat=position.coords.latitude;that.posStatus="2";callbackFn.call(this);},function(error){that.posStatus="3";callbackFn.call(this);},{enableHighAcuracy:true,timeout:5000,maximumAge:3000});}},fixEmptyValue:function(v){if(v==null||v==""){v="无"}return v;},addJS:function(jsPath,fn){var headEle=document.getElementsByTagName("head")[0];var scriptEle=document.createElement("script");scriptEle.setAttribute("type","text/javascript");scriptEle.setAttribute("src",jsPath);if(typeof(fn)=="function"){scriptEle.onload=fn;}headEle.appendChild(scriptEle);},ajax:function(url,data,callback){if(typeof(data)=="function"){callback=data;data=null;}$.get(url,data,function(responseText){var result=$.parseJSON(responseText);var status=result["status"];if(status=="1"){callback.call(this,result);}else{var errMsg=result["errMsg"];alert(errMsg);}});},panelChange:function(page_in,page_out){var id_in=page_in.id,id_out="";if(!id_in)return;this.currPageId=id_in;var ele_link_in=null,ele_link_out=null;if(ele_link_in=document.querySelector("#crm_main .footer a[href$="+id_in+"]")){ele_link_in.classList.add("active");}if(page_out){id_out=page_out.id;ele_link_out=id_out&&document.querySelector("#crm_main .footer a[href$="+id_out+"]");ele_link_out&&ele_link_out.classList.remove("active");}$("#"+id_in+" .pop_menu").hide();},freshByTab:function(obj){var that=this;var $obj=$(obj);if($obj.hasClass("active")){var href=$obj.attr("href");var $crm_list=$(href);if($crm_list.length>0){var $content=$(".content",$crm_list);if(!$content.hasClass("list_refreshing")){var _scroll=that.crmListScroll[$crm_list.attr("id")];if(_scroll){var $pullDown=$(".scroll_scroller .pullDown",$crm_list);var h=0;if($pullDown.length>0){h=$pullDown.height();}$(".iScrollVerticalScrollbar",$crm_list).css("opacity","1");_scroll.scrollTo(0,-h,500,IScroll.utils.ease.quadratic);}}}}},currPageId:null,crmListPageNo:{},crmListPageSize:20,crmSearchCondition:{},refreshListTimestamp:{},pushSearchCondition:function(name,value){this.crmSearchCondition[this.currPageId][name]=value;},clearSearchCondition:function(){this.crmSearchCondition[this.currPageId]={};},crmListScroll:{},refreshCrmListScroll:function(){var that=this;if(that.crmListScroll[that.currPageId]){that.crmListScroll[that.currPageId].refresh();}},createScroll:function(selector,refreshCallback){var $wrap=$(selector);var $pullDown=$(".pullDown",$wrap);var pullDownEl=null;var pullDownOffset=0;if($pullDown.length>0){$pullDown.show();pullDownEl=$pullDown[0];pullDownOffset=pullDownEl.offsetHeight;}var _scroll=new IScroll(selector,{mouseWheel:true,topOffset:pullDownOffset,preventDefault:false,scrollbars:"custom",fadeScrollbars:true});if(pullDownEl!=null){_scroll.on('refresh',function(){if(pullDownEl.className.match('scroll_loading')){pullDownEl.className='pullDown';pullDownEl.querySelector('.pullDownLabel').innerHTML='下拉可以刷新';}});_scroll.on('scrollMove',function(){if(this.y>50&&!pullDownEl.className.match('flip')){pullDownEl.className='pullDown flip';pullDownEl.querySelector('.pullDownLabel').innerHTML='释放立即刷新';this.minScrollY=0;}else if(this.y<50&&pullDownEl.className.match('flip')){pullDownEl.className='pullDown';pullDownEl.querySelector('.pullDownLabel').innerHTML='下拉可以刷新';this.minScrollY=-pullDownOffset;}});_scroll.on('scrollEnd',function(){if(pullDownEl.className.match('flip')){pullDownEl.className='pullDown scroll_loading';pullDownEl.querySelector('.pullDownLabel').innerHTML='正在刷新...';if(typeof(refreshCallback)=="function"){refreshCallback.call(this);}}});}_scroll.refresh();$wrap.on("touchmove",function(e){e.preventDefault();});return _scroll;},buildCrmListPage:function(pageInto,pageOut,options){var that=this;var $crm_list=$("#crm_main .panel.in");that.currPageId=$crm_list.attr("id");that.crmListScroll[that.currPageId]=that.createScroll("#"+that.currPageId+" div.listContent",function(){that.downRefreshCrmList();});var $tab=$(".tab",$crm_list);function tabEvnInner(callbackFn){$("ul li",$tab).click(function(e,flag){if(typeof(callbackFn)=="function"){var returnV=callbackFn.call(this);if(returnV==false){return;}}if(!$(this).hasClass("selected")||flag=="1"){$(this).siblings("li.selected").removeClass("selected");$(this).addClass("selected");that.resetCrmSearch();that.refreshCrmList("tabChange");$(".pop_menu",$crm_list).hide();}});}if(that.currPageId=="crm_list"||that.currPageId=="crm_partner"||that.currPageId=="crm_people"){var $aroundTab=$("ul li.around",$tab);var rightV=$(window).width()-($aroundTab.offset().left+$aroundTab.width());var $popMenu=$(".pop_menu",$crm_list);$popMenu.css("right",rightV+"px");tabEvnInner(function(){if($(this).hasClass("around")){if(that.posStatus=="0"){var $allPopmenu=$("#crm_main .panel .pop_menu");var $pos_msg=$("li.pos_msg",$allPopmenu);$pos_msg.html("<a>定位中</a>");that.getCurrentPosition(function(){if(that.posStatus=="2"){$("ul",$allPopmenu).append("<li data-value=\"1\"><a>1km</a></li><li data-value=\"3\"><a>3km</a></li><li data-value=\"5\"><a>5km</a></li><li data-value=\"10\"><a>10km</a></li>");$pos_msg.remove();$("li",$allPopmenu).click(function(){var t=$(this).text();var raidus=$(this).attr("data-value");var expr=$(this).parent().attr("data-for");var $t=$(expr);$t.html(t);$t.attr("data-filter","&opt=around&raidus="+raidus+"&lng="+that.lng+"&lat="+that.lat);$t.siblings("li.selected").removeClass("selected");$t.addClass("selected");$(this).parent().parent().hide();that.resetCrmSearch();that.refreshCrmList();});}else{$pos_msg.html("<a>定位失败</a>")}});}$popMenu.toggle();return false;}else{if(!$(this).hasClass("selected")){$aroundTab.html("附近");}return true;}});}else{tabEvnInner();}$(".load_more",$crm_list).click(function(){that.loadCrmList();});$("form[disabledEnterSubmit]",$crm_list).keydown(function(event){if(event.keyCode==13){return false;}});var $searchBtn=$(".listSearch .btn",$crm_list);var $searchKey=$(".listSearch input",$crm_list);$searchBtn.click(function(){that.pushSearchCondition("searchKey",encodeURIComponent($searchKey.val()));that.refreshCrmList();$searchKey[0].blur();});$searchKey.on("input",function(){$("#crm_search input[data-fieldname='searchKey']").val($(this).val());}).keyup(function(event){if(event.keyCode==13){$searchBtn.triggerHandler("click");}});$("ul li",$tab).eq(0).triggerHandler("click");},refreshCrmList:function(_action){var that=this;that.crmListPageNo[that.currPageId]=0;var $crm_list=$("#crm_main .panel.in");if(_action=="tabChange"){that.buildCrmListFormCache(that.currPageId);}$(".content",$crm_list).addClass("list_refreshing");setTimeout(function(){that.refreshCrmListScroll();},300);that.loadCrmList(true,_action);},buildCrmListFormCache:function(pageid){var that=this;var $page=$("#"+pageid);var $list=$(".list",$page);var html="";if(localStorage){var tabId=$(".tab ul li.selected",$page).attr("data-tabId");var cacheKey="CRM_List_"+pageid+"_"+tabId+"_"+E3005CF26D9F9AC78773E16572827297;var listData=localStorage.getItem(cacheKey);if(listData!=null){listData=JSON.parse(listData);var buildHtmlFunc="build"+pageid.replace(/^c|_[\w]/g,function(matchs){if(matchs.indexOf('_')!=-1){matchs=matchs.substring(1);}return matchs.toUpperCase();})+"Html";html=that[buildHtmlFunc](listData);}}$list.html(html);if(pageid=="crm_business"){$("canvas",$list).drawPercent();}that.refreshCrmListScroll();},updateCrmListCache:function(pageid,listData){if(localStorage){var $page=$("#"+pageid);var tabId=$(".tab ul li.selected",$page).attr("data-tabId");var cacheKey="CRM_List_"+pageid+"_"+tabId+"_"+E3005CF26D9F9AC78773E16572827297;localStorage.removeItem(cacheKey);localStorage.setItem(cacheKey,JSON.stringify(listData));}},downRefreshCrmList:function(){var that=this;that.crmListPageNo[that.currPageId]=0;that.loadCrmList(true);},crmListRequestAction:{"crm_list":"getCustomerList","crm_business":"getBusinessList","crm_partner":"getCustomerList","crm_people":"getCustomerList"},loadCrmList:function(unShowloading,_action){var that=this;var timestamp=(new Date()).valueOf();var currPageId=that.currPageId;that.refreshListTimestamp[currPageId]=timestamp;that.crmListPageNo[currPageId]++;var url="/mobilemode/apps/e-cology/crm/crmAction.jsp?action="+that.crmListRequestAction[currPageId]+"&type="+currPageId+"&pageNo="+that.crmListPageNo[currPageId]+"&pageSize="+that.crmListPageSize;var $crm_list=$("#crm_main .panel.in");var $currTab=$(".tab ul li.selected",$crm_list);var filter=$currTab.attr("data-filter")||"";url=url+filter;var $loading=$(".crm_loading",$crm_list);if(unShowloading!=true){$loading.show();}var $load_more=$(".load_more",$crm_list);$load_more.hide();that.ajax(url,that.crmSearchCondition[currPageId],function(result){if(timestamp!=that.refreshListTimestamp[currPageId]){return;}$loading.hide();var $list=$(".list",$crm_list);if(that.crmListPageNo[currPageId]==1){$list.find("*").remove();that.refreshCrmListScroll();}var datas=result["datas"];var buildHtmlFunc="build"+currPageId.replace(/^c|_[\w]/g,function(matchs){if(matchs.indexOf('_')!=-1){matchs=matchs.substring(1);}return matchs.toUpperCase();})+"Html";var html=that[buildHtmlFunc](datas);$list.append(html);if(currPageId=="crm_business"){$("canvas",$list).drawPercent();}else{$(".contactinfo[data-loaded='0']",$list).each(function(){that.loadCrmContactInfo($(this),currPageId);});}ToucherUtil.swipeList($list,".slideBtnContainer");var totalSize=result["totalSize"];if(totalSize<=0){$(".no_data",$crm_list).show();}else{$(".no_data",$crm_list).hide();}var totalPageCount;if(totalSize%that.crmListPageSize==0){totalPageCount=totalSize/that.crmListPageSize;}else{totalPageCount=parseInt(totalSize/that.crmListPageSize)+1;}if(that.crmListPageNo[currPageId]>=totalPageCount){$load_more.hide();}else{$load_more.show();}if(_action=="tabChange"){that.updateCrmListCache(currPageId,datas);}$(".content",$crm_list).removeClass("list_refreshing");setTimeout(function(){that.refreshCrmListScroll();},300);that.refreshCrmListScroll();});},loadCrmContactInfo:function($contactinfo,pageid){var that=this;var loaded=$contactinfo.attr("data-loaded");if(loaded!="0"){return;}$contactinfo.attr("data-loaded","1");var tabId=null;if(pageid){var $page=$("#"+pageid);tabId=$(".tab ul li.selected",$page).attr("data-tabId");}var customerid=$contactinfo.attr("data-customerid");that.ajax("/mobilemode/apps/e-cology/crm/crmAction.jsp?action=getLastContactRecord&id="+customerid,function(result){var d=result["data"];var contactdate=d["contactdate"];var days=d["days"];var html=that.createCrmContactHtml(contactdate,days);$contactinfo.html(html);if(pageid){try{that.crmListScroll[pageid].refresh();}catch(e){}var cacheKey="CRM_List_"+pageid+"_"+tabId+"_"+E3005CF26D9F9AC78773E16572827297;var listData=localStorage.getItem(cacheKey);if(listData!=null){listData=JSON.parse(listData);for(var i=0;i<listData.length;i++){var da=listData[i];var id=da["id"];if(id==customerid){da["contactdate"]=contactdate;da["days"]=days;break;}}localStorage.setItem(cacheKey,JSON.stringify(listData));}}});},createCrmContactHtml:function(contactdate,days){var cd="";if(contactdate==""){cd="<span style=\"color:red;\">无记录</span>";}else{cd=contactdate.replace("-","/").replace("-","/").replace("/0","/").replace("/0","/");}var cl="";if(days>0){cl="("+days+"天未联系)";}var html=cd+" <span style=\"color:red;font-size: 12px;\">"+cl+"</span>";return html;},setCrmAttention:function(objid,settype,operatetype,event){var that=this;var $box=$(event.target);$box.closest("li").trigger("swipeRight");that.ajax("/mobilemode/apps/e-cology/crm/crmAction.jsp?action=doAttention&id="+objid+"&settype="+settype+"&operatetype="+operatetype,function(result){var $common_msg=$("#crm_main > .common_msg");$common_msg.show().addClass("show");setTimeout(function(){$common_msg.removeClass("show").hide();},1000);});setTimeout(function(){if(settype=="1"){$box.parent().removeClass("status_0").addClass("status_1");}else{$box.parent().removeClass("status_1").addClass("status_0");}},300);event.stopPropagation();},buildCrmListHtml:function(datas){var that=this;var html="";for(var i=0;i<datas.length;i++){var d=datas[i];var contactdate=d["contactdate"];var days=d["days"];var contactinfoHtml="";if(typeof(contactdate)!="undefined"&&typeof(days)!="undefined"){contactinfoHtml=that.createCrmContactHtml(contactdate,days);}else{contactinfoHtml="<span class=\"contactinfo\" data-customerid=\""+d["id"]+"\" data-loaded=\"0\">...</span>";}var statusHtml="";var status=d["status"];if(status!=""){statusHtml="<div class=\"flag flag"+d["statusId"]+"\">"+status+"</div>";}var distance=d["distance"];var distanceHtml="";var distanceStyle="";if(distance&&$.trim(distance)!=""){distanceHtml="<div class=\"distance\">"+distance+"m</div>";distanceStyle="padding-right:60px;";}html+="<li>"+"<a href=\"/mobilemode/apps/e-cology/crm/customer.jsp\" data-formdata=\"id="+d["id"]+"\">"+statusHtml
+"<div class=\"title\">"+d["name"]+"</div>"+"<div style=\""+distanceStyle+"\">客户经理: "+d["manager"]+",最近联系: "+contactinfoHtml+"</div>"+distanceHtml
+"</a>"+"<div class=\"slideBtnContainer\">"+"<div class=\"btnContainer status_"+d["attention"]+"\">"+"<div class=\"btnBox box_0\" style=\"background-color: #da8e2c;\" onclick=\"CRM.setCrmAttention("+d["id"]+",'1','1',event)\">标记关注</div>"+"<div class=\"btnBox box_1\" style=\"background-color: #d83202;\" onclick=\"CRM.setCrmAttention("+d["id"]+",'0','1',event)\">取消关注</div>"+"</div>"+"</div>"+"</li>";}return html;},buildCrmPartnerHtml:function(datas){return this.buildCrmListHtml(datas);},buildCrmPeopleHtml:function(datas){return this.buildCrmListHtml(datas);},buildCrmBusinessHtml:function(datas){var html="";for(var i=0;i<datas.length;i++){var d=datas[i];var statusHtml="";var status=d["sellstatus"];if(status!=""){statusHtml="<div class=\"flag flag"+d["sellstatusid"]+"\">"+status+"</div>";}var preyield=d["preyield"];if(preyield>0){preyield=preyield+"万";}html+="<li>"+"<a href=\"/mobilemode/apps/e-cology/crm/sellchance.jsp\" data-formdata=\"id="+d["id"]+"\">"+"<canvas width='80' height='80' data-value=\""+d["probability"]+"\"></canvas>"+statusHtml
+"<div class=\"title\">"+d["subject"]+"</div>"+"<div class=\"desc\">客户经理: "+d["creater"]+"，客户: "+d["customername"]+"，预期收益: "+preyield+"</div>"+"</a>"+"<div class=\"slideBtnContainer\">"+"<div class=\"btnContainer status_"+d["attention"]+"\">"+"<div class=\"btnBox box_0\" style=\"background-color: #da8e2c;\" onclick=\"CRM.setCrmAttention("+d["id"]+",'1','2',event)\">标记关注</div>"+"<div class=\"btnBox box_1\" style=\"background-color: #d83202;\" onclick=\"CRM.setCrmAttention("+d["id"]+",'0','2',event)\">取消关注</div>"+"</div>"+"</div>"+"</li>";}return html;},buildCrmSearchPage:function(pageInto,pageOut,options){var that=this;var $crmSearch=$("#crm_search");$(".clear-btn",$crmSearch).click(function(){var $field=$(this).parents(".field[data-flag]");if($field.length>0){var flag=$field.attr("data-flag");that.setCrmSearchValue("","",flag,false);}});$(".hori_check",$crmSearch).click(function(e){if(e.target&&e.target.tagName.toLowerCase()=="li"){var $this=$(e.target);var $realField=$this.parent().siblings("input[data-fieldname]");if($this.hasClass("checked")){var type=$this.parent().attr("data-type");if(type=="CAN_CANCEL"){$this.removeClass("checked");$realField.val("");}}else{$this.siblings("li.checked").removeClass("checked");$this.addClass("checked");var v=$this.attr("data-value");$realField.val(v);}}});that.ajax("/mobilemode/apps/e-cology/crm/crmAction.jsp?action=getLabel",function(result){var datas=result["datas"];var html="";for(var i=0;i<datas.length;i++){var d=datas[i];html+="<li data-value=\""+d["id"]+"\">"+d["name"]+"</li>";}$(".field[data-flag='label'] .hori_check",$crmSearch).html(html);});$("form[disabledEnterSubmit]",$crmSearch).keydown(function(event){if(event.keyCode==13){return false;}});var $searchBtn=$("#crm_search .header .right");var $searchKey=$("input[data-fieldname='searchKey']",$crmSearch);$searchBtn.click(function(){$("input[data-fieldname]",$crmSearch).each(function(){var v=$(this).val();if(v==null){v="";}var name=$(this).attr("data-fieldname");that.pushSearchCondition(name,v);});that.refreshCrmList();$searchKey[0].blur();history.go(-1);});$searchKey.on("input",function(){$("#crm_list .listSearch input").val($(this).val());}).keyup(function(event){if(event.keyCode==13){$searchBtn.triggerHandler("click");}});},refreshCustomerPageContacter:function(id){var that=this;var $crm_cust=$("#crm_cust");that.ajax("/mobilemode/apps/e-cology/crm/crmAction.jsp?action=getCustomer&id="+id,function(result){var data=result["data"];var contacter=that.fixEmptyValue(data["contacter"]);var contacterCount=data["contacterCount"];if(contacterCount>0){contacter="<a href=\"/mobilemode/apps/e-cology/crm/crmContacts.jsp\" data-formdata=\"id="+id+"\">"+contacter+"<div class=\"moreNumber\">"+contacterCount+"</div></a>";}$("[data-field='contacter']",$crm_cust).html(contacter);});},crmSearchPageShow:function(pageInto,pageOut,options){var that=this;if(options.target){var $crmSearch=$("#crm_search");var $searchMy=$(".search_my",$crmSearch);var $tabSel=$("#"+that.currPageId+" .tab ul li.selected");if($tabSel.index()==0){$searchMy.show();}else{$searchMy.hide();}}},resetCrmSearch:function(){var that=this;var $crmSearch=$("#crm_search");$(".field[data-flag]",$crmSearch).each(function(){var flag=$(this).attr("data-flag");var v="";if(flag=="managerType"){v="my";}that.setCrmSearchValue(v,"",flag,false);});var $crm_list=$("#"+that.currPageId);var $searchKey=$(".listSearch input",$crm_list);$searchKey.val("");that.clearSearchCondition();},setCrmSearchValue:function(value,text,flag,isBack){var $field=$("#crm_search .field[data-flag='"+flag+"']");var $realField=$("input[data-fieldname='"+flag+"']",$field);$realField.val(value);if(value==""){$field.removeClass("hasValue");}else{$field.addClass("hasValue");}var $more=$(".more",$field);if($more.length>0){$(".text",$more).html(text);}var $horiCheck=$realField.siblings(".hori_check");if($horiCheck.length>0){$("li",$horiCheck).removeClass("checked");if(value!=""){$("li[data-value='"+value+"']",$horiCheck).addClass("checked");}}if(isBack==true){history.go(-1);}},buildCustomerPage:function(id,canEdit){var that=this;var $crm_cust=$("#crm_cust");var $popMenu=$(".pop_menu",$crm_cust);$(".header .addBtn",$crm_cust).click(function(e){$popMenu.toggle();e.stopPropagation();});$crm_cust.click(function(){$popMenu.hide();});that.ajax("/mobilemode/apps/e-cology/crm/crmAction.jsp?action=getCustomer&id="+id,function(result){var data=result["data"];$(".header .left",$crm_cust).html(data["name"]);var managerHtml=data["manager"];if(canEdit){var managerid=data["managerid"];var callbackData=id+"_"+managerid;managerHtml+="<span onclick=\"CRM.confrimChangeCrmManager('"+callbackData+"');\" style=\"display: inline;float: right;color: #0161c9;text-decoration: underline;\">修改</span>";}$("[data-field='manager']",$crm_cust).html(managerHtml);var address=data["address"];if(address!=""){address="<a href=\"/mobilemode/apps/e-cology/crm/custAddr.jsp\" data-formdata=\"id="+id+"\">"+address+"</a>";}else{address="无";}$("[data-field='address']",$crm_cust).html(address);$("[data-field='status_rating']",$crm_cust).html(that.fixEmptyValue(data["status"])+", "+that.fixEmptyValue(data["rating"]));$("[data-field='size_n_sector']",$crm_cust).html(that.fixEmptyValue(data["size_n"])+", "+that.fixEmptyValue(data["sector"]));var sellChance=that.fixEmptyValue(data["sellChance"]);var sellChanceCount=data["sellChanceCount"];if(sellChanceCount>0){sellChance="<a href=\"/mobilemode/apps/e-cology/crm/crmSellChance.jsp\" data-formdata=\"id="+id+"\">"+sellChance+"<div class=\"moreNumber\">"+sellChanceCount+"</div></a>";}$("[data-field='sellChance']",$crm_cust).html(sellChance);var contacter=that.fixEmptyValue(data["contacter"]);var contacterCount=data["contacterCount"];if(contacterCount>0){contacter="<a href=\"/mobilemode/apps/e-cology/crm/crmContacts.jsp\" data-formdata=\"id="+id+"\">"+contacter+"<div class=\"moreNumber\">"+contacterCount+"</div></a>";}$("[data-field='contacter']",$crm_cust).html(contacter);$(".moreNumber",$crm_cust).each(function(){var h=$(this).parent("a").height()-$(this).height();if(h<0){h=0;}$(this).css("top",(h/2)+"px");});});$(".load_more",$crm_cust).click(function(){that.loadContactRecordList(id);});that.refreshContactRecordList(id);},confrimChangeCrmManager:function(callbackData){Mobilebone.ajax({url:"/mobilemode/apps/e-cology/crm/hrmList.jsp?flag=changeCrmManager&callback=CRM.changeCrmManager&callbackData="+callbackData});return;},changeCrmManager:function(id,name,callbackData){var that=this;if(id!=""&&callbackData){var cArr=callbackData.split("_");var customerid=cArr[0];var oldManagerid=cArr[1];if(id!=oldManagerid){var $crm_cust=$("#crm_cust");var $common_msg=$(".common_msg",$crm_cust);setTimeout(function(){$common_msg.html("操作中，请稍后...").show().addClass("show");that.ajax("/mobilemode/apps/e-cology/crm/crmAction.jsp?action=changeCrmManager&customerid="+customerid+"&newmanagerid="+id+"&oldmanagerid="+oldManagerid,function(result){var managerHtml=name;var callbackData=customerid+"_"+id;managerHtml+="<span onclick=\"CRM.confrimChangeCrmManager('"+callbackData+"');\" style=\"display: inline;float: right;color: #0161c9;text-decoration: underline;\">修改</span>";$("[data-field='manager']",$crm_cust).html(managerHtml);$common_msg.html("修改成功").show().addClass("show");setTimeout(function(){$common_msg.removeClass("show").hide();history.go(-1);that.refreshCrmList();},1000);});},250);}else{}}},crmRecordListPageSize:10,resetCrmRecordListPageNo:function(id){var that=this;eval("that.crmRecordListPageNo_"+id+" = 0;");},refreshContactRecordList:function(id){var that=this;that.resetCrmRecordListPageNo(id);that.loadContactRecordList(id);},loadContactRecordList:function(id){var that=this;eval("that.crmRecordListPageNo_"+id+"++;");eval("var pageNo = that.crmRecordListPageNo_"+id+";");var url="/mobilemode/apps/e-cology/crm/crmAction.jsp?action=getContactRecordList&pageNo="+pageNo+"&pageSize="+that.crmRecordListPageSize+"&id="+id;var $crm_cust=$("#crm_cust");var $loading=$(".crm_loading",$crm_cust);$loading.show();var $load_more=$(".load_more",$crm_cust);$load_more.hide();var $no_data=$(".no_data",$crm_cust);$no_data.hide();that.ajax(url,function(result){$loading.hide();var $list=$(".list",$crm_cust);if(pageNo==1){$list.find("*").remove();}var datas=result["datas"];var html="";for(var i=0;i<datas.length;i++){var d=datas[i];var contacter=d["contacter"];var sellchance=d["sellchance"];var contacterHtm="";if(contacter!=""){contacterHtm="相关联系人："+contacter;}var sellchanceHtm="";if(sellchance!=""){sellchanceHtm="商机："+sellchance;}var ht="";if(contacterHtm!=""&&sellchanceHtm!=""){ht=contacterHtm+" , "+sellchanceHtm;}else{ht=(contacterHtm=="")?((sellchanceHtm=="")?"":sellchanceHtm):contacterHtm;}html+="<li>"+"<img src=\""+d["avator"]+"\"/>"+"<div>"+d["creater"]+"</div>"+"<div>"+d["createdate"]+" "+d["createtime"]+"</div>"+"<div>"+d["description"]+"</div>"+((ht=="")?"":"<div>"+ht+"</div>")+"</li>";}$list.append(html);var totalSize=result["totalSize"];if(totalSize<=0){$no_data.show();}var totalPageCount;if(totalSize%that.crmRecordListPageSize==0){totalPageCount=totalSize/that.crmRecordListPageSize;}else{totalPageCount=parseInt(totalSize/that.crmRecordListPageSize)+1;}if(pageNo>=totalPageCount){$load_more.hide();}else{$load_more.show();}});}};Mobilebone.rootTransition=CRM;Mobilebone.evalScript=true;$.fn.drawPercent=function(){for(var i=0;i<this.length;i++){var canvas=this[i];if($(canvas).attr("drawed")=="true"){continue;}var cts=null;if(canvas.getContext){cts=canvas.getContext('2d');}else{continue;}var process=parseInt($(canvas).attr("data-value"));var x=40,y=40,radius=40,backColor='#e5e5e5',proColor='#0161c9',fontColor='#0161c9';cts.beginPath();cts.moveTo(x,y);cts.arc(x,y,radius,0,Math.PI*2,false);cts.closePath();cts.fillStyle=backColor;cts.fill();cts.beginPath();cts.moveTo(x,y);cts.arc(x,y,radius,Math.PI*1.5,Math.PI*1.5-Math.PI*2*process/100,true);cts.closePath();cts.fillStyle=proColor;cts.fill();cts.beginPath();cts.moveTo(x,y);cts.arc(x,y,radius-(radius*0.2),0,Math.PI*2,true);cts.closePath();cts.fillStyle='rgba(255,255,255,1)';cts.fill();cts.font="normal 20px arial";cts.fillStyle=fontColor;cts.textAlign='center';cts.textBaseline='middle';cts.moveTo(x,y);cts.fillText(process+"%",x,y);$(canvas).attr("drawed","true");}};