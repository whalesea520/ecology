
<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ page import="weaver.common.xtable.*" %>		
<%@ include file="/systeminfo/init_wev8.jsp" %>
<jsp:useBean id="CustomerTypeComInfo" class="weaver.crm.Maint.CustomerTypeComInfo" scope="page"/>
<jsp:useBean id="ContactWayComInfo" class="weaver.crm.Maint.ContactWayComInfo" scope="page"/>
<jsp:useBean id="CustomerIntentComInfo" class="weaver.crm.channel.CustomerIntentComInfo" scope="page"/>
<jsp:useBean id="CustomerBizTypeComInfo" class="weaver.crm.channel.CustomerBizTypeComInfo" scope="page"/>
<jsp:useBean id="CustomerDeputizeBrandComInfo" class="weaver.crm.channel.CustomerDeputizeBrandComInfo" scope="page"/>
<jsp:useBean id="CustomerProjectPhaseComInfo" class="weaver.crm.channel.CustomerProjectPhaseComInfo" scope="page"/>
<jsp:useBean id="CityComInfo" class="weaver.hrm.city.CityComInfo" scope="page"/>
<jsp:useBean id="ProvinceComInfo" class="weaver.hrm.province.ProvinceComInfo" scope="page"/>
<jsp:useBean id="CommonTransUtil" class="weaver.crm.channel.CommonTransUtil" scope="page"/>
<jsp:useBean id="RecordSet" class="weaver.conn.RecordSet" scope="page" />
<HTML>
	<HEAD>
		<LINK href="/css/Weaver_wev8.css" type=text/css rel=STYLESHEET>
		<SCRIPT language="javascript" src="/js/weaver_wev8.js"></script>
		<SCRIPT language="javascript" src="/js/datetime_wev8.js"></script>
		<SCRIPT language="javascript" src="/js/selectDateTime_wev8.js"></script>
		<SCRIPT language="javascript" src="/js/JSDateTime/WdatePicker_wev8.js"></script>
		<link rel='stylesheet' type='text/css' href='/js/extjs/resources/css/ext-all_wev8.css' />
		<link rel='stylesheet' type='text/css' href='/js/extjs/resources/css/xtheme-gray_wev8.css'/>
		<link rel='stylesheet' type='text/css' href='/css/weaver-ext_wev8.css' />
		<script type='text/javascript' src='/js/extjs/adapter/ext/ext-base_wev8.js'></script>
		<script type='text/javascript' src='/js/extjs/ext-all_wev8.js'></script>   
		<%if(user.getLanguage()==7) {%>
			<script type='text/javascript' src='/js/extjs/build/locale/ext-lang-zh_CN_gbk_wev8.js'></script>
			<script type='text/javascript' src='/js/weaver-lang-cn-gbk_wev8.js'></script>
		<%} else if(user.getLanguage()==8) {%>
			<script type='text/javascript' src='/js/extjs/build/locale/ext-lang-en_wev8.js'></script>
			<script type='text/javascript' src='/js/weaver-lang-en-gbk_wev8.js'></script>
		<%} else if(user.getLanguage()==9) {%>
			<script type='text/javascript' src='/js/extjs/build/locale/ext-lang-zh_TW_wev8.js'></script>
			<script type='text/javascript' src='/js/weaver-lang-tw-gbk_wev8.js'></script>
		<%}%>
		<script type="text/javascript" src="/js/WeaverTableExt_wev8.js"></script>  
		<link rel="stylesheet" type="text/css" href="/css/weaver-ext-grid_wev8.css" />
	</head>
	<%
		boolean advance = false;
		if(HrmUserVarify.checkUserRight("CustomerChannelBaseMaint:View", user)){
			advance = true;
		}
	
		String imagefilename = "/images/hdReport_wev8.gif";
		String titlename = SystemEnv.getHtmlLabelName(26825, user.getLanguage());//开拓客户列表
		String needfav = "1";
		String needhelp = "";
		
		//查询用户定制的每页显示条数
		String userid = ""+user.getUID();
		String loginType = ""+user.getLogintype();
		int perpage=20;
		char flag = 2;
		String ProcPara = userid+flag+loginType;
		RecordSet.executeProc("CRM_Customize_SelectByUid",ProcPara);
		if(RecordSet.getCounts()>0){
			RecordSet.first();
			perpage=RecordSet.getInt("perpage");
		}
		
		int display = Util.getIntValue(request.getParameter("display"), 0);

		String customerName = Util.fromScreen3(request.getParameter("customerName"), user.getLanguage());
		
		String typeId = Util.fromScreen3(request.getParameter("typeId"), user.getLanguage());
		String typeName = CustomerTypeComInfo.getCustomerTypename(typeId);
		
		String sourceId = Util.fromScreen3(request.getParameter("sourceId"), user.getLanguage());
		String sourceName = ContactWayComInfo.getContactWayname(sourceId);
		
		String intentId = Util.fromScreen3(request.getParameter("intentId"), user.getLanguage());
		String intentName = CustomerIntentComInfo.getName(intentId);
		
		String bizTypeId = Util.fromScreen3(request.getParameter("bizTypeId"), user.getLanguage());
		String bizTypeName = CustomerBizTypeComInfo.getName(bizTypeId);
		
		String deputizeBrandId = Util.fromScreen3(request.getParameter("deputizeBrandId"), user.getLanguage());
		String deputizeBrandName = CustomerDeputizeBrandComInfo.getName(deputizeBrandId);
		
		String projectPhaseId = Util.fromScreen3(request.getParameter("projectPhaseId"), user.getLanguage());
		String projectPhaseName = CustomerProjectPhaseComInfo.getName(projectPhaseId);
		
		String exploiterIds = "";
		if(advance){
			exploiterIds = Util.fromScreen3(request.getParameter("exploiterIds"), user.getLanguage());
		}else{
			exploiterIds = user.getUID()+"";
		}
		String exploiterName = CommonTransUtil.getPerson(exploiterIds);
		
		String managerIds = Util.fromScreen3(request.getParameter("managerIds"), user.getLanguage());
		String managerName = CommonTransUtil.getPerson(managerIds);
		
		String keyContact = Util.fromScreen3(request.getParameter("keyContact"), user.getLanguage());
		
		String createDateFrom = Util.fromScreen3(request.getParameter("createDateFrom"), user.getLanguage());
		String createDateTo = Util.fromScreen3(request.getParameter("createDateTo"), user.getLanguage());
		
		String agentName = Util.fromScreen3(request.getParameter("agentName"), user.getLanguage());
		
		String nocontactfromdate = Util.fromScreen3(request.getParameter("nocontactfromdate"), user.getLanguage());
		String nocontacttodate = Util.fromScreen3(request.getParameter("nocontacttodate"), user.getLanguage());
		
		String contactfromdate = Util.fromScreen3(request.getParameter("contactfromdate"), user.getLanguage());
		String contacttodate = Util.fromScreen3(request.getParameter("contacttodate"), user.getLanguage());
		
		String contacterId = Util.fromScreen3(request.getParameter("contacterId"), user.getLanguage());
		String contacterName = CommonTransUtil.getPerson(contacterId);
		
		String provinceId = Util.fromScreen3(request.getParameter("CustomerProvince"), user.getLanguage());
		String cityId = Util.fromScreen3(request.getParameter("CustomerCity"), user.getLanguage());
		
		
		String sqlWhere = " where t1.id=t2.customerId ";

		if(!customerName.equals("")){
			sqlWhere += " and t1.name like '%"+customerName+"%'";
		}
		
		if(!typeId.equals("")){
			sqlWhere += " and t1.type = " + typeId;
		}
		if(!sourceId.equals("")){
			sqlWhere += " and t1.source = " + sourceId;
		}
		if(!intentId.equals("")){
			sqlWhere += " and t2.intentId = " + intentId;
		}
		if(!bizTypeId.equals("")){
			sqlWhere += " and t2.bizTypeId = " + bizTypeId;
		}
		if(!deputizeBrandId.equals("")){
			sqlWhere += " and t2.deputizeBrandId = " + deputizeBrandId;
		}
		if(!managerIds.equals("")){
			sqlWhere += " and t1.manager in ("+managerIds+")";
		}
		if(!exploiterIds.equals("")){
			sqlWhere += " and t2.exploiterId in ("+exploiterIds+")";
		}
		if(!keyContact.equals("")){
			sqlWhere += " and t2.keyContact = " + keyContact;
		}
		
		if(!createDateFrom.equals("")){
			//sqlWhere += " and (select min(t4.submitdate) from CRM_Log t4 where t1.id=t4.customerid and t4.logtype='n') >= '"+createDateFrom+"'";
			sqlWhere += " and t1.createdate >= '"+createDateFrom+"'";
		}
		if(!createDateTo.equals("")){
			//sqlWhere += " and (select min(t4.submitdate) from CRM_Log t4 where t1.id=t4.customerid and t4.logtype='n') <= '"+createDateTo+"'";
			sqlWhere += " and t1.createdate <= '"+createDateTo+"'";
		}
		
		if(!agentName.equals("")){
			sqlWhere += " and exists (select 1 from CRM_CustomerInfo t5 where t5.id=t1.agent and t5.name like '%"+agentName+"%')";
		}
		
		if(!nocontactfromdate.equals("") || !nocontacttodate.equals("")){
			sqlWhere += " and NOT EXISTS " 
						    + " (SELECT a.id FROM WorkPlan a " 
							  + " WHERE a.type_n = '3' and a.crmid = CONVERT(varchar,t1.id) ";
			
			if(!nocontactfromdate.equals("")){
				sqlWhere += " AND a.begindate>='"+nocontactfromdate+"'";
			}
			if(!nocontacttodate.equals("")){
				sqlWhere += " AND a.begindate<='"+nocontacttodate+"'";
			}
			if(!contacterId.equals("")){
				sqlWhere += " AND a.createrid="+contacterId;
			}
			sqlWhere += ")";
		}
		if(!contactfromdate.equals("") || !contacttodate.equals("")){
			sqlWhere += " and EXISTS " 
						    + " (SELECT a.id FROM WorkPlan a " 
							  + " WHERE a.type_n = '3' and a.crmid = CONVERT(varchar,t1.id) ";
			
			if(!contactfromdate.equals("")){
				sqlWhere += " AND a.begindate>='"+contactfromdate+"'";
			}
			if(!contacttodate.equals("")){
				sqlWhere += " AND a.begindate<='"+contacttodate+"'";
			}
			if(!contacterId.equals("")){
				sqlWhere += " AND a.createrid="+contacterId;
			}
			sqlWhere += ")";
		}
		if(!provinceId.equals("")){
			sqlWhere += " and t1.province = " + provinceId;
		}
		if(!cityId.equals("")){
			sqlWhere += " and t1.city = " + cityId;
		}
	%>
	<BODY  style="overflow: hidden">
		<%@ include file="/systeminfo/TopTitle_wev8.jsp" %>
		<%@ include file="/systeminfo/RightClickMenuConent_wev8.jsp" %>
		<%
			RCMenu += "{" + SystemEnv.getHtmlLabelName(197, user.getLanguage()) + ",javascript:onSearch();,_self} ";
			RCMenuHeight += RCMenuHeightStep;
			
			RCMenu += "{" + "Excel,javascript:exportExcel(),_top} ";
			RCMenuHeight += RCMenuHeightStep;
			
			//if (HrmUserVarify.checkUserRight("CE_CustomerSystemRecordMaint:Log", user)) {
			//	RCMenu += "{" + SystemEnv.getHtmlLabelName(17480, user.getLanguage()) + ",CustomerSystemRecordLogList.jsp,_self} ";
			//	RCMenuHeight += RCMenuHeightStep;
			//}
		%>
		<%@ include file="/systeminfo/RightClickMenu_wev8.jsp" %>
		<form id="frmMain" name="frmMain" action="CustomerExploitList.jsp" method="post">
		<input id="display" name="display" type="hidden" value="<%=display %>">
		<table width=100% height=96% border="0" cellspacing="0" cellpadding="0" valign="top">
			<colgroup>
				<col width="10">
				<col width="">
				<col width="10">
			</colgroup>
			<tr style="height: 10px;">
				<td height="10" colspan="3"></td>
			</tr>
			<tr>
				<td></td>
				<td valign="top">
					<TABLE class=Shadow>
						<tr>
							<td valign="top">
								<TABLE class=ViewForm id=searchTable>
									<tr id=searchItem <%if(display==1){ %> style="display: none;" <%} %>>
										<td>
											<TABLE class=ViewForm>
												<COLGROUP>
													<COL width="12%">
													<COL width="20%">
													<COL width="12%">
													<COL width="22%">
													<COL width="12%">
													<COL width="22%">
												</COLGROUP>
												<TBODY>
													<TR>
														<TD><%=SystemEnv.getHtmlLabelName(1268, user.getLanguage())%><!-- 客户 -->
														</TD>
														<TD class=Field>
															<input class=inputstyle type=text style="width: 95%" name="customerName" maxlength="100" value="<%=customerName %>"/>
														</TD>
														<TD><%=SystemEnv.getHtmlLabelName(63, user.getLanguage())%><!-- 类型 -->
														</TD>
														<TD class=Field>
															<INPUT class="wuiBrowser" type="hidden" id="typeId" name="typeId" value="<%=typeId %>"
					          	 								_displayText="<%=typeName %>"
					          	 								_url="/systeminfo/BrowserMain.jsp?url=/crm/maint/CustomerTypeBrowser.jsp" />
														</TD>
														<TD><%=SystemEnv.getHtmlLabelName(15240, user.getLanguage())%><!-- 来源-->
														</TD>
														<TD class=Field>
															<INPUT class="wuiBrowser" type="hidden" id="sourceId" name="sourceId" value="<%=sourceId %>"
					          	 								_displayText="<%=sourceName %>"
					          	 								_url="/systeminfo/BrowserMain.jsp?url=/crm/maint/ContactWayBrowser.jsp" />
														</TD>
													</TR>
													<tr style="height: 1px;">
														<td class=Line colspan=6></td>
													</tr>
													<TR>
														<TD><%=SystemEnv.getHtmlLabelName(26795, user.getLanguage())%><!-- 意向性 -->
														</TD>
														<TD class=Field>
															<INPUT class="wuiBrowser" type="hidden" id="intentId" name="intentId" value="<%=intentId %>"
					          	 								_displayText="<%=intentName %>"
					          	 								_url="/systeminfo/BrowserMain.jsp?url=/crm/channel/base/CustomerIntentBrowser.jsp" />
														</TD>
														<TD><%=SystemEnv.getHtmlLabelName(26800, user.getLanguage())%><!-- 业务类型 -->
														</TD>
														<TD class=Field>
															<INPUT class="wuiBrowser" type="hidden" id="bizTypeId" name="bizTypeId" value="<%=bizTypeId %>"
					          	 								_displayText="<%=bizTypeName %>"
					          	 								_url="/systeminfo/BrowserMain.jsp?url=/crm/channel/base/CustomerBizTypeBrowser.jsp" />
														</TD>
														<TD><%=SystemEnv.getHtmlLabelName(26796, user.getLanguage())%><!-- 代理品牌-->
														</TD>
														<TD class=Field>
															<INPUT class="wuiBrowser" type="hidden" id="deputizeBrandId" name="deputizeBrandId" value="<%=deputizeBrandId %>"
					          	 								_displayText="<%=deputizeBrandName %>"
					          	 								_url="/systeminfo/BrowserMain.jsp?url=/crm/channel/base/CustomerDeputizeBrandBrowser.jsp" />
														</TD>
													</TR>
													<tr style="height: 1px;">
														<td class=Line colspan=6></td>
													</tr>
													<TR>
														<TD><%=SystemEnv.getHtmlLabelName(1278, user.getLanguage())%><!-- 客户经理 -->
														</TD>
														<TD class=Field>
															<INPUT class="wuiBrowser" type="hidden" id="managerIds" name="managerIds" value="<%=managerIds %>"
																_displayTemplate="<A href='javaScript:openhrm(#b{id})' onclick='pointerXY(event)'>#b{name}</A>" 
					          	 								_displayText="<%=managerName %>" _param="resourceids" 
					          	 								_url="/systeminfo/BrowserMain.jsp?url=/hrm/resource/MutiResourceBrowser.jsp" />	
														</TD>
														<TD><%=SystemEnv.getHtmlLabelName(722, user.getLanguage())%><!-- 创建日期 -->
														</TD>
														<TD class=Field>
															<BUTTON type="button" class=Calendar onclick="gettheDate(createDateFrom,createDateFromSpan)"></BUTTON>
															<SPAN id="createDateFromSpan"><%=createDateFrom%></SPAN>
															<input class=inputstyle type="hidden" name="createDateFrom" value="<%=createDateFrom%>" />－
															<BUTTON type="button" class=Calendar onclick="gettheDate(createDateTo,createDateToSpan)"></BUTTON>
															<SPAN id="createDateToSpan"><%=createDateTo%></SPAN>
															<input class=inputstyle type="hidden" name="createDateTo" value="<%=createDateTo%>" />
														</TD>
														<TD><%=SystemEnv.getHtmlLabelName(26863, user.getLanguage())%><!-- 关键联系 -->
														</TD>
														<TD class=Field>
															<select name="keyContact">
																<option value=""></option>
																<option value="1" <%if(keyContact.equals("1")){%> selected="selected" <%}%>><%=SystemEnv.getHtmlLabelName(163, user.getLanguage())%></option>
																<option value="0" <%if(keyContact.equals("0")){%> selected="selected" <%}%>><%=SystemEnv.getHtmlLabelName(161, user.getLanguage())%></option>
															</select>
														</TD>
													</TR>
													<tr style="height: 1px;">
														<td class=Line colspan=6></td>
													</tr>
													
													<TR>
														<TD><%=SystemEnv.getHtmlLabelName(15239, user.getLanguage())%><!-- 中介机构 -->
														</TD>
														<TD class=Field>
															<input class=inputstyle type=text style="width: 95%" name="agentName" maxlength="100" value="<%=agentName %>"/>
														</TD>
														<TD><%=SystemEnv.getHtmlLabelName(25348, user.getLanguage())%><!-- 未联系日期 -->
														</TD>
														<TD class=Field>
															<BUTTON type="button" class=calendar id=SelectDate onclick="gettheDate(nocontactfromdate,nocontactfromdatespan)"></BUTTON>
															<SPAN id=nocontactfromdatespan ><%=nocontactfromdate%></SPAN>
															<input type="hidden" name="nocontactfromdate" value="<%=nocontactfromdate%>">－
															<BUTTON type="button" class=calendar id=SelectDate onclick="gettheDate(nocontacttodate,nocontacttodatespan)"></BUTTON>
															<SPAN id=nocontacttodatespan ><%=nocontacttodate%></SPAN>
															<input type="hidden" name="nocontacttodate" value="<%=nocontacttodate%>">
														</TD>
														<TD><%=SystemEnv.getHtmlLabelName(621, user.getLanguage())+SystemEnv.getHtmlLabelName(97, user.getLanguage())%><!-- 联系日期 -->
														</TD>
														<TD class=Field>
															<BUTTON type="button" class=calendar id=SelectDate onclick="gettheDate(contactfromdate,contactfromdatespan)"></BUTTON>
															<SPAN id=contactfromdatespan ><%=contactfromdate%></SPAN>
															<input type="hidden" name="contactfromdate" value="<%=contactfromdate%>">－
															<BUTTON type="button" class=calendar id=SelectDate onclick="gettheDate(contacttodate,contacttodatespan)"></BUTTON>
															<SPAN id=contacttodatespan ><%=contacttodate%></SPAN>
															<input type="hidden" name="contacttodate" value="<%=contacttodate%>">
														</TD>
													</TR>
													<tr style="height: 1px;">
														<td class=Line colspan=6></td>
													</tr>
													
													<TR>
														<TD><%=SystemEnv.getHtmlLabelName(800,user.getLanguage())%><!-- 省份 --></TD>
											        	<TD class=Field>
											              	<INPUT class="wuiBrowser" type="hidden" id="CustomerProvince" name="CustomerProvince" value="<%=provinceId %>"
					          	 								_displayText="<%=ProvinceComInfo.getProvincename(provinceId) %>"
					          	 								_url="/systeminfo/BrowserMain.jsp?url=/hrm/province/ProvinceBrowser.jsp" />
											            </TD>
											            <TD><%=SystemEnv.getHtmlLabelName(493,user.getLanguage())%><!-- 城市 --></TD>
												        <TD class=Field>
												        	<INPUT class="wuiBrowser" type="hidden" id="CustomerCity" name="CustomerCity" value="<%=cityId %>"
					          	 								_displayText="<%=CityComInfo.getCityname(cityId) %>"
					          	 								_url="/systeminfo/BrowserMain.jsp?url=/hrm/city/CityBrowser.jsp" />
														</TD>
														
														<TD><%=SystemEnv.getHtmlLabelName(572, user.getLanguage())%>(<%=SystemEnv.getHtmlLabelName(17532, user.getLanguage())%>)<!-- 联系人 -->
														</TD>
														<TD class=Field>
															<INPUT class="wuiBrowser" type="hidden" id="contacterId" name="contacterId" value="<%=contacterId %>"
																_displayTemplate="<A href='javaScript:openhrm(#b{id})' onclick='pointerXY(event)'>#b{name}</A>" 
					          	 								_displayText="<%=contacterName %>"
					          	 								_url="/systeminfo/BrowserMain.jsp?url=/hrm/resource/ResourceBrowser.jsp" />		
														</TD>
													</TR>
													<tr style="height: 1px;">
														<td class=Line colspan=6></td>
													</tr>
													
													<%if(advance){ %>
													<TR>
														<TD><%=SystemEnv.getHtmlLabelName(25171, user.getLanguage())%><!-- 开拓人员 -->
														</TD>
														<TD class=Field>
															<INPUT class="wuiBrowser" type="hidden" id="exploiterIds" name="exploiterIds" value="<%=exploiterIds %>"
																_displayTemplate="<A href='javaScript:openhrm(#b{id})' onclick='pointerXY(event)'>#b{name}</A>" 
					          	 								_displayText="<%=exploiterName %>" _param="resourceids" 
					          	 								_url="/systeminfo/BrowserMain.jsp?url=/hrm/resource/MutiResourceBrowser.jsp" />		
														</TD>
													</TR>
													<tr style="height: 1px;">
														<td class=Line colspan=6></td>
													</tr>
													<%} %>
													
												</TBODY>
											</TABLE>
										</td>
									</tr>
									<tr>
										<td colspan=6 align="right">
											<a href="###" onclick="searchCR()">
											<%if(display==0){%>
												<img id="searchAdviceImg" name="searchAdviceImg" src="/images/down_wev8.png" align=absMiddle><%=SystemEnv.getHtmlLabelName(15774, user.getLanguage())%><!-- 搜索条件 -->
											<%}else{ %>
												<img id="searchAdviceImg" name="searchAdviceImg" src="/images/up_wev8.png" align=absMiddle><%=SystemEnv.getHtmlLabelName(15774, user.getLanguage())%><!-- 搜索条件 -->
											<%} %>
											</a>
										</td>
									</tr>
								</table>
											
											<%
												String tableString = "";
												String backfields = " t1.id,t1.name,t1.manager,t1.type,t1.source,t1.agent"
																+",t2.intentId,t2.bizTypeId,t2.expectMoney,t2.deputizeBrandId,t2.deputizeBrandOther,t2.projectDemand,t2.projectBudget,t2.projectPhaseId,t2.exploiterId,t2.keyContact,t1.province,t1.city"
																//+",(select min(submitdate) from CRM_Log t3 where t3.customerid=t1.id and t3.logtype='n') as submitdate";
																+",t1.createDate as submitdate";
												String fromSql = " CRM_CustomerInfo t1,CRM_CustomerChannelInfo t2";
												String sqlmei = "";
												String orderby = " t3.submitdate,t1.id";
												//out.println("select "+backfields+" from "+fromSql+ sqlWhere);
											
												ArrayList xTableColumnList=new ArrayList();
												
												TableColumn xTableColumn_customerName=new TableColumn();
												xTableColumn_customerName.setColumn("name");
												xTableColumn_customerName.setDataIndex("name");
												xTableColumn_customerName.setHeader(SystemEnv.getHtmlLabelName(1268,user.getLanguage()));
												xTableColumn_customerName.setTransmethod("weaver.crm.channel.CommonTransUtil.getCustomer");
												xTableColumn_customerName.setPara_1("column:id");
												xTableColumn_customerName.setSortable(true);
												xTableColumn_customerName.setHideable(false);
												xTableColumn_customerName.setWidth(0.008); 
												xTableColumnList.add(xTableColumn_customerName);
												
												if(advance){
													TableColumn xTableColumn_exploiter=new TableColumn();
													xTableColumn_exploiter.setColumn("exploiterId");
													xTableColumn_exploiter.setDataIndex("exploiterId");
													xTableColumn_exploiter.setHeader(SystemEnv.getHtmlLabelName(25171,user.getLanguage()));
													xTableColumn_exploiter.setTransmethod("weaver.ce.util.CommonTransUtil.getPerson");
													xTableColumn_exploiter.setPara_1("column:exploiterId");
													xTableColumn_exploiter.setSortable(true);
													xTableColumn_exploiter.setHideable(true);
													xTableColumn_exploiter.setWidth(0.004); 
													xTableColumnList.add(xTableColumn_exploiter);
												}
												
												TableColumn xTableColumn_manager=new TableColumn();
												xTableColumn_manager.setColumn("manager");
												xTableColumn_manager.setDataIndex("manager");
												xTableColumn_manager.setHeader(SystemEnv.getHtmlLabelName(1278,user.getLanguage()));
												xTableColumn_manager.setTransmethod("weaver.ce.util.CommonTransUtil.getPerson");
												xTableColumn_manager.setPara_1("column:manager");
												xTableColumn_manager.setSortable(true);
												xTableColumn_manager.setHideable(true);
												xTableColumn_manager.setWidth(0.004); 
												xTableColumnList.add(xTableColumn_manager);
												
												TableColumn xTableColumn_type=new TableColumn();
												xTableColumn_type.setColumn("type");
												xTableColumn_type.setDataIndex("type");
												xTableColumn_type.setHeader(SystemEnv.getHtmlLabelName(63, user.getLanguage()));
												xTableColumn_type.setTransmethod("weaver.crm.Maint.CustomerTypeComInfo.getCustomerTypename");
												xTableColumn_type.setPara_1("column:type");
												xTableColumn_type.setSortable(true);
												xTableColumn_type.setHideable(true);
												xTableColumn_type.setWidth(0.006); 
												xTableColumnList.add(xTableColumn_type);
												
												TableColumn xTableColumn_source=new TableColumn();
												xTableColumn_source.setColumn("source");
												xTableColumn_source.setDataIndex("source");
												xTableColumn_source.setHeader(SystemEnv.getHtmlLabelName(15240,user.getLanguage()));
												xTableColumn_source.setTransmethod("weaver.crm.Maint.ContactWayComInfo.getContactWayname");
												xTableColumn_source.setPara_1("column:source");
												xTableColumn_source.setSortable(true);
												xTableColumn_source.setHideable(true);
												xTableColumn_source.setWidth(0.006); 
												xTableColumnList.add(xTableColumn_source);
												
												TableColumn xTableColumn_intent=new TableColumn();
												xTableColumn_intent.setColumn("intentId");
												xTableColumn_intent.setDataIndex("intentId");
												xTableColumn_intent.setHeader(SystemEnv.getHtmlLabelName(26795,user.getLanguage()));
												xTableColumn_intent.setTransmethod("weaver.crm.channel.CustomerIntentComInfo.getName");
												xTableColumn_intent.setPara_1("column:intentId");
												xTableColumn_intent.setSortable(true);
												xTableColumn_intent.setHideable(true);
												xTableColumn_intent.setWidth(0.004); 
												xTableColumnList.add(xTableColumn_intent);
												
												TableColumn xTableColumn_bizType=new TableColumn();
												xTableColumn_bizType.setColumn("bizTypeId");
												xTableColumn_bizType.setDataIndex("bizTypeId");
												xTableColumn_bizType.setHeader(SystemEnv.getHtmlLabelName(26800,user.getLanguage()));
												xTableColumn_bizType.setTransmethod("weaver.crm.channel.CustomerBizTypeComInfo.getName");
												xTableColumn_bizType.setPara_1("column:bizTypeId");
												xTableColumn_bizType.setSortable(true);
												xTableColumn_bizType.setHideable(true);
												xTableColumn_bizType.setWidth(0.004); 
												xTableColumnList.add(xTableColumn_bizType);
												
												TableColumn xTableColumn_deputizeBrand=new TableColumn();
												xTableColumn_deputizeBrand.setColumn("deputizeBrandId");
												xTableColumn_deputizeBrand.setDataIndex("deputizeBrandId");
												xTableColumn_deputizeBrand.setHeader(SystemEnv.getHtmlLabelName(26796,user.getLanguage()));
												xTableColumn_deputizeBrand.setTransmethod("weaver.crm.channel.CommonTransUtil.getDeputizeBrand");
												xTableColumn_deputizeBrand.setPara_1("column:deputizeBrandId");
												xTableColumn_deputizeBrand.setPara_2("column:deputizeBrandOther");
												xTableColumn_deputizeBrand.setSortable(true);
												xTableColumn_deputizeBrand.setHideable(true);
												xTableColumn_deputizeBrand.setWidth(0.004); 
												xTableColumnList.add(xTableColumn_deputizeBrand);
												
												TableColumn xTableColumn_expectMoney=new TableColumn();
												xTableColumn_expectMoney.setColumn("expectMoney");
												xTableColumn_expectMoney.setDataIndex("expectMoney");
												xTableColumn_expectMoney.setHeader(SystemEnv.getHtmlLabelName(26815, user.getLanguage()));
												xTableColumn_expectMoney.setTransmethod("weaver.crm.channel.CommonTransUtil.comma");
												xTableColumn_expectMoney.setPara_1("column:expectMoney");
												xTableColumn_expectMoney.setSortable(true);
												xTableColumn_expectMoney.setHideable(true);
												xTableColumn_expectMoney.setWidth(0.006); 
												xTableColumnList.add(xTableColumn_expectMoney);
												
												/**
												TableColumn xTableColumn_projectDemand=new TableColumn();
												xTableColumn_projectDemand.setColumn("projectDemand");
												xTableColumn_projectDemand.setDataIndex("projectDemand");
												xTableColumn_projectDemand.setHeader(SystemEnv.getHtmlLabelName(26816,user.getLanguage()));
												xTableColumn_projectDemand.setSortable(true);
												xTableColumn_projectDemand.setHideable(true);
												xTableColumn_projectDemand.setWidth(0.006); 
												xTableColumnList.add(xTableColumn_projectDemand);
												
												TableColumn xTableColumn_projectBudget=new TableColumn();
												xTableColumn_projectBudget.setColumn("projectBudget");
												xTableColumn_projectBudget.setDataIndex("projectBudget");
												xTableColumn_projectBudget.setHeader(SystemEnv.getHtmlLabelName(15274, user.getLanguage()));
												xTableColumn_projectBudget.setTransmethod("weaver.crm.channel.CommonTransUtil.comma");
												xTableColumn_projectBudget.setPara_1("column:projectBudget");
												xTableColumn_projectBudget.setSortable(true);
												xTableColumn_projectBudget.setHideable(true);
												xTableColumn_projectBudget.setWidth(0.006); 
												xTableColumnList.add(xTableColumn_projectBudget);
												
												TableColumn xTableColumn_projectPhase=new TableColumn();
												xTableColumn_projectPhase.setColumn("projectPhaseId");
												xTableColumn_projectPhase.setDataIndex("projectPhaseId");
												xTableColumn_projectPhase.setHeader(SystemEnv.getHtmlLabelName(26797,user.getLanguage()));
												xTableColumn_projectPhase.setTransmethod("weaver.crm.channel.CustomerProjectPhaseComInfo.getName");
												xTableColumn_projectPhase.setPara_1("column:projectPhaseId");
												xTableColumn_projectPhase.setSortable(true);
												xTableColumn_projectPhase.setHideable(true);
												xTableColumn_projectPhase.setWidth(0.004); 
												xTableColumnList.add(xTableColumn_projectPhase);
												*/
												
												TableColumn xTableColumn_agent=new TableColumn();
												xTableColumn_agent.setColumn("agent");
												xTableColumn_agent.setDataIndex("agent");
												xTableColumn_agent.setHeader(SystemEnv.getHtmlLabelName(15239,user.getLanguage()));
												xTableColumn_agent.setTransmethod("weaver.crm.channel.CommonTransUtil.getCustomer");
												xTableColumn_agent.setPara_1("column:agent");
												xTableColumn_agent.setSortable(true);
												xTableColumn_agent.setHideable(true);
												xTableColumn_agent.setWidth(0.006); 
												xTableColumnList.add(xTableColumn_agent);
												
												TableColumn xTableColumn_keyContact=new TableColumn();
												xTableColumn_keyContact.setColumn("keyContact");
												xTableColumn_keyContact.setDataIndex("keyContact");
												xTableColumn_keyContact.setHeader(SystemEnv.getHtmlLabelName(26863,user.getLanguage()));
												xTableColumn_keyContact.setTransmethod("weaver.crm.channel.CommonTransUtil.getYN");
												xTableColumn_keyContact.setPara_1("column:keyContact");
												xTableColumn_keyContact.setPara_2(user.getLanguage()+"");
												xTableColumn_keyContact.setSortable(true);
												xTableColumn_keyContact.setHideable(true);
												xTableColumn_keyContact.setWidth(0.004); 
												xTableColumnList.add(xTableColumn_keyContact);
												
												TableColumn xTableColumn_createDate=new TableColumn();
												xTableColumn_createDate.setColumn("submitdate");
												xTableColumn_createDate.setDataIndex("submitdate");
												xTableColumn_createDate.setHeader(SystemEnv.getHtmlLabelName(722,user.getLanguage()));
												xTableColumn_createDate.setSortable(true);
												xTableColumn_createDate.setHideable(true);
												xTableColumn_createDate.setWidth(0.005); 
												xTableColumnList.add(xTableColumn_createDate);


												TableSql xTableSql=new TableSql();
												xTableSql.setBackfields(backfields);
												xTableSql.setPageSize(perpage);
												xTableSql.setSqlform(fromSql);
												xTableSql.setSqlwhere(sqlWhere);
												xTableSql.setSqlprimarykey("t1.id");
												xTableSql.setSqlisdistinct("true");
												xTableSql.setSort(orderby);
												xTableSql.setDir(TableConst.DESC);

												Table xTable=new Table(request); 
												
												xTable.setTableGridType(TableConst.NONE);
												xTable.setTableNeedRowNumber(true);
												xTable.setTableSql(xTableSql);
												xTable.setTableColumnList(xTableColumnList);
												
												//System.out.println(exportSql);
											%>
											<%=xTable.toString4()%>
							</td>
						</tr>
					</TABLE>
				</td>
				<td></td>
			</tr>
		</table>
		</form>
		<iframe id="searchexport" style="display:none"></iframe>
		<script type="text/javascript">
			function onSearch(){
				jQuery("#frmMain").submit();	
			}
			
			function onRefresh(){
				_table.refresh();
			}
			
			document.onkeydown=keyListener;
			function keyListener(e){
			    e = e ? e : event;   
			    if(e.keyCode == 13){    
			    	onSearch();    
			    }    
			}
			function exportExcel(){
				if(confirm("确认导出所有记录?")){
					<%
						String exportSql = "select " + backfields + " from " + fromSql + sqlWhere + " order by t3.submitdate desc,t1.id desc";
						request.getSession().setAttribute("CRM_CHANNEL_IMPORT_SQL",exportSql);
					%>
					jQuery("#searchexport").attr("src","CustomerExploitExport.jsp");
				}
			}
			
			var display = <%=display%>;
			function searchCR(){
				if(display==0){
					jQuery("#searchAdviceImg").attr("src","/images/up_wev8.png");
					jQuery("#searchItem").hide();
					display=1;
				}else{
					jQuery("#searchAdviceImg").attr("src","/images/down_wev8.png");
					jQuery("#searchItem").show();
					display=0;
				}
				jQuery("#display").val(display);
				setHeight();
			}
			function setHeight(){
				_table.setGridHeight(document.body.clientHeight-searchTable.offsetHeight-75)
			}
		</script>
	</BODY>
</HTML>