
<%@ page language="java" contentType="text/html; charset=UTF-8"%>
<%@ include file="/systeminfo/init_wev8.jsp" %>
<%@ page import="weaver.general.Util,weaver.file.ExcelSheet,weaver.file.ExcelRow"%>
<%@ page import="weaver.general.Util,weaver.file.ExcelSheet,weaver.file.ExcelRow,weaver.secondary.file.ExcelStyle" %>
<jsp:useBean id="rs" class="weaver.conn.RecordSet" scope="page" />
<jsp:useBean id="rs2" class="weaver.conn.RecordSet" scope="page" />
<jsp:useBean id="CustomerInfoComInfo" class="weaver.crm.Maint.CustomerInfoComInfo" scope="page"/>
<jsp:useBean id="ResourceComInfo" class="weaver.hrm.resource.ResourceComInfo" scope="page"/>
<jsp:useBean id="CustomerTypeComInfo" class="weaver.crm.Maint.CustomerTypeComInfo" scope="page"/>
<jsp:useBean id="ContactWayComInfo" class="weaver.crm.Maint.ContactWayComInfo" scope="page"/>
<jsp:useBean id="CustomerIntentComInfo" class="weaver.crm.channel.CustomerIntentComInfo" scope="page"/>
<jsp:useBean id="CustomerBizTypeComInfo" class="weaver.crm.channel.CustomerBizTypeComInfo" scope="page"/>
<jsp:useBean id="CityComInfo" class="weaver.hrm.city.CityComInfo" scope="page"/>
<jsp:useBean id="ProvinceComInfo" class="weaver.hrm.province.ProvinceComInfo" scope="page"/>
<jsp:useBean id="CRM_CHANNEL" class="weaver.secondary.file.ExcelFile" scope="session" />
<jsp:useBean id="cmutil" class="weaver.crm.channel.CommonTransUtil" scope="page" />
<%
	String sql = (String)request.getSession().getAttribute("CRM_CHANNEL_IMPORT_SQL");
	boolean advance = false;
	if(HrmUserVarify.checkUserRight("CustomerChannelBaseMaint:View", user)){
		advance = true;
	}

	ExcelSheet es = new ExcelSheet();
	
	es.addColumnwidth(10000);
	if(advance){
		es.addColumnwidth(4000);
	}
	es.addColumnwidth(4000);
	es.addColumnwidth(6000);
	es.addColumnwidth(4000);
	es.addColumnwidth(4000);
	es.addColumnwidth(4000);
	es.addColumnwidth(4000);
	es.addColumnwidth(4000);
	es.addColumnwidth(8000);
	es.addColumnwidth(4000);
	es.addColumnwidth(4000);
	es.addColumnwidth(10000);
	es.addColumnwidth(4000);
	es.addColumnwidth(4000);
	
	ExcelRow title = es.newExcelRow();
	title.setHight(22);
	title.addStringValue(SystemEnv.getHtmlLabelName(1268,user.getLanguage()), "title");//客户
	if(advance){
		title.addStringValue(SystemEnv.getHtmlLabelName(25171,user.getLanguage()), "title");//开拓人员
	}
	title.addStringValue(SystemEnv.getHtmlLabelName(1278,user.getLanguage()), "title");//客户经理
	title.addStringValue(SystemEnv.getHtmlLabelName(63, user.getLanguage()), "title");//类型
	title.addStringValue(SystemEnv.getHtmlLabelName(15240,user.getLanguage()), "title");//来源
	title.addStringValue(SystemEnv.getHtmlLabelName(26795,user.getLanguage()), "title");//意向性
	title.addStringValue(SystemEnv.getHtmlLabelName(26800,user.getLanguage()), "title");//业务类型
	title.addStringValue(SystemEnv.getHtmlLabelName(26796,user.getLanguage()), "title");//代理品牌
	title.addStringValue(SystemEnv.getHtmlLabelName(26815, user.getLanguage()), "title");//预计签约金额
	title.addStringValue(SystemEnv.getHtmlLabelName(15239,user.getLanguage()), "title");//中介机构
	title.addStringValue(SystemEnv.getHtmlLabelName(26863,user.getLanguage()), "title");//关键联系
	title.addStringValue(SystemEnv.getHtmlLabelName(722,user.getLanguage()), "title");//创建日期
	title.addStringValue(SystemEnv.getHtmlLabelName(25061,user.getLanguage()), "title");//联系人邮箱
	title.addStringValue(SystemEnv.getHtmlLabelName(800,user.getLanguage()), "title");//省份
	title.addStringValue(SystemEnv.getHtmlLabelName(493,user.getLanguage()), "title");//城市
	
	rs.executeSql(sql);
	while (rs.next()) {
		ExcelRow er1 = es.newExcelRow();
		er1.setHight(22);
		er1.addStringValue(CustomerInfoComInfo.getCustomerInfoname(rs.getString("id")),"normal");
		if(advance){
			er1.addStringValue(ResourceComInfo.getLastname(rs.getString("exploiterId")),"normal");
		}
		er1.addStringValue(ResourceComInfo.getLastname(rs.getString("manager")),"normal");
		er1.addStringValue(CustomerTypeComInfo.getCustomerTypename(rs.getString("type")),"normal");
		er1.addStringValue(ContactWayComInfo.getContactWayname(rs.getString("source")),"normal");
		er1.addStringValue(CustomerIntentComInfo.getName(rs.getString("intentId")),"normal");
		er1.addStringValue(CustomerBizTypeComInfo.getName(rs.getString("bizTypeId")),"normal");
		er1.addStringValue(cmutil.getDeputizeBrand(rs.getString("deputizeBrandId"),rs.getString("deputizeBrandOther")),"normal");
		er1.addStringValue(cmutil.comma(rs.getString("expectMoney")),"normal");
		er1.addStringValue(CustomerInfoComInfo.getCustomerInfoname(rs.getString("agent")),"normal");
		er1.addStringValue(cmutil.getYN(rs.getString("keyContact"),user.getLanguage()+""),"normal");
		er1.addStringValue(rs.getString("submitdate"),"normal");
		
		String mails = "";
		rs2.executeSql("select id,email from CRM_CustomerContacter where customerid ="+rs.getString("id")+" order by main desc,fullname asc");
		while(rs2.next()){
			mails += ";" + rs2.getString("email");
		}
		if(!mails.equals("")){
			mails = mails.substring(1);
		}
		er1.addStringValue(mails,"normal");
		er1.addStringValue(ProvinceComInfo.getProvincename(rs.getString("province")),"normal");
		er1.addStringValue(CityComInfo.getCityname(rs.getString("city")),"normal");
	}
	
	CRM_CHANNEL.init();

	ExcelStyle titleStyle = CRM_CHANNEL.newExcelStyle("title");
	titleStyle.setGroundcolor(ExcelStyle.LIGHT_BLUE_Color);
	titleStyle.setFontcolor(ExcelStyle.WHITE_Color);
	titleStyle.setFontheight(10);
	titleStyle.setFontbold(ExcelStyle.Strong_Font);
	titleStyle.setAlign(ExcelStyle.ALIGN_CENTER);
	titleStyle.setValign(ExcelStyle.VALIGN_CENTER);

	ExcelStyle normalStyle = CRM_CHANNEL.newExcelStyle("normal");
	normalStyle.setAlign(ExcelStyle.ALIGN_LEFT);
	normalStyle.setValign(ExcelStyle.VALIGN_CENTER);
	normalStyle.setFontheight(10);
	
	CRM_CHANNEL.setFilename(SystemEnv.getHtmlLabelName(26825, user.getLanguage()));
	CRM_CHANNEL.addSheet(SystemEnv.getHtmlLabelName(26825, user.getLanguage()), es);
%>

<script language="javascript">
    window.location="/weaver/weaver.secondary.file.ExcelOut?excelfile=CRM_CHANNEL";
</script>