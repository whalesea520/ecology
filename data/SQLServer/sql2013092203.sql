alter table Prj_TaskProcess alter column content text
GO

drop procedure Prj_TaskProcess_Insert
GO

  CREATE PROCEDURE Prj_TaskProcess_Insert (@prjid 	int, @taskid 	int, @wbscoding 	varchar(20), @subject 	varchar(80) , @version 	tinyint, @begindate 	varchar(10), @enddate 	varchar(10), @workday decimal (10,1), @content 	text, @fixedcost decimal (18,2), @parentid int, @parentids varchar (255), @parenthrmids varchar (255), @level_n tinyint, @hrmid int, @prefinish_1 varchar(4000), @realManDays decimal (6,1), @taskIndex int, @flag integer output, @msg varchar(80) output  ) AS declare @dsporder_9 int, @current_maxid int  select @current_maxid = max(dsporder) from Prj_TaskProcess where prjid = @prjid and version = @version and parentid = @parentid and isdelete<>'1' if @current_maxid is null set @current_maxid = 0 set @dsporder_9 = @current_maxid + 1  INSERT INTO Prj_TaskProcess ( prjid, taskid , wbscoding, subject , version , begindate, enddate, workday, content, fixedcost, parentid, parentids, parenthrmids, level_n, hrmid, islandmark, prefinish, dsporder, realManDays, taskIndex ) VALUES ( @prjid, @taskid , @wbscoding, @subject , @version , @begindate, @enddate, @workday, @content, @fixedcost, @parentid, @parentids, @parenthrmids, @level_n, @hrmid,'0',@prefinish_1,@dsporder_9, @realManDays,@taskIndex) Declare @id int, @maxid varchar(10), @maxhrmid varchar(255) select @id = max(id) from Prj_TaskProcess set @maxid = convert(varchar(10), @id) + ',' set @maxhrmid = '|' + convert(varchar(10), @id) + ',' + convert(varchar(10), @hrmid) + '|' update Prj_TaskProcess set parentids=parentids+@maxid, parenthrmids=parenthrmids+@maxhrmid  where id=@id  set @flag = @@identity set @msg = 'OK!' 
GO

drop procedure Prj_TaskProcess_Update
GO
   CREATE PROCEDURE Prj_TaskProcess_Update (@id	int, @wbscoding varchar(20), @subject 	varchar(80) , @begindate 	varchar(10), @enddate 	varchar(10), @actualbegindate 	varchar(10), @actualenddate 	varchar(10), @workday decimal (10,1), @content 	text,  @fixedcost decimal (18,2), @hrmid int, @oldhrmid int, @finish tinyint, @taskconfirm char(1), @islandmark char(1), @prefinish_1 varchar(4000), @realManDays decimal (6,1), @flag integer output, @msg varchar(80) output ) AS UPDATE Prj_TaskProcess SET wbscoding = @wbscoding, subject = @subject , begindate = @begindate, enddate = @enddate 	, actualbegindate = @actualbegindate, actualenddate = @actualenddate 	, workday = @workday, content = @content, fixedcost = @fixedcost, hrmid = @hrmid, finish = @finish , taskconfirm = @taskconfirm, islandmark = @islandmark, prefinish = @prefinish_1, realManDays = @realManDays WHERE ( id	 = @id) if @hrmid<>@oldhrmid begin Declare @currenthrmid varchar(255), @currentoldhrmid varchar(255) set @currenthrmid='|' + convert(varchar(10), @id) + ',' + convert(varchar(10), @hrmid) + '|' set @currentoldhrmid='|' + convert(varchar(10), @id) + ',' + convert(varchar(10), @oldhrmid) + '|' UPDATE Prj_TaskProcess set parenthrmids=replace(parenthrmids,@currentoldhrmid,@currenthrmid) where (parenthrmids like '%'+@currentoldhrmid+'%') end set @flag = 1 set @msg = 'OK!'
GO   