CREATE OR REPLACE TRIGGER trg_prjmembers_update AFTER INSERT OR UPDATE OF members ON Prj_ProjectInfo FOR EACH ROW 
declare i_prjid int; i_members varchar2(4000); i_isblock int; i_idx int; i_userid int; begin i_members:=:new.members||','; i_isblock:=:new.isblock; i_prjid:=:new.id; delete from prj_members where relateditemid=i_prjid;  if i_isblock!=1 THEN RETURN; end if; if i_members='' THEN RETURN; end if; if i_members is null THEN RETURN; end if;  i_idx:=INSTR(i_members,',',1,1) ;  while i_idx>0 loop i_userid:=to_number(SUBSTR(i_members,0,(i_idx-1))); if i_userid>0 then insert into prj_members(relateditemid,userid) values(i_prjid,i_userid); end if; i_members:=SUBSTR(i_members,(i_idx+1),LENGTH(i_members)); i_idx:=INSTR(i_members,',',1,1); end loop; end;
/

create or replace trigger Tri_CRM_CustomerInfoShare after update ON  CRM_CustomerInfo FOR each row 
Declare crmid_1 integer; oldmanagerstr_1 varchar2(4000); managerstr_1 varchar2(4000); begin  crmid_1 := :new.id; oldmanagerstr_1 := :old.manager; managerstr_1 := :new.manager;  if (managerstr_1 <> oldmanagerstr_1 ) then update shareinnerdoc set content=managerstr_1 where srcfrom=-81 and opuser = crmid_1; end if; end;
/

create or replace trigger Tri_importexpense  after INSERT ON fnaaccountlog FOR each row 
declare relatedcrm_1 integer; relatedprj_1 integer; organizationid_1 integer; occurdate_1 char(10); amount_1 number(15,3); subject_1 integer; requestid_1 integer; iscontract_1 integer; description_1 varchar2(4000); begin iscontract_1 := :new.iscontractid; if(iscontract_1 =0 or iscontract_1 is null) then subject_1  := :new.feetypeid; organizationid_1  := :new.resourceid; relatedcrm_1  := :new.crmid; relatedprj_1  := :new.projectid; occurdate_1  := :new.occurdate; amount_1  := :new.amount; requestid_1  := :new.releatedid; insert into fnaexpenseinfo(subject,organizationtype,organizationid,relatedcrm,relatedprj,amount,occurdate,requestid,status,type,description) values(subject_1,3,organizationid_1,relatedcrm_1,relatedprj_1,amount_1,occurdate_1,requestid_1,1,2,description_1); end if; end;
/


create or replace trigger Tri_importloan after INSERT ON fnaloanlog FOR each row 
declare relatedcrm_1 integer; relatedprj_1 integer; organizationid_1 integer; occurdate_1 char(10); amount_1 number(15,3); subject_1 integer; requestid_1 integer; description_1 varchar2(4000); loantype_1 integer; debitremark_1 varchar2(4000); processorid_1 integer; begin loantype_1 := :new.loantypeid; organizationid_1 := :new.resourceid; relatedcrm_1 := :new.crmid; relatedprj_1 := :new.projectid; amount_1 := :new.amount; occurdate_1 := :new.occurdate; requestid_1 := :new.releatedid; description_1 := :new.description; debitremark_1 := :new.credenceno; processorid_1 := :new.dealuser; if(loantype_1=1) then insert into fnaloaninfo(loantype,organizationtype,organizationid,relatedcrm,relatedprj,amount,occurdate,requestid,remark,debitremark,processorid) values(loantype_1,3,organizationid_1,relatedcrm_1,relatedprj_1,amount_1,occurdate_1,requestid_1,description_1,debitremark_1,processorid_1); end if; end;
/
create or replace trigger Tri_ULeftMenuConfig_ByInfo after  insert or update or delete ON LeftMenuInfo for each row 
Declare id_1 integer; defaultIndex_1 integer; countdelete   integer; countinsert   integer; userId_1 integer; isCustom_1 char(1); useCustomName_1 char(1); customName_1 varchar2(4000); begin countdelete := :old.id; countinsert := :new.id;  IF (countinsert > 0 AND countdelete is null) then id_1 := :new.id; defaultIndex_1 := :new.defaultIndex; isCustom_1 := :new.isCustom; useCustomName_1 := :new.useCustomName; customName_1 := :new.customName;  if(isCustom_1 = '0' OR isCustom_1 IS NULL) then   FOR hrmCompany_cursor in( SELECT id FROM HrmCompany order by id) loop userId_1 := hrmCompany_cursor.id; INSERT INTO LeftMenuConfig (userId,infoId,visible,viewIndex,resourceid,resourcetype,locked,lockedById,useCustomName,customName) VALUES(0,id_1,1,defaultIndex_1,userId_1,'1',0,0,useCustomName_1,customName_1); END loop;    FOR hrmSubCompany_cursor in( SELECT id FROM HrmSubCompany order by id) loop userId_1 := hrmSubCompany_cursor.id; INSERT INTO LeftMenuConfig (userId,infoId,visible,viewIndex,resourceid,resourcetype,locked,lockedById,useCustomName,customName) VALUES(0,id_1,1,defaultIndex_1,userId_1,'2',0,0,useCustomName_1,customName_1); END loop;   end if; END if;   IF (countinsert is null) then id_1 := :old.id; DELETE FROM LeftMenuConfig WHERE infoId = id_1; END if; end;
/

create or replace trigger Tri_UMailByCRMContacter after update ON CRM_CustomerContacter FOR each row  
DECLARE userid_1 integer; email_1 varchar2(4000); countDeleted_1 integer; countInserted_1 integer; BEGIN countDeleted_1 := :old.id ; countInserted_1 := :new.id ;  IF countInserted_1>0 then  userid_1 := :new.id ; email_1 := :new.email ; UPDATE MailUserAddress SET mailaddress=email_1 WHERE mailUserDesc=CAST(userid_1 AS varchar(10)) AND mailUserType='3'; end if; END;
/

create or replace trigger Tri_UMailByHrmResource after update ON HrmResource FOR each row  
DECLARE userid_1 integer; email_1 varchar2(4000); countDeleted_1 integer; countInserted_1 integer; BEGIN countDeleted_1 := :old.id ; countInserted_1 := :new.id ;  IF countInserted_1>0 then userid_1 := :new.id ; email_1 := :new.email ; UPDATE MailUserAddress SET mailaddress=email_1 WHERE mailUserDesc=CAST(userid_1 AS varchar(10)) AND mailUserType='2'; end if; END;
/
create or replace trigger Tri_UMainMenuConfig_ByInfo  after  insert or update or delete  ON MainMenuInfo for each row  
Declare id_1 integer; defaultIndex_1 integer; countdelete   integer; countinsert   integer; userId_1 integer; isCustom_1 char(1); useCustomName_1 char(1); customName_1 varchar2(4000);   begin countdelete := :old.id; countinsert := :new.id;  IF (countinsert > 0 AND countdelete is null) then id_1 := :new.id; defaultIndex_1 := :new.defaultIndex; isCustom_1 := :new.isCustom; useCustomName_1 := :new.useCustomName; customName_1 := :new.customName;  if(isCustom_1 = '0' OR isCustom_1 IS NULL) then  FOR hrmCompany_cursor in( SELECT id FROM HrmCompany order by id) loop userId_1 := hrmCompany_cursor.id; INSERT INTO MainMenuConfig (userId,infoId,visible,viewIndex,resourceid,resourcetype,locked,lockedById,useCustomName,customName) VALUES(0,id_1,1,defaultIndex_1,userId_1,'1',0,0,useCustomName_1,customName_1); END loop;  FOR hrmSubCompany_cursor in( SELECT id FROM HrmSubCompany order by id) loop userId_1 := hrmSubCompany_cursor.id; INSERT INTO MainMenuConfig (userId,infoId,visible,viewIndex,resourceid,resourcetype,locked,lockedById,useCustomName,customName) VALUES(0,id_1,1,defaultIndex_1,userId_1,'2',0,0,useCustomName_1,customName_1); END loop;  FOR hrmResourcemanager_cursor in( SELECT id FROM HrmResourceManager order by id) loop userId_1 := hrmResourcemanager_cursor.id; INSERT INTO MainMenuConfig (userId,infoId,visible,viewIndex,resourceid,resourcetype,locked,lockedById,useCustomName,customName) VALUES(userId_1,id_1,1,defaultIndex_1,userId_1,'3',0,0,useCustomName_1,customName_1); END loop;  end if; END if;  IF (countinsert is null) then id_1 := :old.id; DELETE FROM MainMenuConfig WHERE infoId = id_1; END if; end;
/

create or replace trigger Tri_UMMInfo_ByDocFrontpage after  insert or update or delete ON DocFrontpage for each row 
Declare id_1 integer; frontpagename_1 varchar2(4000); isactive_1 char(1); publishtype_1 integer; linkAddress_1 varchar2(4000); defaultIndex_1 integer; countdelete   integer; countinsert   integer; updateId integer; updateIndex integer;  begin countdelete :=:old.id; countinsert :=:new.id;    IF (countinsert > 0 and countdelete is null) then id_1:= :new.id; frontpagename_1:= :new.frontpagename; isactive_1:= :new.isactive; publishtype_1:= :new.publishtype; defaultIndex_1 := :new.typeordernum;  IF (isactive_1 = 1 AND publishtype_1 = 1) then linkAddress_1 := concat('/docs/news/NewsDsp.jsp?id=',To_CHAR(id_1)); INSERT INTO MainMenuInfo ( id, menuName , linkAddress , parentFrame , defaultParentId , defaultLevel , defaultIndex , needRightToVisible , needRightToView , needSwitchToVisible , relatedModuleId, parentId ) VALUES ( id_1*-1, frontpagename_1, linkAddress_1, 'mainFrame', 1, 1, defaultIndex_1, 0, 0, 0, 9, 1 ); END if; END if;     IF (countinsert > 0 and  countdelete >0) then id_1:= :new.id; frontpagename_1:= :new.frontpagename; isactive_1:= :new.isactive; publishtype_1:= :new.publishtype; defaultIndex_1 := :new.typeordernum;  linkAddress_1 := concat('/docs/news/NewsDsp.jsp?id=',To_CHAR(id_1)); update MainMenuInfo set menuName=frontpagename_1,linkAddress=linkAddress_1,defaultIndex=defaultIndex_1 where id = id_1*-1; END if;     IF (countinsert is null) then id_1 :=:old.id; DELETE FROM MainMenuInfo WHERE id=id_1*-1; END if; end;
/

create or replace trigger Tri_Update_bill_HrmTime after update ON Prj_TaskProcess FOR each row 
when (new.isactived=2)
Declare prjid_1 integer ; taskid_1 integer ; subject_1 varchar2(4000); isactived_1	    integer ; begindate_1     char(10); enddate_1	    char(10) ; resourceid_1    integer ; tmpcount_1	    integer ; tmpbegindate_1   char(10); tmpenddate_1    char(10); tmpid_1       integer ; begin prjid_1:=:old.prjid ; select name into subject_1 from prj_projectinfo where id=prjid_1 ;  tmpbegindate_1:= '' ; tmpenddate_1:= '' ; begindate_1:=:new.begindate ; enddate_1:=:new.enddate ; if ( begindate_1 !='x' or enddate_1 != '-' ) and :new.isdelete <> 1 then resourceid_1:=:new.hrmid ; if begindate_1 = 'x' then begindate_1:=enddate_1 ; end if ; if enddate_1 = '-' then enddate_1:=begindate_1 ; end if ;  select count(id) into tmpcount_1 from bill_hrmtime where resourceid=resourceid_1 and requestid=prjid_1 and basictype=1 ;  if tmpcount_1 > 0 then select id,begindate,enddate into tmpid_1,tmpbegindate_1,tmpenddate_1 from bill_hrmtime where resourceid=resourceid_1 and requestid=prjid_1 and basictype=1 ;  if tmpbegindate_1 > begindate_1 then tmpbegindate_1:=begindate_1 ; end if ;  if tmpenddate_1 < enddate_1 then tmpenddate_1:=enddate_1 ; end if ; update bill_hrmtime set begindate=tmpbegindate_1 ,enddate=tmpenddate_1 where id=tmpid_1 ; else if tmpcount_1 = 0 then insert into bill_hrmtime (resourceid,basictype,detailtype,requestid,name,begindate,enddate,status,accepterid) values (resourceid_1,1,1,prjid_1,subject_1,begindate_1,enddate_1,'0',to_char(resourceid_1)) ; end if ; end if ; end if ; end ;
/

create or replace trigger Tri_U_bill_HrmTimeByMeet1 after update ON Meeting FOR each row 
when (new.isapproved=3)
Declare name_1          varchar2(4000) ; isapproved_1    integer ; begindate_1	    char(10) ; begintime_1     char(8) ; enddate_1       char(10) ; endtime_1       char(8) ; resourceid_1    integer ; meetingid_1     integer ; caller_1        integer ; contacter_1     integer ; tmpcount_1      integer ; begin meetingid_1 := :new.id ; begindate_1 := :new.begindate ; enddate_1 := :new.enddate ; begintime_1 := :new.begintime ; endtime_1 := :new.endtime ; name_1 := :new.name ; caller_1 := :new.caller ; contacter_1 := :new.contacter ;  delete from bill_hrmtime where requestid=meetingid_1 and basictype=5 and detailtype=1 ;  insert into bill_hrmtime (resourceid,requestid,basictype,detailtype,name,begindate,begintime,enddate,endtime,status,accepterid) values (caller_1,meetingid_1,5,1,name_1,begindate_1,begintime_1,enddate_1,endtime_1,'0',to_char(caller_1)) ;  insert into bill_hrmtime (resourceid,requestid,basictype,detailtype,name,begindate,begintime,enddate,endtime,status,accepterid) values (contacter_1,meetingid_1,5,1,name_1,begindate_1,begintime_1,enddate_1,endtime_1,'0',to_char(contacter_1)) ;  for tmp_cursor in ( select memberid from Meeting_Member2 where meetingid=meetingid_1 and membertype = 1 ) loop resourceid_1 := tmp_cursor.memberid ; insert into bill_hrmtime (resourceid,requestid,basictype,detailtype,name,begindate,begintime,enddate,endtime,status,accepterid) values (resourceid_1,meetingid_1,5,1,name_1,begindate_1,begintime_1,enddate_1,endtime_1,'0',to_char(resourceid_1)) ; end loop ; end ;
/
create or replace trigger Tri_U_bill_HrmTimeByMeet2 after update ON Meeting_Member2 FOR each row 
when (new.othermember<>'' or new.othermember <> null )
Declare recordid_1   integer ; name_1       varchar2(4000) ; begindate_1	 char(10) ; begintime_1  char(8) ; enddate_1    char(10) ; endtime_1    char(8) ; meetingid_1     integer ; othermember_1     varchar2(4000) ; tmpcount_1     integer ; tmpid_1        integer ; begin recordid_1 := :new.id ; meetingid_1 := :new.meetingid ; othermember_1 := :new.othermember ; select name,begindate,enddate,begintime,endtime into name_1,begindate_1,enddate_1,begintime_1,endtime_1 from meeting where id=meetingid_1 ;  select count(id) into tmpcount_1 from bill_hrmtime where requestid=meetingid_1 and billid=recordid_1 and basictype=5 and detailtype=1 ; if tmpcount_1 = 0 then insert into bill_hrmtime (billid,resourceid,requestid,basictype,detailtype,name,begindate,begintime,enddate,endtime,status,accepterid) values (recordid_1,0,meetingid_1,5,1,name_1,begindate_1,begintime_1,enddate_1,endtime_1,'0',othermember_1) ; else if tmpcount_1 > 0 then select id into tmpid_1 from bill_hrmtime where requestid=meetingid_1 and billid=recordid_1 and basictype=5 and detailtype=1 ; update bill_hrmtime set accepterid=othermember_1,begindate=begindate_1,enddate=enddate_1,begintime=begintime_1,endtime=endtime_1 where id=tmpid_1 ; end if ; end if ; end ;
/

CREATE OR REPLACE TRIGGER TRI_U_BILL_WORKPLANBYMEET1 AFTER UPDATE ON MEETING REFERENCING NEW AS NEW OLD AS OLD FOR EACH ROW 
when (new.isapproved = 2)
Declare name_1          varchar2(4000); isapproved_1    integer; begindate_1     char(10); begintime_1     char(8); enddate_1       char(10); endtime_1       char(8); createdate_1    char(10); createtime_1    char(8); resourceid_1    integer; meetingid_1     integer; caller_1        integer; contacter_1     integer; allresource_1   varchar2(4000); managerstr_1    varchar2(4000); managerid       integer; tmpcount        integer; userid_1        integer; usertype_1      integer; sharelevel_1    integer; workplanid_1    integer; workplancount_1 integer; m_deptId        integer; m_subcoId       integer;     begin name_1       := :new.name; begindate_1  := :new.begindate; begintime_1  := :new.begintime; enddate_1    := :new.enddate; endtime_1    := :new.endtime;   caller_1     := :new.caller; createdate_1 := :new.createdate; createtime_1 := :new.createtime; contacter_1  := :new.contacter; if enddate_1 = '' then enddate_1 := begindate_1; end if;     SELECT departmentid, subcompanyid1 into m_deptId, m_subcoId FROM HrmResource WHERE id = caller_1;   INSERT INTO WorkPlan (type_n, name, resourceid, begindate, begintime, enddate, endtime, description, requestid, projectid, crmid, docid, meetingid, status, isremind, waketime, createrid, createdate, createtime, deleted, urgentLevel, deptId, subcompanyId) values ('1', name_1, allresource_1, begindate_1, begintime_1, enddate_1, endtime_1, '', '0', '0', '0', '0', meetingid_1, '0', '1', '0', caller_1, createdate_1, createtime_1, '0', '1', m_deptId, m_subcoId); select id into workplanid_1 from WorkPlan where rownum = 1 order by id desc; allresource_1 := to_char(caller_1); if INSTR(concat(',', concat(allresource_1, ',')), concat('%,', concat(to_char(contacter_1), ',%'))) = 0 then  allresource_1 := concat(allresource_1, concat(',', to_char(contacter_1))); allresource_1 := to_char(caller_1); end if; insert into temptablevalueWork values (workplanid_1, caller_1, 1, 2); managerstr_1 := ''; select managerstr into managerstr_1 from HrmResource where id = caller_1; managerstr_1 := concat('%,', concat(managerstr_1, '%')); for allmanagerid_cursor in (select id from HrmResource where concat(',', concat(to_char(id), ',')) like managerstr_1) loop select count(workid) into workplancount_1 from temptablevalueWork where workid = workplanid_1 and userid = managerid; if workplancount_1 = 0 then insert into temptablevalueWork values (workplanid_1, managerid, 1, 1); end if; end loop;   select count(workid) into workplancount_1 from temptablevalueWork where workid = workplanid_1 and userid = contacter_1; if workplancount_1 = 0 then insert into temptablevalueWork values (workplanid_1, contacter_1, 1, 1); managerstr_1 := ''; select managerstr into managerstr_1 from HrmResource where id = contacter_1; managerstr_1 := concat('%,', concat(managerstr_1, '%')); for allmanagerid_cursor in (select id from HrmResource where concat(',', concat(to_char(id), ',')) like managerstr_1) loop select count(workid) into workplancount_1 from temptablevalueWork where workid = workplanid_1 and userid = managerid; if workplancount_1 = 0 then insert into temptablevalueWork values (workplanid_1, managerid, 1, 1); end if; end loop; end if;  for detail_cursor in (select memberid from Meeting_Member2 where meetingid = meetingid_1 and membertype = 1) loop  if INSTR(concat(',', concat(allresource_1, ',')), concat('%,', concat(to_char(resourceid_1), ',%'))) = 0 then  allresource_1 := concat(allresource_1, concat(',', to_char(resourceid_1))); select count(workid) into workplancount_1 from temptablevalueWork where workid = workplanid_1 and userid = resourceid_1; if workplancount_1 = 0 then insert into temptablevalueWork values (workplanid_1, resourceid_1, 1, 1); managerstr_1 := ''; select managerstr into managerstr_1 from HrmResource where id = resourceid_1; managerstr_1 := concat('%,', concat(managerstr_1, '%')); for allmanagerid_cursor in (select id from HrmResource where concat(',', concat(to_char(id), ',')) like managerstr_1) loop select count(workid) into workplancount_1 from temptablevalueWork where workid = workplanid_1 and userid = managerid; if workplancount_1 = 0 then insert into temptablevalueWork values (workplanid_1, managerid, 1, 1); end if; end loop; end if; end if; end loop; update WorkPlan set resourceid = allresource_1 where id = workplanid_1; for allmeetshare_cursor in (select * from temptablevalueWork) loop insert into WorkPlanShareDetail (workid, userid, usertype, sharelevel) values (meetingid_1, userid_1, usertype_1, sharelevel_1); end loop; end;
/

create or replace trigger workplanviewlog_trigger after insert on workplanviewlog for each row 
DECLARE relatedname varchar(400); begin select  name into relatedname from workplan where id=:new.workPlanId;  SysMaintenanceLog_proc( :new.workPlanId, relatedname, :new.userId, :new.usertype, :new.viewType, '计划任务', '91', :new.logDate, :new.logTime, 1, :new.ipAddress, 0 ); end;
/
