/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._matrixmanage._pages;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import java.util.*;
import weaver.general.*;
import weaver.hrm.User;
import weaver.hrm.HrmUserVarify;
import java.io.OutputStream;
import weaver.matrix.MatrixUtil;
import weaver.workflow.workflow.GetShowCondition;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.apache.poi.hssf.usermodel.HSSFSheet;
import org.apache.poi.hssf.usermodel.HSSFRow;
import org.apache.poi.hssf.usermodel.HSSFCellStyle;
import org.apache.poi.hssf.usermodel.HSSFCell;
import org.apache.poi.hssf.usermodel.HSSFFont;
import org.apache.poi.hssf.util.HSSFColor;
import weaver.systeminfo.SystemEnv;
import de.schlichtherle.io.FileOutputStream;
import java.io.File;
import weaver.general.GCONST;

public class _matrixexporttofile__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.conn.RecordSet RecordSet;
      RecordSet = (weaver.conn.RecordSet) pageContext.getAttribute("RecordSet");
      if (RecordSet == null) {
        RecordSet = new weaver.conn.RecordSet();
        pageContext.setAttribute("RecordSet", RecordSet);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet rs;
      rs = (weaver.conn.RecordSet) pageContext.getAttribute("rs");
      if (rs == null) {
        rs = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs", rs);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.matrix.MatrixManager MatrixManager;
      MatrixManager = (weaver.matrix.MatrixManager) pageContext.getAttribute("MatrixManager");
      if (MatrixManager == null) {
        MatrixManager = new weaver.matrix.MatrixManager();
        pageContext.setAttribute("MatrixManager", MatrixManager);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.company.SubCompanyComInfo SubCompanyComInfo;
      SubCompanyComInfo = (weaver.hrm.company.SubCompanyComInfo) pageContext.getAttribute("SubCompanyComInfo");
      if (SubCompanyComInfo == null) {
        SubCompanyComInfo = new weaver.hrm.company.SubCompanyComInfo();
        pageContext.setAttribute("SubCompanyComInfo", SubCompanyComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet RecordSet1;
      RecordSet1 = (weaver.conn.RecordSet) pageContext.getAttribute("RecordSet1");
      if (RecordSet1 == null) {
        RecordSet1 = new weaver.conn.RecordSet();
        pageContext.setAttribute("RecordSet1", RecordSet1);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      
User user = HrmUserVarify.getUser (request , response) ;
if(user==null) {
    response.sendRedirect("/login/Login.jsp");
    return;
}
//request.setCharacterEncoding("UTF-8");
String matrixid = Util.null2String(request.getParameter("matrixid"));
String method = Util.null2String(request.getParameter("method"));
String type = Util.null2String(request.getParameter("type"));
        //\u5904\u7406\u6a21\u677f\u5bfc\u51fa
  	try{
	   //\u67e5\u8be2\u5728\u5f53\u524d\u77e9\u9635id\u4e0b\u7684\u6240\u6709\u5b57\u6bb5
	    List<String> backfiledlist = new ArrayList<String>();
	    List<String> displaynamelist = new ArrayList<String>();
	    List<String> fieldType = new ArrayList<String>();
		String sql ="select *  from MatrixFieldInfo where matrixid="+matrixid+"  order by fieldtype asc, priority";
		RecordSet.execute(sql);
	    //\u83b7\u53d6\u5f53\u524d\u8868\u7684\u6240\u6709\u5b57\u6bb5\uff0c\u4e0d\u5305\u62ecid
        while(RecordSet.next()){
        	backfiledlist.add(RecordSet.getString("fieldname"));	
        	displaynamelist.add(RecordSet.getString("displayname"));
        	fieldType.add(RecordSet.getString("browsertypeid"));
        }
	    
	    
	    HSSFWorkbook wb = new HSSFWorkbook(); 
	    int sheetNum = 0;
	    if(!"exportDataNoSQ".equals(method)){
	        HSSFSheet sheet0 = wb.createSheet(""+SystemEnv.getHtmlLabelName(84453,user.getLanguage())); //TODO 84453 \u77e9\u9635\u5bfc\u5165\u8bf4\u660e
	        sheet0.setColumnWidth((short)1, (short)(1000 * 256));  
	        wb.setSheetName(0,""+SystemEnv.getHtmlLabelName(84453,user.getLanguage()),HSSFWorkbook.ENCODING_UTF_16);
	        HSSFCell cell_;
	        //\u7b2c\u4e00\u884c
	        HSSFRow row0 = sheet0.createRow((int) 0); 
	        HSSFCellStyle style0 = wb.createCellStyle();  
	        style0.setAlignment(HSSFCellStyle.ALIGN_CENTER); 
	        HSSFCellStyle style_ = wb.createCellStyle();  
	        style_.setAlignment(HSSFCellStyle.ALIGN_LEFT); 
	        cell_ = row0.createCell((short) 0); 
	        cell_.setEncoding(HSSFCell.ENCODING_UTF_16);
	        cell_.setCellValue(""+SystemEnv.getHtmlLabelName(15486,user.getLanguage()));  //\u5e8f\u53f7
	        cell_.setCellStyle(style0); 
	        
	        cell_ = row0.createCell((short) 1);  
	        cell_.setEncoding(HSSFCell.ENCODING_UTF_16);
	        cell_.setCellValue(""+SystemEnv.getHtmlLabelName(25734,user.getLanguage()));    //\u8bf4\u660e 
	        cell_.setCellStyle(style_); 
	      	//\u7b2c\u4e8c\u884c
	        row0 = sheet0.createRow((int) 1);
	        cell_ = row0.createCell((short) 0); 
	        cell_.setEncoding(HSSFCell.ENCODING_UTF_16);
	        cell_.setCellValue(1);  //\u5e8f\u53f7
	        cell_.setCellStyle(style0); 
	        
	        cell_ = row0.createCell((short) 1);  
	        cell_.setEncoding(HSSFCell.ENCODING_UTF_16);
	        cell_.setCellValue(""+SystemEnv.getHtmlLabelName(84454,user.getLanguage()));    //\u8bf4\u660e 
	        cell_.setCellStyle(style_); 
	      	//\u7b2c\u4e09\u884c
	        row0 = sheet0.createRow((int) 2);
	        cell_ = row0.createCell((short) 0); 
	        cell_.setEncoding(HSSFCell.ENCODING_UTF_16);
	        cell_.setCellValue(2);  //\u5e8f\u53f7
	        cell_.setCellStyle(style0); 
	        
	        cell_ = row0.createCell((short) 1);  
	        cell_.setEncoding(HSSFCell.ENCODING_UTF_16);
	        cell_.setCellValue(""+SystemEnv.getHtmlLabelName(84455,user.getLanguage()));    //\u8bf4\u660e 
	        cell_.setCellStyle(style_); 
	      	//\u7b2c\u56db\u884c
	        row0 = sheet0.createRow((int) 3);
	        cell_ = row0.createCell((short) 0); 
	        cell_.setEncoding(HSSFCell.ENCODING_UTF_16);
	        cell_.setCellValue(3);  //\u5e8f\u53f7
	        cell_.setCellStyle(style0); 
	        
	        cell_ = row0.createCell((short) 1);  
	        cell_.setEncoding(HSSFCell.ENCODING_UTF_16);
	        cell_.setCellValue(""+SystemEnv.getHtmlLabelName(84456,user.getLanguage()));    //\u8bf4\u660e 
	        cell_.setCellStyle(style_); 
	      	//\u7b2c\u4e94\u884c
	        row0 = sheet0.createRow((int) 4);
	        cell_ = row0.createCell((short) 0); 
	        cell_.setEncoding(HSSFCell.ENCODING_UTF_16);
	        cell_.setCellValue(4);  //\u5e8f\u53f7
	        cell_.setCellStyle(style0); 
	        
	        cell_ = row0.createCell((short) 1);  
	        cell_.setEncoding(HSSFCell.ENCODING_UTF_16);
	        cell_.setCellValue(""+SystemEnv.getHtmlLabelName(84457,user.getLanguage()));    //\u8bf4\u660e 
	        cell_.setCellStyle(style_); 
	      	//\u7b2c\u516d\u884c
	        row0 = sheet0.createRow((int) 5);
	        cell_ = row0.createCell((short) 0); 
	        cell_.setEncoding(HSSFCell.ENCODING_UTF_16);
	        cell_.setCellValue(5);  //\u5e8f\u53f7
	        cell_.setCellStyle(style0); 
	        
	        cell_ = row0.createCell((short) 1);  
	        cell_.setEncoding(HSSFCell.ENCODING_UTF_16);
	        cell_.setCellValue(""+SystemEnv.getHtmlLabelName(84458,user.getLanguage()));    //\u8bf4\u660e 
	        cell_.setCellStyle(style_);
	      	//\u7b2c\u4e03\u884c
	        row0 = sheet0.createRow((int) 6);
	        cell_ = row0.createCell((short) 0); 
	        cell_.setEncoding(HSSFCell.ENCODING_UTF_16);
	        cell_.setCellValue(6);  //\u5e8f\u53f7
	        cell_.setCellStyle(style0); 
	        
	        cell_ = row0.createCell((short) 1);  
	        cell_.setEncoding(HSSFCell.ENCODING_UTF_16);
	        cell_.setCellValue(""+SystemEnv.getHtmlLabelName(84580,user.getLanguage()));    //\u8bf4\u660e 
	        cell_.setCellStyle(style_);
	        
	        sheetNum++;
	    }
	        HSSFSheet sheet = wb.createSheet(""+SystemEnv.getHtmlLabelName(84452,user.getLanguage()));  //TODO 84452 \u77e9\u9635\u5bfc\u5165\u6a21\u677f
	        sheet.setDefaultColumnWidth( (short)15);
	        wb.setSheetName(sheetNum,""+SystemEnv.getHtmlLabelName(84452,user.getLanguage()),HSSFWorkbook.ENCODING_UTF_16);
	        HSSFRow row = sheet.createRow((int) 0);  
	        HSSFCellStyle style = wb.createCellStyle();  
	        style.setAlignment(HSSFCellStyle.ALIGN_CENTER); 
	        HSSFCellStyle style1 = wb.createCellStyle(); 
	        HSSFFont font = wb.createFont();
	        font.setColor(HSSFColor.GREY_50_PERCENT.index);
	        style1.setFont(font);
	        HSSFCell cell;
	        int cellNum = 0;
	        if("exportData".equals(method)){
		        cell = row.createCell((short) 0);  
		        cell.setEncoding(HSSFCell.ENCODING_UTF_16);
		        cell.setCellValue("UUID("+SystemEnv.getHtmlLabelName(129277, user.getLanguage())+")");  
		        cell.setCellStyle(style1); 
		        cellNum++;
	        }
	        HSSFCellStyle style2 = wb.createCellStyle(); 
	        HSSFFont font2 = wb.createFont();
	        font2.setColor(HSSFColor.ORANGE.index);
	        font2.setBoldweight(HSSFFont.BOLDWEIGHT_BOLD);
	        style2.setFont(font2);
	        style2.setAlignment(HSSFCellStyle.ALIGN_CENTER); 
	        for (int i = cellNum; i < displaynamelist.size()+cellNum; i++)  
	        {  
	        	cell = row.createCell((short) (i));  
		        cell.setEncoding(HSSFCell.ENCODING_UTF_16);
		        cell.setCellValue(displaynamelist.get("exportData".equals(method)?i-1:i));  
		        cell.setCellStyle(style2);  
	        }
	        if("exportData".equals(method)||"exportDataNoSQ".equals(method)){
	        	Map<String, Map<String, String>>  fieldinfos=MatrixUtil.getFieldDetail(matrixid);
	        	//\u6839\u636eid\u503c\u83b7\u53d6\u5177\u4f53\u7684\u540d\u79f0
	        	GetShowCondition conditions=new GetShowCondition();
	        	String dbType = RecordSet1.getDBType();
	        	String dataorder = "dataorder";
	        	if("oracle".equalsIgnoreCase(dbType)){
	        		dataorder = "dataorder-1";
	        	}else if("sqlserver".equalsIgnoreCase(dbType)){
	        		dataorder = "cast(dataorder as float)";
	        	}
	        	sql ="select *  from "+MatrixUtil.MATRIXPREFIX+matrixid +"  order by "+dataorder;
	        	RecordSet1.execute(sql);
	        	int rowNum =1;
	        	while(RecordSet1.next())
	        	{  
		        	row = sheet.createRow((int) rowNum);
	        		if(!"exportDataNoSQ".equals(method)){
		        		cell = row.createCell((short) 0);  
	      			  	cell.setCellValue(RecordSet1.getString("UUID"));  
	    		        cell.setCellStyle(style1);
	        		}
	        		  //\u6dfb\u52a0\u5217\u503c
	        		  for(int i=0;i<backfiledlist.size();i++){
	        			  String filedValue = RecordSet1.getString(backfiledlist.get(i));
	        			  String showName = "";
      			  		  String isExists = ""; 
      			  		  boolean isRed = false;
	        			  if(!"".equals(filedValue)){
	        				  if("exportDataNoSQ".equals(method)){
	        					  showName = MatrixUtil.getSpanValueByIds(fieldinfos.get(backfiledlist.get(i).toLowerCase()),conditions,filedValue);
	        					  if("162".equals(fieldType.get(i))||"17".equals(fieldType.get(i))){ //\u81ea\u5b9a\u4e49\u591a\u9009
			        				  showName = showName.replace(",",";");
			        			  }
	        				  }else{
			        			  if("1".equals(fieldType.get(i))||"17".equals(fieldType.get(i))){//\u4eba\u5458
			        				  showName =MatrixManager.getResource(filedValue);
			        			  }else if("164".equals(fieldType.get(i))){ // \u5206\u90e8\u7c7b\u578b
			        				  showName =MatrixManager.getSubcompany(filedValue);
				        			  	isExists = "select * from hrmsubcompany where id = "+filedValue+" and canceled='1' ";
				        			  	rs.executeSql(isExists);
				        			  
								  	if(rs.next()){
				        			  		isRed = true;
				        			  		if(!"".equals(showName)){
				        				  showName += ">"+Util.null2String(rs.getString("subcompanyname"))+"("+SystemEnv.getHtmlLabelName(22151,user.getLanguage())+")";
				        			  		}else{
				        			  			showName = Util.null2String(rs.getString("subcompanyname"))+"("+SystemEnv.getHtmlLabelName(22151,user.getLanguage())+")";
				        			  		}
				        			  	}
			        			  }else if("4".equals(fieldType.get(i))){ // \u90e8\u95e8\u7c7b\u578b
			        				  showName =MatrixManager.getDepartment(filedValue);
			        			  	isExists = "select * from hrmdepartment where id = "+filedValue+" and canceled='1' ";
			        			  	rs.executeSql(isExists);
			        			  	if(rs.next()){
			        			  		isRed = true;
			        			  		if(!"".equals(showName)){
			        				  showName += "/"+Util.null2String(rs.getString("departmentname"))+"("+SystemEnv.getHtmlLabelName(22151,user.getLanguage())+")";
			        			  		}else{
			        			  			showName = MatrixManager.getSubcompany(rs.getString("subcompanyid1"));
			        				  		showName += "/"+Util.null2String(rs.getString("departmentname"))+"("+SystemEnv.getHtmlLabelName(22151,user.getLanguage())+")";
			        			  		}
			        			  	}
			        			  }else if("24".equals(fieldType.get(i))){ // \u5c97\u4f4d\u7c7b\u578b
			        				  showName =MatrixManager.getJobTitleName(filedValue);
			        			  }else{
				        			  showName = MatrixUtil.getSpanValueByIds(fieldinfos.get(backfiledlist.get(i).toLowerCase()),conditions,filedValue);
			        			  }
			        			  if("162".equals(fieldType.get(i))){ //\u81ea\u5b9a\u4e49\u591a\u9009
			        				  showName = showName.replace(",",";");
			        			  }
	        				  }
	      					  showName = Util.formatMultiLang(showName,""+user.getLanguage());
	        			  }
	        			  cell = row.createCell((short) (i+sheetNum));  
	        			  cell.setEncoding(HSSFCell.ENCODING_UTF_16);
	        			  cell.setCellValue(showName);  
	        			  if(isRed){
					        HSSFFont font3 = wb.createFont();
	        				HSSFCellStyle style3 = wb.createCellStyle(); 
					        font3.setColor(HSSFColor.RED.index);
					        style3.setFont(font3);
		      		          cell.setCellStyle(style3);	
	        			  }else{
	      		          cell.setCellStyle(style);
	        			  }
	        		  }
	        		  rowNum++;
	        	}
	        	
	        	
	        }
	        String name = "";
	        RecordSet1.executeSql("select issystem,name from MatrixInfo where id =" +matrixid);
	        if(RecordSet1.next()){
	        	name = RecordSet1.getString("name");
	        }
	        name += SystemEnv.getHtmlLabelName(84477,user.getLanguage());
	        String tmpfile = GCONST.getRootPath()+"matrixmanage"+File.separator+"pages"+File.separator+"tmpfile";
	        File f = new  File(tmpfile);
	        if(!f.exists() && !f .isDirectory()) f.mkdir();
	        String lab = String.valueOf(new Date().getTime());
	       String webPath = GCONST.getRootPath()+"matrixmanage"+File.separator+"pages";
	       // \u901a\u8fc7\u4e0a\u4e0b\u6587\u6765\u53d6\u5de5\u7a0b\u8def\u5f84 
		    try{
		        	webPath = GCONST.getRootPath();
		            webPath += "matrixmanage"+f.separator+"pages"+f.separator+"tmpfile"+f.separator;  
	        	if(webPath == null){
	        	}else{
					//webPath += "tmpfile"+f.separator;
				}
	        }catch(Exception e){
	        	RecordSet.writeLog(e);
	        }
	        name = name.replace("/","-");
	        name = name.replace("\\","-");
	        File file1 = new File(webPath);
	        if(!file1.exists() && !file1.isDirectory()){
	        	file1 .mkdir();
	        }
	        String path = webPath+name+"_"+lab+".xls";
	        File file = new File(path);
	        OutputStream fos = new FileOutputStream(file); 
	        wb.write(fos);
	        fos.flush();
	        fos.close();
	        out.write(name+"_"+lab);
  	}catch(Exception e){
  	e.printStackTrace();
  		RecordSet.writeLog("matrixexportFile>>>>>>"+e.getMessage());
  	}finally{
  		
  	}

      out.write(_jsp_string1, 0, _jsp_string1.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("matrixmanage/pages/MatrixExportToFile.jsp"), 5527487505094497831L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string1;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
  }
}
