/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._email._new;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.general.*;
import net.sf.json.JSONObject;
import weaver.email.WeavermailUtil;
import weaver.splitepage.transform.SptmForMail;
import weaver.conn.RecordSet;
import weaver.email.MailSend;
import java.io.File;
import weaver.email.service.MailManagerService;
import org.apache.commons.lang.StringUtils;
import java.util.*;
import weaver.hrm.*;
import weaver.systeminfo.*;
import weaver.general.StaticObj;
import weaver.general.Util;
import weaver.hrm.settings.RemindSettings;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

public class _mailmanageoperation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;

  
  	public String getBelongMailIds(int userId, String mailIds) {
  	    // \u83b7\u5f97\u8fd9\u4e2a\u7528\u6237\u4e0b\u53ef\u5220\u9664\u7684\u90ae\u4ef6ID\uff0c\u653e\u7f6e\u53d8\u66f4\u7528\u6237\u540e\u66f4\u6539mailIds\u653b\u51fb
  	    List<String> ids = new ArrayList<String>();
  	    try {
  	        RecordSet recordSet = new RecordSet();
  		    String resourceids = MailManagerService.getAllResourceids(String.valueOf(userId));
  		    String sql = "SELECT id FROM MailResource WHERE (" + Util.getSubINClause(resourceids, "resourceid", "in") + ") AND (" +  Util.getSubINClause(mailIds, "id", "in") + ")";
  		    recordSet.executeQuery(sql);
  		    while(recordSet.next()) {
  		        ids.add(recordSet.getString("id"));
  		    }
  	    } catch(Exception e) {
  	        ids.clear(); //\u5982\u679c\u51fa\u9519\uff0c\u5219 \u8ba4\u4e3a\u6ca1\u6709\u53ef\u64cd\u4f5c\u7684mailid
  	        new BaseBean().writeLog(e);
  	    }
  	    
  	    return ids.isEmpty() ? "" : StringUtils.join(ids, ",");
  	}

  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=utf-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      
	
	response.setHeader("cache-control", "no-cache");
	response.setHeader("pragma", "no-cache");
	response.setHeader("expires", "Mon 1 Jan 1990 00:00:00 GMT");
	

	User user = HrmUserVarify.getUser (request , response) ;
	if(user == null)  return ;
	Log logger= LogFactory.getLog(this.getClass());
	String isIE = (String)session.getAttribute("browser_isie");

      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.email.service.MailResourceService mrs;
      mrs = (weaver.email.service.MailResourceService) pageContext.getAttribute("mrs");
      if (mrs == null) {
        mrs = new weaver.email.service.MailResourceService();
        pageContext.setAttribute("mrs", mrs);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.email.service.MailSettingService mss;
      mss = (weaver.email.service.MailSettingService) pageContext.getAttribute("mss");
      if (mss == null) {
        mss = new weaver.email.service.MailSettingService();
        pageContext.setAttribute("mss", mss);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.conn.RecordSet rs;
      rs = (weaver.conn.RecordSet) pageContext.getAttribute("rs");
      if (rs == null) {
        rs = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs", rs);
      }
      out.write(_jsp_string3, 0, _jsp_string3.length);
      
	String operation = Util.null2String(request.getParameter("operation"));
	String[] mailsId = Util.null2String(request.getParameter("mailsId")).split(",");
	String mailId = Util.null2String(request.getParameter("mailId"));
	String mailIds = Util.null2String(request.getParameter("mailIds"));
	String lableId = Util.null2String(request.getParameter("lableId"));
	String star = Util.null2String(request.getParameter("star"));
	String movetoFolder = Util.null2String(request.getParameter("movetoFolder"));
	String status = Util.null2String(request.getParameter("status"));
	String folderid = Util.null2String(request.getParameter("folderid"));
	String replycontent = Util.fromScreen(Util.null2String(request.getParameter("replycontent")), user.getLanguage());  //\u5feb\u6377\u56de\u590d\u4e3a\u7eaf\u6587\u672c\u5185\u5bb9\uff0c\u8f6c\u4e49\u9632\u6b62html\u4ee3\u7801\u7b49\u95ee\u9898\u6f0f\u6d1e
	
	if(operation.equals("getMailcontent")){     
		JSONObject json = new JSONObject();
		json.put("mailcontent", (String)session.getAttribute("mailcontent"));
		session.removeAttribute("mailcontent");
		out.println(json);
	}
    
    else if(operation.equals("checkEml")) {
		String sql = "select haseml, emlpath, emlName, subject from MailResource where id in (" + mailIds + ")";
		boolean emlexist = false;
		try{
			rs.execute(sql);
			while(rs.next()) {
				String emlpath = Util.null2String(rs.getString("emlpath"));
                if(new File(emlpath).exists()) {
                	emlexist = true;
                    break;
                }
			}
		}catch(Exception e){
			logger.error(e);
		}
		out.print(emlexist);
		return;
	}
	
    else if(operation.equals("addLable")) {
        String finalMailIds = getBelongMailIds(user.getUID(), StringUtils.join(mailsId, ","));
        if(!finalMailIds.isEmpty()) {
			mrs.addLable(Util.TokenizerString2(finalMailIds, ","), lableId);
        }
	} 
    
    else if(operation.equals("removeLable")) {
        String finalMailIds = getBelongMailIds(user.getUID(), mailId);
        if(!finalMailIds.isEmpty()) {
            mrs.removeLable(finalMailIds, lableId);
        }
	} 
    
    else if(operation.equals("updateStar")) {
        String finalMailIds = getBelongMailIds(user.getUID(), mailId);
        if(!finalMailIds.isEmpty()) {
            mrs.updateStar(finalMailIds, star);
        }
	}
    
    else if(operation.equals("move")){
        String finalMailIds = getBelongMailIds(user.getUID(), mailId);
        if(!finalMailIds.isEmpty()) {
            mrs.moveMailToFolder(finalMailIds, movetoFolder);
        }
	}
    
    else if(operation.equals("delete")){
		 String emlPath=application.getRealPath("")+"email\\eml\\";
		 mrs.deleteMail(mailId, user.getUID(), emlPath);
		 rs.execute("select totalspace, occupyspace from hrmresource where id = "+user.getUID());
		 float totalspace = 0f;
		 float occupyspace = 0f; 
		 while(rs.next()){
		     totalspace = Util.getFloatValue(rs.getString("totalspace"), 0f);
			 occupyspace = Util.getFloatValue(rs.getString("occupyspace"), 0f); 
		 }
		 out.println(occupyspace+","+totalspace);
	}
    
    else if(operation.equals("updateStatus")){
		mrs.updateMailResourceStatus(status,mailId,user.getUID());
		//update mail.readdate
		if("1".equals(status)){
		    String finalMailIds = getBelongMailIds(user.getUID(), mailId);
	        if(!finalMailIds.isEmpty()) {
	            mrs.updateMailResourceReaddate(finalMailIds);
	        }
			
		}
	}
    
    else if(operation.equals("editLayout")){
		String layout  = Util.null2String(request.getParameter("layout"));
		mss.updateLayout(user.getUID(), layout);
	}
    
    else if (operation.equals("deleteAll")){
		 String emlPath=application.getRealPath("")+"email\\eml\\";
		 mrs.deleteFolderMail(folderid, user.getUID(), emlPath);
	}
    
    else if (operation.equals("cancelLabel")){
        String finalMailIds = getBelongMailIds(user.getUID(), StringUtils.join(mailsId, ","));
        if(!finalMailIds.isEmpty()) {
            String[] finalMailIdsArr = Util.TokenizerString2(finalMailIds, ",");
            for(int i=0;i<finalMailIdsArr.length;i++){
    			mrs.removeALLLable(finalMailIdsArr[i], lableId);
    		}
        }
	}
    
    else if (operation.equals("getAllTO")){ //\u83b7\u53d6\u6240\u6709\u53d1\u4ef6\u4eba
		String mailaddress  = Util.null2String(request.getParameter("mailaddress"));
		SptmForMail sptmForMail = new SptmForMail(); 
		String mailAddressStr=sptmForMail.getNameByEmailTOP(mailaddress,""+user.getUID(),"all");
		mailAddressStr+="&nbsp;&nbsp;<a href='javascript:void(0)' style='color:blue' onclick=\"hideALL(this)\">[\u6536\u7f29]</a>";
		out.println(mailAddressStr);
	}
    
    else if(operation.equals("recall")){//\u64a4\u56de\u64cd\u4f5c
		String flag = "true";
    
    	String finalMailId = getBelongMailIds(user.getUID(), mailId);
    	if(finalMailId.isEmpty()) {
    	    out.println("false");
    	    return;
    	}
    	
		try{
			//update MailResource
			String sb = SystemEnv.getHtmlLabelName(32063, user.getLanguage());  //\u53d1\u4fe1\u65b9\u5df2\u64a4\u56de\u90ae\u4ef6
			String ct = SystemEnv.getHtmlLabelName(32064, user.getLanguage());  //\u8be5\u90ae\u4ef6\u5df2\u7ecf\u88ab\u53d1\u9001\u8005\u64a4\u56de
			String sql = "";
			if("oracle".equals(rs.getDBType())){
				sql = "update MailResource set subject =concat('"+sb+":',subject) "+
				" , content = '"+ct+"' , attachmentNumber = 0 where originalMailId ="+mailId+
				" AND id NOT IN(SELECT id FROM MailResource WHERE subject LIKE '%"+sb+":%')";
				rs.execute("update mailcontent set mailcontent = '"+ct+"' where mailid in (select id from mailresource where originalMailId = "+mailId+")");
			}else{
				sql = "update MailResource set subject ='"+sb+":'+subject "+
				" , content = '"+ct+"' , attachmentNumber = 0 where originalMailId ="+mailId+
				" AND id NOT IN(SELECT id FROM MailResource WHERE subject LIKE '%"+sb+":%')";
			}
			rs.execute(sql);
			
			//delete MailResourceFile
			sql = "DELETE FROM MailResourceFile WHERE mailid IN (SELECT id FROM MailResource WHERE originalMailId = "+mailId+" )";
			rs.execute(sql);
			
			//update mailresource recallstate
			sql = "update MailResource set recallState = 1 where id ="+mailId;
			rs.execute(sql);
			
			rs.execute("select subject from MailResource where id = "+mailId);
			rs.next();
			int totalsize = (rs.getString("subject")+sb).getBytes().length+ct.getBytes().length;
			sql = "UPDATE MailResource SET size_n = '"+totalsize+"' WHERE originalMailId = '"+mailId+"'";
			rs.execute(sql);
			
			rs.execute("select resourceid from MailResource where originalMailId = "+mailId);
			RecordSet childSet = new RecordSet();
			while(rs.next()){
				sql = "UPDATE HrmResource SET occupySpace = " +
					  " round((select sum(size_n) from MailResource where resourceid = "+rs.getString("resourceid")+" and canview=1)*1.0/(1024*1024),2)" +
					  " WHERE id = "+ rs.getString("resourceid");
				childSet.execute(sql);
			}
		}catch(Exception e){
			flag = "false";
			new BaseBean().writeLog(e);
		}
		out.println(flag);
	}
    
    else if(operation.equals("fastReply")){
        String finalMailId = getBelongMailIds(user.getUID(), mailId);
    	if(!finalMailId.isEmpty()) {
    	    MailSend mailSend = new MailSend();
    		String state = mailSend.fastReply(mailId ,replycontent ,user,"fastReply");
    		out.println(state);
    	} else {
    	    out.println("false");
    	}
	}
    
    else if(operation.equals("receiveNeedReceipt")){
        String finalMailId = getBelongMailIds(user.getUID(), mailId);
    	if(!finalMailId.isEmpty()) {
    	    rs.execute("update MailResource set receiveNeedReceipt = 2 WHERE id="+mailId);
    		MailSend mailSend = new MailSend();
    		String state = mailSend.fastReply(mailId ,SystemEnv.getHtmlLabelName(83116,user.getLanguage()) ,user,"receiveNeedReceipt");
    		out.println(state);
    	} else {
    	    out.println("false");
    	}
	}
    
    else if(operation.equals("readReceipt")) {
        String finalMailId = getBelongMailIds(user.getUID(), mailId);
    	if(!finalMailId.isEmpty()) {
    	    rs.execute("update MailResource set receiveNeedReceipt = 2 WHERE id="+mailId);
    	}
	}

    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("email/new/MailManageOperation.jsp"), -4096206614095489897L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
    depend = new com.caucho.vfs.Depend(appDir.lookup("page/maint/common/initNoCache.jsp"), 3270256153856711871L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string3;
  private final static char []_jsp_string2;
  private final static char []_jsp_string1;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n \r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string3 = "\r\n\r\n\r\n".toCharArray();
    _jsp_string2 = "\r\n".toCharArray();
    _jsp_string1 = "\r\n\r\n".toCharArray();
  }
}
