/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._blog;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.general.Util;
import java.text.SimpleDateFormat;
import java.util.Date;
import weaver.conn.*;
import java.util.HashMap;
import net.sf.json.JSONObject;
import weaver.hrm.User;
import weaver.hrm.HrmUserVarify;
import java.util.ArrayList;
import weaver.blog.BlogDao;
import weaver.blog.BlogReplyVo;
import weaver.blog.BlogDiscessVo;
import weaver.systeminfo.SystemEnv;

public class _blogcommentoparation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.conn.RecordSet rs;
      rs = (weaver.conn.RecordSet) pageContext.getAttribute("rs");
      if (rs == null) {
        rs = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs", rs);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.ConnStatement cs;
      cs = (weaver.conn.ConnStatement) pageContext.getAttribute("cs");
      if (cs == null) {
        cs = new weaver.conn.ConnStatement();
        pageContext.setAttribute("cs", cs);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      
    User user = HrmUserVarify.getUser (request , response) ;
    request.setCharacterEncoding("UTF-8");
    HashMap result=new HashMap();
    if(user==null){
        result.put("status","2"); //\u8d85\u65f6
        JSONObject json=JSONObject.fromObject(result);
        out.println(json);
        return ;
    }
    Date today=new Date();
    String userid=""+user.getUID();
    String curDate=new SimpleDateFormat("yyyy-MM-dd").format(today);//\u5f53\u524d\u65e5\u671f
    String curTime=new SimpleDateFormat("HH:mm:ss").format(today);//\u5f53\u524d\u65f6\u95f4
    
    SimpleDateFormat dateFormat=new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    SimpleDateFormat dateFormat3=new SimpleDateFormat("yyyy\u5e74M\u6708d\u65e5 HH:mm");
    
    String content=Util.null2String(request.getParameter("content"));//\u65e5\u5fd7\u5185\u5bb9
    String discussid=Util.null2String(request.getParameter("discussid"));//\u88ab\u8bc4\u8bba\u7684\u65e5\u5fd7id
    String replyid=Util.null2String(request.getParameter("replyid"));//\u88ab\u8bc4\u8bba\u7684\u8bc4\u8bba\u7684id
    String tempreplyid=Util.null2String(request.getParameter("replyid")); //\u88ab\u8bc4\u8bba\u7684\u8bc4\u8bba\u7684id
    
    String relatedid=Util.null2String(request.getParameter("relatedid")); //\u8bc4\u8bba\u4e2d\u76f8\u5173\u4ebaid
    
    String commentType=Util.null2String(request.getParameter("commentType"));//\u88ab\u8bc4\u8bba\u7684\u65e5\u5fd7id
    String workdate=Util.null2String(request.getParameter("workdate"));//\u88ab\u8bc4\u8bba\u7684\u8bc4\u8bba\u7684id
    String bediscussantid=Util.null2String(request.getParameter("bediscussantid"));//\u88ab\u8bc4\u8bba\u7684\u8bc4\u8bba\u7684id

    String action=Util.null2String(request.getParameter("action")).trim();
    
    HashMap backData=new HashMap();
    ArrayList array=new ArrayList();
    String remindSql="";
    if("add".equals(action)){
     try{
        String sql="insert into blog_reply (userid, discussid, createdate, createtime, content,comefrom,workdate,bediscussantid,commentType,relatedid)"+
            "VALUES (?, ?,?,?,?,?,?,?,?,?)";
        cs.setStatementSql(sql);
        cs.setString(1,""+userid);
        cs.setString(2,""+discussid);
        cs.setString(3,""+curDate);
        cs.setString(4,""+curTime);
        cs.setString(5,""+content);
        cs.setString(6,"0");
        cs.setString(7,""+workdate);
        cs.setString(8,""+bediscussantid);
        cs.setString(9,""+commentType);
        cs.setString(10,""+relatedid);
        if(cs.executeUpdate()>0){ 
            cs.close();
            sql="select max(id) maxid from blog_reply where userid="+userid;
            rs.execute(sql);
            rs.next();
            replyid=rs.getString("maxid");
            result.put("status","1");
            backData.put("id",replyid);
            backData.put("discussid",discussid);
            backData.put("createDate",curDate);
            backData.put("createTime",curTime);
            backData.put("createTime",curTime);
            
            String createdatetime=dateFormat3.format(dateFormat.parse(curDate+" "+curTime));
            backData.put("createdatetime",createdatetime);
            
            backData.put("userid",new Integer(user.getUID()));
            backData.put("username",user.getLastname());
            
            backData.put("commentType",commentType);
            
            result.put("backdata",backData);
            JSONObject json=JSONObject.fromObject(result);
            out.println(json);
        }else{
            result.put("status","0");
            result.put("backdata",SystemEnv.getHtmlLabelName(83155,user.getLanguage()));
            JSONObject json=JSONObject.fromObject(result);
            out.println(json);
        }
        }catch(Exception e){}
        finally{
            cs.close();
        }
        BlogDao blogdao=new BlogDao();
        if(!"0".equals(tempreplyid)){
            
            if(!bediscussantid.equals(userid))
                blogdao.addRemind(bediscussantid,userid,"9",discussid+"|0|"+replyid,"0");
            
            if(!relatedid.equals(userid)&&!bediscussantid.equals(relatedid))
                blogdao.addRemind(relatedid,userid,"9",discussid+"|"+tempreplyid+"|"+replyid,"0");
        }else{ 
            
            if(!bediscussantid.equals(userid))
                   blogdao.addRemind(bediscussantid,userid,"9",discussid+"|0|"+replyid,"0");
        }
        // \u66f4\u65b0\u8bbf\u95ee\u8bb0\u5f55\u65f6\u95f4
        blogdao.addVisitRecord(userid, bediscussantid);
    }else if("del".equals(action)){
        replyid=Util.null2String(request.getParameter("replyid"));    //\u8bc4\u8bba\u7684id
        BlogDao blogdao=new BlogDao();
        String status=blogdao.delComment(replyid,discussid,userid);
        result.put("status",status);
        JSONObject json=JSONObject.fromObject(result);
        out.println(json);
        
    }else{
        result.put("status","-4");
        result.put("backdata",SystemEnv.getHtmlLabelName(83156,user.getLanguage()));
        JSONObject json=JSONObject.fromObject(result);
        out.println(json);
    }

      out.write(_jsp_string1, 0, _jsp_string1.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("blog/blogCommentOparation.jsp"), 8839891495513520771L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string1;
  private final static char []_jsp_string0;
  static {
    _jsp_string1 = "\r\n".toCharArray();
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n \r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
  }
}
