/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._blog;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.general.Util;
import java.text.SimpleDateFormat;
import java.util.Date;
import weaver.conn.*;
import java.util.HashMap;
import net.sf.json.JSONObject;
import java.util.ArrayList;
import weaver.hrm.User;
import weaver.hrm.HrmUserVarify;
import weaver.blog.AppDao;
import weaver.blog.BlogDao;
import weaver.blog.BlogManager;
import java.util.List;
import oracle.sql.CLOB;
import java.io.Writer;
import weaver.blog.BlogDiscessVo;
import weaver.systeminfo.SystemEnv;
import weaver.conn.ConnStatement;

public class _saveblogoperation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.conn.RecordSet rs;
      rs = (weaver.conn.RecordSet) pageContext.getAttribute("rs");
      if (rs == null) {
        rs = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs", rs);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.ConnStatement cs;
      cs = (weaver.conn.ConnStatement) pageContext.getAttribute("cs");
      if (cs == null) {
        cs = new weaver.conn.ConnStatement();
        pageContext.setAttribute("cs", cs);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      
    boolean isoracle = (cs.getDBType()).equals("oracle");
    HashMap result = new HashMap();
    User user = HrmUserVarify.getUser(request, response);
    if (user == null) {
        result.put("status", "2"); //\u8d85\u65f6
        JSONObject json = JSONObject.fromObject(result);
        out.println(json);
    } else {

        request.setCharacterEncoding("UTF-8");
        Date today = new Date();
        String userid = "" + user.getUID();
        String curDate = new SimpleDateFormat("yyyy-MM-dd").format(today);//\u5f53\u524d\u65e5\u671f
        String curTime = new SimpleDateFormat("HH:mm:ss").format(today);//\u5f53\u524d\u65f6\u95f4
        SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        SimpleDateFormat dateFormat3 = new SimpleDateFormat("yyyy\u5e74M\u6708d\u65e5 HH:mm");

        String content = Util.null2String(request.getParameter("content")).trim();//\u65e5\u5fd7\u5185\u5bb9

        String forDate = Util.null2String(request.getParameter("forDate")).trim();
        String appType = Util.null2String(request.getParameter("type"));
        String appItemId = Util.null2String(request.getParameter("appItemId"), "1");
        int discussid = Util.getIntValue(Util.null2String(request.getParameter("discussid")), 0);
        //\u9632\u6b62\u6570\u636e\u4f20\u8f93\u7f3a\u5931
        if (content.equals("") || forDate.equals("") || appItemId.equals("0")) {
            result.put("status", "3");
            JSONObject json = JSONObject.fromObject(result);
            out.println(json);

        } else {

            appItemId = appItemId.equals("2") ? appItemId : "1"; //\u5904\u7406\u5fc3\u60c5\u4e22\u5931\u60c5\u51b5 
            String score = "0";
            String comefrom = "0";

            BlogDao blogDao = new BlogDao();
            String isManagerScore = blogDao.getSysSetting("isManagerScore"); //\u542f\u7528\u4e0a\u7ea7\u8bc4\u5206

            boolean isEdit = discussid != 0 ? true : false; //\u662f\u5426\u662f\u7f16\u8f91

            String lastUpdateTime = "" + today.getTime();
            String sql = "";
            AppDao appDao = new AppDao();
            boolean isAppend = false;
            try {
                if (!isEdit) { //\u5982\u679c\u5fae\u535a\u8bb0\u5f55id=0 \u5219\u8868\u793a\u4e3a\u521b\u5efa

                    BlogDiscessVo discessVo = blogDao.getDiscussVoByDate(userid, forDate);
                    if (discessVo != null) { //\u5224\u65ad\u662f\u5426\u4e3a\u65b0\u589e\u5fae\u8584\uff0cdiscessVo\u4e3anull\u4e3a\u65b0\u589e\uff0c\u5426\u5219\u5f53\u5929\u7684\u5185\u5bb9\u8ffd\u52a0\u5f53\u5929\u5185\u5bb9\u4e0b\uff1a\u51af\u5e7f\u7855

                        if (discessVo.getUserid().equals(userid)) { //\u9632\u6b62\u901a\u8fc7ajax\u66f4\u65b0\u4ed6\u4eba\u5fae\u535a
                            isAppend = true;
                            content = discessVo.getContent() + content;
                            
                            sql = "update blog_discuss set lastUpdatetime=?, content=? where id=?";
                            cs.setStatementSql(sql);
                            cs.setString(1, lastUpdateTime);
                            cs.setCharacterStream(2, content);
                            cs.setString(3, discessVo.getId());
                            
                        }
                    } else {  //\u65b0\u589e\u5fae\u8584

                        sql = "insert into blog_discuss (userid, createdate, createtime,content,lastUpdatetime,isReplenish,workdate,score,comefrom)"
                                + " values (?, ?,?,?,?,?,?,?,?)";
                        cs.setStatementSql(sql);
                        cs.setString(1, "" + userid);
                        cs.setString(2, "" + curDate);
                        cs.setString(3, "" + curTime);
                        cs.setCharacterStream(4, content);
                        cs.setString(5, "" + lastUpdateTime);
                        cs.setString(6, "" + (forDate.equals(curDate) ? "0" : "1"));
                        cs.setString(7, "" + forDate);
                        cs.setString(8, "0");
                        cs.setString(9, "0");
                    }

                } else { //\u66f4\u65b0

                    sql = "update blog_discuss set lastUpdatetime=?,content=? where id=? and userid=?";
                    cs.setStatementSql(sql);
                    cs.setString(1, "" + lastUpdateTime);
                    cs.setCharacterStream(2, content);
                    cs.setInt(3, discussid);
                    cs.setString(4, userid);

                }

                HashMap backData = new HashMap();
                if (cs.executeUpdate() > 0) {
                    cs.close(); //\u5173\u95ed\u6570\u636e\u5e93\u8fde\u63a5

                    //\u5982\u679c\u662f\u7f16\u8f91\uff0c\u5219\u53d6\u521b\u5efa\u65f6\u7684\u65f6\u95f4
                    if (isEdit) {
                        BlogDiscessVo discessVo = blogDao.getDiscussVo("" + discussid);
                        curDate = discessVo.getCreatedate();
                        curTime = discessVo.getCreatetime();
                        score = discessVo.getScore();
                        comefrom = discessVo.getComefrom();
                    }
                    //discuss=0\u8868\u793a\u65b0\u5efa
                    if (!isEdit) {
                        sql = "select id from blog_discuss where userid=? and createdate=? and createtime=?";
                        rs.executeQuery(sql, userid, curDate, curTime);
                        if (rs.next()) {
                            discussid = rs.getInt("id");
                        }
                    }

                    backData.put("id", "" + discussid);
                    backData.put("curDate", curDate);
                    backData.put("curTime", curTime);
                    backData.put("forDate", forDate);

                    String createdatetime = dateFormat3.format(dateFormat.parse(curDate + " " + curTime));
                    backData.put("createdatetime", createdatetime);
                    backData.put("score", score);
                    backData.put("isManagerScore", isManagerScore);

                    backData.put("comefrom", comefrom);

                    backData.put("userName", user.getLastname());
                    backData.put("userid", "" + user.getUID());

                    String type = (!forDate.equals(curDate)) ? "1" : "0"; //\u662f\u5426\u4e3a\u8865\u4ea4  1\u8865\u4ea4 0\u6b63\u5e38\u63d0\u4ea4
                    backData.put("type", type);

                    result.put("status", "1"); //\u4fdd\u5b58\u662f\u5426\u6210\u529f

                    if (appDao.getAppVoByType("mood").isActive()) {
                        if (!isEdit && !isAppend) {
                            sql = "INSERT INTO blog_appDatas(userid,workDate,createDate,createTime,discussid,appitemId) VALUES('" + user.getUID() + "','" + forDate
                                    + "','" + curDate + "','" + curTime + "','" + discussid + "','" + appItemId + "')";
                        } else {
                            sql = "update blog_appDatas set appitemId=" + appItemId + " where discussid=" + discussid;
                        }
                        rs.executeSql(sql);
                        sql = "SELECT * FROM blog_appDatas LEFT JOIN blog_AppItem ON blog_appDatas.appItemId=blog_AppItem.id WHERE discussid=?";
                        rs.executeQuery(sql, discussid);
                        if (rs.next()) {
                            backData.put("appItemId", appItemId);
                            backData.put("faceImg", rs.getString("face"));
                            backData.put("itemName", SystemEnv.getHtmlLabelName(Util.getIntValue(rs.getString("itemName")), user.getLanguage()));
                        }
                    }
                    //\u63d0\u4ea4\u65b0\u7684\u5fae\u535a\u65f6\u7ed9\u4e88\u63d0\u9192
                    if (!isEdit && !isAppend) {
                        if(discussid > 0) { //\u4e3b\u952e\u503c\u4e0d\u6b63\u786e\u65f6\uff0c\u65e0\u9700\u6dfb\u52a0\u63d0\u9192\u8bb0\u5f55
                            //\u5220\u9664\u9605\u8bfb\u8bb0\u5f55
                            sql = "DELETE FROM blog_read WHERE blogid=?";
                            rs.executeUpdate(sql, user.getUID());
    
                            //\u7ed9\u5173\u6ce8\u6211\u7684\u4eba\u53d1\u9001\u5fae\u535a\u63d0\u4ea4\u63d0\u9192\u3002
                            List attentionMeList = blogDao.getAttentionMe(userid);
                            for (int i = 0; i < attentionMeList.size(); i++) {
                                blogDao.addRemind((String) attentionMeList.get(i), userid, "6", "" + discussid, "0");
                            }
                        }
                    }

                    result.put("backdata", backData);
                    JSONObject json = JSONObject.fromObject(result);

                    out.println(json);

                } else {
                    result.put("status", "0");
                    JSONObject json = JSONObject.fromObject(result);

                    out.println(json);
                }
            } catch (Exception e) {
                e.printStackTrace();
            } finally {
                cs.close();
            }
        }
    }

    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("blog/saveBlogOperation.jsp"), 6671878203138250335L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string1;
  private final static char []_jsp_string2;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
    _jsp_string2 = "\r\n\r\n".toCharArray();
  }
}
