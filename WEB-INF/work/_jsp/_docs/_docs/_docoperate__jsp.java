/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._docs._docs;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import java.util.*;
import weaver.docs.DocDetailLog;
import weaver.general.Util;
import java.io.Writer;
import oracle.sql.CLOB;
import weaver.conn.ConnStatement;
import java.io.BufferedReader;
import weaver.systeminfo.*;
import weaver.hrm.*;

public class _docoperate__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.splitepage.operate.SpopForDoc spop;
      spop = (weaver.splitepage.operate.SpopForDoc) pageContext.getAttribute("spop");
      if (spop == null) {
        spop = new weaver.splitepage.operate.SpopForDoc();
        pageContext.setAttribute("spop", spop);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.docs.DocDetailLog DocDetailLog;
      DocDetailLog = (weaver.docs.DocDetailLog) pageContext.getAttribute("DocDetailLog");
      if (DocDetailLog == null) {
        DocDetailLog = new weaver.docs.DocDetailLog();
        pageContext.setAttribute("DocDetailLog", DocDetailLog);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet rs;
      rs = (weaver.conn.RecordSet) pageContext.getAttribute("rs");
      if (rs == null) {
        rs = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs", rs);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet RecordSet;
      RecordSet = (weaver.conn.RecordSet) pageContext.getAttribute("RecordSet");
      if (RecordSet == null) {
        RecordSet = new weaver.conn.RecordSet();
        pageContext.setAttribute("RecordSet", RecordSet);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.docs.docs.DocExtUtil DocExtUtil;
      DocExtUtil = (weaver.docs.docs.DocExtUtil) pageContext.getAttribute("DocExtUtil");
      if (DocExtUtil == null) {
        DocExtUtil = new weaver.docs.docs.DocExtUtil();
        pageContext.setAttribute("DocExtUtil", DocExtUtil);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.crm.Maint.CustomerInfoComInfo CustomerInfoComInfo;
      CustomerInfoComInfo = (weaver.crm.Maint.CustomerInfoComInfo) pageContext.getAttribute("CustomerInfoComInfo");
      if (CustomerInfoComInfo == null) {
        CustomerInfoComInfo = new weaver.crm.Maint.CustomerInfoComInfo();
        pageContext.setAttribute("CustomerInfoComInfo", CustomerInfoComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.resource.ResourceComInfo ResourceComInfo;
      ResourceComInfo = (weaver.hrm.resource.ResourceComInfo) pageContext.getAttribute("ResourceComInfo");
      if (ResourceComInfo == null) {
        ResourceComInfo = new weaver.hrm.resource.ResourceComInfo();
        pageContext.setAttribute("ResourceComInfo", ResourceComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.docs.DocDetailLog docDetailLog;
      docDetailLog = (weaver.docs.DocDetailLog) pageContext.getAttribute("docDetailLog");
      if (docDetailLog == null) {
        docDetailLog = new weaver.docs.DocDetailLog();
        pageContext.setAttribute("docDetailLog", docDetailLog);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.docs.docs.DocRecycleManager docRecycleManager;
      docRecycleManager = (weaver.docs.docs.DocRecycleManager) pageContext.getAttribute("docRecycleManager");
      if (docRecycleManager == null) {
        docRecycleManager = new weaver.docs.docs.DocRecycleManager();
        pageContext.setAttribute("docRecycleManager", docRecycleManager);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.filter.XssUtil xssUtil;
      xssUtil = (weaver.filter.XssUtil) pageContext.getAttribute("xssUtil");
      if (xssUtil == null) {
        xssUtil = new weaver.filter.XssUtil();
        pageContext.setAttribute("xssUtil", xssUtil);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      
response.setHeader("cache-control", "no-cache");
response.setHeader("pragma", "no-cache");
response.setHeader("expires", "Mon 1 Jan 1990 00:00:00 GMT");

      out.write(_jsp_string3, 0, _jsp_string3.length);
      
User user = HrmUserVarify.getUser (request , response) ;
if(user == null)  return ;

String operation =  Util.null2String(request.getParameter("operation"));
String docid =  Util.null2String(request.getParameter("docid"));
String redirectTo =  Util.null2String(request.getParameter("redirectTo"));

String docsubject="";
String doccreaterid="";
String checkOutStatus="";
int checkOutUserId=0;
String checkOutUserType="";
String doccreatertype = "";

String strSql="select docsubject,doccreaterid,doccreatertype,checkOutStatus,checkOutUserId,checkOutUserType from docdetail where id="+docid;
rs.executeSql(strSql);
if (rs.next()){
	docsubject = Util.null2String(rs.getString("docsubject"));
	doccreaterid =  Util.null2String(rs.getString("doccreaterid"));
	checkOutStatus=Util.null2String(rs.getString("checkOutStatus"));
	checkOutUserId=rs.getInt("checkOutUserId");
	checkOutUserType=Util.null2String(rs.getString("checkOutUserType"));
	doccreatertype = Util.null2String(rs.getString("doccreatertype"));
  }

      out.write(_jsp_string3, 0, _jsp_string3.length);
      
if (!"GetDocContent".equals(operation)){

      out.write(_jsp_string3, 0, _jsp_string3.length);
       } 
      out.write(_jsp_string3, 0, _jsp_string3.length);
      
//\u6c42\u5f97\u6743\u9650
//userType,userId,userSeclevel
String userType = ""+user.getType();
String userdepartment = ""+user.getUserDepartment();
String usersubcomany = ""+user.getUserSubCompany1();
String userInfo = user.getLogintype()+"_"+user.getUID()+"_"+user.getSeclevel()+"_"+userType+"_"+userdepartment+"_"+usersubcomany;

// 0:\u67e5\u770b 1:\u7f16\u8f91 2:\u5220\u9664 3:\u5171\u4eab 4:\u65e5\u5fd7 \u6bcf\u9879\u4e2d\u7684\u503c "false":\u8868\u793a\u65e0\u6743\u9650  "true":\u8868\u793a\u6709\u6743\u9650
ArrayList popedomList = spop.getDocOpratePopedom(docid,userInfo); 

if ("delete".equals(operation)){
    //\u6743\u9650\u65ad\u5b9a
    if ("false".equals((String)popedomList.get(2))) {
        response.sendRedirect("/notice/noright.jsp");
	    return;
    }

	String promptInfo="";
    
    //rs.executeSql("select count(0) from docdetail where doceditionid > 0 and id<>"+docid+" and doceditionid = (select doceditionid from docdetail where id = " + docid + ") and (docstatus <= 0 or docstatus in (3,4,6)) ");
    rs.executeSql("select count(0) from docdetail where doceditionid > 0 and id>"+docid+" and doceditionid = (select doceditionid from docdetail where id = " + docid + ") and (docstatus <= 0 or docstatus in (3,4,6)) ");
    if(rs.next()&&rs.getInt(1)>0){
    	promptInfo=SystemEnv.getHtmlLabelName(20411,user.getLanguage());		
    } else {    
		if(checkOutStatus.equals("1")
	             &&(checkOutUserId!=user.getUID()||!checkOutUserType.equals(user.getLogintype()))){//\u5982\u679c\u88ab\u5176\u4ed6\u4eba\u7b7e\u51fa
	
	                String checkOutUserName="";
	            	if(checkOutUserType.equals("2")){
	            		checkOutUserName=CustomerInfoComInfo.getCustomerInfoname(""+checkOutUserId);
	            	}else{
	            		checkOutUserName=ResourceComInfo.getResourcename(""+checkOutUserId);
	            	}
	
	            	promptInfo=SystemEnv.getHtmlLabelName(19786,user.getLanguage())+SystemEnv.getHtmlLabelName(19690,user.getLanguage())+":"+checkOutUserName;
	
		}else{//\u5426\u5219,\u5373\u6ca1\u6709\u88ab\u5176\u4ed6\u4eba\u7b7e\u51fa
			RecordSet.executeSql("select propvalue from   doc_prop  where propkey='docsrecycle'");
			RecordSet.next();
			int docsrecycle=Util.getIntValue(RecordSet.getString("propvalue"),0);
			if(docsrecycle==1&&!(user.getLogintype().equals("2"))){//\u5f00\u542f\u56de\u6536\u7ad9
				docRecycleManager.moveDocToRecycle(user.getUID(), user.getLogintype(), Util.getIntValue(docid), request.getRemoteAddr());
			}else{
            int doceditionid=-1;
			int docedition=-1;
			rs.executeSql("select doceditionid,docedition from DocDetail where id = " + docid);
			if(rs.next()){
				doceditionid = Util.getIntValue(Util.null2String(rs.getString("doceditionid")));
				docedition = Util.getIntValue(Util.null2String(rs.getString("docedition")));
			}
		    if(doceditionid>0){
			    rs.executeSql("select * from DocDetail where doceditionid = " + doceditionid + " order by docEdition asc ");
			    while(rs.next()) {
					docid = Util.null2String(rs.getString("id"));
					docsubject = Util.null2String(rs.getString("docsubject"));
					doccreaterid =  Util.null2String(rs.getString("doccreaterid"));
					doccreatertype = Util.null2String(rs.getString("doccreatertype"));

					DocExtUtil.deleteDoc(Util.getIntValue(docid));
					//TD10931 chujun
					docDetailLog.resetParameter();
					docDetailLog.setDocId(Util.getIntValue(docid));
					docDetailLog.setDocSubject(docsubject);
					docDetailLog.setOperateType("3");           
					docDetailLog.setOperateUserid(user.getUID());
					docDetailLog.setUsertype(user.getLogintype());
					docDetailLog.setClientAddress(request.getRemoteAddr());
					docDetailLog.setDocCreater(Util.getIntValue(doccreaterid,0));
					docDetailLog.setCreatertype(doccreatertype);
					docDetailLog.setDocLogInfo();

			    }
		    }else{
			    DocExtUtil.deleteDoc(Util.getIntValue(docid));
			    //TD10931 chujun
			    docDetailLog.resetParameter();
			    docDetailLog.setDocId(Util.getIntValue(docid));
			    docDetailLog.setDocSubject(docsubject);
			    docDetailLog.setOperateType("3");           
			    docDetailLog.setOperateUserid(user.getUID());
			    docDetailLog.setUsertype(user.getLogintype());
			    docDetailLog.setClientAddress(request.getRemoteAddr());
			    docDetailLog.setDocCreater(Util.getIntValue(doccreaterid,0));
			    docDetailLog.setCreatertype(doccreatertype);
			    docDetailLog.setDocLogInfo();
			}
			}
			promptInfo=SystemEnv.getHtmlLabelName(19791,user.getLanguage());
		}

    }    
    
      out.write(_jsp_string4, 0, _jsp_string4.length);
      out.print((promptInfo));
      out.write(_jsp_string1, 0, _jsp_string1.length);
      } else if("share".equals(operation)) {
     //\u6743\u9650\u65ad\u5b9a
    if ("false".equals((String)popedomList.get(3))) {
        response.sendRedirect("/notice/noright.jsp") ;
	    return ;
    }
    //\u5177\u4f53\u64cd\u4f5c
    
      out.write(_jsp_string5, 0, _jsp_string5.length);
      out.print((docid));
      out.write(_jsp_string6, 0, _jsp_string6.length);
      out.print((docsubject));
      out.write(_jsp_string7, 0, _jsp_string7.length);
      out.print((doccreaterid));
      out.write(_jsp_string8, 0, _jsp_string8.length);
      out.print((xssUtil.put("where docid="+docid)));
      out.write(_jsp_string9, 0, _jsp_string9.length);
      } else if("viewLog".equals(operation)) {
     //\u6743\u9650\u65ad\u5b9a
    if ("false".equals((String)popedomList.get(4))) {
        response.sendRedirect("/notice/noright.jsp") ;
	    return ;
    }    
    //\u5177\u4f53\u64cd\u4f5c
    
      out.write(_jsp_string10, 0, _jsp_string10.length);
      out.print((docid));
      out.write(_jsp_string6, 0, _jsp_string6.length);
      out.print((docsubject));
      out.write(_jsp_string7, 0, _jsp_string7.length);
      out.print((doccreaterid));
      out.write(_jsp_string8, 0, _jsp_string8.length);
      out.print((xssUtil.put("where docid="+docid)));
      out.write(_jsp_string11, 0, _jsp_string11.length);
      } else if ("GetDocContent".equals(operation)){ 
        
        
        //\u5176\u5b83\u64cd\u4f5c        
        String tempsql="";
        String parentids="";
        String docContent = "";
        String docReplyId = "" ;
        String returnStr = "";
        String viewStr=SystemEnv.getHtmlLabelName(367,user.getLanguage());
        String editStr=SystemEnv.getHtmlLabelName(93,user.getLanguage());      
        String deleteStr=SystemEnv.getHtmlLabelName(91,user.getLanguage());         
        if(!"oracle".equals(rs.getDBType())){ 
            tempsql="select replydocid,doccontent,parentids,docsubject,doccreaterid,usertype from docdetail where  id="+docid;
        }else {
            tempsql="select replydocid,parentids,docsubject,doccreaterid,usertype from docdetail where  id="+docid;
        }
         String docsubject1="";
        rs.executeSql(tempsql);
        if(rs.next()){
            docReplyId= Util.null2String(rs.getString("replydocid"));            
             if("oracle".equals(rs.getDBType())){   
                String sqltemporalce="select doccontent from DocDetailContent where docid="+docid;                         
                ConnStatement statement=new ConnStatement();
                
                statement.setStatementSql(sqltemporalce, false);
                statement.executeQuery();
                //System.out.println(statement.next());  
                if(statement.next()){                    
                    CLOB theclob = statement.getClob("doccontent");
           
                    String readline = "";
                    StringBuffer clobStrBuff = new StringBuffer("");
                    BufferedReader clobin = new BufferedReader(theclob.getCharacterStream());
                    while ((readline = clobin.readLine()) != null) clobStrBuff = clobStrBuff.append(readline);
                    clobin.close() ;
                    docContent = clobStrBuff.toString();
                }
        
                //System.out.println("docContent is "+docContent);                
                statement.close();
             } else {
                docContent= Util.null2String(rs.getString("doccontent"));
             }
            parentids= Util.null2String(rs.getString("parentids"));
            docsubject1= Util.null2String(rs.getString("docsubject"));
            String doccreaterid1= Util.null2String(rs.getString("doccreaterid"));
            String usertype= Util.null2String(rs.getString("usertype"));
            
            //\u8bb0\u65e5\u5fd7        
            DocDetailLog log = new DocDetailLog();
           
            log.setDocId(Util.getIntValue(docid));
            log.setDocSubject(docsubject1);
            log.setOperateType("0");
            log.setOperateUserid(user.getUID());
            log.setUsertype(""+user.getLogintype());
            log.setCreatertype(usertype);
            log.setClientAddress(request.getRemoteHost());
            log.setDocCreater(Util.getIntValue(doccreaterid1));
            log.setDocLogInfo();
            
            /**********************\u5411\u9605\u8bfb\u6807\u8bb0\u8868\u4e2d\u63d2\u5165\u9605\u8bfb\u8bb0\u5f55\uff0c\u4fee\u6539\u9605\u8bfb\u6b21\u6570(\u53ea\u6709\u5f53\u6d4f\u89c8\u8005\u4e0d\u662f\u521b\u5efa\u8005\u65f6)********************/
            if( user.getUID() != Util.getIntValue(doccreaterid1) || !user.getLogintype().equals(usertype) ){
                char flag=Util.getSeparator() ;
                String procStr =docid+flag+(""+user.getUID())+flag+user.getLogintype();
                rs.executeProc("docReadTag_AddByUser",""+docid+flag+""+user.getUID()+flag+""+user.getLogintype());  // \u4ed6\u4eba                           
                //System.out.println(procStr);
            }
        }  
        
        if ("true".equals((String)popedomList.get(0))) viewStr="/docs/docs/DocDsp.jsp?id="+docid;
        if ("true".equals((String)popedomList.get(1))) editStr="/docs/docs/DocEdit.jsp?id="+docid;
        if ("true".equals((String)popedomList.get(2))) deleteStr="/docs/docs/DocOperate.jsp?operation=delete&docid="+docid;
        String replyStr="/docs/docs/DocReply.jsp?id="+docReplyId+"&parentids="+parentids;   
        //System.out.println(docContent);
        //if (docContent.length()<=36) docContent+="";
        
        //returnStr = "<div align=right>["+viewStr+"]&nbsp;&nbsp;["+editStr+"]&nbsp;&nbsp;["+replyStr+"]&nbsp;&nbsp;["+deleteStr+"]</div><hr>";
        //returnStr+=docContent;
        returnStr="var jsonReply={docsubject:\""+docsubject1+"\","+
							     "viewStr:\""+viewStr+"\","+
							     "editStr:\""+editStr+"\","+
							     "deleteStr:\""+deleteStr+"\","+
							     "replyStr:\""+replyStr+"\","+
							     "docContent:\""+docContent+"\""+
							     "};";
        
        out.println(returnStr);
    }
    
      out.write(_jsp_string3, 0, _jsp_string3.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("docs/docs/DocOperate.jsp"), 6435626019792277459L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string9;
  private final static char []_jsp_string4;
  private final static char []_jsp_string11;
  private final static char []_jsp_string5;
  private final static char []_jsp_string10;
  private final static char []_jsp_string6;
  private final static char []_jsp_string2;
  private final static char []_jsp_string0;
  private final static char []_jsp_string1;
  private final static char []_jsp_string8;
  private final static char []_jsp_string7;
  private final static char []_jsp_string3;
  static {
    _jsp_string9 = "\">\r\n	</FORM>\r\n\r\n    <script language=\"javaScript\">\r\n        document.docShareLog.action=\"/docs/docs/DocShare.jsp\" ;\r\n        document.docShareLog.submit() ;\r\n    </script>  \r\n".toCharArray();
    _jsp_string4 = "\r\n	".toCharArray();
    _jsp_string11 = "\">\r\n	</FORM>\r\n\r\n    <script language=\"javaScript\">\r\n        document.docShareLog.action=\"/docs/DocDetailLog.jsp\" ;\r\n        document.docShareLog.submit() ;\r\n    </script> \r\n".toCharArray();
    _jsp_string5 = "\r\n	<FORM id=docShareLog name=docShareLog method=post>\r\n	    <input type=hidden name=docid value=\"".toCharArray();
    _jsp_string10 = "\r\n\r\n	<FORM id=docShareLog name=docShareLog method=post>\r\n	    <input type=hidden name=docid value=\"".toCharArray();
    _jsp_string6 = "\">\r\n	    <input type=hidden name=docsubject value=\"".toCharArray();
    _jsp_string2 = "\r\n\r\n\r\n".toCharArray();
    _jsp_string0 = "\r\n \r\n\r\n  \r\n  \r\n  \r\n \r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
    _jsp_string8 = "\">\r\n	    <input type=hidden name=sqlwhere value=\"".toCharArray();
    _jsp_string7 = "\">\r\n	    <input type=hidden name=doccreaterid value=\"".toCharArray();
    _jsp_string3 = "\r\n\r\n".toCharArray();
  }
}
