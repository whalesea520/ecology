/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._docs._category;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.docs.docs.CustomFieldManager;
import weaver.general.Util;
import java.util.*;
import oracle.sql.CLOB;
import java.io.BufferedReader;
import java.io.Writer;
import weaver.conn.*;
import weaver.hrm.*;
import net.sf.json.JSONObject;

public class _docajax_0operation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, "/notice/error.jsp", session, 4096, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.conn.RecordSet rs;
      rs = (weaver.conn.RecordSet) pageContext.getAttribute("rs");
      if (rs == null) {
        rs = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs", rs);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSetTrans rst;
      rst = (weaver.conn.RecordSetTrans) pageContext.getAttribute("rst");
      if (rst == null) {
        rst = new weaver.conn.RecordSetTrans();
        pageContext.setAttribute("rst", rst);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.docs.mould.MouldManager mouldManager;
      mouldManager = (weaver.docs.mould.MouldManager) pageContext.getAttribute("mouldManager");
      if (mouldManager == null) {
        mouldManager = new weaver.docs.mould.MouldManager();
        pageContext.setAttribute("mouldManager", mouldManager);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.docs.docs.CustomDictManager CustomDictManager;
      CustomDictManager = (weaver.docs.docs.CustomDictManager) pageContext.getAttribute("CustomDictManager");
      if (CustomDictManager == null) {
        CustomDictManager = new weaver.docs.docs.CustomDictManager();
        pageContext.setAttribute("CustomDictManager", CustomDictManager);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.docs.category.SubCategoryComInfo SubCategoryComInfo;
      SubCategoryComInfo = (weaver.docs.category.SubCategoryComInfo) pageContext.getAttribute("SubCategoryComInfo");
      if (SubCategoryComInfo == null) {
        SubCategoryComInfo = new weaver.docs.category.SubCategoryComInfo();
        pageContext.setAttribute("SubCategoryComInfo", SubCategoryComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.docs.category.SecCategoryComInfo SecCategoryComInfo;
      SecCategoryComInfo = (weaver.docs.category.SecCategoryComInfo) pageContext.getAttribute("SecCategoryComInfo");
      if (SecCategoryComInfo == null) {
        SecCategoryComInfo = new weaver.docs.category.SecCategoryComInfo();
        pageContext.setAttribute("SecCategoryComInfo", SecCategoryComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.docs.category.SecCategoryDocPropertiesComInfo SecCategoryDocPropertiesComInfo;
      SecCategoryDocPropertiesComInfo = (weaver.docs.category.SecCategoryDocPropertiesComInfo) pageContext.getAttribute("SecCategoryDocPropertiesComInfo");
      if (SecCategoryDocPropertiesComInfo == null) {
        SecCategoryDocPropertiesComInfo = new weaver.docs.category.SecCategoryDocPropertiesComInfo();
        pageContext.setAttribute("SecCategoryDocPropertiesComInfo", SecCategoryDocPropertiesComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.docs.category.SecCategoryCustomSearchComInfo SecCategoryCustomSearchComInfo;
      SecCategoryCustomSearchComInfo = (weaver.docs.category.SecCategoryCustomSearchComInfo) pageContext.getAttribute("SecCategoryCustomSearchComInfo");
      if (SecCategoryCustomSearchComInfo == null) {
        SecCategoryCustomSearchComInfo = new weaver.docs.category.SecCategoryCustomSearchComInfo();
        pageContext.setAttribute("SecCategoryCustomSearchComInfo", SecCategoryCustomSearchComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.systeminfo.SysMaintenanceLog log;
      log = (weaver.systeminfo.SysMaintenanceLog) pageContext.getAttribute("log");
      if (log == null) {
        log = new weaver.systeminfo.SysMaintenanceLog();
        pageContext.setAttribute("log", log);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.docs.docs.DocUtil DocUtil;
      DocUtil = (weaver.docs.docs.DocUtil) pageContext.getAttribute("DocUtil");
      if (DocUtil == null) {
        DocUtil = new weaver.docs.docs.DocUtil();
        pageContext.setAttribute("DocUtil", DocUtil);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      
  User user = HrmUserVarify.getUser(request,response);
  String src = Util.null2String(request.getParameter("src"));
  if(src.equals("checkDocCusSame")){  //\u68c0\u67e5\u5b57\u6bb5\u662f\u5426\u5df2\u5b58\u5728
  	String fieldname = Util.null2String(request.getParameter("fieldname"));
  	String fieldid = Util.null2String(request.getParameter("fieldid"));
     String sql = "select 1 from cus_formdict where fieldname = '"+fieldname+"'";
     if(!fieldid.equals("")){
     	sql += " and id!="+fieldid;
     }
     if(fieldname.equals("")){
     	out.println("1");//\u5931\u8d25
     	return;
     }
     if(rs.execute(sql)){
     	if(rs.next()){
     		out.println("1");
     	}else{
     		out.println("0");//\u6210\u529f
     	}
     }else{
     	out.println("1");
     }

  }else if(src.equalsIgnoreCase("attachSecCategory") ){//\u5173\u8054\u81ea\u5b9a\u4e49\u5b57\u6bb5
	String secCategoryId = Util.null2String(request.getParameter("secCategoryId"));
	String fieldids = Util.null2String(request.getParameter("fieldids"));
	String[] fieldArr = fieldids.split(",");
	String sql = "select fieldid from cus_formfield where scope='DocCustomFieldBySecCategory' and scopeid="+secCategoryId;
	if(!fieldids.equals("")){
		sql += " and fieldid in("+fieldids+")";
	}
	List<String> cusids = new ArrayList<String>();
	rs.executeSql(sql);
	while(rs.next()){
		cusids.add(rs.getString(1));
	}
	sql = "select fieldid from DocSecCategoryDocProperty where scope='DocCustomFieldBySecCategory' and scopeid="+secCategoryId;
	if(!fieldids.equals("")){
		sql += " and fieldid in("+fieldids+")";
	}
	rs.executeSql(sql);
	List<String> secProp = new ArrayList<String>();
	while(rs.next()){
		secProp.add(rs.getString(1));
	}
	try{
		rst.setAutoCommit(false);
		String logsql = "";
		//\u5148\u6267\u884c\u5220\u9664\u5b57\u6bb5\u64cd\u4f5c
		sql = "delete from cus_formfield where scope='DocCustomFieldBySecCategory' and scopeid="+secCategoryId;
		if(!fieldids.equals("")){
			sql += " and fieldid not in("+fieldids+")";
		}
		logsql = sql;
		rst.executeSql(sql);
		sql = "delete from DocSecCategoryDocProperty where scope='DocCustomFieldBySecCategory' and scopeid="+secCategoryId;
		if(!fieldids.equals("")){
			sql += " and fieldid not in("+fieldids+")";
		}
		logsql = logsql+";"+ sql;
		rst.executeSql(sql);

		int maxfieldorder=0;

		rst.executeSql("select max(fieldOrder) from cus_formfield where scope='DocCustomFieldBySecCategory' and scopeid="+secCategoryId);
		if(rst.next()){
			maxfieldorder=Util.getIntValue(rst.getString(1),-1);
			maxfieldorder++;
		}

		int maxviewindex=0;
		rst.executeSql("select max(viewindex) from DocSecCategoryDocProperty where seccategoryId="+secCategoryId);
		if(rst.next()){
			maxviewindex=Util.getIntValue(rst.getString(1),-1);
			maxviewindex++;
		}

		for(int i=0;!fieldids.equals("")&&i<fieldArr.length;i++){
			if(cusids.indexOf(fieldArr[i])!=-1){
				sql = "update cus_formfield set fieldorder="+i+" where scope='DocCustomFieldBySecCategory' and scopeid="+secCategoryId+" and fieldid="+fieldArr[i];
			}else{
				sql = "insert into cus_formfield(scope,scopeid,fieldid,fieldorder) values('DocCustomFieldBySecCategory',"+secCategoryId+","+fieldArr[i]+","+(maxfieldorder+i)+")";
			}
			logsql = logsql+";"+ sql;
			rst.executeSql(sql);
			
			if(secProp.indexOf(fieldArr[i])!=-1){
				//sql = "update DocSecCategoryDocProperty set viewindex="+i+" where scope='DocCustomFieldBySecCategory' and scopeid="+secCategoryId+" and fieldid="+fieldArr[i];
			}else{
				sql = "insert into DocSecCategoryDocProperty(scope,scopeid,seccategoryid,fieldid,viewindex,iscustom,visible,type,mustinput) values('DocCustomFieldBySecCategory',"+secCategoryId+","+secCategoryId+","+fieldArr[i]+","+(maxviewindex+i)+",1,1,0,0)";
				logsql = logsql+";"+ sql;
				rst.executeSql(sql);
			}
		}
		log.insSysLogInfo(user, Util.getIntValue(secCategoryId), SecCategoryComInfo.getSecCategoryname(secCategoryId), logsql, "3", "24", 0, request.getRemoteAddr());
		rst.commit();
		SubCategoryComInfo.removeMainCategoryCache();
		SecCategoryComInfo.removeMainCategoryCache();
		
		SecCategoryDocPropertiesComInfo.removeCache();
		SecCategoryCustomSearchComInfo.checkDefaultCustomSearch(Util.getIntValue(secCategoryId));
		out.println("0");
	}catch(Exception e){
		e.printStackTrace();
		rst.writeLog(e);
		rst.rollback();
		out.println("1");
	}
	
}else if(src.equals("docCusFieldDelete")){//\u5220\u9664\u81ea\u5b9a\u4e49\u5b57\u6bb5
  	 String id = Util.null2String(request.getParameter("id"));
  	 String[] idArr = id.split(",");
  	 boolean success = true;
  	String scope = Util.null2String(request.getParameter("scope"));
  	if(scope.equals(""))scope = "DocCustomFieldBySecCategory";
  	 for(int i=0;i<idArr.length;i++){
  		CustomDictManager.setScope(scope);
  		CustomDictManager.setClientAddress(request.getRemoteAddr());
  		CustomDictManager.setUser(user);
  	 	success = CustomDictManager.deleteField(idArr[i]);
  	 }
  	 if(success){
  	 	out.println("0");//\u5220\u9664\u6210\u529f
  	 }else{
  	 	out.println("1");//\u5220\u9664\u5931\u8d25
  	 }
  	 
}else if(src.equals("prjtypeCusFieldDelete")){//4prj\u5220\u9664\u9879\u76ee\u7c7b\u578b\u81ea\u5b9a\u4e49\u5b57\u6bb5
 	 String id = Util.null2String(request.getParameter("id"));
 	 String scopeid = Util.null2String(request.getParameter("scopeid"));
	String[] idArr = id.split(",");
	 boolean success = true;
	 for(int i=0;i<idArr.length;i++){
		 String sql=" delete cus_formfield where scope='ProjCustomField' and scopeid='"+scopeid+"' and fieldid='"+idArr[i]+"' ";
		 rs.executeSql(sql);
		 rs.executeSql("select fieldname from cus_formdict where id='"+idArr[i]+"' ");
		 if(rs.next()){
			 String fieldname= rs.getString("fieldname");
			 boolean isused= CustomFieldManager.fieldIsUsed4all( fieldname);
			 if(!isused){
				 success = CustomDictManager.deleteField(idArr[i]);
			 }
		 }
	 }
	 if(success){
	 	out.println("0");//\u5220\u9664\u6210\u529f
	 }else{
	 	out.println("1");//\u5220\u9664\u5931\u8d25
	 }

}else if(src.equalsIgnoreCase("getSecMaxUploadSize")){
	String id = Util.null2String(request.getParameter("secid"));
	int maxUploadSize = DocUtil.getMaxUploadImageSize(Util.getIntValue(id,-1));
	JSONObject json = new JSONObject();
	json.put("maxUploadSize",maxUploadSize);
	out.println(json.toString());
}else{
  	out.println("1");
  }
  
  
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("docs/category/docajax_operation.jsp"), 4426653148581709962L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string1;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
  }
}
