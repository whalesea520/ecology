/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._messager;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.file.AESCoder;
import weaver.file.FileUpload;
import weaver.file.Prop;
import weaver.general.*;
import weaver.hrm.*;
import java.util.*;
import com.sun.image.codec.jpeg.*;
import java.awt.*;
import java.awt.geom.Rectangle2D;
import java.awt.image.*;
import java.io.*;
import javax.imageio.ImageIO;
import org.apache.commons.fileupload.*;
import java.util.zip.ZipInputStream;
import weaver.hrm.resource.ResourceComInfo;
import weaver.conn.RecordSet;

public class _getusericonopreate__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;

  
  	public synchronized void saveOrUpdateImg(RecordSet rs, String iconName, String userId) {
  		String strSql="update hrmresource set messagerurl='/messager/usericon/"+iconName+"' where id="+userId;
  		rs.executeSql(strSql);
  	}

  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.conn.RecordSet rs;
      rs = (weaver.conn.RecordSet) pageContext.getAttribute("rs");
      if (rs == null) {
        rs = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs", rs);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.moduledetach.ManageDetachComInfo mdci;
      mdci = (weaver.hrm.moduledetach.ManageDetachComInfo) pageContext.getAttribute("mdci");
      if (mdci == null) {
        mdci = new weaver.hrm.moduledetach.ManageDetachComInfo();
        pageContext.setAttribute("mdci", mdci);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.systeminfo.systemright.CheckSubCompanyRight CheckSubCompanyRight;
      CheckSubCompanyRight = (weaver.systeminfo.systemright.CheckSubCompanyRight) pageContext.getAttribute("CheckSubCompanyRight");
      if (CheckSubCompanyRight == null) {
        CheckSubCompanyRight = new weaver.systeminfo.systemright.CheckSubCompanyRight();
        pageContext.setAttribute("CheckSubCompanyRight", CheckSubCompanyRight);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      
	User user = HrmUserVarify.getUser(request, response);
	if (user == null) return;
	
	
	String mode=Prop.getPropValue(GCONST.getConfigFile() , "authentic");
	String temploginid = Util.null2String(request.getParameter("temploginid"));
	String trmphomepage = Util.null2String(request.getParameter("trmphomepage"));
	String uploadPath = GCONST.getRootPath() + "messager"
			+ File.separatorChar + "usericon";
	String tempPath = uploadPath + File.separatorChar + "Temp";
	//\u81ea\u52a8\u521b\u5efa\u76ee\u5f55\uff1a
	if (!new File(uploadPath).isDirectory())
		new File(uploadPath).mkdirs();
	if (!new File(tempPath).isDirectory())
		new File(tempPath).mkdirs();
	String method = "";
	String userId = "";
	String subcompanyid = "";
	String isManager = "";
	String loginid = "";
	int x1 = 0;
	int y1 = 0;
	int x2 = 0;
	int y2 = 0;
  int formatWidth = 0;
  int formatHeight = 0;
	String requestFrom="";
	
	int imagefileid=0;
	DiskFileUpload fu = new DiskFileUpload();
	fu.setSizeMax(4194304); //4MB
	fu.setSizeThreshold(4096); //\u7f13\u51b2\u533a\u5927\u5c0f4kb
	fu.setRepositoryPath(tempPath);

	java.util.List fileItems = fu.parseRequest(request);
	Iterator ite = fileItems.iterator();

	//BufferedInputStream imagefile=null;
	try {
		while (ite.hasNext()) {
			FileItem item = (FileItem) ite.next();
			if (!item.isFormField()) {
				String name = item.getName();
				if(Util.isExcuteFile(name)) continue;
				long size = item.getSize();
				if ((name == null || name.equals("")) || size == 0)
					continue;
				
				//imagefile = new BufferedInputStream(item.getInputStream());
			} else {
				if (item.getFieldName().equals("method"))
					method = Util.null2String(item.getString("UTF-8"));
				if (item.getFieldName().equals("userId"))
					userId = Util.null2String(item.getString("UTF-8"));
				if (item.getFieldName().equals("subcompanyid"))
					subcompanyid = Util.null2String(item.getString("UTF-8"));
				if (item.getFieldName().equals("isManager"))
					isManager = Util.null2String(item.getString("UTF-8"));
				if (item.getFieldName().equals("loginid"))
					loginid = Util.null2String(item.getString("UTF-8"));
				if (item.getFieldName().equals("x1"))
					x1 = Util.getIntValue(item.getString("UTF-8"));
				if (item.getFieldName().equals("y1"))
					y1 = Util.getIntValue(item.getString("UTF-8"));
				if (item.getFieldName().equals("x2"))
					x2 = Util.getIntValue(item.getString("UTF-8"));
				if (item.getFieldName().equals("y2"))
					y2 = Util.getIntValue(item.getString("UTF-8"));	
				if (item.getFieldName().equals("formatHeight"))
					formatHeight = Util.getIntValue(item.getString("UTF-8"));
				if (item.getFieldName().equals("formatWidth"))
					formatWidth = Util.getIntValue(item.getString("UTF-8"));
				if (item.getFieldName().equals("imagefileid"))
					imagefileid = Util.getIntValue(item.getString("UTF-8"));		
				if (item.getFieldName().equals("requestFrom"))
					requestFrom = Util.null2String(item.getString("UTF-8"));

			}
		}
	} catch (Exception e) {
	}
	
	if(!"1".equals(isManager)){
		userId = ""+user.getUID();
		loginid = user.getLoginid();
	}else{
		int hrmdetachable = 0;
		if(session.getAttribute("hrmdetachable")!=null){
			hrmdetachable = Util.getIntValue(String.valueOf(session.getAttribute("hrmdetachable")),0);
		}else{
			boolean isUseHrmManageDetach = mdci.isUseHrmManageDetach();
			if(isUseHrmManageDetach){
				hrmdetachable = 1;
			}else{
				hrmdetachable = 0;
			}
		}
		int operatelevel = -1;
		if(hrmdetachable==1){
			operatelevel = CheckSubCompanyRight.ChkComRightByUserRightCompanyId(user.getUID(),"HrmResourceEdit:Edit",Util.getIntValue(subcompanyid,0));
		}else{
			if(HrmUserVarify.checkUserRight("HrmResourceEdit:Edit", user)){
				operatelevel = 2;
			}
		}
		if(operatelevel<=0){
			userId = ""+user.getUID();
			loginid = user.getLoginid();
		}
	}
	
	if ("delete".equals(method)) {
		String strSql="update hrmresource set messagerurl='' where id="+userId;		
		rs.executeSql(strSql);
		ResourceComInfo resourceComInfo=new ResourceComInfo();
		resourceComInfo.updateResourceInfoCache(userId);

		out.println("<script>window.location='GetUserIcon.jsp?isclosed=true&requestFrom="+requestFrom+"&isManager="+isManager+"&userId="+userId+"&subcompanyid="+subcompanyid+"&iconUrl="+resourceComInfo.getMessagerUrls(userId)+"&loginid="+loginid+"'</script>");
		
	}
	
	if ("usericon".equals(method)) {
	try{
		String iconName="loginid"+TimeUtil.getFormartString(Calendar.getInstance(),"yyyyMMddHHmmss")+".jpg";
		//\u751f\u6210\u7f29\u7565\u56fe		
		String targetUrl = uploadPath+ File.separatorChar +iconName;
		
		rs.executeSql("select isaesencrypt,aescode,filerealpath,iszip from imagefile where imagefileid="+imagefileid);
		rs.next();
		String filerealpath=Util.null2String(rs.getString("filerealpath"));  
        String iszip=Util.null2String(rs.getString("iszip"));
        String isaesencrypt = Util.null2String(rs.getString("isaesencrypt"));
        String aescode = Util.null2String(rs.getString("aescode"));
        InputStream imagefile = null;
        
        if(filerealpath==null || filerealpath.equals("")){
            out.println("<script>window.location='GetUserIcon.jsp?requestFrom="+trmphomepage+"&isManager="+isManager+"&userId="+userId+"&subcompanyid="+subcompanyid+"&loginid="+temploginid+"'</script>");
            return;
          }
        
        
        File thefile = new File(filerealpath);
        if (iszip.equals("1")) {
          ZipInputStream zin = new ZipInputStream(new FileInputStream(thefile));
          if (zin.getNextEntry() != null) imagefile = new BufferedInputStream(zin);
        } else {
          imagefile = new BufferedInputStream(new FileInputStream(thefile));
        }
        if(isaesencrypt.equals("1")){
        	imagefile = AESCoder.decrypt(imagefile,aescode);
        }
         Image image = ImageIO.read(imagefile);

         if(formatWidth>477||formatHeight>287){ }
	         //\u521b\u5efa\u4e00\u4e2aBufferedImage  477px;height:287px
	         BufferedImage bufimage = new BufferedImage(formatWidth,formatHeight,BufferedImage.TYPE_3BYTE_BGR);
	       	 //\u628a\u56fe\u7247\u8bfb\u5230bufferedImage\u4e2d
	
	         bufimage.getGraphics().drawImage(image,0,0, formatWidth, formatHeight, null);
	         //\u5f97\u5230\u8f6c\u6362\u540e\u7684Image\u56fe\u7247
	         image = bufimage;
        
         
         imagefile.close();
         
		//Image image = ImageIO.read(imagefile);
		//imagefile.close();

		
		int width = x2 - x1;
		int height = y2 - y1;
		if(width<=0)width=100;
		if(height<=0)height=100;
		BufferedImage thumbImage = new BufferedImage(width, height,
				BufferedImage.TYPE_INT_RGB);
		int[] data = new int[width * height];
		int i = 0;
		for (int y = 0; y < height; y++) {
			for (int x = 0; x < width; x++) {
				data[i++] = 0xffffffff;
			}
		}
		thumbImage.setRGB(0, 0, width, height, data, 0, width);
		Graphics2D graphics2D = thumbImage.createGraphics();
		graphics2D.setRenderingHint(RenderingHints.KEY_INTERPOLATION,
				RenderingHints.VALUE_INTERPOLATION_BILINEAR);

		graphics2D.drawImage(image, 0, 0, width, height, x1, y1, x2,
				y2, Color.white, null);

		BufferedOutputStream out2 = new BufferedOutputStream(
				new FileOutputStream(targetUrl));
		JPEGImageEncoder encoder = JPEGCodec.createJPEGEncoder(out2);
		JPEGEncodeParam param = encoder
				.getDefaultJPEGEncodeParam(thumbImage);
		int quality = 80;
		quality = Math.max(0, Math.min(quality, 100));
		param.setQuality((float) quality / 100.0f, false);
		encoder.setJPEGEncodeParam(param);
		encoder.encode(thumbImage);
		out2.close();

		//\u4fdd\u5b58\u8fdb\u6570\u636e\u5e93
		//String whereSql = "and loginid='"+loginid+"'";
		//loginid\u3001account\u5b57\u6bb5\u6574\u5408  qc:128484
		//if(mode.equals("ldap")) whereSql = "and account='"+loginid+"'";
		//if(mode.equals("ldap")) whereSql = "and loginid='"+loginid+"'";
		saveOrUpdateImg(rs, iconName, userId);
		ResourceComInfo resourceComInfo=new ResourceComInfo();
		resourceComInfo.updateResourceInfoCache(userId);
		out.println("<script>window.location='GetUserIcon.jsp?isclosed=true&requestFrom="+requestFrom+"&isManager="+isManager+"&userId="+userId+"&subcompanyid="+subcompanyid+"&iconUrl=/messager/usericon/"+iconName+"&loginid="+loginid+"'</script>");
		}catch(Exception e){
			//\u5982\u679c\u65e5\u5fd7\u62a5\u9519javax.imageio.IIOException: Unsupported Image Type\uff0c\u5e94\u8be5\u662f\u4e0a\u4f20\u7684\u8fd9\u4e2a\u56fe\u7247\u7ecf\u8fc7ps\u5904\u7406\u6539\u53d8\u4e86\u6a21\u5f0f\u4e86\uff0c\u7528\u753b\u56fe\u5de5\u5177\u53e6\u5b58\u4e3a\u5c31\u53ef\u4ee5\u4e86
			rs.writeLog("GetUserIconOpreate>Exception:"+e.getMessage());
		}
	}

      out.write(_jsp_string2, 0, _jsp_string2.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("messager/GetUserIconOpreate.jsp"), -8538745228413294137L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string1;
  private final static char []_jsp_string2;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
    _jsp_string2 = "\r\n\r\n".toCharArray();
  }
}
