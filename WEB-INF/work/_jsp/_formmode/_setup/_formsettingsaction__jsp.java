/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._formmode._setup;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.general.BaseBean;
import weaver.formmode.virtualform.VirtualFormHandler;
import weaver.formmode.field.FieldComInfo;
import net.sf.json.JSONArray;
import java.net.URLDecoder;
import net.sf.json.JSONObject;
import weaver.formmode.service.FormInfoService;
import weaver.formmode.dao.BaseDao;
import weaver.conn.RecordSetTrans;
import java.net.URLEncoder;
import weaver.formmode.service.CommonConstant;
import weaver.conn.RecordSet;
import weaver.systeminfo.label.LabelComInfo;
import weaver.workflow.form.FormManager;
import weaver.systeminfo.SystemEnv;
import weaver.workflow.workflow.BillComInfo;
import weaver.workflow.field.BrowserComInfo;
import weaver.formmode.virtualform.VirtualFormCacheManager;
import weaver.formmode.service.LogService;
import weaver.formmode.Module;
import weaver.formmode.log.LogType;
import java.util.*;
import weaver.general.Util;
import weaver.hrm.HrmUserVarify;
import weaver.hrm.User;
import weaver.formmode.ThreadLocalUser;
import weaver.systeminfo.systemright.CheckSubCompanyRight;
import java.io.IOException;

public class _formsettingsaction__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;

  
  private Map getCheckRightSubCompanyParam(String userRightStr,User user,String fmdetachable,int subCompanyId,String subCompanyIdName,
  	HttpServletRequest request,HttpServletResponse response,HttpSession session){
  	int operatelevel=0;
  	Map map = new HashMap();
  	if(subCompanyIdName.equals("")){
  		subCompanyIdName = "subCompanyId";
  	}
  	
  	if(fmdetachable.equals("1")){  
  		if(subCompanyId==-1){
  		    if(request.getParameter(subCompanyIdName)==null){
  		        subCompanyId=Util.getIntValue(String.valueOf(session.getAttribute("managefield_subCompanyId")),-1);
  		    }else{
  		        subCompanyId=Util.getIntValue(request.getParameter(subCompanyIdName),-1);
  		    }
  		    if(subCompanyId == -1){
  		        subCompanyId = user.getUserSubCompany1();
  		    }
  		}
  	    CheckSubCompanyRight CheckSubCompanyRight = new CheckSubCompanyRight();
  	    operatelevel= CheckSubCompanyRight.ChkComRightByUserRightCompanyId(user.getUID(),userRightStr,subCompanyId);
  	    if(operatelevel>=0){
  		    session.setAttribute("managefield_subCompanyId",String.valueOf(subCompanyId));
  	    }
  	}else{
  	    if(HrmUserVarify.checkUserRight(userRightStr, user)){
  	        operatelevel=2;
  	    }
  	}
  	String currentSubCompanyId = ""+session.getAttribute("defaultSubCompanyId");
  	map.put("currentSubCompanyId",currentSubCompanyId);
  	map.put("subCompanyId",subCompanyId);
  	map.put("operatelevel",operatelevel);
  	return map;
  }

  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.filter.XssUtil xssUtil;
      xssUtil = (weaver.filter.XssUtil) pageContext.getAttribute("xssUtil");
      if (xssUtil == null) {
        xssUtil = new weaver.filter.XssUtil();
        pageContext.setAttribute("xssUtil", xssUtil);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.selectItem.SelectItemManager SelectItemManager;
      SelectItemManager = (weaver.workflow.selectItem.SelectItemManager) pageContext.getAttribute("SelectItemManager");
      if (SelectItemManager == null) {
        SelectItemManager = new weaver.workflow.selectItem.SelectItemManager();
        pageContext.setAttribute("SelectItemManager", SelectItemManager);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      
int isIncludeToptitle = 0;
User user = HrmUserVarify.getUser (request , response) ;
if(user==null) {
    response.sendRedirect("/login/Login.jsp");
    return;
}
ThreadLocalUser.setUser(user);

      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.hrm.moduledetach.ManageDetachComInfo ManageDetachComInfo;
      ManageDetachComInfo = (weaver.hrm.moduledetach.ManageDetachComInfo) pageContext.getAttribute("ManageDetachComInfo");
      if (ManageDetachComInfo == null) {
        ManageDetachComInfo = new weaver.hrm.moduledetach.ManageDetachComInfo();
        pageContext.setAttribute("ManageDetachComInfo", ManageDetachComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.systeminfo.systemright.CheckSubCompanyRight CheckSubCompanyRight;
      CheckSubCompanyRight = (weaver.systeminfo.systemright.CheckSubCompanyRight) pageContext.getAttribute("CheckSubCompanyRight");
      if (CheckSubCompanyRight == null) {
        CheckSubCompanyRight = new weaver.systeminfo.systemright.CheckSubCompanyRight();
        pageContext.setAttribute("CheckSubCompanyRight", CheckSubCompanyRight);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.company.SubCompanyComInfo SubCompanyComInfo;
      SubCompanyComInfo = (weaver.hrm.company.SubCompanyComInfo) pageContext.getAttribute("SubCompanyComInfo");
      if (SubCompanyComInfo == null) {
        SubCompanyComInfo = new weaver.hrm.company.SubCompanyComInfo();
        pageContext.setAttribute("SubCompanyComInfo", SubCompanyComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      
boolean isUseFmManageDetach=ManageDetachComInfo.isUseFmManageDetach();
String fmdetachable="0";
if(isUseFmManageDetach){
   fmdetachable="1";
   session.setAttribute("detachable","1");
   session.setAttribute("fmdetachable",fmdetachable);
   session.setAttribute("fmdftsubcomid",ManageDetachComInfo.getFmdftsubcomid());
}else{
   fmdetachable="0";
   session.setAttribute("detachable","0");
   session.setAttribute("fmdetachable",fmdetachable);
   session.setAttribute("fmdftsubcomid","0");
}

      out.write(_jsp_string3, 0, _jsp_string3.length);
      
response.reset();
out.clear();
FormInfoService formInfoService = new FormInfoService();
String action = Util.null2String(request.getParameter("action"));
RecordSetTrans rsTrans = new RecordSetTrans();
RecordSet rs = new RecordSet();
LogService logService = new LogService();
if(action.equalsIgnoreCase("saveFormfield")){
	try{
		int formId = Util.getIntValue(request.getParameter("formId"));
		String data = Util.null2String(request.getParameter("data"));
		data = URLDecoder.decode(data, "UTF-8");
		JSONArray dataArr = JSONArray.fromObject(data);
		for(int i = 0; i < dataArr.size(); i++){
			JSONObject jsonObject = (JSONObject)dataArr.get(i);
			int fieldId = Util.getIntValue(Util.null2String(jsonObject.get("id")));
			String fieldname = Util.null2String(jsonObject.get("fieldname"));
			if("id".equals(fieldname)){
				fieldId = -1000;
			}else if("modedatacreater".equals(fieldname)){
				fieldId = -1001;
			}else if("modedatacreatedate".equals(fieldname)){
				fieldId = -1002;
			}
			int needlog = Util.getIntValue(Util.null2String(jsonObject.get("needlog")), 0);
			int needExcel = Util.getIntValue(Util.null2String(jsonObject.get("needExcel")), 0);
			int isprompt = Util.getIntValue(Util.null2String(jsonObject.get("isprompt")), 0);
			String expendattr = Util.null2String(jsonObject.get("expendattr"));
			int impcheck = Util.getIntValue(Util.null2String(jsonObject.get("impcheck")),0);
			String checkexpression = Util.null2String(jsonObject.get("checkexpression"));
			Map<String,	Object> dataMap = new HashMap<String,	Object>();
			dataMap.put("formId", formId);
			dataMap.put("fieldId", fieldId);
			dataMap.put("needlog", needlog);
			dataMap.put("needExcel", needExcel);
			dataMap.put("isprompt", isprompt);
			dataMap.put("expendattr", expendattr);
			dataMap.put("impcheck", impcheck);
			dataMap.put("checkexpression", checkexpression);
			
			formInfoService.saveOrUpdateFieldExtend(dataMap);
		}
		logService.log(formId, Module.FORM, LogType.EDIT);
		out.print("1");
	}catch(Exception ep){
		ep.printStackTrace();
		out.print("0");		
	}
}else if(action.equalsIgnoreCase("saveFormfield2")){
	char flag=2;
	rsTrans.setAutoCommit(false);
	try{
		int formId = Util.getIntValue(request.getParameter("formId"));
		String data = Util.null2String(request.getParameter("data"));
		data = URLDecoder.decode(data, "UTF-8");
		JSONArray dataArr = JSONArray.fromObject(data);
		
		FormManager formManager = new FormManager();
		BrowserComInfo browserComInfo = new BrowserComInfo();
		
		boolean issqlserver = CommonConstant.DB_TYPE.equals("sqlserver");
		boolean isoracle = CommonConstant.DB_TYPE.equals("oracle");
		boolean isdb2 = CommonConstant.DB_TYPE.equals("db2");
		
		String labelidsCache = ",";//\u66f4\u65b0\u7f13\u5b58\u7528
		Map<String,String> field_pubchoice_map = new HashMap<String,String>();
		Map<String,String> field_pubchilchoiceid_map = new HashMap<String,String>();
		List<String> field_selectlist = new ArrayList<String>();
		for(int i = 0; i < dataArr.size(); i++){
			JSONObject jsonObject = (JSONObject)dataArr.get(i);
			String fieldId = Util.null2String(jsonObject.get("id"));
			
			//\u4e0d\u4e3a\u7a7a\u8868\u793a\u662f\u7f16\u8f91\u5b57\u6bb5\uff0c\u4e3a\u7a7a\u8868\u793a\u65b0\u6dfb\u52a0\u5b57\u6bb5\u3002
	  		if(!fieldId.equals("")){
				//\u5bf9\u7f16\u8f91\u5b57\u6bb5\u5148\u5220\u9664\uff0c\u518d\u6dfb\u52a0
				//\u5b57\u6bb5\u7f16\u8f91\u65f6\u4e0d\u5141\u8bb8\u4fee\u6539\u5b57\u6bb5\u6570\u636e\u5e93\u540d\uff0c\u4e0d\u9700\u8981\u91cd\u65b0\u751f\u6210id\uff0c\u907f\u514d\u6d41\u7a0b\u4e2d\u6570\u636e\u4e22\u5931\u3002TD10290
				rsTrans.executeSql("delete from workflow_SelectItem where isbill=1 and fieldid="+fieldId);//\u5220\u9664\u8868workflow_SelectItem\u4e2d\u8be5\u5b57\u6bb5\u5bf9\u5e94\u6570\u636e
				rsTrans.executeSql("delete from workflow_specialfield where isbill=1 and fieldid="+fieldId);//\u5220\u9664\u8868workflow_specialfield\u4e2d\u8be5\u5b57\u6bb5\u5bf9\u5e94\u6570\u636e	
	  		}
			
	  		String fieldname = "";//\u6570\u636e\u5e93\u5b57\u6bb5\u540d\u79f0
  			int fieldlabel = 0;//\u5b57\u6bb5\u663e\u793a\u540d\u6807\u7b7eid
  			String fielddbtype = "";//\u5b57\u6bb5\u6570\u636e\u5e93\u7c7b\u578b
			String _fielddbtype = "";//\u5b57\u6bb5\u6570\u636e\u5e93\u7c7b\u578b
  			String fieldhtmltype = "";//\u5b57\u6bb5\u9875\u9762\u7c7b\u578b
  			String type = "";//\u5b57\u6bb5\u8be6\u7ec6\u7c7b\u578b
  			String dsporder = "";//\u663e\u793a\u987a\u5e8f
  			String viewtype = "0";//viewtype="0"\u8868\u793a\u4e3b\u8868\u5b57\u6bb5,viewtype="1"\u8868\u793a\u660e\u7ec6\u8868\u5b57\u6bb5
  			String detailtable = "";//\u660e\u7ec6\u8868\u540d
  			int textheight = 0;//\u591a\u884c\u6587\u672c\u6846\u7684\u9ad8\u5ea6
  			int places = 0;
  			
  			int imgwidth = 100;
            int imgheight = 100;
  			String selectitem = "";
  			String linkfield = "";
  			
  			fieldname = Util.null2String(jsonObject.get("fieldname"));
  			String fieldlabelname = Util.null2String(jsonObject.get("fieldlabelname"));
  			fieldlabelname = Util.StringReplace(fieldlabelname, "\"", "");//TD10108 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u53cc\u5f15\u53f7\u201c"\u201d
  			fieldlabelname = Util.StringReplace(fieldlabelname, "'", "");//TD31514 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u5355\u5f15\u53f7\u201c'\u201d
  			
  			if(issqlserver){
  				rsTrans.executeSql("select indexid from HtmlLabelInfo where labelname='"+fieldlabelname+"' collate Chinese_PRC_CS_AI and languageid="+Util.getIntValue(""+user.getLanguage(),7));
  			}else{
  				rsTrans.executeSql("select indexid from HtmlLabelInfo where labelname='"+fieldlabelname+"' and languageid="+Util.getIntValue(""+user.getLanguage(),7));
  			}
		  	if(rsTrans.next()){
		  		fieldlabel = rsTrans.getInt("indexid");//\u5982\u679c\u5b57\u6bb5\u540d\u79f0\u5728\u6807\u7b7e\u5e93\u4e2d\u5b58\u5728\uff0c\u53d6\u5f97\u6807\u7b7eid
		  	}else{
		  		fieldlabel = formManager.getNewIndexId(rsTrans);//\u751f\u6210\u65b0\u7684\u6807\u7b7eid
			  	if(fieldlabel!=-1){//\u66f4\u65b0\u6807\u7b7e\u5e93
			  		labelidsCache+=fieldlabel+",";
			  		rsTrans.executeSql("delete from HtmlLabelIndex where id="+fieldlabel);
			  		rsTrans.executeSql("delete from HtmlLabelInfo where indexid="+fieldlabel);
			  		rsTrans.executeSql("INSERT INTO HtmlLabelIndex values("+fieldlabel+",'"+fieldlabelname+"')");
			  		rsTrans.executeSql("INSERT INTO HtmlLabelInfo values("+fieldlabel+",'"+fieldlabelname+"',7)");
			  		rsTrans.executeSql("INSERT INTO HtmlLabelInfo values("+fieldlabel+",'"+fieldlabelname+"',8)");
			  		rsTrans.executeSql("INSERT INTO HtmlLabelInfo values("+fieldlabel+",'"+fieldlabelname+"',9)");
			  	}
			}
		  	//BillComInfo billComInfo = new BillComInfo();
	  		//billComInfo.addBillCache(""+formId,fieldlabel);
		  	fieldhtmltype = Util.null2String(jsonObject.get("htmltype"));
		  	if(fieldhtmltype.equals("1")){	//\u5355\u884c\u6587\u672c
				type = Util.null2String(jsonObject.get("fieldtype"));	
				if(type.equals("1")){
					String strlength = Util.null2String(jsonObject.get("fieldattr"));
				  	if(Util.getIntValue(strlength,1)<=1) strlength = "1";
			    	if(isoracle) fielddbtype="varchar2("+strlength+")";
			    	else fielddbtype="varchar("+strlength+")";
			   	}
				
				if(type.equals("2")){
			   		if(isoracle) fielddbtype="integer";
			   		else fielddbtype="int";
			   	}
				
				if(type.equals("3")){
					int decimaldigits = Util.getIntValue(Util.null2String(jsonObject.get("fieldattr")),2);
					if(isoracle) fielddbtype="number(15,"+decimaldigits+")";
					else fielddbtype="decimal(15,"+decimaldigits+")";
				}
				 	
			   	if(type.equals("4")){
					if(isoracle) fielddbtype="number(15,2)";
			   		else fielddbtype="decimal(15,2)";
				}
			   	
			   	if(type.equals("5")){
			   		int decimaldigits = Util.getIntValue(Util.null2String(jsonObject.get("fieldattr")),2);
					if(isoracle) fielddbtype="varchar2(30)";
					else fielddbtype="varchar(30)";
			   		places=decimaldigits;
				}
			}
		  	
			if(fieldhtmltype.equals("2")){	//\u591a\u884c\u6587\u672c
			  	String htmledit = Util.null2String(jsonObject.get("fieldattr"));
				if(htmledit.equals("")){
					htmledit = "1";
				}
			  	type=htmledit;
			  	
				if(isoracle) fielddbtype="varchar2(4000)";
				else if(isdb2) fielddbtype="varchar(2000)";
				else fielddbtype="text";
				
				textheight = Util.getIntValue(Util.null2String(jsonObject.get("fieldtype")),4);
			}
			
			if(fieldhtmltype.equals("3")){	//\u6d4f\u89c8\u6309\u94ae
			  	int temptype = Util.getIntValue(Util.null2String(jsonObject.get("fieldtype")),0);
			  	type = ""+temptype;
			  	if(temptype>0){
			  		fielddbtype=browserComInfo.getBrowserdbtype(type+"");
			  	}
			  	
			  	if(temptype==118){
					if(isoracle) fielddbtype="varchar2(200)";
					else fielddbtype="varchar(200)";
				}
			  	
				if(temptype==161||temptype==162){
					fielddbtype=Util.null2String(jsonObject.get("fieldattr"));	//TO DO
					if(temptype==161){
						if(isoracle) _fielddbtype="varchar2(1000)";
						else if(isdb2) _fielddbtype="varchar(1000)";
						else _fielddbtype="varchar(1000)";
					}else{
						if(isoracle) _fielddbtype="varchar2(4000)";
						else if(isdb2) _fielddbtype="varchar(2000)";
						else _fielddbtype="text";
					}
				}
				
				if(temptype==256||temptype==257){
					fielddbtype=Util.null2String(jsonObject.get("fieldattr"));	//TO DO
					if(isoracle) _fielddbtype="varchar2(1000)";
					else if(isdb2) _fielddbtype="varchar(1000)";
					else _fielddbtype="varchar(1000)";
				}
				
				if(temptype==224||temptype==225){
					fielddbtype=Util.null2String(jsonObject.get("fieldattr"));	//TO DO
					if(temptype==224){
						if(isoracle) _fielddbtype="varchar2(1000)";
						else if(isdb2) _fielddbtype="varchar(1000)";
						else _fielddbtype="varchar(1000)";
					}else{
						if(isoracle) _fielddbtype="varchar2(4000)";
						else if(isdb2) _fielddbtype="varchar(2000)";
						else _fielddbtype="text";
					}
				}
					
				if(temptype==226||temptype==227){
					fielddbtype=Util.null2String(jsonObject.get("fieldattr"));	//TO DO
					if(temptype==226){
						if(isoracle) _fielddbtype="varchar2(1000)";
						else if(isdb2) _fielddbtype="varchar(1000)";
						else _fielddbtype="varchar(1000)";
					}else{
						if(isoracle) _fielddbtype="varchar2(4000)";
						else if(isdb2) _fielddbtype="varchar(2000)";
						else _fielddbtype="text";
					}
				}
					
					
				if(temptype==165||temptype==166||temptype==167||temptype==168){
				  	textheight=Util.getIntValue(Util.null2String(jsonObject.get("fieldattr")),0);	//TO DO
				}
			}
			
			if(fieldhtmltype.equals("4")){	//CHECK\u6846
				type = "1";
				fielddbtype="char(1)";
			}
			
			if(fieldhtmltype.equals("5")){	//\u9009\u62e9\u6846
			  	type = "1";
			  	if(isoracle) fielddbtype="integer";
			  	else fielddbtype="int";
			  	field_selectlist.add(fieldId);
			}
			
			if(fieldhtmltype.equals("8")){	//\u9009\u62e9\u6846
				fieldhtmltype = "5";
			  	type = "1";
			  	if(isoracle) fielddbtype="integer";
			  	else fielddbtype="int";
			  	JSONObject sel_data = (JSONObject)jsonObject.get("sel_data");
			  	selectitem = "" + Util.getIntValue(Util.null2String(sel_data.get("pubselectType")), 0);
				linkfield = "" + Util.getIntValue(Util.null2String(sel_data.get("publinkfield")), 0);
				field_pubchoice_map.put(fieldId, selectitem);
				
				field_pubchilchoiceid_map.put(fieldId,linkfield);
			}
			
			if(fieldhtmltype.equals("6")){	//\u9644\u4ef6\u4e0a\u4f20
			  	type = "" + Util.getIntValue(Util.null2String(jsonObject.get("fieldtype")), 1);
			    if(isoracle) fielddbtype="varchar2(4000)";
				else if(isdb2) fielddbtype="varchar(2000)";
			    else fielddbtype="text";
                
			    String uploadPicAttr = Util.null2String(jsonObject.get("fieldattr"));
			    
			    String[] vArr = uploadPicAttr.split(";");
	        	String v1 = vArr.length > 0 ? vArr[0] : "5";
	        	String v2 = vArr.length > 1 ? vArr[1] : "100";
	        	String v3 = vArr.length > 2 ? vArr[2] : "100";
	        	
			    textheight = Util.getIntValue(v1, 0);
                imgwidth = Util.getIntValue(v2);
                imgheight = Util.getIntValue(v3);
			}
			
			if(fieldhtmltype.equals("7")){	//\u7279\u6b8a\u5b57\u6bb5
			  	type = Util.null2String(jsonObject.get("fieldtype"));
			    if(isoracle) fielddbtype="varchar2(4000)";
				else if(isdb2) fielddbtype="varchar(2000)";
			    else fielddbtype="text";
			}
			
			dsporder = Util.null2String(jsonObject.get("ordernum"));
			dsporder = ""+Util.getFloatValue(dsporder,0);
			
			JSONObject sel_data = (JSONObject)jsonObject.get("sel_data");
			int childfieldid_tmp = Util.getIntValue(Util.null2String(sel_data.get("childfieldid")), 0);
			
			if(!fieldId.equals("")){//\u4e0d\u4e3a\u7a7a\u8868\u793a\u662f\u7f16\u8f91\u5b57\u6bb5\uff0c\u4e3a\u7a7a\u8868\u793a\u65b0\u6dfb\u52a0\u5b57\u6bb5\u3002
				rsTrans.executeSql("update workflow_billfield set billid="+formId+",fieldname='"+fieldname+"',fieldlabel="+fieldlabel+",fielddbtype='"+fielddbtype+"',fieldhtmltype="+fieldhtmltype+",type="+type+",dsporder="+dsporder+",viewtype="+viewtype+",detailtable='"+detailtable+"',textheight="+textheight+",childfieldid="+childfieldid_tmp+",imgwidth="+imgwidth+",imgheight="+imgheight+" ,places="+places+",pubchoiceid='"+selectitem+"',pubchilchoiceid='"+linkfield+"',linkfield='"+linkfield+"' where id="+fieldId);
			}
			
			//\u5982\u679c\u662f\u9009\u62e9\u6846\uff0c\u66f4\u65b0\u8868workflow_SelectItem
			String curfieldid = "";
			if(fieldId.equals("")){
			    rsTrans.executeSql("select max(id) as id from workflow_billfield");
			    if(rsTrans.next()) curfieldid = rsTrans.getString("id");
			}else{
			    curfieldid = fieldId;
			}
			
			if(fieldhtmltype.equals("5")){
				JSONArray selDetailArr = (JSONArray)sel_data.get("sel_detaildata");
				int rowsum = Util.getIntValue(Util.null2String(sel_data.get("rowsum")));
				int curvalue=0;
			  	for(int temprow=1;temprow<=rowsum;temprow++){
			  		JSONObject selDetailObj = (JSONObject)selDetailArr.get(temprow - 1);
			  		String curname = Util.null2String(selDetailObj.get("field_name"));
			  		if(curname.equals("")) continue;
			  		String curorder = Util.null2String(selDetailObj.get("field_count_name"));
			  		String isdefault = "n";
			  		String checkValue = Util.null2String(selDetailObj.get("field_checked_name"));
			  		String cancel = Util.null2String(selDetailObj.get("cancel_name"));	//TO DO 
			  		if(cancel!=null && !cancel.equals("") && cancel.equals("1")){
						cancel = "1";
					}else{
						cancel = "0";
					}
					if(checkValue.equals("1")){
						isdefault="y";
					}
					
		  			int isAccordToSubCom_tmp = Util.getIntValue(Util.null2String(selDetailObj.get("isAccordToSubCom")), 0);
					String doccatalog = Util.null2String(selDetailObj.get("maincategory"));
					String docPath = Util.null2String(selDetailObj.get("pathcategory"));
					String childItem_tmp = Util.null2String(selDetailObj.get("childItem"));
					String para=curfieldid+flag+"1"+flag+""+curvalue+flag+curname+flag+curorder+flag+isdefault+flag+cancel; 
					rsTrans.executeProc("workflow_selectitem_insert_new",para);//\u66f4\u65b0\u8868workflow_SelectItem
					rsTrans.executeSql("update workflow_SelectItem set docpath='"+docPath+"', docCategory='"+doccatalog+"',childitemid='"+childItem_tmp+"',isAccordToSubCom='"+isAccordToSubCom_tmp+"' where fieldid="+curfieldid+" and selectvalue="+curvalue);
                    curvalue++;
				}
			}
			
			if(fieldhtmltype.equals("7")){              
				String specialfield = Util.null2String(jsonObject.get("fieldtype"));//\u7c7b\u578b
				String fieldattr = Util.null2String(jsonObject.get("fieldattr"));
				String sql = "";
				if(specialfield.equals("1")){
					String[] vArr = fieldattr.split(";");
		        	String v1 = vArr.length > 0 ? vArr[0] : "";
		        	String v2 = vArr.length > 1 ? vArr[1] : "";
					String displayname = v1;//\u663e\u793a\u540d
					String linkaddress = v2;//\u94fe\u63a5\u5730\u5740
					sql = "insert into workflow_specialfield(fieldid,displayname,linkaddress,isform,isbill) values("+curfieldid+",'"+displayname+"','"+linkaddress+"',0,1)";    
				}else{
					String descriptivetext = fieldattr;//\u63cf\u8ff0\u6027\u6587\u5b57
					descriptivetext = Util.spacetoHtml(descriptivetext);
					sql = "insert into workflow_specialfield(fieldid,descriptivetext,isform,isbill) values("+curfieldid+",'"+descriptivetext+"',0,1)";    
				}
				rsTrans.executeSql(sql);
			}
			
			//\u4fdd\u5b58\u5b57\u6bb5\u6269\u5c55\u5c5e\u6027
			int needlog = Util.getIntValue(Util.null2String(jsonObject.get("needlog")), 0);
			int isprompt = Util.getIntValue(Util.null2String(jsonObject.get("isprompt")), 0);
			String expendattr = Util.null2String(jsonObject.get("expendattr"));
			Map<String,	Object> dataMap = new HashMap<String,	Object>();
			dataMap.put("formId", formId);
			dataMap.put("fieldId", fieldId);
			dataMap.put("needlog", needlog);
			dataMap.put("isprompt", isprompt);
			dataMap.put("expendattr", expendattr);
			formInfoService.saveOrUpdateFieldExtend(dataMap);
			
		}
		for(int i=0;i<field_selectlist.size();i++){
			rsTrans.executeSql("update workflow_billfield set pubchoiceid = null where id="+field_selectlist.get(i));
		}
		rsTrans.commit();
		for(Map.Entry<String, String> entry: field_pubchoice_map.entrySet()){
			    int fieldid = Util.getIntValue(entry.getKey(),0);
			    int pubchoiceId = Util.getIntValue(entry.getValue(),0);
				SelectItemManager.setSelectOpBypubid(formId+"",pubchoiceId,fieldid+"",1,user.getLanguage());
		}
		for(Map.Entry<String, String> entry: field_pubchilchoiceid_map.entrySet()){
			    int fieldid = Util.getIntValue(entry.getKey(),0);
			    int pubchilchoiceid = Util.getIntValue(entry.getValue(),0);
				SelectItemManager.setSuperSelectOp(formId+"",1,pubchilchoiceid,fieldid,user.getLanguage());
		}
		LabelComInfo labelComInfo = new LabelComInfo();
		ArrayList labelidsArray = Util.TokenizerString(labelidsCache,",");
		for(int i=0;i<labelidsArray.size();i++){//\u6dfb\u52a0\u6807\u7b7eid\u5230\u7f13\u5b58
			labelComInfo.addLabeInfoCache((String)labelidsArray.get(i));
		}
		FieldComInfo fieldComInfo = new FieldComInfo();
  		fieldComInfo.removeFieldCache();
		logService.log(formId, Module.FORM, LogType.EDIT);
		
		out.print("1");
	}catch(Exception ep){
		rsTrans.rollback();
		ep.printStackTrace();
		out.print("0");		
	}
}else if(action.equalsIgnoreCase("getFieldLogDetail")){
	int viewlogid = Util.getIntValue(request.getParameter("viewlogid"));
	int modeid = Util.getIntValue(request.getParameter("modeid"));
	List<Map<String, Object>> dataList = formInfoService.getFieldLogDetailByViewlogid(viewlogid,modeid,user.getLanguage());
	//TODO \u5b57\u6bb5\u503c\u6309\u7167\u7c7b\u578b\u8f6c\u6362
	JSONArray result = JSONArray.fromObject(dataList);

	//try{Thread.sleep(2000);}catch(Exception e){}
	response.setCharacterEncoding("UTF-8");
	out.print(result.toString());
}else if(action.equalsIgnoreCase("getPromptField")){
	int formId = Util.getIntValue(request.getParameter("formId"));
	JSONArray promptFieldArr = formInfoService.getPromptFieldWithJSON(formId); //\u6570\u636e\u63d0\u9192\u7684\u5b57\u6bb5\u4fe1\u606f
	//try{Thread.sleep(2000);}catch(Exception e){}
	response.setCharacterEncoding("UTF-8");
	out.print(promptFieldArr.toString());
}else if(action.equalsIgnoreCase("validatePromptFieldData")){
	int formId = Util.getIntValue(request.getParameter("formId"));
	int dataId = Util.getIntValue(request.getParameter("dataId"));
	String data = Util.null2String(request.getParameter("data"));
	data = data.replace("+", "%2B");
	data = URLDecoder.decode(data, "UTF-8");
	JSONArray dataArr = JSONArray.fromObject(data);
	String sql = "";
	String tablename = formInfoService.getTablenameByFormid(formId);
	ArrayList<String> parmArray = new ArrayList<String>();
	for(int i = 0; i < dataArr.size(); i++){
		JSONObject jsonObject = (JSONObject)dataArr.get(i);
		String fieldid = Util.null2String(jsonObject.get("fieldid"));
		String fieldname = Util.null2String(jsonObject.get("fieldname"));
		String changedValue = Util.null2String(jsonObject.get("changedValue"));
		sql += " select '"+fieldid+"' as fieldid,COUNT(1) as dcount from "+tablename+" where "+fieldname+"=? and id!="+dataId;
		parmArray.add(changedValue);
		if(i != (dataArr.size() - 1)){
			sql += " union all";
		}
	}
	rs.executeQuery(sql, parmArray.toArray());
	List<Map<String, Object>> resultList = new ArrayList<Map<String, Object>>();
	while(rs.next()){
		Map<String, Object> map = new HashMap<String, Object>();
		map.put("fieldid", Util.null2String(rs.getString("fieldid")));
		map.put("dcount", Util.getIntValue(rs.getString("dcount"),0));
		resultList.add(map);
	}
	JSONArray resultArr = JSONArray.fromObject(resultList);
	out.print(resultArr.toString());
}else if(action.equalsIgnoreCase("createIndex")){
	int formId = Util.getIntValue(request.getParameter("formId"));
	
	String tablename = Util.null2String(request.getParameter("tablename"));
	
	String indexName = Util.null2String(request.getParameter("indexName"));
	if(indexName.trim().equals("")){
		indexName = tablename + "_" + System.currentTimeMillis();
	}
	
	String uniqueFlag = Util.null2String(request.getParameter("uniqueFlag"));
	boolean isUnique = uniqueFlag.equals("1");
	String uniqueStr = "";
	if(isUnique){
		uniqueStr = "unique";
	}
	
	String indexColumns = Util.null2String(request.getParameter("indexColumns"));
	
	String errorMsg = "";
	String sql = "create "+uniqueStr+" index "+indexName+" on "+tablename+" ("+indexColumns+")";
	try{
		rsTrans.setAutoCommit(false);
		rsTrans.execute(sql);
		rsTrans.commit();
	}catch(Exception ep){
		rsTrans.rollback();
		errorMsg = ep.getMessage();
		if(rs.getDBType().equalsIgnoreCase("oracle")&&indexName.length()>30){
			errorMsg += ","+SystemEnv.getHtmlLabelName(82126,user.getLanguage())+":"+indexName+","+SystemEnv.getHtmlLabelName(128734,user.getLanguage());
		}
	}
	response.sendRedirect("/formmode/setup/formIndex.jsp?formId="+formId+"&errorMsg="+xssUtil.put(errorMsg));
	return;
}else if(action.equalsIgnoreCase("deleteIndex")){
	String indexName = Util.null2String(request.getParameter("indexName"));
	String tablename = Util.null2String(request.getParameter("tablename"));
	String sql = "drop index ";
	if(CommonConstant.DB_TYPE.equals("sqlserver")){	//\u5355\u72ec\u5904\u7406sql server  Oracle\u5220\u9664\u7d22\u5f15\u4e0d\u9700\u8981\u8868\u540d
		sql += tablename+".";
	}
	sql += indexName;
	try{
		//rsTrans.execute(sql);
		rs.executeSql(sql);
		out.print("1");
	}catch(Exception ep){
		ep.printStackTrace();
		out.print("0");
	}
}else if(action.equalsIgnoreCase("checkform")){
	String tablename = Util.null2String(request.getParameter("tablename"));
	rs.executeSql("select id from workflow_bill where tablename ='"+tablename+"'");
	if(rs.next()){
		out.print("1");
	}else{
		out.print("0");
	}
}else if(action.equalsIgnoreCase("eidtform")){
	String formname = Util.null2String(request.getParameter("formname"));
	String formid = Util.null2String(request.getParameter("formid"));
  	formname = formname.replaceAll("<","\uff1c").replaceAll(">","\uff1e").replaceAll("'","''");
	formname = Util.toHtmlForSplitPage(formname);
	float dsporder  = Util.getFloatValue(request.getParameter("dsporder"));
  	boolean issamename = false;
  	rs.executeSql("select namelabel from workflow_bill where id !="+formid);
    while(rs.next()){//\u65b0\u8868\u5355\u540d\u548c\u5355\u636e\u540d
  	    int namelabel = Util.getIntValue(Util.null2String(rs.getString("namelabel")),0);
  	    if(namelabel!=0)
  	    {
  	        if(formname.equals(SystemEnv.getHtmlLabelName(namelabel,user.getLanguage())))
  	        {
  	            issamename = true;
  	            break;
  	        }
  	    }
  	}
  	rs.executeSql("select formname from workflow_formbase where id !="+formid);
    while(rs.next()){//\u65e7\u8868\u5355\u540d
  	    String tempformname = Util.null2String(rs.getString("formname"));
  	    if(!tempformname.equals(""))
  	    {
  	        if(formname.equals(tempformname))
  	        {
  	            issamename = true;
  	            break;
  	        }
  	    }
  	}
  	if(issamename){
  		//String errorMsg = URLEncoder.encode(SystemEnv.getHtmlLabelName(22750,user.getLanguage()));
  		response.sendRedirect("/formmode/setup/formbase.jsp?id="+formid+"&errorMsg=22750&errorcode=1");
	    return;
  	}
  	int namelabelid = -1;
  	boolean issqlserver = CommonConstant.DB_TYPE.equals("sqlserver") ;
  	if(issqlserver) rs.executeSql("select indexid from HtmlLabelInfo where labelname='"+formname+"' collate Chinese_PRC_CS_AI and languageid="+Util.getIntValue(""+user.getLanguage(),7));
	else rs.executeSql("select indexid from HtmlLabelInfo where labelname='"+formname+"' and languageid="+Util.getIntValue(""+user.getLanguage(),7));
	if(rs.next()) namelabelid = rs.getInt("indexid");//\u5982\u679c\u8868\u5355\u540d\u79f0\u5728\u6807\u7b7e\u5e93\u4e2d\u5b58\u5728\uff0c\u53d6\u5f97\u6807\u7b7eid
	else{
		FormManager formManager = new FormManager();
		namelabelid = formManager.getNewIndexId(rsTrans);//\u751f\u6210\u65b0\u7684\u6807\u7b7eid
		if(namelabelid!=-1){//\u66f4\u65b0\u6807\u7b7e\u5e93
			rs.executeSql("delete from HtmlLabelIndex where id="+namelabelid);
			rs.executeSql("delete from HtmlLabelInfo where indexid="+namelabelid);
			rs.executeSql("INSERT INTO HtmlLabelIndex values("+namelabelid+",'"+formname+"')");
			rs.executeSql("INSERT INTO HtmlLabelInfo values("+namelabelid+",'"+formname+"',7)");
			rs.executeSql("INSERT INTO HtmlLabelInfo values("+namelabelid+",'"+formname+"',8)");
			rs.executeSql("INSERT INTO HtmlLabelInfo values("+namelabelid+",'"+formname+"',9)");
		}
	}
	LabelComInfo labelComInfo = new LabelComInfo();
	labelComInfo.addLabeInfoCache(""+namelabelid);//\u5f80\u7f13\u5b58\u4e2d\u6dfb\u52a0\u8868\u5355\u540d\u79f0\u7684\u6807\u7b7e
	BillComInfo billComInfo = new BillComInfo();
	billComInfo.addBillCache(formid,namelabelid);
  	String formdes = Util.null2String(request.getParameter("formdes"));
  	formdes = formdes.replaceAll("<","\uff1c").replaceAll(">","\uff1e").replaceAll("'","''");
  	formdes = Util.toHtmlForSplitPage(formdes);
  	
  	int subcompanyid = Util.getIntValue(request.getParameter("subcompanyid"),-1);
  	if(subcompanyid==-1){
		rs.executeSql("select dftsubcomid from SystemSet");
		if(rs.next()) subcompanyid = Util.getIntValue(rs.getString("dftsubcomid"),-1);
		if(subcompanyid==-1){
	  		rs.executeSql("select min(id) as id from HrmSubCompany");
	  		if(rs.next()) subcompanyid = rs.getInt("id");
		}
	}	
  	
  	int subCompanyId3 = Util.getIntValue(request.getParameter("subCompanyId3"),-1);
  	if(subCompanyId3==-1){//\u5206\u6743\u5206\u90e8\u7684\u53d6\u5f97\u3002\u5982\u679c\u9875\u9762\u6ca1\u6709\uff0c\u5219\u9996\u5148\u4ece\u5206\u6743\u8bbe\u7f6e\u7684\u9ed8\u8ba4\u673a\u6784\u53d6\u5f97\uff0c\u5982\u679c\u9ed8\u8ba4\u673a\u6784\u6ca1\u6709\u8bbe\u7f6e\u5219\u53d6\u6240\u6709\u5206\u90e8\u4e2did\u6700\u5c0f\u7684\u90a3\u4e2a\u5206\u90e8\u3002
  		rsTrans.executeSql("select fmdftsubcomid,dftsubcomid from SystemSet");
  		if(rsTrans.next()){
  			subCompanyId3 = Util.getIntValue(rsTrans.getString("fmdftsubcomid"),-1);
  			if(subCompanyId3==-1){
	  			subCompanyId3 = Util.getIntValue(rsTrans.getString("dftsubcomid"),-1);
  			}
  		}
  		if(subCompanyId3==-1){
  			rsTrans.executeSql("select min(id) as id from HrmSubCompany");
  			if(rsTrans.next()) subCompanyId3 = rsTrans.getInt("id");
  		}
  	}
  	rs.executeSql("update workflow_bill set subCompanyId="+subcompanyid+",subCompanyId3="+subCompanyId3+", namelabel="+namelabelid+",formdes='"+formdes+"',dsporder='"+dsporder+"' where id="+formid);
  	
	//\u66f4\u65b0\u7f13\u5b58\u4e2d\u7684\u865a\u62df\u8868\u5355\u6570\u636e
  	String isvirtualform = Util.null2String(request.getParameter("isvirtualform"));
  	if(isvirtualform.equals("true")){
  		String vprimarykey = Util.null2String(request.getParameter("vprimarykey"));
  		String vpkgentype =  Util.null2String(request.getParameter("vpkgentype"));
  		rs.executeSql("update ModeFormExtend set vprimarykey='"+vprimarykey+"' ,vpkgentype='"+vpkgentype+"' where formid='"+formid+"'");
  		VirtualFormCacheManager.updateVFormInCache(formid);
  	}
  	
  	logService.log(formid, Module.FORM, LogType.EDIT);
  	
  	//response.sendRedirect("/formmode/setup/formbase.jsp?id="+formid+"&isRefreshLeftData=1");
  	out.print("<script type=\"text/javascript\">parent.parent.refreshForm("+formid+");</script>");
}else if(action.equalsIgnoreCase("getFormInfoByAppIdWithJSON")){
	int appId = Util.getIntValue(request.getParameter("appId"), 0);
	int subCompanyId = Util.getIntValue(request.getParameter("subCompanyId"), 0);
	JSONArray forminfoArr = new JSONArray();
	if(fmdetachable.equals("1")){
		forminfoArr = formInfoService.getFormInfoByAppIdWithJSONDetach(appId,subCompanyId);
	}else{
		forminfoArr = formInfoService.getFormInfoByAppIdWithJSON(appId);
	}
	response.setCharacterEncoding("UTF-8");
	out.print(forminfoArr.toString());
}else if(action.equalsIgnoreCase("getTablesByDS")){
	JSONObject result = new JSONObject();
	try{
		String dsName = Util.null2String(request.getParameter("dsName"));
		List<Map<String, Object>> dataList = formInfoService.getTablesByDS(dsName);
		JSONArray jsonArray = JSONArray.fromObject(dataList);
		result.put("status", "1");
		result.put("data", jsonArray);
	}catch(Exception ep){
		result.put("status", "0");
		//result.put("errorMsg", URLEncoder.encode(Util.null2String(ep.getMessage())));
		result.put("errorMsg",Util.null2String(ep.getMessage()));
		
	}
	response.setCharacterEncoding("UTF-8");
	out.print(result.toString());
}else if(action.equalsIgnoreCase("getFieldsByTable")){
	JSONObject result = new JSONObject();
	try{
		String dsName = Util.null2String(request.getParameter("dsName"));
		String tbName = Util.null2String(request.getParameter("tbName"));
		List<Map<String, Object>> dataList = formInfoService.getFieldsByTable(dsName, tbName);
		JSONArray jsonArray = JSONArray.fromObject(dataList);
		result.put("status", "1");
		result.put("data", jsonArray);
	}catch(Exception ep){
		result.put("status", "0");
		result.put("errorMsg", URLEncoder.encode(Util.null2String(ep.getMessage())));
	}
	response.setCharacterEncoding("UTF-8");
	out.print(result.toString());
}else if(action.equalsIgnoreCase("getFieldsByTables")){
	JSONObject result = new JSONObject();
	try{
		String dsName = Util.null2String(request.getParameter("dsName"));
		String tbArrayString = Util.null2String(request.getParameter("tbArray"));
		String[] tbArray = tbArrayString.split(",");
		List<Map<String, Object>> resultList = new ArrayList<Map<String,Object>>();
		for(String tbName : tbArray){
			List<Map<String, Object>> dataList = formInfoService.getFieldsByTable(dsName, tbName);
			resultList.addAll(dataList);
		}
		JSONArray jsonArray = JSONArray.fromObject(resultList);
		result.put("status", "1");
		result.put("data", jsonArray);
	}catch(Exception ep){
		result.put("status", "0");
		result.put("errorMsg", URLEncoder.encode(Util.null2String(ep.getMessage())));
	}
	response.setCharacterEncoding("UTF-8");
	out.print(result.toString());
}else if(action.equalsIgnoreCase("addform")){
	int appId = Util.getIntValue(request.getParameter("appId"), 0);
	
	String formname = Util.null2String(request.getParameter("formname"));
  	formname = formname.replaceAll("<","\uff1c").replaceAll(">","\uff1e").replaceAll("'","''");
  	formname = Util.toHtmlForSplitPage(formname);
  	
	//\u540c\u540d\u9a8c\u8bc1 \u5f00\u59cb TD10194
  	boolean issamename = false;
  	rs.executeSql("select namelabel from workflow_bill");
    while(rs.next()){//\u65b0\u8868\u5355\u540d\u548c\u5355\u636e\u540d
  	    int namelabel = Util.getIntValue(Util.null2String(rs.getString("namelabel")),0);
  	    if(namelabel!=0)
  	    {
  	        if(formname.equals(SystemEnv.getHtmlLabelName(namelabel,user.getLanguage())))
  	        {
  	            issamename = true;
  	            break;
  	        }
  	    }
  	}
    if(!issamename){	//\u518d\u9a8c\u8bc1\u65e7\u8868\u5355
	  	rs.executeSql("select formname from workflow_formbase");
	    while(rs.next()){//\u65e7\u8868\u5355\u540d
	  	    String tempformname = Util.null2String(rs.getString("formname"));
	  	    if(!tempformname.equals(""))
	  	    {
	  	        if(formname.equals(tempformname))
	  	        {
	  	            issamename = true;
	  	            break;
	  	        }
	  	    }
	  	}
    }
  	if(issamename){
  		String errorMsg = SystemEnv.getHtmlLabelName(22750,user.getLanguage());//\u8868\u5355\u540d\u79f0\u5df2\u5b58\u5728
  		response.sendRedirect("/formmode/setup/formAdd.jsp?appId=" + appId + "&errorMsg="+xssUtil.put(errorMsg)+"&errorcode=1");
	    return;
  	}
  	//\u540c\u540d\u9a8c\u8bc1 \u7ed3\u675f TD10194
  	
  	String formdes = Util.null2String(request.getParameter("formdes"));
  	formdes = formdes.replaceAll("<","\uff1c").replaceAll(">","\uff1e").replaceAll("'","''");
  	formdes = Util.toHtmlForSplitPage(formdes);
  	
  	rsTrans.setAutoCommit(false);
  	try{
  		FormManager formManager = new FormManager();
		int namelabelid = -1;
		boolean issqlserver = CommonConstant.DB_TYPE.equals("sqlserver") ;
		if(issqlserver) rsTrans.executeSql("select indexid from HtmlLabelInfo where labelname='"+formname+"' collate Chinese_PRC_CS_AI and languageid="+Util.getIntValue(""+user.getLanguage(),7));
		else rsTrans.executeSql("select indexid from HtmlLabelInfo where labelname='"+formname+"' and languageid="+Util.getIntValue(""+user.getLanguage(),7));
		if(rsTrans.next()) namelabelid = rsTrans.getInt("indexid");//\u5982\u679c\u8868\u5355\u540d\u79f0\u5728\u6807\u7b7e\u5e93\u4e2d\u5b58\u5728\uff0c\u53d6\u5f97\u6807\u7b7eid
		else{
			namelabelid = formManager.getNewIndexId(rsTrans);//\u751f\u6210\u65b0\u7684\u6807\u7b7eid
		  	if(namelabelid!=-1){//\u66f4\u65b0\u6807\u7b7e\u5e93
		  		rsTrans.executeSql("delete from HtmlLabelIndex where id="+namelabelid);
		  		rsTrans.executeSql("delete from HtmlLabelInfo where indexid="+namelabelid);
		  		rsTrans.executeSql("INSERT INTO HtmlLabelIndex values("+namelabelid+",'"+formname+"')");
		  		rsTrans.executeSql("INSERT INTO HtmlLabelInfo values("+namelabelid+",'"+formname+"',7)");
		  		rsTrans.executeSql("INSERT INTO HtmlLabelInfo values("+namelabelid+",'"+formname+"',8)");
		  		rsTrans.executeSql("INSERT INTO HtmlLabelInfo values("+namelabelid+",'"+formname+"',9)");
		  	}
		}
	  	
	  	int subcompanyid = Util.getIntValue(request.getParameter("subcompanyid"),-1);
	  	if(subcompanyid==-1){//\u5206\u6743\u5206\u90e8\u7684\u53d6\u5f97\u3002\u5982\u679c\u9875\u9762\u6ca1\u6709\uff0c\u5219\u9996\u5148\u4ece\u5206\u6743\u8bbe\u7f6e\u7684\u9ed8\u8ba4\u673a\u6784\u53d6\u5f97\uff0c\u5982\u679c\u9ed8\u8ba4\u673a\u6784\u6ca1\u6709\u8bbe\u7f6e\u5219\u53d6\u6240\u6709\u5206\u90e8\u4e2did\u6700\u5c0f\u7684\u90a3\u4e2a\u5206\u90e8\u3002
	  		rsTrans.executeSql("select dftsubcomid from SystemSet");
	  		if(rsTrans.next()) subcompanyid = Util.getIntValue(rsTrans.getString("dftsubcomid"),-1);
	  		if(subcompanyid==-1){
	  			rsTrans.executeSql("select min(id) as id from HrmSubCompany");
	  			if(rsTrans.next()) subcompanyid = rsTrans.getInt("id");
	  		}
	  	}
	  	
	  	int subCompanyId3 = Util.getIntValue(request.getParameter("subCompanyId3"),-1);
	  	if(subCompanyId3==-1){//\u5206\u6743\u5206\u90e8\u7684\u53d6\u5f97\u3002\u5982\u679c\u9875\u9762\u6ca1\u6709\uff0c\u5219\u9996\u5148\u4ece\u5206\u6743\u8bbe\u7f6e\u7684\u9ed8\u8ba4\u673a\u6784\u53d6\u5f97\uff0c\u5982\u679c\u9ed8\u8ba4\u673a\u6784\u6ca1\u6709\u8bbe\u7f6e\u5219\u53d6\u6240\u6709\u5206\u90e8\u4e2did\u6700\u5c0f\u7684\u90a3\u4e2a\u5206\u90e8\u3002
	  		rsTrans.executeSql("select fmdftsubcomid,dftsubcomid from SystemSet");
	  		if(rsTrans.next()){
	  			subCompanyId3 = Util.getIntValue(rsTrans.getString("fmdftsubcomid"),-1);
	  			if(subCompanyId3==-1){
		  			subCompanyId3 = Util.getIntValue(rsTrans.getString("dftsubcomid"),-1);
	  			}
	  		}
	  		if(subCompanyId3==-1){
	  			rsTrans.executeSql("select min(id) as id from HrmSubCompany");
	  			if(rsTrans.next()) subCompanyId3 = rsTrans.getInt("id");
	  		}
	  	}
	  	
	  	String formtype = Util.null2String(request.getParameter("formtype"));
	  	formtype = "1";	//\u6682\u65f6\u56fa\u5b9a\u4e3a\u865a\u62df\u8868\u5355
	  	
	  	int formid = formManager.getNewFormId();
	  	
	  	if(formtype.equals("0")){	//\u5b9e\u9645\u8868\u5355
	  		
	  		String formtable_main = "formtable_main_"+formid*(-1);//\u4e3b\u8868\u540d
	  		rsTrans.executeSql("insert into workflow_bill(id,namelabel,tablename,detailkeyfield,formdes,subcompanyid,subCompanyId3) values("+formid+","+namelabelid+",'"+formtable_main+"','mainid','"+formdes+"',"+subcompanyid+","+subCompanyId3+")");
	  		
	  		String dbType = CommonConstant.DB_TYPE;
			if("oracle".equals(dbType)){//\u521b\u5efa\u8868\u5355\u4e3b\u8868\uff0c\u660e\u7ec6\u8868\u7684\u521b\u5efa\u5728\u65b0\u5efa\u5b57\u6bb5\u7684\u65f6\u5019\u5982\u679c\u6709\u660e\u7ec6\u5b57\u6bb5\u5219\u521b\u5efa\u660e\u7ec6\u8868
				rsTrans.executeSql("create table " + formtable_main + "(id integer primary key not null, requestId integer)");
	  		}else{
	  			rsTrans.executeSql("create table " + formtable_main + "(id int IDENTITY(1,1) primary key CLUSTERED, requestId integer)");
	  		}
			rsTrans.commit();
			if("oracle".equals(dbType)){//\u4e3b\u8868id\u81ea\u589e\u957f
				rsTrans.executeSql("create sequence "+formtable_main+"_Id start with 1 increment by 1 nomaxvalue nocycle");
				rsTrans.setChecksql(false);
				rsTrans.executeSql("CREATE OR REPLACE TRIGGER "+formtable_main+"_Id_Trigger before insert on "+formtable_main+" for each row begin select "+formtable_main+"_Id.nextval into :new.id from dual; end;");
	  		}
			
	  	}else if(formtype.equals("1")){	//\u865a\u62df\u8868\u5355
	  		
	  		String vtableName = Util.null2String(request.getParameter("vtableName"));
	  		vtableName = VirtualFormHandler.getVirtualFormName(vtableName);
	  		rsTrans.executeSql("insert into workflow_bill(id,namelabel,tablename,detailkeyfield,formdes,subcompanyid,subCompanyId3) values("+formid+","+namelabelid+",'"+vtableName+"','mainid','"+formdes+"',"+subcompanyid+","+subCompanyId3+")");

	  		rsTrans.commit();
	  		
	  		String virtualformtype = Util.null2String(request.getParameter("virtualformtype"));	//\u865a\u62df\u8868\u5355\u7c7b\u578b   0\u4e3a\u8868  1\u4e3a\u89c6\u56fe
	  		String vdatasource = Util.null2String(request.getParameter("vdatasource"));
	  		String vprimarykey = Util.null2String(request.getParameter("vprimarykey"));	//\u4e3b\u952e\u5b57\u6bb5
	  		String vpkgentype = Util.null2String(request.getParameter("vpkgentype"));	//\u4e3b\u952e\u751f\u6210\u7b56\u7565
	  		
	  		//\u6dfb\u52a0\u6269\u5c55\u8868\u4fe1\u606f
	  		Map<String,	Object> dataMap = new HashMap<String,	Object>();
			dataMap.put("formId", formid);
			dataMap.put("appId", appId);
			dataMap.put("isvirtualform", "1");	//\u662f\u5426\u865a\u62df\u8868\u5355   1\u4e3a\u865a\u62df\u8868\u5355\uff0c0\u4e3a\u5b9e\u9645\u8868\u5355
			dataMap.put("virtualformtype", virtualformtype);
			dataMap.put("vdatasource", vdatasource);
			dataMap.put("vprimarykey", vprimarykey);
			dataMap.put("vpkgentype", vpkgentype);
			formInfoService.saveOrUpdateFormExtend(dataMap);
			vtableName = VirtualFormHandler.getRealFromName(vtableName);
			
			//\u6dfb\u52a0\u5b57\u6bb5
			String[] vfieldNameArr = request.getParameterValues("vfieldName");
			formInfoService.generateVirtualTableColumns(formid, vtableName, vfieldNameArr, vdatasource);
	  	}else{
	  		throw new RuntimeException(SystemEnv.getHtmlLabelName(82142,user.getLanguage()));//\u672a\u77e5\u7684\u8868\u5355\u7c7b\u578b
	  	}
	  	
	  	LabelComInfo labelComInfo = new LabelComInfo();
		labelComInfo.addLabeInfoCache(String.valueOf(namelabelid));//\u5f80\u7f13\u5b58\u4e2d\u6dfb\u52a0\u8868\u5355\u540d\u79f0\u7684\u6807\u7b7e
		
		BillComInfo billComInfo = new BillComInfo();
		billComInfo.addBillCache(String.valueOf(formid));
		
		//\u6dfb\u52a0\u865a\u62df\u8868\u5355\u6570\u636e\u5230\u7f13\u5b58
		if(formtype.equals("1")){
			VirtualFormCacheManager.addVFormInCache(formid);
		}
		
		logService.log(formid, Module.FORM, LogType.ADD);
		
		out.print("<script type=\"text/javascript\">parent.parent.refreshForm("+formid+");</script>");
  	}catch(Exception ep){
  		rsTrans.rollback();
  		String errorMsg = ep.getMessage();
  		response.sendRedirect("/formmode/setup/formAdd.jsp?appId=" + appId + "&errorMsg=" + xssUtil.put(errorMsg));
  	}
}else if(action.equalsIgnoreCase("getDetailTables")){
	JSONObject result = new JSONObject();
	try{
		int formid = Util.getIntValue(Util.null2String(request.getParameter("formid")),0);
		List<Map<String, Object>> dataList = formInfoService.getAllDetailTable(formid);
		JSONArray jsonArray = JSONArray.fromObject(dataList);
		result.put("status", "1");
		result.put("data", jsonArray);
	}catch(Exception ep){
		result.put("status", "0");
	}
	response.setCharacterEncoding("UTF-8");
	out.print(result.toString());
}else if(action.equalsIgnoreCase("checktablename")){
	String checkStatus = "-1";	//-1:\u6b63\u5e38  0:\u68c0\u6d4b\u8868\u540d\u65f6\u51fa\u73b0\u672a\u77e5\u9519\u8bef   1:\u8868\u540d\u5df2\u5b58\u5728  2.\u8868\u540d\u4e0d\u5408\u6cd5
	String tablename = Util.null2String(request.getParameter("tablename"));
	
	try{
		RecordSet rs1 = new RecordSet();
		rs1.executeSql("select * from workflow_bill where lower(tablename)='"+tablename.toLowerCase()+"'");
		if(rs1.next()){
			checkStatus = "1";
			out.print(checkStatus);
			return;
		}
		FormManager formManager = new FormManager();
		boolean tableISExists = formManager.isHaveSameTableInDB(tablename);
	    if (tableISExists) {
	    	checkStatus = "1";
	    }else{	//\u68c0\u67e5\u8868\u540d\u662f\u5426\u5408\u6cd5(\u6a21\u62df\u521b\u5efa\u8868)
	    	try{
	    		boolean createTableSuccess = rs.executeSql("create table " + tablename + "(id varchar(10))");
	    		if(!createTableSuccess){
	    			checkStatus = "2";
	    		}else{
	    			try{
	    				rs.executeSql("drop table " + tablename);
	    			}catch(Exception e){}
	    		}
	    	}catch(Exception e){
	    		e.printStackTrace();
	    	}finally{
	    		
	    	}
	    }
	    //Thread.sleep(2000);
	}catch(Exception ep){
		ep.printStackTrace();
		checkStatus = "0";
	}
	out.print(checkStatus);
	return;
}else if(action.equalsIgnoreCase("getDetailTablename")){
	String maintablename = Util.null2String(request.getParameter("maintablename"));
	String detailtablename = "";
	if(maintablename.startsWith("uf_")){
		maintablename = maintablename.substring(3);
	}
	
	int detailEndIndex = Util.getIntValue(request.getParameter("detailEndIndex"), 1);
	String pageNoSaveTablenames = Util.null2String(request.getParameter("pageNoSaveTablenames")).toLowerCase();
	
	FormManager formManager = new FormManager();
	
	for(; detailEndIndex <Integer.MAX_VALUE; detailEndIndex++){
		detailtablename = maintablename + "_dt" + detailEndIndex;
		if(pageNoSaveTablenames.indexOf(detailtablename.toLowerCase() + ",") == -1){
			String testTablename = maintablename.startsWith("uf_") ? ("uf_" + detailtablename) : detailtablename;
			boolean tableISExists = formManager.isHaveSameTableInDB(testTablename);
			if(!tableISExists){
				break;
			}
		}
	}
	out.print(detailtablename);
}else if(action.equalsIgnoreCase("getfirstid")){
	int appId = Util.getIntValue(request.getParameter("appid"), 0);
	int subCompanyId = Util.getIntValue(request.getParameter("subCompanyId"), 0);
	JSONArray forminfoArr = new JSONArray();
	if(fmdetachable.equals("1")){
		forminfoArr = formInfoService.getFormInfoByAppIdWithJSONDetach(appId,subCompanyId);
	}else{
		forminfoArr = formInfoService.getFormInfoByAppIdWithJSON(appId);
	}
	String firstId = "";
	if(forminfoArr.size()>0){
		JSONObject jsonObject = forminfoArr.getJSONObject(0);
		firstId = jsonObject.getString("id");
	}
	JSONObject jsonObject = new JSONObject();
	jsonObject.put("id",firstId);
	out.print(jsonObject.toString());
}
out.flush();
out.close();

    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("formmode/setup/formSettingsAction.jsp"), 6050042756398436228L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
    depend = new com.caucho.vfs.Depend(appDir.lookup("formmode/pub_init.jsp"), -4246916824298514572L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
    depend = new com.caucho.vfs.Depend(appDir.lookup("formmode/pub_function.jsp"), 5446055981984630656L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string3;
  private final static char []_jsp_string2;
  private final static char []_jsp_string1;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string3 = "\r\n\r\n\r\n".toCharArray();
    _jsp_string2 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
  }
}
