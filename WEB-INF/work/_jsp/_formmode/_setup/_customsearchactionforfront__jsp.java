/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._formmode._setup;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.general.Util;
import weaver.hrm.HrmUserVarify;
import weaver.hrm.User;
import weaver.conn.RecordSet;
import weaver.common.util.taglib.ShowColUtil;
import java.util.*;
import java.util.Map.Entry;
import weaver.formmode.search.editplugin.AbstractPluginElement;
import weaver.formmode.search.editplugin.PluginElementClassName;
import weaver.formmode.service.CustomSearchService;
import weaver.formmode.search.CustomSearchBatchEditUtil;
import java.util.Iterator;
import net.sf.json.JSONArray;
import net.sf.json.JSONObject;
import weaver.formmode.setup.ModeRightInfo;

public class _customsearchactionforfront__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.formmode.search.FormModeRightInfo FormModeRightInfo;
      FormModeRightInfo = (weaver.formmode.search.FormModeRightInfo) pageContext.getAttribute("FormModeRightInfo");
      if (FormModeRightInfo == null) {
        FormModeRightInfo = new weaver.formmode.search.FormModeRightInfo();
        pageContext.setAttribute("FormModeRightInfo", FormModeRightInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      
out.clear();
User user = HrmUserVarify.getUser(request,response);
RecordSet rs =  new RecordSet();
String action = Util.null2String(request.getParameter("action"));
if("cleanColWidthByUser".equalsIgnoreCase(action)){
	String customid = Util.null2String(request.getParameter("customid"));
	boolean isRight = false;
	rs.executeSql("select * from mode_searchPageshareinfo where righttype=1 and pageid = " + customid);
	if(rs.next()){  
		FormModeRightInfo.setUser(user);
		isRight = FormModeRightInfo.checkUserRight(Util.getIntValue(customid),1);
	}else{  						//\u6ca1\u6709\u8bbe\u7f6e\u4efb\u4f55\u67e5\u770b\u6743\u9650\u6570\u636e\uff0c\u5219\u8ba4\u4e3a\u6709\u6743\u9650\u67e5\u770b
		isRight = true;
	}
	if(!isRight){
		response.sendRedirect("/notice/noright.jsp");
	 	return;
	}
	if(!"".equals(customid)){
		String pageId = "mode_customsearch:" + customid;
		String sql = "delete from user_default_col where pageid = '"+pageId+"' and userid = "+user.getUID()+"";
		rs.execute(sql);
		sql = "update system_default_col set isdefault=1 where pageid = '"+pageId+"'";//\u521d\u59cb\u5316\u5217\u5bbd\u5c06\u6240\u6709isdefault\u91cd\u7f6e\u4e3a1
        rs.execute(sql);
		ShowColUtil.reloadCache(pageId);
		ShowColUtil.removeDefaultColsMap(pageId);
	}
	JSONObject jsonObject = new JSONObject();
	jsonObject.put("status", "1");
	out.print(jsonObject.toString());
	return;
}else if("batchEdit".equalsIgnoreCase(action)){
	int customid = Util.getIntValue(Util.null2String(request.getParameter("batcheditCustomid")), 0);
	String modifiedRows = Util.null2String(request.getParameter("modifiedRows"));
	String clientaddress = request.getRemoteAddr();
	boolean isBatchEdit = false;
	rs.executeSql("select * from mode_searchPageshareinfo where righttype=2 and pageid = " + customid);
	if(rs.next()){
		FormModeRightInfo.setUser(user);
		isBatchEdit = FormModeRightInfo.checkUserRight(Util.getIntValue(String.valueOf(customid)),2);
	}
	if(!isBatchEdit){
		response.sendRedirect("/notice/noright.jsp");
	 	return;
	}
	int modeid = 0;
	int formid = 0;
	String tablename = "";
	String detailtable = "";
	String detailkeyfield = "";
	String sql = "select a.modeid,a.formid,a.detailtable,b.tablename,b.detailkeyfield from mode_customsearch a left join workflow_bill b on a.formid=b.id where a.id="+customid;
	rs.executeSql(sql);
	if(rs.next()){
		modeid = Util.getIntValue(rs.getString("modeid"), 0);
		formid = Util.getIntValue(rs.getString("formid"), 0);
		tablename = Util.null2String(rs.getString("tablename"));
		detailtable=Util.null2String(rs.getString("detailtable"));
		detailkeyfield = Util.null2String(rs.getString("detailkeyfield"));
	}
	CustomSearchService customSearchService = new CustomSearchService();
	List<Map<String,Object>> editableFields = customSearchService.getEditableFieldsById(customid);
	Map<String,Object> editableFieldMap = new HashMap<String,Object>();
	AbstractPluginElement pluginElement = null;
	for(int i=0;i<editableFields.size();i++){
		Map<String,Object> editableField = editableFields.get(i);
		int fieldId = Util.getIntValue(Util.null2String(editableField.get("id")), 0);
		String fieldhtmltype = Util.null2String(editableField.get("fieldhtmltype"));
		String fieldtype = Util.null2String(editableField.get("type"));
		String elementClassName = PluginElementClassName.getElementClassName(fieldhtmltype,fieldtype);
		pluginElement = (AbstractPluginElement)Class.forName(elementClassName).newInstance();
		String pluginName = pluginElement.getEditPluginName(fieldId);
		editableFieldMap.put(pluginName, editableField);
	}
	boolean batchEditResult = false;
	StringBuffer batchEditMessage = new StringBuffer();
	int dialogW = 300;
	int dialogH = 80;
	CustomSearchBatchEditUtil customSearchBatchEditUtil  = new CustomSearchBatchEditUtil();
	Map<String,Object> promptFieldsMap = customSearchBatchEditUtil.getPromptFields(formid);
	Map<String,Object> needLogFieldsMap = customSearchBatchEditUtil.getNeedLogFields(formid);
	Map<String,Object> modeRightRelatedFieldsMap = new HashMap<String,Object>();
	StringBuffer promptFieldsValidateFail = new StringBuffer();
	String resultStatus = "0";
	JSONObject modifiedRowsObject = JSONObject.fromObject(modifiedRows);
	JSONObject mRows = modifiedRowsObject.getJSONObject("mrows");
	Iterator rowKey = mRows.keys();
	List<String> billList = new ArrayList<String>();
	List<Integer> modeList = new ArrayList<Integer>();
	while(rowKey.hasNext()){
		String rowIndex = Util.null2String(rowKey.next());
		int rowIndexInt = Util.getIntValue(rowIndex.substring(3), 0);
		JSONObject rowObject = mRows.getJSONObject(rowIndex);
		String updateMaintableSql = "";
		String updateDetailtableSql = "";
		boolean ismodifypromptfield = false;
		boolean ismodifyneedlogfield = false;
		boolean ismodifyRelatedField = false;
		customSearchBatchEditUtil.resetPromptFields(promptFieldsMap);
		customSearchBatchEditUtil.resetNeedLogFields(needLogFieldsMap);
		String mainid = Util.null2String(rowObject.get("mainid"));
		String detailid = Util.null2String(rowObject.get("detailid"));
		JSONArray fields = rowObject.getJSONArray("fields");
		rs.executeSql("select formmodeid from " + tablename + " where id = " + mainid);
		if(!rs.next())continue;
		if(modeid==0){
			modeid = Util.getIntValue(rs.getString("formmodeid"), 0);
		}
		if(modeid==0)continue;
		Map<String,Object> rightRelatedFieldsMap = null;
		if(modeRightRelatedFieldsMap.containsKey(String.valueOf(modeid))){
			rightRelatedFieldsMap = (Map<String,Object>)modeRightRelatedFieldsMap.get(String.valueOf(modeid));
		}else{
			rightRelatedFieldsMap = customSearchBatchEditUtil.getRightRelatedFields(modeid);
			modeRightRelatedFieldsMap.put(String.valueOf(modeid), rightRelatedFieldsMap);
		}
		
		Map<String,Object> modifyRightRelatedFieldsMap = new HashMap<String,Object>();
		
		Vector mainV = new Vector();
		Vector detailV = new Vector();
		
		for(int j=0;j<fields.size();j++){
			JSONObject fieldObject = fields.getJSONObject(j);
			String pluginName = Util.null2String(fieldObject.get("pluginname"));
			if(!editableFieldMap.containsKey(pluginName)) continue;
			Map<String,Object> editableField = (Map<String,Object>)editableFieldMap.get(pluginName);
			String fieldId = Util.null2String(editableField.get("id"));
			String fieldName = Util.null2String(editableField.get("fieldname"));
			String fieldHtmlType = Util.null2String(editableField.get("fieldhtmltype"));
			String fieldType = Util.null2String(editableField.get("type"));
			String fieldDbType = Util.null2String(editableField.get("fielddbtype"));
			int viewtype = Util.getIntValue(Util.null2String(editableField.get("viewtype")), 0);
			
			String fieldValue = Util.null2String(fieldObject.get("value"));
			String oldFieldValue = Util.null2String(fieldObject.get("oval"));
			Object realFieldValue = customSearchBatchEditUtil.AnalyzeStorageValue(fieldValue, fieldHtmlType, fieldType, fieldDbType);
			boolean isEqualVal = customSearchBatchEditUtil.judgeEqualFieldValue(fieldHtmlType,fieldType,oldFieldValue, realFieldValue,fieldValue);
			if(isEqualVal) continue;
			//\u552f\u4e00\u6027\u5b57\u6bb5\u7684\u503c
			if(promptFieldsMap.containsKey(fieldId)){
				boolean isEmptyVal = false;
				if(realFieldValue==null || "".equals(realFieldValue)){
					isEmptyVal = true;
				}else if("1".equals(fieldHtmlType) && "2".equals(fieldType)){
					int nValueD = Util.getIntValue(Util.null2String(realFieldValue), 0);
					if(nValueD==0){
						isEmptyVal = true;
					}
				}else if("1".equals(fieldHtmlType)&&("3".equals(fieldType)||"5".equals(fieldType))){
					String tempRealFieldVal = Util.null2String(realFieldValue);
					if("5".equals(fieldType)){
						tempRealFieldVal = tempRealFieldVal.replaceAll(",","");
					}
					double nValueD = Util.getDoubleValue(tempRealFieldVal, 0);
					if(Double.compare(nValueD, 0)==0){
						isEmptyVal = true;
					}
				}
				if(!isEmptyVal){
					JSONObject jsonObject = (JSONObject)promptFieldsMap.get(fieldId);
	            	jsonObject.put("fieldvalue", realFieldValue);
	            	jsonObject.put("pluginName", pluginName+"_"+rowIndexInt);
	            	ismodifypromptfield = true;
				}
            }
            //\u8bb0\u5f55\u65e5\u5fd7\u5b57\u6bb5
            if(needLogFieldsMap.containsKey(fieldId)){
            	JSONObject jsonObject = (JSONObject)needLogFieldsMap.get(fieldId);
            	jsonObject.put("nfieldvalue", realFieldValue);
            	jsonObject.put("ofieldvalue", oldFieldValue);
            	ismodifyneedlogfield = true;
            }
            
            //\u5224\u65ad\u6743\u9650\u5173\u8054\u5b57\u6bb5\u503c\u662f\u5426\u6539\u53d8
            if(rightRelatedFieldsMap.containsKey(fieldId)){
            	modifyRightRelatedFieldsMap.put(fieldId, rightRelatedFieldsMap.get(fieldId));
            	ismodifyRelatedField = true;
            }
			
			if(viewtype==0){
				updateMaintableSql += ","+fieldName+"=?";
				mainV.addElement(realFieldValue);
			}else{
				if(!"".equals(detailid)){
					updateDetailtableSql += ","+fieldName+"=?";
					detailV.addElement(realFieldValue);
				}else{
					updateDetailtableSql += ","+fieldName+"";
					detailV.addElement(realFieldValue);
				}
			}
		}
		
		if(ismodifypromptfield){
			String fieldTipHtml = customSearchBatchEditUtil.judgePromptField(promptFieldsMap, modeid+"", tablename, mainid);
			if(!"".equals(fieldTipHtml)){
				for(Entry<String, Object> promptField : promptFieldsMap.entrySet()){
					JSONObject jsonObject = (JSONObject)promptField.getValue();
					if(!jsonObject.containsKey("status"))continue;
					String status = Util.null2String(jsonObject.get("status"));
					if(!"1".equals(status))continue;
					String promptFieldValidateFailName = Util.null2String(jsonObject.get("pluginName"));
					if(!"".equals(promptFieldValidateFailName)){
						if(promptFieldsValidateFail.length()>0){
							promptFieldsValidateFail.append(",");
						}
						promptFieldsValidateFail.append(promptFieldValidateFailName);
					}
				}
			
				if(batchEditMessage.length()>0){
					batchEditMessage.append("<br>");
					batchEditMessage.append("<div style=\"height:4px;\"></div>");
					dialogH += 30;
				}
				batchEditMessage.append("\u7b2c"+(rowIndexInt+1)+"\u884c\uff1a\u60a8\u5f55\u5165\u7684"+fieldTipHtml+"\u5df2\u5b58\u5728\uff0c\u8fdd\u53cd\u4e86\u552f\u4e00\u6027\u9a8c\u8bc1\uff0c\u8bf7\u91cd\u65b0\u5f55\u5165\u3002");
				resultStatus = "1";
				continue;
			}
		}
		
		if(mainV.size()>0){
			updateMaintableSql = updateMaintableSql.substring(1);
			updateMaintableSql = "update " + tablename + " set " + updateMaintableSql + " where id = " + mainid;
			boolean uResult = rs.executeSql(updateMaintableSql,false,mainV);
			if(uResult && ismodifyneedlogfield){
				customSearchBatchEditUtil.saveLogFieldsModifyInfo(Util.getIntValue(mainid,0), modeid, user, clientaddress, "5", needLogFieldsMap);
			}
		}
		if(detailV.size()>0){
			if(!"".equals(detailid)){
				updateDetailtableSql = updateDetailtableSql.substring(1);
				updateDetailtableSql = "update " + detailtable + " set " + updateDetailtableSql + " where id = " + detailid;
				rs.executeSql(updateDetailtableSql,false,detailV);
			}else{
				updateDetailtableSql = "insert into " + detailtable + " (mainid" + updateDetailtableSql + ") values (" + mainid;
				for(int k=0;k<detailV.size();k++){
					updateDetailtableSql += ",?";
				}
				updateDetailtableSql += ")";
				rs.executeSql(updateDetailtableSql,false,detailV);
			}
		}

		if(!billList.contains(mainid)){
			billList.add(mainid);
			modeList.add(modeid);
		}
	}

	for(int i=0;i<billList.size();i++){
		String bid = billList.get(i);
		int mid = modeList.get(i);
		ModeRightInfo ModeRightInfo = new ModeRightInfo();
		ModeRightInfo.rebuildModeDataShareByEdit(-1,mid,Util.getIntValue(bid,0));
		//\u6279\u91cf\u4fee\u6539\u7684\u91cd\u6784\u6743\u9650
		ModeRightInfo.addDocShare(-1,mid,Util.getIntValue(bid,0));
	}

	if(batchEditMessage.length()==0){
		batchEditMessage.append("\u66f4\u65b0\u6210\u529f\uff0c\u662f\u5426\u7ee7\u7eed\u4fee\u6539\uff1f");
	}
	JSONObject resultJson = new JSONObject();
	resultJson.put("resultStatus", resultStatus);
	resultJson.put("resultMessage", batchEditMessage.toString());
	resultJson.put("promptFieldsValidateFail", promptFieldsValidateFail.toString());
	out.print("<script>parent.customSearchOperate.batchEditCallbak("+resultJson+","+dialogW+","+dialogH+")</script>");
}

    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("formmode/setup/customSearchActionForFront.jsp"), -4824443228910350930L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string1;
  private final static char []_jsp_string0;
  static {
    _jsp_string1 = "\r\n".toCharArray();
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
  }
}
