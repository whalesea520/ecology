/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._base._ffield;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.general.BaseBean;
import java.util.Map;
import java.util.HashMap;
import java.util.ArrayList;
import weaver.hrm.User;
import weaver.hrm.HrmUserVarify;
import weaver.conn.RecordSet;

public class _crm_0freefieldoperation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.conn.RecordSet RecordSet;
      RecordSet = (weaver.conn.RecordSet) pageContext.getAttribute("RecordSet");
      if (RecordSet == null) {
        RecordSet = new weaver.conn.RecordSet();
        pageContext.setAttribute("RecordSet", RecordSet);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSetTrans RecordSetTrans;
      RecordSetTrans = (weaver.conn.RecordSetTrans) pageContext.getAttribute("RecordSetTrans");
      if (RecordSetTrans == null) {
        RecordSetTrans = new weaver.conn.RecordSetTrans();
        pageContext.setAttribute("RecordSetTrans", RecordSetTrans);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.general.Util Util;
      Util = (weaver.general.Util) pageContext.getAttribute("Util");
      if (Util == null) {
        Util = new weaver.general.Util();
        pageContext.setAttribute("Util", Util);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.crm.Maint.CRMFreeFieldManage CRMFreeFieldManage;
      CRMFreeFieldManage = (weaver.crm.Maint.CRMFreeFieldManage) pageContext.getAttribute("CRMFreeFieldManage");
      if (CRMFreeFieldManage == null) {
        CRMFreeFieldManage = new weaver.crm.Maint.CRMFreeFieldManage();
        pageContext.setAttribute("CRMFreeFieldManage", CRMFreeFieldManage);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.field.BrowserComInfo BrowserComInfo;
      BrowserComInfo = (weaver.workflow.field.BrowserComInfo) pageContext.getAttribute("BrowserComInfo");
      if (BrowserComInfo == null) {
        BrowserComInfo = new weaver.workflow.field.BrowserComInfo();
        pageContext.setAttribute("BrowserComInfo", BrowserComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.systeminfo.label.LabelComInfo LabelComInfo;
      LabelComInfo = (weaver.systeminfo.label.LabelComInfo) pageContext.getAttribute("LabelComInfo");
      if (LabelComInfo == null) {
        LabelComInfo = new weaver.systeminfo.label.LabelComInfo();
        pageContext.setAttribute("LabelComInfo", LabelComInfo);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.crm.util.CrmFieldComInfo CrmFieldComInfo;
      CrmFieldComInfo = (weaver.crm.util.CrmFieldComInfo) pageContext.getAttribute("CrmFieldComInfo");
      if (CrmFieldComInfo == null) {
        CrmFieldComInfo = new weaver.crm.util.CrmFieldComInfo();
        pageContext.setAttribute("CrmFieldComInfo", CrmFieldComInfo);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.crm.ExcelToDB.CrmExcelToDB CrmExcelToDB;
      CrmExcelToDB = (weaver.crm.ExcelToDB.CrmExcelToDB) pageContext.getAttribute("CrmExcelToDB");
      if (CrmExcelToDB == null) {
        CrmExcelToDB = new weaver.crm.ExcelToDB.CrmExcelToDB();
        pageContext.setAttribute("CrmExcelToDB", CrmExcelToDB);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      
	String usetable = Util.null2String(request.getParameter("usetable"));
	boolean isoracle = (RecordSet.getDBType()).equals("oracle") ;
	boolean isdb2 = (RecordSet.getDBType()).equals("db2") ;
	boolean issqlserver = (RecordSet.getDBType()).equals("sqlserver") ;
	String method = Util.null2String(request.getParameter("method"));
	int message = 1;
	
	User user = HrmUserVarify.getUser (request , response) ;
	boolean canedit = false;
	if(usetable.equals("CRM_CustomerInfo")){
		canedit = HrmUserVarify.checkUserRight("CustomerAccountFreeFeildEdit:Edit", user);
	}else if(usetable.equals("CRM_CustomerContacter")){
		canedit = HrmUserVarify.checkUserRight("CustomerContactorFreeFeildEdit:Edit", user);
	}else if(usetable.equals("CRM_CustomerAddress")){
		canedit = HrmUserVarify.checkUserRight("CustomerAddressFreeFeildEdit:Edit", user);
	}else if(usetable.equals("CRM_SellChance")){
		canedit = HrmUserVarify.checkUserRight("CustomerAddressFreeFeildEdit:Edit", user);
	}
	if(!canedit){
		response.sendRedirect("/notice/noright.jsp") ;
	}
	
	if(method.equals("savefieldbatch")){
		Map map =new HashMap();
		map.put("CRM_CustomerInfo",5);
		map.put("CRM_CustomerContacter",5);
		map.put("CRM_CustomerAddress",5);
		RecordSetTrans.setAutoCommit(false);
		
		try{
			String maintablename = usetable;
			int recordNum = Util.getIntValue(Util.null2String(request.getParameter("recordNum")),0);//\u5b57\u6bb5\u884c\u6570
		  	String delids = Util.null2String(request.getParameter("delids"));//\u5220\u9664\u884cid\u96c6
		  	String changeRowIndexs = Util.null2String(request.getParameter("changeRowIndexs"));//\u6709\u6539\u53d8\u7684\u884cid\u96c6
		  	String labelidsCache = ",";//\u66f4\u65b0\u7f13\u5b58\u7528
		  	
		  	ArrayList delidsArray = Util.TokenizerString(delids,",");
		  	for(int i=0;i<delidsArray.size();i++){//\u5220\u9664\u6307\u5b9a\u7684\u5b57\u6bb5
		  		
		  		String fieldnameForDel = "";
		  		String delFieldId = (String)delidsArray.get(i);
		  		
		  		RecordSetTrans.executeSql("select fieldname from CRM_CustomerDefinField where id="+delFieldId);
		  		if(RecordSetTrans.next()) {
		  		   fieldnameForDel = RecordSetTrans.getString("fieldname");//\u53d6\u5f97\u5b57\u6bb5\u540d
		  		}
		  		
		  		if(isoracle){
		  		   String sql1="select * from ALL_TAB_COLS A  where lower(A.Table_Name) = lower('"+maintablename+"')  and lower(A.COLUMN_NAME)=lower('"+fieldnameForDel+"')";
		  		   RecordSetTrans.executeSql(sql1);
		  		   if(RecordSetTrans.next()) {
		  		     RecordSetTrans.executeSql("alter table "+maintablename+" drop column "+fieldnameForDel);//\u4fee\u6539\u8868\u7ed3\u6784
		  		   } 
		  		}else{
		  		     RecordSetTrans.executeSql("alter table "+maintablename+" drop column "+fieldnameForDel);//\u4fee\u6539\u8868\u7ed3\u6784
		  		}
		  		//\u6e05\u9664\u663e\u793a\u5b9a\u5236\u5217\u4e2d\u7684\u6570\u636e\uff0c\u6e05\u9664system_default_col\u548cuser_default_col\u4e2d\u7684\u663e\u793a\u5217
				if("CRM_CustomerInfo".equals(usetable)){
					RecordSet.executeSql("select id from system_default_col where pageid='CRM:CustomerListInfo' and name='"+fieldnameForDel+"'");
					String id = "";
					while(RecordSet.next()){
						if("".equals(id))
							id+=RecordSet.getString("id");
						else
							id+=","+RecordSet.getString("id");
					}
					RecordSet.executeSql("delete from user_default_col where pageid='CRM:CustomerListInfo' and systemid in("+id+")");
					RecordSet.executeSql("delete from system_default_col where pageid='CRM:CustomerListInfo' and name='"+fieldnameForDel+"'");
				}
		  		
		  		RecordSetTrans.executeSql("delete from CRM_CustomerDefinField where id="+delFieldId);//\u5220\u9664\u5b57\u6bb5
		  		RecordSetTrans.executeSql("delete from crm_selectitem where fieldid = "+delFieldId);//\u5220\u9664\u53ef\u80fd\u5b58\u5728\u7684\u4e0b\u62c9\u6846\u503c
		  	}

		  	ArrayList changeRowIndexsArray = Util.TokenizerString(changeRowIndexs,",");
		  	//System.err.println("changeRowIndexsArray=="+changeRowIndexs);
		  	for(int i=0;i<changeRowIndexsArray.size();i++){//\u4fee\u6539\u6709\u6539\u53d8\u7684\u884c(\u5305\u62ec\u65b0\u589e\u884c\u548c\u7f16\u8f91\u884c)
		  		String index = (String)changeRowIndexsArray.get(i);
		  		String new_OR_modify = Util.null2String(request.getParameter("modifyflag_"+index));//\u5373\u6570\u636e\u5e93CRM_CustomerDefinField\u7684id\u503c
		  		String fieldname = Util.null2String(request.getParameter("itemDspName_"+index));//\u6570\u636e\u5e93\u5b57\u6bb5\u540d\u79f0
	  			if(fieldname.equals("")) continue;//\u5148\u6dfb\u52a0\u540e\u5220\u9664\u7684
	  			
	            /*************\u5904\u7406\u6807\u7b7e\u5f00\u59cb********************/
	            int fieldlabel = 0;//\u5b57\u6bb5\u663e\u793a\u540d\u6807\u7b7eid
	  			String fieldlabelname = Util.null2String(request.getParameter("itemFieldName_"+index));
	  			fieldlabelname = Util.StringReplace(fieldlabelname, "\"", "");//TD10108 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u53cc\u5f15\u53f7\u201c"\u201d
	  			if(issqlserver) RecordSetTrans.executeSql("select indexid from HtmlLabelInfo where labelname='"+fieldlabelname+"' collate Chinese_PRC_CS_AI and languageid="+Util.getIntValue(""+user.getLanguage(),7));
			  	else RecordSetTrans.executeSql("select indexid from HtmlLabelInfo where labelname='"+fieldlabelname+"' and languageid="+Util.getIntValue(""+user.getLanguage(),7));
			  	if(RecordSetTrans.next()) fieldlabel = RecordSetTrans.getInt("indexid");//\u5982\u679c\u5b57\u6bb5\u540d\u79f0\u5728\u6807\u7b7e\u5e93\u4e2d\u5b58\u5728\uff0c\u53d6\u5f97\u6807\u7b7eid
			  	else{
			  		fieldlabel = CRMFreeFieldManage.getNewIndexId(RecordSetTrans);//\u751f\u6210\u65b0\u7684\u6807\u7b7eid
				  	if(fieldlabel!=-1){//\u66f4\u65b0\u6807\u7b7e\u5e93
				  		labelidsCache+=fieldlabel+",";
				  		RecordSetTrans.executeSql("delete from HtmlLabelIndex where id="+fieldlabel);
				  		RecordSetTrans.executeSql("delete from HtmlLabelInfo where indexid="+fieldlabel);
				  		RecordSetTrans.executeSql("INSERT INTO HtmlLabelIndex values("+fieldlabel+",'"+fieldlabelname+"')");
				  		RecordSetTrans.executeSql("INSERT INTO HtmlLabelInfo values("+fieldlabel+",'"+fieldlabelname+"',7)");
				  		RecordSetTrans.executeSql("INSERT INTO HtmlLabelInfo values("+fieldlabel+",'"+fieldlabelname+"',8)");
				  		RecordSetTrans.executeSql("INSERT INTO HtmlLabelInfo values("+fieldlabel+",'"+fieldlabelname+"',9)");
				  	}
				}
			  	/*************\u5904\u7406\u6807\u7b7e\u7ed3\u675f********************/
			  	
			  	
			  	String fielddbtype = "";//\u5b57\u6bb5\u6570\u636e\u5e93\u7c7b\u578b
	  			String _fielddbtype = "";//\u5b57\u6bb5\u6570\u636e\u5e93\u7c7b\u578b
	  			String fieldhtmltype = Util.null2String(request.getParameter("itemFieldType_"+index));//\u5b57\u6bb5\u9875\u9762\u7c7b\u578b
	  			String type = "";//\u5b57\u6bb5\u8be6\u7ec6\u7c7b\u578b \u3010\u5b50\u7c7b\u578b\u3011
	  			String viewtype = "0";//viewtype="0"\u8868\u793a\u4e3b\u8868\u5b57\u6bb5,viewtype="1"\u8868\u793a\u660e\u7ec6\u8868\u5b57\u6bb5
	  			//String usetable = "";//\u88ab\u4f7f\u7528\u8868\u540d
	  			int textheight = 0;//\u591a\u884c\u6587\u672c\u6846\u7684\u9ad8\u5ea6
	  			
	  			int  places=0;
	  			
	  			int imgwidth = Util.getIntValue(request.getParameter("imgwidth_"+index),0);//\u4e0a\u4f20\u56fe\u7247\u7684\u5bbd\u5ea6
	            int imgheight = Util.getIntValue(request.getParameter("imgheight_"+index),0);//\u4e0a\u4f20\u56fe\u7247\u7684\u9ad8\u5ea6
	            String dmlUrl = "";
	
				if(fieldhtmltype.equals("1")){
					
				  	type = Util.null2String(request.getParameter("documentType_"+index));	
				  	if(type.equals("1")){
					  	String strlength = Util.null2String(request.getParameter("itemFieldScale1_"+index));
					  	if(Util.getIntValue(strlength,1)<=1) strlength = "1";
				    	if(isoracle) fielddbtype="varchar2("+strlength+")";
				    	else fielddbtype="varchar("+strlength+")";
				    	
				    	/**************************************************************
				    	if(!new_OR_modify.equals("")){
				    		
				    	    String oldfielddbtype = "";
				    	    RecordSetTrans.executeSql("select fielddbtype from CRM_CustomerDefinField where id="+new_OR_modify);
				    	    if(RecordSetTrans.next()) oldfielddbtype = RecordSetTrans.getString("fielddbtype");
				    	    if(!fielddbtype.equals(oldfielddbtype)){
				    	        if(isoracle) RecordSetTrans.executeSql("ALTER TABLE "+maintablename+" MODIFY "+fieldname+" "+fielddbtype);
				    	        else RecordSetTrans.executeSql("ALTER TABLE "+maintablename+" ALTER COLUMN "+fieldname+" "+fielddbtype);
				    	    }
				    	}
				    	**************************************************************/
					}
				  	if(type.equals("2")){
				   		if(isoracle) fielddbtype="integer";
				   		else fielddbtype="int";
				   	}
					if(type.equals("3")){
						int decimaldigits = Util.getIntValue(request.getParameter("decimaldigits_"+index),2);
						if(isoracle) fielddbtype="number(15,"+decimaldigits+")";
					   	else fielddbtype="decimal(15,"+decimaldigits+")";
						
						/**************************************************************
				   		if(!new_OR_modify.equals("")){
							//\u5bf9\u6d6e\u70b9\u578b\u5b57\u6bb5\u7684\u5c0f\u6570\u70b9\u500d\u6570\u8fdb\u884c\u4fee\u6539\u65f6\u5019\uff0c\u9700\u8981\u540c\u65f6\u4fee\u6539\u8868\u5355\u6570\u636e\u5b58\u50a8\u8868\u4e2d\u7684\u5b57\u6bb5\u5b57\u4e49
							String oldfielddbtype = "";
							RecordSetTrans.executeSql("select fielddbtype from CRM_CustomerDefinField where id="+new_OR_modify);
							if(RecordSetTrans.next()) oldfielddbtype = RecordSetTrans.getString("fielddbtype");
							if(!fielddbtype.equals(oldfielddbtype)){
								if(isoracle) RecordSetTrans.executeSql("ALTER TABLE "+maintablename+" MODIFY "+fieldname+" "+fielddbtype);
								else RecordSetTrans.executeSql("ALTER TABLE "+maintablename+" ALTER COLUMN "+fieldname+" "+fielddbtype);
							
							}
				   		}
						**************************************************************/
			 	 	}
					if(type.equals("4")){
				   		if(isoracle) fielddbtype="number(15,2)";
				   		else fielddbtype="decimal(15,2)";
						}
				   	if(type.equals("5")){
				   		int decimaldigits = Util.getIntValue(request.getParameter("decimaldigits_"+index),2);
				   		if(isoracle) fielddbtype="varchar2(30)";
				   		else fielddbtype="varchar(30)";
				   		places=decimaldigits;
					}
				   	
				}
				
				if(fieldhtmltype.equals("2")){
					type = "1";
					if(isoracle) fielddbtype="varchar2(4000)";
					else if(isdb2) fielddbtype="varchar(2000)";
					else fielddbtype="text";
					textheight = Util.getIntValue(Util.null2String(request.getParameter("textheight_"+index)),4);
				}
				
				if(fieldhtmltype.equals("3")){
				  	int temptype = Util.getIntValue(Util.null2String(request.getParameter("broswerType_"+index)),0);
				  	type = ""+temptype;
				  	if(temptype>0)
				  		fielddbtype=BrowserComInfo.getBrowserdbtype(type+"");
				  	if(temptype==118){
				  		if(isoracle) fielddbtype="varchar2(200)";
						else fielddbtype="varchar(200)";
				  	}
					if(temptype==161||temptype==162){
						dmlUrl=Util.null2String(request.getParameter("custombrow_"+index));
						if(temptype==161){
							if(isoracle) _fielddbtype="varchar2(1000)";
							else if(isdb2) _fielddbtype="varchar(1000)";
							else _fielddbtype="varchar(1000)";
						}else{
							if(isoracle) _fielddbtype="varchar2(4000)";
							else if(isdb2) _fielddbtype="varchar(2000)";
							else _fielddbtype="text";
						}
						fielddbtype = _fielddbtype;
					}
					if(temptype==224||temptype==225){
						fielddbtype=Util.null2String(request.getParameter("sapbrowser_"+index));
						if(temptype==224){
							if(isoracle) _fielddbtype="varchar2(1000)";
							else if(isdb2) _fielddbtype="varchar(1000)";
							else _fielddbtype="varchar(1000)";
						}else{
							if(isoracle) _fielddbtype="varchar2(4000)";
							else if(isdb2) _fielddbtype="varchar(2000)";
							else _fielddbtype="text";
						}
					}
					
					if(temptype==226||temptype==227){
						fielddbtype=Util.null2String(request.getParameter("showvalue_"+index));
						if(temptype==226){
							if(isoracle) _fielddbtype="varchar2(1000)";
							else if(isdb2) _fielddbtype="varchar(1000)";
							else _fielddbtype="varchar(1000)";
						}else{
							if(isoracle) _fielddbtype="varchar2(4000)";
							else if(isdb2) _fielddbtype="varchar(2000)";
							else _fielddbtype="text";
						}
					}
					if(temptype==165||temptype==166||temptype==167||temptype==168) 
					  	textheight=Util.getIntValue(Util.null2String(request.getParameter("decentralizationbroswerType_"+index)),0); 
				}
				if(fieldhtmltype.equals("4")){
				  	type = "1";
				  	fielddbtype="char(1)";
				}
				if(fieldhtmltype.equals("5"))	{
				  	type = "1";
				  	if(isoracle) fielddbtype="integer";
				  	else fielddbtype="int";
				}
				if(fieldhtmltype.equals("6"))	{
				  	//type = "" + Util.getIntValue(Util.null2String(request.getParameter("uploadtype_"+index)), 1);
				  	type = "1";
				    if(isoracle) fielddbtype="varchar2(4000)";
					else if(isdb2) fielddbtype="varchar(2000)";
				    else fielddbtype="varchar(2000)";
	                textheight = Util.getIntValue(Util.null2String(request.getParameter("strlength_"+index)), 0);  
				}
				  if(fieldhtmltype.equals("7"))	{
				  	type = Util.null2String(request.getParameter("specialfield_"+index));
				    if(isoracle) fielddbtype="varchar2(4000)";
					else if(isdb2) fielddbtype="varchar(2000)";
				    else fielddbtype="varchar(2000)";
				}	
			
	  			String groupid = Util.null2String(request.getParameter("groupid_"+index));
	  			String isopen = Util.null2String(request.getParameter("isopen_"+index));//\u662f\u5426\u542f\u7528 0-\u4e0d\u542f\u7528(\u9ed8\u8ba4) 1-\u542f\u7528
	  			String ismust = Util.null2String(request.getParameter("ismust_"+index));//\u662f\u5426\u5fc5\u586b 0-\u4e0d\u5fc5\u586b(\u9ed8\u8ba4) 1-\u5fc5\u586b
	  			String issearch = Util.null2String(request.getParameter("issearch_"+index));//\u662f\u5426\u4e3a\u641c\u7d22\u6761\u4ef6 0--\u4e0d\u4f5c\u4e3a 1--\u4f5c\u4e3a
	  			String isdisplay = Util.null2String(request.getParameter("isdisplay_"+index));//\u662f\u5426\u4e3a\u5ba2\u6237\u5217\u8868\u663e\u793a\u5b57\u6bb5 0--\u4e0d\u4f5c\u4e3a 1--\u4f5c\u4e3a
	  			String isexport = Util.null2String(request.getParameter("isexport_"+index));//\u662f\u5426\u4e3a\u5ba2\u6237\u5bfc\u51fa\u5b57\u6bb5 0--\u4e0d\u4f5c\u4e3a 1--\u4f5c\u4e3a
                String isfixed = Util.null2String(request.getParameter("isfixed_"+index));//\u662f\u5426\u4e3a\u6570\u636e\u5e93\u5df2\u5b58\u5728\u5b57\u6bb5
                if("id".equals(fieldname)&& "1".equals(isfixed)) throw new Exception();
	  			//if(dsporder.equals("")) dsporder="0";
				if(!new_OR_modify.equals("")){//\u4e0d\u4e3a\u7a7a\u8868\u793a\u662f\u7f16\u8f91\u5b57\u6bb5\uff0c\u4e3a\u7a7a\u8868\u793a\u65b0\u6dfb\u52a0\u5b57\u6bb5\u3002
				  	String oldfieldname = "";
				  	String oldfielddbtype = "";
				  	RecordSetTrans.executeSql("select fieldname,fielddbtype from CRM_CustomerDefinField where id="+new_OR_modify);
				  	if(RecordSetTrans.next()){
				  	    oldfieldname = RecordSetTrans.getString("fieldname");
				  	    oldfielddbtype = RecordSetTrans.getString("fielddbtype");
				  	}
					String dmlurlstr = "";
					if(dmlUrl != null && !"".equals(dmlUrl))  dmlurlstr = "dmlUrl='"+dmlUrl+"',";
					//\u5982\u679cisdisplay=0\uff0c\u5219\u6e05\u9664system_default_col\u548cuser_default_col\u4e2d\u7684\u663e\u793a\u5217
					if("CRM_CustomerInfo".equals(usetable)&&!"1".equals(isdisplay)){
						RecordSet.executeSql("select id from system_default_col where pageid='CRM:CustomerListInfo' and name='"+fieldname+"'");
						String id = "";
						while(RecordSet.next()){
							if("".equals(id))
								id+=RecordSet.getString("id");
							else
								id+=","+RecordSet.getString("id");
						}
						RecordSet.executeSql("delete from user_default_col where pageid='CRM:CustomerListInfo' and systemid in("+id+")");
						RecordSet.executeSql("delete from system_default_col where pageid='CRM:CustomerListInfo' and name='"+fieldname+"'");
						
					}
					
					RecordSetTrans.executeSql("update CRM_CustomerDefinField set "+dmlurlstr+" fieldname='"+fieldname+"',fieldlabel="+fieldlabel+",fielddbtype='"+fielddbtype+"',fieldhtmltype="+fieldhtmltype+",type="+type+",viewtype="+viewtype+",usetable='"+usetable+"',textheight="+textheight+",imgwidth="+imgwidth+",imgheight="+imgheight+",isopen='"+isopen+"',ismust='"+ismust+"',issearch='"+issearch+"',isdisplay='"+isdisplay+"',isexport='"+isexport+"',places='"+places+"' , groupid = '"+groupid+"' where id="+new_OR_modify);
				  	//\u66f4\u6539\u5217\u540d
				  	if(!oldfieldname.equals(fieldname)){
				  		if(isoracle) RecordSetTrans.execute("alter table "+usetable+" rename colun "+oldfieldname+" to "+fieldname);
				  		else if(issqlserver) RecordSetTrans.execute("exec sp_rename '"+usetable+"."+oldfieldname+"' , '"+fieldname+"' , 'column'");
				  		
				  	}
				  	
				  	
				  	/**************************************************************
				  	if(!fieldname.equals(oldfieldname)||(!fielddbtype.equals(oldfielddbtype) && !"1".equals(fieldhtmltype) && !"".equals(type))){//\u4fee\u6539\u4e86\u6570\u636e\u5e93\u5b57\u6bb5\u540d\u79f0\u6216\u7c7b\u578b
				  		RecordSetTrans.executeSql("select "+oldfieldname+" from "+maintablename + " where " + oldfieldname + " is not NULL");
				  		if(!RecordSetTrans.next()){
				  			RecordSetTrans.executeSql("alter table "+maintablename+" drop column "+oldfieldname);
				  	    	if(fieldhtmltype.equals("3")&&(type.equals("161")||type.equals("162"))){
				  	        RecordSetTrans.executeSql("alter table "+maintablename+" add "+fieldname+" "+_fielddbtype);
					  	    }else if(fieldhtmltype.equals("3")&&(type.equals("224")||type.equals("225"))){
					  	        RecordSetTrans.executeSql("alter table "+maintablename+" add "+fieldname+" "+_fielddbtype);
					  	    }else if(fieldhtmltype.equals("3")&&(type.equals("226")||type.equals("227"))){
					  	        RecordSetTrans.executeSql("alter table "+maintablename+" add "+fieldname+" "+_fielddbtype);
					  	    }
					  	    else{
					  	        RecordSetTrans.executeSql("alter table "+maintablename+" add "+fieldname+" "+fielddbtype);
					  	    }
				  		}
				  	}
				  	
				  	**************************************************************/
				}else{
					//\u63d2\u5165\u5b57\u6bb5\u4fe1\u606f
					//System.err.println("INSERT INTO CRM_CustomerDefinField(fieldname,fieldlabel,fielddbtype,fieldhtmltype,type,dsporder,viewtype,usetable,textheight,imgwidth,imgheight,isopen,ismust,places,candel,groupid) "+
					//		  " VALUES ('"+fieldname+"',"+fieldlabel+",'"+fielddbtype+"',"+fieldhtmltype+","+type+","+index+","+viewtype+",'"+usetable+"',"+textheight+","+imgwidth+","+imgheight+",'"+isopen+"','"+ismust+"','"+places+"','y',"+groupid+")");
                    if("1".equals(isfixed))
					RecordSetTrans.executeSql("INSERT INTO CRM_CustomerDefinField(dmlUrl,fieldname,fieldlabel,fielddbtype,fieldhtmltype,type,dsporder,viewtype,usetable,textheight,imgwidth,imgheight,isopen,ismust,issearch,isdisplay,isexport,places,candel,groupid) "+
					  " VALUES ('"+dmlUrl+"','"+fieldname+"',"+fieldlabel+",'"+fielddbtype+"',"+fieldhtmltype+","+type+","+index+","+viewtype+",'"+usetable+"',"+textheight+","+imgwidth+","+imgheight+",'"+isopen+"','"+ismust+"','"+issearch+"','"+isdisplay+"','"+isexport+"','"+places+"','n',"+groupid+")");
                    else
					RecordSetTrans.executeSql("INSERT INTO CRM_CustomerDefinField(dmlUrl,fieldname,fieldlabel,fielddbtype,fieldhtmltype,type,dsporder,viewtype,usetable,textheight,imgwidth,imgheight,isopen,ismust,issearch,isdisplay,isexport,places,candel,groupid) "+
					  " VALUES ('"+dmlUrl+"','"+fieldname+"',"+fieldlabel+",'"+fielddbtype+"',"+fieldhtmltype+","+type+","+index+","+viewtype+",'"+usetable+"',"+textheight+","+imgwidth+","+imgheight+",'"+isopen+"','"+ismust+"','"+issearch+"','"+isdisplay+"','"+isexport+"','"+places+"','y',"+groupid+")");

				}
				if(new_OR_modify.equals("")){//\u65b0\u6dfb\u52a0\u5b57\u6bb5
                    String actualType = "";
                    String actualLength = "";
                    String checkType = "";
                    String checkLength = "";
				    if("1".equals(isfixed)){
                        if(isoracle) {
                            RecordSetTrans.executeSql("SELECT DATA_TYPE as type,DATA_LENGTH as length FROM USER_TAB_COLUMNS WHERE TABLE_NAME = UPPER('"+maintablename+"') and COLUMN_NAME =UPPER('"+fieldname+"')");
                        }
                        else {
                            RecordSetTrans.executeSql("SELECT systy.name as type,syscol.length as length FROM SysColumns syscol left JOIN systypes systy on syscol.xtype =systy.xtype  WHERE syscol.id=Object_Id('"+maintablename+"') and syscol.name='"+fieldname+"'");
                        }
                        if(RecordSetTrans.next()){
                            actualType = Util.null2String(RecordSetTrans.getString("type")).toLowerCase();
                            actualLength = RecordSetTrans.getString("length");
                        }else{
                            message=-2;
                            throw new Exception();
                        }
                        if(fieldhtmltype.equals("3")&&(type.equals("161")||type.equals("162"))){
                            checkType = (_fielddbtype.indexOf("(")>0)?(_fielddbtype.substring(0, _fielddbtype.indexOf("("))):_fielddbtype;
                            checkLength = (_fielddbtype.indexOf("(")>0)?(_fielddbtype.substring( _fielddbtype.indexOf("(")+1,_fielddbtype.indexOf(")"))):"";
                        }else if(fieldhtmltype.equals("3")&&(type.equals("224")||type.equals("225"))){
                            checkType = (_fielddbtype.indexOf("(")>0)?(_fielddbtype.substring(0, _fielddbtype.indexOf("("))):_fielddbtype;
                            checkLength = (_fielddbtype.indexOf("(")>0)?(_fielddbtype.substring( _fielddbtype.indexOf("(")+1,_fielddbtype.indexOf(")"))):"";
                        }else if(fieldhtmltype.equals("3")&&(type.equals("226")||type.equals("227"))){
                            checkType = (_fielddbtype.indexOf("(")>0)?(_fielddbtype.substring(0, _fielddbtype.indexOf("("))):_fielddbtype;
                            checkLength = (_fielddbtype.indexOf("(")>0)?(_fielddbtype.substring( _fielddbtype.indexOf("(")+1,_fielddbtype.indexOf(")"))):"";
                        }
                        else{
                            checkType = (fielddbtype.indexOf("(")>0)?(fielddbtype.substring(0, fielddbtype.indexOf("("))):fielddbtype;
                            checkLength = (fielddbtype.indexOf("(")>0)?(fielddbtype.substring( fielddbtype.indexOf("(")+1,fielddbtype.indexOf(")"))):"";
                        }
                        if(!actualType.equals(checkType)
				&& actualType.indexOf("varchar")<0 
				&& !"clob".equals(actualType) 
				&& !"text".equals(actualType) 
				&& !( "number".equals(actualType) && "integer".equals(checkType)) ){
                                message=-3;
                                throw new Exception();
                            }
                        else if(checkType.indexOf("char")>=0 && !actualLength.equals(checkLength)){
                            RecordSetTrans.executeSql("update CRM_CustomerDefinField set fielddbtype ='"+checkType+"("+actualLength+")"+"' where id=(select max(id) as id from CRM_CustomerDefinField)");
                        }
				    }
				    else{
						//\u66f4\u65b0\u4e3b\u8868\u7ed3\u6784
						if(fieldhtmltype.equals("3")&&(type.equals("161")||type.equals("162"))){
							RecordSetTrans.executeSql("alter table "+maintablename+" add "+fieldname+" "+_fielddbtype);
						}else if(fieldhtmltype.equals("3")&&(type.equals("224")||type.equals("225"))){
							RecordSetTrans.executeSql("alter table "+maintablename+" add "+fieldname+" "+_fielddbtype);
						}else if(fieldhtmltype.equals("3")&&(type.equals("226")||type.equals("227"))){
							RecordSetTrans.executeSql("alter table "+maintablename+" add "+fieldname+" "+_fielddbtype);
						}
						else{
							RecordSetTrans.executeSql("alter table "+maintablename+" add "+fieldname+" "+fielddbtype);
						}
				    }
				}
				//\u8bbe\u7f6e\u4e0b\u62c9\u6846\u9009\u9879\u503c
				if(fieldhtmltype.equals("5")){
					String info = Util.null2String(request.getParameter("selectOption_"+index+"_value"));
					
					if(!info.equals("")){
						RecordSetTrans.executeSql("select id from CRM_CustomerDefinField where usetable = '"+maintablename+"' and fieldname = '"+fieldname+"'");
						RecordSetTrans.first();
						String fieldid = RecordSetTrans.getString("id");
						
						RecordSetTrans.execute("SELECT max(selectvalue) FROM crm_selectitem WHERE fieldid = "+fieldid);
						RecordSetTrans.next();
						int num = Util.getIntValue(RecordSetTrans.getString(1),0)+1;
						
						String[] arr = info.split(",,,");
						String ids = "";
						for(int m = 0; m < arr.length ;m++){
							if(m>=1){
								ids += ",";
							}
							ids += arr[m].substring(0,arr[m].indexOf("***"));
						}
						RecordSetTrans.execute("update crm_selectitem set isdel = 1 where fieldid = "+fieldid+" and selectvalue not in ("+ids+")");
						
						for(int m = 0; m < arr.length ;m++){
							String id = arr[m].substring(0,arr[m].indexOf("***"));
							String value = arr[m].substring(arr[m].indexOf("***")+3);
							if(!"-1".equals(id)){
								RecordSetTrans.execute("update crm_selectitem set selectname = '"+value+"' , fieldorder = "+m+" where fieldid = "+fieldid+" and selectvalue ="+id);
							}else{
								String sql = "insert into crm_selectitem(fieldid ,selectvalue,selectname,fieldorder,isdel) values "+
								" ("+fieldid+" , "+num+" , '"+value+"' , "+m+" ,0)";
								RecordSetTrans.execute(sql);
								num++;
							}
						}
						
					}
				}
			}
			//\u4e3b\u5b57\u6bb5 \u7ed3\u675f
			//\u6392\u5e8f
		    String sortnames = Util.null2String(request.getParameter("sortname"));
		    String[] _sortname = Util.TokenizerString2(sortnames,",");
		    for(int i=0;i<_sortname.length;i++)
			{
		    	RecordSetTrans.execute("update CRM_CustomerDefinField set dsporder='"+(i+1)+"' where fieldname='"+_sortname[i]+"' and usetable='"+usetable+"'");
			}
		    RecordSetTrans.commit();
			ArrayList labelidsArray = Util.TokenizerString(labelidsCache,",");
			for(int i=0;i<labelidsArray.size();i++){//\u6dfb\u52a0\u6807\u7b7eid\u5230\u7f13\u5b58
				LabelComInfo.addLabeInfoCache((String)labelidsArray.get(i));
			}    
		}catch(Exception e){
			RecordSetTrans.rollback();
			e.printStackTrace();
            if(message>=0)
                message=-1;
		}finally{
			CrmFieldComInfo.removeFieldCache(usetable);
			if("CRM_CustomerInfo".equals(usetable)){
				CrmExcelToDB.generateExcel();
			}
				
		}  
		if("CRM_CustomerInfo".equals(usetable))
	  		response.sendRedirect("/base/ffield/CRM_FreeFieldInner.jsp?usetable=c1&message="+message);
		else if("CRM_CustomerContacter".equals(usetable))
			response.sendRedirect("/base/ffield/CRM_FreeFieldInner.jsp?usetable=c2&message="+message);
		else if("CRM_CustomerAddress".equals(usetable))
			response.sendRedirect("/base/ffield/CRM_FreeFieldInner.jsp?usetable=c3&message="+message);
		else if("CRM_SellChance".equals(usetable))
			response.sendRedirect("/base/ffield/CRM_FreeFieldInner.jsp?usetable=c4&message="+message);
	}else if(method.equals("editfieldlabel"))
	{
		String changefieldids = Util.null2String(request.getParameter("changefieldids"));
		RecordSetTrans.setAutoCommit(false);
		try{
			ArrayList changefieldidsArray = Util.TokenizerString(changefieldids,",");
			for(int i=0;i<changefieldidsArray.size();i++){
				String fieldid = (String)changefieldidsArray.get(i);
				String fieldnameCN = Util.null2String(request.getParameter("field_"+fieldid+"_CN"));
				String fieldnameEn = Util.null2String(request.getParameter("field_"+fieldid+"_En"));
				String fieldnameTW = Util.null2String(request.getParameter("field_"+fieldid+"_TW"));
				fieldnameCN = Util.StringReplace(fieldnameCN, "\"", "");//TD10108 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u53cc\u5f15\u53f7\u201c"\u201d
				fieldnameEn = Util.StringReplace(fieldnameEn, "\"", "");//TD10108 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u53cc\u5f15\u53f7\u201c"\u201d
				fieldnameTW = Util.StringReplace(fieldnameTW, "\"", "");//TD10108 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u53cc\u5f15\u53f7\u201c"\u201d
				int lableid = 0;
				String sql = "SELECT * FROM HtmlLabelInfo WHERE labelname = '"+fieldnameCN+"' AND languageid = 7 AND indexid IN("+
					 " SELECT indexid FROM HtmlLabelInfo WHERE labelname = '"+fieldnameEn+"' AND languageid = 8 AND indexid IN ("+
					 " SELECT indexid FROM HtmlLabelInfo WHERE labelname = '"+fieldnameTW+"' AND languageid = 9))";
				RecordSetTrans.execute(sql);
				
			  if(RecordSetTrans.next()){
				  	lableid = RecordSetTrans.getInt("indexid");//\u5982\u679c\u5b57\u6bb5\u540d\u79f0\u5728\u6807\u7b7e\u5e93\u4e2d\u5b58\u5728\uff0c\u53d6\u5f97\u6807\u7b7eid,\u4ee5\u4e2d\u6587\u4e3a\u51c6\u3002
			  }else{//\u4e0d\u5b58\u5728\u5219\u751f\u6210\u65b0\u7684\u6807\u7b7eid
					lableid = CRMFreeFieldManage.getNewIndexId(RecordSetTrans);
			  }
				if(lableid!=-1){//\u66f4\u65b0\u6807\u7b7e\u5e93
					RecordSet.executeSql("delete from HtmlLabelIndex where id="+lableid);
					RecordSet.executeSql("delete from HtmlLabelInfo where indexid="+lableid);
					RecordSet.executeSql("INSERT INTO HtmlLabelIndex values("+lableid+",'"+fieldnameCN+"')");
					RecordSet.executeSql("INSERT INTO HtmlLabelInfo values("+lableid+",'"+fieldnameCN+"',7)");//\u4e2d\u6587
					RecordSet.executeSql("INSERT INTO HtmlLabelInfo values("+lableid+",'"+fieldnameEn+"',8)");//\u82f1\u6587
					RecordSet.executeSql("INSERT INTO HtmlLabelInfo values("+lableid+",'"+fieldnameTW+"',9)");//\u7e41\u4f53
					LabelComInfo.addLabeInfoCache(""+lableid);//\u66f4\u65b0\u7f13\u5b58
				}
				RecordSetTrans.executeSql("update CRM_CustomerDefinField set fieldlabel="+lableid+" where id="+fieldid);
			}
			RecordSetTrans.commit();
		}catch(Exception exception){
			exception.printStackTrace();
			RecordSetTrans.rollback();
		}finally{
			CrmFieldComInfo.removeFieldCache(usetable);
		} 
		if("CRM_CustomerInfo".equals(usetable))
	  		response.sendRedirect("/base/ffield/CRM_FreeFieldLabelInner.jsp?usetable=c1");
		else if("CRM_CustomerContacter".equals(usetable))
			response.sendRedirect("/base/ffield/CRM_FreeFieldLabelInner.jsp?usetable=c2");
		else if("CRM_CustomerAddress".equals(usetable))
			response.sendRedirect("/base/ffield/CRM_FreeFieldLabelInner.jsp?usetable=c3");
		else if("CRM_SellChance".equals(usetable))
			response.sendRedirect("/base/ffield/CRM_FreeFieldLabelInner.jsp?usetable=c4");
	}else if(method.equals("editGroupInfo")){
		String delids = request.getParameter("delids");
		String changeRowIndexs = request.getParameter("changeRowIndexs");
		String sortInfo = request.getParameter("sortInfo");
		RecordSetTrans.setAutoCommit(false);
		Map indexValueMap = new HashMap();
		ArrayList<String> sortids = new ArrayList<String>(); 
		if(!sortInfo.equals("")){
			String[] arr = Util.TokenizerString2(sortInfo,",");
			for(int i=0 ; i<arr.length ; i++){
				String index = arr[i].substring(0,arr[i].indexOf("-"));
				String id = arr[i].substring(arr[i].indexOf("-")+1);
				indexValueMap.put(index ,id);
				sortids.add(id);
			}
		}
		
		try{
			if(!"".equals(delids) && !",".equals(delids)){
				delids = delids.substring(1,delids.length()-1);
				RecordSetTrans.execute("delete from CRM_CustomerDefinFieldGroup where usetable = '"+usetable+"' and id in ("+delids+")");
			}
			
			ArrayList array = Util.TokenizerString(changeRowIndexs,",");
		  	for(int i=0;i<array.size();i++){//\u4fee\u6539\u6709\u6539\u53d8\u7684\u884c
		  		int index = Util.getIntValue(array.get(i).toString());
		  		String new_OR_modify = Util.null2String(request.getParameter("modifyflag_"+index));//\u5373\u6570\u636e\u5e93CRM_CustomerDefinField\u7684id\u503c
		  		
		  		String fieldnameCN = Util.null2String(request.getParameter("CN_"+index));
				String fieldnameEn = Util.null2String(request.getParameter("EN_"+index));
				String fieldnameTW = Util.null2String(request.getParameter("TW_"+index));
				
				int lableid = 0;
	  			String sql = "SELECT * FROM HtmlLabelInfo WHERE labelname = '"+fieldnameCN+"' AND languageid = 7 AND indexid IN("+
	  						 " SELECT indexid FROM HtmlLabelInfo WHERE labelname = '"+fieldnameEn+"' AND languageid = 8 AND indexid IN ("+
	  						 " SELECT indexid FROM HtmlLabelInfo WHERE labelname = '"+fieldnameTW+"' AND languageid = 9))";
	  		
	  			RecordSetTrans.execute(sql);
	  			if(RecordSetTrans.next()){
			    	lableid = RecordSetTrans.getInt("indexid");//\u5982\u679c\u5b57\u6bb5\u540d\u79f0\u5728\u6807\u7b7e\u5e93\u4e2d\u5b58\u5728\uff0c\u53d6\u5f97\u6807\u7b7eid,\u4ee5\u4e2d\u6587\u4e3a\u51c6\u3002
			    }else{//\u4e0d\u5b58\u5728\u5219\u751f\u6210\u65b0\u7684\u6807\u7b7eid
					lableid = CRMFreeFieldManage.getNewIndexId(RecordSetTrans);
				}
				if(lableid!=-1){//\u66f4\u65b0\u6807\u7b7e\u5e93
					RecordSet.executeSql("delete from HtmlLabelIndex where id="+lableid);
					RecordSet.executeSql("delete from HtmlLabelInfo where indexid="+lableid);
					RecordSet.executeSql("INSERT INTO HtmlLabelIndex values("+lableid+",'"+fieldnameCN+"')");
					RecordSet.executeSql("INSERT INTO HtmlLabelInfo values("+lableid+",'"+fieldnameCN+"',7)");//\u4e2d\u6587
					RecordSet.executeSql("INSERT INTO HtmlLabelInfo values("+lableid+",'"+fieldnameEn+"',8)");//\u82f1\u6587
					RecordSet.executeSql("INSERT INTO HtmlLabelInfo values("+lableid+",'"+fieldnameTW+"',9)");//\u7e41\u4f53
					LabelComInfo.addLabeInfoCache(""+lableid);//\u66f4\u65b0\u7f13\u5b58
				}
				
		  		if(new_OR_modify.equals("")){//\u65b0\u589e\u64cd\u4f5c
					sql = "insert into  CRM_CustomerDefinFieldGroup(usetable ,grouplabel,dsporder , candel) values ('"+usetable+"' , '"+lableid+"' ,"+index+1+" , 'y')";
					RecordSetTrans.executeSql(sql);
					
					if(!sortInfo.equals("")){
						RecordSetTrans.execute("select max(id) from CRM_CustomerDefinFieldGroup where usetable = '"+usetable+"'");
						RecordSetTrans.next();
						String newId = RecordSetTrans.getString(1);
						sortids.add(newId);
//						indexValueMap.put(index , newId);
					}
					
		  		}else{
		  			sql = "update CRM_CustomerDefinFieldGroup set grouplabel = '"+lableid+"' where id = "+new_OR_modify;
		  			RecordSetTrans.executeSql(sql);
		  		}
		  		
		  	}
		  	
		  	if(!sortInfo.equals("")){
		  		int order = 1;
		  		for(String id : sortids){
		  			RecordSetTrans.execute("update CRM_CustomerDefinFieldGroup set dsporder = "+order+" where id = "+id);
		  			order++;
		  		}
		  	}
		  	
		  	
		    RecordSetTrans.commit();
		}catch(Exception exception){
			RecordSetTrans.rollback();
			exception.printStackTrace();
		}finally{
			CrmFieldComInfo.removeFieldCache(usetable);
		} 
		
		if("CRM_CustomerInfo".equals(usetable))
	  		response.sendRedirect("/base/ffield/CRM_FreeFieldGroupInner.jsp?usetable=c1");
		else if("CRM_CustomerContacter".equals(usetable))
			response.sendRedirect("/base/ffield/CRM_FreeFieldGroupInner.jsp?usetable=c2");
		else if("CRM_CustomerAddress".equals(usetable))
			response.sendRedirect("/base/ffield/CRM_FreeFieldGroupInner.jsp?usetable=c3");
		else if("CRM_SellChance".equals(usetable))
			response.sendRedirect("/base/ffield/CRM_FreeFieldGroupInner.jsp?usetable=c4");
		
	}else if(method.equals("getTableGroupInfo")){
		String rowindex = Util.null2String(request.getParameter("rowindex"));
		
		String selectValue = "";
		if(usetable.equals("CRM_CustomerInfo"))selectValue = "5";
		if(usetable.equals("CRM_CustomerContacter"))selectValue = "7";
		if(usetable.equals("CRM_CustomerAddress"))selectValue = "9";
		
		out.println(CRMFreeFieldManage.getTableGroupInfo(usetable,rowindex,selectValue,user,true)); 
	}else if(method.equals("changeSelectItemInfo")){
		int rownum = Util.getIntValue(request.getParameter("rownum"),0);
		int fieldid = Util.getIntValue(request.getParameter("fieldid"),0);
		String canDeleteP = "";
		String itemName = "";
		int itemNameId;
		String notInId = "";
        for (int i=0;i<rownum;i++){
        	canDeleteP = Util.getIntValue(request.getParameter("canDeleteP_"+i),0)+"";
        	itemNameId = Util.getIntValue(request.getParameter("itemNameId_"+i),0);
            if (canDeleteP.equals("1")){
            	if (notInId.equals("")) 
            		notInId = itemNameId + "";
                else 
                	notInId +="," + itemNameId;
            }
        }
        String strSqlDelAll = "" ;
        if ("".equals(notInId)){
            strSqlDelAll = " delete from crm_selectitem WHERE fieldid ="+ fieldid;            
        } else {
            strSqlDelAll = " delete from crm_selectitem WHERE selectvalue not in("+notInId+") and fieldid ="+ fieldid ;        
        }
		RecordSet.executeSql(strSqlDelAll);
		for (int i=0;i<rownum;i++){
            canDeleteP = Util.fromScreen(request.getParameter("canDeleteP_"+i),user.getLanguage());
            itemName = Util.fromScreen(request.getParameter("itemName_"+i),user.getLanguage());
            itemNameId = Util.getIntValue(request.getParameter("itemNameId_"+i),0);
            if (canDeleteP.equals("0")){
				if (!"".equals(itemName)){
                	String isql = " insert into crm_selectitem (fieldid,selectvalue,selectname,fieldorder,isdel) values ("+fieldid+","+itemNameId+",'"+itemName+"',"+(itemNameId-1)+",0) ";
                	RecordSet.executeSql(isql);
				}
            }else{
            	if (!"".equals(itemName)){
                	String usql = " update crm_selectitem set selectname='"+itemName+"' where fieldid ="+ fieldid +" and selectvalue="+itemNameId;
                	RecordSet.executeSql(usql);
                }
            }
        }
		out.println("<script>parent.getParentWindow(window).onSave('');parent.getParentWindow(window).closeDialog();</script>");
	}

    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("base/ffield/CRM_FreeFieldOperation.jsp"), -3892552048172981358L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string2;
  private final static char []_jsp_string1;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n \r\n \r\n".toCharArray();
    _jsp_string2 = "	\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
  }
}
