/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._homepage._element;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import java.util.*;
import weaver.hrm.*;
import weaver.systeminfo.*;
import weaver.general.StaticObj;
import weaver.general.Util;
import weaver.hrm.settings.RemindSettings;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

public class _esettingoperate__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      
	
	response.setHeader("cache-control", "no-cache");
	response.setHeader("pragma", "no-cache");
	response.setHeader("expires", "Mon 1 Jan 1990 00:00:00 GMT");
	

	User user = HrmUserVarify.getUser (request , response) ;
	if(user == null)  return ;
	Log logger= LogFactory.getLog(this.getClass());
	String isIE = (String)session.getAttribute("browser_isie");

      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet rs;
      rs = (weaver.conn.RecordSet) pageContext.getAttribute("rs");
      if (rs == null) {
        rs = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs", rs);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.conn.RecordSet rs1;
      rs1 = (weaver.conn.RecordSet) pageContext.getAttribute("rs1");
      if (rs1 == null) {
        rs1 = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs1", rs1);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.conn.RecordSet rsWordCount;
      rsWordCount = (weaver.conn.RecordSet) pageContext.getAttribute("rsWordCount");
      if (rsWordCount == null) {
        rsWordCount = new weaver.conn.RecordSet();
        pageContext.setAttribute("rsWordCount", rsWordCount);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.homepage.HomepageUtil hpu;
      hpu = (weaver.homepage.HomepageUtil) pageContext.getAttribute("hpu");
      if (hpu == null) {
        hpu = new weaver.homepage.HomepageUtil();
        pageContext.setAttribute("hpu", hpu);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.homepage.cominfo.HomepageElementCominfo hpec;
      hpec = (weaver.homepage.cominfo.HomepageElementCominfo) pageContext.getAttribute("hpec");
      if (hpec == null) {
        hpec = new weaver.homepage.cominfo.HomepageElementCominfo();
        pageContext.setAttribute("hpec", hpec);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.page.style.ElementStyleCominfo esc;
      esc = (weaver.page.style.ElementStyleCominfo) pageContext.getAttribute("esc");
      if (esc == null) {
        esc = new weaver.page.style.ElementStyleCominfo();
        pageContext.setAttribute("esc", esc);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.page.PageUtil pu;
      pu = (weaver.page.PageUtil) pageContext.getAttribute("pu");
      if (pu == null) {
        pu = new weaver.page.PageUtil();
        pageContext.setAttribute("pu", pu);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.general.BaseBean baseBean;
      baseBean = (weaver.general.BaseBean) pageContext.getAttribute("baseBean");
      if (baseBean == null) {
        baseBean = new weaver.general.BaseBean();
        pageContext.setAttribute("baseBean", baseBean);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      	
	boolean isSystemer=false;
	if(HrmUserVarify.checkUserRight("homepage:Maint", user)) isSystemer=true;

	String eid=Util.null2String(request.getParameter("eid"));	
	String ebaseid=Util.null2String(request.getParameter("ebaseid"));
	String method=Util.null2String(request.getParameter("method"));	
	
	String eTitleValue=Util.null2String(request.getParameter("eTitleValue"));	
	String ePerpageValue=Util.null2String(request.getParameter("ePerpageValue"));	
	String eLinkmodeValue=Util.null2String(request.getParameter("eLinkmodeValue"));	
	String eFieldsVale=Util.null2String(request.getParameter("eFieldsVale"));
	String whereKeyStr=Util.null2String(request.getParameter("whereKeyStr"));
	String hpid=Util.null2String(request.getParameter("hpid"));	
	
	String eShowMoulde=Util.null2String(request.getParameter("eShowMoulde"));
	String eBackground=Util.null2String(request.getParameter("eBackground"));	
	
	int subCompanyId = Util.getIntValue(request.getParameter("subCompanyId"),-1);
	
	//\u6c42\u7528\u6237\u7684ID\u4e0e\u5206\u90e8ID
	int userid=pu.getHpUserId(hpid,""+subCompanyId,user);
	int usertype=pu.getHpUserType(hpid,""+subCompanyId,user);

	baseBean.writeLog(userid+","+usertype);
	if("0".equals(hpid)&&subCompanyId==0){
		userid =1;
		usertype=0;
	}
	//\u534f\u540c\u6a21\u5757\u6682\u65f6\u6307\u5b9aUserid\u4e3a\u539f\u59cbid=========\u534f\u540c\u63d2\u5165\u95e8\u6237\u4ee3\u78011========
	if(Util.getIntValue(hpid)<0)//\u534f\u540c\u7684 userid  \u548c usertype \u4e3a 1  \u548c 0
	{
		userid = 1;
		usertype = 0;
	}

	// \u5224\u65ad\u5143\u7d20\u7f16\u8f91\u6743\u9650
	String esharelevel ="";
	


	String  strShareSql="select perpage,linkmode,showfield,sharelevel from hpElementSettingDetail where eid="+eid+" and userid="+userid+" and usertype="+usertype;	
	rs.executeSql(strShareSql);
	if(rs.next()){
		esharelevel =Util.null2String(rs.getString("sharelevel"));  //1:\u4e3a\u67e5\u770b 2:\u4e3a\u7f16\u8f91
	}
	if(isSystemer){
		esharelevel = "2";
	}
	//=========\u534f\u540c\u63d2\u5165\u95e8\u6237\u4ee3\u78011=======
	
	if("editSetting".equals(method)){
		

		String strSql="";
		if("2".equals(esharelevel)){
			if(ebaseid.equals("33")&&whereKeyStr.contains("'")){
				whereKeyStr = Util.StringReplace(whereKeyStr,"'","#");
			}
			strSql="update hpElement set title='"+eTitleValue+"',strsqlwhere='"+whereKeyStr+"',isFixationRowHeight='"+eShowMoulde+"',background='"+eBackground+"' where id="+eid;	

			rs.executeSql(strSql);
			hpec.updateHpElementCache(eid);
			
		}
		

		strSql="update hpElementSettingDetail set perpage="+ePerpageValue+" ,linkmode='"+eLinkmodeValue+"', showfield='"+eFieldsVale+"'  where eid="+eid+" and userid="+userid+" and usertype="+usertype;
		rs.executeSql(strSql);	


		String strSql1="select id,islimitlength, fieldColumn from hpFieldElement where elementid="+ebaseid;		
		rs.executeSql(strSql1);	

		rs1.executeSql("delete hpFieldLength where eid="+eid+" and userid="+userid+" and usertype="+usertype);
		while(rs.next()){
			String id=Util.null2String(rs.getString("id"));
			String islimitlength=Util.null2String(rs.getString("islimitlength"));
			String fieldcolumn=Util.null2String(rs.getString("fieldColumn"));
			
			if(fieldcolumn.toLowerCase().equals("img")){
				String imgSize = Util.null2String(request.getParameter("imgSize_"+id));
				rsWordCount.executeSql("insert into hpFieldLength (eid,efieldid,charnum,imgsize,userid,usertype) values ("+eid+","+id+",8,'"+imgSize+"',"+userid+","+usertype+")");
			}
			int wordCount=0;			
			
			if("1".equals(islimitlength)) {
				wordCount=Util.getIntValue(request.getParameter("wordcount_"+id),0);
				rsWordCount.executeSql("insert into hpFieldLength (eid,efieldid,charnum,userid,usertype) values ("+eid+","+id+","+wordCount+","+userid+","+usertype+")");
		
			}

		}	
		
	} else if("delElement".equals(method)){	
		String delFlag=Util.null2String(request.getParameter("delFlag"));
		String delAreaElement=Util.null2String(request.getParameter("delAreaElement"));
		String delType = Util.null2String(request.getParameter("delType"));
	    //\u5982\u679c\u662f\u5220\u9664\u5143\u7d20,\u53ea\u662f\u5220\u9664\u76f8\u5e94\u7684\u4eba\u7684\u6761\u4ef6
		//\u5982\u679c\u662f\u7cfb\u7edf\u7ba1\u7406\u5458\u4e5f\u53ea\u80fd\u5220\u9664\u4ed6\u81ea\u5df2\u6240\u80fd\u770b\u5230\u7684\u4e1c\u897f,\u800c\u4e0d\u80fd\u5220\u9664\u522b\u4eba\u7684\uff0c\u53ea\u4e0d\u8fc7\u7cfb\u7edf\u7ba1\u7406\u5458\u5220\u9664\u7684\u65f6\u5019\u9700\u8981\u628a\u76f8\u5e94\u7684\u5143\u7d20\u7684\u9501\u5b9a\u72b6\u6001\u53d8\u4e3a\u4e0d\u9501\u5b9a       
		if(usertype==3||usertype==4) {
			String strULocked="update hpelement set islocked=0,isuse=0 where id="+eid;	          
			rs.executeSql(strULocked);
            hpec.updateHpElementCache(eid);
		}
		if("0".equals(hpid)&&subCompanyId==0){
			rs.executeSql("update hpelement set fromModule='NULL',isuse=0 where id="+eid);
		}
	    if(usertype == 3 && !"2".equals(esharelevel)){
	    	return;
	    }
		//\u5220\u9664\u76f8\u5173\u7684\u5143\u7d20\u7684\u5e03\u5c40\u4fe1\u606f
		String strDelLayout ="";
		if("".equals(delType)){
			strDelLayout="update  hplayout set areaElements='"+delAreaElement+"' where hpid="+hpid+" and areaflag='"+delFlag+"' and userid="+userid+" and usertype="+usertype;
		}else{
			strDelLayout="update  pagenewstemplatelayout set areaElements='"+delAreaElement+"' where templateid="+hpid+" and areaFlag='"+delFlag+"'";
		}
		//\u5220\u9664\u76f8\u5173\u7684\u5143\u7d20\u8be6\u7ec6
		String strDelEdetail="delete hpElementSettingDetail  where hpid="+hpid+" and eid="+eid+" and userid="+userid+" and usertype="+usertype;	
		
		//\u5220\u9664\u76f8\u5173\u7684\u5143\u7d20\u5b57\u6bb5\u5b57\u6570\u9650\u5236
		String strDelEFiledLenght="delete hpFieldLength  where eid="+eid+"  and userid="+userid+" and usertype="+usertype;	
		
		if("2".equals(esharelevel)){
			//\u5916\u90e8\u6570\u636e\u5143\u7d20\u7279\u6b8a\u5904\u7406
			if("OutData".equals(ebaseid)) {
				rs.executeSql("delete from hpOutDataTabSetting where eid="+eid);
				rs.executeSql("delete from hpOutDataSettingAddr where eid="+eid);
				rs.executeSql("delete from hpOutDataSettingDef where eid="+eid);
				rs.executeSql("delete from hpOutDataSettingField where eid="+eid);
			} 
		}
		 
		rs.executeSql(strDelLayout);
		rs.executeSql(strDelEdetail);
		rs.executeSql(strDelEFiledLenght);	
	} else if("locked".equals(method)){
		//\u5982\u679c\u53d8\u4e3a\u9501\u5b9a
		//1:\u628a\u5143\u7d20\u672c\u8eab\u7684\u72b6\u6001\u53d8\u5316\u9501\u5b9a
		if(!"2".equals(esharelevel)){
			return ;
		}
		String strSql="update  hpElement set islocked=1  where id="+eid;		

		rs.executeSql(strSql);	
		hpec.updateHpElementCache(eid);
		

		//2:\u628a\u6240\u6709\u5f53\u524d\u5df2\u7ecf\u4f7f\u7528\u4e86\u9996\u9875\u7684\u7528\u6237\u4e2d \u5982\u679c\u6ca1\u6709\u6b64\u5143\u7d20\u7684\u5c31\u52a0\u4e0a\u6b64\u5143\u7d20
		
		strSql="select userid,usertype from (	select distinct userid,usertype from hplayout where hpid="+hpid+" and not (userid="+userid+" and usertype="+usertype+")	union all	select distinct userid,usertype from hpElementSettingDetail where eid="+eid+" and hpid="+hpid+" and not (userid="+userid+" and usertype="+usertype+")) a group by a.userid,a.usertype having count(*)=1";

		rs.executeSql(strSql);		
		while(rs.next()){
			String tempUserid=Util.null2String(rs.getString("userid"));
			String tempUsertype=Util.null2String(rs.getString("usertype"));

			String tempSql="insert into hpElementSettingDetail (userid,usertype,eid,perpage,linkmode,showfield,sharelevel,hpid) select "+tempUserid+","+tempUsertype+",eid,perpage,linkmode,showfield,'1',hpid from hpElementSettingDetail where  hpid="+hpid+" and userid="+userid+" and usertype="+usertype+" and eid="+eid;

			rs1.executeSql(tempSql);

			//\u628a\u76f8\u5e94\u7684\u5143\u7d20\u52a0\u5230\u5230\u5176A\u533a
			String strCon="+";
			if("oracle".equals(rs1.getDBType())) strCon="||";				
			tempSql="update hplayout  set areaElements='"+eid+",' "+strCon+" areaElements where hpid="+hpid+" and  areaflag='A' and userid="+tempUserid+" and usertype="+tempUsertype;
			rs1.executeSql(tempSql);

			//\u628a\u76f8\u5e94\u7684\u5143\u7d20\u7684\u76f8\u5e94\u7684\u5b57\u6570\u8bbe\u7f6e\u4e5f\u52a0\u4e0a

			tempSql="insert into  hpFieldLength (eid,efieldid,charnum,userid,usertype,imgsize) select  eid,efieldid,charnum,"+tempUserid+","+tempUsertype+",imgsize from  hpFieldLength where eid="+eid+" and userid="+userid+" and usertype="+usertype;

			rs1.executeSql(tempSql);
		}
		out.println(esc.getIconLock(hpec.getStyleid(eid)));
	} else if("unlocked".equals(method)){
		if(!"2".equals(esharelevel)){
			return ;
		}
		String strSql="update hpElement set islocked=0  where id="+eid;		
		rs.executeSql(strSql);	
		hpec.updateHpElementCache(eid);
		out.println(esc.getIconUnLock(hpec.getStyleid(eid)));
	}else if("editLayout".equals(method)){
		String targetFlag=Util.null2String(request.getParameter("targetFlag"));
		String targetStr=Util.null2String(request.getParameter("targetStr"));

		String srcFlag=Util.null2String(request.getParameter("srcFlag"));
		String srcStr=Util.null2String(request.getParameter("srcStr"));
		String editType = Util.null2String(request.getParameter("editType"));

		if(usertype == 3 && !"2".equals(esharelevel)){
	    	return;
	    }

		/*String strMoveSql="update hpElementSettingDetail set areaflag='"+targetFlag+"' where  hpid="+hpid+" and  eid="+eid+" and userid="+userid+" and usertype="+usertype;*/
		String strMoveSql1="";
		String strMoveSql2="";
		if("".equals(editType)){
			strMoveSql1="update hplayout set areaelements='"+srcStr+"' where  hpid="+hpid+" and areaflag='"+srcFlag+"' and userid="+userid+" and usertype="+usertype;
			strMoveSql2="update hplayout set areaelements='"+targetStr+"' where  hpid="+hpid+" and areaflag='"+targetFlag+"' and userid="+userid+" and usertype="+usertype;
		}else{
			strMoveSql1="update pagenewstemplatelayout set areaElements='"+srcStr+"' where  templateid="+hpid+" and areaFlag='"+srcFlag+"'";
			strMoveSql2="update pagenewstemplatelayout set areaElements='"+targetStr+"' where  templateid="+hpid+" and areaFlag='"+targetFlag+"'";
		}

		rs.executeSql(strMoveSql1);
		rs.executeSql(strMoveSql2);
	}else if("addtoass".equals(method)){
		String strSql="insert into hpsysremind(eid) values ("+eid+")";	

		rs.executeSql(strSql);	
		return;
	}else if("removefromass".equals(method)){
		String strSql="delete  hpsysremind  where eid="+eid;
		rs.executeSql(strSql);	
		return;
	}else if("synernyisusechange".equals(method)){	// \u5904\u7406\u534f\u540c \u95e8\u6237 \u542f\u7528 \u4e0d\u542f\u7528
		String isuse = request.getParameter("isuse");
	    // \u517c\u5bb9\u5386\u53f2\u6570\u636e
	    rs.executeSql("select * from synergyconfig where hpid="+hpid);
	    if(!rs.next()){
	    	rs.execute("insert into synergyconfig (hpid,isuse) values('"+hpid+"','"+isuse+"')");
	    }else{
	        rs.execute("update synergyconfig set isuse='"+isuse+"' where hpid="+hpid );
	    }
	    out.print("1");
	    return;
	} 

    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("homepage/element/EsettingOperate.jsp"), -1068071250569150978L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
    depend = new com.caucho.vfs.Depend(appDir.lookup("page/maint/common/initNoCache.jsp"), 3270256153856711871L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string1;
  private final static char []_jsp_string2;
  private final static char []_jsp_string0;
  static {
    _jsp_string1 = "\r\n\r\n\r\n".toCharArray();
    _jsp_string2 = "\r\n".toCharArray();
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
  }
}
