/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._mobile._plugin._plus._doc._data;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import java.util.*;
import weaver.hrm.*;
import weaver.systeminfo.*;
import weaver.general.StaticObj;
import weaver.general.Util;
import weaver.hrm.settings.RemindSettings;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import weaver.general.*;
import net.sf.json.*;
import org.jsoup.*;
import weaver.file.Prop;
import org.jsoup.safety.*;
import weaver.hrm.resource.ResourceComInfo;
import weaver.conn.RecordSet;
import java.lang.reflect.Method;
import weaver.hrm.company.DepartmentComInfo;
import weaver.hrm.company.SubCompanyComInfo;
import weaver.hrm.job.JobTitlesComInfo;

public class _docoperation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;

   
  	public JSONArray getDocReply(String docid,ResourceComInfo rc,String order,boolean isUseNewReply,String replyid,int userid){
  		RecordSet rs = new RecordSet();
  		StringBuffer sb = new StringBuffer();
  		if(isUseNewReply){
  			String rpSql = "(r.reply_parentid = '"+replyid+"'";
  			if(replyid.equals("-1")){
  				rpSql+=" or r.reply_parentid = '"+docid+"'";
  			}
  			rpSql+=")";
  			sb.append("select r.id,r.content as doccontent,r.userid as doccreaterid,r.replydate as doccreatedate,");
  			sb.append("r.replytime as doccreatetime,r.parentid as parentids,");
  			sb.append("(select count(id) from PRAISE_INFO p where p.PRAISE_ID = r.id) as praisecount,");
  			sb.append("(select max(id) from PRAISE_INFO p2 where p2.PRAISE_ID = r.id and p2.userid = "+userid+") as mypraiseid ");
  			sb.append("from doc_reply r ");
  			sb.append("where r.docid = '"+docid+"' and "+rpSql+" order by r.id "+order);
  		}else{
  			if(rs.getDBType().equals("oracle")){//oracle\u6570\u636e\u5e93 \u56fe\u6587\u5185\u5bb9\u5b58\u653e\u5728DocDetailContent
  				sb.append("select a.id,b.doccontent,a.doccreaterid,a.doccreatedate,a.doccreatetime,a.parentids from DOCDETAIL a,");
  				sb.append("DocDetailContent b where a.id = b.docid and a.isreply = 1 and replydocid="+replyid);
  				sb.append(" and (a.docstatus = 1 or a.docstatus = 2) order by a.id "+order);
  				rs.executeSql(sb.toString());
  			}else{
  				sb.append("select id,doccontent,doccreaterid,doccreatedate,doccreatetime,parentids "+
  						" from DocDetail where (docstatus = 1 or docstatus = 2) and isreply = 1 and replydocid="+replyid+" order by id "+order);
  			}
  		}
  		rs.executeSql(sb.toString());
  		//System.out.println(sb.toString());
  		JSONArray ja = new JSONArray();
  		while(rs.next()){
  			String id = rs.getString("id");
  			String doccreaterid = rs.getString("doccreaterid");
  			String doccontent = Util.null2String(rs.getString("doccontent"));
  			String parentids = Util.null2String(rs.getString("parentids"));
  			String date = rs.getString("doccreatedate")+" "+rs.getString("doccreatetime");
  			JSONObject comment = new JSONObject();
  			comment.put("id", id);//\u8bc4\u8bbaID
  			comment.put("doccreaterid", doccreaterid);//\u8bc4\u8bba\u521b\u5efa\u4ebaID
  			comment.put("doccontent", doccontent);//\u8bc4\u8bba\u5185\u5bb9
  			comment.put("doccreatedate", date);//\u8bc4\u8bba\u65f6\u95f4
  			comment.put("userimg", rc.getMessagerUrls(doccreaterid));//\u8bc4\u8bba\u4eba\u5934\u50cf
  			comment.put("username", rc.getLastname(doccreaterid));//\u8bc4\u8bba\u4eba\u540d\u79f0
  			comment.put("parentids", parentids);//\u65e7\u7248\u672c\u56de\u590d \u8fd9\u91cc\u4e3a\u6b64\u56de\u590d\u6240\u6709\u4e0a\u7ea7\u7684ID\u5305\u62ec\u81ea\u5df1 \u65b0\u7248\u672c\u56de\u590d\u8fd9\u91cc\u4e3a\u5f53\u524d\u56de\u590d\u7684\u9876\u7ea7\u56de\u590d \u5982\u679c\u5f53\u524d\u56de\u590d\u662f\u5bf9\u6587\u6863\u56de\u590d\u6b64\u503c\u4e3a\u7a7a
  			if(isUseNewReply){
  				comment.put("praisecount", Util.getIntValue(rs.getString("praisecount")));//\u65b0\u7248\u672c\u8be5\u8bc4\u8bba\u7684\u70b9\u8d5e\u6570\u91cf
  				comment.put("mypraiseid", Util.getIntValue(rs.getString("mypraiseid"),0));//\u65b0\u7248\u672c\u6211\u5bf9\u8be5\u8bc4\u8bba\u70b9\u8d5e\u7684ID \u6ca1\u6709\u70b9\u8d5e\u8fc7\u5219\u4e3a0
  			}
  			comment.put("subCommentList", getDocReply(docid,rc,"asc",isUseNewReply,id,userid));
  			ja.add(comment);
  		}
  		return ja;
  	}
  
  	public String getIpAddr(HttpServletRequest request) {      
      String ip = request.getHeader("x-forwarded-for");      
      if(ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {      
          ip = request.getHeader("Proxy-Client-IP");      
      }      
      if(ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {      
          ip = request.getHeader("WL-Proxy-Client-IP");      
      }      
      if(ip == null || ip.length() == 0 || "unknown".equalsIgnoreCase(ip)) {      
          ip = request.getRemoteAddr();      
      }   
      if ((ip.indexOf(",") >= 0)){
          ip = ip.substring(0 , ip.indexOf(","));
      }
      return ip;      
  }
  /**
   * \u8f6c\u7801\u4e3a\u53ef\u5728\u624b\u673a\u4e0a\u5b8c\u6574\u663e\u793a\u7684html
   * 
   * @param bedHtml
   *            \u5f85\u8f6c\u7801\u7684html
   * @return \u8f6c\u7801\u540e\u7684html
   */
  public static String translateMarkup(String bedHtml) {
  	boolean isHtml = false;
  	if (bedHtml == null || bedHtml.trim().equals("")) {
  		return "";
  	}
  
  	StringBuffer sbfrtnRst = new StringBuffer();
  
  	bedHtml = java.util.regex.Pattern.compile("<!--[^(-->)]+-->",
  			java.util.regex.Pattern.CASE_INSENSITIVE).matcher(bedHtml)
  			.replaceAll("");
  
  	String regExHtml = "<[^>]+>";
  
  	int mtchEndIdx = 0;
  
  	java.util.regex.Pattern mainPattern = java.util.regex.Pattern.compile(
  			regExHtml, java.util.regex.Pattern.CASE_INSENSITIVE);
  	java.util.regex.Matcher mainMacher = mainPattern.matcher(bedHtml);
  
  	while (mainMacher.find()) {
  		isHtml = true;
  		sbfrtnRst.append(tagConversion(bedHtml, mainMacher.group(),
  				mainMacher.start(), mtchEndIdx));
  		mtchEndIdx = mainMacher.end();
  	}
  
  	if (!isHtml){
  		return bedHtml;
  	}
  
  	String imgresizeScript = "<SCRIPT type=\"text/javascript\">function image_resize(_this) {var innerWidth = window.innerWidth;var imgWidth = $(_this).width();if (imgWidth >= innerWidth) {$(_this).width(\"100%\");$(_this).removeAttr(\"height\");$(_this).css(\"height\", \"\");}}</SCRIPT>";
  	if (!sbfrtnRst.toString().trim().equals("")) {
  		return sbfrtnRst.toString() + "\r\n" + imgresizeScript;
  	}
  	
  	return sbfrtnRst.toString();
  }
  /**
   * \u5bf9html\u4e2d\u7684\u6807\u7b7e\u8fdb\u884c\u8f6c\u7801
   * 
   * @param bedHtml
   *            \u5f85\u8f6c\u7801\u7684html
   * @param mainMacher
   *            \u5df2\u6839\u636e
   * @param lastMatchEndIdx
   * @return
   */
  private static String tagConversion(String bedHtml, String tagString,
  		int tagStartIdx, int lastMatchEndIdx) {
  	String rtnRst = null;
  	// \u6807\u7b7e\u5f00\u59cb\u4e0b\u6807
  	int startidx = tagStartIdx;
  	// \u9002\u5408\u5c0f\u8bbe\u5907\u663e\u793a\u7684html\u6807\u7b7e
  	String sedTag = tagConversion4Rule(tagString);
  
  	// \u6807\u7b7e\u4e4b\u95f4\u7684\u5185\u5bb9
  	String mtcContnt = bedHtml.substring(lastMatchEndIdx, startidx);
  
  	rtnRst = mtcContnt + sedTag;
  
  	return rtnRst;
  }
  private static String tagConversion4Rule(String convertTag) {
  	// \u8fd4\u56de\u503c
  	String rtnRst = "";
  	// \u6807\u7b7e\u540d\u79f0
  	String tagName = "";
  	// \u6807\u7b7e\u5c5e\u6027
  	String tagAttr = "";
  	// \u8f6c\u6362\u540e\u7684\u6807\u7b7e\u5c5e\u6027
  	String newTagAttr = "";
  	// style\u5f00\u59cb\u4e0b\u6807
  	int styleIdx = -1;
  
  	// \u662f\u5426\u662f\u7ed3\u675f\u6807\u7b7e
  	int startTag = convertTag.charAt(1) == '/' ? 2
  			: convertTag.charAt(1) != '!' ? 1 : 0;
  	// \u83b7\u53d6\u6807\u7b7e\u540d\u79f0
  	int tagNameEndIdx = convertTag.indexOf(" ");
  	if (tagNameEndIdx != -1) {
  		tagName = convertTag.substring(startTag, tagNameEndIdx);
  	} else {
  		tagName = convertTag.substring(startTag, convertTag.length() - 1);
  	}
  
  	String[] regexSplitBs = new String[] { "width=[^ ]+",
  			"nowrap=\"[^\"]+\"", "width:[^;]+[; ]",
  			"padding[ ]{0,}:[^;]+[; ]", "padding-top[ ]{0,}:[^;]+[; ]",
  			"padding-right[ ]{0,}:[^;]+[; ]",
  			"padding-bottom[ ]{0,}:[^;]+[; ]",
  			"padding-left[ ]{0,}:[^;]+[; ]", "margin[ ]{0,}:[^;]+[; ]",
  			"margin-top[ ]{0,}:[^;]+[; ]", "margin-right[ ]{0,}:[^;]+[; ]",
  			"margin-bottom[ ]{0,}:[^;]+[; ]",
  			"margin-left[ ]{0,}:[^;]+[; ]", "text-indent[ ]{0,}:[^;]+[; ]",
  			"white-space[ ]{0,}:[ ]{0,}nowrap[ ]{0,}[; ]" };
  
  	String[] regexSplitFh = new String[] { "width[ ]{0,}:[^\"^;]+[\"]",
  			"padding[ ]{0,}:[^\"^;]+[\"]",
  			"padding-top[ ]{0,}:[^\"^;]+[\"]",
  			"padding-right[ ]{0,}:[^\"^;]+[\"]",
  			"padding-bottom[ ]{0,}:[^\"^;]+[\"]",
  			"padding-left[ ]{0,}:[^\"^;]+[\"]",
  			"margin[ ]{0,}:[^\"^;]+[\"]", "margin-top[ ]{0,}:[^\"^;]+[\"]",
  			"margin-right[ ]{0,}:[^\"^;]+[\"]",
  			"margin-bottom[ ]{0,}:[^\"^;]+[\"]",
  			"margin-left[ ]{0,}:[^\"^;]+[\"]",
  			"text-indent[ ]{0,}:[^\"^;]+[\"]",
  			"white-space[ ]{0,}:[ ]{0,}nowrap[ ]{0,}[\"]" };
  
  	// \u5982\u679c\u662f\u5f00\u59cb\u6807\u7b7e
  	if (startTag == 1) {
  		// \u6b64\u6807\u7b7e\u65e0\u5c5e\u6027
  		if (tagNameEndIdx != -1) {
  			tagAttr = convertTag.substring(tagNameEndIdx + 1, convertTag
  					.length() - 1);
  			newTagAttr = tagAttr;
  
  			for (String srex : regexSplitBs) {
  				newTagAttr = java.util.regex.Pattern.compile(srex,
  						java.util.regex.Pattern.CASE_INSENSITIVE).matcher(
  						newTagAttr).replaceAll("");
  			}
  
  			for (String srex : regexSplitFh) {
  				newTagAttr = java.util.regex.Pattern.compile(srex,
  						java.util.regex.Pattern.CASE_INSENSITIVE).matcher(
  						newTagAttr).replaceAll("\"");
  			}
  			newTagAttr = " " + newTagAttr + " ";
  			styleIdx = newTagAttr.toLowerCase().indexOf("style");
  		} else {
  			tagAttr = " ";
  		}
  
  		if (tagName.equalsIgnoreCase("table")) {
  			
  			if (styleIdx != -1) {
  				newTagAttr = " " + newTagAttr.substring(0, styleIdx + 7)
  						+ "table-layout: fixed;"
  						+ newTagAttr.substring(styleIdx + 7)
  						+ " width=\"100%\" ";
  			} else {
  				newTagAttr += " style=\"table-layout: fixed;\" width=\"100%\" ";
  			}
  		} else if (tagName.equalsIgnoreCase("td")) {
  			if (styleIdx != -1) {
  				newTagAttr = " " + newTagAttr.substring(0, styleIdx + 7)
  						+ "word-break:break-all;word-wrap:break-word;"
  						+ newTagAttr.substring(styleIdx + 7)
  						+ " width=\"auto\" ";
  			} else {
  				newTagAttr += " style=\"word-break:break-all;word-wrap:break-word;\" width=\"auto\" ";
  			}
  		} else if (tagName.equalsIgnoreCase("img")) {
  			newTagAttr += " onload=\"image_resize(this);\" onresize=\"image_resize(this);\" ";
  		}
  	}
  
  	if (startTag == 1) {
  		rtnRst = "<" + tagName + newTagAttr + ">";
  	} else if (startTag == 2) {
  		rtnRst = "</" + tagName + ">";
  	} else if (startTag == 0) {
  		rtnRst = convertTag;
  	}
  
  	return rtnRst;
  }

  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=utf-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      
	
	response.setHeader("cache-control", "no-cache");
	response.setHeader("pragma", "no-cache");
	response.setHeader("expires", "Mon 1 Jan 1990 00:00:00 GMT");
	

	User user = HrmUserVarify.getUser (request , response) ;
	if(user == null)  return ;
	Log logger= LogFactory.getLog(this.getClass());
	String isIE = (String)session.getAttribute("browser_isie");

      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.docs.docs.DocManager docManager;
      docManager = (weaver.docs.docs.DocManager) pageContext.getAttribute("docManager");
      if (docManager == null) {
        docManager = new weaver.docs.docs.DocManager();
        pageContext.setAttribute("docManager", docManager);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.docs.DocDetailLog docDetailLog;
      docDetailLog = (weaver.docs.DocDetailLog) pageContext.getAttribute("docDetailLog");
      if (docDetailLog == null) {
        docDetailLog = new weaver.docs.DocDetailLog();
        pageContext.setAttribute("docDetailLog", docDetailLog);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.conn.RecordSet rs;
      rs = (weaver.conn.RecordSet) pageContext.getAttribute("rs");
      if (rs == null) {
        rs = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs", rs);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.docs.docs.DocImageManager docImageManager;
      docImageManager = (weaver.docs.docs.DocImageManager) pageContext.getAttribute("docImageManager");
      if (docImageManager == null) {
        docImageManager = new weaver.docs.docs.DocImageManager();
        pageContext.setAttribute("docImageManager", docImageManager);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.hrm.resource.ResourceComInfo resourceComInfo;
      resourceComInfo = (weaver.hrm.resource.ResourceComInfo) pageContext.getAttribute("resourceComInfo");
      if (resourceComInfo == null) {
        resourceComInfo = new weaver.hrm.resource.ResourceComInfo();
        pageContext.setAttribute("resourceComInfo", resourceComInfo);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.splitepage.operate.SpopForDoc spopForDoc;
      spopForDoc = (weaver.splitepage.operate.SpopForDoc) pageContext.getAttribute("spopForDoc");
      if (spopForDoc == null) {
        spopForDoc = new weaver.splitepage.operate.SpopForDoc();
        pageContext.setAttribute("spopForDoc", spopForDoc);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.conn.RecordSet recordSet;
      recordSet = (weaver.conn.RecordSet) pageContext.getAttribute("recordSet");
      if (recordSet == null) {
        recordSet = new weaver.conn.RecordSet();
        pageContext.setAttribute("recordSet", recordSet);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.docs.docmark.DocMark DocMark;
      DocMark = (weaver.docs.docmark.DocMark) pageContext.getAttribute("DocMark");
      if (DocMark == null) {
        DocMark = new weaver.docs.docmark.DocMark();
        pageContext.setAttribute("DocMark", DocMark);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.docs.category.SecCategoryComInfo SecCategoryComInfo;
      SecCategoryComInfo = (weaver.docs.category.SecCategoryComInfo) pageContext.getAttribute("SecCategoryComInfo");
      if (SecCategoryComInfo == null) {
        SecCategoryComInfo = new weaver.docs.category.SecCategoryComInfo();
        pageContext.setAttribute("SecCategoryComInfo", SecCategoryComInfo);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.docs.docs.DocComInfo dc;
      dc = (weaver.docs.docs.DocComInfo) pageContext.getAttribute("dc");
      if (dc == null) {
        dc = new weaver.docs.docs.DocComInfo();
        pageContext.setAttribute("dc", dc);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.docs.docs.DocViewer DocViewer;
      DocViewer = (weaver.docs.docs.DocViewer) pageContext.getAttribute("DocViewer");
      if (DocViewer == null) {
        DocViewer = new weaver.docs.docs.DocViewer();
        pageContext.setAttribute("DocViewer", DocViewer);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      
	int status = 1;String msg = ""; 
	JSONObject json = new JSONObject();
	request.setCharacterEncoding("UTF-8");
	response.setContentType("application/json;charset=UTF-8");
	String operate = Util.null2String(request.getParameter("operate"));
	int userid=user.getUID();
	//int userid=1;
	try{
		if(operate.equals("getDocById")){//\u6839\u636eID\u83b7\u53d6\u6587\u6863\u4fe1\u606f
			int docid = Util.getIntValue(request.getParameter("docid"),0);
			if(docid!=0){
				JSONObject doc = new JSONObject();
				//\u4ece\u6587\u6863\u7f13\u5b58\u83b7\u53d6\u6587\u6863
				docManager.resetParameter();
				docManager.setId(docid);
				docManager.getDocInfoById();
				String docstatus=docManager.getDocstatus();
				String parentids = docManager.getParentids();
				int ishistory = docManager.getIsHistory();
				//\u5224\u65ad\u6743\u9650
				String userType = ""+user.getType();
				String userdepartment = ""+user.getUserDepartment();
				String usersubcomany = ""+user.getUserSubCompany1();
				String logintype = user.getLogintype();
				String userSeclevel = user.getSeclevel();
				String userSeclevelCheck = userSeclevel;
				if("2".equals(logintype)){
					userdepartment="0";
					usersubcomany="0";
					userSeclevel="0";
				}
				int maincategory=docManager.getMaincategory();
				int subcategory=docManager.getSubcategory();
				int seccategory=docManager.getSeccategory();
				recordSet.executeProc("Doc_SecCategory_SelectByID",seccategory+"");
				recordSet.next();
				String readerCanViewHistoryEdition=Util.null2String(recordSet.getString("readerCanViewHistoryEdition"));

				String userInfo=logintype+"_"+userid+"_"+userSeclevelCheck+"_"+userType+"_"+userdepartment+"_"+usersubcomany;
				List PdocList = spopForDoc.getDocOpratePopedom(""+docid,userInfo);
				//0:\u67e5\u770b  
				boolean canReader = false;
				//1:\u7f16\u8f91
				boolean canEdit = false;
				//2:\u5220\u9664
				boolean canDel = false;
				//3:\u5171\u4eab
				boolean canShare = false ;
				//4:\u65e5\u5fd7
				boolean canViewLog = false;
				//5:\u53ef\u4ee5\u56de\u590d
				boolean canReplay = false;
				//6:\u6253\u5370
				boolean canPrint = false;
				//7:\u53d1\u5e03
				boolean canPublish = false;
				//8:\u5931\u6548
				boolean canInvalidate = false;
				//9:\u5f52\u6863
				boolean canArchive = false;
				//10:\u4f5c\u5e9f
				boolean canCancel = false;
				//11:\u91cd\u65b0\u6253\u5f00
				boolean canReopen = false;
				//\u7b7e\u51fa
				boolean canCheckOut = false;
				//\u7b7e\u5165
				boolean canCheckIn = false;
				//\u5f3a\u5236\u7b7e\u5165
				boolean canCheckInCompellably =false ;
				//\u65b0\u5efa\u5de5\u4f5c\u6d41
				boolean cannewworkflow = true;
				//TD12005\u4e0d\u53ef\u4e0b\u8f7d
				boolean canDownloadFromShare = false;

				if (((String)PdocList.get(0)).equals("true")) canReader = true ;
				if (((String)PdocList.get(1)).equals("true")) canEdit = true ;
				if (((String)PdocList.get(2)).equals("true")) canDel = true ;
				if (((String)PdocList.get(3)).equals("true")) canShare = true ;
				if (((String)PdocList.get(4)).equals("true")) canViewLog = true ;
				if (((String)PdocList.get(5)).equals("true")) canDownloadFromShare = true ;//TD12005

				if(canReader && ((!docstatus.equals("7")&&!docstatus.equals("8")) 
				                  ||(docstatus.equals("7")&&ishistory==1&&readerCanViewHistoryEdition.equals("1"))
								  )){
				    canReader = true;
				}else{
				    canReader = false;
				}

				//\u662f\u5426\u53ef\u4ee5\u67e5\u770b\u5386\u53f2\u7248\u672c
				//\u5177\u6709\u7f16\u8f91\u6743\u9650\u7684\u7528\u6237\uff0c\u59cb\u7ec8\u53ef\u89c1\u6587\u6863\u7684\u5386\u53f2\u7248\u672c\uff1b
				//\u53ef\u4ee5\u8bbe\u7f6e\u5177\u6709\u53ea\u8bfb\u6743\u9650\u7684\u64cd\u4f5c\u4eba\u662f\u5426\u53ef\u89c1\u5386\u53f2\u7248\u672c\uff1b

				if(ishistory==1) {
					//if(SecCategoryComInfo.isReaderCanViewHistoryEdition(seccategory)){
					if(readerCanViewHistoryEdition.equals("1")){
				    	if(canReader && !canEdit) canReader = true;
					} else {
					    if(canReader && !canEdit) canReader = false;
					}
				}	

				//\u7f16\u8f91\u6743\u9650\u64cd\u4f5c\u8005\u53ef\u67e5\u770b\u6587\u6863\u72b6\u6001\u4e3a\uff1a\u201c\u5ba1\u6279\u201d\u3001\u201c\u5f52\u6863\u201d\u3001\u201c\u5f85\u53d1\u5e03\u201d\u6216\u5386\u53f2\u6587\u6863
				if(canEdit && ((docstatus.equals("3") || docstatus.equals("5") || docstatus.equals("6") || docstatus.equals("7")) || ishistory==1)) {
					//canEdit = false;
				    canReader = true;
				}
				if(!canReader){//zhw20170929 \u6ca1\u6709\u67e5\u770b\u6743\u9650,\u5224\u65ad\u662f\u5426\u4ece\u65e5\u7a0b\u70b9\u51fb\u8fc7\u6765\u7684\u6587\u6863(\u540e\u7eed\u8865\u5145\u5f53\u524d\u4eba\u662f\u5426\u6709\u6743\u9650\u67e5\u770b\u8be5\u65e5\u7a0b)
					int workplanid = Util.getIntValue(request.getParameter("workplanid"),0);
					if(workplanid!=0){
						String sdocid = "";
						if(!"oracle".equals(rs.getDBType())){
							sdocid = "(','+docid+',')";
						}else{
							sdocid = "(,||docid||,)";
						}
						rs.executeSql("select 1 from WorkPlan where id = "+workplanid+" and "+sdocid+" like '%,"+docid+",%' ");
						if(rs.next()){
							canReader = true;
						}
					}
				}
				//System.out.println(canReader+"===============");
				if(canReader){
					String docsubject=docManager.getDocsubject();//\u6587\u6863\u6807\u9898
					String doccontent=docManager.getDoccontent();//\u6587\u6863\u5185\u5bb9
					String docpublishtype=docManager.getDocpublishtype();//\u53d1\u5e03\u7c7b\u578b
					if(docpublishtype.equals("2")){
						int tmppos = doccontent.indexOf("!@#$%^&*");
						if(tmppos!=-1) doccontent = doccontent.substring(tmppos+8,doccontent.length());
					}
					doccontent = Util.replace(doccontent, "&amp;", "&", 0);
					doccontent = doccontent.replaceAll("<title>((.|\n)*?)</title>", "");//\u5904\u7406word\u5bfc\u5165\u4e2d\u5e26\u5165\u7684title
					doccontent = doccontent.replaceAll("\u3000", "#SBCnbsp;");//\u5904\u7406\u5168\u89d2\u7a7a\u683c\u4e22\u5931\u95ee\u9898
					
					Whitelist user_content_filter = Whitelist.relaxed();

					user_content_filter.addTags("embed","object","param","span","div","video");
					user_content_filter.addAttributes(":all", "style", "class", "id", "name");
					user_content_filter.addAttributes("object", "width", "height","classid","codebase");	
					user_content_filter.addAttributes("param", "name", "value");
					user_content_filter.addAttributes("embed", "src","quality","width","height","allowFullScreen","allowScriptAccess","flashvars","name","type","pluginspage");
					user_content_filter.addAttributes("video", "src", "style", "controls", "autoplay", "loop", "preload");
					
					String placeholderUri = "http://WeaverReservedURL";
					int isJsonp = Util.getIntValue(Prop.getPropValue("wx_docset","isJsonp"),0);
					if(isJsonp==1){//\u662f\u5426\u9700\u8981\u7ecf\u8fc7JSONP\u5904\u7406
						doccontent = Jsoup.clean(doccontent, placeholderUri, user_content_filter);
					}
					doccontent = doccontent.replace(placeholderUri, "");
					doccontent = doccontent.replace("#SBCnbsp;", "\u3000");//\u5904\u7406\u5168\u89d2\u7a7a\u683c\u4e22\u5931\u95ee\u9898
					doccontent = translateMarkup(doccontent);
					
					//\u589e\u52a0\u67e5\u770b\u65e5\u5fd7\u8bb0\u5f55
					int doccreaterid=docManager.getDoccreaterid();
					
					//String logintype = "1";
					String usertype=docManager.getUsertype();
					char flag=Util.getSeparator();
					if(userid != doccreaterid || !usertype.equals(logintype)){
					    rs.executeProc("docReadTag_AddByUser",""+docid+flag+userid+flag+logintype); 
					    docDetailLog.resetParameter();
					    docDetailLog.setDocId(docid);
					    docDetailLog.setDocSubject(docsubject);
					    docDetailLog.setOperateType("0");
					    docDetailLog.setOperateUserid(userid);
					    docDetailLog.setUsertype(logintype);
					    docDetailLog.setClientAddress(request.getRemoteAddr());
					    docDetailLog.setDocCreater(doccreaterid);
					    docDetailLog.setDocLogInfo();
					}
					String lastModifyer = resourceComInfo.getLastname(docManager.getDoclastmoduserid()+"");
					String lastModfyTime = docManager.getDoclastmoddate()+"&nbsp;"+docManager.getDoclastmodtime();
					String creater = resourceComInfo.getLastname(docManager.getDoccreaterid()+"");
					String createTime = docManager.getDoccreatedate()+"&nbsp;"+docManager.getDoccreatetime();
					String owner = resourceComInfo.getLastname(docManager.getOwnerid()+"");
					
					doc.put("doccontent", doccontent);
					doc.put("docsubject", docsubject);
					//doc.put("ifHasNew", ifHasNew);
					doc.put("lastModifyer", lastModifyer);
					doc.put("lastModfyTime", lastModfyTime);
					doc.put("creater", creater);
					doc.put("createrImg", resourceComInfo.getMessagerUrls(docManager.getDoccreaterid()+""));
					doc.put("createTime", createTime);
					doc.put("createDate", docManager.getDoccreatedate());
					doc.put("owner", owner);
					//\u83b7\u53d6\u9644\u4ef6
					JSONArray js = new JSONArray();
					int docImageId = 0;
					String oldCurimgid = "";
					rs.executeSql("select * from DocImageFile where docid="+docid+" and (isextfile <> '1' or isextfile is null) and docfiletype <> '1' order by versionId desc");
					if(rs.next()) {
				        String curimgid = rs.getString("imagefileid");
				        oldCurimgid = curimgid;
				        long docImagefileSize = docImageManager.getImageFileSize(Util.getIntValue(curimgid));
				        String docImagefilename = Util.null2String(rs.getString("imagefilename"));
				        String docImagefileSizeStr = "";
				        if(docImagefileSize / (1024 * 1024) > 0) {
				        	docImagefileSizeStr = (docImagefileSize / 1024 / 1024) + "M";
				        } else if(docImagefileSize / 1024 > 0) {
				        	docImagefileSizeStr = (docImagefileSize / 1024) + "K";
				        } else {
				        	docImagefileSizeStr = docImagefileSize + "B";
				        }
				        int idx = docImagefilename.length() - 200;
				        String urlfilename = (idx > 0) ? docImagefilename.substring(idx, docImagefilename.length()) : docImagefilename;
				        urlfilename = java.net.URLEncoder.encode(urlfilename,"UTF-8");
				        JSONObject fj = new JSONObject();
				        fj.put("name", docImagefilename);
				        fj.put("urlfilename", urlfilename);
				        fj.put("size", docImagefileSizeStr);
				        fj.put("fileid", curimgid);
				        js.add(fj);
					}
				    docImageManager.resetParameter();
				    docImageManager.setDocid(docid);
				    docImageManager.selectDocImageInfo();
				    while (docImageManager.next()) {
				        int temdiid = docImageManager.getId();
				        if (temdiid == docImageId) {
				            continue;
				        }
				        docImageId = temdiid;
				        String curimgid = docImageManager.getImagefileid();
				        if(oldCurimgid.equals(curimgid)){
				        	continue;
				        }
				       
				        String curimgname = docImageManager.getImagefilename();
				        String docFileType = docImageManager.getDocfiletype();
				        long docImagefileSize = docImageManager.getImageFileSize(Util.getIntValue(curimgid));
				        String docImagefilename = Util.null2String(docImageManager.getImagefilename());
				        String docImagefileSizeStr = "";
				        if(docImagefileSize / (1024 * 1024) > 0) {
				        	docImagefileSizeStr = (docImagefileSize / 1024 / 1024) + "M";
				        } else if(docImagefileSize / 1024 > 0) {
				        	docImagefileSizeStr = (docImagefileSize / 1024) + "K";
				        } else {
				        	docImagefileSizeStr = docImagefileSize + "B";
				        }
				        
				        int idx = docImagefilename.length() - 200;
				        String urlfilename = (idx > 0) ? docImagefilename.substring(idx, docImagefilename.length()) : docImagefilename;
				        urlfilename = java.net.URLEncoder.encode(urlfilename,"UTF-8");
				        JSONObject fj = new JSONObject();
				        fj.put("name", docImagefilename);
				        fj.put("urlfilename", urlfilename);
				        fj.put("size", docImagefileSizeStr);
				        fj.put("fileid", curimgid);
				        js.add(fj);
					}
				    doc.put("fj",js);
				    doc.put("canDownload",canDownloadFromShare);
				    //\u83b7\u53d6\u6587\u6863\u56de\u590d \u5224\u65ad\u662f\u5426\u542f\u7528\u4e86\u65b0\u7248\u672c\u7684\u56de\u590d
				    boolean isUseNewReply = false;
				    try{
						Class mcu = Class.forName("weaver.docs.docs.reply.DocReplyUtil");
						Method m = mcu.getMethod("isUseNewReply"); 		
						isUseNewReply = (Boolean)m.invoke(mcu);
					}catch(Exception e){
						//e.printStackTrace();
					}
				    doc.put("isUseNewReply", isUseNewReply);//true\u542f\u7528\u4e86\u65b0\u7248\u672c\u7684\u56de\u590d\u529f\u80fd
				    if(isUseNewReply){//\u5982\u679c\u542f\u7528\u4e86\u65b0\u7248\u672c\u7684\u56de\u590d\u529f\u80fd
				    	//\u83b7\u53d6\u70b9\u8d5e\u6570\u636e
				    	String sql = "SELECT ID,USERID,PRAISE_ID,PRAISE_TYPE,PRAISE_DATE,PRAISE_TIME FROM PRAISE_INFO "+
				    			"WHERE PRAISE_TYPE = 0 AND DOCID = " + docid+" order by PRAISE_DATE desc,PRAISE_TIME desc";
			            rs.executeSql(sql);
			            int praiseCount = 0;//\u70b9\u8d5e\u603b\u6570
			            JSONObject praise = new JSONObject();
			            JSONArray praiseList = new JSONArray();
			            DepartmentComInfo departmentComInfo = new DepartmentComInfo();
			    		SubCompanyComInfo subCompanyComInfo = new SubCompanyComInfo();
			    		JobTitlesComInfo jobTitlesComInfo = new JobTitlesComInfo();
			    		boolean ifMyPraise = false;
			            while(rs.next()){
			            	praiseCount++;
			            	JSONObject p = new JSONObject();
			            	String praiseUserid = Util.null2String(rs.getString("USERID"));
			            	if(praiseUserid.equals(userid+"")){
			            		ifMyPraise = true;
			            	}
			            	p.put("userid", praiseUserid);
			            	p.put("userName", resourceComInfo.getLastname(praiseUserid));
			            	p.put("userimg", resourceComInfo.getMessagerUrls(praiseUserid));
			            	p.put("praiseDate", Util.null2String(rs.getString("PRAISE_DATE")));
			            	p.put("praiseTime", Util.null2String(rs.getString("PRAISE_TIME")));
			            	String subCompanyID = resourceComInfo.getSubCompanyID(praiseUserid);//\u5206\u90e8id
							String departmentID = resourceComInfo.getDepartmentID(praiseUserid);//\u90e8\u95e8id
							String jobTitle = resourceComInfo.getJobTitle(praiseUserid);//\u5c97\u4f4did
							String subCompanyName = subCompanyComInfo.getSubCompanyname(subCompanyID);//\u5206\u90e8\u540d\u79f0
							String departmentName = departmentComInfo.getDepartmentname(departmentID);//\u90e8\u95e8\u540d\u79f0
							String jobTitlesName = jobTitlesComInfo.getJobTitlesname(jobTitle);	//\u5c97\u4f4d\u540d\u79f0
			            	p.put("userDepart", departmentName);
			            	p.put("userSubCompany", subCompanyName);
			            	p.put("userJobTitle", jobTitlesName);
			            	praiseList.add(p);
			            }
			            praise.put("ifMyPraise", ifMyPraise);
			            praise.put("count", praiseCount);
			            praise.put("praiseList", praiseList);
			            doc.put("praise",praise);
			            //\u540c\u6b65\u5386\u53f2\u56de\u590d\u6570\u636e
			            String csql = "select count(docid) as c from syn_old_reply where docid="+docid;
			            rs.executeSql(csql);
			            if(rs.next()){
			                if(rs.getInt("c") <= 0){
			                	try{
									Class drm = Class.forName("weaver.docs.docs.reply.DocReplyManager");
									Method m = drm.getMethod("synOldReplyData",String.class); 		
									m.invoke(drm.newInstance(),docid+"");
								}catch(Exception e){
									//e.printStackTrace();
								}
			                }
			            }
				    }
				    int readCount = 0;
				    String sql_readCount="select count(id)  from DocDetailLog where operatetype = 0 and docid =" + docid ;
		            if( user.getUID() != docManager.getDoccreaterid()|| !docManager.getUsertype().equals(user.getLogintype()) ) {
		                sql_readCount ="select count(id)+1  from DocDetailLog where operatetype = 0 and docid =" + docid ;
		            }
				    //String sql_readCount ="select sum(readCount) from docreadtag where (userid<>"+docManager.getDoccreaterid()+
				    //		" or usertype<>"+docManager.getUsertype()+") and docid =" + docid ;
		            //System.out.println(sql_readCount);
				    rs.execute(sql_readCount);
		            if(rs.next()){
		                readCount = Util.getIntValue(rs.getString(1),0) ;
		            }
				    doc.put("readCount", readCount);//\u9605\u8bfb\u6570\u91cf
				    doc.put("replyCount", docManager.getReplaydoccount());//\u56de\u590d\u6570\u91cf
				  	//\u83b7\u53d6\u56de\u590d\u6570\u636e
				    doc.put("comment",getDocReply(docid+"",resourceComInfo,"desc",isUseNewReply,(isUseNewReply?"-1":docid+""),userid));
				    String docreplyable=SecCategoryComInfo.getSecReplyAbles(""+seccategory);
				    doc.put("ifCanReply", docreplyable.equals("1")?true:false);
				    //\u83b7\u53d6\u6587\u6863\u8bc4\u5206\u8be6\u60c5
				    JSONObject mark = new JSONObject();
					boolean ifCanMark = DocMark.isAllowMark(seccategory+"");
				    if(ifCanMark){
				    	int docMarkCount = DocMark.getDocMarkCount(docid+""); //\u6253\u5206\u7684\u4e2a\u6570
						int docMarkSum = DocMark.getDocMarkSum(docid+"");   //\u603b\u5206
						double docMarkAve =MathUtil.round(DocMark.getDocMarkAve(docid+""),2);  //\u5e73\u5747\u5206
						mark.put("markCount",docMarkCount);
						mark.put("markSum",docMarkSum);
						mark.put("markAverage",docMarkAve);
						String strSql ="select * from docmark where docid="+docid+" and markHrmId="+userid;
						rs.executeSql(strSql);
						int myMark = 0;
						if(rs.next()){
							myMark = Util.getIntValue(rs.getString("mark"),0);
						}
						mark.put("myMark",myMark);
				    }
				    mark.put("ifCanMark", ifCanMark);
					doc.put("mark",mark);
					//\u83b7\u53d6\u56de\u590d\u8868\u5355\u6240\u9700\u8981\u7684\u4fe1\u606f
					JSONObject reply = new JSONObject();
					reply.put("docsubject", "RE:"+docsubject);
					reply.put("replydocid",docid);
					reply.put("usertype", logintype);
					reply.put("maincategory", maincategory);
					reply.put("subcategory", subcategory);
					reply.put("seccategory",seccategory );
					reply.put("docdepartmentid", userdepartment);
					reply.put("doclangurage", user.getLanguage());
					reply.put("parentids", parentids);
					reply.put("ownerid", user.getUID());
					doc.put("reply", reply);
					//\u662f\u5426\u662f\u590d\u5730\u5ba2\u6237
					int ifFdSSo = Util.getIntValue(Prop.getPropValue("fdcsdev","ifFdSSo"),0);
					if(ifFdSSo==1){//\u662f\u590d\u5730\u5ba2\u6237 \u589e\u52a0\u81ea\u5b9a\u4e49\u5c5e\u6027
						String gsbm = "",csdw = "",zsdw = "",wzzy = "";
						rs.executeSql("select gsbm,csdw,zsdw,wzzy from cus_fielddata where id = "+docid+" and scope = 'DocCustomFieldBySecCategory'");
						if(rs.next()){
							gsbm = Util.null2String(rs.getString("gsbm"));
							csdw = Util.null2String(rs.getString("csdw"));
							zsdw = Util.null2String(rs.getString("zsdw"));
							wzzy = Util.null2String(rs.getString("wzzy"));
						}
						doc.put("gsbm", gsbm);
						doc.put("csdw", csdw);
						doc.put("zsdw", zsdw);
						doc.put("wzzy", wzzy);
					}
					json.put("doc",doc);
					status = 0;
				}else{
					msg = "\u60a8\u65e0\u6743\u67e5\u770b\u6b64\u6587\u6863\u6216\u6570\u636e\u5df2\u88ab\u5220\u9664!";
				}
			}else{
				msg = "\u6ca1\u6709\u83b7\u53d6\u5230\u6587\u6863ID";
			}
		}else if(operate.equals("docReply")){
			int isUseNewReply = Util.getIntValue(request.getParameter("isUseNewReply"),0);
			if(isUseNewReply==1){//\u542f\u7528\u65b0\u7684\u56de\u590d\u529f\u80fd
				try{
					//request\u4e2d\u5fc5\u987b\u5305\u542b\u4ee5\u4e0b\u53c2\u6570
					//documentid \u6587\u6863ID 
					//replyid \u5f53\u524d\u88ab\u56de\u590d\u7684\u8282\u70b9ID,\u5982\u679c\u662f\u5bf9\u6587\u6863\u56de\u590d\u5219\u4e3a-1
					//replytype \u5bf9\u6587\u6863\u56de\u590d\u4e3a0 \u5bf9\u6587\u6863\u7684\u56de\u590d\u8fdb\u884c\u56de\u590d\u4e3a1
					//rownerid \u88ab\u56de\u590d\u4eba\u7684ID \u5982\u5f20\u4e09\u5bf9\u674e\u56db\u7684\u6587\u6863\u6216\u8005\u674e\u56db\u7684\u56de\u590d\u8fdb\u884c\u56de\u590d \u8fd9\u91cc\u5c31\u4e3a\u674e\u56db\u7684userid
					//replymainid: \u4e3b\u56de\u590did \u5982\u679c\u662f\u56de\u590d\u6587\u6863\u5219\u4e3a\u7a7a \u5426\u5219\u4e3a\u5f53\u524d\u8fd9\u6761\u56de\u590d\u7684parentid
					//docsubject \u56de\u590d\u7684\u5185\u5bb9
					Class docReply = Class.forName("weaver.docs.webservices.reply.DocReplyServiceForMobile");
					Method m = docReply.getDeclaredMethod("saveReply",HttpServletRequest.class,User.class);
					Map<String, Object> result = (Map<String, Object>)m.invoke(docReply.newInstance(),request,user);
					JSONObject jo = JSONObject.fromObject(result);
					if(jo.containsKey("result")&&jo.getString("result").equals("success")){
						status = 0;
					}else{
						msg = jo.containsKey("error")?jo.getString("error"):"\u64cd\u4f5c\u8fd4\u56de\u6570\u636e\u683c\u5f0f\u9519\u8bef";
					}
				}catch(Exception e){
					msg = "\u64cd\u4f5c\u5931\u8d25:"+e.getMessage();
				}
			}else{
				docManager.resetParameter();
				docManager.setClientAddress(this.getIpAddr(request));
				docManager.setUserid(user.getUID());
				docManager.setLanguageid(user.getLanguage());
				docManager.setUsertype(""+user.getLogintype());	 
				String message = docManager.UploadDoc(request);
				int docId=docManager.getId();
				dc.addDocInfoCache(""+docId);
				DocViewer.setDocShareByDoc(""+docId);
				rs.executeSql("update DocDetail set docStatus='1' where id="+docId);
				status = 0;
			}
		}else if(operate.equals("markDoc")){
			String docId = Util.null2String(request.getParameter("docid"));
			if(!docId.equals("")){
				String rdoMark = Util.null2String(request.getParameter("rdoMark"));//\u8bc4\u52061-5
				String remark = Util.fromScreen(Util.null2String(request.getParameter("remark")),7);//\u8bc4\u8bba   
				String currentDateStr = DocMark.getCurrentDayStr();
			    String marker = ""+user.getUID();            
			    String markId = DocMark.getMarkId(user,docId);
			    char flag = 2 ;
			    String ProcPara = "";  
		        if ("".equals(markId)){
		             ProcPara = docId;
		             ProcPara += flag  + ""+user.getLogintype() ;
		             ProcPara += flag  + ""+marker;
		             ProcPara += flag  + ""+rdoMark ;
		             ProcPara += flag  + ""+remark ;
		             ProcPara += flag  + ""+currentDateStr ;
		             rs.executeProc("DocMark_Insert",ProcPara);
		        }else{
		             ProcPara = markId ;
		             ProcPara += flag  + ""+docId ;
		             ProcPara += flag  + ""+user.getLogintype() ;
		             ProcPara += flag  + ""+marker ;
		             ProcPara += flag  + ""+rdoMark ;
		             ProcPara += flag  + ""+remark ;
		             ProcPara += flag  + ""+currentDateStr ;
		             rs.executeProc("DocMark_update",ProcPara);         
		        }
		        status = 0;
			}else{
				msg = "\u6ca1\u6709\u83b7\u53d6\u5230\u8981\u8bc4\u5206\u7684\u6587\u6863ID";
			}
		}else if(operate.equals("getFileHtmlId")){//\u6587\u6863\u5728\u7ebf\u67e5\u770b  \u8fd4\u56de\u89e3\u6790\u6210HTML\u9875\u9762\u7684\u9644\u4ef6ID
			int fileid = Util.getIntValue(request.getParameter("fileid"),0);
			int docid = Util.getIntValue(request.getParameter("docid"),0);
			if(fileid!=0){
				String imageFileName="";int fileSize = 0;
				rs.executeSql("select imagefilename,fileSize from ImageFile where imagefileid="+fileid);
				if(rs.next()){
					imageFileName = Util.null2String(rs.getString("imagefilename"));
					fileSize = Util.getIntValue(rs.getString("fileSize"),0);
				}
				if(imageFileName.toLowerCase().endsWith(".doc")||imageFileName.toLowerCase().endsWith(".docx")
						||imageFileName.toLowerCase().endsWith(".xls")||imageFileName.toLowerCase().endsWith(".xlsx")
						||imageFileName.toLowerCase().endsWith(".pdf")){
					int maxFileSize = Util.getIntValue(rs.getPropValue("docpreview","maxFileSize"),5);
					if(fileSize>maxFileSize*1024*1024){
						msg = "\u60a8\u67e5\u770b\u7684\u6587\u6863\u8fc7\u5927\uff0c\u8bf7\u4e0b\u8f7d\u6587\u6863\u540e\u67e5\u770b\u3002";
					}else{
						try{
							int versionId = 0;
							
							rs.executeSql("select * from DocImageFile where imagefileid="+fileid+""+((docid!=0)?(" and docid="+docid):"")+" order by versionId desc") ;
							if(rs.next()){
								versionId = Util.getIntValue(rs.getString("versionId"),0);
								if(docid==0) docid = Util.getIntValue(rs.getString("docid"),0);
							}
							Class pvm = Class.forName("weaver.docs.docpreview.DocPreviewHtmlManager");
							Method m = pvm.getDeclaredMethod("doFileConvert",int.class,String.class,String.class,int.class,int.class);
							Object htmlFileid = m.invoke(pvm.newInstance(),fileid,null,null,docid,versionId);
							json.put("htmlFileid",htmlFileid);
							json.put("imageFileName",imageFileName);
							//\u589e\u52a0\u4e0b\u8f7d\u65e5\u5fd7
							char flag=Util.getSeparator();
							String logintype = user.getLogintype();
							docManager.resetParameter();
							docManager.setId(docid);
							docManager.getDocInfoById();
						    rs.executeProc("docReadTag_AddByUser",""+docid+flag+userid+flag+logintype); 
						    docDetailLog.resetParameter();
						    docDetailLog.setDocId(docid);
						    docDetailLog.setDocSubject(docManager.getDocsubject());
						    docDetailLog.setOperateType("0");
						    docDetailLog.setOperateUserid(userid);
						    docDetailLog.setUsertype(logintype);
						    docDetailLog.setClientAddress(request.getRemoteAddr());
						    docDetailLog.setDocCreater(docManager.getDoccreaterid());
						    docDetailLog.setDocLogInfo();
							status = 0;
						}catch(Exception e){
							e.printStackTrace();
							msg = "\u6587\u6863\u5728\u7ebf\u9884\u89c8\u76ee\u524d\u53ea\u652f\u6301E8\u7cfb\u7edf\uff0cE7\u7cfb\u7edf\u6682\u65f6\u65e0\u6cd5\u4f7f\u7528";
						}
					}
				}else{
					msg = "\u8be5\u6587\u6863\u683c\u5f0f\u4e0d\u652f\u6301\u5728\u7ebf\u9884\u89c8\uff0c\u8bf7\u4e0b\u8f7d\u540e\u67e5\u770b";
				}
			}else{
				msg = "\u6ca1\u6709\u83b7\u53d6\u5230\u8981\u8f6c\u6362\u4e3aHTML\u683c\u5f0f\u7684\u9644\u4ef6ID\u6216\u6587\u6863ID";
			}
		}else if(operate.equals("praise")||operate.equals("unpraise")){//\u70b9\u8d5e\u548c\u53d6\u6d88\u70b9\u8d5e
			String docid = Util.null2String(request.getParameter("docid"));//\u6587\u6863ID
			int replyid = Util.getIntValue(request.getParameter("replyid"));//\u70b9\u8d5e\u7684\u8282\u70b9ID \u5982\u679c\u662f\u5bf9\u6587\u6863\u70b9\u8d5e\u5219\u4e3a\u6587\u6863ID\u5426\u5219\u662f\u6587\u6863\u56de\u590d\u7684ID
			int replytype = Util.getIntValue(request.getParameter("replytype"));//\u5bf9\u6587\u6863\u70b9\u8d5e\u4e3a0 \u5bf9\u56de\u590d\u70b9\u8d5e\u4e3a1
			try{
				//weaver.docs.webservices.reply.DocReplyServiceForMobile d = new weaver.docs.webservices.reply.DocReplyServiceForMobile();
				//Map<String, Object> result = d.praise(replyid, replytype, user, docid);
				Class docReply = Class.forName("weaver.docs.webservices.reply.DocReplyServiceForMobile");
				Method m = null;
				if(operate.equals("praise")){
					m = docReply.getMethod("praise",int.class,int.class,User.class,String.class);
				}else{
					m = docReply.getDeclaredMethod("unPraise",int.class,int.class,User.class,String.class);
				}
				Map<String, Object> result = (Map<String, Object>)m.invoke(docReply.newInstance(),replyid,replytype,user,docid);
				JSONObject jo = JSONObject.fromObject(result);
				if(jo.containsKey("result")&&jo.getString("result").equals("success")){
					status = 0;
				}else{
					msg = jo.containsKey("error")?jo.getString("error"):"\u64cd\u4f5c\u8fd4\u56de\u6570\u636e\u683c\u5f0f\u9519\u8bef";
				}
			}catch(Exception e){
				msg = "\u64cd\u4f5c\u5931\u8d25:"+e.getMessage();
			}
		}
	}catch(Exception e){
		e.printStackTrace();
		msg = e.getMessage();
	}
	json.put("status",status);
	json.put("msg",msg);
	//System.out.println(json.toString());
	out.println(json.toString());

      out.write(_jsp_string2, 0, _jsp_string2.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("mobile/plugin/plus/doc/data/docOperation.jsp"), 302771729006281667L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
    depend = new com.caucho.vfs.Depend(appDir.lookup("page/maint/common/initNoCache.jsp"), 3270256153856711871L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string1;
  private final static char []_jsp_string0;
  private final static char []_jsp_string2;
  static {
    _jsp_string1 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string2 = "\r\n".toCharArray();
  }
}
