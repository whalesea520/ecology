/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._mobile._plugin._plus._workflow._data;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import java.util.*;
import weaver.hrm.*;
import weaver.systeminfo.*;
import weaver.general.StaticObj;
import weaver.general.Util;
import weaver.hrm.settings.RemindSettings;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import net.sf.json.*;
import weaver.mobile.webservices.workflow.WorkflowRequestInfo;
import weaver.conn.RecordSet;
import weaver.general.*;
import weaver.file.Prop;
import java.lang.reflect.Method;
import weaver.wxinterface.FormatMultiLang;

public class _wfoperation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;

  
  	private String getWorkFlowTypes(int userid,String[] conditions){
  		String result = "";
  		try{
  			String select = " select distinct ";
  		    String fields = " t1.workflowid ";
  		    String from = " from workflow_requestbase t1,workflow_currentoperator t2 ";
  		    String where = " where t1.requestid=t2.requestid ";
  		    where += " and t2.usertype = 0 and t2.userid = " + userid;
  		    where += " and t2.islasttimes=1 ";
  		    where += " and t1.workflowID in (select id from workflow_base where isvalid in('1','3')) ";
  		    if (conditions != null){
  	            for (int m=0;m<conditions.length;m++) {
  	                String condition = conditions[m];
  	                where += (condition != null && !"".equals(condition)) ? " and " + condition : "";
  	            }
  		    }
  	        String sql = select + fields + from + where;
  	        RecordSet rs = new RecordSet();
  	        rs.executeSql(sql);
  	        while (rs.next()) {
  	            result += "," + rs.getString(1);
  	        }
  	        if (result.length() > 1) {
  	            result = result.substring(1);
  	        }
  		}catch(Exception e){
  			
  		}
  		return result;
  	}

  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("application/json");
    response.setCharacterEncoding("UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      
	
	response.setHeader("cache-control", "no-cache");
	response.setHeader("pragma", "no-cache");
	response.setHeader("expires", "Mon 1 Jan 1990 00:00:00 GMT");
	

	User user = HrmUserVarify.getUser (request , response) ;
	if(user == null)  return ;
	Log logger= LogFactory.getLog(this.getClass());
	String isIE = (String)session.getAttribute("browser_isie");

      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.resource.ResourceComInfo rc;
      rc = (weaver.hrm.resource.ResourceComInfo) pageContext.getAttribute("rc");
      if (rc == null) {
        rc = new weaver.hrm.resource.ResourceComInfo();
        pageContext.setAttribute("rc", rc);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.conn.RecordSet rs;
      rs = (weaver.conn.RecordSet) pageContext.getAttribute("rs");
      if (rs == null) {
        rs = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs", rs);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.mobile.webservices.workflow.WorkflowServiceImpl ws;
      ws = (weaver.mobile.webservices.workflow.WorkflowServiceImpl) pageContext.getAttribute("ws");
      if (ws == null) {
        ws = new weaver.mobile.webservices.workflow.WorkflowServiceImpl();
        pageContext.setAttribute("ws", ws);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      
out.clearBuffer();

request.setCharacterEncoding("UTF-8");
response.setContentType("application/json;charset=UTF-8");
String operation = Util.null2String(request.getParameter("operation"));
JSONObject json = new JSONObject();
String msg = "";int status = 1;
BaseBean bb = new BaseBean();
if(operation.equals("getDataList")){
	try{
		int pageSize = Util.getIntValue(request.getParameter("pagesize"),10);
		int pageIndex = Util.getIntValue(request.getParameter("pageindex"),1);
		String requestname = Util.null2String(request.getParameter("requestname"));//\u6807\u9898
		String workcode = Util.null2String(request.getParameter("workcode"));//\u7f16\u53f7
		int createid = Util.getIntValue(Util.null2String(request.getParameter("createid")), 0);//\u521b\u5efa\u4eba
		String createdatestart = Util.null2String(request.getParameter("createdatestart"));//\u521b\u5efa\u5f00\u59cb\u65e5\u671f
		String createdateend = Util.null2String(request.getParameter("createdateend"));//\u521b\u5efa\u7ed3\u675f\u65e5\u671f
		String receivedatestart = Util.null2String(request.getParameter("receivedatestart"));//\u63a5\u6536\u5f00\u59cb\u65e5\u671f
		String receivedateend = Util.null2String(request.getParameter("receivedateend"));//\u63a5\u6536\u7ed3\u675f\u65e5\u671f
		String setting = Util.null2String(request.getParameter("setting"));//\u6a21\u5757\u8bbe\u7f6e\u4e2d\u9009\u62e9\u7684\u6d41\u7a0b\u7c7b\u578b
		String workflowid = Util.null2String(request.getParameter("workflowid"));//\u67e5\u8be2\u9875\u9762\u4e2d\u9009\u62e9\u7684\u6d41\u7a0b\u7c7b\u578b
		int showcopy = Util.getIntValue(request.getParameter("showcopy"),0);//\u67e5\u8be2\u5f85\u529e\u65f6\u662f\u5426\u663e\u793a\u6284\u9001
		int archivestatus = Util.getIntValue(request.getParameter("archivestatus"),1);//\u6d41\u7a0b\u5f52\u6863\u72b6\u6001\uff1a1\uff1a\u5168\u90e8\uff0c 2\uff1a\u672a\u5f52\u6863\uff0c 3\uff1a\u5df2\u5f52\u6863
		int ifFirst = Util.getIntValue(request.getParameter("ifFirst"),0);//\u662f\u5426\u9996\u6b21\u52a0\u8f7d
		//\u67e5\u8be2\u7c7b\u578b -1019\u67e5\u8be2\u6240\u6709\u6d41\u7a0b -11000\u5f85\u529e -11001 \u5df2\u529e -11002 \u6211\u7684\u8bf7\u6c42
		int module = Util.getIntValue(request.getParameter("module"),0);
		String modules = Util.null2String(request.getParameter("modules"));// 1,2,3,4,5 \u5f85\u529e \u6284\u9001 \u5df2\u529e \u529e\u7ed3 \u6211\u7684\u8bf7\u6c42
		int settingType = Util.getIntValue(request.getParameter("settingType"),1);//1 \u5305\u542b 0\u6392\u9664
		List conditions = new ArrayList();
		boolean ifNewTable = false;
		if(module==-11000||module==-11001||(!modules.equals("")&&module==-1019)){
			if(rs.getDBType().equals("oracle")){
				rs.execute("select 1 from user_tab_cols where table_name='WORKFLOW_CURRENTOPERATOR' and column_name='TAKISREMARK'");
			}else{
				rs.execute("select 1 from syscolumns where name='takisremark' and id=object_id('workflow_currentoperator')");
			}
			if(rs.next()){
				ifNewTable = true;
			}
		}
		boolean ifNewRequestName = false;
		if(rs.getDBType().equals("oracle")){
			rs.execute("select 1 from user_tab_cols where table_name='WORKFLOW_REQUESTBASE' and column_name='REQUESTNAMENEW'");
		}else{
			rs.execute("select 1 from syscolumns where name='requestname' and id=object_id('workflow_requestbase')");
		}
		if(rs.next()){
			ifNewRequestName = true;
		}
		if(!modules.equals("")&&module==-1019&&!modules.equals("1,2,3,4,5")){
			String sql = "";
			if(modules.contains("1")){//\u5305\u542b\u5f85\u529e
				if(ifNewTable){
		        	sql = "((t2.isremark='0' and (t2.takisremark is null or t2.takisremark='0' )) or t2.isremark in ('1','5','7')) ";
		        }else{
		        	sql = "t2.isremark in ('0','1','5','7') ";
		        }
			}
			if(modules.contains("2")){//\u5305\u542b\u6284\u9001
		        sql += "or t2.isremark in ('8','9') ";
			}
			if(modules.contains("3")){//\u5305\u542b\u5df2\u529e
				if(ifNewTable){
					sql += "or ((t2.isremark in('2','4') or (t2.isremark=0 and t2.takisremark ='-2')) and t2.iscomplete=0) ";
				}else{
					sql += "or (t2.isremark in('2','4') and t2.iscomplete=0) ";
				}
			}
			if(modules.contains("4")){//\u5305\u542b\u529e\u7ed3
				//sql += "or (t2.isremark in ('2','4') and t1.currentnodetype = '3' and t2.iscomplete=1) ";
				sql += "or (t2.isremark in ('2','4') and t2.iscomplete=1) ";
			}
			if(modules.contains("5")){//\u5305\u542b\u6211\u7684\u8bf7\u6c42
				sql += "or ((t2.isremark is not null or t2.isremark !='') and t1.creater = " + 
						user.getUID() + " and t1.creatertype = 0) ";
			}
			if(sql.startsWith("or")){
				sql = sql.substring(2);
			}
			if(!sql.equals("")){
				sql = " ("+sql+")";
			}
			conditions.add(sql);
		}else{
			if(module==-11000){//\u67e5\u8be2\u5f85\u529e
				String remark = "'1','5','7'";
		        if (showcopy==1) {
		            remark += ",'8','9'";
		        }
		        if(ifNewTable){
		        	conditions.add(" ((t2.isremark='0' and (t2.takisremark is null or t2.takisremark='0' )) or t2.isremark in(" + remark + "))");
		        }else{
		        	conditions.add(" t2.isremark in ('0',"+remark+")");
		        }
			}else if(module==-11001){//\u67e5\u8be2\u5df2\u529e\u5305\u542b\u529e\u7ed3
				if(ifNewTable){
					conditions.add(" (t2.isremark in('2','4') or (t2.isremark=0 and t2.takisremark ='-2'))");
				}else{
					conditions.add(" t2.isremark in('2','4')");
				}
			}else if(module==-11002){//\u6211\u7684\u8bf7\u6c42
				conditions.add(" (t2.isremark is not null or t2.isremark !='') and t1.creater = " + 
						user.getUID() + " and t1.creatertype = 0 ");
			}
		}
		
		if(archivestatus!=1){
			if(archivestatus==2){//\u672a\u5f52\u6863
				conditions.add(" t2.iscomplete = 0 ");
			}else if(archivestatus==3){//\u5df2\u5f52\u6863
				conditions.add(" t2.iscomplete = 1 ");
			}
		}
		if(!requestname.equals("")) {//\u6807\u9898
			if(ifNewRequestName){
				conditions.add(" t1.requestnamenew like '%" + requestname + "%'");
			}else{
				conditions.add(" t1.requestname like '%" + requestname + "%'");
			}
		}
		if (!"".equals(workcode)){//\u7f16\u53f7
			conditions.add(" t1.requestmark like '%"+workcode+"%' ");
		}
		if (createid > 0) {//\u521b\u5efa\u4eba
		    conditions.add(" t1.creater=" + createid );
		}
		if (!"".equals(createdatestart)) {//\u521b\u5efa\u8d77\u59cb\u65e5\u671f
		    conditions.add(" t1.createdate>='" + createdatestart + "' ");
		}
		if (!"".equals(createdateend)) {//\u521b\u5efa\u7ed3\u675f\u65e5\u671f
		    conditions.add(" t1.createdate<='" + createdateend + "' ");
		}
		if (!"".equals(receivedatestart)) {//\u63a5\u6536\u8d77\u59cb\u65e5\u671f
		    conditions.add(" t2.receivedate>='" + receivedatestart + "' ");
		}
		if (!"".equals(receivedateend)) {//\u63a5\u6536\u7ed3\u675f\u65e5\u671f
		    conditions.add(" t2.receivedate<='" + receivedateend + "' ");
		}
		if (!"".equals(setting)) {//\u6a21\u5757\u8bbe\u7f6e\u4e2d\u9009\u62e9\u7684\u6d41\u7a0b\u7c7b\u578b
			String settings = "";
			try{			
				Class WorkflowVersion = Class.forName("weaver.workflow.workflow.WorkflowVersion");
				Method m = WorkflowVersion.getMethod("getAllVersionStringByWFIDs", String.class); 
				settings = (String)m.invoke(WorkflowVersion, setting);
			}catch (Exception e){
				settings = setting;
			}
			if(!"".equals(settings)){
				if(settingType==1){
					conditions.add(" t1.workflowid in (" + settings + ")");
				}else{
					conditions.add(" t1.workflowid not in (" + settings + ")");
				}
			}
		}
		if (!"".equals(workflowid)) {//\u67e5\u8be2\u9875\u9762\u9009\u62e9\u7684\u6d41\u7a0b\u7c7b\u578b
			String workflowids = "";
			try{			
				Class WorkflowVersion = Class.forName("weaver.workflow.workflow.WorkflowVersion");
				Method m = WorkflowVersion.getMethod("getAllVersionStringByWFIDs", String.class); 
				workflowids = (String)m.invoke(WorkflowVersion, workflowid);
			}catch (Exception e){
				workflowids = workflowid;
			}
			if(!"".equals(workflowids)){
				conditions.add(" t1.workflowid in (" + workflowids + ")");
			}
		}
		int ifFdSSo = Util.getIntValue(Prop.getPropValue("fdcsdev","ifFdSSo"),0);
		if(ifFdSSo==1){//\u662f\u590d\u5730\u5ba2\u6237 \u589e\u52a0\u5f02\u6784\u7cfb\u7edf\u67e5\u8be2\u6761\u4ef6
			String sysid = Util.null2String(request.getParameter("sysid"));//\u5f02\u6784\u7cfb\u7edfID
			if(!sysid.equals("")){
				conditions.add(" sysid in ("+sysid+")");
			}
		}
		conditions.add("");
		String[] strconditions = new String[conditions.size()];
		conditions.toArray(strconditions);
		//String where = "";
		//for (int m=0;m<strconditions.length;m++) {
		//	String condition = strconditions[m];
		//	where += (condition != null && !"".equals(condition)) ? " and " + condition : "";
		//}
		//System.out.println(where);
		int count = ws.getAllWorkflowRequestCount(user.getUID(), strconditions);
		if(ifFdSSo==1){//\u662f\u590d\u5730\u5ba2\u6237 \u589e\u52a0\u6392\u5e8f\u6761\u4ef6\u8bbe\u7f6e
			String orderby = Util.null2String(request.getParameter("orderby"));//\u6392\u5e8f
			if(orderby.equals("")){
				orderby = "desc";
			}
			strconditions[strconditions.length-1] = " order by t2.receivedate "+orderby+",t2.receivetime "+orderby+",t1.requestid "+orderby;
		}
		WorkflowRequestInfo[] wris = ws.getAllWorkflowRequestList(pageIndex, pageSize, count, user.getUID(), strconditions);
		int pageCount = 0;
		int isHavePre = 0;
		int isHaveNext = 0;
		JSONArray list = new JSONArray();
		if (count <= 0) pageCount = 0;
		pageCount = count / pageSize + ((count % pageSize > 0)?1:0);
		isHaveNext = (pageIndex + 1 <= pageCount)?1:0;
		isHavePre = (pageIndex - 1 >= 1)?1:0;
		List<WorkflowRequestInfo> datas = Arrays.asList(wris);
		String[] requestids = new String[datas.size()];
		int i=0;
		for(WorkflowRequestInfo wri:datas) {
			requestids[i] = wri.getRequestId();
			i++;
			JSONObject newdata = new JSONObject();
			newdata.put("time", Util.null2String(wri.getReceiveTime()));
			newdata.put("image", Util.null2String(rc.getMessagerUrls(wri.getCreatorId())));
			newdata.put("id", Util.null2String(wri.getRequestId()));
			newdata.put("subject", Util.null2String(wri.getRequestName()).replace("&quot;", "\""));
			String description = "" +
					 "[" +Util.null2String(wri.getWorkflowBaseInfo().getWorkflowName())+ "]" +
					 "   \u521b\u5efa\u4eba :  " +Util.null2String(wri.getCreatorName())+
					 "   \u63a5\u6536\u65f6\u95f4 : " +Util.null2String(wri.getReceiveTime())+
					 "   \u6d41\u7a0b\u72b6\u6001 : " +Util.null2String(wri.getStatus())+
					 "   \u521b\u5efa\u65f6\u95f4 : " +Util.null2String(wri.getCreateTime());
			description = FormatMultiLang.formatByUserid(description,user.getUID()+"");
			newdata.put("description", description);
			//newdata.put("f_weaver_belongto_userid", Util.null2String(wri.getWorkflowBaseInfo().getF_weaver_belongto_userid()));
			//newdata.put("f_weaver_belongto_usertype", Util.null2String(wri.getWorkflowBaseInfo().getF_weaver_belongto_usertype()));
			//newdata.put("url", Util.null2String(wri.getAppurl()));
			list.add(newdata);
		}
   		if (requestids.length > 0) {
   			String[] newflagarray = ws.getWorkflowNewFlag(requestids, user.getUID()+"");
   			if(newflagarray!=null&&newflagarray.length==requestids.length){
   				for(i=0;i<requestids.length;i++){
   					JSONObject newdata = list.getJSONObject(i);
   					newdata.put("isnew", newflagarray[i]);
   				}
   			}
   		}
   		if(ifFirst==1){
   			String listtypes = getWorkFlowTypes(user.getUID(),strconditions);
   			json.put("listtypes", listtypes);
   			if(ifFdSSo==1){//\u83b7\u53d6\u5f02\u6784\u7cfb\u7edf\u6570\u636e
   				rs.executeSql("select sysid,syscode,sysfullname from ofs_sysinfo order by sysid");
   				JSONArray ja = new JSONArray();
   				while(rs.next()){
   					JSONObject jo = new JSONObject();
   					String sysid = Util.null2String(rs.getString("sysid"));
   					String syscode = Util.null2String(rs.getString("syscode"));
   					String sysfullname = Util.null2String(rs.getString("sysfullname"));
   					jo.put("sysid", sysid);
   					jo.put("syscode", syscode);
   					jo.put("sysfullname", sysfullname);
   					ja.add(jo);
   				}
   				json.put("syslist", ja);
   			}
   		}
		json.put("pageindex", pageIndex);
		json.put("pagesize", pageSize);
		json.put("ishavepre", isHavePre);
		json.put("ishavenext", isHaveNext);
		json.put("count", count);
		json.put("pagecount", pageCount);
		json.put("list", list);
		//\u83b7\u53d6\u6d41\u7a0b\u63a8\u9001\u8bbe\u7f6e
		if(ifFdSSo==1){
			int settype = 1;
			rs.executeSql("select settype from FdWFMsgSet where userid = "+user.getUID());
			if(rs.next()){
				settype = Util.getIntValue(rs.getString("settype"));
			}
			json.put("settype", settype);
		}
	}catch(Exception e){
		//e.printStackTrace();
		msg = e.getMessage();
	}
}else if(operation.equals("setWFMsg")){
	int value = Util.getIntValue(request.getParameter("value"));
	rs.executeSql("delete from FdWFMsgSet where userid = "+user.getUID());
	boolean flag = rs.executeSql("insert into FdWFMsgSet (userid,settype) values ("+user.getUID()+","+value+")");
	if(flag){
		status = 0;
	}else{
		msg = "\u6267\u884c\u4fdd\u5b58\u52a8\u4f5c\u5931\u8d25:\u4fdd\u5b58\u6570\u636e\u5e93\u51fa\u9519";
	}
	json.put("status", status);
	json.put("msg", msg);
}
//System.out.println(json.toString());
out.print(json.toString());

      out.write(_jsp_string2, 0, _jsp_string2.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("mobile/plugin/plus/workflow/data/wfOperation.jsp"), -7752171719599960312L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
    depend = new com.caucho.vfs.Depend(appDir.lookup("page/maint/common/initNoCache.jsp"), 3270256153856711871L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string2;
  private final static char []_jsp_string1;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string2 = "\r\n".toCharArray();
    _jsp_string1 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
  }
}
