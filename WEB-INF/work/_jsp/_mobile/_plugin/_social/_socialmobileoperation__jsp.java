/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._mobile._plugin._social;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.mobile.plugin.ecology.service.PluginServiceImpl;
import java.util.Map;
import java.util.List;
import java.util.HashMap;
import java.util.UUID;
import weaver.hrm.HrmUserVarify;
import weaver.hrm.User;
import java.util.Enumeration;
import weaver.file.FileUpload;
import java.net.URLDecoder;
import weaver.general.Util;
import net.sf.json.JSONObject;
import net.sf.json.JSONArray;
import weaver.rdeploy.task.TaskUtil;
import weaver.general.TimeUtil;
import weaver.favourite.FavouriteInfo;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import weaver.social.rdeploy.im.IMService;
import weaver.social.im.SocialIMClient;

public class _socialmobileoperation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.social.service.SocialIMService SocialIMService;
      SocialIMService = (weaver.social.service.SocialIMService) pageContext.getAttribute("SocialIMService");
      if (SocialIMService == null) {
        SocialIMService = new weaver.social.service.SocialIMService();
        pageContext.setAttribute("SocialIMService", SocialIMService);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet RecordSet;
      RecordSet = (weaver.conn.RecordSet) pageContext.getAttribute("RecordSet");
      if (RecordSet == null) {
        RecordSet = new weaver.conn.RecordSet();
        pageContext.setAttribute("RecordSet", RecordSet);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.social.service.SocialIMFavourate SocialIMFavourate;
      SocialIMFavourate = (weaver.social.service.SocialIMFavourate) pageContext.getAttribute("SocialIMFavourate");
      if (SocialIMFavourate == null) {
        SocialIMFavourate = new weaver.social.service.SocialIMFavourate();
        pageContext.setAttribute("SocialIMFavourate", SocialIMFavourate);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      
request.setCharacterEncoding("UTF-8");
response.setContentType("text/html;charset=UTF-8");
FileUpload fu=new FileUpload(request);
PluginServiceImpl ps = new PluginServiceImpl();
Map<String,Object> param=new HashMap<String, Object>();
User user = HrmUserVarify.getUser(request, response);
if (user == null) return;
String userid = user.getUID()+"";
//String userid = Util.null2String(fu.getParameter("userid"));//"462";//lx4
//\u83b7\u53d6\u6240\u6709\u8bf7\u6c42\u53c2\u6570
Enumeration enu=fu.getParameterNames();
while(enu.hasMoreElements()){
	String paraName=(String)enu.nextElement();
	String value=Util.null2String(fu.getParameter(paraName));
    
	if(!paraName.equals("request")&&!paraName.equals("response")&&!paraName.equals("sessionkey"))
		param.put(paraName, value);
	if(paraName.equals("content")){
		param.put("content",URLDecoder.decode(value,"utf-8"));
	}
}

String uid=Util.null2String((String)fu.getParameter("userid"));
String operation=Util.null2String((String)fu.getParameter("operation"));

Log logger= LogFactory.getLog(this.getClass());

Map result=new HashMap();
if(operation.equals("doShareIMFile")){ //\u5206\u4eab\u9644\u4ef6
	
	String shareid = Util.null2String(fu.getParameter("shareid"));
	String targetid = Util.null2String(fu.getParameter("targetid"));
	String fileid = Util.null2String(fu.getParameter("fileid"));
	String resourceids = Util.null2String(fu.getParameter("resourceids"));
	String resourcetype = Util.null2s(fu.getParameter("resourcetype"), "1");
	boolean status=SocialIMService.addIMFileByFileid(shareid,fileid,targetid,resourceids,resourcetype);
	//boolean status_0 = ChatResourceShareManager.addShare(resourcetype, shareid, uid, targetType.equals("1")?targetid:"", resourceids);
	//boolean status_0=IMService.saveChatResource(uid,targetType.equals("1")?targetid:"",Integer.parseInt(shareid),0, resourceids);
	result.put("status",status?"1":"0");
	
}
else if(operation.equals("savefavourate")){				//\u6536\u85cf
	String favInfo = Util.null2String(fu.getParameter("favInfo"));
	uid = Util.null2String(fu.getParameter("userid"));
	//userid \u9a8c\u8bc1
	if(userid.equals(uid)){
		JSONObject fav = null;
		try{
			favInfo = favInfo.replaceAll("\r","").replaceAll("\n","");
			fav = JSONObject.fromObject(favInfo);
			String favid = fav.optString("favid"); 
		}catch(Exception e){
			logger.error("!!savefavourate error!!"+e.toString());
		}
		String msg = SocialIMFavourate.saveFavourate(uid, fav); 
		//JSONObject result = new JSONObject();
		int sIndex = msg.indexOf("|");
		if(msg.startsWith("|")){
			result.put("issuccess",1);
			result.put("id", msg.substring(sIndex+1, msg.length()));
		}else{
			result.put("issuccess",0);
			result.put("errormsg", msg.substring(0, sIndex));
		}
	}else{
		result.put("issuccess",0);
		result.put("errormsg", "bad userid!");
	}
}
else if(operation.equals("getfavourate")){					//\u83b7\u53d6\u6211\u7684\u6536\u85cf
	uid = Util.null2String(fu.getParameter("userid"));
	if(userid.equals(uid)){
		String pageno = Util.null2String(fu.getParameter("page"));
		String pagesize = Util.null2String(fu.getParameter("pagesize"));
		//\u641c\u7d22\u6807\u9898
		String keyWord = Util.null2String(fu.getParameter("key_word"));
		//\u641c\u7d22\u7c7b\u578b 0\u8868\u793a\u5168\u90e8\uff0c1\u8868\u793a\u6d88\u606f\u7c7b\u578b\uff0c2\u8868\u793a\u56fe\u7247\u7c7b\u578b
		String style = Util.null2String(fu.getParameter("style"));
		//\u91cd\u8981\u7ea7\u522b 0\u8868\u793a\u5168\u90e8 1 
		String importantLevel = Util.null2String(fu.getParameter("important_level"));
		//\u76ee\u5f55ID
		String location = Util.null2String(fu.getParameter("location"));
		Map<String, String> condis = new HashMap<String,String>();
		condis.put("pagename", keyWord);
		condis.put("style", style);
		condis.put("importlevel", importantLevel);
		condis.put("favouriteids", location);
		if("".equals(uid)){
			uid = userid;
		}
		//\u67e5\u8be2\u6211\u7684\u6536\u85cf
		List<Map<String, String>> favList = SocialIMFavourate.getFavourate(uid,pageno,pagesize,condis);
		//JSONObject result = new JSONObject();
		String totalPage;
		if(favList.size() <= 0){
			result.put("favlist", "");
			
		}else{
			Map<String, String> map = favList.get(0);
			if(map.containsKey("totalPage")){
				totalPage = map.get("totalPage");
				favList.remove(0);
			}
			JSONArray favjsary = JSONArray.fromObject(favList);
			favList.clear();
			favList = null;
			result.put("favlist", favjsary);
			//result.put("favinfos", JSONObject.fromObject(favinfos));
		}
	}else{
		result.put("errormsg", "bad userid!");
	}
}
else if(operation.equals("addtask")){		//\u521b\u5efa\u4efb\u52a1
	String tasktitle = Util.null2String(fu.getParameter("tasktitle"));
	String taskid = TaskUtil.addTask(tasktitle, Integer.parseInt(userid));
	String shareids = Util.null2String(fu.getParameter("shareids"));
	int sPos = taskid.lastIndexOf("|");
	taskid = taskid.substring(sPos+1, taskid.length());
	TaskUtil.addShare(Integer.parseInt(taskid), shareids);
	Map taskInfo = TaskUtil.getTaskInfo(Integer.parseInt(taskid));
	result.put("taskid", taskid);
	result.put("creatorid", taskInfo.get("createrID"));
	result.put("createdate", taskInfo.get("createdate"));
	result.put("status", taskInfo.get("status"));
}else if(operation.equals("istaskcomplete")){		//\u4efb\u52a1\u662f\u5426\u5b8c\u6210
	String taskid = Util.null2String(fu.getParameter("taskid"));
	boolean isComplete = TaskUtil.ifComplete(Integer.parseInt(taskid));
	result.put("isComplete", isComplete);
}else if(operation.equals("istaskdeleted")){		//\u4efb\u52a1\u662f\u5426\u5220\u9664
	String taskid = Util.null2String(fu.getParameter("taskid"));
	boolean ifDelete = TaskUtil.ifDelete(Integer.parseInt(taskid));
	result.put("ifDelete", ifDelete);
}else if(operation.equals("completeTask")){			//\u5b8c\u6210\u4efb\u52a1
	String taskid = Util.null2String(fu.getParameter("taskid"));
	String msg = "";
	try{
		Map taskInfo = TaskUtil.getTaskInfo(Integer.parseInt(taskid));
		//\u64cd\u4f5c\u6743\u9650\u8fc7\u6ee4
		String creatorid = taskInfo.get("createrID").toString();
		String principalid = taskInfo.get("principalid").toString();
		if(userid.equals(creatorid) || userid.equals(principalid)){
			msg = TaskUtil.completeTask(Integer.parseInt(taskid), "2", Integer.parseInt(userid));
		}
	}catch(Exception e){
		e.printStackTrace();
	}
	result.put("isSuccess", msg.equals(""));
	result.put("error", msg);
}else if(operation.equals("gettaskinfo")){			//\u83b7\u53d6\u4efb\u52a1\u4fe1\u606f
	String taskid = Util.null2String(fu.getParameter("taskid"));
	Map info = TaskUtil.getTaskInfo(Integer.parseInt(taskid));
	if(info != null && info.size() > 0){
		result.put("creator", info.get("creater"));
		result.put("createdate", info.get("createdate"));
		result.put("creatorid", info.get("createrID"));
		result.put("principalid", info.get("principalid"));
		result.put("status", info.get("status"));
		result.put("deleted", info.get("deleted"));
	}
	
}else if(operation.equals("getMsgReaderIdList")){			//\u6839\u636e\u65f6\u95f4\u6bb5\u548c\u6d88\u606f\u6240\u6709\u4eba\u7684\u6240\u6709\u5df2\u9605\u8bfb\u6b64\u6d88\u606f\u7684\u4eba\u5458id\u96c6\u5408
	String dateTime = Util.null2String(fu.getParameter("dateTime"));
	Map res = SocialIMService.getMsgReaderIdList(userid, dateTime);
	result.put("res", res);
}else if(operation.equals("sendBroadcast")){			//\u53d1\u9001\u7cfb\u7edf\u5e7f\u64ad
	String msgId = UUID.randomUUID().toString().trim();
	String plainText = Util.null2String(fu.getParameter("plaintext"));
	String fromUserId = userid;
	String sendtime = System.currentTimeMillis()+"";
	String receiverIds = Util.null2String(fu.getParameter("receiverIds"));
	String imageids = Util.null2String(fu.getParameter("imageids"));	
	String accids = Util.null2String(fu.getParameter("accids"));	
	String wfids = Util.null2String(fu.getParameter("wfids"));	
	String docids = Util.null2String(fu.getParameter("docids"));	
	String accnames = Util.null2String(fu.getParameter("accnames"));	
	String accsizes = Util.null2String(fu.getParameter("accsizes"));	
	String wfnames = Util.null2String(fu.getParameter("wfnames"));	
	String docnames = Util.null2String(fu.getParameter("docnames"));
	JSONObject requestObjs = new JSONObject();
	//{'imageids':[...], 'accids': [], 'wfids': [], 'docids': []}
	requestObjs.put("imageids", imageids);
	requestObjs.put("accids", accids);
	requestObjs.put("accnames", accnames);
	requestObjs.put("accsizes", accsizes);
	requestObjs.put("wfids", wfids);
	requestObjs.put("wfnames", wfnames);
	requestObjs.put("docids", docids);
	requestObjs.put("docnames", docnames);
	if((","+receiverIds+",").indexOf(","+fromUserId+",") == -1){
		receiverIds += ","+fromUserId;
	}
	SocialIMClient.sendBroadCast(msgId, plainText, fromUserId, requestObjs, sendtime, receiverIds);
	result.put("issuccess", true);
}else if(operation.equals("getBroadcast")){			//\u83b7\u53d6\u7cfb\u7edf\u5e7f\u64ad
	String pagesize = Util.null2String(fu.getParameter("pagesize"));
	String pageindex = Util.null2String(fu.getParameter("pageindex"));
	String content = Util.null2String(fu.getParameter("content"));
	String timestart = Util.null2String(fu.getParameter("timestart"));
	String timeend = Util.null2String(fu.getParameter("timeend"));
	String senderid = Util.null2String(fu.getParameter("senderid"));
	//pagesize, pageindex, timestart, timeend, senderid, content
	HashMap<String, String> params = new HashMap<String, String>();
	params.put("pagesize", pagesize);
	params.put("pageindex", pageindex);
	params.put("content", content);
	params.put("timestart", timestart);
	params.put("timeend", timeend);
	params.put("senderid", senderid);
	JSONArray resList = SocialIMService.getBroadcastList(Util.getIntValue(userid), params);
	result.put("res", resList);
	result.put("hasnext", resList.size() == Util.getIntValue(pagesize));
}
if(result!=null){
	JSONObject jsonResult = JSONObject.fromObject(result);
	out.print(jsonResult);
}

    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("mobile/plugin/social/SocialMobileOperation.jsp"), -5563146924442116422L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string1;
  private final static char []_jsp_string2;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
    _jsp_string2 = " \r\n".toCharArray();
  }
}
