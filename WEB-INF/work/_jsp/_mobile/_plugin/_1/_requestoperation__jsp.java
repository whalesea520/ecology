/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._mobile._plugin._1;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.mobile.plugin.ecology.RequestOperation;
import weaver.mobile.webservices.workflow.*;
import weaver.general.*;
import org.apache.commons.lang.StringUtils;
import java.util.*;
import org.json.JSONObject;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import weaver.hrm.*;
import weaver.systeminfo.*;
import weaver.workflow.request.WorkflowSpeechAppend;
import weaver.file.FileUpload;
import weaver.meeting.defined.MeetingWFUtil;
import weaver.workflow.request.WorkflowRequestMessage;
import weaver.workflow.request.RequestSaveCheckManager;

public class _requestoperation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.conn.RecordSet RecordSet;
      RecordSet = (weaver.conn.RecordSet) pageContext.getAttribute("RecordSet");
      if (RecordSet == null) {
        RecordSet = new weaver.conn.RecordSet();
        pageContext.setAttribute("RecordSet", RecordSet);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      
request.setCharacterEncoding("UTF-8");
response.setContentType("text/html;charset=UTF-8");
FileUpload fu = new FileUpload(request);
String clienttype = Util.null2String(fu.getParameter("clienttype"));
String clientlevel = Util.null2String(fu.getParameter("clientlevel"));
String detailid = Util.null2String(fu.getParameter("detailid"));
String from = Util.null2String(fu.getParameter("from"));
String module = Util.null2String(fu.getParameter("module"));
String scope = Util.null2String(fu.getParameter("scope"));
String mobileSession = Util.null2String(fu.getParameter("mobileSession"));
String currentnodeid = Util.null2String(fu.getParameter("nodeid"));
String client = Util.null2String(fu.getParameter("client"));
String type = Util.null2String(fu.getParameter("type"));
String requestid = Util.null2String(fu.getParameter("requestid"));
String src = Util.null2String(fu.getParameter("src"));
String clientip = Util.null2String(fu.getParameter("clientip"));
String forwardresourceids = Util.null2String(fu.getParameter("forwardresourceids"));
String forwardresourceids2 = Util.null2String(fu.getParameter("forwardresourceids2"));
String forwardresourceids3 = Util.null2String(fu.getParameter("forwardresourceids3"));
String Intervenorremark = Util.null2String(fu.getParameter("Intervenorremark"));
String remark = Util.null2String(fu.getParameter("userSignRemark"));
String userid = Util.null2String(fu.getParameter("userid"));
String workflowid = Util.null2String(fu.getParameter("workflowid"));
String fromPage = Util.null2String(fu.getParameter("fromPage"));
String requestURI= Util.null2String(fu.getParameter("requestURI"));
int forwardflag = Util.getIntValue(fu.getParameter("forwardflag"),0);
String _rejectToNodeId = Util.null2String(fu.getParameter("rejectToNodeid"));
int rejectToType = 0 ;//\u9000\u56de\u7c7b\u578b
int rejectToNodeId = 0;
if(_rejectToNodeId.indexOf("_")!=-1){
	rejectToNodeId = Util.getIntValue(_rejectToNodeId.split("_")[0],0);
	rejectToType = Util.getIntValue(_rejectToNodeId.split("_")[1],1);
}else{
	rejectToNodeId = Util.getIntValue(_rejectToNodeId,0);
}
int SubmitToNodeid = Util.getIntValue(fu.getParameter("SubmitToNodeid"), 0);
int markId = Util.getIntValue(fu.getParameter("markId"), -1);
String remarkLocation = Util.null2String(fu.getParameter("remarkLocation"));
String method2 = fu.getParameter("method2");
String ismonitor = Util.null2String(fu.getParameter("ismonitor"));
int isurge = Util.getIntValue(fu.getParameter("isurge"),0);

//\u5e72\u9884
String intervenorright=Util.null2String(fu.getParameter("intervenorright"));
String submitNodeId=Util.null2String(fu.getParameter("submitNodeId"));
String Intervenorid=Util.null2String(fu.getParameter("Intervenorid"));
String IntervenoridType=Util.null2String(fu.getParameter("IntervenoridType"));
int SignType = Util.getIntValue(fu.getParameter("SignType"),0);
int enableIntervenor = Util.getIntValue(fu.getParameter("enableIntervenor"),1);//\u662f\u5426\u542f\u7528\u8282\u70b9\u53ca\u51fa\u53e3\u9644\u52a0\u64cd\u4f5c

int lastOperator = Util.getIntValue(fu.getParameter("lastOperator"), 0);
String lastOperateDate = Util.null2String(fu.getParameter("lastOperateDate"));
String lastOperateTime = Util.null2String(fu.getParameter("lastOperateTime"));		

//\u76d1\u63a7\u3001\u7763\u529e\u7fa4\u7ec4

Map<String, Object> otherinfo = new HashMap<String, Object>();
otherinfo.put("ismonitor", ismonitor);
otherinfo.put("isurger", isurge);
otherinfo.put("module",module);
//\u5e72\u9884
Map<String, String> otherinfo2 = new HashMap<String, String>();
otherinfo2.put("submitNodeId", submitNodeId);
otherinfo2.put("Intervenorid", Intervenorid);
otherinfo2.put("IntervenoridType", IntervenoridType);
otherinfo2.put("SignType", Util.null2String(SignType));
otherinfo2.put("enableIntervenor", Util.null2String(enableIntervenor));
otherinfo2.put("intervenorright", Util.null2String(intervenorright));

//\u83b7\u53d6\u5f53\u524d\u7248\u672c
String clientVer = Util.null2String(fu.getParameter("clientver"));
String serverVer = Util.null2String(fu.getParameter("serverver"));
String formid="";
RecordSet.executeSql("select formid from workflow_base where id="+workflowid);
if(RecordSet.next()){
	formid=RecordSet.getString("formid");
}
String f_weaver_belongto_userid=Util.null2String(fu.getParameter("f_weaver_belongto_userid"));//\u9700\u8981\u589e\u52a0\u7684\u4ee3\u7801
String f_weaver_belongto_usertype=Util.null2String(fu.getParameter("f_weaver_belongto_usertype"));//\u9700\u8981\u589e\u52a0\u7684\u4ee3\u7801
User user  = HrmUserVarify.getUser(request, response, f_weaver_belongto_userid, f_weaver_belongto_usertype) ;//\u9700\u8981\u589e\u52a0\u7684\u4ee3\u7801
if(user == null)  return;
userid = user.getUID()+"";

//\u5c06\u7b7e\u5b57\u610f\u89c1\u4e2d\u7684\u6362\u884c\u5185\u5bb9\u66ff\u6362\u6210\u6362\u884c\u6807\u7b7e\u3002



remark = remark.replaceAll("\r\n", "<br/>");

//\u6839\u636e\u5ba2\u6237\u7aef\u7c7b\u578b\u8f6c\u6362\u6210\u6570\u5b57\u5e38\u91cf\u3002



String clientType = "";
if (clienttype.equalsIgnoreCase("ipad")) {
    clientType = "3";
} else if (clienttype.equalsIgnoreCase("iphone")){
   clientType = "2";
} else if (clienttype.equalsIgnoreCase("Webclient")){
   clientType = "1";
} else if (clienttype.equalsIgnoreCase("Android")){
   clientType = "4";
} else if (clienttype.equalsIgnoreCase("AndPad")){
   clientType = "5";
}

//\u5224\u65ad\u5f53\u524d\u5ba2\u6237\u7aef\u7a0b\u5e8f\u7248\u672c\u662f\u5426\u9ad8\u4e8e4.5
boolean flagClientVersion4_5 = RequestOperation.compareVersion(clientVer, RequestOperation.VERSION_45);
//\u5224\u65ad\u5f53\u524dMobile\u7a0b\u5e8f\u7248\u672c\u662f\u5426\u9ad8\u4e8e4.5
boolean flagServerVersion4_5 = RequestOperation.compareVersion(serverVer, RequestOperation.VERSION_45);

int speechAttachment = 0;
int handWrittenSign = 0;
String isannexUpload = "";
if(flagServerVersion4_5){
	//\u83b7\u53d6\u8bed\u97f3\u9644\u4ef6
	String speechAppendix = Util.null2String(fu.getParameter("fieldSpeechAppend"));
	//\u5982\u679c\u4e0d\u4e3a\u7a7a\uff0c\u5219\u5c06\u5176\u4ee5\u9644\u4ef6\u5f62\u5f0f\u4e0a\u4f20\u3002



	if(!"".equals(speechAppendix)){
	  speechAttachment = WorkflowSpeechAppend.uploadAppend(speechAppendix, WorkflowSpeechAppend.FMT_SPEECHATTACHMENT);
	}
	
	//\u83b7\u53d6\u624b\u5199\u7b7e\u6279\u6570\u636e
	String fieldHandWritten = Util.null2String(fu.getParameter("fieldHandWritten"));
	//\u5982\u679c\u4e0d\u4e3a\u7a7a\uff0c\u5219\u5c06\u5176\u4ee5\u9644\u4ef6\u5f62\u5f0f\u4e0a\u4f20\u3002



	if(!"".equals(fieldHandWritten)){
	  handWrittenSign = WorkflowSpeechAppend.uploadAppend(fieldHandWritten, WorkflowSpeechAppend.FMT_HANDWRITTEN_SIGN);
	}
	
	//\u5904\u7406\u7535\u5b50\u7b7e\u7ae0
	if(markId > 0){
	  remark+="<br/><br/><img alt='electricSignature' name='electricSignature' src=/weaver/weaver.file.SignatureDownLoad?markId=" + markId + ">";
	}
	
	int[] annexDocCategory = weaver.workflow.workflow.WorkflowComInfo.getAnnexDocCategory(workflowid);
	isannexUpload = weaver.mobile.plugin.ecology.RequestOperation.uploadSignatureAppends(fu, user, annexDocCategory);
}

if(remark.indexOf("'")!=-1){
   remark = remark.replace("\'","&#39;");
}
//\u8bfb\u53d6\u914d\u7f6e\u9879\u7684\u503c\uff0c\u5bf9\u7b7e\u5b57\u610f\u89c1\u5185\u5bb9\u662f\u5426\u52a0\u4e0a\u624b\u673a\u7248\u4e0a\u7279\u6709\u6765\u6e90\u4fe1\u606f\u3002


//int isShowTerminal = Util.getIntValue(fu.getParameter("_isShowTerminal_"), 1);
//qc 145589 \u5904\u7406\u8bbe\u7f6e\u7b7e\u5b57\u610f\u89c1\u914d\u7f6e\u9879\u4e0d\u80fd\u8bfb\u53d6\u95ee\u9898\u3002


String isshowterminalstr = (String)application.getAttribute("emobile_config_isShowTerminal");
if (isshowterminalstr == null) {
    WorkflowServiceImpl wfsimpl = new WorkflowServiceImpl();
    isshowterminalstr = wfsimpl.getIsShowTerminal();
    application.setAttribute("emobile_config_isShowTerminal", isshowterminalstr);
}

BaseBean mobilewfprops=new BaseBean();
String mobileWFOffice= Util.null2String(mobilewfprops.getPropValue("MobileWFOfficeSign","mobileWFOffice"));


if ("1".equals(isshowterminalstr)) {
	if(clienttype.equalsIgnoreCase("Webclient")){
		//\u589e\u52a0\u5fae\u4fe1\u9489\u9489\u63d0\u4ea4\u6807\u8bb0--QC150390
		String clienttype2 = Util.null2String(fu.getParameter("clienttype2"));
		if(!"".equals(clienttype2)) remark += ("<br/><br/><span style='font-size:11px;color:#666;'>"+SystemEnv.getHtmlLabelName(31505, user.getLanguage())+clienttype2+"</span>");
		else remark += ("<br/><br/><span style='font-size:11px;color:#666;'>"+SystemEnv.getHtmlLabelName(31505, user.getLanguage())+"Web"+SystemEnv.getHtmlLabelName(31506, user.getLanguage())+"</span>");
	}else{
		remark += ("<br/><br/><span style='font-size:11px;color:#666;'>"+SystemEnv.getHtmlLabelName(31505, user.getLanguage()) + clienttype +SystemEnv.getHtmlLabelName(108, user.getLanguage()) +"</span>");
	}
}else {
	remark += "<br/>";
}

WorkflowRequestInfo workflowRequestInfo = null;
WorkflowService wfs = new WorkflowServiceImpl();
String wfReqInfoKey = "";
String sessionkey = Util.null2String((String)request.getParameter("sessionkey"));
if("create".equals(method2)){
  	wfReqInfoKey = sessionkey + "_"+ workflowid + "_"+ user.getUID();
} else {
	//workflowRequestInfo = wfs.getWorkflowRequest4split(Util.getIntValue(requestid, 0), user.getUID(), 0, 10000); 
	wfReqInfoKey = sessionkey + "_" + workflowid + "_" + requestid + "_"+ userid;
}



//\u4ece\u7f13\u5b58\u4e2d\u83b7\u53d6\u6d41\u7a0b\u8868\u5355\u57fa\u7840\u6570\u636e
StaticObj staticObj = StaticObj.getInstance();
synchronized(staticObj){
	Map mapWfReqInfos = (Map)staticObj.getObject("MOBILE_WORKFLOWREQUESTINFO_CACHE");
	if (mapWfReqInfos != null) {
		workflowRequestInfo = (WorkflowRequestInfo)mapWfReqInfos.get(wfReqInfoKey);
		mapWfReqInfos.remove(wfReqInfoKey);
	
		//\u5f53\u7f13\u5b58\u4e2d\u7684\u9879\u5927\u4e8e10000\u65f6\uff0c\u81ea\u52a8\u6e05\u9664\u7f13\u5b58
		if (mapWfReqInfos.entrySet().size() >= 1000) {
			mapWfReqInfos.clear();
			//System.err.println("wipe mobile catche!");
		} 
	}
	
	if (workflowRequestInfo == null) {
	    //\u521b\u5efa\u65f6\uff0c\u5982\u679csessionkey\u53d1\u751f\u53d8\u5316\uff0c\u7f13\u5b58\u5bf9\u8c61\u65e0\u6cd5\u83b7\u53d6\uff0c\u5219\u4ece\u6570\u636e\u5e93\u4e2d\u91cd\u65b0\u67e5\u8be2\u5bf9\u8c61
	    if (Util.getIntValue(requestid, 0) <= 0) {
	        workflowRequestInfo = wfs.getCreateWorkflowRequestInfo(Util.getIntValue(workflowid), user.getUID());
	    } else {
	        workflowRequestInfo = wfs.getWorkflowRequest4split(Util.getIntValue(requestid, 0), user.getUID(), 0, 10000, false, otherinfo);
	    }
		
		//System.err.println("failed to get the object from the cache!");
	} else {
		//System.err.println("success derives from the cache object!");
	}
}



int[] docCategory = WorkflowSpeechAppend.getDocCategory(workflowid, fu);
workflowRequestInfo = weaver.mobile.plugin.ecology.RequestOperation.getWorkflowRequestInfoFromRequest(fu, workflowRequestInfo, user, docCategory);
workflowRequestInfo.setRejectToNodeid(rejectToNodeId);
workflowRequestInfo.setRejcetToType(rejectToType);
workflowRequestInfo.setSubmitToNodeid(SubmitToNodeid);

boolean fnaMobileErrorFlag = false;
String fnaMobileErrorMsg = "";
String result = "";
workflowRequestInfo.setSpeechAttachment(speechAttachment);
workflowRequestInfo.setHandWrittenSign(handWrittenSign);
workflowRequestInfo.setSignatureAppendfix(isannexUpload);
workflowRequestInfo.setRemarkLocation(remarkLocation);
workflowRequestInfo.setLanguageid(user.getLanguage());

String responseUrl = "/mobile/plugin/1/view.jsp";
if("client.jsp".equals(fromPage)){ 
    responseUrl =  "/mobile/plugin/1/client.jsp"; 
}

//\u6d41\u7a0b\u5df2\u6d41\u8f6c\u5230\u4e0b\u4e00\u8282\u70b9\uff0c\u4e0d\u53ef\u518d\u63d0\u4ea4
//if(StringUtils.isBlank(result)){
if("submit".equals(src)||"subnoback".equals(src)||"subback".equals(src)||"supervise".equals(src) ||"intervenor".equals(src) ){

    if(!"create".equals(method2)){
	    if(!src.equals("supervise")&&!src.equals("intervenor")){
		    int isremark = workflowRequestInfo.getIsremark();
		    if(isremark!=1&&isremark!=9){
		   	   RecordSet.executeSql("select 1 from workflow_currentoperator where isremark not in('2','4') and (takisremark<>-2 or takisremark is null) and requestid="+requestid+" and userid="+userid+" and nodeid="+workflowRequestInfo.getNodeId());
		       if(RecordSet.getCounts()<1){
		           workflowRequestInfo.setMessageid(WorkflowRequestMessage.WF_REQUEST_ERROR_CODE_02); //\u5df2\u7ecf\u6d41\u8f6c\u5230\u4e0b\u4e00\u8282\u70b9\uff0c\u4e0d\u53ef\u4ee5\u518d\u63d0\u4ea4
		           responseUrl += "?detailid="+requestid+"&messageid="+workflowRequestInfo.getMessageid()+"&clienttype="+clienttype+"&module=8&scope=373";
		           request.getRequestDispatcher(responseUrl).forward(request,response);
		           return;
		       }
	    	}
	    }
	}
	
    String message = RequestSaveCheckManager.getReturnMessage(lastOperator,lastOperateDate,lastOperateTime,Util.getIntValue(workflowid),Util.getIntValue(workflowRequestInfo.getCurrentNodeId(),-1),Util.getIntValue(userid),Util.getIntValue(requestid));
    if(StringUtils.isNotEmpty(message)){
		workflowRequestInfo.setMessageid(message);
		result = "failed";
    }else{
		//\u7531\u7528\u6237\u9009\u62e9\u64cd\u4f5c\u8005\uff0c\u5f02\u5e38\u5904\u7406\u4fe1\u606f\u5c01\u88c5workflowRequestInfo
		String eh_setoperator = Util.null2String(fu.getParameter("eh_setoperator"));
		if("n".equals(eh_setoperator)){			//\u5f02\u5e38\u5904\u7406\u7a97\u53e3\u672a\u9009\u62e9\u64cd\u4f5c\u8005\uff0c\u4ee5\u63d0\u4ea4\u5931\u8d25\u5904\u7406
	
			if("y".equals(Util.null2String(fu.getParameter("eh_fromcreate")))){
				//\u521b\u5efa\u8282\u70b9\u5f02\u5e38\u9009\u4eba\uff0c\u4e0d\u9009\u62e9\u65f6\u9700\u5220\u9664\u6d41\u7a0b\u4fe1\u606f
				//new WorkFlowInit().DeleteByid(Util.getIntValue(requestid));
			}
			workflowRequestInfo.setMessageid(WorkflowRequestMessage.WF_REQUEST_ERROR_CODE_07);
			JSONObject msgjson = new JSONObject();
			msgjson.put("resetoperator","y");
			workflowRequestInfo.setMessagecontent(msgjson.toString());	
			result = "failed";
		}else{
			if("y".equals(eh_setoperator)){		//\u5f02\u5e38\u5904\u7406\u9009\u62e9\u4e86\u64cd\u4f5c\u8005\uff0c\u62fc\u88c5\u64cd\u4f5c\u8005\u4fe1\u606f
	
				Map<String,Object> eh_operatorMap = new HashMap<String,Object>();
				eh_operatorMap.put("eh_setoperator", eh_setoperator);
				eh_operatorMap.put("eh_relationship", Util.null2String(fu.getParameter("eh_relationship")));
				eh_operatorMap.put("eh_operators", Util.null2String(fu.getParameter("eh_operators")));
				workflowRequestInfo.setEh_operatorMap(eh_operatorMap);
			}
			if("create".equals(method2)){
				//\u662f\u5426\u662f\u81ea\u7531\u6d41\u7a0b
	
				String nodeId = workflowRequestInfo.getCurrentNodeId();
				weaver.workflow.workflow.WFManager wfm = new weaver.workflow.workflow.WFManager();
		        wfm.setWfid(Util.getIntValue(workflowid));
		        wfm.getWfInfo();
		    	String isFree = wfm.getIsFree();
				boolean IsFreeWorkflow = false;
				if(isFree.equals("1")){
					IsFreeWorkflow = true;
				}
				
				boolean iscreatenode = false;
				String nodetypesql="select nodetype from workflow_flownode where nodeid="+nodeId;
				RecordSet.executeSql(nodetypesql);
		        while(RecordSet.next()){
		        	String nodetype=RecordSet.getString("nodetype");
		        	if("0".equals(nodetype)){
		        		iscreatenode = true;
		        	}
		        }
				if(IsFreeWorkflow && iscreatenode){
					Map<String, String> params = new HashMap<String, String>();  
			    	try{
			    		Enumeration<String> paramNames = fu.getParameterNames();  
				        while( paramNames.hasMoreElements() ) {  
				        	String paramName = paramNames.nextElement();  
				        	String[] paramValues = fu.getParameterValues(paramName);  
				        	if (paramValues.length >= 1) {  
				        		String paramValue = paramValues[0];  
				        		if (paramValue.length() != 0) {  
				        			params.put(paramName, paramValue);  
				        		}  
				        	} 
				        }
			    	}catch(Exception e){
			    	}
					result = wfs.doCreateWorkflowRequest(workflowRequestInfo, user.getUID(), remark, clientType,src,params);
				}else{
				////////////////
				
					result = wfs.doCreateWorkflowRequest(workflowRequestInfo, user.getUID(), remark, clientType,src);
				}
				
				if(formid.equals("85")){
					String meetingid=MeetingWFUtil.updateWF2Meeting(""+result,""+formid,"",user.getUID());
					RecordSet.execute("update meeting set requestid="+result+" where id="+meetingid);
					//\u53ea\u6709\u8349\u7a3f\u72b6\u6001\u624d\u66f4\u65b0\u6210\u5f85\u5ba1\u6279
					 
					RecordSet.execute("SELECT currentnodetype from workflow_requestbase where requestid="+result);
					if(RecordSet.next()){
						if("3".equals(RecordSet.getString("currentnodetype"))){ //\u5f52\u6863
							//\u8bbe\u7f6e\u4f1a\u8bae\u6b63\u5e38,\u521b\u5efa\u65e5\u7a0b\u6216\u8005\u5f62\u6210\u5468\u671f\u4f1a\u8bae
	
							RecordSet.execute("select id,meetingstatus from meeting where id="+meetingid);
							if(RecordSet.next()){
								if("1".equals(RecordSet.getString("meetingstatus"))||"0".equals(RecordSet.getString("meetingstatus"))){//\u5f53\u524d\u4f1a\u8bae\u662f\u5f85\u5ba1\u6279\u6216\u8005\u8349\u7a3f(\u6d41\u7a0b\u7a7f\u900f)
									MeetingWFUtil.setMeetingNormal(meetingid);
								}
							}
						}else{
							RecordSet.execute("update meeting set meetingstatus=1 where id="+meetingid);
						}
					}
				}
			} else {
				//\u662f\u5426\u662f\u81ea\u7531\u6d41\u7a0b
	
				String nodeId = workflowRequestInfo.getCurrentNodeId();
				weaver.workflow.workflow.WFManager wfm = new weaver.workflow.workflow.WFManager();
		        wfm.setWfid(Util.getIntValue(workflowid));
		        wfm.getWfInfo();
		    	String isFree = wfm.getIsFree();
				boolean IsFreeWorkflow = false;
				if(isFree.equals("1")){
					IsFreeWorkflow = true;
				}
				
				boolean iscreatenode = false;
				String nodetypesql="select nodetype from workflow_flownode where nodeid="+nodeId;
				RecordSet.executeSql(nodetypesql);
		        while(RecordSet.next()){
		        	String nodetype=RecordSet.getString("nodetype");
		        	if("0".equals(nodetype)){
		        		iscreatenode = true;
		        	}
		        }
		        if(IsFreeWorkflow && iscreatenode){
					Map<String, String> params = new HashMap<String, String>();  
			    	try{
			    		Enumeration<String> paramNames = fu.getParameterNames();  
				        while( paramNames.hasMoreElements() ) {  
				        	String paramName = paramNames.nextElement();  
				        	String[] paramValues = fu.getParameterValues(paramName);  
				        	if (paramValues.length >= 1) {  
				        		String paramValue = paramValues[0];  
				        		if (paramValue.length() != 0) {  
				        			params.put(paramName, paramValue);  
				        		}  
				        	} 
				        }
			    	}catch(Exception e){
			    	}
					//result = wfs.doCreateWorkflowRequest(workflowRequestInfo, user.getUID(), remark, clientType,src,params);
					result = wfs.submitWorkflowRequest(workflowRequestInfo, Util.getIntValue(requestid), user.getUID(), src, remark, clientType,params);
				}else{
					if("intervenor".equals(src)){
					result = wfs.submitWorkflowRequest(workflowRequestInfo, Util.getIntValue(requestid), user.getUID(), src, remark, clientType, otherinfo2);
					}else{
					result = wfs.submitWorkflowRequest(workflowRequestInfo, Util.getIntValue(requestid), user.getUID(), src, remark, clientType);
					}
				}
			}
			
			if(result.indexOf("FnaMobileErrorMsg") > -1){		//
				fnaMobileErrorFlag = true;
				
				int req_requestid = -1;
				if("create".equals(method2))
					req_requestid = Util.getIntValue(result.substring(result.indexOf("_")+1));
				else
					req_requestid = Util.getIntValue(requestid);
				
				int fcsemId = 0;
				String sql = "select id,msg from FnaMobileErrorMsg where userid = " + user.getUID() + " and requestid = " + req_requestid;
				RecordSet.executeSql(sql);
				if(RecordSet.next()){
					fcsemId = RecordSet.getInt("id");
					fnaMobileErrorMsg = Util.null2String(RecordSet.getString("msg"));
				}
				
				//RecordSet.executeSql("delete FnaMobileErrorMsg where id = " + fcsemId);
			}
			
			if(result.indexOf("needChooseOperator") > -1){		//\u5f02\u5e38\u5904\u7406\uff0c\u7531\u7528\u6237\u9009\u62e9\u64cd\u4f5c\u8005
	
				int req_requestid = -1;
				if("create".equals(method2))
					req_requestid = Util.getIntValue(result.substring(result.indexOf(",")+1));
				else
					req_requestid = Util.getIntValue(requestid);
				
				String forwardUrl = "/mobile/plugin/1/view.jsp";
				if("client.jsp".equals(fromPage))
					forwardUrl = "/mobile/plugin/1/client.jsp";
				forwardUrl += "?method=&detailid="+req_requestid+"&needChooseOperator=y";
				forwardUrl += "&eh_fromcreate="+("create".equals(method2)?"y":"n");
				forwardUrl += "&clienttype="+clienttype;
				//System.err.println("forwardUrl=="+forwardUrl);
				//out.println("<script>");
		    	//out.println("window.location.href='"+forwardUrl+"';");
		    	//out.println("</script>");
		    	request.getRequestDispatcher(forwardUrl).forward(request, response);
		    	return;
			}
		}
	}
}else if("save".equals(src)){
    result = wfs.saveWorkflowRequest(workflowRequestInfo, Util.getIntValue(requestid), user.getUID(), src, remark, clientType);
} else if("reject".equals(src)){
	result = wfs.submitWorkflowRequest(workflowRequestInfo, Util.getIntValue(requestid), user.getUID(), src, remark, clientType);
} else if("forward".equals(src) && forwardflag == 1 ){
	String[] forwardids = StringUtils.split(forwardresourceids,","); 
	String forwardidvalue = "";
	for(int p=0;forwardids!=null&&forwardids.length>0&&p<forwardids.length;p++){
		String value = forwardids[p];
		if(StringUtils.isNotEmpty(value)){
			forwardidvalue+=","+value;
		}
	}
	forwardidvalue = forwardidvalue.startsWith(",")?forwardidvalue.substring(1):forwardidvalue;
	if(clientip==null||"".equals(clientip)){
		String regex = "(((2[0-4]\\d)|(25[0-5]))|(1\\d{2})|([1-9]\\d)|(\\d))[.](((2[0-4]\\d)|(25[0-5]))|(1\\d{2})|([1-9]\\d)|(\\d))[.](((2[0-4]\\d)|(25[0-5]))|(1\\d{2})|([1-9]\\d)|(\\d))[.](((2[0-4]\\d)|(25[0-5]))|(1\\d{2})|([1-9]\\d)|(\\d))";
        Pattern p = Pattern.compile(regex);
		clientip = StringUtils.defaultIfEmpty(request.getHeader("X-Forwarded-For"),"");
        Matcher m = p.matcher(clientip);
        if (clientip == null || "".equals(clientip) || !m.matches()) {
        	clientip = request.getRemoteAddr();
        }
	}
	result = wfs.forwardWorkflowRequest(Util.getIntValue(requestid), forwardidvalue, remark, user.getUID(), clientip, clientType, handWrittenSign, speechAttachment, isannexUpload,remarkLocation,module);

} else if("forward".equals(src) && forwardflag == 2 ){
	String[] forwardids = StringUtils.split(forwardresourceids2,","); 
	String forwardidvalue = "";
	for(int p=0;forwardids!=null&&forwardids.length>0&&p<forwardids.length;p++){
		String value = forwardids[p];
		if(StringUtils.isNotEmpty(value)){
			forwardidvalue+=","+value;
		}
	}
	forwardidvalue = forwardidvalue.startsWith(",")?forwardidvalue.substring(1):forwardidvalue;
	if(clientip==null||"".equals(clientip)){
		String regex = "(((2[0-4]\\d)|(25[0-5]))|(1\\d{2})|([1-9]\\d)|(\\d))[.](((2[0-4]\\d)|(25[0-5]))|(1\\d{2})|([1-9]\\d)|(\\d))[.](((2[0-4]\\d)|(25[0-5]))|(1\\d{2})|([1-9]\\d)|(\\d))[.](((2[0-4]\\d)|(25[0-5]))|(1\\d{2})|([1-9]\\d)|(\\d))";
        Pattern p = Pattern.compile(regex);
		clientip = StringUtils.defaultIfEmpty(request.getHeader("X-Forwarded-For"),"");
        Matcher m = p.matcher(clientip);
        if (clientip == null || "".equals(clientip) || !m.matches()) {
        	clientip = request.getRemoteAddr();
        }
	}
	
	result = wfs.forwardWorkflowRequest(Util.getIntValue(requestid), forwardidvalue, remark, user.getUID(), clientip, clientType, forwardflag, handWrittenSign, speechAttachment, isannexUpload,remarkLocation);
	
} else if("forward".equals(src) && forwardflag == 3 ){
	String[] forwardids = StringUtils.split(forwardresourceids3,","); 
	String forwardidvalue = "";
	for(int p=0;forwardids!=null&&forwardids.length>0&&p<forwardids.length;p++){
		String value = forwardids[p];
		if(StringUtils.isNotEmpty(value)){
			forwardidvalue+=","+value;
		}
	}
	forwardidvalue = forwardidvalue.startsWith(",")?forwardidvalue.substring(1):forwardidvalue;
	if(clientip==null||"".equals(clientip)){
		String regex = "(((2[0-4]\\d)|(25[0-5]))|(1\\d{2})|([1-9]\\d)|(\\d))[.](((2[0-4]\\d)|(25[0-5]))|(1\\d{2})|([1-9]\\d)|(\\d))[.](((2[0-4]\\d)|(25[0-5]))|(1\\d{2})|([1-9]\\d)|(\\d))[.](((2[0-4]\\d)|(25[0-5]))|(1\\d{2})|([1-9]\\d)|(\\d))";
        Pattern p = Pattern.compile(regex);
		clientip = StringUtils.defaultIfEmpty(request.getHeader("X-Forwarded-For"),"");
        Matcher m = p.matcher(clientip);
        if (clientip == null || "".equals(clientip) || !m.matches()) {
        	clientip = request.getRemoteAddr();
        }
	}
	
	result = wfs.forwardWorkflowRequest(Util.getIntValue(requestid), forwardidvalue, remark, user.getUID(), clientip, clientType, forwardflag, handWrittenSign, speechAttachment, isannexUpload, remarkLocation);
	
}
boolean flagResult = (Util.getIntValue(result, 0)>0 || "success".equals(result));
if(!flagResult){
    session.setAttribute("msgcontent_"+userid+"_"+workflowRequestInfo.getRequestId(),workflowRequestInfo.getMessagecontent());
    responseUrl += "?detailid="+workflowRequestInfo.getRequestId()+"&messageid="+workflowRequestInfo.getMessageid()+"&clienttype="+clienttype; 
    request.getRequestDispatcher(responseUrl).forward(request,response);
}else{
	RecordSet.executeSql("select wftype from cpt_cptwfconf where wfid="+workflowid);
	if(RecordSet.next()){
		String cptwftype=Util.null2String(RecordSet.getString("wftype"));
		if (!"".equals(cptwftype) && !"apply".equalsIgnoreCase(cptwftype)) {
			RecordSet.executeSql("update CptCapital set frozennum = 0 where isdata='2' ");
		}else if ("19".equals(formid)||"201".equals(formid)||"220".equals(formid)||"221".equals(formid)) {
			RecordSet.executeSql("update CptCapital set frozennum = 0 where isdata='2' ");
		}
	}
if((!"1".equals(mobileWFOffice)&&"client.jsp".equals(fromPage))
	||("1".equals(mobileWFOffice)&&"client.jsp".equals(fromPage)&&!"save".equals(src)||("create".equals(method2)&&"client.jsp".equals(fromPage)))){
      out.write(_jsp_string2, 0, _jsp_string2.length);
      out.print((flagResult));
      out.write(_jsp_string3, 0, _jsp_string3.length);
      out.print((result));
      out.write(':');
      out.print((user.getUID() ));
      out.write(_jsp_string4, 0, _jsp_string4.length);
      
				if(fnaMobileErrorFlag){
			
      out.write(_jsp_string5, 0, _jsp_string5.length);
      out.print((fnaMobileErrorMsg.replace("<br>","")));
      out.write(_jsp_string6, 0, _jsp_string6.length);
      
				}
			
      out.write(_jsp_string7, 0, _jsp_string7.length);
       }else{
      out.write(_jsp_string8, 0, _jsp_string8.length);
      if (clienttype.equals("Webclient")) {
      out.write(_jsp_string9, 0, _jsp_string9.length);
      } else {
      out.write(_jsp_string10, 0, _jsp_string10.length);
      }
      out.write(_jsp_string11, 0, _jsp_string11.length);
      out.print((workflowRequestInfo.getWorkflowBaseInfo().getWorkflowName() ));
      out.write(_jsp_string12, 0, _jsp_string12.length);
      if("1".equals(mobileWFOffice)&&!"create".equals(method2)){
      out.write(_jsp_string13, 0, _jsp_string13.length);
      if("save".equals(src)){
      out.write(_jsp_string14, 0, _jsp_string14.length);
      out.print((requestURI));
      out.write(_jsp_string15, 0, _jsp_string15.length);
      }else{
      out.write(_jsp_string16, 0, _jsp_string16.length);
      }
      out.write(_jsp_string17, 0, _jsp_string17.length);
      }else{
      out.write(_jsp_string18, 0, _jsp_string18.length);
      }
      out.write(_jsp_string19, 0, _jsp_string19.length);
      out.print((module));
      out.write(_jsp_string20, 0, _jsp_string20.length);
      out.print((scope));
      out.write(_jsp_string21, 0, _jsp_string21.length);
       } }
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("mobile/plugin/1/RequestOperation.jsp"), 7310827694075921996L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string20;
  private final static char []_jsp_string2;
  private final static char []_jsp_string19;
  private final static char []_jsp_string13;
  private final static char []_jsp_string21;
  private final static char []_jsp_string8;
  private final static char []_jsp_string11;
  private final static char []_jsp_string18;
  private final static char []_jsp_string9;
  private final static char []_jsp_string14;
  private final static char []_jsp_string10;
  private final static char []_jsp_string5;
  private final static char []_jsp_string4;
  private final static char []_jsp_string0;
  private final static char []_jsp_string15;
  private final static char []_jsp_string17;
  private final static char []_jsp_string3;
  private final static char []_jsp_string12;
  private final static char []_jsp_string7;
  private final static char []_jsp_string6;
  private final static char []_jsp_string16;
  private final static char []_jsp_string1;
  static {
    _jsp_string20 = "&scope=".toCharArray();
    _jsp_string2 = "\r\n<script type=\"text/javascript\">\r\n		function submitResult(){		\r\n			var url = \"".toCharArray();
    _jsp_string19 = "\r\n				</div>\r\n			</div>\r\n		</div>\r\n	</div>\r\n	\r\n	\r\n</div>\r\n\r\n\r\n<script type=\"text/javascript\">	\r\n	function goBack() {\r\n		location = \"/list.do?module=".toCharArray();
    _jsp_string13 = "\r\n				       ".toCharArray();
    _jsp_string21 = "\";\r\n	}\r\n	\r\n	function logout() {\r\n		location = \"/logout.do\";\r\n	}\r\n</script>\r\n\r\n</body>\r\n</html> ".toCharArray();
    _jsp_string8 = "\r\n<html><head>\r\n	<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" />\r\n	<meta name=\"author\" content=\"Weaver E-Mobile Dev Group\" />\r\n	<meta name=\"description\" content=\"Weaver E-mobile\" />\r\n	<meta name=\"keywords\" content=\"weaver,e-mobile\" />\r\n	<meta name=\"viewport\" content=\"width=device-width,minimum-scale=1.0, maximum-scale=1.0\" />\r\n	<title></title>\r\n	<script type='text/javascript' src='/mobile/plugin/js/jquery/jquery_wev8.js'></script>\r\n	<script type='text/javascript' src='/mobile/plugin/js/jquery/jquery-ui_wev8.js'></script>\r\n	<link rel=\"stylesheet\" href=\"/mobile/plugin/css/cupertino/jquery-ui_wev8.css\" type=\"text/css\">\r\n	<link rel=\"stylesheet\" href=\"/mobile/plugin/css/mobile_wev8.css\" type=\"text/css\">\r\n</head>\r\n<body style=\"margin:0;padding:0;\">\r\n\r\n<div id=\"view_page\">\r\n\r\n	<div id=\"view_header\" style=\"".toCharArray();
    _jsp_string11 = "\">\r\n		<table style=\"width:100%;height:40px;font-size:13px;\">\r\n			<tr>\r\n				<td width=\"10%\" align=\"left\" valign=\"middle\" style=\"padding-left:5px;\">\r\n					<a href=\"javascript:goBack();\">\r\n						<div style=\"width:56px;height:26px;background:url('/images/bg-top-btn_wev8.png') no-repeat;text-align:center;line-height:26px;color:#000;\">\r\n						\u8fd4\u56de\r\n						</div>\r\n					</a>\r\n				</td>\r\n				<td align=\"center\" valign=\"middle\">\r\n					<div id=\"view_title\">".toCharArray();
    _jsp_string18 = "\r\n					  \u6d41\u7a0b\u5904\u7406\u6210\u529f\uff01\r\n					".toCharArray();
    _jsp_string9 = "display:block;".toCharArray();
    _jsp_string14 = "\r\n					     <script>\r\n					        location = '".toCharArray();
    _jsp_string10 = "display:none;".toCharArray();
    _jsp_string5 = "\r\n				alert(\"".toCharArray();
    _jsp_string4 = "\";	\r\n			".toCharArray();
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string15 = "';\r\n					     </script>\r\n					  ".toCharArray();
    _jsp_string17 = "\r\n				   ".toCharArray();
    _jsp_string3 = "\" + \":\" + \"".toCharArray();
    _jsp_string12 = "</div>\r\n				</td>\r\n				<td width=\"10%\" align=\"right\" valign=\"middle\" style=\"padding-right:5px;\">\r\n					<a href=\"javascript:logout();\">\r\n						<div style=\"width:56px;height:26px;background:url('/images/bg-top-btn_wev8.png') no-repeat;text-align:center;line-height:26px;color:#000;\">\r\n						\u9000\u51fa\r\n\r\n\r\n\r\n						</div>\r\n					</a>\r\n				</td>\r\n			</tr>\r\n		</table>\r\n	</div>\r\n\r\n\r\n	<div class=\"bodyContext\" style=\"background:url(/images/news/viewBg_wev8.png) repeat;margin:0;width:100%;padding-top:20px;padding-bottom:20px;\">\r\n		<div style=\"margin:0 10px 10px 10px;\">\r\n			<div class=\"blockBody\">\r\n				<div style=\"margin:10px;\">\r\n				   ".toCharArray();
    _jsp_string7 = "\r\n			return url;\r\n		}	    \r\n</script>\r\n".toCharArray();
    _jsp_string6 = "\");\r\n			".toCharArray();
    _jsp_string16 = "\r\n					      \u6d41\u7a0b\u5904\u7406\u6210\u529f\uff01\r\n					   ".toCharArray();
    _jsp_string1 = "\r\n\r\n".toCharArray();
  }
}
