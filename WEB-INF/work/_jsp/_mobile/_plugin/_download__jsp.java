/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._mobile._plugin;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import java.net.URLEncoder;
import java.net.URLDecoder;
import net.sf.json.*;
import java.util.*;
import java.util.zip.*;
import java.io.*;
import weaver.general.*;
import weaver.file.*;
import DBstep.iMsgServer2000;
import weaver.hrm.*;
import weaver.mobile.plugin.ecology.service.EMessageService;
import weaver.WorkPlan.WorkPlanService;
import weaver.blog.BlogDao;
import weaver.cowork.CoworkDAO;
import weaver.meeting.MeetingUtil;
import weaver.workflow.request.WFUrgerManager;
import weaver.social.service.SocialIMService;
import weaver.conn.*;
import weaver.file.ImageFileManager;
import weaver.docs.pdf.docpreview.ConvertPDFTools;
import weaver.docs.pdf.docpreview.ConvertPDFUtil;
import weaver.docs.category.SecCategoryComInfo;
import weaver.splitepage.operate.SpopForDoc;
import weaver.docs.docs.DocManager;
import weaver.docs.networkdisk.server.NetworkFileLogServer;

public class _download__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;

  
  private boolean getWhetherHasRight(String fileId,User user)  throws Exception{
  		//\u5b89\u5168\u6027\u68c0\u67e5
  	        if(fileId==null||fileId.trim().equals("")){
  	            return false;
  	        }
  	        RecordSet rs = new RecordSet();
  	        //\u662f\u5426\u5fc5\u987b\u6388\u6743     1\uff1a\u662f   0\u6216\u5176\u4ed6\uff1a\u5426
  	        String mustAuth=Util.null2String(rs.getPropValue("FileDownload","mustAuth"));           
  	        boolean hasRight=true; 
  	        if(mustAuth.equals("1")){
  	            hasRight=false;
  	        }       
  	        boolean isDocFile=false;
  	        //\u6587\u6863\u6a21\u5757  \u9644\u4ef6\u67e5\u770b\u6743\u9650\u63a7\u5236  \u5f00\u59cb
  	        String docId=null;
  	        List docIdList=new ArrayList();
  			RecordSet rs2 = new RecordSet();
  			rs2.executeSql("select  imagefilename from ImageFile where imageFileId="+fileId);
  			String extName="";
  			boolean isExtfile=false;
  			if(rs2.next()){
  	    		 String  filename = Util.null2String(rs2.getString("imagefilename"));			       	    	
  					if(filename.indexOf(".") > -1){
  						int bx = filename.lastIndexOf(".");
  						if(bx>=0){
  							extName = filename.substring(bx+1, filename.length());						
  						}
  					}						
  			}
  			if( "xls".equalsIgnoreCase(extName)||"xlsx".equalsIgnoreCase(extName) || "doc".equalsIgnoreCase(extName)|| "docx".equalsIgnoreCase(extName)||"wps".equalsIgnoreCase(extName)||"ppt".equalsIgnoreCase(extName)||"pptx".equalsIgnoreCase(extName)) {		
  			isExtfile=true;
  			}
  	        rs.executeSql("select  docId from docImageFile where imageFileId="+fileId);
  	        while(rs.next()){
  	            hasRight=false;
  	            docId=rs.getString(1);
  	            if(docId!=null&&!docId.equals("")){
  	                docIdList.add(docId);
  	            }
  	        }
  	        String comefrom="";     
  	        if(docIdList.size()==0){
  	            int fileId_related=0;
  	            int docId_related=0;
  	            boolean hasDocId=false;
  	            rs.executeSql("select comefrom from ImageFile where imageFileId="+fileId);
  	            if(rs.next()){
  	                comefrom=Util.null2String(rs.getString("comefrom"));
  	            }   
  	            String comefrom_noNeedLogin=Util.null2String(rs.getPropValue("FileDownload","comefrom_noNeedLogin"));           
  	            if((","+comefrom_noNeedLogin+",").indexOf(","+comefrom+",")>=0){
  	                hasRight=true;
  	                return hasRight;
  	            }   
  	            
  	            if(comefrom.equals("DocPreview")||comefrom.equals("DocPreviewHistory")){
  	                rs.executeSql("select imageFileId,docId from "+comefrom+"  where (pdfFileId="+fileId+" or swfFileId="+fileId+") order by id desc");
  	                if(rs.next()){
  	                    fileId_related=Util.getIntValue(rs.getString("imageFileId"),0);
  	                    docId_related=Util.getIntValue(rs.getString("docId"),0);                
  	                }
  	                if(docId_related>0){
  	                    docIdList.add(""+docId_related);
  	                    hasDocId=true;
  	                }
  	            }else if(comefrom.equals("DocPreviewHtml")||comefrom.equals("DocPreviewHtmlHistory")){
  	                rs.executeSql("select imageFileId,docId from "+comefrom+"  where  htmlFileId="+fileId+" order by id desc");
  	                if(rs.next()){
  	                    fileId_related=Util.getIntValue(rs.getString("imageFileId"),0);
  	                    docId_related=Util.getIntValue(rs.getString("docId"),0);                
  	                }
  	                if(docId_related>0){
  	                    docIdList.add(""+docId_related);
  	                    hasDocId=true;
  	                }               
  	            }else if(comefrom.equals("DocPreviewHtmlImage")){
  	                rs.executeSql("select imageFileId,docId from DocPreviewHtmlImage  where  picFileId="+fileId+"  order by id desc");
  	                if(rs.next()){
  	                    fileId_related=Util.getIntValue(rs.getString("imageFileId"),0);
  	                    docId_related=Util.getIntValue(rs.getString("docId"),0);                
  	                }
  	                if(docId_related>0){
  	                    docIdList.add(""+docId_related);
  	                    hasDocId=true;
  	                }                   
  	            }
  	            if(!hasDocId&&fileId_related>0){
  	                rs.executeSql("select  docId from docImageFile where imageFileId="+fileId_related);
  	                while(rs.next()){
  	                    docId=rs.getString(1);
  	                    if(docId!=null&&!docId.equals("")){
  	                        docIdList.add(docId);
  	                    }
  	                }               
  	            }
  
  	        }
  	        if(docIdList.size()>0){
  	            hasRight=false;         
  	        }
  	        String mustLogin=Util.null2String(rs.getPropValue("FileDownload","mustLogin"));
  	        if(user==null){
  	            if(mustLogin.equals("1")){
  	                hasRight=false; 
  	            }
  	            return hasRight;
  	        }
  	        String comefrom_noNeedAuth=Util.null2String(rs.getPropValue("FileDownload","comefrom_noNeedAuth"));
  	        if((","+comefrom_noNeedAuth+",").indexOf(","+comefrom+",")>=0){
  	            hasRight=true;
  	            return hasRight;
  	        }       
  	        DocManager docManager=new DocManager();
  	        String docStatus="";
  	        int isHistory=0;
  	        int secCategory=0;
  	        String docPublishType="";//\u6587\u6863\u53d1\u5e03\u7c7b\u578b  1:\u6b63\u5e38(\u4e0d\u53d1\u5e03)  2:\u65b0\u95fb  3:\u6807\u9898\u65b0\u95fb
  	        for(int i=0;i<docIdList.size()&&!hasRight;i++){
  	            docId=(String)docIdList.get(i);
  	            isDocFile=true;
  	            if(docId==null||docId.trim().equals("")){
  	                continue;
  	            }
  	            docManager.resetParameter();
  	            docManager.setId(Integer.parseInt(docId));
  	            try {
  					docManager.getDocInfoById();
  				} catch (Exception e) {
  					// TODO Auto-generated catch block
  					e.printStackTrace();
  				}
  	            docStatus=docManager.getDocstatus();            
  	            isHistory = docManager.getIsHistory();
  	            secCategory=docManager.getSeccategory();    
  	            docPublishType=docManager.getDocpublishtype();
  	            if(docPublishType!=null&&(docPublishType.equals("2")||docPublishType.equals("3"))){
  	                String newsClause="";
  	                String sqlDocExist=" select 1 from DocDetail where id="+docId+" "; 
  	                String sqlNewsClauseOr="";
  	                boolean hasOuterNews=false;             
  	                rs.executeSql("select newsClause from DocFrontPage where publishType='0'");
  	                while(rs.next()){
  	                    hasOuterNews=true;                  
  	                    newsClause=Util.null2String(rs.getString("newsClause"));
  	                    if (newsClause.equals(""))
  	                    {
  	                        hasRight=true;
  	                        break;
  	                    }
  	                    if(!newsClause.trim().equals("")){
  	                        sqlNewsClauseOr+=" ^_^ ("+newsClause+")";                       
  	                    }
  	                }
  	                ArrayList newsArr = new ArrayList();
  	                if(!sqlNewsClauseOr.equals("")&&!hasRight){
  	                    String[] newsPage = Util.TokenizerString2(sqlNewsClauseOr,"^_^");
  	                    int k = 0;
  	                    String newsWhere = "";                  
  	                    for(;k<newsPage.length;k++){
  	                        if(k%10==0){
  	                            newsArr.add(newsWhere);
  	                            newsWhere="";
  	                            newsWhere+=newsPage[k];
  	                        }else
  	                            newsWhere+=" or "+newsPage[k];  
  	                    }
  	                    newsArr.add(newsWhere);
  	                }
  	                if(hasOuterNews&&!hasRight){
  	                    for(int j=1;j<newsArr.size();j++){  
  	                        String newsp = newsArr.get(j).toString();                       
  	                        if(j==1)
  	                            newsp = newsp.substring(newsp.indexOf("or")+2);
  	                        sqlDocExist+="and("+newsp+")";
  	                        rs.executeSql(sqlDocExist);
  	                        sqlDocExist = " select 1 from DocDetail where id="+docId+" "; 
  	                        if(rs.next()){
  	                            hasRight=false;
  	                            break;
  	                        }
  	                    }
  	                }               
  	            }
  	            if(user==null){
  	                continue;
  	            }
  	            String userId=""+user.getUID();
  	            String loginType = user.getLogintype();
  	            String userSeclevel = user.getSeclevel();
  	            String userType = ""+user.getType();
  	            String userDepartment = ""+user.getUserDepartment();
  	            String userSubComany = ""+user.getUserSubCompany1();
  	            String userInfo=loginType+"_"+userId+"_"+userSeclevel+"_"+userType+"_"+userDepartment+"_"+userSubComany;
  	            ArrayList PdocList = null;
  	            SpopForDoc  spopForDoc=new SpopForDoc();
  	            PdocList = spopForDoc.getDocOpratePopedom(""+docId,userInfo);               
  	            SecCategoryComInfo secCategoryComInfo=new SecCategoryComInfo();
  	            //0:\u67e5\u770b  
  	            boolean canReader = false;
  	            //1:\u7f16\u8f91
  	    		boolean canEdit = false;
  	    		//5:\u4e0b\u8f7d
  	            if (((String)PdocList.get(0)).equals("true")) {canReader = true ;}
  	    		if (((String)PdocList.get(1)).equals("true")) {canEdit = true ;}
  	    		if (((String)PdocList.get(5)).equals("true")) {hasRight = true ;}//TD12005
  	            String readerCanViewHistoryEdition=secCategoryComInfo.isReaderCanViewHistoryEdition(secCategory)?"1":"0";
  	            if(canReader && ((!docStatus.equals("7")&&!docStatus.equals("8")) 
  	                    ||(docStatus.equals("7")&&isHistory==1&&readerCanViewHistoryEdition.equals("1"))
  	                  )){
  	                canReader = true;
  	            }else{
  	                canReader = false;
  	            }
  	            if(isHistory==1) {
  	                if(secCategoryComInfo.isReaderCanViewHistoryEdition(secCategory)){
  	                    if(canReader && !canEdit) canReader = true;
  	                } else {
  	                    if(canReader && !canEdit) canReader = false;
  	                }
  	            }   
  	            if(canEdit && ((docStatus.equals("3") || docStatus.equals("5") || docStatus.equals("6") || docStatus.equals("7")) || isHistory==1)) {
  	                canEdit = false;
  	                canReader = true;
  	            }
  	            if(canEdit && (docStatus.equals("0") || docStatus.equals("1") || docStatus.equals("2") || docStatus.equals("7")) && (isHistory!=1))
  	                canEdit = true;
  	            else
  	                canEdit = false;
  	    		if(canReader){//\u624b\u673a\u7aef\u6682\u65f6\u65e0\u6cd5\u5728\u7ebf\u9884\u89c8\uff0c\u6709\u67e5\u770b\u6743\u9650\u5c31\u5e94\u8be5\u5141\u8bb8\u4e0b\u8f7d
  	                hasRight=true;
  	            }
  	        }
  	        //\u6587\u6863\u6a21\u5757  \u9644\u4ef6\u67e5\u770b\u6743\u9650\u63a7\u5236  \u7ed3\u675f        
  	        return hasRight;
  }

  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("application/x-download");
    response.setCharacterEncoding("UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      weaver.mobile.plugin.ecology.service.PluginServiceImpl ps;
      ps = (weaver.mobile.plugin.ecology.service.PluginServiceImpl) pageContext.getAttribute("ps");
      if (ps == null) {
        ps = new weaver.mobile.plugin.ecology.service.PluginServiceImpl();
        pageContext.setAttribute("ps", ps);
      }
      
//\u4e0a\u9762\u8fd9\u53e5\u8bdd\u7684<%\u4e00\u5b9a\u4e0d\u8981\u6572\u5230\u4e0b\u9762\u6765\uff0c\u5426\u5219\u4f1a\u5bfc\u81f4\u8f93\u51fa\u7684\u9644\u4ef6\u6253\u4e0d\u5f00\u6216\u5185\u5bb9\u4e71\u7801
String userid = Util.null2String(request.getParameter("userid"));
String markId = Util.null2String(request.getParameter("markId"));
String url = Util.null2String(request.getParameter("url"));
String sessionkey = Util.null2String(request.getParameter("sessionkey"));
//\u6765\u81ea\u4e8e\u624b\u673a\u7248\u7684\u90ae\u4ef6\u9644\u4ef6\u4e0b\u8f7d
String form_email= Util.null2String(request.getParameter("form_email"));

String from= Util.null2String(request.getParameter("from"));

FileUpload fu = new FileUpload(request);
if(from.isEmpty()){
	from = Util.null2String(fu.getParameter("from"));
}
//\u662f\u5426\u7f29\u7565\u56fe
String thumbnail= Util.null2String(request.getParameter("thumbnail"));
int shareFlag = 1;

String filepath = "";
String iszip = "";
String filename = "";
String contenttype = "";
String markType = "";
String isaesencrypt="";
String aescode = "";
InputStream is = null;

if(ps.verify(sessionkey)) {
	if("networkdisk".equals(from)) {
	    
	    String fileid = Util.null2String(request.getParameter("fileid"));
	    String type = Util.null2String(request.getParameter("type"));
	    String targetid = Util.null2String(request.getParameter("targetid"));
	    
	    type = type.equals("myshare") ? "myShare" : type;
	  	type = type.equals("shareme") ? "shareMy" : type;
	    
	    if(!targetid.isEmpty() && ("myShare".equals(type) || "shareMy".equals(type))){
		    NetworkFileLogServer networkFileLogServer = new NetworkFileLogServer();
		    User user = new User();
		    Map map = ps.getCurrUser(sessionkey);
		    user.setUid(Util.getIntValue(Util.null2String(map.get("id"))));
		    
		    RecordSet rs = new RecordSet();
		    rs.executeSql("select createrid from ImageFileRef where imagefileid=" + fileid);
		    String sharerid = "";
		    if(rs.next()){
		        sharerid = Util.null2String(rs.getString("createrid"));
		    }
		    
		    
		    shareFlag = networkFileLogServer.checkShare("pdoc",sharerid,targetid,fileid,user);
	    }else if("document".equals(type)){
			shareFlag = 1;
		}
		
	    if(shareFlag == 1){
	            ImageFileManager imageFileManager=new ImageFileManager();
	            imageFileManager.getImageFileInfoById(Util.getIntValue(fileid));
	            is = imageFileManager.getInputStream();
	            filename = imageFileManager.getImageFileName();
				int pdfFileId = 0;
				String file2pdf = Util.null2String(request.getParameter("file2pdf"));
				if("1".equals(file2pdf)){
						boolean isUsePDFViewer = ConvertPDFUtil.isUsePDFViewer();
				
					if(isUsePDFViewer){		
						if(filename.endsWith(".doc") || filename.endsWith(".docx") || filename.endsWith(".xls") || filename.endsWith(".xlsx") ||
							filename.endsWith(".ppt") || filename.endsWith(".pptx") || filename.endsWith(".wps") || filename.endsWith(".txt")){
							RecordSet rs = new RecordSet();
							rs.executeSql("select * from pdf_imagefile where imagefileid="+fileid);
							if(rs.next()){
								pdfFileId = Util.getIntValue(rs.getString("pdfimagefileid"),0);
							}else{
								try{
									ConvertPDFTools convertPDFTools = new ConvertPDFTools();
									pdfFileId= convertPDFTools.conertToPdf(fileid+"");
								}catch(Exception e){}
							}
							
							filename += ".pdf";
						}else if(filename.endsWith(".pdf")){
							filename += ".pdf";
						}
						if(pdfFileId > 0){
							imageFileManager.getImageFileInfoById(pdfFileId);
							is = imageFileManager.getInputStream();
						}
					}
				
				}else{
					String extName = "";
					if(filename.indexOf(".") > -1){
						int bx = filename.lastIndexOf(".");
						extName = filename.substring(bx+1, filename.length());
					}					
					if("xls".equalsIgnoreCase(extName) || "doc".equalsIgnoreCase(extName) || "ppt".equalsIgnoreCase(extName)
							|| "xlsx".equalsIgnoreCase(extName) || "docx".equalsIgnoreCase(extName) || "pptx".equalsIgnoreCase(extName)
							|| "wps".equalsIgnoreCase(extName) || "et".equalsIgnoreCase(extName)) {
						//\u6b63\u6587\u7684\u5904\u7406
						ByteArrayOutputStream bout = null;
						try {
							int byteread = 0;
							byte[] rbs = new byte[2048];
							bout = new ByteArrayOutputStream();
							while((byteread = is.read(rbs)) != -1) {
								bout.write(rbs, 0, byteread);
								bout.flush();
							}
							byte[] fileBody = bout.toByteArray();
							iMsgServer2000 MsgObj = new DBstep.iMsgServer2000();
							MsgObj.MsgFileBody(fileBody);			//\u5c06\u6587\u4ef6\u4fe1\u606f\u6253\u5305
							fileBody = MsgObj.ToDocument(MsgObj.MsgFileBody());    //\u901a\u8fc7iMsgServer200 \u5c06pgf\u6587\u4ef6\u6d41\u8f6c\u5316\u4e3a\u666e\u901aOffice\u6587\u4ef6\u6d41
							is = new ByteArrayInputStream(fileBody);
							bout.close();
						}
						catch(Exception e) {
							if(bout!=null) {
								bout.close();
							}
						}
					}
				}
	    }
		
	}
	else if("emessage".equals(from)) {
		filename = url;
		filepath = EMessageService.getCachePath() + File.separator + filename;
		
		if("1".equals(thumbnail)) {
			int pos = url.lastIndexOf('.');
			filename = (pos == -1) ? url : url.substring(0, pos);
			filename += ".jpg";
			filepath = EMessageService.getCachePath() + File.separator + "thumbnail" + File.separator + filename;
		}
		
		File file = new File(filepath);
		if(file.exists() && file.getCanonicalPath().startsWith(EMessageService.getCachePath())) {
			is = new BufferedInputStream(new FileInputStream(file));
		}
	} else if("1".equals(form_email)){//\u624b\u673a\u90ae\u4ef6\u7684\u9644\u4ef6
			String emlsql ="select isaesencrypt,aescode,filerealpath,iszip,filename,filetype  from mailresourcefile where id="+url;
		 	RecordSet rs = new RecordSet();
		     	rs.executeSql(emlsql);
			if(rs.next()) {
				filepath = rs.getString("filerealpath");
				iszip = rs.getString("iszip");
				filename = rs.getString("filename");
				contenttype = rs.getString("filetype");
				isaesencrypt = rs.getString("isaesencrypt");
				aescode = rs.getString("aescode");
				

				//\u90ae\u4ef6\u9644\u4ef6\u76ee\u524d\u8fd8\u6ca1\u6709\u5b58\u653e\u5230\u963f\u91cc\u4e91
				File file = new File(filepath);
				if (Util.getIntValue(iszip) > 0) {
					ZipInputStream zin = new ZipInputStream(new FileInputStream(file));
					if (zin.getNextEntry() != null)
						is = new BufferedInputStream(zin);
				} else {
					is = new BufferedInputStream(new FileInputStream(file));
				}
				
				if(isaesencrypt.equals("1")){
					is = AESCoder.decrypt(is,aescode);
				}
				/*
				ImageFileManager imageFileManager=new ImageFileManager();
                imageFileManager.getImageFileInfoById(Util.getIntValue(url,0));
                is=imageFileManager.getInputStream();
				*/
			
			}
	}else if("onlyForward".equals(from)){	//\u8868\u5355\u8bbe\u8ba1\u5668\u4e8c\u7ef4\u7801\u3001\u6761\u5f62\u7801
		String forwardurl = Util.null2String(request.getParameter("forwardurl"));
		request.getRequestDispatcher(forwardurl).forward(request, response);
		return;
	}else{

				if (markId!=""&&userid!="") {
					//\u7535\u5b50\u7b7e\u7ae0\u7684\u524d\u7aef\u663e\u793a\u6539\u7528\u5176\u5b83\u5730\u5740\u3002
					return;
				} else {
					if(Util.getIntValue(url)>0) {
						
						RecordSet rs = new RecordSet();
						
					boolean needUser = true;
					
					if(needUser){
							int docId = 0;
							String docIdsForOuterNews = "";
							String strSql = "select id from DocDetail where exists (select 1 from docimagefile where imagefileid=" + url + " "
									+ "and docId=DocDetail.id) and ishistory <> 1 and (docPublishType='2' or docPublishType='3')";
							rs.executeSql(strSql);
							while (rs.next()) {
								docId = rs.getInt("id");
								if (docId > 0) {
									docIdsForOuterNews += "," + docId;
								}
							}
							if (!docIdsForOuterNews.equals("")) {
								docIdsForOuterNews = docIdsForOuterNews.substring(1);
							}
							if (!docIdsForOuterNews.equals("")) {
								String newsClause = "";
								String sqlDocExist = " select 1 from DocDetail where id in(" + docIdsForOuterNews + ") ";
								String sqlNewsClauseOr = "";
								boolean hasOuterNews = false;
								rs.executeSql("select newsClause from DocFrontPage where publishType='0'");
								while (rs.next()) {
									hasOuterNews = true;
									newsClause = Util.null2String(rs.getString("newsClause"));
									if (newsClause.equals("")) {
										needUser = false;
										break;
									}
									if (!newsClause.trim().equals("")) {
										sqlNewsClauseOr += " ^_^ (" + newsClause + ")";
									}
								}
								ArrayList newsArr = new ArrayList();
								if (!sqlNewsClauseOr.equals("") && needUser) {
									String[] newsPage = Util.TokenizerString2(sqlNewsClauseOr, "^_^");
									int i = 0;
									String newsWhere = "";
									for (; i < newsPage.length; i++) {
										if (i % 10 == 0) {
											newsArr.add(newsWhere);
											newsWhere = "";
											newsWhere += newsPage[i];
										} else
											newsWhere += " or " + newsPage[i];
									}
									newsArr.add(newsWhere);
								}
								if (hasOuterNews && needUser) {
									for (int j = 1; j < newsArr.size(); j++) {
										String newsp = newsArr.get(j).toString();
										if (j == 1)
											newsp = newsp.substring(newsp.indexOf("or") + 2);
										sqlDocExist += "and(" + newsp + ")";
										rs.executeSql(sqlDocExist);
										sqlDocExist = " select 1 from DocDetail where id in(" + docIdsForOuterNews + ") ";
										if (rs.next()) {
											needUser = false;
											break;
										}
									}
								}
							}
							//\u5904\u7406\u5916\u7f51\u67e5\u770b\u9ed8\u8ba4\u56fe\u7247
							rs.executeSql("SELECT * FROM DocPicUpload  WHERE  Imagefileid=" + url);
							if (rs.next()) {
								needUser = false;
							}
					
					}
					//needUser = false;
					
					boolean hasRight = false;
				    User user = HrmUserVarify.getUser (request , response) ;
				    if(user == null) return;
				    if (needUser) {
						hasRight=getWhetherHasRight(url,user);
					} else {
						hasRight = true;
					}
					
					rs.executeSql("select  docId from docImageFile where imageFileId="+url);
					boolean hasDoc = false;
					int docid = 0;
					if(rs.next()){
					    hasDoc = true;
					    docid = rs.getInt("docid");
					}
					
					if(hasDoc && !hasRight){
						//\u6d41\u7a0b\u5224\u65ad
						String logintype = user.getLogintype();
						int requestid = Util.getIntValue(request.getParameter("requestid"));
				        if(!hasRight && requestid > 0){
				            WFUrgerManager wfu = new WFUrgerManager();
				            hasRight=wfu.OperHaveDocViewRight(requestid,user.getUID(),Util.getIntValue(logintype,1),""+docid);
				            
				            //\u53e6\u5916\u4e00\u79cd\u60c5\u51b5,\u5b50\u6d41\u7a0b\u89e6\u53d1\u7684,\u5f53\u524d\u6d41\u7a0b\u521b\u5efa\u4eba\u53ef\u4ee5\u67e5\u770b\u6587\u6863
				            if(!hasRight) {
				                rs.executeQuery("SELECT 1 FROM workflow_requestbase WHERE requestid="+requestid+" and creater="+userid);
				                if(rs.next()) {
				                    hasRight=true;
				                }
				            }
				            
				            if(!hasRight){
				                rs.writeLog("^^^^^^ E8\u6d41\u7a0b\u5224\u65ad\u6587\u6863\u6ca1\u6743\u9650(" + docid + ")^^^^^^^^requestid=" + requestid);
				            }
				        }
				        
				        
				        //\u65e5\u7a0b
				        boolean noMeetingDocRight = true;
				        int meetingid = Util.getIntValue(request.getParameter("meetingid"));
				        if(meetingid > 0 && !hasRight){
				            MeetingUtil mu = new MeetingUtil();
				            noMeetingDocRight = !mu.UrgerHaveMeetingDocViewRight(""+meetingid,user,Util.getIntValue(logintype),""+docid);
				            if(!noMeetingDocRight)
				            {
				                hasRight=true;
				            }
				            
				            if(!hasRight){
				               rs.writeLog("^^^^^^ \u65e5\u7a0b\u5224\u65ad\u6587\u6863\u6ca1\u6743\u9650(" + docid + ")^^^^^^^^meetingid=" + meetingid);
				            }
				        }
				        //\u8ba1\u5212
				        int workplanid = Util.getIntValue(request.getParameter("workplanid"));
				        boolean noWorkplanDocRight = true;
				        if(workplanid > 0 && !hasRight)
				        {
				            WorkPlanService workplanService = new WorkPlanService();
				            noWorkplanDocRight = !workplanService.UrgerHaveWorkplanDocViewRight(""+workplanid,user,Util.getIntValue(logintype),""+docid);
				            if(!noWorkplanDocRight)
				            {
				                hasRight=true;
				            }
				            if(!hasRight){
				                rs.writeLog("^^^^^^ \u8ba1\u5212\u5224\u65ad\u6587\u6863\u6ca1\u6743\u9650(" + docid + ")^^^^^^^^workplanid=" + workplanid);
				            }
				        }
	
				        //\u5de5\u4f5c\u5fae\u535a\u70b9\u51fb\u67e5\u770b\u6587\u6863
				        int blogDiscussid = Util.getIntValue(request.getParameter("blogDiscussid"),-1);
				        if(!hasRight && blogDiscussid != 0){
				            //\u5de5\u4f5c\u5fae\u535a\u8bb0\u5f55id
				            BlogDao bd = new BlogDao();
				            if(bd.appViewRight("doc",""+userid,docid,blogDiscussid)){   
				                CoworkDAO cd = new CoworkDAO();
				                cd.shareCoworkRelateddoc(Util.getIntValue(logintype),docid,user.getUID());
				                hasRight=true;
				            }
				            if(!hasRight){
				                rs.writeLog("^^^^^^ \u5fae\u535a\u5224\u65ad\u6587\u6863\u6ca1\u6743\u9650(" + docid + ")^^^^^^^^blogDiscussid=" + blogDiscussid);
				            }
				        }
	
				        //\u534f\u4f5c\u533a\u70b9\u51fb\u67e5\u770b\u6587\u6863
				        int coworkid = Util.getIntValue(request.getParameter("coworkid"),-1);
				        if(!hasRight && coworkid != 0){
				            CoworkDAO cd = new CoworkDAO();
				            if(cd.haveViewCoworkDocRight(""+userid,""+coworkid,""+docid)) {
				               cd.shareCoworkRelateddoc(Util.getIntValue(logintype),docid,user.getUID());
				               hasRight=true;
				            }
				            if(!hasRight){
				                rs.writeLog("^^^^^^ \u534f\u4f5c\u5224\u65ad\u6587\u6863\u6ca1\u6743\u9650(" + docid + ")^^^^^^^^coworkid=" + coworkid);
				            }
				        }
					}
					
			        //\u68c0\u67e5\u793e\u4ea4\u5e73\u53f0\u9644\u52a0\u6743\u9650
		            hasRight = SocialIMService.checkFileRight(user, url, hasDoc, hasRight);
		            if(!hasRight){
                          rs.writeLog("^^^^^^ \u793e\u4ea4\u5e73\u53f0\u5224\u65ad\u6ca1\u6743\u9650(" + url + ")^^^^^^^^hasDoc=" + hasDoc);
                     }
					
					if (hasRight) {
						//\u6b63\u5e38
						String sql = "select b.docid,a.isaesencrypt,a.aescode,a.imagefilename,a.imagefiletype,a.filerealpath,a.iszip from imagefile a LEFT join docimagefile b ON a.imagefileid = b.imagefileid where a.imagefileid = " + url;
						
						rs.executeSql(sql);
						
						if(rs.next()) {
							String docId=rs.getString("docid");
							filepath = rs.getString("filerealpath");
							iszip = rs.getString("iszip");
							filename = rs.getString("imagefilename");
							contenttype = rs.getString("imagefiletype");
							isaesencrypt = rs.getString("isaesencrypt");
							aescode = rs.getString("aescode");
							
							if(docId != null && !"".equals(docId)){
								RecordSet record = new RecordSet();
								record.executeSql("select usertype,doccreaterid from docdetail where id="+docId+"");
								if(record.next()){
									String usertype=Util.null2String(record.getString("usertype"));
									int doccreaterid = record.getInt(2);
									
									int uuid=user.getUID();
									String logintype = user.getLogintype();
									if(uuid != doccreaterid || !usertype.equals(logintype)){
										char flag=Util.getSeparator() ;
										record.executeProc("docReadTag_AddByUser",""+docId+flag+uuid+flag+logintype);
									}
								}
							}
							String extName = "";
							if(filename.indexOf(".") > -1){
								int bx = filename.lastIndexOf(".");
								extName = filename.substring(bx+1, filename.length());
							}
							
							ImageFileManager imageFileManager=new ImageFileManager();
                            imageFileManager.getImageFileInfoById(Util.getIntValue(url,0));
                            is=imageFileManager.getInputStream();
							if("xls".equalsIgnoreCase(extName) || "doc".equalsIgnoreCase(extName) || "ppt".equalsIgnoreCase(extName)
									|| "xlsx".equalsIgnoreCase(extName) || "docx".equalsIgnoreCase(extName) || "pptx".equalsIgnoreCase(extName)
									|| "wps".equalsIgnoreCase(extName) || "et".equalsIgnoreCase(extName)) {
								//\u6b63\u6587\u7684\u5904\u7406
								ByteArrayOutputStream bout = null;
								try {
									int byteread = 0;
									byte[] rbs = new byte[2048];
									bout = new ByteArrayOutputStream();
					                while((byteread = is.read(rbs)) != -1) {
					                    bout.write(rbs, 0, byteread);
					                    bout.flush();
					                }
					                byte[] fileBody = bout.toByteArray();
					                iMsgServer2000 MsgObj = new DBstep.iMsgServer2000();
									MsgObj.MsgFileBody(fileBody);			//\u5c06\u6587\u4ef6\u4fe1\u606f\u6253\u5305
									fileBody = MsgObj.ToDocument(MsgObj.MsgFileBody());    //\u901a\u8fc7iMsgServer200 \u5c06pgf\u6587\u4ef6\u6d41\u8f6c\u5316\u4e3a\u666e\u901aOffice\u6587\u4ef6\u6d41
					                is = new ByteArrayInputStream(fileBody);
					                bout.close();
								}
								catch(Exception e) {
									if(bout!=null) {
										bout.close();
									}
								}
							}
						
						}
						}
					} else {
						Enumeration enumeration = request.getParameterNames();
						while (enumeration.hasMoreElements()) {
							String parameterName = (String) enumeration.nextElement();
							if(parameterName.equals("sessionkey")) continue;
							if(parameterName.equals("url")) continue;
							String urlSeparator = "&";
							if(url.indexOf("?")==-1) urlSeparator = "?";
							if(url.indexOf(parameterName)==-1) {
								Object parameterValue = request.getParameter(parameterName);
								String value = parameterValue.toString();
								url += urlSeparator + parameterName + "=" + value;
							}
						}
						request.getRequestDispatcher(url).forward(request, response);
						return;
					}
				}
	}
}//end ps.verify(sessionkey)
else{//\u5916\u7f51\u67e5\u770b\u56fe\u7247\u652f\u6301\uff0c\u65e0\u9700\u7528\u6237\uff0cqc\uff1a411981
	if(Util.getIntValue(url)>0) {
		
		RecordSet rs = new RecordSet();
		
		boolean needUser = true;
		
		if(needUser){
			int docId = 0;
			String docIdsForOuterNews = "";
			String strSql = "select id from DocDetail where exists (select 1 from docimagefile where imagefileid=" + url + " "
					+ "and docId=DocDetail.id) and ishistory <> 1 and (docPublishType='2' or docPublishType='3')";
			rs.executeSql(strSql);
			while (rs.next()) {
				docId = rs.getInt("id");
				if (docId > 0) {
					docIdsForOuterNews += "," + docId;
				}
			}
			if (!docIdsForOuterNews.equals("")) {
				docIdsForOuterNews = docIdsForOuterNews.substring(1);
			}
			if (!docIdsForOuterNews.equals("")) {
				String newsClause = "";
				String sqlDocExist = " select 1 from DocDetail where id in(" + docIdsForOuterNews + ") ";
				String sqlNewsClauseOr = "";
				boolean hasOuterNews = false;
				rs.executeSql("select newsClause from DocFrontPage where publishType='0'");
				while (rs.next()) {
					hasOuterNews = true;
					newsClause = Util.null2String(rs.getString("newsClause"));
					if (newsClause.equals("")) {
						needUser = false;
						break;
					}
					if (!newsClause.trim().equals("")) {
						sqlNewsClauseOr += " ^_^ (" + newsClause + ")";
					}
				}
				ArrayList newsArr = new ArrayList();
				if (!sqlNewsClauseOr.equals("") && needUser) {
					String[] newsPage = Util.TokenizerString2(sqlNewsClauseOr, "^_^");
					int i = 0;
					String newsWhere = "";
					for (; i < newsPage.length; i++) {
						if (i % 10 == 0) {
							newsArr.add(newsWhere);
							newsWhere = "";
							newsWhere += newsPage[i];
						} else
							newsWhere += " or " + newsPage[i];
					}
					newsArr.add(newsWhere);
				}
				if (hasOuterNews && needUser) {
					for (int j = 1; j < newsArr.size(); j++) {
						String newsp = newsArr.get(j).toString();
						if (j == 1)
							newsp = newsp.substring(newsp.indexOf("or") + 2);
						sqlDocExist += "and(" + newsp + ")";
						rs.executeSql(sqlDocExist);
						sqlDocExist = " select 1 from DocDetail where id in(" + docIdsForOuterNews + ") ";
						if (rs.next()) {
							needUser = false;
							break;
						}
					}
				}
			}
			//\u5904\u7406\u5916\u7f51\u67e5\u770b\u9ed8\u8ba4\u56fe\u7247
			rs.executeSql("SELECT * FROM DocPicUpload  WHERE  Imagefileid=" + url);
			if (rs.next()) {
				needUser = false;
			}
		}
		if(needUser){
			return;
		}
	
		//\u6b63\u5e38
		String sql = "select b.docid,a.isaesencrypt,a.aescode,a.imagefilename,a.imagefiletype,a.filerealpath,a.iszip from imagefile a LEFT join docimagefile b ON a.imagefileid = b.imagefileid where a.imagefileid = " + url;
		
		rs.executeSql(sql);
		
		if(rs.next()) {
			String docId=rs.getString("docid");
			filepath = rs.getString("filerealpath");
			iszip = rs.getString("iszip");
			filename = rs.getString("imagefilename");
			contenttype = rs.getString("imagefiletype");
			isaesencrypt = rs.getString("isaesencrypt");
			aescode = rs.getString("aescode");
			
			String extName = "";
			if(filename.indexOf(".") > -1){
				int bx = filename.lastIndexOf(".");
				extName = filename.substring(bx+1, filename.length());
			}
			if("jpg".equalsIgnoreCase(extName) || "jpeg".equalsIgnoreCase(extName) 
					|| "png".equalsIgnoreCase(extName) || "gif".equalsIgnoreCase(extName) || "bmp".equalsIgnoreCase(extName)) {
				ImageFileManager imageFileManager=new ImageFileManager();
	            imageFileManager.getImageFileInfoById(Util.getIntValue(url,0));
	            is=imageFileManager.getInputStream();
			}
		}
	}
}
	if(is != null) {
		
			try {
				
				response.setHeader("Content-disposition","attachment; filename=" + URLEncoder.encode(filename,"UTF-8"));
				String prefix=filename.substring(filename.lastIndexOf(".")+1);
				if(!"".equals(prefix)){
					response.setContentType("application/"+prefix);	
				}

				byte[] rbs = new byte[2048];
				OutputStream outp = response.getOutputStream();
				int len = 0;
				while (((len = is.read(rbs)) > 0)) {
					outp.write(rbs, 0, len);
				}

				outp.flush();
				//out.clear();
				out = pageContext.pushBody();

			} catch (Exception e) {
				e.printStackTrace();
			} finally {
				if (is != null) {
					is.close();
					is = null;
				}
			}
			return;
	} else {
	    if(shareFlag == 2){ //\u6587\u4ef6\u5df2\u5220\u9664
	       // request.getRequestDispatcher("/mobile/plugin/networkdisk/shareMessage.jsp?shareFlag=2").forward(request, response);
	        //response.sendError(-1);
	        //response.sendError()
	        out.print("{\"status\":-1,\"msg\":\"\u6587\u4ef6\u5df2\u5220\u9664\"}");
	    }else if(shareFlag == 3){//\u5171\u4eab\u5df2\u53d6\u6d88
	       // response.sendError(-2);
	        out.print("{\"status\":-2,\"msg\":\"\u5171\u4eab\u5df2\u53d6\u6d88\"}");
	      //  request.getRequestDispatcher("/mobile/plugin/networkdisk/shareMessage.jsp?shareFlag=3").forward(request, response);
	    }else{
			response.sendError(HttpServletResponse.SC_NOT_FOUND);
	    }
	}

      out.write(_jsp_string0, 0, _jsp_string0.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("mobile/plugin/Download.jsp"), 2927329351170505357L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  static {
    _jsp_string0 = "\r\n".toCharArray();
  }
}
