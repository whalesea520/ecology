/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._mobile._plugin;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import java.net.*;
import java.util.*;
import java.io.*;
import java.text.*;
import weaver.hrm.User;
import java.text.SimpleDateFormat;
import org.apache.commons.lang.*;
import org.json.JSONObject;
import org.json.JSONArray;
import weaver.general.*;
import weaver.file.*;
import weaver.hrm.*;
import weaver.login.Account;
import weaver.wxinterface.InterfaceUtil;
import weaver.wxinterface.WxInterfaceInit;
import weaver.wxinterface.MsgRuleSetting;
import weaver.hrm.report.schedulediff.HrmScheduleDiffUtil;
import weaver.mobile.webservices.workflow.*;
import java.lang.reflect.Method;
import weaver.hrm.resource.ResourceComInfo;
import weaver.hrm.company.DepartmentComInfo;
import weaver.hrm.company.SubCompanyComInfo;
import weaver.conn.RecordSet;

public class _wxinterface__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;

  
  	public boolean isutf8(){
  		/* //\u5224\u65ad\u7f16\u7801
  		 File bf = new File(GCONST.getRootPath()+"systeminfo"+File.separatorChar+"init_wev8.jsp");
  		if(bf.exists()){
  			return true;
  		}
  		return false;  */
  		
  		return WxInterfaceInit.isIsutf8();
  	}
  	public void getUserList(User user,int type,int pid,List<Map<String,String>> rData){
  		try{
  			String sql = "";//\u52a0\u5165\u5206\u6743\u63a7\u5236
  			try{
  				Class pvm = Class.forName("weaver.hrm.appdetach.AppDetachComInfo");
  				Method m = pvm.getDeclaredMethod("getScopeSqlByHrmResourceSearch",String.class);
  				sql = (String)m.invoke(pvm.newInstance(),user.getUID()+"");
  			}catch(Exception e){
  				
  			}
  			if(sql.equals("")){//\u6ca1\u6709\u5206\u6743 \u4ece\u7f13\u5b58\u83b7\u53d6\u4eba\u5458
  				ResourceComInfo resourceComInfo = new ResourceComInfo();
  				resourceComInfo.setTofirstRow();
  				DepartmentComInfo dci = new DepartmentComInfo();
  				while(resourceComInfo.next()){
  					if(type==1){
  						if(Util.getIntValue(resourceComInfo.getSubCompanyID())!=pid||
  								dci.getIdIndexKey(resourceComInfo.getDepartmentID())>-1||
  								(Util.getIntValue(resourceComInfo.getStatus())!=0&&Util.getIntValue(resourceComInfo.getStatus())!=1&&
  								Util.getIntValue(resourceComInfo.getStatus())!=2&&Util.getIntValue(resourceComInfo.getStatus())!=3)) 
  							continue;
  					}else if(type==2){
  						if(Util.getIntValue(resourceComInfo.getDepartmentID())!=pid||
  								(Util.getIntValue(resourceComInfo.getStatus())!=0&&Util.getIntValue(resourceComInfo.getStatus())!=1&&
  								Util.getIntValue(resourceComInfo.getStatus())!=2&&Util.getIntValue(resourceComInfo.getStatus())!=3)) 
  							continue;
  					}
  					String id = Util.null2String(resourceComInfo.getResourceid());
  					String lastname = Util.null2String(resourceComInfo.getLastname());
  					String mobile = Util.null2String(resourceComInfo.getMobile()).trim();
  					String tel = Util.null2String(resourceComInfo.getTelephone()).trim();
  					String mail = Util.null2String(resourceComInfo.getEmail()).trim();
  					getUserInfo(3,id,lastname,mobile,tel,mail,rData);
  				}
  			}else{
  				RecordSet rs = new RecordSet();
  				String sql2 = "select * from HrmResource where (status =0 or status =1 or status =2 or status =3)";
  				if(type==1){
  					sql2+=" and subcompanyid1 = "+pid+" and (departmentid = '' or departmentid is null)";
  				}else if(type==2){
  					sql2+=" and departmentid = "+pid;
  				}
  				sql2+=" and "+sql+" order by dsporder asc,id asc";
  				rs.executeSql(sql2);
  				while(rs.next()){
  					String id = Util.null2String(rs.getString("id"));
  					String lastname = Util.null2String(rs.getString("lastname"));
  					String mobile = Util.null2String(rs.getString("mobile"));
  					String tel = Util.null2String(rs.getString("telephone"));
  					String mail = Util.null2String(rs.getString("email"));
  					getUserInfo(3,id,lastname,mobile,tel,mail,rData);
  				}
  			}
  		}catch(Exception e){
  			
  		}
  	}
  	
  	public void getUserInfo(int type,String id,String name,String mobile,String tel,String mail,List<Map<String,String>> rData){
  		Map<String,String> data = new HashMap<String, String>();
  		data.put("type",type+"");
  		data.put("name",name);
  		data.put("id",id);
  		data.put("mobile",mobile);
  		data.put("tel", tel);
  		data.put("mail",mail);
  		rData.add(data);
  	}
  	private String getAllSupDepartment(String subId,DepartmentComInfo rs,int loopLevel,String str){
  	    try{
  		    if(rs==null){
  		        rs = new DepartmentComInfo();
  		    }
  		    String depid = rs.getDepartmentsupdepid(subId);
  		    if (depid==null||depid.equals("") || depid.equals("0")||depid.equals(subId)
  		    		||(","+str+",").indexOf(","+depid+",")>-1||loopLevel>1000)
  		        return str;
  		    str += ","+depid;
  		    loopLevel++;
  		    str = getAllSupDepartment(depid,rs,loopLevel,str);
  		}catch(Exception e){
  			
  		}
  	    return str;
  	}
  	private String getAllSupSubCompany(String subId,SubCompanyComInfo rs,int loopLevel,String str){
  	    try{
  		    if(rs==null){
  		        rs = new SubCompanyComInfo();
  		    }
  		    String subpid = rs.getSupsubcomid(subId);
  		    if (subpid==null||subpid.equals("") || subpid.equals("0")||subpid.equals(subId)
  		    		||(","+str+",").indexOf(","+subpid+",")>-1||loopLevel>10000)
  		        return str;
  		    str += ","+subpid;
  		    loopLevel++;
  		    str = getAllSupSubCompany(subpid,rs,loopLevel,str);
  		}catch(Exception e){
  			
  		}
  	    return str;
  	}
  	
  	 public static String stampToDate(String s){
  	        String res;
  	        SimpleDateFormat simpleDateFormat = new SimpleDateFormat("yyyy-MM-dd");
  	        long lt = new Long(s);
  	        Date date = new Date(lt);
  	        res = simpleDateFormat.format(date);
  	        return res;
  	 }
  	 public static String stampToTime(String s){
  	        String res;
  	        SimpleDateFormat simpleDateFormat = new SimpleDateFormat("HH:mm:ss");
  	        long lt = new Long(s);
  	        Date date = new Date(lt);
  	        res = simpleDateFormat.format(date);
  	        return res;
  	 }

  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("application/json");
    response.setCharacterEncoding("GBK");
    request.setCharacterEncoding("GBK");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.mobile.plugin.ecology.service.PluginServiceImpl ps;
      ps = (weaver.mobile.plugin.ecology.service.PluginServiceImpl) pageContext.getAttribute("ps");
      if (ps == null) {
        ps = new weaver.mobile.plugin.ecology.service.PluginServiceImpl();
        pageContext.setAttribute("ps", ps);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.mobile.plugin.ecology.service.HrmResourceService hrs;
      hrs = (weaver.mobile.plugin.ecology.service.HrmResourceService) pageContext.getAttribute("hrs");
      if (hrs == null) {
        hrs = new weaver.mobile.plugin.ecology.service.HrmResourceService();
        pageContext.setAttribute("hrs", hrs);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.wxinterface.HrmResourceService hrs2;
      hrs2 = (weaver.wxinterface.HrmResourceService) pageContext.getAttribute("hrs2");
      if (hrs2 == null) {
        hrs2 = new weaver.wxinterface.HrmResourceService();
        pageContext.setAttribute("hrs2", hrs2);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.company.CompanyComInfo CompanyComInfo;
      CompanyComInfo = (weaver.hrm.company.CompanyComInfo) pageContext.getAttribute("CompanyComInfo");
      if (CompanyComInfo == null) {
        CompanyComInfo = new weaver.hrm.company.CompanyComInfo();
        pageContext.setAttribute("CompanyComInfo", CompanyComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.resource.ResourceComInfo ResourceComInfo;
      ResourceComInfo = (weaver.hrm.resource.ResourceComInfo) pageContext.getAttribute("ResourceComInfo");
      if (ResourceComInfo == null) {
        ResourceComInfo = new weaver.hrm.resource.ResourceComInfo();
        pageContext.setAttribute("ResourceComInfo", ResourceComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.company.SubCompanyComInfo SubCompanyComInfo;
      SubCompanyComInfo = (weaver.hrm.company.SubCompanyComInfo) pageContext.getAttribute("SubCompanyComInfo");
      if (SubCompanyComInfo == null) {
        SubCompanyComInfo = new weaver.hrm.company.SubCompanyComInfo();
        pageContext.setAttribute("SubCompanyComInfo", SubCompanyComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.company.DepartmentComInfo DepartmentComInfo;
      DepartmentComInfo = (weaver.hrm.company.DepartmentComInfo) pageContext.getAttribute("DepartmentComInfo");
      if (DepartmentComInfo == null) {
        DepartmentComInfo = new weaver.hrm.company.DepartmentComInfo();
        pageContext.setAttribute("DepartmentComInfo", DepartmentComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.job.JobTitlesComInfo JobTitlesComInfo;
      JobTitlesComInfo = (weaver.hrm.job.JobTitlesComInfo) pageContext.getAttribute("JobTitlesComInfo");
      if (JobTitlesComInfo == null) {
        JobTitlesComInfo = new weaver.hrm.job.JobTitlesComInfo();
        pageContext.setAttribute("JobTitlesComInfo", JobTitlesComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.login.VerifyLogin VerifyLogin;
      VerifyLogin = (weaver.login.VerifyLogin) pageContext.getAttribute("VerifyLogin");
      if (VerifyLogin == null) {
        VerifyLogin = new weaver.login.VerifyLogin();
        pageContext.setAttribute("VerifyLogin", VerifyLogin);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet rs;
      rs = (weaver.conn.RecordSet) pageContext.getAttribute("rs");
      if (rs == null) {
        rs = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs", rs);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet rs2;
      rs2 = (weaver.conn.RecordSet) pageContext.getAttribute("rs2");
      if (rs2 == null) {
        rs2 = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs2", rs2);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.mobile.webservices.workflow.WorkflowServiceImpl wsi;
      wsi = (weaver.mobile.webservices.workflow.WorkflowServiceImpl) pageContext.getAttribute("wsi");
      if (wsi == null) {
        wsi = new weaver.mobile.webservices.workflow.WorkflowServiceImpl();
        pageContext.setAttribute("wsi", wsi);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.sms.SMSManager sms;
      sms = (weaver.sms.SMSManager) pageContext.getAttribute("sms");
      if (sms == null) {
        sms = new weaver.sms.SMSManager();
        pageContext.setAttribute("sms", sms);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.company.CompanyComInfo cci;
      cci = (weaver.hrm.company.CompanyComInfo) pageContext.getAttribute("cci");
      if (cci == null) {
        cci = new weaver.hrm.company.CompanyComInfo();
        pageContext.setAttribute("cci", cci);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.company.SubCompanyComInfo sci;
      sci = (weaver.hrm.company.SubCompanyComInfo) pageContext.getAttribute("sci");
      if (sci == null) {
        sci = new weaver.hrm.company.SubCompanyComInfo();
        pageContext.setAttribute("sci", sci);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.company.DepartmentComInfo dci;
      dci = (weaver.hrm.company.DepartmentComInfo) pageContext.getAttribute("dci");
      if (dci == null) {
        dci = new weaver.hrm.company.DepartmentComInfo();
        pageContext.setAttribute("dci", dci);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.resource.ResourceComInfo rci;
      rci = (weaver.hrm.resource.ResourceComInfo) pageContext.getAttribute("rci");
      if (rci == null) {
        rci = new weaver.hrm.resource.ResourceComInfo();
        pageContext.setAttribute("rci", rci);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.docs.news.DocNewsComInfo docNewsComInfo;
      docNewsComInfo = (weaver.docs.news.DocNewsComInfo) pageContext.getAttribute("docNewsComInfo");
      if (docNewsComInfo == null) {
        docNewsComInfo = new weaver.docs.news.DocNewsComInfo();
        pageContext.setAttribute("docNewsComInfo", docNewsComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.docs.category.SecCategoryComInfo secCategoryComInfo;
      secCategoryComInfo = (weaver.docs.category.SecCategoryComInfo) pageContext.getAttribute("secCategoryComInfo");
      if (secCategoryComInfo == null) {
        secCategoryComInfo = new weaver.docs.category.SecCategoryComInfo();
        pageContext.setAttribute("secCategoryComInfo", secCategoryComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.docs.category.DocTreeDocFieldComInfo docTreeDocFieldComInfo;
      docTreeDocFieldComInfo = (weaver.docs.category.DocTreeDocFieldComInfo) pageContext.getAttribute("docTreeDocFieldComInfo");
      if (docTreeDocFieldComInfo == null) {
        docTreeDocFieldComInfo = new weaver.docs.category.DocTreeDocFieldComInfo();
        pageContext.setAttribute("docTreeDocFieldComInfo", docTreeDocFieldComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.docs.docs.DocComInfo docComInfo;
      docComInfo = (weaver.docs.docs.DocComInfo) pageContext.getAttribute("docComInfo");
      if (docComInfo == null) {
        docComInfo = new weaver.docs.docs.DocComInfo();
        pageContext.setAttribute("docComInfo", docComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      	
	out.clearBuffer();
	if(!this.isutf8()){
		request.setCharacterEncoding("GBK");
		response.setContentType("application/json;charset=GBK");
	}else{
		request.setCharacterEncoding("UTF-8");
		response.setContentType("application/json;charset=UTF-8");
	}
	//response.setContentType("application/json;charset=UTF-8");
	FileUpload fu = new FileUpload(request); 
	
	
	String operation = Util.null2String(fu.getParameter("operation"));
	
	Map result = new HashMap();
	
	//\u5fae\u4fe1\u5e73\u53f0\u767b\u5f55e-cology\u7cfb\u7edf
	if(operation.equals("login")){
		String identifier = Util.null2String(fu.getParameter("identifier"));//\u7528\u6237\u6807\u8bc6
		String identifierType = Util.null2String(fu.getParameter("identifierType"));//\u6807\u8bc6\u7c7b\u578b 0\u8868\u793aid 1\u8868\u793aloginid
		String language = Util.null2String(fu.getParameter("language"));//\u8bed\u8a00
		String ipaddress = Util.null2String(fu.getParameter("ipaddress"));//IP\u5730\u5740
		if(ipaddress.equals("")) ipaddress = fu.getRemoteAddr();
		String clienttype = Util.null2String(fu.getParameter("clienttype"));//app\u7c7b\u578b
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(!identifier.equals("") && !ticket.equals("")) {
			
			//\u901a\u8fc7\u8bbf\u95ee\u5fae\u4fe1\u5e73\u53f0\u63a5\u53e3\u9a8c\u8bc1\u7968\u636e\u662f\u5426\u6709\u6548
			boolean wxcheck = InterfaceUtil.wxCheckLogin(ticket);
			if(wxcheck){
				String userid = identifier;
				if(identifierType.equals("1")){//\u4f20\u5165\u7684\u662floginid,\u9700\u8981\u8fdb\u884c\u8f6c\u6362
					userid = InterfaceUtil.transUserId(identifier,0);
				}else{
					rs.executeSql("select t1.id from HrmResource t1 where t1.status in (0,1,2,3) and t1.id="+Util.getIntValue(userid,0));
					if(!rs.next()){
						String demouserid = Util.null2String(Prop.getPropValue("wxinterface", "demouserid"));
						if(!"".equals(demouserid)){
							userid = demouserid;
						}
					}
				}
				
				String loginid = InterfaceUtil.transUserId(userid,1);//\u767b\u5f55\u8d26\u53f7
				
				boolean issubaccount = false;
				String maccount = "";//\u4e3b\u8d26\u53f7
				//\u542f\u7528\u7684\u4e3b\u6b21\u8d26\u53f7
				if(weaver.general.GCONST.getMOREACCOUNTLANDING()){
					rs.executeSql("select t2.id as mainid,t2.loginid as mainloginid,t2.account as mainaccount from HrmResource t1,HrmResource t2"
							+" where t1.belongto=t2.id and t1.status in (0,1,2,3) and t1.status != 10 and t1.accounttype=1"
							+" and t2.status in (0,1,2,3) and t2.status != 10 and (t2.accounttype=0 or t2.accounttype is null) and t1.id="+Util.getIntValue(userid));
					if(rs.next()){
						maccount = Util.null2String(rs.getString("mainid"));
						
						if(InterfaceUtil.getUserkeytype().equals("loginid")){//\u8f6c\u5316\u4e3a\u767b\u5f55\u540d
							maccount = InterfaceUtil.transUserId(Util.null2String(rs.getString("mainloginid")), Util.null2String(rs.getString("mainaccount")));
						}
						issubaccount = true;
					}else{
						maccount = identifier;
					}
				}else{
					maccount = identifier;
				}
						
				if("".equals(loginid) && !issubaccount){//\u65e0\u8d26\u53f7\u4eba\u5458\u4e0d\u5141\u8bb8\u767b\u5f55 \u5e76\u4e14\u662f\u4e3b\u8d26\u53f7
					result.put("message","4");
				}else{
					result = ps.login(userid, language, ipaddress);
					//\u767b\u5f55\u6210\u529f\u8fd4\u56de\u6b64\u8d26\u53f7\u7684\u4e3b\u8d26\u53f7
					if("1".equals(result.get("message"))){
						result.put("maccount",maccount);
						result.put("userId",userid);//outuserid
						result.put("outsysuserid",identifier);//\u4e91\u6865\u9009\u62e9\u7684\u552f\u4e00\u6807\u8bc6
						result.put("outsysloginid",loginid);//OA\u7684\u767b\u5f55\u8d26\u53f7
						result.put("seclevel",ResourceComInfo.getSeclevel(userid));
						//\u83b7\u53d6\u6240\u6709\u4e0a\u7ea7\u90e8\u95e8\u5df2\u7ecf\u4e0a\u7ea7\u5206\u90e8
						String deptid = ResourceComInfo.getDepartmentID(userid);
						String alldeptids = getAllSupDepartment(deptid,null,1,deptid);
						result.put("alldeptids", alldeptids);
						String subid = ResourceComInfo.getSubCompanyID(userid);
						String allsubids = getAllSupSubCompany(subid,null,1,subid);
						result.put("allsubids", allsubids);
						//\u8bb0\u5f55\u767b\u5f55\u65e5\u5fd7
						InterfaceUtil.writeLoginLog(userid,ipaddress,clienttype);
					}
				}
			}else{
				result.put("message","3");//\u9a8c\u8bc1\u7968\u636e\u65e0\u6548
			}
		}	
	}
	else if(operation.equals("updateEbUrl")){
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		String ebUrl = Util.null2String(fu.getParameter("ebUrl"));
		if(!"".equals(ebUrl)){
			InterfaceUtil.setWxsysurl(ebUrl);//\u8bbe\u7f6e\u65b0\u7684\u4e91\u6865\u5730\u5740
			//\u901a\u8fc7\u8bbf\u95ee\u5fae\u4fe1\u5e73\u53f0\u63a5\u53e3\u9a8c\u8bc1\u7968\u636e\u662f\u5426\u6709\u6548
			boolean wxcheck = InterfaceUtil.wxCheckLogin(ticket);
			if(wxcheck){
				Map propmap = new HashMap();
				propmap.put("wxsysurl", ebUrl);
				boolean flag = InterfaceUtil.updateProp(propmap);
				if(flag){
					result.put("status","0");
				}else{
					result.put("status","3");
					result.put("message","\u6267\u884c\u66f4\u65b0\u4e91\u6865\u57fa\u672c\u8bbe\u7f6eSQL\u5931\u8d25");
				}
			}else{
				InterfaceUtil.loadProp();//\u628a\u5185\u90e8\u5730\u5740\u6539\u6210\u4e4b\u524d\u7684
				result.put("status","1");//\u9a8c\u8bc1\u7968\u636e\u65e0\u6548
				result.put("message","ticket\u9a8c\u8bc1\u5931\u8d25!\u4e91\u6865\u5185\u90e8\u5730\u5740["+ebUrl+"]OA\u7cfb\u7edf\u65e0\u6cd5\u8bbf\u95ee\u6216\u8005\u4e0d\u662f\u4e91\u6865\u5185\u90e8\u5730\u5740");//\u9a8c\u8bc1\u7968\u636e\u65e0\u6548
			}
		}else{
			result.put("status","2");//\u9a8c\u8bc1\u7968\u636e\u65e0\u6548
			result.put("message","\u5730\u5740\u4e3a\u7a7a");//\u9a8c\u8bc1\u7968\u636e\u65e0\u6548
		}
	}
	//\u4fee\u6539EC\u7aef\u914d\u7f6e\u6587\u4ef6
	else if(operation.equals("setprop")){
		String sessionkey = Util.null2String(fu.getParameter("sessionkey"));
		boolean wxcheck = ps.verify(sessionkey);
		String msg = "";
		//System.out.println("sessionkey:"+sessionkey+"-----"+wxcheck);
		if(wxcheck){
			User user = HrmUserVarify.checkUser (request , response);
			if(user!=null){
				String wxsysurl = Util.null2String(fu.getParameter("wxsysurl"));//\u5fae\u4fe1\u96c6\u6210\u5e73\u53f0\u8bbf\u95ee\u5730\u5740
				String accesstoken = Util.null2String(fu.getParameter("accesstoken"));//\u8bbf\u95ee\u79d8\u94a5
				String userkeytype = Util.null2String(fu.getParameter("userkeytype"));//\u7528\u6237\u6807\u8bc6\u7c7b\u578b id \u6216\u8005 loginid
				String outsysid = Util.null2String(fu.getParameter("outsysid"));//\u5fae\u4fe1\u96c6\u6210\u5e73\u53f0\u7aef\u5b58\u50a8\u7684\u5916\u90e8\u7cfb\u7edfID\uff08\u672cEC\u7cfb\u7edf\uff09
				String uuid = Util.null2String(fu.getParameter("uuid"));//\u8be5\u7cfb\u7edf\u552f\u4e00\u6807\u8bc6
				
				Map propmap = new HashMap();
				propmap.put("wxsysurl", wxsysurl);
				propmap.put("accesstoken", accesstoken);
				propmap.put("userkeytype", userkeytype);
				propmap.put("outsysid", outsysid);
				propmap.put("uuid", uuid);
				msg = InterfaceUtil.updateProp2(propmap);
				if(msg.equals("")){
					msg = "1";
				}
			}else{
				msg = "\u8bf7\u68c0\u67e5ecology/WEB-INF/web.xml\u4e2d\u662f\u5426\u914d\u7f6e\u4e86MobileFilter\u8fc7\u6ee4\u5668";
			}
		}else{
			msg = "sessionkey\u9a8c\u8bc1\u5931\u8d25,\u8bf7\u68c0\u67e5emobileLoginKey\u8868\u4e2d\u662f\u5426\u6709\u65b0\u751f\u6210\u7684sessionkey";
		}
		result.put("message",msg);
	}
	
	//\u4fee\u6539EC\u7aef\u914d\u7f6e\u6587\u4ef6
	else if(operation.equals("getprop")){
		String sessionkey = Util.null2String(fu.getParameter("sessionkey"));
		boolean wxcheck = ps.verify(sessionkey);
		//System.out.println("sessionkey:"+sessionkey+"-----"+wxcheck);
		if(wxcheck){
			String outsysid = InterfaceUtil.getOutsysid();//\u5fae\u4fe1\u96c6\u6210\u5e73\u53f0\u7aef\u5b58\u50a8\u7684\u5916\u90e8\u7cfb\u7edfID\uff08\u672cEC\u7cfb\u7edf\uff09
			String accesstoken = InterfaceUtil.getToken();//\u8bbf\u95ee\u79d8\u94a5
			
			Map propmap = new HashMap();
			result.put("outsysid", outsysid);
			result.put("accesstoken", accesstoken);
			result.put("message", "1");
			
		}else{
			result.put("message","3");//\u64cd\u4f5c\u5931\u8d25
		}
	}
	
	//\u4fee\u6539EC\u7aef\u5176\u4ed6\u76f8\u5173\u914d\u7f6e
	else if(operation.equals("setotherprop")){
		String sessionkey = Util.null2String(fu.getParameter("sessionkey"));
		boolean wxcheck = ps.verify(sessionkey);
		//System.out.println("sessionkey:"+sessionkey+"-----"+wxcheck);
		if(wxcheck){
			String isShowTerminal = Util.null2String(fu.getParameter("isShowTerminal"));//\u4fee\u6539\u6d41\u7a0b\u7b7e\u5b57\u610f\u89c1\u662f\u5426\u663e\u793a\u201c\u6765\u6e90\u4e8e\u201d
			boolean flag = false;
			try{			
				Class PluginServiceImpl = Class.forName("weaver.mobile.plugin.ecology.service.PluginServiceImpl");
				Method m = PluginServiceImpl.getDeclaredMethod("saveMobileProp",String.class,String.class);
				flag = (Boolean)m.invoke(PluginServiceImpl.newInstance(), "isShowTerminal",isShowTerminal);
				application.removeAttribute("emobile_config_isShowTerminal");
			}
			catch (Exception e){
				flag = false;
				e.printStackTrace();
			}
			if(flag){
				result.put("message","1");//\u64cd\u4f5c\u6210\u529f
			}else{
				result.put("message","2");//\u64cd\u4f5c\u5931\u8d25
			}
		}else{
			result.put("message","3");//\u64cd\u4f5c\u5931\u8d25
		}
	}
	
	//\u4fee\u6539EC\u7aef\u5176\u4ed6\u76f8\u5173\u914d\u7f6e
	else if(operation.equals("getotherprop")){
		String sessionkey = Util.null2String(fu.getParameter("sessionkey"));
		boolean wxcheck = ps.verify(sessionkey);
		//System.out.println("sessionkey:"+sessionkey+"-----"+wxcheck);
		if(wxcheck){
			int isShowTerminal = 1;

			rs.executeSql("select propValue from mobileProperty where name='isShowTerminal'");
			if(rs.next()){
				isShowTerminal = Util.getIntValue(rs.getString(1), 0);
			}
			result.put("isShowTerminal", isShowTerminal);
			result.put("message","1");//\u64cd\u4f5c\u6210\u529f
		}else{
			result.put("message","3");//\u64cd\u4f5c\u5931\u8d25
		}
	}
	
	//\u83b7\u53d6EC\u7cfb\u7edf\u4e2d\u7684\u7ec4\u7ec7\u4eba\u5458\u4fe1\u606f\uff0c\u7528\u4e8e\u4f01\u4e1a\u53f7\u901a\u8baf\u5f55\u540c\u6b65\uff08\u6682\u65f6\u53ea\u7528\u5230 \u4eba\u5458\u3001\u90e8\u95e8\u3001\u5206\u90e8\uff09
	else if(operation.equals("syncdata")){
		User user = HrmUserVarify.checkUser (request , response) ;
		if(user==null) {
			//\u672a\u767b\u5f55\u6216\u767b\u5f55\u8d85\u65f6
			result.put("error", "005");
			
			JSONObject jro = new JSONObject(result);
			out.println(jro);
			return;
		}
		String type = Util.null2String(fu.getParameter("type"));
		if("HrmResource".equalsIgnoreCase(type) || "HrmResourceList".equalsIgnoreCase(type)) {
			String condstr = Util.null2String(fu.getParameter("condstr"));
			boolean isalluser = Util.null2String(fu.getParameter("isalluser")).equals("1");//\u662f\u5426\u5305\u542b\u65e0\u8d26\u53f7\u4eba\u5458
			//System.out.println("condstr:"+condstr);
			List auths = new ArrayList();
			if(!"".equals(condstr)){
				try{
					JSONArray ja = new JSONArray(condstr);

					for(int i=0;ja!=null&&i<ja.length();i++) {
						
						JSONObject jao = ja.getJSONObject(i);
						
						Map map = new HashMap();
						
						String authtype="";
						if(jao.has("authtype")) authtype = jao.getString("authtype");
						
						String authvalue="";
						if(jao.has("authvalue")) authvalue = jao.getString("authvalue");
						
						String authseclevel="";
						if(jao.has("authseclevel")) authseclevel = jao.getString("authseclevel");

						map.put("authtype", authtype);
						map.put("authvalue", authvalue);
						map.put("authseclevel", authseclevel);
						
						auths.add(map);
						
						//System.out.println("authtype:"+authtype+"--authvalue:"+authvalue+"--authseclevel:"+authseclevel);
					}
				}catch(Exception e){
					
				}
			} 
			if("HrmResource".equalsIgnoreCase(type)){
				result = hrs2.getAllUser(user,auths,isalluser);  
			}else{
				int pageIndex = Util.getIntValue(fu.getParameter("pageIndex"), 1);
				int pageSize = Util.getIntValue(fu.getParameter("pageSize"), 20);
				int hrmorder = Util.getIntValue(fu.getParameter("hrmorder"), 0);
				String detailid = Util.null2String(fu.getParameter("detailid"));
				String keywordurl = Util.null2String(fu.getParameter("keyword"));
				String keyword = URLDecoder.decode(keywordurl, "GBK");
				List conditions = new ArrayList();
				if(StringUtils.isNotEmpty(keyword)) {
					conditions.add(" (lastname like '%"+keyword+"%' or pinyinlastname like '%"+keyword+"%' or workcode like '%"+keyword+"%' or mobile like '%"+keyword+"%' or telephone like '%"+keyword+"%') ");
				}
				
				if(StringUtils.isNotEmpty(detailid)) {
					conditions.add(" (id = "+detailid+") ");
				}
				result = hrs2.getUserList(user, auths, isalluser, pageIndex, pageSize, hrmorder, conditions); 
			}
			
		} else if("HrmDepartment".equalsIgnoreCase(type)) { 
			String conddeptids = Util.null2String(fu.getParameter("conddeptids"));
			String condsubids = Util.null2String(fu.getParameter("condsubids"));
			result = hrs2.getAllDepartment(user,conddeptids,condsubids);
		} else if("HrmSubCompany".equalsIgnoreCase(type)) {
			String condsubids = Util.null2String(fu.getParameter("condsubids"));
			result = hrs2.getAllSubCompany(user,condsubids);
		} else if("HrmCompany".equalsIgnoreCase(type)) {
			result = hrs2.getAllCompany(user);
		} else if("HrmGroup".equalsIgnoreCase(type)) {
			result = hrs2.getUserGroups(user);
		} else if("HrmGroupMember".equalsIgnoreCase(type)) {
			result = hrs2.getGroupMember(user);
		} else if("WorkPlanType".equalsIgnoreCase(type)) {
			result = hrs2.getWorkPlanType(user);
		} else if("WorkFlowType".equalsIgnoreCase(type)) {
			result = hrs2.getWorkFlowType(user);
		} else if("getBlackWorkFlow".equalsIgnoreCase(type)) {
			result = hrs2.getBlackWorkFlow(user); 
		} else if("setBlackWorkFlow".equalsIgnoreCase(type)) {
			String workflows = fu.getParameter("workflow");
			result = hrs2.setBlackWorkFlow(user, workflows);
		} else if("getHideModule".equalsIgnoreCase(type)) {
			result = hrs2.getHideModule(user);
		} else if("setHideModule".equalsIgnoreCase(type)) {
			String hidemodule = fu.getParameter("hidemodule");
			result = hrs2.setHideModule(user, hidemodule);
		} else if("getHrmSubCompanyTree".equalsIgnoreCase(type)) {
			result = hrs2.getHrmSubCompanyTree(user);
		} else {
			String[] tablenames = fu.getParameters("tablename");
			String[] timestamps = fu.getParameters("timestamp");
			result = hrs2.getTableStatus(tablenames, timestamps);
		}
		//System.out.println(result+"\n===============\n");
	}
	
	//\u626b\u63cf\u4e8c\u7ef4\u7801\u7ed1\u5b9aEC\u8d26\u53f7 \u9a8c\u8bc1token\u548c\u6709\u6548\u671f
	else if(operation.equals("checkToken")){
		String token=Util.null2String(fu.getParameter("token"));
		int status = 1;
		String userid = "",loginid = "",userdbid="";
		if(!"".equals(token)){
			try{
				String sql = "select * from wx_token where token='"+token+"'";
				rs.execute(sql);
				if(rs.next()){
					SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
					long nowTime = System.currentTimeMillis();
					String createdate = rs.getString("createdate");
					long cTime = sdf.parse(createdate).getTime();
					if(nowTime-cTime<300000){//\u6709\u6548\u671f5\u5206\u949f \u5426\u5219token\u8d85\u65f6
						userid = Util.null2String(rs.getString("userid"));
						loginid = Util.null2String(rs.getString("loginid"));
						userdbid = Util.null2String(rs.getString("userdbid"));
						result.put("companyname",CompanyComInfo.getCompanyname("1"));//\u516c\u53f8\u540d\u79f0
						result.put("deptname",DepartmentComInfo.getDepartmentname(ResourceComInfo.getDepartmentID(userdbid)));//\u90e8\u95e8\u540d\u79f0
						result.put("jobtitle",JobTitlesComInfo.getJobTitlesname(ResourceComInfo.getJobTitle(userdbid)));//\u804c\u4f4d\u540d\u79f0
						result.put("username",ResourceComInfo.getLastname(userdbid));//\u7528\u6237\u59d3\u540d
						result.put("mobile",ResourceComInfo.getMobile(userdbid));//\u624b\u673a\u53f7
						result.put("email",ResourceComInfo.getEmail(userdbid));//\u90ae\u7bb1
						
						status = 0;
					}
				}
			}catch(Exception e){
				e.printStackTrace();
			}
		}
		result.put("userid",userid);
		result.put("loginid",loginid);
		result.put("userdbid",userdbid);
		result.put("status",status);
	}
	
	//\u83b7\u53d6EC\u4e2d\u5df2\u7ecf\u5173\u6ce8\u516c\u4f17\u53f7\u7684\u7c89\u4e1d\u4fe1\u606f
	else if(operation.equals("getFollowerList")){
		String publicid = Util.null2String(fu.getParameter("publicid"));
		String token = Util.null2String(fu.getParameter("token"));
		int status = 1;String msg = "";
		JSONArray ja = new JSONArray();
		try{
			if(!"".equals(publicid)&&!"".equals(token)){
				boolean ifAuth = InterfaceUtil.wxCheckLogin(token);//\u9a8c\u8bc1token
				if(ifAuth){
					rs.execute("select openid,userid from wechat_band where publicid = '"+publicid+"' and openid is not null");
					String userkeytype = Prop.getPropValue("wxinterface","userkeytype");//\u83b7\u53d6\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u7528\u6237\u7c7b\u578b
					boolean ifAccount = false;
					if(!userkeytype.equals("ID")){
						String mode=Prop.getPropValue(GCONST.getConfigFile() , "authentic");
						if(mode!=null&&mode.equals("ldap")){
							ifAccount = true;
						}
					}
					while(rs.next()){
						JSONObject jo = new JSONObject();
						jo.put("openid",rs.getString("openid"));
						String userid = rs.getString("userid");
						String loginid = ResourceComInfo.getLoginID(userid);
						String account = ResourceComInfo.getAccount(userid);
						jo.put("userid",userid);
						if(ifAccount){
							jo.put("loginid",account);
						}else{
							jo.put("loginid",loginid);
						}
						ja.put(jo);
					}
					result.put("followerList", ja);
					result.put("userkeytype",userkeytype);
					status = 0;
				}else{
					msg = "token\u9a8c\u8bc1\u5931\u8d25";
				}
			}else{
				msg = "\u6ca1\u6709\u83b7\u53d6\u5230\u516c\u4f17\u53f7ID";
			}
		}catch(Exception e){
			e.printStackTrace();
			msg = e.getMessage();
		}
		result.put("status", status);
		result.put("msg", msg);
	
	}else if(operation.equals("checkUser")){//\u624b\u52a8\u8f93\u5165\u8d26\u53f7\u5bc6\u7801\u7ed1\u5b9a\u5fae\u4fe1\u548cEcology\u8d26\u53f7
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(InterfaceUtil.wxCheckLogin(ticket)){
			String loginid = Util.null2String(fu.getParameter("loginid"));
			String password = Util.null2String(fu.getParameter("password"));
			String ipaddress = Util.null2String(fu.getParameter("ipaddress"));//IP\u5730\u5740
			String clienttype = Util.null2String(fu.getParameter("clienttype"));//app\u7c7b\u578b
			String language = Util.null2String(fu.getParameter("language"));//\u8bed\u8a00
			int status = 1;String msg = "";
			String outuserid = "";//ec\u7cfb\u7edf\u7684\u7528\u6237id \u552f\u4e00\u6807\u8bc6
			if(!"".equals(loginid)&&!"".equals(password)){
				try{
					int ifFdSSo = Util.getIntValue(Prop.getPropValue("fdcsdev","ifFdSSo"),0);
					if(ifFdSSo==1){//\u662f\u590d\u5730SSO\u9a8c\u8bc1
						try{
							Class hrsClass = Class.forName("weaver.mobile.plugin.ecology.service.HrmResourceService");
							Method m = hrsClass.getMethod("checkFdSSOLogin",String.class,String.class); 		
							loginid = (String)m.invoke(hrsClass.newInstance(),loginid,password);
							if(!"".equals(loginid)){
								outuserid = InterfaceUtil.transUserId(loginid, 0);//\u5c06loginid\u8f6c\u5316\u4e3a\u7528\u6237ID
							}else{
								msg = "\u8d26\u53f7\u5bc6\u7801\u9a8c\u8bc1\u5931\u8d25";
							}
						}catch(Exception e){
							e.printStackTrace();
							msg = "SSO\u6821\u9a8c\u7a0b\u5e8f\u51fa\u73b0\u5f02\u5e38";
						}
					}else{
						Map<String,String> map = InterfaceUtil.userVerify(loginid, password);
						if("1".equals(map.get("result"))){
							loginid = map.get("loginid");
							outuserid = InterfaceUtil.transUserId(loginid, 0);//\u5c06loginid\u8f6c\u5316\u4e3a\u7528\u6237ID
						}else{
							msg = map.get("msg");
						}
					}
					if(!"".equals(outuserid)){
						//\u6267\u884c\u767b\u5f55\u64cd\u4f5c
						int dologin = Util.getIntValue(fu.getParameter("dologin"),0);
						if(dologin==1){
							Map loginres = ps.login(outuserid, language, ipaddress);
							result.put("sessionkey", Util.null2String((String)loginres.get("sessionkey")));
							//\u8bb0\u5f55\u767b\u5f55\u65e5\u5fd7
							InterfaceUtil.writeLoginLog(outuserid,ipaddress,clienttype);
						}
						
						//\u83b7\u53d6\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u7528\u6237\u6807\u8bc6
						String userkeytype = Util.null2String(InterfaceUtil.getUserkeytype());
						if(userkeytype.equalsIgnoreCase("id")){
							loginid = outuserid;//outsysuserid \u5916\u90e8\u7cfb\u7edfuserkey
						}
						//\u83b7\u53d6\u6240\u6709\u4e0a\u7ea7\u90e8\u95e8\u5df2\u7ecf\u4e0a\u7ea7\u5206\u90e8
						String deptid = ResourceComInfo.getDepartmentID(outuserid);
						String alldeptids = getAllSupDepartment(deptid,null,1,deptid);
						if(alldeptids.equals("")){
							alldeptids = ResourceComInfo.getDepartmentID(outuserid);
						}
						result.put("alldeptids", alldeptids);
						String subid = ResourceComInfo.getSubCompanyID(outuserid);
						String allsubids = getAllSupSubCompany(subid,null,1,subid);
						if(allsubids.equals("")){
							allsubids = ResourceComInfo.getSubCompanyID(outuserid);
						}
						result.put("allsubids", allsubids);
						result.put("seclevel",ResourceComInfo.getSeclevel(outuserid));
						result.put("outuserid", outuserid);
						result.put("outsysuserid", loginid);
						status = 0;
					}else if(msg.equals("")){
						msg = "\u5f53\u524d\u8d26\u53f7\u5728OA\u7cfb\u7edf\u4e2d\u4e0d\u5b58\u5728";
					}
				}catch(Exception e){
					msg = "Ecology\u7aef\u9a8c\u8bc1\u8d26\u53f7\u5bc6\u7801\u7a0b\u5e8f\u5f02\u5e38:"+e.getMessage();
				}
			}
			result.put("status", status);
			result.put("msg", msg);
		}else{
			result.put("status", 1);
			result.put("msg", "ticket\u65e0\u6548");
		}
		
	}else if(operation.equals("checkFdUser")){//\u9a8c\u8bc1\u662f\u5426\u662f\u590d\u661f\u7684\u9489\u9489\u8d26\u53f7
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		String ifFdUser = "0";String msg = "";
		if(InterfaceUtil.wxCheckLogin(ticket)){
			String dduserid = Util.null2String(fu.getParameter("dduserid"));//\u4f20\u5165\u7684\u9489\u9489\u7684\u552f\u4e00\u6807\u8bc6
			String ipaddress = Util.null2String(fu.getParameter("ipaddress"));//IP\u5730\u5740
			String clienttype = Util.null2String(fu.getParameter("clienttype"));//app\u7c7b\u578b
			String language = Util.null2String(fu.getParameter("language"));//\u8bed\u8a00
			String apptype = Util.null2String(fu.getParameter("apptype"));//apptype jcyzj
			if(!"".equals(dduserid)){
				try{
					String oaUserDbId = "";
					int ifqsmf = Util.getIntValue(Prop.getPropValue("qsmfcsdev","ifqsmf"),0);
					if(ifqsmf==1){//\u662f\u5168\u65f6\u871c\u8702\u5ba2\u6237 \u4e0a\u6c7d\u5f00\u53d1
						ifFdUser = "1";
						rs.executeSql("select id from HrmResource where email = '"+dduserid+"'");
						if(rs.next()){
							oaUserDbId = rs.getString(1);//OA\u7cfb\u7edf\u6570\u636e\u5e93ID
						}
					}else if(apptype.equals("jcyzj")){
						rs.executeSql("select id from HrmResource where mobile = '"+dduserid+"'");
						if(rs.next()){
							ifFdUser = "1";
							oaUserDbId = rs.getString(1);//OA\u7cfb\u7edf\u6570\u636e\u5e93ID
						}
					}else{
						String field = Util.null2String(Prop.getPropValue("fdcsdev","field"));
						rs.executeSql("select id from cus_fielddata where field"+field+" = '"+dduserid+"'");
						if(rs.next()){
							ifFdUser = "1";
							oaUserDbId = rs.getString(1);//OA\u7cfb\u7edf\u6570\u636e\u5e93ID
						}
					}
					if(!oaUserDbId.equals("")){
						Map loginres = ps.login(oaUserDbId, language, ipaddress);
						result.put("sessionkey", Util.null2String((String)loginres.get("sessionkey")));
						result.put("seclevel",ResourceComInfo.getSeclevel(oaUserDbId));
						result.put("outuserid", oaUserDbId);//OA\u7cfb\u7edf\u6570\u636e\u5e93ID
						String deptid = ResourceComInfo.getDepartmentID(oaUserDbId);
						String alldeptids = getAllSupDepartment(deptid,null,1,deptid);
						result.put("alldeptids", alldeptids);
						String subid = ResourceComInfo.getSubCompanyID(oaUserDbId);
						String loginid = oaUserDbId;//OA\u7cfb\u7edf\u552f\u4e00\u6807\u8bc6(id or loginid)
						String userkeytype = Util.null2String(InterfaceUtil.getUserkeytype());//\u83b7\u53d6\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u7528\u6237\u6807\u8bc6\u7c7b\u578b
						if(!userkeytype.equalsIgnoreCase("id")){
							loginid = ResourceComInfo.getLoginID(oaUserDbId);
						}
						result.put("outsysuserid", loginid);//OA\u7cfb\u7edf\u552f\u4e00\u6807\u8bc6(id or loginid)
						result.put("maccount", loginid);//\u4e3b\u8d26\u53f7
						result.put("outsysloginid", ResourceComInfo.getLoginID(oaUserDbId));//\u767b\u5f55\u8d26\u53f7
						//\u8bb0\u5f55\u767b\u5f55\u65e5\u5fd7
						InterfaceUtil.writeLoginLog(oaUserDbId,ipaddress,clienttype);
					}else{
						msg = "\u6ca1\u6709\u5728OA\u67e5\u8be2\u5230\u5bf9\u5e94\u7684\u8d26\u53f7";
					}
				}catch(Exception e){
					msg = "Ecology\u7aef\u9a8c\u8bc1\u8d26\u53f7\u5bc6\u7801\u7a0b\u5e8f\u5f02\u5e38:"+e.getMessage();
				}
			}else{
				msg = "\u6ca1\u6709\u53d6\u5230\u9489\u9489\u6807\u8bc6";
			}
		}else{
			msg = "ticket\u65e0\u6548";
		}
		result.put("msg", msg);
		result.put("ifFdUser",ifFdUser);
	}else if(operation.equals("getVersion")||operation.equals("")){
		rs.execute("select cversion from license");
		String cVersion = "";
		if(rs.next()){
			cVersion = rs.getString("cversion");
		}
		String wVersion = Prop.getPropValue("wxinterfaceversion","version");
		result.put("cversion", cVersion);
		result.put("wversion", wVersion);
		//\u67e5\u8be2\u662f\u5426\u5b58\u5728wx_basesetting\u8868
		boolean ifTableExist = false;
		if("oracle".equals(rs.getDBType())){
			rs.executeSql("select 1 from user_tables where table_name = 'WX_BASESETTING'");
		}else{
			rs.executeSql("select 1 from sysobjects where id = object_id('wx_basesetting')");
		}
		if(rs.next()){
			ifTableExist = true;
		}
		if(ifTableExist){
			result.put("msg", "wx_basesetting\u8868\u5b58\u5728");
		}else{
			result.put("msg", "wx_basesetting\u8868\u4e0d\u5b58\u5728,\u8bf7\u68c0\u67e5\u811a\u672c\u5347\u7ea7\u662f\u5426\u6709\u95ee\u9898");
		}
	}else if(operation.equals("getSignInfo")){
		try{
			String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
			if(InterfaceUtil.wxCheckLogin(ticket)){
			//if(true){	
				String identifierType = Util.null2String(fu.getParameter("identifierType"));//\u7528\u6237\u6807\u8bc6
				String identifier = Util.null2String(fu.getParameter("identifier"));
				JSONObject signIn = null;
				JSONObject signOut = null;
				int buttonType = 1;//\u5f53\u524d\u5e94\u8be5\u663e\u793a\u7b7e\u5230\u6216\u8005\u7b7e\u9000 1\uff1a\u7b7e\u5230 2\uff1a\u7b7e\u9000 3:\u975e\u5de5\u4f5c\u65e5 4:\u6ca1\u6709\u83b7\u53d6\u5230\u7528\u6237ID
				String comment = "";
				if(!identifier.equals("")&&!identifierType.equals("")){
					if(!identifierType.equalsIgnoreCase("ID")){
						identifier = InterfaceUtil.transUserId(identifier,0);
					}
					int uid = Util.getIntValue(identifier,0);
					if(uid!=0){
						String currentdate = TimeUtil.getCurrentDateString();//\u5f53\u5929\u65e5\u671f
						User user = new User();//\u6784\u9020\u7528\u6237\u5bf9\u8c61
						user.setUid(uid);
						user.setUserSubCompany1(Util.getIntValue(ResourceComInfo.getSubCompanyID(identifier)));
						user.setUserDepartment(Util.getIntValue(ResourceComInfo.getDepartmentID(identifier)));
						user.setLogintype("1");
						//\u6784\u9020\u5224\u65ad\u662f\u5426\u662f\u5de5\u4f5c\u65e5\u548c\u4e0a\u4e0b\u73ed\u65f6\u95f4\u7684\u7c7b
						HrmScheduleDiffUtil HrmScheduleDiffUtil = new HrmScheduleDiffUtil();
						HrmScheduleDiffUtil.setUser(user);
						boolean isWorkday = HrmScheduleDiffUtil.getIsWorkday(currentdate);
						if(!isWorkday&&WxInterfaceInit.isIsutf8()){//\u4eca\u5929\u4e0d\u662f\u5de5\u4f5c\u65e5\u5224\u65ad\u662f\u5426\u5141\u8bb8\u5728\u975e\u5de5\u4f5c\u65e5\u7b7e\u5230
							rs.executeSql("select * from HrmkqSystemSet");
							if(rs.next()){
								int onlyworkday = Util.getIntValue(rs.getString("onlyworkday"),0);//1\u8868\u793a\u53ea\u80fd\u5728\u5de5\u4f5c\u65e5\u7b7e\u5230 
								if(onlyworkday!=1){
									isWorkday = true;
								}
							}
						}
						if(!isWorkday){
							buttonType = 3;
						}else{
							boolean ifOpenSecondSignIn = false;//\u662f\u5426\u5f00\u542f\u4e24\u6b21\u7b7e\u5230
							String secondTime = "",secondDate = "";
							Map onDutyAndOffDutyTimeMap = HrmScheduleDiffUtil.getOnDutyAndOffDutyTimeMap(currentdate, user.getUserSubCompany1());
							if(onDutyAndOffDutyTimeMap.containsKey("signType")){
								String signType2 = Util.null2String((String)onDutyAndOffDutyTimeMap.get("signType"));
								if(signType2.equals("2")){
									ifOpenSecondSignIn = true;
								}
							}
							if(onDutyAndOffDutyTimeMap.containsKey("signStartTime")){
								secondTime = Util.null2String((String)onDutyAndOffDutyTimeMap.get("signStartTime"));
								secondDate = currentdate+" "+secondTime+":00";
							}
							boolean ifSigned = false;//\u5f53\u5929\u662f\u5426\u6709\u7b7e\u5230
							String sql = "SELECT * FROM HrmScheduleSign where userId="+identifier+" and signDate='"+currentdate+"' and isInCom = 1";
							rs.execute(sql);
							SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
							while(rs.next()){
								try{
									String signType = rs.getString("signType");
									String signDate = rs.getString("signDate");
									String signTime = rs.getString("signTime");
									String clientAddress = rs.getString("clientAddress");
									String address = Util.null2String(rs.getString("ADDR"));
									String wxsignaddress = Util.null2String(rs.getString("wxsignaddress"));
									comment = rs.getString("comment");
									if(!wxsignaddress.equals("")){
										address = wxsignaddress;
									}
									JSONObject jo = new JSONObject();
									jo.put("signType", signType);
									jo.put("signDate", signDate);
									jo.put("signTime", signTime);
									jo.put("clientAddress", address.equals("")?clientAddress:address);
									Date thisDate = sdf.parse(signDate+" "+signTime);
									if(signType.equals("1")){//\u7b7e\u5230
										ifSigned = true;
										if(signIn==null){
											signIn = jo;
										}else{
											Date signInDate = sdf.parse(signIn.getString("signDate")+" "+signIn.getString("signTime"));
											if(thisDate.getTime()>signInDate.getTime()){//\u53d6\u5f53\u5929\u6700\u540e\u4e00\u6b21\u7b7e\u5230\u65f6\u95f4\u4f5c\u4e3a\u4e0a\u4e00\u6b21\u7b7e\u5230\u65f6\u95f4
												signIn = jo;
											}
										}
									}else{//\u7b7e\u9000
										if(signOut==null){
											signOut = jo;
										}else{
											Date signOutDate = sdf.parse(signOut.getString("signDate")+" "+signOut.getString("signTime"));
											if(thisDate.getTime()>signOutDate.getTime()){//\u53d6\u5f53\u5929\u6700\u540e\u4e00\u6b21\u7b7e\u9000\u65f6\u95f4\u4f5c\u4e3a\u6700\u540e\u4e00\u6b21\u7b7e\u9000\u65f6\u95f4
												signOut = jo;
											}
										}
									}
								}catch(Exception e){
									e.printStackTrace();
								}
							}
							if(onDutyAndOffDutyTimeMap.containsKey("onDutyTimeAMButton")){//\u662f\u5426\u662f\u5c04\u9633\u519c\u5546\u884c\u5ba2\u6237
							//if(true){	
								String onDutyTimeAM = Util.null2String((String) onDutyAndOffDutyTimeMap.get("onDutyTimeAM"))+":00";
								String offDutyTimeAM = Util.null2String((String) onDutyAndOffDutyTimeMap.get("offDutyTimeAM"))+":00";
								String onDutyTimePM = Util.null2String((String) onDutyAndOffDutyTimeMap.get("onDutyTimePM"))+":00";
								String offDutyTimePM = Util.null2String((String) onDutyAndOffDutyTimeMap.get("offDutyTimePM"))+":00";
								String onDutyTimeAMButton = Util.null2String((String) onDutyAndOffDutyTimeMap.get("onDutyTimeAMButton"))+":00";
								String offDutyTimeAMButton = Util.null2String((String) onDutyAndOffDutyTimeMap.get("offDutyTimeAMButton"))+":00";
								String onDutyTimePMButton = Util.null2String((String) onDutyAndOffDutyTimeMap.get("onDutyTimePMButton"))+":00";
								String offDutyTimePMButton = Util.null2String((String) onDutyAndOffDutyTimeMap.get("offDutyTimePMButton"))+":00";
								String currenttime = TimeUtil.getOnlyCurrentTimeString();//\u5f53\u5929\u65f6\u95f4
								if(currenttime.compareTo(offDutyTimeAM)<0){//\u4e0a\u5348\u4e0b\u73ed\u4e4b\u524d
									if(ifSigned){//\u5df2\u7ecf\u7b7e\u8fc7\u5230\u663e\u793a\u7b7e\u9000
										buttonType = 2;
									}
								}else if(currenttime.compareTo(offDutyTimeAM)>=0&&currenttime.compareTo(onDutyTimePMButton)<0){
									//\u4e0a\u5348\u4e0b\u73ed\u5230\u4e0b\u5348\u5f00\u59cb\u7b7e\u5230\u65f6\u95f4\u5185\u663e\u793a\u7b7e\u9000
									buttonType = 2;
								}else if(currenttime.compareTo(onDutyTimePMButton)>=0&&currenttime.compareTo(offDutyTimePM)<0){
									//\u4e0b\u5348\u7b7e\u5230\u65f6\u95f4\u5230\u4e0b\u5348\u4e0b\u73ed\u65f6\u95f4\u5185 \u5982\u679c\u7b7e\u8fc7\u5230\u5e76\u4e14\u662f\u5728\u4e0a\u9762\u7684\u65f6\u95f4\u5185\u7b7e\u5230\u7684 \u663e\u793a\u7b7e\u9000
									if(ifSigned&&signIn.getString("signTime").compareTo(onDutyTimePMButton)>0
											&&signIn.getString("signTime").compareTo(offDutyTimePM)<0){
										buttonType = 2;
									}
								}else{//\u4e0b\u5348\u4e0b\u73ed\u540e\u90fd\u663e\u793a\u7b7e\u9000
									buttonType = 2;
								}
							}else{
								if(ifOpenSecondSignIn){//\u5f00\u542f\u4e24\u6b21\u7b7e\u5230
									String nowtime = TimeUtil.getCurrentTimeString();//\u5f53\u524d\u65f6\u95f4
									if(TimeUtil.timeInterval(secondDate,nowtime)>0){//\u5f53\u524d\u65f6\u95f4\u5728\u7b2c\u4e8c\u6b21\u7b7e\u5230\u4e4b\u540e
										if(null!=signIn){
											String lastSignInDate = signIn.getString("signDate")+" "+signIn.getString("signTime");
											if(TimeUtil.timeInterval(secondDate,lastSignInDate)>0){//\u6700\u540e\u4e00\u6b21\u7b7e\u5230\u65f6\u95f4\u5728\u7b2c\u4e8c\u6b21\u7b7e\u5230\u65f6\u95f4\u4e4b\u540e
												buttonType = 2;//\u5e94\u8be5\u663e\u793a\u7b7e\u9000
											}
										}
									}else{//\u5f53\u524d\u65f6\u95f4\u5728\u7b2c\u4e8c\u6b21\u7b7e\u5230\u4e4b\u524d
										if(ifSigned){//\u5982\u679c\u4e4b\u524d\u7b7e\u8fc7\u5230\u5219\u5e94\u8be5\u663e\u793a\u7b7e\u9000
											buttonType = 2;
										}
									}
								}else{//\u6ca1\u6709\u5f00\u542f\u4e24\u6b21\u7b7e\u5230
									if(ifSigned){//\u5f53\u5929\u5df2\u7ecf\u7b7e\u8fc7\u5230
										buttonType = 2;
									}
								}
							}
						}
					}else{
						buttonType = 4;
					}
				}else{
					buttonType = 4;
			     }
				//\u51af\u6653\u8f89   \u94c1\u9053\u5b66\u9662\u5ba2\u6237\u5f00\u53d1\uff0c\u65b0\u589e\u7b7e\u5230 \u5907\u6ce8\u5b57\u6bb5
				result.put("comment", comment);
				result.put("buttonType", buttonType);
				result.put("signIn", signIn);
				result.put("signOut", signOut);
			}
		}catch(Exception e){
			e.printStackTrace();
		}
	}else if(operation.equals("getSignList")){
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(InterfaceUtil.wxCheckLogin(ticket)){
			String identifierType = Util.null2String(fu.getParameter("identifierType"));//\u7528\u6237\u6807\u8bc6\u7c7b\u578b
			String identifier = Util.null2String(fu.getParameter("identifier"));//\u7528\u6237\u6807\u8bc6
			String currentdate = Util.null2String(fu.getParameter("currentdate"));//\u9700\u8981\u67e5\u8be2\u7684\u65e5\u671f
			//type 0:\u67e5\u6b64\u65e5\u671f\u524d\u4e00\u4e2a\u661f\u671f\u8bb0\u5f55 1\uff1a\u67e5\u6b64\u65e5\u671f\u672c\u6708\u7684\u8bb0\u5f55 2\uff1a\u67e5\u6b64\u65e5\u671f\u4e0a\u6708\u7684\u8bb0\u5f55
			String type = Util.null2String(fu.getParameter("type"));
			int status = 1;String msg = "";
			if(!identifier.equals("")&&!identifierType.equals("")&&!currentdate.equals("")&&!"".equals(type)){
				if(!identifierType.equalsIgnoreCase("ID")){
					identifier = InterfaceUtil.transUserId(identifier,0);
				}
				int uid = Util.getIntValue(identifier,0);
				if(uid==0){
					msg = "\u7528\u6237\u4e0d\u5b58\u5728";
				}
				SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
				Calendar calendar = Calendar.getInstance();
				try{
					calendar.setTime(sdf.parse(currentdate));
				}catch(Exception e){
					msg = "\u65e5\u671f\u683c\u5f0f\u9519\u8bef";
				}
				String beginDate = "",endDate = "";
				if(msg.equals("")){
					if(type.equals("0")){//\u6700\u8fd17\u5929
						calendar.add(Calendar.DAY_OF_YEAR,-6);
						beginDate = sdf.format(calendar.getTime());
						endDate = currentdate;
					}else if(type.equals("1")){//\u672c\u6708
						calendar.set(GregorianCalendar.DAY_OF_MONTH,1); 
						beginDate = sdf.format(calendar.getTime());
						endDate =  currentdate;
					}else if(type.equals("2")){//\u4e0a\u6708
						calendar.add(Calendar.MONTH,-1);
						calendar.set(GregorianCalendar.DAY_OF_MONTH,1); 
						beginDate = sdf.format(calendar.getTime());
						calendar.roll(Calendar.DATE,-1);
						endDate =  sdf.format(calendar.getTime());
					}else{
						msg = "\u65e0\u6548\u67e5\u8be2\u7c7b\u578b";
					}
				}
				if(msg.equals("")){
					if(!"".equals(beginDate)&&!"".equals(endDate)){
						try{
							User user = new User();//\u6784\u9020\u7528\u6237\u5bf9\u8c61
							user.setUid(uid);
							user.setUserSubCompany1(Util.getIntValue(ResourceComInfo.getSubCompanyID(identifier)));
							user.setUserDepartment(Util.getIntValue(ResourceComInfo.getDepartmentID(identifier)));
							user.setLogintype("1");
							//\u6784\u9020\u5224\u65ad\u662f\u5426\u662f\u5de5\u4f5c\u65e5\u548c\u4e0a\u4e0b\u73ed\u65f6\u95f4\u7684\u7c7b
							HrmScheduleDiffUtil HrmScheduleDiffUtil = new HrmScheduleDiffUtil();
							HrmScheduleDiffUtil.setUser(user);
							
							JSONArray signInArray = new JSONArray();
							JSONArray signOutArray = new JSONArray();
							Map<String,List<JSONObject>> signInMap = new HashMap<String,List<JSONObject>>();
							Map<String,List<JSONObject>> signOutMap = new HashMap<String,List<JSONObject>>();
							String sql = "SELECT a.* FROM HrmScheduleSign a WHERE a.userId = "+identifier+
								" and a.signDate >= '"+beginDate+"' and a.signDate <='"+endDate+"' and a.isInCom = 1 order by a.id";
							rs.executeSql(sql);
							while(rs.next()){//\u5c06\u67e5\u8be2\u65f6\u95f4\u6bb5\u5185\u7684\u6240\u6709\u7b7e\u5230\u548c\u7b7e\u9000\u6570\u636e\u5206\u522b\u88c5\u5165map\u4e2d
								JSONObject json = new JSONObject();
								String signType = Util.null2String(rs.getString("signType"));
								String signDate = Util.null2String(rs.getString("signDate"));
								String signTime = Util.null2String(rs.getString("signTime"));
								String clientAddress = Util.null2String(rs.getString("clientAddress"));
								String address = Util.null2String(rs.getString("ADDR"));
								String wxsignaddress = Util.null2String(rs.getString("wxsignaddress"));
								if(!wxsignaddress.equals("")){
									address = wxsignaddress;
								}
								json.put("signType", signType);
								json.put("signDate", signDate);
								json.put("signTime", signTime);
								json.put("clientAddress", address.equals("")?clientAddress:address);
								List<JSONObject> jos = null;
								if(signType.equals("1")){//\u7b7e\u5230
									if(signInMap.containsKey(signDate)){
										jos = signInMap.get(signDate);
									}
								}else{
									if(signOutMap.containsKey(signDate)){
										jos = signOutMap.get(signDate);
									}
								}
								if(jos==null){
									jos = new ArrayList<JSONObject>();
								}
								jos.add(json);
								if(signType.equals("1")){//\u7b7e\u5230
									signInMap.put(signDate, jos);
								}else{
									signOutMap.put(signDate, jos);
								}
							}
							//\u5224\u65ad\u975e\u5de5\u4f5c\u65e5\u662f\u5426\u53ef\u4ee5\u8003\u52e4
							int onlyworkday = 0;//0\u975e\u5de5\u4f5c\u65e5\u4e5f\u53ef\u4ee5\u7b7e\u5230
							if(WxInterfaceInit.isIsutf8()){//\u4eca\u5929\u4e0d\u662f\u5de5\u4f5c\u65e5\u5224\u65ad\u662f\u5426\u5141\u8bb8\u5728\u975e\u5de5\u4f5c\u65e5\u7b7e\u5230
								rs.executeSql("select onlyworkday from HrmkqSystemSet");
								if(rs.next()){
									onlyworkday = Util.getIntValue(rs.getString("onlyworkday"),0);//1\u8868\u793a\u53ea\u80fd\u5728\u5de5\u4f5c\u65e5\u7b7e\u5230 
								}
							}
							//\u83b7\u53d6\u5f00\u59cb\u65e5\u671f\u548c\u7ed3\u675f\u65e5\u671f\u7684\u65f6\u95f4\u95f4\u9694
							int dateSize = TimeUtil.dateInterval(beginDate,endDate);
							Calendar c = Calendar.getInstance();
							c.setTime(sdf.parse(beginDate));//\u4ece\u5f00\u59cb\u65e5\u671f\u5f00\u59cb\u5faa\u73af
							for(int i=0;i<=dateSize;i++){
								String date = sdf.format(c.getTime());
								
								Map onDutyAndOffDutyTimeMap = HrmScheduleDiffUtil.getOnDutyAndOffDutyTimeMap(date, user.getUserSubCompany1());
								String onDutyTimeAM = Util.null2String((String) onDutyAndOffDutyTimeMap.get("onDutyTimeAM"));
								String offDutyTimeAM = Util.null2String((String) onDutyAndOffDutyTimeMap.get("offDutyTimeAM"));
								String onDutyTimePM = Util.null2String((String) onDutyAndOffDutyTimeMap.get("onDutyTimePM"));
								String offDutyTimePM = Util.null2String((String) onDutyAndOffDutyTimeMap.get("offDutyTimePM"));
								boolean ifOpenSecondSignIn = false;//\u662f\u5426\u5f00\u542f\u4e24\u6b21\u7b7e\u5230
								String secondTime = "";
								if(onDutyAndOffDutyTimeMap.containsKey("signType")){
									String signType2 = Util.null2String((String)onDutyAndOffDutyTimeMap.get("signType"));
									if(signType2.equals("2")){
										ifOpenSecondSignIn = true;
									}
								}
								if(onDutyAndOffDutyTimeMap.containsKey("signStartTime")){
									secondTime = Util.null2String((String)onDutyAndOffDutyTimeMap.get("signStartTime"));
									if(onDutyAndOffDutyTimeMap.containsKey("onDutyTimePMButton")){//\u5c04\u9633\u519c\u5546\u884c\u7684\u4e8c\u6b21\u7b7e\u5230\u65f6\u95f4\u9700\u8981\u63d0\u524d
										secondTime =  Util.null2String((String) onDutyAndOffDutyTimeMap.get("onDutyTimePMButton"));
									}
								}
								
								List<JSONObject> signInList = null;
								List<JSONObject> signOutList = null;
								if(signInMap.containsKey(date)){
									signInList = signInMap.get(date);
								}else{
									signInList = new ArrayList<JSONObject>();
								}
								if(signOutMap.containsKey(date)){
									signOutList = signOutMap.get(date);
								}else{
									signOutList = new ArrayList<JSONObject>();
								}
								JSONObject[] jos = null,jos2 = null;//\u67d0\u5929\u7684\u7b7e\u5230\u6216\u8005\u7b7e\u9000\u6570\u7ec4\uff08\u5f00\u542f\u4e24\u6b21\u7b7e\u5230\u5219\u6570\u7ec4\u957f\u5ea6\u4e3a2\u5426\u5219\u4e3a1\uff09
								if(ifOpenSecondSignIn){
									jos = new JSONObject[2];
									jos2 = new JSONObject[2];
								}else{
									jos = new JSONObject[1];
									jos2 = new JSONObject[1];
								}
								for(int j=0;j<signInList.size();j++){//\u5faa\u73af\u5f53\u5929\u6240\u6709\u7684\u7b7e\u5230\u6570\u636e \u53d6\u51fa\u5176\u4e2d\u7684\u4e00\u5230\u4e24\u6761
									JSONObject jo = signInList.get(j);
									if(null!=jo){
										String signDateTime = jo.getString("signDate")+" "+jo.getString("signTime");
										if(ifOpenSecondSignIn){//\u5f00\u542f\u4e24\u6b21\u7b7e\u5230
											String thisSecondTime = jo.getString("signDate")+" "+secondTime+":00";
											if(TimeUtil.timeInterval(signDateTime,thisSecondTime)>0){//\u7b2c\u4e00\u6b21\u7b7e\u5230
												jo.put("signFlag", 1);
												if(jos[0]==null){
													jos[0] = jo;
												}else{
													String lastSignDateTime = jos[0].getString("signDate")+" "+jos[0].getString("signTime");
													if(TimeUtil.timeInterval(signDateTime,lastSignDateTime)>0){//\u53d6\u6700\u65e9\u7684\u7b7e\u5230\u8bb0\u5f55
														jos[0] = jo;
													}
												}
											}else{
												jo.put("signFlag", 2);
												if(jos[1]==null){
													jos[1] = jo;
												}else{
													String lastSignDateTime = jos[1].getString("signDate")+" "+jos[1].getString("signTime");
													if(TimeUtil.timeInterval(signDateTime,lastSignDateTime)>0){//\u53d6\u6700\u65e9\u7684\u7b7e\u5230\u8bb0\u5f55
														jos[1] = jo;
													}
												}
											}
										}else{
											jo.put("signFlag",1);
											if(jos[0]==null){
												jos[0] = jo;
											}else{
												String lastSignDateTime = jos[0].getString("signDate")+" "+jos[0].getString("signTime");
												if(TimeUtil.timeInterval(signDateTime,lastSignDateTime)>0){
													jos[0] = jo;
												}
											}
										}
									}
								}
								boolean isWorkday = HrmScheduleDiffUtil.getIsWorkday(date);
								for(int j=0;j<jos.length;j++){
									if(jos[j]==null){
										jos[j] = new JSONObject();
										jos[j].put("signType","1");
										jos[j].put("signFlag",j==0?"1":"2");
										jos[j].put("signDate",date);
										jos[j].put("signTime", "");
										jos[j].put("clientAddress", "");
									}
									jos[j].put("ifOpenSecondSignIn", ifOpenSecondSignIn);
									int signStatus = 0;
									if(isWorkday){//\u5de5\u4f5c\u65e5
										String signInTime = jos[j].getString("signTime");
										if(signInTime.equals("")){
											signStatus = 1;//\u672a\u7b7e\u5230
										}else{
											int signFlag = jos[j].getInt("signFlag");//1 \u7b2c\u4e00\u6b21\u7b7e\u5230 2\u7b2c\u4e8c\u6b21\u7b7e\u5230
											String compareTime = "";
											if(signFlag==1){
												compareTime = onDutyTimeAM;
											}else if(signFlag==2){
												compareTime = onDutyTimePM;
											}
											if(!compareTime.equals("")&&signInTime.compareTo(compareTime) > 0){
												signStatus = 2;//\u8fdf\u5230
											}
										}
									}else{
										if(onlyworkday==0){//\u975e\u5de5\u4f5c\u65e5\u5141\u8bb8\u7b7e\u5230
											String signInTime = jos[j].getString("signTime");
											if(signInTime.equals("")){
												signStatus = 1;//\u672a\u7b7e\u5230
											}else{
												signStatus = 0;
											}
										}else{//\u975e\u5de5\u4f5c\u65e5\u5e76\u4e14\u4e0d\u5141\u8bb8\u7b7e\u5230
											signStatus = 3;
										}
									}
									jos[j].put("signStatus", signStatus);
								}
								signInArray.put(jos);
								
								for(int j=0;j<signOutList.size();j++){//\u5faa\u73af\u5f53\u5929\u6240\u6709\u7684\u7b7e\u9000\u6570\u636e \u53d6\u51fa\u5176\u4e2d\u7684\u4e00\u5230\u4e24\u6761
									JSONObject jo = signOutList.get(j);
									if(null!=jo){
										String signDateTime = jo.getString("signDate")+" "+jo.getString("signTime");
										if(ifOpenSecondSignIn){//\u5f00\u542f\u4e24\u6b21\u7b7e\u5230
											String thisSecondTime = jo.getString("signDate")+" "+onDutyTimePM+":00";//\u4e0b\u5348\u4e0a\u73ed\u65f6\u95f4
											if(onDutyAndOffDutyTimeMap.containsKey("offDutyTimeAMButton")){//\u5c04\u9633\u519c\u5546\u884c\u7684\u4e8c\u6b21\u7b7e\u5230\u65f6\u95f4\u9700\u8981\u63d0\u524d
												thisSecondTime =  jo.getString("signDate")+" "+
													Util.null2String((String) onDutyAndOffDutyTimeMap.get("offDutyTimeAMButton"))+":00";
											}
											if(TimeUtil.timeInterval(signDateTime,thisSecondTime)>0){//\u7b2c\u4e00\u6b21\u7b7e\u9000
												jo.put("signFlag", 1);
												if(jos2[0]==null){
													jos2[0] = jo;
												}else{
													String lastSignDateTime = jos2[0].getString("signDate")+" "+jos2[0].getString("signTime");
													if(TimeUtil.timeInterval(lastSignDateTime,signDateTime)>0){//\u53d6\u6700\u540e\u4e00\u6b21\u7b7e\u9000\u8bb0\u5f55
														jos2[0] = jo;
													}
												}
											}else{
												jo.put("signFlag", 2);
												if(jos2[1]==null){
													jos2[1] = jo;
												}else{
													String lastSignDateTime = jos2[1].getString("signDate")+" "+jos2[1].getString("signTime");
													if(TimeUtil.timeInterval(lastSignDateTime,signDateTime)>0){//\u53d6\u6700\u540e\u4e00\u6b21\u7b7e\u9000\u8bb0\u5f55
														jos2[1] = jo;
													}
												}
											}
										}else{
											jo.put("signFlag",1);
											if(jos2[0]==null){
												jos2[0] = jo;
											}else{
												String lastSignDateTime = jos2[0].getString("signDate")+" "+jos2[0].getString("signTime");
												if(TimeUtil.timeInterval(lastSignDateTime,signDateTime)>0){
													jos2[0] = jo;
												}
											}
										}
									
									}
								}
								for(int j=0;j<jos2.length;j++){
									if(jos2[j]==null){
										jos2[j] = new JSONObject();
										jos2[j].put("signType","2");
										jos2[j].put("signFlag",j==0?"1":"2");
										jos2[j].put("signDate",date);
										jos2[j].put("signTime", "");
										jos2[j].put("clientAddress", "");
									}
									jos2[j].put("ifOpenSecondSignIn",ifOpenSecondSignIn);
									int signStatus = 0;
									if(isWorkday){//\u4eca\u5929\u662f\u5de5\u4f5c\u65e5
										String signInTime = jos2[j].getString("signTime");
										if(signInTime.equals("")){
											signStatus = 1;//\u672a\u7b7e\u9000
										}else{
											int signFlag = jos2[j].getInt("signFlag");//1 \u7b2c\u4e00\u6b21\u7b7e\u9000 2\u7b2c\u4e8c\u6b21\u7b7e\u9000
											String compareTime = "";
											if(ifOpenSecondSignIn&&signFlag==1){//\u5f00\u542f\u4e24\u6b21\u7b7e\u5230\u5e76\u4e14\u662f\u7b2c\u4e00\u6b21\u7b7e\u9000
												compareTime = offDutyTimeAM;
											}else{
												compareTime = offDutyTimePM;
											}
											if(!compareTime.equals("")&&signInTime.compareTo(compareTime) < 0){
												signStatus = 2;//\u65e9\u9000
											}
										}
									}else{//\u4eca\u5929\u975e\u5de5\u4f5c\u65e5
										if(onlyworkday==0){//\u975e\u5de5\u4f5c\u65e5\u5141\u8bb8\u7b7e\u5230
											String signInTime = jos2[j].getString("signTime");
											if(signInTime.equals("")){
												signStatus = 1;//\u672a\u7b7e\u9000
											}else{
												signStatus = 0;
											}
										}else{//\u975e\u5de5\u4f5c\u65e5\u5e76\u4e14\u4e0d\u5141\u8bb8\u7b7e\u5230
											signStatus = 3;
										}
									}
									jos2[j].put("signStatus", signStatus);
								}
								signOutArray.put(jos2);
								c.add(Calendar.DAY_OF_YEAR,1);
							}
							result.put("signInArray", signInArray);
							result.put("signOutArray", signOutArray);
							result.put("ifOpenSecondSignIn", false);
							status = 0;
						}catch(Exception e){
							msg = "\u6267\u884c\u6570\u636e\u67e5\u8be2\u5e76\u5c01\u88c5\u7a0b\u5e8f\u51fa\u9519";
						}
					}else{
						msg = "\u6839\u636e\u67e5\u8be2\u7c7b\u578b\u83b7\u53d6\u5f00\u59cb\u65e5\u671f\u548c\u7ed3\u675f\u65e5\u671f\u9519\u8bef";
					}
				}
			}else{
				msg = "\u76f8\u5173\u53c2\u6570\u4e0d\u5b8c\u6574";
			}
			result.put("status", status);
			result.put("msg", msg);
		}else{
			result.put("status", 1);
			result.put("msg", "ticket\u65e0\u6548");
		}
	}else if(operation.equals("getSignTotal")){//\u83b7\u53d6\u8003\u52e4\u8bb0\u5f55\u7edf\u8ba1
		
	}else if(operation.equals("getSignDetail")){//\u83b7\u53d6\u8003\u52e4\u67d0\u79cd\u7c7b\u578b\u7684\u660e\u7ec6
		
	}
	//\u83b7\u53d6\u4e3b\u4ece\u8d26\u53f7\u4fe1\u606f
	else if(operation.equals("getaccounts")){
		
		//\u5224\u65ad\u7f16\u7801
		if(this.isutf8()){
			response.setContentType("application/json;charset=UTF-8");
		}
		
		int status = 0;
		String msg = "";
		
		User user = HrmUserVarify.checkUser (request , response) ;
		if(user==null) {
			status = 0;
			msg = "\u7528\u6237\u767b\u5f55\u5931\u8d25";
		}
		
		if(weaver.general.GCONST.getMOREACCOUNTLANDING()){
			List accounts = VerifyLogin.getAccountsById(user.getUID());
		    if(accounts != null && accounts.size()>1){
		    	JSONArray accountlist = new JSONArray();
		    	JSONObject account = null;
		    	Iterator iter=accounts.iterator();
			    while(iter.hasNext()){
			    	Account a = (Account)iter.next();
			    	account = new JSONObject();
			    	
			    	String subcompanyname = SubCompanyComInfo.getSubCompanyname(""+a.getSubcompanyid());
			        String departmentname = DepartmentComInfo.getDepartmentname(""+a.getDepartmentid());
			        String jobtitlename = JobTitlesComInfo.getJobTitlesname(""+a.getJobtitleid());     
			        
			        account.put("id", a.getId());
			        account.put("loginid", InterfaceUtil.transUserId(a.getId()+"", 1));
			        //account.put("loginid", a.getAccount()); 
			        account.put("showname", subcompanyname+"/"+departmentname+"/"+jobtitlename);
			        
			        //\u5f53\u524d\u8d26\u53f7\u6807\u5fd7
			        if(a.getId()==user.getUID()){
			        	result.put("cuserid", a.getId());
			        }
			        
			        accountlist.put(account);
			    }
			    
			    result.put("accountlist", accountlist);
			    result.put("userkeytype", InterfaceUtil.getUserkeytype());
			    
			    status = 1;
			}else{
				status = 0;
				msg = "\u6ca1\u6709\u8bbe\u7f6e\u591a\u8d26\u53f7\u65e0\u9700\u8fdb\u884c\u5207\u6362";
			}
		}else{
			status = 0;
			msg = "\u672a\u542f\u7528\u591a\u8d26\u53f7\u767b\u5f55";
		}
		result.put("status", 1);
		result.put("msg", "");
	}else if(operation.equals("getMsgRuleList")){
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(InterfaceUtil.wxCheckLogin(ticket)){
			rs.executeSql("select * from WX_MsgRuleSetting order by type,id");
			JSONArray ja = new JSONArray();
			while(rs.next()){
				JSONObject jo = new JSONObject();
				jo.put("id",Util.null2String(rs.getString("id")));
				jo.put("name",Util.null2String(rs.getString("name")));
				jo.put("type",Util.null2String(rs.getString("type")));
				jo.put("ifrepeat",Util.null2String(rs.getString("ifrepeat")));
				jo.put("typeids",Util.null2String(rs.getString("typeids")));
				jo.put("flowsordocs",Util.null2String(rs.getString("flowsordocs")));
				jo.put("names",Util.null2String(rs.getString("names")));
				jo.put("msgtpids",Util.null2String(rs.getString("msgtpids")));
				jo.put("msgtpnames",Util.null2String(rs.getString("msgtpnames")));
				jo.put("freqtime",Util.null2String(rs.getString("freqtime")));
				jo.put("isenable",Util.null2String(rs.getString("isenable")));
				jo.put("iftoall",Util.null2String(rs.getString("iftoall")));
				jo.put("ifcover",Util.null2String(rs.getString("ifcover")));
				jo.put("lastscantime",Util.null2String(rs.getString("lastscantime")));
				jo.put("wfsettype",Util.getIntValue(rs.getString("wfsettype"),0)+"");
				jo.put("flowtype",Util.getIntValue(rs.getString("flowtype"),0)+"");
				jo.put("ifwftodo",Util.getIntValue(rs.getString("ifwftodo"),0)+"");
				jo.put("ifwffinish",Util.getIntValue(rs.getString("ifwffinish"),0)+"");
				jo.put("ifwftimeout",Util.getIntValue(rs.getString("ifwftimeout"),0)+"");
				jo.put("ifwfreject",Util.getIntValue(rs.getString("ifwfreject"),0)+"");
				jo.put("requestlevel",Util.null2String(rs.getString("requestlevel")));
				jo.put("startdate",Util.null2String(rs.getString("startdate")));
				jo.put("startcentext",Util.null2String(rs.getString("startcentext")));
				jo.put("enddate",Util.null2String(rs.getString("enddate")));
				jo.put("endcentext",Util.null2String(rs.getString("endcentext")));
				jo.put("resourcetype",Util.null2String(rs.getString("resourcetype")));
				jo.put("resourceids",Util.null2String(rs.getString("resourceids")));
				jo.put("resourceNames",Util.null2String(rs.getString("resourceNames")));
				jo.put("ifsendsub",Util.getIntValue(rs.getString("ifsendsub"),1)+"");
				ja.put(jo);
			}
			result.put("msgRuleList",ja);
		}
	}else if(operation.equals("getWorkPlanTypeList")){
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(InterfaceUtil.wxCheckLogin(ticket)){
			rs.executeSql("select * from WorkPlantype WHERE available = '1' ORDER BY displayOrder ASC");
			JSONArray ja = new JSONArray();
			while(rs.next()){
				JSONObject jo = new JSONObject();
				jo.put("id",Util.null2String(rs.getString("workPlanTypeID")));
				jo.put("name",Util.null2String(rs.getString("workPlanTypeName")));
				ja.put(jo);
			}
			result.put("workPlanTypeList",ja);
		}
	}else if("saveMsgRule".equals(operation)){
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(InterfaceUtil.wxCheckLogin(ticket)){
			String status = "1";String msg = "";
			String param = Util.null2String(fu.getParameter("param"));
			//System.out.println("param======="+param);
			try{
				if(!param.equals("")){
					JSONObject json = new JSONObject(param);
					String fdid = Util.null2String(json.getString("id"));
					String name = Util.null2String(json.getString("name"));
					int type = Util.getIntValue(json.getString("type"), 1);
					int ifrepeat = Util.getIntValue(json.getString("ifrepeat"), 1);
					int iftoall = Util.getIntValue(json.getString("iftoall"), 2);
					int ifcover = Util.getIntValue(json.getString("ifcover"), 1);
					int freqtime = Util.getIntValue(json.getString("freqtime"), 1);
					String msgtpids = Util.null2String(json.getString("msgtpids"));
					String msgtpnames = Util.null2String(json.getString("msgtpnames"));
					String types = Util.null2String(json.getString("typeids"));
					String flows = Util.null2String(json.getString("flowsordocs"));
					String names = Util.null2String(json.getString("names"));
					
					int isenable = Util.getIntValue(json.getString("isenable"),1);
					int flowtype = Util.getIntValue(json.getString("flowtype"),0);//\u6d41\u7a0b\u5185\u5bb9\u8bbe\u7f6e\u7c7b\u578b 0\u5305\u542b 1\u6392\u9664
					
					int remindtype = Util.getIntValue(json.getString("remindtype"), 1);//\u4f1a\u8bae\u65e5\u7a0b\u63d0\u9192\u65b9\u5f0f
					int timeBefore = Util.getIntValue(json.getString("timeBefore"), 1);//\u4f1a\u8bae\u65e5\u7a0b\u63d0\u524d\u591a\u957f\u65f6\u95f4\u901a\u77e5 \u5355\u4f4d:\u5206\u949f
					String remindTypeForXz = Util.null2String(json.getString("rtfx"));//\u534f\u4f5c\u63d0\u9192\u65b9\u5f0f
					
					int wfsettype = Util.getIntValue(json.getString("wfsettype"),0);//\u6d41\u7a0b\u5f52\u6863\u63d0\u9192\u8bbe\u7f6e \u9ed8\u8ba4\u4e0d\u63d0\u9192\u5f52\u6863(20160721\u4e4b\u540e\u65e0\u6548)
					
					int ifwftodo = Util.getIntValue(json.getString("ifwftodo"),0);//\u662f\u5426\u63a8\u9001\u5f85\u529e\u6d41\u7a0b\uff08\u542b\u6284\u9001\uff09
					int ifwffinish = Util.getIntValue(json.getString("ifwffinish"),0);//\u662f\u5426\u63a8\u9001\u5f52\u6863\u6d41\u7a0b
					int ifwftimeout = Util.getIntValue(json.getString("ifwftimeout"),0);//\u662f\u5426\u63a8\u9001\u8d85\u65f6\u6d41\u7a0b
					int ifwfreject = Util.getIntValue(json.getString("ifwfreject"),0);//\u662f\u5426\u63a8\u9001\u9000\u56de\u6d41\u7a0b
					String requestlevel = Util.null2String(json.getString("requestlevel"));//\u6d41\u7a0b\u7d27\u6025\u7a0b\u5ea6\u7c7b\u578b
					
					
					String startDate = Util.null2String(json.getString("startdate")); //\u5f00\u59cb\u65f6\u95f4
					String startCentext = Util.null2String(json.getString("startcentext")); //\u5f00\u59cb\u5185\u5bb9
					String endDate = Util.null2String(json.getString("enddate")); //\u7ed3\u675f\u65f6\u95f4
					String endCentext = Util.null2String(json.getString("endcentext")); //\u7ed3\u675f\u5185\u5bb9
					String resourceids = Util.null2String(json.getString("resourceids")); //\u90e8\u95e8\u6216\u5206\u90e8id
					String resourceNames = Util.null2String(json.getString("resourceNames"));  //\u90e8\u95e8\u6216\u8005\u5206\u90e8\u540d\u79f0
					String resourcetype = Util.null2String(json.getString("resourcetype"));  //\u9009\u62e9\u4e86\u5206\u90e8\u8fd8\u662f\u90e8\u95e8
					
					int ifsendsub = Util.getIntValue(json.getString("ifsendsub"), 1);//\u6d88\u606f\u63a5\u6536\u4eba\u540c\u65f6\u5305\u542b\u4e3b\u6b21\u8d26\u53f7\u65f6\uff0c\u6b21\u8d26\u53f7\u662f\u5426\u63a8\u9001
					
					MsgRuleSetting mrs = new MsgRuleSetting();
					String [] r = mrs.saveOrUpdateMsgRule(fdid, name, type, ifrepeat, iftoall, freqtime, 
							msgtpids, msgtpnames, types, flows, names, isenable, remindtype, timeBefore,
							remindTypeForXz,true,ifcover,wfsettype,flowtype,ifwftodo,ifwffinish,ifwftimeout,ifwfreject,requestlevel,startDate,startCentext,endDate,endCentext,resourceids,resourceNames,resourcetype,
							ifsendsub);
					status = r[0];
					msg = r[1];
				}else{
					msg = "\u6ca1\u6709\u83b7\u53d6\u5230\u8981\u4fdd\u5b58\u7684\u6570\u636e";
				}
			}catch(Exception e){
				msg = "ECOLOGY\u7aef\u6267\u884c\u4fdd\u5b58\u7a0b\u5e8f\u51fa\u73b0\u5f02\u5e38:"+e.getMessage();
			}
			result.put("status", status);
			result.put("msg", msg);
		}else{
			result.put("status", "1");
			result.put("msg", "ticket\u65e0\u6548");
		}
	}else if(operation.equals("delMsgRule")){
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(InterfaceUtil.wxCheckLogin(ticket)){
			int status = 1;String msg = "Ecolog\u7aef\u6ca1\u6709\u83b7\u53d6\u5230\u8981\u5220\u9664\u7684\u6d88\u606f\u63a8\u9001\u8bbe\u7f6e\u7684ID";
			String ids = Util.null2String(fu.getParameter("ids"));
			if(!ids.equals("")){
				String sql = "delete from WX_MsgRuleSetting where id in (" + ids + ")";
				boolean flag = rs.execute(sql);
				if (flag) {
					WxInterfaceInit.initFlowAndDoc();//\u66f4\u65b0\u7f13\u5b58
					status = 0;msg = "";
				} else {
					msg = "\u6267\u884c\u5220\u9664SQL\u5931\u8d25";
				}
			}
			result.put("status", status);
			result.put("msg", msg);
		}else{
			result.put("status", 1);
			result.put("msg", "ticket\u65e0\u6548");
		}
	}else if(operation.equals("getMsgRuleLog")){
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(InterfaceUtil.wxCheckLogin(ticket)){
			int type = Util.getIntValue(fu.getParameter("type"),0);
			int resultstatus = Util.getIntValue(fu.getParameter("resultstatus"),-1000);
			String receiveusers = Util.null2String(fu.getParameter("receiveusers"));
			String reourceid = Util.null2String(fu.getParameter("reourceid"));
			String content = Util.null2String(fu.getParameter("content"));
			String startDate = Util.null2String(fu.getParameter("startDate"));
			String endDate = Util.null2String(fu.getParameter("endDate"));
			//System.out.println("content========="+content);
			String backfields = " * ";
			String fromSql = " from WX_SCANLOG";
			String sqlWhere = " where 1=1 ";
			if(type!=0){
				if(type==16){
					sqlWhere +=" and type >="+type;
				}else{
					sqlWhere += " and type="+type;
				}
			}
			if(resultstatus!=-1000){
				sqlWhere += " and resultstatus="+resultstatus;
			}
			if(!receiveusers.equals("")){
				sqlWhere +=" and receiveusers like '%"+receiveusers+"%'";
			}
			if(!content.equals("")){
				sqlWhere +=" and content like '%"+content+"%'";
			}
			if(!startDate.equals("")){
				sqlWhere +=" and scantime  >= '"+startDate+"'";
			}
			if(!endDate.equals("")){
				sqlWhere +=" and scantime  <= '"+endDate+"'";
			}
			if(!reourceid.equals("")){
				sqlWhere +=" and reourceid  = '"+reourceid+"'";
			}
			String orderby1 = " order by id desc ";
			String orderby2 = " order by id asc ";
			String orderby3 = " order by id desc ";
			int iTotal = 0; 
			int pagesize = Util.getIntValue(fu.getParameter("pagesize"),20);;
			rs.executeSql("select count(id) "+fromSql+sqlWhere.toString());
			if(rs.next()) iTotal = rs.getInt(1);
			
			int totalpage = iTotal / pagesize;
			if(iTotal % pagesize >0) totalpage += 1;
			int pagenum = Util.getIntValue(fu.getParameter("pagenum"),1);
			if(pagenum>totalpage) pagenum=1;
			int iNextNum = pagenum * pagesize;
			int ipageset = pagesize;
			if(iTotal - iNextNum + pagesize < pagesize) ipageset = iTotal - iNextNum + pagesize;
			if(iTotal < pagesize) ipageset = iTotal;
			
			String sql = "select top " + ipageset +" A.* from (select top "+ iNextNum + backfields + fromSql + sqlWhere + orderby3 + ") A "+orderby2;
			sql = "select top " + ipageset +" B.* from (" + sql + ") B "+orderby1;
			
			if(rs.getDBType().equals("oracle")){
				sql = "select "+backfields+fromSql+sqlWhere+orderby3;
				sql = "select t2.*,rownum rn from (" + sql + ") t2 where rownum <= " + iNextNum;
				sql = "select t3.* from (" + sql + ") t3 where rn > " + (iNextNum - pagesize);
			}
			rs.executeSql(sql);
			//System.out.println("sql==============\n"+sql);
			JSONArray ja = new JSONArray();
			while(rs.next()){
				JSONObject jo = new JSONObject();
				jo.put("id",Util.null2String(rs.getString("id")));
				jo.put("type",Util.null2String(rs.getString("type")));
				jo.put("othertypes",Util.null2String(rs.getString("othertypes")));
				jo.put("reourceid",Util.null2String(rs.getString("reourceid")));
				jo.put("otherid",Util.null2String(rs.getString("otherid")));
				jo.put("scantime",Util.null2String(rs.getString("scantime")));
				jo.put("receiveusers",Util.null2String(rs.getString("receiveusers")));
				jo.put("content",Util.null2String(rs.getString("content")));
				jo.put("resultstatus",Util.null2String(rs.getString("resultstatus")));
				jo.put("resultcontent",Util.null2String(rs.getString("resultcontent")));
				ja.put(jo);
			}
			//System.out.println("\u8fd4\u56de\u7684\u6570\u636e\u4e3a:\n"+ja.toString());
			result.put("total",iTotal);
			result.put("msgRuleLogList",ja);
		}
	}else if(operation.equals("delMsgRuleLog")){
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		int status = 1;String msg = "";
		if(InterfaceUtil.wxCheckLogin(ticket)){
			rs.executeSql("select count(1) from WX_SCANLOG");
			if(rs.next()){
				if(rs.getInt(1)>=10000){
					Calendar calendar = Calendar.getInstance();
					calendar.add(Calendar.MONTH,-1);
					SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
					String lastMonthDate = sdf.format(calendar.getTime());
					rs.executeSql("delete from WX_SCANLOG where scantime <'"+lastMonthDate+"'");
					status = 0;
				}else{
					msg = "\u65e5\u5fd7\u8bb0\u5f55\u4e0d\u8db31\u4e07\u6761";
				}
			}
		}else{
			msg = "\u7968\u636e\u9a8c\u8bc1\u5931\u8d25";
		}
		result.put("status", status);
		result.put("msg", msg);
	}else if(operation.equals("getSetMsgLog")){//\u83b7\u53d6\u4e91\u4e4b\u5bb6\u8bbe\u7f6e\u5df2\u529e\u64cd\u4f5c\u65e5\u5fd7
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(InterfaceUtil.wxCheckLogin(ticket)){
			int msgcode = Util.getIntValue(fu.getParameter("msgcode"),-1000);
			String userstrs = Util.null2String(fu.getParameter("userstrs"));
			String requestid = Util.null2String(fu.getParameter("requestid"));
			String workflowid = Util.null2String(fu.getParameter("workflowid"));
			String startDate = Util.null2String(fu.getParameter("startDate"));
			String endDate = Util.null2String(fu.getParameter("endDate"));
			String backfields = " * ";
			String fromSql = " from WX_SETMSGLOG";
			String sqlWhere = " where 1=1";
			if(msgcode!=-1000){
				sqlWhere += " and msgcode="+msgcode;
			}
			if(!userstrs.equals("")){
				sqlWhere +=" and userstrs like '%"+userstrs+"%'";
			}
			if(!startDate.equals("")){
				sqlWhere +=" and createtime  >= '"+startDate+"'";
			}
			if(!endDate.equals("")){
				sqlWhere +=" and createtime  <= '"+endDate+"'";
			}
			if(!requestid.equals("")){
				sqlWhere +=" and requestid  = '"+requestid+"'";
			}
			if(!workflowid.equals("")){
				sqlWhere +=" and workflowid  = '"+workflowid+"'";
			}
			String orderby1 = " order by id desc ";
			String orderby2 = " order by id asc ";
			String orderby3 = " order by id desc ";
			int iTotal = 0; 
			int pagesize = Util.getIntValue(fu.getParameter("pagesize"),20);;
			rs.executeSql("select count(id) "+fromSql+sqlWhere.toString());
			if(rs.next()) iTotal = rs.getInt(1);
			
			int totalpage = iTotal / pagesize;
			if(iTotal % pagesize >0) totalpage += 1;
			int pagenum = Util.getIntValue(fu.getParameter("pagenum"),1);
			if(pagenum>totalpage) pagenum=1;
			int iNextNum = pagenum * pagesize;
			int ipageset = pagesize;
			if(iTotal - iNextNum + pagesize < pagesize) ipageset = iTotal - iNextNum + pagesize;
			if(iTotal < pagesize) ipageset = iTotal;
			
			String sql = "select top " + ipageset +" A.* from (select top "+ iNextNum + backfields + fromSql + sqlWhere + orderby3 + ") A "+orderby2;
			sql = "select top " + ipageset +" B.* from (" + sql + ") B "+orderby1;
			
			if(rs.getDBType().equals("oracle")){
				sql = "select "+backfields+fromSql+sqlWhere+orderby3;
				sql = "select t2.*,rownum rn from (" + sql + ") t2 where rownum <= " + iNextNum;
				sql = "select t3.* from (" + sql + ") t3 where rn > " + (iNextNum - pagesize);
			}
			rs.executeSql(sql);
			//System.out.println("sql==============\n"+sql);
			JSONArray ja = new JSONArray();
			while(rs.next()){
				JSONObject jo = new JSONObject();
				jo.put("id",Util.null2String(rs.getString("id")));
				jo.put("requestid",Util.null2String(rs.getString("requestid")));
				jo.put("workflowid",Util.null2String(rs.getString("workflowid")));
				jo.put("createtime",Util.null2String(rs.getString("createtime")));
				jo.put("userstrs",Util.null2String(rs.getString("userstrs")));
				jo.put("msgcode",Util.null2String(rs.getString("msgcode")));
				jo.put("errormsg",Util.null2String(rs.getString("errormsg")));
				ja.put(jo);
			}
			//System.out.println("\u8fd4\u56de\u7684\u6570\u636e\u4e3a:\n"+ja.toString());
			result.put("total",iTotal);
			result.put("setMsgLogList",ja);
		}
	}else if(operation.equals("reSetMsg")){//\u83b7\u53d6\u4e91\u4e4b\u5bb6\u8bbe\u7f6e\u5df2\u529e\u64cd\u4f5c\u65e5\u5fd7
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(InterfaceUtil.wxCheckLogin(ticket)){
			String ids = Util.null2String(fu.getParameter("msgids"));
			if(!ids.equals("")){
				int successCount = 0,errorCount = 0;
				String[] idss = ids.split(",");
				for(String id:idss){
					if(!id.equals("")){
						Map<String,String> map = InterfaceUtil.setMsgFlag(Util.getIntValue(id,0));
						if(map!=null){
							if("0".equals(map.get("msgcode"))){
								successCount++;
							}else{
								errorCount++;
							}
						}else{
							errorCount++;
						}
					}
				}
				result.put("msg","\u6210\u529f\u53d1\u9001"+successCount+"\u6761,\u5931\u8d25"+errorCount+"\u6761");
			}else{
				result.put("msg","\u6ca1\u6709\u83b7\u53d6\u5230\u9700\u8981\u64cd\u4f5c\u7684\u6570\u636e");
			}
		}else{
			result.put("msg","ticket\u9a8c\u8bc1\u5931\u8d25");
		}
	}else if(operation.equals("updateMsgRuleAll")){//\u66f4\u65b0\u6240\u6709\u63a8\u9001\u8bbe\u7f6e\u4e3a\u4e0d\u542f\u7528
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		//\u901a\u8fc7\u8bbf\u95ee\u5fae\u4fe1\u5e73\u53f0\u63a5\u53e3\u9a8c\u8bc1\u7968\u636e\u662f\u5426\u6709\u6548
		boolean wxcheck = InterfaceUtil.wxCheckLogin(ticket);
		if(wxcheck){
			String sql = "update WX_MsgRuleSetting set isenable = 0";
			if(rs.executeSql(sql)){
				WxInterfaceInit.initFlowAndDoc();//\u66f4\u65b0\u7f13\u5b58
				result.put("status","0");
			}else{
				result.put("status","1");
			}
		}else{
			result.put("status","2");
		}
	}
	//\u83b7\u53d6\u8054\u7cfb\u4eba
	else if(operation.equals("getContacts")){
		//\u5224\u65ad\u7f16\u7801
		if(this.isutf8()){
			response.setContentType("application/json;charset=UTF-8");
		}
		
		int status = 0;
		String msg = "";
		
		User user = HrmUserVarify.checkUser (request , response) ;
		if(user==null) {
			status = 0;
			msg = "\u7528\u6237\u767b\u5f55\u5931\u8d25";
		} else {
			String module = Util.null2String(fu.getParameter("module"));
			String scope = Util.null2String(fu.getParameter("scope"));
			String detailid = Util.null2String(fu.getParameter("detailid"));
			String pageindex = Util.null2String(fu.getParameter("pageindex"));
			String pagesize = Util.null2String(fu.getParameter("pagesize"));
	
			String keywordurl = Util.null2String(fu.getParameter("keyword"));
			String keyword = URLDecoder.decode(keywordurl, "GBK");
	
			String sessionkey = Util.null2String(fu.getParameter("sessionkey"));
			String setting = Util.null2String(fu.getParameter("setting"));
			String mconfig = Util.null2String(fu.getParameter("config"));
			int hrmorder = Util.getIntValue(fu.getParameter("_hrmorder_"), 0);
	
			//\u56e0\u5ba2\u6237\u7aef\u4f7f\u7528GBK\u7f16\u7801\uff0c\u6545\u9700\u8981\u8f6c\u7801\u3002
			//keyword = new String(keyword.getBytes("iso8859-1"), "GBK");
	
			//if(ps.verify(sessionkey)) {
				List conditions = new ArrayList();
				
				if(StringUtils.isNotEmpty(keyword)) {
					conditions.add(" (lastname like '%"+keyword+"%' or pinyinlastname like '%"+keyword+"%' or workcode like '%"+keyword+"%' or mobile like '%"+keyword+"%' or telephone like '%"+keyword+"%') ");
				}
				
				if(StringUtils.isNotEmpty(detailid)) {
					conditions.add(" (id = "+detailid+") ");
				}
				try{
					Class pvm = Class.forName("weaver.hrm.appdetach.AppDetachComInfo");
					Method m = pvm.getDeclaredMethod("getScopeSqlByHrmResourceSearch",String.class);
					String sql = (String)m.invoke(pvm.newInstance(),user.getUID()+"");
					if(!sql.equals("")){
						conditions.add(" "+sql);
					}
				}catch(Exception e){
					//e.printStackTrace();
				}
				
				result = hrs2.getUserList(conditions, Util.getIntValue(pageindex), Util.getIntValue(pagesize), hrmorder, user);
				
				if(result!=null&&result.get("list")!=null) {
					List<Map<String,Object>> list = (List<Map<String,Object>>) result.get("list");
					
					List<Map<String,Object>> newlist = new ArrayList<Map<String,Object>>();
					for(Map<String,Object> d:list) {
						Map<String,Object> newdata = new HashMap<String,Object>();
						
						String time = "";
						String image = StringUtils.defaultIfEmpty((String) d.get("msgerurl"),"");
						String id = StringUtils.defaultIfEmpty((String) d.get("id"),"");
						String isnew = "";
						String subject = StringUtils.defaultIfEmpty((String) d.get("lastname"),"");
						String description = "" +
											 " [" + StringUtils.defaultIfEmpty((String) d.get("jobtitle"),"") + "]" +
											 " " + StringUtils.defaultIfEmpty((String) d.get("dept"),"") + " / " +
											 "" + StringUtils.defaultIfEmpty((String) d.get("subcom"),"");
						String jobtitle = StringUtils.defaultIfEmpty((String) d.get("jobtitle"),"");
						String dept = StringUtils.defaultIfEmpty((String) d.get("dept"),"");
						String subcom = StringUtils.defaultIfEmpty((String) d.get("subcom"),"");
						String pinyinlastname = StringUtils.defaultIfEmpty((String) d.get("pinyinlastname"),"");
						
						newdata.put("time", time);
						newdata.put("image", image);
						newdata.put("id", id);
						newdata.put("isnew", isnew);
						newdata.put("subject", subject);
						newdata.put("description", description);
						newdata.put("jobtitle", jobtitle);
						newdata.put("dept", dept);
						newdata.put("subcom", subcom);
						newdata.put("pinyinlastname", pinyinlastname);
						newlist.add(newdata);
					}
					result.put("list",newlist);
				}
				status = 1;
			//}
		}
		
		result.put("status", status);
		result.put("msg", msg);
	}
	//\u83b7\u53d6\u53ef\u7528\u6d41\u7a0b
	else if(operation.equals("getAvailableWorkflows")){
		//\u5224\u65ad\u7f16\u7801
		if(this.isutf8()){
			response.setContentType("application/json;charset=UTF-8");
		}
		
		int status = 0;
		String msg = "";
		
		User user = HrmUserVarify.checkUser (request , response) ;
		if(user==null) {
			status = 0;
			msg = "\u7528\u6237\u767b\u5f55\u5931\u8d25";
		} else {
			String keywordurl = Util.null2String(fu.getParameter("keyword"));
			String keyword = URLDecoder.decode(keywordurl, "GBK");
			String setting = Util.null2String(fu.getParameter("setting"));
			
			String[] conditions = new String[2];
			conditions[0] = keyword;
			conditions[1] = weaver.mobile.plugin.ecology.RequestOperation.AVAILABLE_WORKFLOW;
			
			WorkflowBaseInfo[] wbis = wsi.getCreateWorkflowList(0, 99999999, 0, user.getUID(), 0, conditions);
			
			if ("".equals(setting)) {
				result.put("list", net.sf.json.JSONArray.fromObject(wbis).toString());
				//result.put("list", JSON.toJSONString(wbis));
			} else {
				String allwfids = setting;
				try{			
					Class WorkflowVersion = Class.forName("weaver.workflow.workflow.WorkflowVersion");
					Method m = WorkflowVersion.getMethod("getAllVersionStringByWFIDs", String.class); 
					allwfids = (String)m.invoke(WorkflowVersion, allwfids);
				}
				catch (Exception e){
					//e.printStackTrace();
					allwfids = setting;
				}
				List<WorkflowBaseInfo> wbiList = new ArrayList<WorkflowBaseInfo>();
				String settings = "," + allwfids + ",";
				for (int i = 0; i < wbis.length; i++) {
					if (settings.indexOf("," + wbis[i].getWorkflowId() + ",") != -1)
						wbiList.add(wbis[i]);
				}
				result.put("list", net.sf.json.JSONArray.fromObject(wbiList).toString());
				//result.put("list", JSON.toJSONString(wbiList));
			}
			status = 1;
		}
		
		result.put("status", status);
		result.put("msg", msg);
	}
	//\u83b7\u53d6\u5730\u7406\u4f4d\u7f6e\u8bbe\u7f6e
	else if(operation.equals("getLocationSetList")){
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(InterfaceUtil.wxCheckLogin(ticket)){
			rs.executeSql("select * from WX_LocationSetting order by id desc");
			Map<String,String> map = new HashMap<String,String>();
			while(rs.next()){
				map.put(Util.null2String(rs.getString("id")), Util.null2String(rs.getString("name")));
			}
			rs.executeSql("select * from wx_locations order by id desc");
			JSONArray ja = new JSONArray();
			while(rs.next()){
				JSONObject jo = new JSONObject();
				jo.put("id",Util.null2String(rs.getString("id")));
				jo.put("resourcetype",Util.null2String(rs.getString("resourcetype")));
				jo.put("resourceids",Util.null2String(rs.getString("resourceids")));
				jo.put("resourceNames",Util.null2String(rs.getString("resourceNames")));
				String addressids = Util.null2String(rs.getString("addressids"));
				jo.put("addressids",addressids);
				if(!addressids.equals("-1")){
					String addids[] = addressids.split(",");
					String addressNames = "";
					for(String aid:addids){
						if(!aid.equals("")&&map.containsKey(aid)){
							addressNames +=",<a href='javascript:;' class='editAddress' addid='"+aid+"'>"+map.get(aid)+"</a>";
						}
					}
					if(!addressNames.equals("")){
						addressNames = addressNames.substring(1);
					}
					jo.put("addressNames",addressNames);
				}else{
					jo.put("addressNames","\u4efb\u610f\u4f4d\u7f6e");
				}
				jo.put("createtime",Util.null2String(rs.getString("createtime")));
				jo.put("isenable",Util.null2String(rs.getString("isenable")));
				ja.put(jo);
			}
			result.put("locationList",ja);
		}
	}
	//\u83b7\u53d6\u5730\u7406\u4f4d\u7f6e\u89c4\u5219
	else if(operation.equals("getAddressRuleList")){
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(InterfaceUtil.wxCheckLogin(ticket)){
			rs.executeSql("select * from WX_LocationSetting order by id desc");
			JSONArray ja = new JSONArray();
			while(rs.next()){
				JSONObject jo = new JSONObject();
				jo.put("id",Util.null2String(rs.getString("id")));
				jo.put("name",Util.null2String(rs.getString("name")));
				jo.put("lat",Util.null2String(rs.getString("lat")));
				jo.put("lng",Util.null2String(rs.getString("lng")));
				jo.put("address",Util.null2String(rs.getString("address")));
				jo.put("distance",Util.null2String(rs.getString("distance")));
				jo.put("createtime",Util.null2String(rs.getString("createtime")));
				ja.put(jo);
			}
			result.put("addressRuleList",ja);
		}
	}
	else if("saveOrUpdateLocation".equals(operation)){
		String status = "1";String msg = "";
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(InterfaceUtil.wxCheckLogin(ticket)){
			String param = Util.null2String(fu.getParameter("param"));
			try{
				if(!param.equals("")){
					JSONObject json = new JSONObject(param);
					String id = Util.null2String(json.getString("id"));
					String resourcetype = Util.null2String(json.getString("resourcetype"));
					String resourceids = Util.null2String(json.getString("resourceids"));
					String resourceNames = Util.null2String(json.getString("resourceNames"));
					String addressids = Util.null2String(json.getString("addressids"));
					String addressNames = Util.null2String(json.getString("addressNames"));
					int isenable = Util.getIntValue(json.getString("isenable"),1);
					StringBuffer sql = new StringBuffer();
					String nowtime = TimeUtil.getCurrentTimeString();//\u5f53\u5929\u65e5\u671f\u548c\u65f6\u95f4
					if(id.equals("")){
						sql.append("insert into wx_locations (resourcetype,resourceids,resourceNames,addressids");
						sql.append(",addressNames,isenable,createtime)");
						sql.append(" values ('"+resourcetype+"','"+resourceids+"','"+resourceNames+"','"+addressids);
						sql.append("','',"+isenable+",'"+nowtime+"')");
					}else{
						sql.append("update wx_locations set ");
						sql.append("resourcetype='"+resourcetype+"',resourceids='"+resourceids+"'");
						sql.append(",resourceNames='"+resourceNames+"',addressids='"+addressids+"'");
						sql.append(",addressNames='',isenable="+isenable+" where id = "+id);
					}
					rs.execute(sql.toString());
					status = "0";
				}else{
					msg = "\u6ca1\u6709\u83b7\u53d6\u5230\u8981\u4fdd\u5b58\u7684\u6570\u636e";
				}
			}catch(Exception e){
				msg = "ECOLOGY\u7aef\u6267\u884c\u4fdd\u5b58\u7a0b\u5e8f\u51fa\u73b0\u5f02\u5e38:"+e.getMessage();
			}
			
		}else{
			msg = "ticket\u65e0\u6548";
		}
		result.put("status", status);
		result.put("msg", msg);
	}else if(operation.equals("delLocation")){
		int status = 1;String msg = "Ecolog\u7aef\u6ca1\u6709\u83b7\u53d6\u5230\u8981\u5220\u9664\u7684\u8003\u52e4\u89c4\u5219\u8bbe\u7f6e\u7684ID";
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(InterfaceUtil.wxCheckLogin(ticket)){
			
			String ids = Util.null2String(fu.getParameter("ids"));
			if (!"".equals(ids)) {
				String sql = "delete from wx_locations where id in (" + ids + ")";
				boolean flag = rs.execute(sql);
				if (flag) {
					status = 0;
				} else {
					msg = "\u6267\u884c\u5220\u9664SQL\u5931\u8d25";
				}
			}
		}else{
			msg = "ticket\u65e0\u6548";
		}
		result.put("status", status);
		result.put("msg", msg);
	}
	else if("saveOrUpdateAddress".equals(operation)){
		String status = "1";String msg = "";
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(InterfaceUtil.wxCheckLogin(ticket)){
			String param = Util.null2String(fu.getParameter("param"));
			try{
				if(!param.equals("")){
					JSONObject json = new JSONObject(param);
					String id = Util.null2String(json.getString("id"));
					String name = Util.null2String(json.getString("name"));
					String address = Util.null2String(json.getString("address"));
					String lat = Util.null2String(json.getString("lat"));
					String lng = Util.null2String(json.getString("lng"));
					String distance = Util.null2String(json.getString("distance"));
					StringBuffer sql = new StringBuffer();
					String nowtime = TimeUtil.getCurrentTimeString();//\u5f53\u5929\u65e5\u671f\u548c\u65f6\u95f4
					if(id.equals("")){
						sql.append("insert into WX_LocationSetting (name,address,distance,lat,lng,createtime)");
						sql.append(" values ('"+name+"','"+address+"',"+distance);
						sql.append(",'"+lat+"','"+lng+"','"+nowtime+"')");
					}else{
						sql.append("update WX_LocationSetting set ");
						sql.append("name='"+name+"',address='"+address+"',distance="+distance);
						sql.append(",lat='"+lat+"',lng='"+lng+"' where id = "+id);
					}
					rs.executeSql(sql.toString());
					String newId = "";
					if(id.equals("")){
						rs.executeSql("select max(id) from WX_LocationSetting");
						if(rs.next()){
							newId = rs.getString(1);
						}
					}
					result.put("newId", newId);
					status = "0";
				}else{
					msg = "\u6ca1\u6709\u83b7\u53d6\u5230\u8981\u4fdd\u5b58\u7684\u6570\u636e";
				}
			}catch(Exception e){
				msg = "ECOLOGY\u7aef\u6267\u884c\u4fdd\u5b58\u7a0b\u5e8f\u51fa\u73b0\u5f02\u5e38:"+e.getMessage();
			}
		}else{
			msg = "ticket\u65e0\u6548";
		}
		result.put("status", status);
		result.put("msg", msg);
	}else if(operation.equals("delAddress")){
		int status = 1;String msg = "Ecolog\u7aef\u6ca1\u6709\u83b7\u53d6\u5230\u8981\u5220\u9664\u7684\u8003\u52e4\u4f4d\u7f6e\u8bbe\u7f6e\u7684ID";
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(InterfaceUtil.wxCheckLogin(ticket)){
			String ids = Util.null2String(fu.getParameter("ids"));
			if (!"".equals(ids)) {
				String sql = "delete from WX_LocationSetting where id in (" + ids + ")";
				boolean flag = rs.execute(sql);
				if (flag) {
					status = 0;
				} else {
					msg = "\u6267\u884c\u5220\u9664SQL\u5931\u8d25";
				}
			}
		}else{
			msg = "ticket\u65e0\u6548";
		}
		result.put("status", status);
		result.put("msg", msg);
		
	}else if(operation.equals("getAddressById")){
		int status = 1;String msg = "Ecolog\u7aef\u6ca1\u6709\u83b7\u53d6\u5230\u8981\u7f16\u8f91\u7684\u8003\u52e4\u4f4d\u7f6e\u8bbe\u7f6e\u7684ID";
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(InterfaceUtil.wxCheckLogin(ticket)){
			String id = Util.null2String(fu.getParameter("id"));
			if(!id.equals("")){
				rs.executeSql("select * from WX_LocationSetting where id = "+id);
				if(rs.next()){
					JSONObject jo = new JSONObject();
					jo.put("id",Util.null2String(rs.getString("id")));
					jo.put("name",Util.null2String(rs.getString("name")));
					jo.put("lat",Util.null2String(rs.getString("lat")));
					jo.put("lng",Util.null2String(rs.getString("lng")));
					jo.put("address",Util.null2String(rs.getString("address")));
					jo.put("distance",Util.null2String(rs.getString("distance")));
					jo.put("createtime",Util.null2String(rs.getString("createtime")));
					result.put("jo", jo);
					status = 0;
				}
			}
		}else{
			msg = "ticket\u65e0\u6548";
		}
		result.put("status", status);
		result.put("msg", msg);
	}else if(operation.equals("systemcheck")){//\u7cfb\u7edf\u68c0\u6d4b
		
		String token = Util.null2String(fu.getParameter("token"));
		String ticket = Util.null2String(fu.getParameter("ticket"));
		
		/* 
		1\u3001\u662f\u5426\u914d\u7f6e\u7684mobile\u8fc7\u6ee4\u5668
		2\u3001\u662f\u5426\u914d\u7f6e\u4e86wxinterface
		3\u3001\u662f\u5426\u8bbe\u7f6e\u4e86\u6d41\u7a0b\u7c7b\u7684\u6d88\u606f\u63d0\u9192
		4\u3001\u662f\u5426\u8bbe\u7f6e\u4e86\u6587\u6863\u7c7b\u7684\u6d88\u606f\u63d0\u9192
		5\u3001\u662f\u5426\u8bbe\u7f6e\u4e86xxx\u7c7b\u7684\u6d88\u606f\u63d0\u9192
		\u3002\u3002\u3002\u3002
		6\u3001\u5fae\u4fe1\u63a5\u53e3\u7248\u672c\u53f7
		7\u3001OA\u7248\u672c\u53f7 
		*/
		//\u662f\u5426\u914d\u7f6emobile\u8fc7\u6ee4\u5668
		int ismobilefilter = 0;
		//\u662f\u5426\u914d\u7f6emobile\u8def\u5f84
		int ismobile = 0;
		//\u662f\u5426\u914d\u7f6e\u4e86wxinterfaceinit
		int iswxinit = 0;
		//\u662f\u5426\u914d\u7f6e\u4e86\u79fb\u52a8\u5efa\u6a21
		int ismobilemode = 0;
		BufferedReader br = null; 
		try{
			br = new BufferedReader(new FileReader(GCONST.getRootPath()+"WEB-INF"+File.separatorChar+"web.xml"));
			String line = null;
			while ((line = br.readLine()) != null) {  
				if(line.indexOf("weaver.mobile.plugin.ecology.MobileFilter")>-1){
					ismobilefilter = 1;
				}else if(line.indexOf("weaver.wxinterface.WxInterfaceInit")>-1){
					iswxinit = 1;
				}else if(line.indexOf("<url-pattern>/mobilemode")>-1){
					ismobilemode = 1;
				}else if(line.indexOf("<url-pattern>/mobile/")>-1){
					ismobile = 1;
				}
			}
		}catch(Exception e){
			
	 	} finally {  
	        // \u5173\u95ed\u6d41  
	        if (br != null) {  
	        	try {  
	        		br.close();  
	            } catch (IOException e) {  
	            	br = null;  
	            }  
	        } 
	  }  
	  ismobile = (ismobilefilter==1 && ismobile==1)?1:0;
	  ismobilemode = (ismobilefilter==1 && ismobilemode==1)?1:0;
		result.put("ismobile", ismobile);
		result.put("iswxinit", iswxinit);
		result.put("ismobilemode", ismobilemode);
		
		//\u67e5\u8be2\u63a8\u9001\u914d\u7f6e
		rs.executeSql("select * from WX_MsgRuleSetting where isenable=1 order by type,id");
		JSONArray ja = new JSONArray();
		while(rs.next()){
			JSONObject jo = new JSONObject();
			jo.put("id",Util.null2String(rs.getString("id")));
			jo.put("name",Util.null2String(rs.getString("name")));
			jo.put("type",Util.null2String(rs.getString("type")));
			jo.put("ifrepeat",Util.null2String(rs.getString("ifrepeat")));
			jo.put("typeids",Util.null2String(rs.getString("typeids")));
			jo.put("flowsordocs",Util.null2String(rs.getString("flowsordocs")));
			//jo.put("names",Util.null2String(rs.getString("names")));
			jo.put("msgtpids",Util.null2String(rs.getString("msgtpids")));
			//jo.put("msgtpnames",Util.null2String(rs.getString("msgtpnames")));
			jo.put("freqtime",Util.null2String(rs.getString("freqtime")));
			jo.put("iftoall",Util.null2String(rs.getString("iftoall")));
			jo.put("ifcover",Util.null2String(rs.getString("ifcover")));
			jo.put("lastscantime",Util.null2String(rs.getString("lastscantime")));
			ja.put(jo);
		}
		result.put("msgRuleList",ja);
		
		//\u8bfb\u53d6\u63a5\u53e3\u4fe1\u606f
		result.put("wxsysurl", InterfaceUtil.getWxsysurl());
		result.put("outsysid", InterfaceUtil.getOutsysid());
		result.put("istoken", token.equals(InterfaceUtil.getToken())?1:0);
		
		//\u8bfb\u53d6\u7248\u672c\u53f7
		rs.execute("select cversion from license");
		String cVersion = "";
		if(rs.next()){
			cVersion = Util.null2String(rs.getString("cversion"));
		}
		String wVersion = Util.null2String(Prop.getPropValue("wxinterfaceversion","version"));
		result.put("cversion", cVersion);
		result.put("wversion", wVersion);
		
		//\u5224\u65adPoppupRemindInfoUtil\u6587\u4ef6\u662f\u5426\u4fee\u6539
		int ispop = 0;
		File popfile = new File(GCONST.getRootPath()+"classbean"+File.separatorChar+"weaver"+File.separatorChar+"workflow"+File.separatorChar+"msg"+File.separatorChar+"PoppupRemindInfoUtil.class");
		if(!popfile.exists()){
			popfile = new File(GCONST.getRootPath()+"WEB-INF"+File.separatorChar+"classes"+File.separatorChar+"weaver"+File.separatorChar+"workflow"+File.separatorChar+"msg"+File.separatorChar+"PoppupRemindInfoUtil.class");
		}
		if(popfile.exists()){
			long modifytime = popfile.lastModified();
			Date d = new Date(modifytime);
			Format simpleFormat = new SimpleDateFormat("yyyy'-'MM'-'dd");
			String modifydate = simpleFormat.format(d);
			if(TimeUtil.dateInterval("2015-03-17", modifydate)>=0) ispop = 1;
			//80\u7248\u672c\u7279\u6b8a\u5904\u7406\u4e00\u4e0b
			if(ispop==0){
				if(cVersion.startsWith("8")){
					if(TimeUtil.dateInterval("2014-12-22", modifydate)>=0) ispop = 1;
				}
			}
		}
		result.put("ispop", ispop);
		
		//\u68c0\u6d4b\u662f\u5426\u53ef\u8bbf\u95ee\u96c6\u6210\u5e73\u53f0
		int isaccesswx = 0;
		if(!ticket.equals("")) {
			//\u901a\u8fc7\u8bbf\u95ee\u5fae\u4fe1\u5e73\u53f0\u63a5\u53e3\u9a8c\u8bc1\u7968\u636e\u662f\u5426\u6709\u6548
			boolean wxcheck = InterfaceUtil.wxCheckLogin(ticket);
			if(wxcheck) isaccesswx = 1;
		}
		result.put("isaccesswx", isaccesswx);
		
		//ecology\u662f\u5426\u96c6\u7fa4
		result.put("iscluster", WxInterfaceInit.isCluster()?1:0);
	}else if(operation.equals("getDataList")){//\u83b7\u53d6\u6d41\u7a0b\u6587\u6863\u7b49\u6570\u636e\uff0c\u91c7\u7528\u8c03\u6574\u6a21\u5f0f\u89e3\u51b360\u7248\u672c\u4e0b\u4e2d\u6587\u4e71\u7801\u95ee\u9898
		request.getRequestDispatcher("/mobile/plugin/ComponentList.jsp?"+request.getQueryString()).forward(request, response);
		return;
	}
	//\u83b7\u53d6\u4e0b\u5c5e\u4eba\u5458
	else if(operation.equals("getSubUsers")){
		//\u5224\u65ad\u7f16\u7801
		if(this.isutf8()){
			response.setContentType("application/json;charset=UTF-8");
		}
		String userid = Util.null2String(fu.getParameter("userid"));
		int status = 1;
		String msg = "";
		JSONArray ja = new JSONArray();
		User user = HrmUserVarify.checkUser (request , response) ;
		if(user==null) {
			msg = "\u7528\u6237\u767b\u5f55\u5931\u8d25";
		}else{
			//\u9ed8\u8ba4\u53d6\u5f53\u524d\u7528\u6237
			if("".equals(userid)) userid = user.getUID()+"";
			try{
				rs.executeSql("select id,lastname from HrmResource where managerid="+userid+" and (status = 0 or status = 1 or status = 2 or status = 3) and status != 10"
						+" and (accounttype is null or accounttype=0) "
						+" and " + ((!"oracle".equals(rs.getDBType()))?" loginid<>'' and ":"")+" loginid is not null order by dsporder,id");
				JSONObject jo = null;
				while(rs.next()){
					jo = new JSONObject();
					jo.put("userid",Util.null2String(rs.getString("id")));
					jo.put("username",Util.null2String(rs.getString("lastname")));
					ja.put(jo);
				}
				result.put("userList", ja);
				status = 0;
			}catch(Exception e){
				e.printStackTrace();
				msg = e.getMessage();
			}
		}
		result.put("status", status);
		result.put("msg", msg);
	}else if(operation.equals("sendMsg")){
		int status = 1;String msg = "";JSONObject jo = new JSONObject();
		try{
			String ticket = Util.null2String(fu.getParameter("ticket"));
			String mobiles = Util.null2String(fu.getParameter("mobiles"));
			String content = Util.null2String(fu.getParameter("content"));
			if(!ticket.equals("")&&!"".equals(mobiles)&&!"".equals(content)){
				boolean wxcheck = InterfaceUtil.wxCheckLogin(ticket);
				//wxcheck = true;
				if(wxcheck){
					String[] mobiless = mobiles.split(",");
					for(String mobile:mobiless){
						if(!mobile.equals("")){
							jo.put(mobile, sms.sendSMS(mobile, content));
						}
					}
					status = 0;
				}else{
					msg = "token\u9a8c\u8bc1\u5931\u8d25";
				}
			}else{
				msg = "\u76f8\u5173\u53c2\u6570\u4e0d\u5b8c\u6574";
			}
		}catch(Exception e){
			e.printStackTrace();
		}
		result.put("status", status);
		result.put("msg", msg);
		result.put("result", jo);
	}
	//\u83b7\u53d6\u7ec4\u7ec7\u67b6\u6784
	else if(operation.equals("loadOrganization")){
		User user = HrmUserVarify.checkUser (request , response) ;
		if(user==null){
			return;	
		}
		if(this.isutf8()){
			response.setContentType("application/json;charset=UTF-8");
		}
		
		List<Map<String, String>> cData = new ArrayList<Map<String, String>>();
		List<Map<String, String>> sData = new ArrayList<Map<String, String>>();
		List<Map<String, String>> dData = new ArrayList<Map<String, String>>();
		List<Map<String, String>> rData = new ArrayList<Map<String, String>>();
		int o = Util.getIntValue(Util.null2String(fu.getParameter("o")));
		int ot = Util.getIntValue(Util.null2String(fu.getParameter("ot")));

		String name = "";
		String type = "";
		String id = "";
		String mobile = "";
		String tel = "";
		String mail = "";

		if(ot==0&&o==0) {
			cci.setTofirstRow();
			cci.next();

			Map<String, String> data = new HashMap<String, String>();
			data.put("type", "0");
			data.put("name", cci.getCompanyname());
			data.put("id", cci.getCompanyid());
			cData.add(data);
		} else if(ot==0&&o>0) {
			sci.setTofirstRow();
			
			Map<String, String> data = null;
			while(sci.next()) {
				if(Util.getIntValue(sci.getCompanyid())!=o || Util.getIntValue(sci.getSupsubcomid(), 0)!=0 || Util.getIntValue(sci.getCompanyiscanceled())==1) continue;
				
				data = new HashMap<String, String>();
				data.put("type", "1");
				data.put("name", sci.getSubCompanyname());
				data.put("id", sci.getSubCompanyid());
				sData.add(data);
			}
		} else if(ot==1&&o>0) {
			
			Map<String, String> data = null;
			getUserList(user,ot,o,rData);
			
			dci.setTofirstRow();
			while(dci.next()) {
				int departmentsupdepid = Util.getIntValue(dci.getDepartmentsupdepid(), 0);
				if(departmentsupdepid > 0) {
					int supdepididx = dci.getIdIndexKey(""+departmentsupdepid);
					if(supdepididx == -1) departmentsupdepid = 0;
				}
				
				if(Util.getIntValue(dci.getSubcompanyid1())!=o || departmentsupdepid!=0 || Util.getIntValue(dci.getDeparmentcanceled())==1) continue;
				
				data = new HashMap<String, String>();
				data.put("type", "2");
				data.put("name", dci.getDepartmentname());
				data.put("id", dci.getDepartmentid());
				dData.add(data);
			}
			
			sci.setTofirstRow();
			while(sci.next()) {
				
				if(Util.getIntValue(sci.getSupsubcomid())!=o || Util.getIntValue(sci.getSupsubcomid(), 0)==0 || Util.getIntValue(sci.getCompanyiscanceled())==1) continue;
				
				data = new HashMap<String, String>();
				data.put("type", "1");
				data.put("name", sci.getSubCompanyname());
				data.put("id", sci.getSubCompanyid());
				sData.add(data);
			}
		} else if(ot==2&&o>0) {
			
			Map<String, String> data = null;
			getUserList(user,ot,o,rData);
			
			dci.setTofirstRow();
			while(dci.next()) {
				if(Util.getIntValue(dci.getDepartmentsupdepid())!=o || Util.getIntValue(dci.getDepartmentsupdepid(), 0)==0 || Util.getIntValue(dci.getDeparmentcanceled())==1) continue;

				data = new HashMap<String, String>();
				data.put("type", "2");
				data.put("name", dci.getDepartmentname());
				data.put("id", dci.getDepartmentid());
				dData.add(data);
			}
		}
		
		result.put("cdata", cData);
		result.put("sdata", sData);
		result.put("ddata", dData);
		result.put("rdata", rData);
	}else if(operation.equals("getBirthdayUserList")){//\u83b7\u53d6\u8fc7\u751f\u65e5\u7684\u4eba\u5458\u5217\u8868
		int status = 1;String msg = "";
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(InterfaceUtil.wxCheckLogin(ticket)){
			try{
				int remindType = Util.getIntValue(fu.getParameter("remindType"),1);//1\u5f53\u5929 2\u63d0\u524d\u51e0\u5929
				int beforeDay = Util.getIntValue(fu.getParameter("beforeDay"),0);//\u63d0\u524d\u51e0\u5929
				String nowDate = TimeUtil.getCurrentDateString();
				if(remindType!=1){
					nowDate = TimeUtil.dateAdd(nowDate, beforeDay);
				}
				if(null!=nowDate&&!nowDate.equals("")){
					nowDate = nowDate.substring(5);
					rs.executeSql("select id,loginid,lastname,departmentid,subcompanyid1 from HrmResource where birthday like '%"+nowDate+"' and (status =0 or status =1 or status =2 or status =3) order by dsporder,id");
					String userdbids = "",userids = "",usernames = "",shownames = "",departids = "",subcompanyids = "";
					while(rs.next()){
						String id = Util.null2String(rs.getString("id"));
						userdbids += ","+id;
						if(InterfaceUtil.getUserkeytype().equals("loginid")){
							id = Util.null2String(InterfaceUtil.transUserId(id,1));
						}
						userids +=","+id;
						String lastname = Util.null2String(rs.getString("lastname"));
						usernames += ","+lastname;
						String subcompanyid = Util.null2String(rs.getString("subcompanyid1"));
						subcompanyids += ","+subcompanyid;
						String departid = Util.null2String(rs.getString("departmentid"));
						departids += ","+departid;
						String deptName = dci.getDepartmentname(departid);
						shownames += ","+lastname+"-"+deptName;
					}
					if(!userdbids.equals("")){
						userdbids = userdbids.substring(1);
					}
					if(!userids.equals("")){
						userids = userids.substring(1);
					}
					if(!usernames.equals("")){
						usernames = usernames.substring(1);
					}
					if(!shownames.equals("")){
						shownames = shownames.substring(1);
					}
					if(!subcompanyids.equals("")){
						subcompanyids = subcompanyids.substring(1);
					}
					if(!departids.equals("")){
						departids = departids.substring(1);
					}
					result.put("userdbids", userdbids);
					result.put("userids", userids);
					result.put("usernames", usernames);
					result.put("shownames", shownames);
					result.put("subcompanyids", subcompanyids);
					result.put("departids", departids);
					status = 0;
				}else{
					msg = "\u83b7\u53d6\u7684\u751f\u65e5\u65e5\u671f\u4e3anull\u6216\u8005\u4e3a\u7a7a";
				}
			}catch(Exception e){
				e.printStackTrace();
				msg = "\u83b7\u53d6OA\u4e2d\u8fc7\u751f\u65e5\u4eba\u5458\u7a0b\u5e8f\u51fa\u73b0\u5f02\u5e38:"+e.getMessage();
			}
		}else{
			msg = "ticket\u65e0\u6548";
		}
		result.put("status", status);
		result.put("msg", msg);
		
	}else if(operation.equals("getUserByTag")){//\u6839\u636e\u624b\u673a\u53f7/\u8d26\u53f7 \u67e5\u8be2OA\u4eba\u5458
		String ticket = Util.null2String(fu.getParameter("ticket"));//\u7528\u7968\u636e\u9a8c\u8bc1\u662f\u5426\u6765\u6e90\u4e8e\u5fae\u4fe1\u5e73\u53f0
		if(InterfaceUtil.wxCheckLogin(ticket)){
			
			String tagvalue = Util.null2String(fu.getParameter("tagvalue"));
			int bindtype = Util.getIntValue(fu.getParameter("bindtype"),1);
			String ipaddress = Util.null2String(fu.getParameter("ipaddress"));//IP\u5730\u5740
			String clienttype = Util.null2String(fu.getParameter("clienttype"));//app\u7c7b\u578b
			int status = 1;String msg = "";
			String outuserid = "";//ec\u7cfb\u7edf\u7684\u7528\u6237id \u552f\u4e00\u6807\u8bc6
			String outsysuserid = "";
			String outsysloginid = "";
			if(!"".equals(tagvalue)){
				try{
					//\u83b7\u53d6\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u7528\u6237\u6807\u8bc6
					String userkeytype = Util.null2String(InterfaceUtil.getUserkeytype());
					if(bindtype==1){//\u624b\u673a\u53f7\u67e5\u8be2
						rs.executeSql("select id from HrmResource where (status = 0 or status = 1 or status = 2 or status = 3) and status != 10 and (accounttype is null or accounttype=0) and mobile='"+tagvalue+"' order by id");
						if(rs.next()){
							outuserid = Util.null2String(rs.getString("id"));
							outsysloginid = InterfaceUtil.transUserId(outuserid, 1);
							//\u6267\u884c\u767b\u5f55\u64cd\u4f5c
							int dologin = Util.getIntValue(fu.getParameter("dologin"),0);
							if(dologin==1){
								Map loginres = ps.login(outuserid, "zh_cn", ipaddress);
								result.put("sessionkey", Util.null2String((String)loginres.get("sessionkey")));
								
								//\u8bb0\u5f55\u767b\u5f55\u65e5\u5fd7
								InterfaceUtil.writeLoginLog(outuserid,ipaddress,clienttype);
							}
			
							if(userkeytype.equalsIgnoreCase("id")){
								outsysuserid = outuserid;//outsysuserid \u5916\u90e8\u7cfb\u7edfuserkey
							}else{
								outsysuserid = outsysloginid;
							}
							status = 0;
						}else{
							msg = "\u627e\u4e0d\u5230OA\u4eba\u5458";
						}
					}else if(bindtype==2){//\u8d26\u53f7\u67e5\u627e
						outuserid = InterfaceUtil.transUserId(tagvalue, 0);
						if(!"".equals(outuserid)){
							outsysloginid = InterfaceUtil.transUserId(outuserid, 1);
							if(userkeytype.equalsIgnoreCase("id")){
								outsysuserid = outuserid;//outsysuserid \u5916\u90e8\u7cfb\u7edfuserkey
							}else{
								outsysuserid = outsysloginid;
							}
							status = 0;
						}else{
							msg = "\u627e\u4e0d\u5230OA\u4eba\u5458";
						}
					}else if(bindtype==3){//\u6570\u636e\u5e93id\u67e5\u627e
						outsysloginid = InterfaceUtil.transUserId(tagvalue, 1);
						if(!"".equals(outsysloginid)){
							outuserid = InterfaceUtil.transUserId(outsysloginid, 0);
							if(userkeytype.equalsIgnoreCase("id")){
								outsysuserid = outuserid;//outsysuserid \u5916\u90e8\u7cfb\u7edfuserkey
							}else{
								outsysuserid = outsysloginid;
							}
							status = 0;
						}else{
							msg = "\u627e\u4e0d\u5230OA\u4eba\u5458";
						}
					}
					
				}catch(Exception e){
					msg = "Ecology\u7aef\u67e5\u627e\u4eba\u5458\u51fa\u73b0\u5f02\u5e38:"+e.getMessage();
				}
			}else{
				msg = "tagvalue\u503c\u4e3a\u7a7a";
			}
			//\u83b7\u53d6\u6240\u6709\u4e0a\u7ea7\u90e8\u95e8\u5df2\u7ecf\u4e0a\u7ea7\u5206\u90e8
			String deptid = ResourceComInfo.getDepartmentID(outuserid);
			String alldeptids = getAllSupDepartment(deptid,null,1,deptid);
			result.put("alldeptids", alldeptids);
			String subid = ResourceComInfo.getSubCompanyID(outuserid);
			String allsubids = getAllSupSubCompany(subid,null,1,subid);
			result.put("allsubids", allsubids);
			result.put("seclevel",ResourceComInfo.getSeclevel(outuserid));
			result.put("outuserid", outuserid);
			result.put("outsysloginid", outsysloginid);
			result.put("outsysuserid", outsysuserid);
			result.put("status", status);
			result.put("msg", msg);
		}else{
			result.put("status", 1);
			result.put("msg", "ticket\u65e0\u6548");
		}
		
	} else if(operation.equals("getDocNames")) {
		//if(this.isutf8()){
			response.setContentType("application/json;charset=UTF-8");
		//}
		String selectids = fu.getParameter("selectids");
		String from = "";
		String fromids = "";
		String showstr = "";
		String includereplay = "";

		if(!"".equals(selectids)) {
			String[] t = new String[]{"","",""};
			//t = Util.TokenizerString2(selectids,"|");
			t = selectids.split("\\|", -1);
			if(t==null||t.length==0) t = new String[]{"","",""};
			if(t.length>2) {
				from = t[0];           //\u6587\u6863\u7c7b\u578b
				fromids = t[1];        //\u6587\u6863id
				//includereplay = t[2];  //\u662f\u5426\u5305\u542b\u56de\u590d
			}
			showstr = ",";

			if(fromids!=null&&!"".equals(fromids)){
				String[] tid = Util.TokenizerString2(fromids,",");
				for(int i=0;tid!=null&&i<tid.length;i++){
					if(tid[i]==null||"".equals(tid[i])) continue;
					if("1".equals(from)){
						showstr = showstr + docNewsComInfo.getDocNewsname(tid[i]) +",";
					} else if("2".equals(from)){
						showstr = showstr + secCategoryComInfo.getSecCategoryname(tid[i])+",";
					} else if("3".equals(from)){
						showstr = showstr + docTreeDocFieldComInfo.getTreeDocFieldName(tid[i])+",";
					} else if("4".equals(from)){
						showstr = showstr + docComInfo.getDocname(tid[i])+",";
					}
				}
			}
			result.put("success", true);
			result.put("docNames", showstr.substring(1));
		} else {
			result.put("success", false);
			result.put("message", "selectids\u53c2\u6570\u4e3a\u7a7a");
		}
	}
	
	JSONObject jro = null;
	if(result!=null){
		jro = new JSONObject(result);
	}
	out.println(jro);

      out.write(_jsp_string2, 0, _jsp_string2.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("mobile/plugin/WxInterface.jsp"), -5950653068781832982L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string1;
  private final static char []_jsp_string0;
  private final static char []_jsp_string2;
  static {
    _jsp_string1 = "\r\n".toCharArray();
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string2 = "\r\n\r\n".toCharArray();
  }
}
