/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._workflow._request;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.systeminfo.SystemEnv;
import weaver.hrm.User;
import weaver.hrm.HrmUserVarify;
import weaver.general.Util;
import weaver.conn.*;
import java.util.*;
import org.json.JSONObject;
import org.json.JSONArray;
import weaver.workflow.workflow.WorkflowVersion;
import weaver.systeminfo.menuconfig.LeftMenuInfoHandler;
import weaver.systeminfo.menuconfig.LeftMenuInfo;
import weaver.general.BaseBean;

public class _myrequestviewajaxcount__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.conn.RecordSet RecordSet;
      RecordSet = (weaver.conn.RecordSet) pageContext.getAttribute("RecordSet");
      if (RecordSet == null) {
        RecordSet = new weaver.conn.RecordSet();
        pageContext.setAttribute("RecordSet", RecordSet);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.resource.ResourceComInfo ResourceComInfo;
      ResourceComInfo = (weaver.hrm.resource.ResourceComInfo) pageContext.getAttribute("ResourceComInfo");
      if (ResourceComInfo == null) {
        ResourceComInfo = new weaver.hrm.resource.ResourceComInfo();
        pageContext.setAttribute("ResourceComInfo", ResourceComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.workflow.WorkTypeComInfo WorkTypeComInfo;
      WorkTypeComInfo = (weaver.workflow.workflow.WorkTypeComInfo) pageContext.getAttribute("WorkTypeComInfo");
      if (WorkTypeComInfo == null) {
        WorkTypeComInfo = new weaver.workflow.workflow.WorkTypeComInfo();
        pageContext.setAttribute("WorkTypeComInfo", WorkTypeComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.workflow.WorkflowComInfo WorkflowComInfo;
      WorkflowComInfo = (weaver.workflow.workflow.WorkflowComInfo) pageContext.getAttribute("WorkflowComInfo");
      if (WorkflowComInfo == null) {
        WorkflowComInfo = new weaver.workflow.workflow.WorkflowComInfo();
        pageContext.setAttribute("WorkflowComInfo", WorkflowComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.system.SystemComInfo sysInfo;
      sysInfo = (weaver.system.SystemComInfo) pageContext.getAttribute("sysInfo");
      if (sysInfo == null) {
        sysInfo = new weaver.system.SystemComInfo();
        pageContext.setAttribute("sysInfo", sysInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.request.todo.RequestUtil requestutil;
      requestutil = (weaver.workflow.request.todo.RequestUtil) pageContext.getAttribute("requestutil");
      if (requestutil == null) {
        requestutil = new weaver.workflow.request.todo.RequestUtil();
        pageContext.setAttribute("requestutil", requestutil);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      
User user = HrmUserVarify.getUser (request , response) ;
if(user==null) {
    return;
}
Enumeration em = request.getParameterNames();
boolean isinit = true;
while(em.hasMoreElements())
{
	String paramName = (String)em.nextElement();
	if(!paramName.equals(""))
		isinit = false;
	break;
}
//\u662f\u5426\u9700\u8981\u52a0\u8f7d\u6811
String offical = Util.null2String(request.getParameter("offical"));
int officalType = Util.getIntValue(request.getParameter("officalType"),-1);
String loadtree = Util.null2String(request.getParameter("loadtree"));
int date2during = Util.getIntValue(request.getParameter("date2during"),0);
String imagefilename = "/images/hdReport_wev8.gif";
String titlename =  SystemEnv.getHtmlLabelName(1210,user.getLanguage()) +":"+SystemEnv.getHtmlLabelName(367,user.getLanguage());
String needfav ="1";
String needhelp ="";

String resourceid=""+user.getUID();
int userid = user.getUID();
String userID = String.valueOf(user.getUID());
String belongtoshow = "";				
								RecordSet.executeSql("select * from HrmUserSetting where resourceId = "+userID);
								if(RecordSet.next()){
									belongtoshow = RecordSet.getString("belongtoshow");
								}
String userIDAll = String.valueOf(user.getUID());
		
String Belongtoids =user.getBelongtoids();
int Belongtoid=0;
String[] arr2 = null;
ArrayList<String> userlist = new ArrayList();
userlist.add(userid + "");
if(!"".equals(Belongtoids)){
userIDAll = userID+","+Belongtoids;
arr2 = Belongtoids.split(",");
for(int i=0;i<arr2.length;i++){
Belongtoid = Util.getIntValue(arr2[i]);
userlist.add(Belongtoid + "");
}
}

session.removeAttribute("RequestViewResource");
String logintype = ""+user.getLogintype();
int usertype = 0; 

/* edited by wdl 2006-06-14 left menu advanced menu */
int fromAdvancedMenu = Util.getIntValue(request.getParameter("fromadvancedmenu"),0);
String selectedContent = Util.null2String(request.getParameter("selectedContent"));
String menuType = Util.null2String(request.getParameter("menuType"));
int infoId = Util.getIntValue(request.getParameter("infoId"),0);
if(selectedContent!=null && selectedContent.startsWith("key_")){
	String menuid = selectedContent.substring(4);
	RecordSet.executeSql("select * from menuResourceNode where contentindex = '"+menuid+"'");
	selectedContent = "";
	while(RecordSet.next()){
		String keyVal = RecordSet.getString(2);
		selectedContent += keyVal +"|";
	}
	if(selectedContent.indexOf("|")!=-1)
		selectedContent = selectedContent.substring(0,selectedContent.length()-1);
}
if(fromAdvancedMenu == 1){
	response.sendRedirect("/workflow/search/WFSearchCustom.jsp?offical="+offical+"&officalType="+officalType+"&fromadvancedmenu=1&infoId="+infoId+"&selectedContent="+selectedContent+"&menuType="+menuType);
	return;
}
String selectedworkflow = "";
LeftMenuInfoHandler infoHandler = new LeftMenuInfoHandler();
LeftMenuInfo info = infoHandler.getLeftMenuInfo(infoId);
if(info!=null){
	selectedworkflow = info.getSelectedContent();
}
if(!"".equals(selectedContent))
{
	selectedworkflow = selectedContent;
}
selectedworkflow+="|";
/* edited end */    

if(logintype.equals("2"))
	usertype= 1;
char flag = Util.getSeparator();

int olddate2during = 0;
BaseBean baseBean = new BaseBean();
String date2durings = "";
try
{
	date2durings = Util.null2String(baseBean.getPropValue("wfdateduring", "wfdateduring"));
}
catch(Exception e)
{}
String[] date2duringTokens = Util.TokenizerString2(date2durings,",");
if(date2duringTokens.length>0)
{
	olddate2during = Util.getIntValue(date2duringTokens[0],0);
}
if(olddate2during<0||olddate2during>36)
{
	olddate2during = 0;
}
if(isinit)
{
	date2during = olddate2during;
}

ArrayList wftypes=new ArrayList();
ArrayList wftypecounts=new ArrayList();
ArrayList workflows=new ArrayList();
ArrayList wftypecountsy=new ArrayList();
ArrayList workflowcounts=new ArrayList();//\u672a\u5f52\u6863\u7684
ArrayList workflowcountsy=new ArrayList();//\u5f52\u6863
ArrayList newcountslist = new ArrayList();//\u672a\u8bfb
ArrayList supedcountslist = new ArrayList();//\u53cd\u9988
ArrayList overcountslist = new ArrayList();//\u8d85\u65f6

Map workflowcountsMap=new Hashtable();//\u672a\u5f52\u6863\u7684\u6570\u91cf
Map workflowcountsyMap=new Hashtable();//\u5f52\u6863\u6570\u91cf
Map newcountsMap=new Hashtable();     //\u672a\u8bfb
Map supedcountsMap=new Hashtable();//\u53cd\u9988\u6570\u91cf
Map overcountsMap = new Hashtable();	//\u8d85\u65f6\u6570\u91cf

String _viewtype = "";	//
int totalcount=0;
int totalcounty=0;
String currworkflowtype="";

String currworkflowid="";
String currentnodetype="";
String _wftypes = "";
String demoLeftMenus = "";

StringBuffer sqlsb = new StringBuffer();

sqlsb.append("select count(distinct t1.requestid) typecount, ");
sqlsb.append("      t2.workflowtype, ");
sqlsb.append("      t1.workflowid, ");
sqlsb.append("      t1.currentnodetype ");
sqlsb.append(" from workflow_requestbase t1, workflow_base t2,workflow_currentoperator t3 ");
	if("1".equals(belongtoshow)){
		sqlsb.append(" where t1.creater in ( ").append(userIDAll);	
			}else{
		sqlsb.append(" where t1.creater in (").append(resourceid);
			}
sqlsb.append(") and t1.creatertype = ").append(usertype);
sqlsb.append("  and t1.workflowid = t2.id ");
sqlsb.append("  and t1.requestid = t3.requestid ");
sqlsb.append("  and t3.islasttimes=1 ");
sqlsb.append("  and (t2.isvalid='1' or t2.isvalid='3') ");
if(RecordSet.getDBType().equals("oracle"))
{
	sqlsb.append(" and (nvl(t1.currentstatus,-1) = -1 or (nvl(t1.currentstatus,-1)=0 and t1.creater="+user.getUID()+")) ");
}
else
{
	sqlsb.append(" and (isnull(t1.currentstatus,-1) = -1 or (isnull(t1.currentstatus,-1)=0 and t1.creater="+user.getUID()+")) ");
}
sqlsb.append("  and exists ");
sqlsb.append("		(select 1 ");
sqlsb.append("         from workflow_currentoperator ");
sqlsb.append("        where workflow_currentoperator.islasttimes='1' ");
if("1".equals(belongtoshow)){
		sqlsb.append("          and workflow_currentoperator.userid in (" + userIDAll + WorkflowComInfo.getDateDuringSql(date2during) +")) ");
		}else{
		sqlsb.append("          and workflow_currentoperator.userid in ( " + resourceid + WorkflowComInfo.getDateDuringSql(date2during) +")) ");
		}
if(offical.equals("1")){//\u53d1\u6587/\u6536\u6587/\u7b7e\u62a5
	if(officalType==1){
		sqlsb.append(" and t1.workflowid in (select id from workflow_base where isWorkflowDoc=1 and officalType in (1,3) and isvalid=1)");
	}else if(officalType==2){
		sqlsb.append(" and t1.workflowid in (select id from workflow_base where isWorkflowDoc=1 and officalType=2 and isvalid=1)");
	}
}
sqlsb.append("group by t2.workflowtype, t1.workflowid, t1.currentnodetype");
RecordSet.executeSql(sqlsb.toString());
//System.out.println("sqlsb.toString():"+sqlsb.toString());
   //RecordSet.executeProc("workflow_requestbase_MyRequest",resourceid+flag+usertype);
while (RecordSet.next())
{
	currworkflowtype = RecordSet.getString("workflowtype");
	currworkflowid = RecordSet.getString("workflowid");
	 
	currworkflowid = WorkflowVersion.getActiveVersionWFID(currworkflowid);
	 
	currentnodetype=RecordSet.getString("currentnodetype");
	_viewtype = RecordSet.getString("viewtype");
	int theworkflowcount=RecordSet.getInt("typecount");
	if(selectedworkflow.indexOf("T"+currworkflowtype+"|")==-1 && fromAdvancedMenu==1) continue;
	if(selectedworkflow.indexOf("W"+currworkflowid+"|")==-1 && fromAdvancedMenu==1) continue;
	int temps=wftypes.indexOf(currworkflowtype);
	if (temps!=-1)
	{
	 	if (currentnodetype.equals("3"))
	 		wftypecountsy.set(temps,""+(Util.getIntValue((String)wftypecountsy.get(temps),0)+theworkflowcount));
	 	else
	  		wftypecounts.set(temps,""+(Util.getIntValue((String)wftypecounts.get(temps),0)+theworkflowcount));
	}
	else
	{
	 	wftypes.add(currworkflowtype);
	 	if (currentnodetype.equals("3"))
	 	{
	 		wftypecountsy.add(""+RecordSet.getString("typecount"));
	 		wftypecounts.add(""+0);
	 	}
	 	else
	 	{
	 		wftypecounts.add(""+RecordSet.getString("typecount"));
	 		wftypecountsy.add(""+0);
	 	}
	}
	temps=workflows.indexOf(currworkflowid);
	if (temps!=-1)
	{
		if (currentnodetype.equals("3"))
	 		workflowcountsy.set(temps,""+(Util.getIntValue((String)workflowcountsy.get(temps),0)+theworkflowcount));	
	 	else
	 		workflowcounts.set(temps,""+(Util.getIntValue((String)workflowcounts.get(temps),0)+theworkflowcount));
	}
	else
	{
	 	workflows.add(currworkflowid);
	 	if (currentnodetype.equals("3"))
	 	{
	 		workflowcountsy.add(""+RecordSet.getString("typecount"));
	 		workflowcounts.add(""+0);
	 	}
	 	else
	 	{
	 		workflowcounts.add(""+RecordSet.getString("typecount"));
	 		workflowcountsy.add(""+0);
	 	}
	}
	 
	if (currentnodetype.equals("3"))
	 	totalcounty+=theworkflowcount;
	else
	 	totalcount+=theworkflowcount;
}

StringBuffer wftypesb = new StringBuffer();
  	StringBuffer wfsb = new StringBuffer();
  	StringBuffer wfnodesb = new StringBuffer();

for(int x=0;x<workflows.size();x++)
{
	String _wfid = (String)workflows.get(x);
	String _wftype = (String)WorkflowComInfo.getWorkflowtype(_wfid);
}

for(int i=0;i<workflows.size();i++){
    String tworkflowid = (String)workflows.get(i);
	 String tworkflowtype = (String)WorkflowComInfo.getWorkflowtype(tworkflowid);
    if(tworkflowtype.equals("")){
	    tworkflowtype = "0";
    }
    int newcount=0;
    int newcount1=0;
    //tworkflowNodeIDs = Util.null2String((String)wfNodeHahstable.get(tworkflowid));
    if(!"".equals(tworkflowtype)){
	 wftypesb.append(",").append(tworkflowtype);
	 //wfsb.append(",").append(WorkflowVersion.getAllVersionStringByWFIDs(tworkflowid));
	 String tempworkflowid = WorkflowVersion.getAllVersionStringByWFIDs(tworkflowid) ;
	 if(tempworkflowid.equals("")){
		 tempworkflowid = "0";
	 }
	 wfsb.append(",").append(tempworkflowid);
    }
	 /*
	 String tempnodeid = WorkflowVersion.getAllRelationNodeStringByNodeIDs(tworkflowNodeIDs);
	 if (tempnodeid != null && !"".equals(tempnodeid)) {
	 	wfnodesb.append(",").append(tempnodeid);
	 }
	 */
	 
	 }

	 if (wftypesb.length() > 0) {
	  	wftypesb = wftypesb.delete(0, 1);
		wfsb = wfsb.delete(0, 1);
	 }
	 if (wfnodesb.indexOf(",") == 0) {
		wfnodesb = wfnodesb.delete(0, 1);
	 }
	 

	sqlsb = new StringBuffer();
	sqlsb.append(" select t3.workflowtype, t3.workflowid, count(distinct t1.requestid) viewcount,t3.viewtype,t3.isremark ");
	sqlsb.append(" from workflow_requestbase t1, workflow_base t2,workflow_currentoperator t3 ");
	sqlsb.append(" where t1.creater = ").append(resourceid);
	sqlsb.append(" and t3.userid = ").append(resourceid);
	sqlsb.append("  and t1.creatertype = ").append(usertype);
	sqlsb.append("  and t1.workflowid = t2.id ");
	sqlsb.append("	    and t3.workflowtype in ( ").append(wftypesb).append(") ");
	sqlsb.append("	    and t3.workflowid in (").append(wfsb).append(")");
	sqlsb.append("  and t1.requestid = t3.requestid ");
	sqlsb.append("  and t3.islasttimes=1 ");
	sqlsb.append("  and (t2.isvalid='1' or t2.isvalid='3') ");
	sqlsb.append(" and (t1.deleted=0 or t1.deleted is null) and ((t3.isremark in('2','4') and t1.currentnodetype = '3') or t1.currentnodetype <> '3' ) ");
	if(RecordSet.getDBType().equals("oracle"))
	{
		sqlsb.append(" and (nvl(t1.currentstatus,-1) = -1 or (nvl(t1.currentstatus,-1)=0 and t1.creater="+user.getUID()+")) ");
	}
	else
	{
		sqlsb.append(" and (isnull(t1.currentstatus,-1) = -1 or (isnull(t1.currentstatus,-1)=0 and t1.creater="+user.getUID()+")) ");
	}
	sqlsb.append("  and exists ");
	sqlsb.append("		(select 1 ");
	sqlsb.append("         from workflow_currentoperator ");
	sqlsb.append("        where workflow_currentoperator.islasttimes='1' ");
	sqlsb.append("          and workflow_currentoperator.userid = " + resourceid + WorkflowComInfo.getDateDuringSql(date2during) +") ");
	if(offical.equals("1")){//\u53d1\u6587/\u6536\u6587/\u7b7e\u62a5
		if(officalType==1){
			sqlsb.append(" and t1.workflowid in (select id from workflow_base where isWorkflowDoc=1 and officalType in (1,3) and isvalid=1)");
		}else if(officalType==2){
			sqlsb.append(" and t1.workflowid in (select id from workflow_base where isWorkflowDoc=1 and officalType=2 and isvalid=1)");
		}
	}
	sqlsb.append(" group by viewtype,t3.isremark, t3.workflowtype, t3.workflowid");
	RecordSet.execute(sqlsb.toString());
	//System.out.println(sqlsb.toString());
	int _newcount = 0;
	int _rescount = 0;
	int _outcount = 0;
	while(RecordSet.next()) {
	    
	    String tworkflowtype = Util.null2String(RecordSet.getString("workflowtype"));
        String tworkflowid = WorkflowVersion.getActiveVersionWFID(Util.null2String(RecordSet.getString("workflowid")));
        
        
		int _vc = Util.getIntValue(RecordSet.getString("viewcount"),0);
		
		String _im = RecordSet.getString("isremark");
		String _vt = RecordSet.getString("viewtype"); 
		//System.out.println(WorkflowComInfo.getWorkflowname(_wfid) +" \u6709"+(_vt.equals("-1")?"\u53cd\u9988":(_vt.equals("0")?"\u672a\u8bfb":"\u4e00\u822c"))+"\u6d41\u7a0b \uff1a"+_vc+" \u6761");
		int wfindex = workflows.indexOf(tworkflowid) ;
		if(wfindex != -1) {
			if(_im.equals("5")) {
				//_outcount += _vc;
				Object tempobj = overcountsMap.get(tworkflowid);
                if (tempobj != null) {
                	int wf0countindex = (Integer)tempobj ;
                	overcountsMap.put(tworkflowid, wf0countindex + _vc);
                } else {
                    overcountsMap.put(tworkflowid, _vc);  
                }
			}else{
			    
				if(_vt.equals("-1")) {
				 	
				    Object tempobj = supedcountsMap.get(tworkflowid);
	                if (tempobj != null) {
	                	int wf0countindex = (Integer)tempobj ;
	                	supedcountsMap.put(tworkflowid, wf0countindex + _vc);
	                } else {
	                    supedcountsMap.put(tworkflowid, _vc);  
	                }
				    
					//_rescount += _vc;
					
				}
				if(_vt.equals("0")) {
				    Object tempobj = newcountsMap.get(tworkflowid);
	                if (tempobj != null) {
	                	int wf0countindex = (Integer)tempobj ;
	                	newcountsMap.put(tworkflowid, wf0countindex + _vc);
	                } else {
	                    newcountsMap.put(tworkflowid, _vc);  
	                }
					//_newcount += _vc;
				}
			}
		}
	}
	//newcountslist.add(_newcount+"");
	//supedcountslist.add(_rescount+"");
	//overcountslist.add(_outcount+"");
//}

/***************************************/
//\u5de6\u4fa7\u6811 json \u6570\u636e\u751f\u6210\u903b\u8f91
demoLeftMenus+="[";
String typeid="";
String typecount="";	//\u672a\u5f52\u6863\u7684type\u6570\u91cf
String typecounty = "";	//\u5df2\u5f52\u6863\u7684type\u6570\u91cf
String typename="";
String workflowid="";
String workflowcount="";	//\u672a\u5f52\u6863\u7684\u6570\u91cf
String workflowcounty = "";	//\u5f52\u6863\u7684\u6570\u91cf

String wfnewcount = ""; //\u672a\u8bfb
String wfrescount = ""; //\u53cd\u9988
String wfoutcount = ""; //\u8d85\u65f6
String workflowname="";
       				
for(int i=0;i<wftypes.size();i++){
	typeid=(String)wftypes.get(i);
	typename=WorkTypeComInfo.getWorkTypename(typeid);

	demoLeftMenus+="{";
	demoLeftMenus+="\"__domid__\":\"__type_"+typeid+"\",";
	
	List<Map> maps=new ArrayList(0);
	int flowAll=0;
	int flowNew=0;
	int flowResponse=0;
	int flowOut=0;
	
	for(int j=0;j<workflows.size();j++){
		workflowid=(String)workflows.get(j);
		String curtypeid=WorkflowComInfo.getWorkflowtype(workflowid);
		if(!curtypeid.equals(typeid)){
			continue;
		}
		workflowcount=(String)workflowcounts.get(j);
		workflowcounty = (String)workflowcountsy.get(j);
		//wfnewcount = (String)newcountslist.get(j);
		//wfrescount = (String)supedcountslist.get(j);
		//wfoutcount = (String)overcountslist.get(j);
		
		Object tempovtimenumObj = newcountsMap.get(workflowid);
		if (tempovtimenumObj != null) {
		    wfnewcount = tempovtimenumObj.toString();
		} else {
		    wfnewcount = "0";
		}
		
		Object tempovtimenumObj2 = supedcountsMap.get(workflowid);
		if (tempovtimenumObj2 != null) {
		    wfrescount = tempovtimenumObj2.toString();
		} else {
		    wfrescount = "0";
		}
		
		Object tempovtimenumObj3 = overcountsMap.get(workflowid);
		if (tempovtimenumObj3 != null) {
		    wfoutcount = tempovtimenumObj3.toString();
		} else {
		    wfoutcount = "0";
		}
		
		String wfallcount = (Util.getIntValue(workflowcount) + Util.getIntValue(workflowcounty))+"";
		//System.out.println("\u672a\u5f52\u6863\uff1a"+workflowcount+"   \u5df2\u5f52\u6863\uff1a"+workflowcounty);
		workflowname=WorkflowComInfo.getWorkflowname(workflowid);
		//System.out.println(workflowname+"   \u672a\u8bfb\u6d41\u7a0b\uff1a"+wfnewcount+"\u53cd\u9988\u6d41\u7a0b\uff1a"+wfrescount);
			Map map=new HashMap();
			map.put("name",Util.toScreen(workflowname,user.getLanguage()));
			map.put("workflowid",workflowid);
			map.put("flowAll",Util.toScreen(wfallcount,user.getLanguage()));
			map.put("flowNew",Util.toScreen(wfnewcount,user.getLanguage()));
			map.put("flowResponse",Util.toScreen(wfrescount,user.getLanguage()));
			map.put("flowOut",Util.toScreen(wfoutcount,user.getLanguage()));
			if(workflowcount.equals("")) workflowcount = "0";
			if(workflowcounty.equals("0")) workflowcounty = "0";
			//\u628a\u672a\u5f52\u6863\u7684\u548c\u5df2\u5f52\u6863\u7684\u5408\u5e76\u8d77\u6765 modifier Dracula 2014-7-7
			if(workflowcount.equals("0") && workflowcounty.equals("0"));
			else{
				maps.add(map);
			}
		
		flowAll+=Integer.valueOf(map.get("flowAll")+"");
		flowNew+=Integer.valueOf(map.get("flowNew")+"");
		flowResponse+=Integer.valueOf(map.get("flowResponse")+"");
		flowOut+=Integer.valueOf(map.get("flowOut")+"");
	}
	
	
	demoLeftMenus+="\"numbers\":{";
	demoLeftMenus+="\"flowAll\":"+flowAll+",";
	demoLeftMenus+="\"flowNew\":"+flowNew+",";
	demoLeftMenus+="\"flowResponse\":"+flowResponse+",";
	demoLeftMenus+="\"flowOut\":"+flowOut;
	demoLeftMenus+="}";
	demoLeftMenus+="}";
	if (maps.size() > 0) {
		demoLeftMenus += ",";
	}
	
	for(int x=0;x<maps.size();x++){
		Map map=maps.get(x);
		demoLeftMenus+="{";	
		demoLeftMenus+="\"__domid__\":\"__wf_"+map.get("workflowid")+"\",";
		demoLeftMenus+="\"numbers\":{";
		demoLeftMenus+="\"flowAll\":"+map.get("flowAll")+",";
		demoLeftMenus+="\"flowNew\":"+map.get("flowNew")+",";
		demoLeftMenus+="\"flowResponse\":"+map.get("flowResponse")+",";
		demoLeftMenus+="\"flowOut\":"+map.get("flowOut");
		demoLeftMenus+="}";
		demoLeftMenus+="}";
		demoLeftMenus += (x==maps.size()-1)?"":",";
	}
	if (i < wftypes.size() - 1) {
		demoLeftMenus += ",";
	}
}

if(requestutil.getOfsSetting().getIsuse()==1){
        RecordSet rs = new RecordSet();
        RecordSet rs1 = new RecordSet();
        RecordSet rs2 = new RecordSet();
        if(demoLeftMenus.length()>10){
            demoLeftMenus += ",";
        }
        rs.executeSql("select sysid,(select COUNT(requestid) from ofs_todo_data where creatorid = "+user.getUID()+"  and creatorid=userid AND islasttimes=1 AND workflowid in (select workflowid from ofs_workflow where sysid=ofs_sysinfo.sysid and cancel=0) ) as allc,(select COUNT(requestid) from ofs_todo_data where creatorid="+user.getUID()+" and creatorid=userid and islasttimes=1  and viewtype='0'  AND workflowid in (select workflowid from ofs_workflow where sysid=ofs_sysinfo.sysid and cancel=0) ) as alldb from ofs_sysinfo  where cancel=0 ");
        while(rs.next()){
            String _typeid = rs.getString("sysid") ;

            demoLeftMenus+="{";
            demoLeftMenus+="\"__domid__\":\"__type_"+_typeid+"\",";
            demoLeftMenus+="\"numbers\":{";
            demoLeftMenus+="\"flowAll\":"+rs.getInt("allc")+",";
            demoLeftMenus+="\"flowNew\":"+rs.getInt("alldb")+",";
            demoLeftMenus+="\"flowResponse\":0,";
            demoLeftMenus+="\"flowOut\":0";
            demoLeftMenus+="}";
            demoLeftMenus+="},";

            rs1.executeSql("select workflowid,workflowname from ofs_workflow where sysid="+_typeid+" and cancel=0");
            while(rs1.next()){
                String _wfid = rs1.getString(1);
                String _wfname = rs1.getString(2);
                rs2.executeSql("select COUNT(requestid) from ofs_todo_data where creatorid="+user.getUID()+" and creatorid=userid AND islasttimes=1 AND workflowid=" + _wfid + " ");
                int wfcount = 0;
                if (rs2.next()) {
                    wfcount = Util.getIntValue(rs2.getString(1), 0);
                }

                rs2.executeSql("select count(*) from ofs_todo_data where creatorid="+user.getUID()+" and creatorid=userid AND islasttimes=1 and viewtype='0' and workflowid="+_wfid+" and sysid="+_typeid);
                int _wfnewcount = 0;
                if(rs2.next()){
                    _wfnewcount = Util.getIntValue(rs2.getString(1),0);
                }
                
                demoLeftMenus+="{";
                demoLeftMenus+="\"__domid__\":\"__wf_"+_wfid+"\",";
                demoLeftMenus+="\"numbers\":{";

                demoLeftMenus+="\"flowAll\":"+wfcount+",";
                demoLeftMenus+="\"flowNew\": "+_wfnewcount+",";
                demoLeftMenus+="\"flowResponse\":0,";
                demoLeftMenus+="\"flowOut\":0";

                demoLeftMenus+="}";
                demoLeftMenus+="},";

            }

        }
        if(demoLeftMenus.endsWith(",")){
            demoLeftMenus = demoLeftMenus.substring(0,demoLeftMenus.length()-1);
        }
    }
	
demoLeftMenus += "]";

out.print(demoLeftMenus);
	

      out.write(_jsp_string2, 0, _jsp_string2.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("workflow/request/MyRequestViewAjaxCount.jsp"), 3931460181948094526L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string2;
  private final static char []_jsp_string1;
  private final static char []_jsp_string0;
  static {
    _jsp_string2 = "\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n \r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
  }
}
