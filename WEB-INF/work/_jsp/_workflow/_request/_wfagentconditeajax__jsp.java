/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._workflow._request;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.general.*;
import java.util.*;
import java.sql.Timestamp;
import weaver.general.GCONST;
import weaver.hrm.HrmUserVarify;
import weaver.hrm.User;
import java.text.SimpleDateFormat;
import org.json.JSONObject;
import weaver.workflow.workflow.WorkflowVersion;

public class _wfagentconditeajax__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.conn.RecordSet rs;
      rs = (weaver.conn.RecordSet) pageContext.getAttribute("rs");
      if (rs == null) {
        rs = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs", rs);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.request.wfAgentCondition wfAgentCondition;
      wfAgentCondition = (weaver.workflow.request.wfAgentCondition) pageContext.getAttribute("wfAgentCondition");
      if (wfAgentCondition == null) {
        wfAgentCondition = new weaver.workflow.request.wfAgentCondition();
        pageContext.setAttribute("wfAgentCondition", wfAgentCondition);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      
 
//\u83b7\u53d6\u9009\u4e2d\u7684\u5e74\u548c\u6708\u4efd\u6709\u591a\u5c11\u5929
StringBuffer result = new StringBuffer("{");
BaseBean bean=new BaseBean();
User user = HrmUserVarify.getUser (request , response) ;
if(user == null){
}else{
	try{
		int agentcount=0;
	   	String agentids="";
		String retustr="";
		String agetnzt="";
		//2012_53_31/12/2012_6/1/2013_2013-01-07
		int beagenterId = Util.getIntValue(request.getParameter("beagenterId"),0);
	    int agenterId = Util.getIntValue(request.getParameter("agenterId"),0);
	    String beginDate = Util.fromScreen(request.getParameter("beginDate"),user.getLanguage());
	    String beginTime = Util.fromScreen(request.getParameter("beginTime"),user.getLanguage());
	    String endDate = Util.fromScreen(request.getParameter("endDate"),user.getLanguage());
	    String endTime = Util.fromScreen(request.getParameter("endTime"),user.getLanguage());
	  
	    int usertype = Util.getIntValue(request.getParameter("usertype"), 0);
	    int isPendThing=Util.getIntValue(request.getParameter("isPendThing"),0);
	    int agentid=Util.getIntValue(request.getParameter("agentid"),0);
	    String workflowid = Util.null2String(request.getParameter("workflowid"));
	    String agentrange =Util.null2String(request.getParameter("agentrange"));
	    String rangetype =Util.null2String(request.getParameter("rangetype"));
	    //if(agentid>0){
	    //	  agetnzt=wfAgentCondition.getAgentType(""+agentid);
	   // }
	    
	 //  if(!agetnzt.equals("3")){
		   
		   
	  
	    if(beginDate.equals("")){
	    	beginDate="1900-01-01";
	    }
	    if(beginTime.equals("")){
	    	beginTime="00:00";
	    }
	    if(endDate.equals("")){
	    	endDate="2099-12-31";
	    }
	    if(endTime.equals("")){
	    	endTime="23:59";
	    }
	    
	    int isCreateAgenter = 0;
	    if(Util.getIntValue(request.getParameter("isCreateAgenter"),0) == 1){
	      isCreateAgenter = 1;
	    }
	    int isProxyDeal = 0;
	    if(Util.getIntValue(request.getParameter("isProxyDeal"),0) == 1){
	    	isProxyDeal = 1;
	    }
	 
	    boolean flag1 = false;
	    String sql="";
	    String workflowids="";
	    StringBuffer sb = new StringBuffer();
		
	    //\u5982\u679c\u6d41\u7a0bID\u4e0d\u4e3a\u7a7a\uff0c\u5219\u6d41\u7a0b\u8303\u56f4\u7c7b\u578b\u4e3a\u7a7a\u3010\u6807\u793a\u8bc6\u4ece\u7f16\u8f91\u9875\u9762\u8fc7\u6765\u3011
	    if(!workflowid.equals("")&&agentrange.equals("")&&rangetype.equals("")){
	    	//workflowids=workflowid+",";
			sb.append(workflowid+",");
	    }

	    //80\u6539\u9020\u6d41\u7a0b\u4ee3\u7406\u903b\u8f91
	    if(agentrange.equals("0"))
	    {
	    	flag1 = true;
	    	if (usertype == 0) {
				sql = "select * from workflow_base where isvalid=1 order by workflowname ";
				rs.executeSql(sql);
				while (rs.next()) {
	                //workflowids+=Util.getIntValue(rs.getString("id"))+",";
					sb.append(Util.getIntValue(rs.getString("id"))+",");
				}
			} else if (usertype == 1) {
				//\u5ba2\u6237\u7528\u6237\u53ea\u80fd\u4ee3\u7406\u201c\u5916\u90e8\u8bbf\u95ee\u8005\u652f\u6301\u201d\u7c7b\u578b\u7684\u6d41\u7a0b
				sql = "select id from workflow_base where isvalid=1 and workflowtype=29 order by workflowname";
				rs.executeSql(sql);
				while (rs.next()) {
	                //workflowids+=Util.getIntValue(rs.getString("id"))+",";
				 sb.append(Util.getIntValue(rs.getString("id"))+",");
				}
			}
	      	sql = "";
			workflowids = sb.toString();
	      	if(workflowids.length() > 0){
	      	  workflowids = workflowids.substring(0,workflowids.length() -1);
	      	}
		 }else if(agentrange.equals("1"))
		 {
		    	if(!rangetype.equals(""))
		    	{
		    		if (!rangetype.startsWith(",")) {
		    			workflowids = rangetype;
		    		}
		    	}
		    	flag1 = true;
		 }else{
			 workflowids=workflowid+",";
		 }
		  
 
	    String versionsIds =  WorkflowVersion.getAllVersionStringByWFIDs(workflowids);
	    String overlapAgent=wfAgentCondition.getIsAgent(""+agentid,""+beagenterId,"",beginDate,beginTime,endDate,endTime,versionsIds,""+isCreateAgenter,""+isProxyDeal,""+isPendThing);
		if(!overlapAgent.equals("")){
	    	String str[]=overlapAgent.split("_");
	    	agentcount=Util.getIntValue(""+str[1],0);
	    	agentids=""+str[0];;
	    }
	  // }  
	    session.setAttribute(user.getUID()+"_"+beagenterId+"_"+agenterId,agentids);
	    int _cnt=0;
	    result.append("\"data"+_cnt+"\":{");
	    result.append("\"overlapAgent\":"+JSONObject.quote(Util.null2String(agentcount))+",");
	    result.append("\"agentids\":"+JSONObject.quote(Util.null2String(agentids))+",");
		result.append("\"dbFieldEnd\":0},");
        result.append("\"done\":{\"success\":\"success\",\"info\":\"\"}");
	}catch(Exception e){
		result.append("\"done\":{\"success\":\"failed\",\"info\":\""+e.getMessage()+"\"}");
	}
	
}
result.append("}");

 //System.out.println(result.toString());

      out.print((result.toString() ));
      out.write(_jsp_string1, 0, _jsp_string1.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("workflow/request/WFAgentConditeAjax.jsp"), -3827356824119539041L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string1;
  private final static char []_jsp_string0;
  static {
    _jsp_string1 = "\r\n".toCharArray();
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
  }
}
