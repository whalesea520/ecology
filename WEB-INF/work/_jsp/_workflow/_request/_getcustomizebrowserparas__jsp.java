/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._workflow._request;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import com.weaver.formmodel.util.StringHelper;
import weaver.general.Util;
import java.util.*;
import java.io.Writer;
import weaver.general.StaticObj;
import weaver.interfaces.workflow.browser.Browser;
import weaver.interfaces.workflow.browser.BrowserBean;

public class _getcustomizebrowserparas__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.conn.RecordSet rs;
      rs = (weaver.conn.RecordSet) pageContext.getAttribute("rs");
      if (rs == null) {
        rs = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs", rs);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      
response.setContentType("text/xml;charset=UTF-8");
request.setCharacterEncoding("utf-8");
String formid=Util.getIntValue(request.getParameter("formid"),0)+"";
String isbill=Util.getIntValue(request.getParameter("isbill"),-1)+"";
String workflowid = Util.getIntValue(request.getParameter("workflowid"),-1)+"";
String browserType = Util.null2String(request.getParameter("browserType"));
String currenttime = Util.null2String(request.getParameter("currenttime"));
String frombrowserid = Util.null2String(request.getParameter("frombrowserid"));//\u00e8\u00a7\u00a6\u00e5\u008f\u0091\u00e5\u00ad\u0097\u00e6\u00ae\u00b5id
String iscustom = Util.null2String(request.getParameter("iscustom"));

//browserType = java.net.URLDecoder.decode(browserType);
String sql = "";
if("-1".equals(workflowid)) { // \u00e4\u00bb\u008e\u00e8\u00a1\u00a8\u00e5\u008d\u0095\u00e5\u00bb\u00ba\u00e6\u00a8\u00a1\u00e8\u00bf\u009b\u00e6\u009d\u00a5isbill\u00e8\u00ae\u00be\u00e4\u00b8\u00ba1
	isbill = "1";
}

boolean ismainfiled = true;//\u00e6\u0098\u00af\u00e4\u00b8\u00bb\u00e5\u00ad\u0097\u00e6\u00ae\u00b5
String detailrow = "";//\u00e5\u00a6\u0082\u00e6\u009e\u009c\u00e6\u0098\u00af\u00e6\u0098\u008e\u00e5\u00ad\u0097\u00e6\u00ae\u00b5\u00ef\u00bc\u008c\u00e4\u00bb\u00a3\u00e8\u00a1\u00a8\u00e8\u00a1\u008c\u00e5\u008f\u00b7
String fromdetailtable = "";//\u00e5\u00a6\u0082\u00e6\u009e\u009c\u00e6\u0098\u00af\u00e6\u0098\u008e\u00e5\u00ad\u0097\u00e6\u00ae\u00b5\u00ef\u00bc\u008c\u00e4\u00bb\u00a3\u00e8\u00a1\u00a8\u00e6\u0098\u008e\u00e7\u00bb\u0086\u00e8\u00a1\u00a8
String fromfieldid = "";//\u00e8\u00a7\u00a6\u00e5\u008f\u0091\u00e5\u00ad\u0097\u00e6\u00ae\u00b5id
String strs[] = frombrowserid.split("_");
if(strs.length==2){
	fromfieldid = strs[0];
	detailrow = strs[1];
	ismainfiled = false;
}else{
	fromfieldid = strs[0];
}
fromfieldid = fromfieldid.toLowerCase();
if(fromfieldid.indexOf("field")>=0){
	fromfieldid = fromfieldid.replace("field","");
}
if(browserType.indexOf("browser.")==-1)
{
	browserType = "browser."+browserType;
}

ArrayList allFieldList = new ArrayList();//\u00e4\u00b8\u00bb\u00e5\u00ad\u0097\u00e6\u00ae\u00b5
HashMap allField = new HashMap();//\u00e4\u00b8\u00bb\u00e5\u00ad\u0097\u00e6\u00ae\u00b5
ArrayList needChangeField = new ArrayList();//\u00e9\u009c\u0080\u00e8\u00a6\u0081\u00e8\u00bd\u00ac\u00e6\u008d\u00a2\u00e7\u009a\u0084\u00e5\u00ad\u0097\u00e6\u00ae\u00b5
String needChangeFieldString = "";
if(isbill.equals("1")){//\u00e5\u008d\u0095\u00e6\u008d\u00ae
	sql = "select id,fieldname,detailtable from workflow_billfield where billid = "+formid;
	rs.executeSql(sql);
	while(rs.next()){
		String id = "field"+Util.null2String(rs.getString("id"));
		String fieldname = Util.null2String(rs.getString("fieldname")).toLowerCase();
		String detailtable = Util.null2String(rs.getString("detailtable")).toLowerCase();
		if(!detailtable.equals("")){
			detailtable = detailtable + "_";
		}
		if(id.equals("field"+fromfieldid)){
			fromdetailtable = detailtable;
		}
		fieldname = "$"+detailtable+fieldname+"$";
		allField.put(fieldname.toLowerCase(),id);
		allFieldList.add(fieldname);
	}
}else{//\u00e8\u00a1\u00a8\u00e5\u008d\u0095
	//\u00e4\u00b8\u00bb\u00e5\u00ad\u0097\u00e6\u00ae\u00b5
	sql = "select b.id,b.fieldname from workflow_formfield a,workflow_formdict b where a.fieldid = b.id and formid = " + formid;
	rs.executeSql(sql);
	while(rs.next()){
		String id = "field"+Util.null2String(rs.getString("id"));
		String fieldname = "$"+Util.null2String(rs.getString("fieldname"))+"$";
		//System.out.println(id+"	"+fieldname);
		allField.put(fieldname.toLowerCase(),id);
		allFieldList.add(fieldname);
	}
	//\u00e6\u0098\u008e\u00e7\u00bb\u0086\u00e5\u00ad\u0097\u00e6\u00ae\u00b5
	sql = "select b.id,b.fieldname from workflow_formfield a,workflow_formdictdetail b where a.fieldid = b.id and formid = " + formid;
	rs.executeSql(sql);
	while(rs.next()){
		String id = "field"+Util.null2String(rs.getString("id"));
		String fieldname = "$detail_"+Util.null2String(rs.getString("fieldname"))+"$";
		if(id.equals("field"+fromfieldid)){
			fromdetailtable = "detail_";
		}
		//System.out.println(id+"	"+fieldname);
		allField.put(fieldname.toLowerCase(),id);
		allFieldList.add(fieldname);
	}
}
Browser browser=null;
String Search = "";//
String SearchByName = "";//
String from = "";
Map paramvalues = null;
try
{
	browser=(Browser)StaticObj.getServiceByFullname(browserType, Browser.class);
	Search = browser.getSearch().toLowerCase();//
	SearchByName = browser.getSearchByName().toLowerCase();//
	from = Util.null2String(browser.getFrom());
	paramvalues = browser.getParamvalues();
}
catch(Exception e)
{
	e.printStackTrace();
}
//if(from.equals("2")&&null!=browser){
	browser.initBaseBrowser("",browserType,from);
//}
for(int i=0;i<allFieldList.size();i++){
	String fieldname = Util.null2String((String)allFieldList.get(i));
	if(from.equals("2")&&null!=browser){
		Map map = (Map)browser.getWokflowfieldnameMap();
		//System.out.println("map : "+map.size());
		if(null!=map&&map.size()>0)
		{
			Set keyset = map.keySet(); 
			for(Iterator it = keyset.iterator();it.hasNext();)
			{
				String searchfieldname = Util.null2String((String)it.next());
				String workflowname = Util.null2String((String)map.get(searchfieldname));
				String fieldid = Util.null2String((String)allField.get(workflowname.toLowerCase()));
				//System.out.println("searchfieldname : "+searchfieldname+" workflowname : "+workflowname+" fieldid : "+fieldid);
				if(!"".equals(fieldid)&&fieldname.equalsIgnoreCase(workflowname))
				{
					int isdetailfield = fieldname.indexOf(fromdetailtable);
					if(isdetailfield>=0&&!fromdetailtable.equals("")){
						fieldid = fieldid+"_"+detailrow;
					}
					needChangeFieldString += searchfieldname+"="+fieldid + ",";
				}
			}
		}
		if(null!=paramvalues&&paramvalues.size()>0)
		{
			Set keyset = paramvalues.keySet(); 
			for(Iterator it = keyset.iterator();it.hasNext();)
			{
				String searchfieldname = Util.null2String((String)it.next());
				String workflowname = Util.null2String((String)paramvalues.get(searchfieldname));
				String fieldid = Util.null2String((String)allField.get(workflowname.toLowerCase()));
				if(!"".equals(fieldid)&&fieldname.equalsIgnoreCase(workflowname))
				{
					int isdetailfield = fieldname.indexOf(fromdetailtable);
					if(isdetailfield>=0&&!fromdetailtable.equals("")){
						fieldid = fieldid+"_"+detailrow;
					}
					needChangeFieldString += searchfieldname+"="+fieldid + ",";
				}
			}
		}
	}
	if(from.equals("1")||from.equals("")||Search.indexOf("$")>-1)
	{
		int searchIndex = Search.indexOf(fieldname);
		int searchByNameIndex = SearchByName.indexOf(fieldname);
		//System.out.println(fieldname+"	"+searchIndex+"	"+searchByNameIndex);
		if(searchIndex>=0||searchByNameIndex>=0){
			String fieldid = Util.null2String((String)allField.get(fieldname));
			int isdetailfield = fieldname.indexOf(fromdetailtable);
			if(isdetailfield>=0&&!fromdetailtable.equals("")){
				if(!"1".equals(iscustom)){
					fieldid = fieldid+"_"+detailrow;
				}
			}
			needChangeFieldString += fieldid + ",";
		}
	}
}
//System.out.println("needChangeFieldString : "+needChangeFieldString);
session.setAttribute("needChangeFieldString_"+workflowid+"_"+currenttime,needChangeFieldString);
session.setAttribute("allField_"+workflowid+"_"+currenttime,allField);
session.setAttribute("allFieldList_"+workflowid+"_"+currenttime,allFieldList);

      out.write(_jsp_string2, 0, _jsp_string2.length);
      out.print((needChangeFieldString));
      out.write(_jsp_string3, 0, _jsp_string3.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("workflow/request/GetCustomizeBrowserParas.jsp"), -713162870734000160L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string2;
  private final static char []_jsp_string3;
  private final static char []_jsp_string0;
  private final static char []_jsp_string1;
  static {
    _jsp_string2 = "\r\n<value>\r\n".toCharArray();
    _jsp_string3 = "\r\n</value>".toCharArray();
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
  }
}
