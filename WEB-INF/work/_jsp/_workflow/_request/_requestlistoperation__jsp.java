/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._workflow._request;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.fna.general.FnaCommon;
import weaver.mobile.webservices.workflow.bill.BatchSubmitAction;
import weaver.general.Util;
import java.net.*;
import weaver.workflow.field.FieldComInfo;
import java.util.*;
import weaver.WorkPlan.WorkPlanLogMan;
import java.text.DecimalFormat;
import weaver.general.*;
import weaver.workflow.request.RequestManager;
import weaver.hrm.HrmUserVarify;
import weaver.hrm.User;
import weaver.systeminfo.SystemEnv;
import weaver.general.GCONST;
import weaver.hrm.attendance.domain.*;
import weaver.workflow.request.RequestOperationLogManager;
import weaver.workflow.request.RequestOperationLogManager.RequestOperateEntityTableNameEnum;

public class _requestlistoperation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.workflow.request.RequestManager RequestManager;
      RequestManager = (weaver.workflow.request.RequestManager) pageContext.getAttribute("RequestManager");
      if (RequestManager == null) {
        RequestManager = new weaver.workflow.request.RequestManager();
        pageContext.setAttribute("RequestManager", RequestManager);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet RecordSet;
      RecordSet = (weaver.conn.RecordSet) pageContext.getAttribute("RecordSet");
      if (RecordSet == null) {
        RecordSet = new weaver.conn.RecordSet();
        pageContext.setAttribute("RecordSet", RecordSet);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet RecordSet1;
      RecordSet1 = (weaver.conn.RecordSet) pageContext.getAttribute("RecordSet1");
      if (RecordSet1 == null) {
        RecordSet1 = new weaver.conn.RecordSet();
        pageContext.setAttribute("RecordSet1", RecordSet1);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet rs;
      rs = (weaver.conn.RecordSet) pageContext.getAttribute("rs");
      if (rs == null) {
        rs = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs", rs);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet rs1;
      rs1 = (weaver.conn.RecordSet) pageContext.getAttribute("rs1");
      if (rs1 == null) {
        rs1 = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs1", rs1);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet rs2;
      rs2 = (weaver.conn.RecordSet) pageContext.getAttribute("rs2");
      if (rs2 == null) {
        rs2 = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs2", rs2);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet rs_1;
      rs_1 = (weaver.conn.RecordSet) pageContext.getAttribute("rs_1");
      if (rs_1 == null) {
        rs_1 = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs_1", rs_1);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.resource.ResourceComInfo ResourceComInfo;
      ResourceComInfo = (weaver.hrm.resource.ResourceComInfo) pageContext.getAttribute("ResourceComInfo");
      if (ResourceComInfo == null) {
        ResourceComInfo = new weaver.hrm.resource.ResourceComInfo();
        pageContext.setAttribute("ResourceComInfo", ResourceComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.crm.Maint.CustomerInfoComInfo CustomerInfoComInfo;
      CustomerInfoComInfo = (weaver.crm.Maint.CustomerInfoComInfo) pageContext.getAttribute("CustomerInfoComInfo");
      if (CustomerInfoComInfo == null) {
        CustomerInfoComInfo = new weaver.crm.Maint.CustomerInfoComInfo();
        pageContext.setAttribute("CustomerInfoComInfo", CustomerInfoComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.msg.PoppupRemindInfoUtil PoppupRemindInfoUtil;
      PoppupRemindInfoUtil = (weaver.workflow.msg.PoppupRemindInfoUtil) pageContext.getAttribute("PoppupRemindInfoUtil");
      if (PoppupRemindInfoUtil == null) {
        PoppupRemindInfoUtil = new weaver.workflow.msg.PoppupRemindInfoUtil();
        pageContext.setAttribute("PoppupRemindInfoUtil", PoppupRemindInfoUtil);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.docs.docs.DocManager DocManager;
      DocManager = (weaver.docs.docs.DocManager) pageContext.getAttribute("DocManager");
      if (DocManager == null) {
        DocManager = new weaver.docs.docs.DocManager();
        pageContext.setAttribute("DocManager", DocManager);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.WorkPlan.WorkPlanViewer WorkPlanViewer;
      WorkPlanViewer = (weaver.WorkPlan.WorkPlanViewer) pageContext.getAttribute("WorkPlanViewer");
      if (WorkPlanViewer == null) {
        WorkPlanViewer = new weaver.WorkPlan.WorkPlanViewer();
        pageContext.setAttribute("WorkPlanViewer", WorkPlanViewer);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.request.WFLinkInfo WFLinkInfo;
      WFLinkInfo = (weaver.workflow.request.WFLinkInfo) pageContext.getAttribute("WFLinkInfo");
      if (WFLinkInfo == null) {
        WFLinkInfo = new weaver.workflow.request.WFLinkInfo();
        pageContext.setAttribute("WFLinkInfo", WFLinkInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.report.schedulediff.HrmScheduleDiffUtil HrmScheduleDiffUtil;
      HrmScheduleDiffUtil = (weaver.hrm.report.schedulediff.HrmScheduleDiffUtil) pageContext.getAttribute("HrmScheduleDiffUtil");
      if (HrmScheduleDiffUtil == null) {
        HrmScheduleDiffUtil = new weaver.hrm.report.schedulediff.HrmScheduleDiffUtil();
        pageContext.setAttribute("HrmScheduleDiffUtil", HrmScheduleDiffUtil);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.schedule.HrmAnnualManagement HrmAnnualManagement;
      HrmAnnualManagement = (weaver.hrm.schedule.HrmAnnualManagement) pageContext.getAttribute("HrmAnnualManagement");
      if (HrmAnnualManagement == null) {
        HrmAnnualManagement = new weaver.hrm.schedule.HrmAnnualManagement();
        pageContext.setAttribute("HrmAnnualManagement", HrmAnnualManagement);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.schedule.HrmPaidSickManagement HrmPaidSickManagement;
      HrmPaidSickManagement = (weaver.hrm.schedule.HrmPaidSickManagement) pageContext.getAttribute("HrmPaidSickManagement");
      if (HrmPaidSickManagement == null) {
        HrmPaidSickManagement = new weaver.hrm.schedule.HrmPaidSickManagement();
        pageContext.setAttribute("HrmPaidSickManagement", HrmPaidSickManagement);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.attendance.manager.HrmPaidLeaveManager HrmPaidLeaveManager;
      HrmPaidLeaveManager = (weaver.hrm.attendance.manager.HrmPaidLeaveManager) pageContext.getAttribute("HrmPaidLeaveManager");
      if (HrmPaidLeaveManager == null) {
        HrmPaidLeaveManager = new weaver.hrm.attendance.manager.HrmPaidLeaveManager();
        pageContext.setAttribute("HrmPaidLeaveManager", HrmPaidLeaveManager);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.request.RequestLog Requestlog;
      Requestlog = (weaver.workflow.request.RequestLog) pageContext.getAttribute("Requestlog");
      if (Requestlog == null) {
        Requestlog = new weaver.workflow.request.RequestLog();
        pageContext.setAttribute("Requestlog", Requestlog);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.general.BaseBean basebean;
      basebean = (weaver.general.BaseBean) pageContext.getAttribute("basebean");
      if (basebean == null) {
        basebean = new weaver.general.BaseBean();
        pageContext.setAttribute("basebean", basebean);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.fna.maintenance.FnaBudgetControl fnaBudgetControl;
      fnaBudgetControl = (weaver.fna.maintenance.FnaBudgetControl) pageContext.getAttribute("fnaBudgetControl");
      if (fnaBudgetControl == null) {
        fnaBudgetControl = new weaver.fna.maintenance.FnaBudgetControl();
        pageContext.setAttribute("fnaBudgetControl", fnaBudgetControl);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      

/*\u7528\u6237\u9a8c\u8bc1*/
User user = HrmUserVarify.getUser (request , response) ;
if(user==null) {
    response.sendRedirect("/login/Login.jsp");
    return;
}
// \u64cd\u4f5c\u7684\u7528\u6237\u4fe1\u606f

int userid=user.getUID();                   //\u5f53\u524d\u7528\u6237id
int usertype = 0;                           //\u7528\u6237\u5728\u5de5\u4f5c\u6d41\u8868\u4e2d\u7684\u7c7b\u578b 0: \u5185\u90e8 1: \u5916\u90e8
String logintype = user.getLogintype();     //\u5f53\u524d\u7528\u6237\u7c7b\u578b  1: \u7c7b\u522b\u7528\u6237  2:\u5916\u90e8\u7528\u6237
String username = "";

if(logintype.equals("1"))
	username = Util.toScreen(ResourceComInfo.getResourcename(""+userid),user.getLanguage()) ;
if(logintype.equals("2"))
	username = Util.toScreen(CustomerInfoComInfo.getCustomerInfoname(""+userid),user.getLanguage());

String dateSql = "";
if(rs.getDBType().equalsIgnoreCase("oracle")){
	dateSql = "select to_char(sysdate,'yyyy-mm-dd') as currentdate, to_char(sysdate,'hh24:mi:ss') as currenttime from dual";
}else{
	dateSql = "select convert(char(10),getdate(),20) as currentdate, convert(char(8),getdate(),108) as currenttime";
}
String currentdate = "";
String currenttime = "";
rs.execute(dateSql);
if(rs.next()){
	currentdate = Util.null2String(rs.getString(1));
	currenttime = Util.null2String(rs.getString(2));
}else{
	Calendar today = Calendar.getInstance();
	currentdate = Util.add0(today.get(Calendar.YEAR), 4) + "-" +
			Util.add0(today.get(Calendar.MONTH) + 1, 2) + "-" +
			Util.add0(today.get(Calendar.DAY_OF_MONTH), 2) ;

	currenttime = Util.add0(today.get(Calendar.HOUR_OF_DAY), 2) + ":" +
			Util.add0(today.get(Calendar.MINUTE), 2) + ":" +
			Util.add0(today.get(Calendar.SECOND), 2) ;
}

String src = "submit";
String iscreate = "0";
int isremark = 0;
//\u6dfb\u52a0\u652f\u6301\u6279\u6ce8\u5185\u5bb9\u4ece\u524d\u53f0\u4f20\u9012

String remark = Util.null2String(request.getParameter("remark"));
remark = remark.replaceAll("\\r\\n", "<br>");
remark = remark.replaceAll("\\r", "<br>");
remark = remark.replaceAll("\\n", "<br>");

if(remark.equals("")) {
	remark = Util.null2String(request.getAttribute("remark"));
}

if(remark.equals("")) remark = "\n"+username+" "+currentdate+" "+currenttime;
String workflowtype = "";
int formid = -1;
int isbill = -1;
int billid = -1;
String messageType = "";
int nodeid = -1;
String nodetype = "";
String requestname = "";
String requestlevel = "";

//modify by xhheng @20050524 for TD 2023
String requestidlist=Util.null2String(request.getParameter("multiSubIds"));
String wfid = Util.null2String(request.getParameter("workflowid"));
String wftypes = "";

String method = Util.null2String(request.getParameter("method"));
String wftype=Util.null2String(request.getParameter("wftype"));
int flowAll=Util.getIntValue(Util.null2String(request.getParameter("flowAll")), 0);
int flowNew=Util.getIntValue(Util.null2String(request.getParameter("flowNew")), 0);
String viewcondition = Util.null2String(request.getParameter("viewcondition"));
String [] requestids=Util.TokenizerString2(requestidlist,",");


//\u5bf9\u5e94\u4e00\u4eba\u591a\u5c97\u6279\u91cf\u63d0\u4ea4\u65e0\u6cd5\u63d0\u4ea4\u6b21\u8d26\u53f7\u6d41\u7a0b\u7684\u95ee\u9898
String belongtoUseridList = request.getParameter("belongtoUserids");
String [] belongtoUserids=Util.TokenizerString2(belongtoUseridList,",");

for (int i=0; i<requestids.length; i++){
    String f_weaver_belongto_userid = "";
    if(i < belongtoUserids.length){
        f_weaver_belongto_userid = belongtoUserids[i];
    }

    //\u5982\u679c\u4f7f\u7528\u6b21\u8d26\u53f7\uff0c\u5219\u4f7f\u7528\u6b21\u8d26\u53f7\u767b\u5f55
    if(f_weaver_belongto_userid != null && f_weaver_belongto_userid != "" && !f_weaver_belongto_userid.equals(user.getUID())){
        user = HrmUserVarify.getUser (request , response,f_weaver_belongto_userid,"0") ;
        userid = user.getUID();
    }else{
        user = HrmUserVarify.getUser (request , response) ;
        userid = user.getUID();
    }
    //\u7528\u6237\u9a8c\u8bc1
    if(user==null) {
        response.sendRedirect("/login/Login.jsp");
        return;
    }
    
    RequestManager = new RequestManager();
    int requestid = Util.getIntValue(requestids[i],-1) ;
    
     /*----------xwj for td3098 20051202 begin -----*/
    src = "submit";
    isremark = 0;
    RecordSet.executeSql("select min(isremark) from workflow_currentoperator where requestid = " + requestid + " and userid = "+user.getUID());
    if(RecordSet.next()){
    int isremarkCheck = RecordSet.getInt(1);
    if(isremarkCheck==1){
    src = "save";
    isremark = 1;
    }
    }
    
    RecordSet.executeSql("select isremark,isreminded,preisremark,id,groupdetailid,nodeid,(CASE WHEN isremark=9 THEN '7.5' ELSE isremark END) orderisremark from workflow_currentoperator where requestid="+requestid+" and userid="+userid+" and usertype="+usertype+" order by orderisremark,id ");
    boolean istoManagePage=false;   //add by xhheng @20041217 for TD 1438
    while(RecordSet.next())	{
        String t_isremark = Util.null2String(RecordSet.getString("isremark")) ;
        int tmpnodeid=Util.getIntValue(RecordSet.getString("nodeid"));
        //modify by mackjoe at 2005-09-29 td1772 \u8f6c\u53d1\u7279\u6b8a\u5904\u7406\uff0c\u8f6c\u53d1\u4fe1\u606f\u672c\u4eba\u672a\u5904\u7406\u4e00\u76f4\u9700\u8981\u5904\u7406\u5373\u4f7f\u6d41\u7a0b\u5df2\u5f52\u6863
        if( t_isremark.equals("1")||t_isremark.equals("5") || t_isremark.equals("7")|| t_isremark.equals("9") ||(t_isremark.equals("0")  && !nodetype.equals("3")) ) {
          //modify by xhheng @20041217 for TD 1438
          if (t_isremark.equals("9")) {
              isremark = 9;
          }
          break;
        }
    }

    
    //\u5224\u65ad\u5f53\u524d\u6d41\u7a0b\u662f\u5426\u8fd8\u4e3a\u5f53\u524d\u64cd\u4f5c\u8005\u7684\u5f85\u529e\u4e8b\u5b9c
    //\u5224\u65ad\u5f53\u524d\u6d41\u7a0b\u662f\u5426\u8fd8\u4e3a\u5f53\u524d\u64cd\u4f5c\u8005\u7684\u5f85\u529e\u4e8b\u5b9c
    if(RecordSet.getDBType().equals("sqlserver")){
	    RecordSet.executeSql("select t1.requestid from workflow_requestbase t1, workflow_currentoperator t2 " +
		"where t1.requestid = t2.requestid and t2.userid = "+user.getUID()+" and t2.usertype = 0 and (isnull(t1.currentstatus, -1) = -1 or (isnull(t1.currentstatus, -1) = 0 and t1.creater = "+user.getUID()+")) "+
		"and t2.isremark in ('0', '1', '5', '8', '9', '7') and t2.islasttimes = 1 and t1.requestid = " + requestid);
	    if(!RecordSet.next()){
	    	continue;
	    }
    }else{
	    RecordSet.executeSql("select t1.requestid from workflow_requestbase t1, workflow_currentoperator t2 " +
   		"where t1.requestid = t2.requestid and t2.userid = "+user.getUID()+" and t2.usertype = 0 and (nvl(t1.currentstatus, -1) = -1 or (nvl(t1.currentstatus, -1) = 0 and t1.creater = "+user.getUID()+")) "+
   		"and t2.isremark in ('0', '1', '5', '8', '9', '7') and t2.islasttimes = 1 and t1.requestid = " + requestid);
   	    if(!RecordSet.next()){
   	    	continue;
   	    }
    }
    //System.out.println("2:\u6d41\u7a0b" + i + "\u65f6\u95f4:" + (new Date().getTime() - d1.getTime()));
    /*----------xwj for td3098 20051202 end -----*/
    
    int workflowid=-1;

    if(requestid!=-1 ){
    boolean isStart = false;
    int currentnodeid = 0 ;
    RecordSet.executeSql("select currentnodeid,currentnodetype,requestname,requestlevel,workflowid,status from workflow_requestbase where requestid="+requestid);
    if(RecordSet.next()){
      requestname = RecordSet.getString("requestname");
      requestlevel = RecordSet.getString("requestlevel");
      workflowid = RecordSet.getInt("workflowid");
      currentnodeid = RecordSet.getInt("currentnodeid");
      isStart = (RecordSet.getString("status")!=null && !"".equals(RecordSet.getString("status")));
    }
    //System.out.println("3:\u6d41\u7a0b" + i + "\u65f6\u95f4:" + (new Date().getTime() - d1.getTime()));
    nodeid=WFLinkInfo.getCurrentNodeid(requestid,userid,Util.getIntValue(logintype,1));               //\u8282\u70b9id
    nodetype=WFLinkInfo.getNodeType(nodeid);         //\u8282\u70b9\u7c7b\u578b  0:\u521b\u5efa 1:\u5ba1\u6279 2:\u5b9e\u73b0 3:\u5f52\u6863    
    boolean isTrack = true;
    RecordSet.executeSql("select workflowtype,formid,isbill,messageType,isModifyLog from workflow_base where id="+workflowid);
    if(RecordSet.next()){
      workflowtype = RecordSet.getString("workflowtype");
      formid = RecordSet.getInt("formid");
      isbill = RecordSet.getInt("isbill");
      //billid = RecordSet.getInt("formid");
      messageType = RecordSet.getString("messageType");
      isTrack = (RecordSet.getString("ismodifylog")!=null && "1".equals(RecordSet.getString("ismodifylog")));
    }
    //System.out.println("4:\u6d41\u7a0b" + i + "\u65f6\u95f4:" + (new Date().getTime() - d1.getTime()));
	if(isbill == 1){
		RecordSet.execute("select tablename from workflow_bill where id="+formid);
		if(RecordSet.next()){
			String tablename = Util.null2String(RecordSet.getString(1));
			if(!"".equals(tablename)){
				RecordSet.execute("select id from "+tablename+" where requestid="+requestid);
				if(RecordSet.next()){
					billid = RecordSet.getInt("id");
				}
			}else{
				continue;
			}
		}
	}
	//System.out.println("5:\u6d41\u7a0b" + i + "\u65f6\u95f4:" + (new Date().getTime() - d1.getTime()));
    if( src.equals("") || workflowid == -1 || formid == -1 || isbill == -1 || nodeid == -1 || nodetype.equals("") ) {
        response.sendRedirect("/notice/RequestError.jsp");
        return ;
    }

    if (isremark == 9) {
        
        RequestOperationLogManager rolm = new RequestOperationLogManager(requestid);
        int optLogid = -1;
        //\u5f3a\u5236\u6536\u56de
        int wfcuroptid = -1;
        RecordSet.executeSql("select id from workflow_currentoperator where requestid=" + requestid + " and userid=" + userid + " and usertype=" + usertype + " and isremark=9");
        if (RecordSet.next()) {
            wfcuroptid = Util.getIntValue(RecordSet.getString(1));
            optLogid = rolm.getOptLogID(RequestOperationLogManager.RequestOperateEntityTableNameEnum.CURRENTOPERATOR.getId(), wfcuroptid, 0);
        }
        
        char flag = Util.getSeparator();
       	RecordSet.executeProc("workflow_CurOpe_UbySendNB", "" + requestid + flag + userid + flag + usertype+flag+isremark);
       	
        String isfeedback="";
        String isnullnotfeedback="";    
        RecordSet.executeSql("select isfeedback,isnullnotfeedback from workflow_flownode where workflowid="+workflowid+" and nodeid="+nodeid);
        if(RecordSet.next()){
        	isfeedback=Util.null2String(RecordSet.getString("isfeedback"));
            isnullnotfeedback=Util.null2String(RecordSet.getString("isnullnotfeedback"));
        }
        
        String ifchangstatus=Util.null2String(basebean.getPropValue(GCONST.getConfigFile() , "ecology.changestatus"));
        if (!ifchangstatus.equals("")&&isfeedback.equals("1")&&((isnullnotfeedback.equals("1")&&!Util.replace(remark, "\\<script\\>initFlashVideo\\(\\)\\;\\<\\/script\\>", "", 0, false).equals(""))||!isnullnotfeedback.equals("1"))){
            RecordSet.executeSql("update workflow_currentoperator set viewtype =-1  where needwfback='1' and requestid=" + requestid + " and userid<>" + userid + " and viewtype=-2");

        }
        String curnodetype = "";
        RecordSet.executeSql("select currentnodetype from workflow_Requestbase where requestid="+requestid);
        if(RecordSet.next()) curnodetype = Util.null2String(RecordSet.getString(1));
        if(curnodetype.equals("3"))//\u5f52\u6863\u6d41\u7a0b\u8f6c\u53d1\u540e\uff0c\u8f6c\u53d1\u4eba\u6216\u6284\u9001\u4eba\u63d0\u4ea4\u540e\u5230\u529e\u7ed3\u4e8b\u5b9c\u3002

        	RecordSet.executeSql("update workflow_currentoperator set iscomplete=1 where userid="+userid+" and usertype="+usertype+" and requestid="+requestid);        

        //Requestlog.setRequest(fu) ;
        Requestlog.saveLog(workflowid,requestid,nodeid,"9",remark,user) ;
        
        //\u6284\u9001\u9700\u8981\u63d0\u4ea4  \u65f6\uff0c \u6dfb\u52a0 \u5f3a\u5236\u6536\u56de\u652f\u6301
        RecordSet.executeSql("select logid from workflow_requestlog where requestid = " + requestid + " and nodeid = " + nodeid + " and operator=" + user.getUID() + " and operatortype=" + usertype + " and logtype = '9' order by operatedate, operatetime");
        if (RecordSet.next()) {
            int newlogid = RecordSet.getInt(1);
            if (newlogid > 0) {
                //\u5411\u4e4b\u524d\u7684\u65e5\u5fd7\u4e2d\u6dfb\u52a0\u672c\u6761\u63d0\u4ea4\u7684\u8bb0\u5f55\uff0c \u65b9\u4fbf\u5728\u5f3a\u5236\u6536\u56de\u7684\u65f6\u5019\u80fd\u591f\u6536\u56de
                rolm.addDetailLog(optLogid, RequestOperationLogManager.RequestOperateEntityTableNameEnum.REQUESTLOG.getId(), newlogid, 0, "", "", "");
            }
        }
        
        continue;
    }
    
	int requestKey = 0;
    RecordSet.executeSql("select id from workflow_currentoperator where requestid="+requestid+" and nodeid='"+nodeid+"' and userid="+userid+" and usertype="+usertype+" order by isremark,id");
    if(RecordSet.next()){
    	requestKey = RecordSet.getInt("id");
    }
    
    int lastnodeid = 0; // \u4e0a\u4e00\u6b21\u9000\u56de\u64cd\u4f5c\u7684\u8282\u70b9id
    if(isremark == 0) {
	    String sql_isreject = " select a.nodeid lastnodeid, a.logtype from workflow_requestlog a, workflow_nownode b where a.requestid = b.requestid and a.destnodeid = b.nownodeid "
	    	+ " and b.requestid=" + requestid + " and a.destnodeid=" + nodeid + " and a.nodeid != " + nodeid + " order by a.logid desc";
	    RecordSet.executeSql(sql_isreject);
	    while(RecordSet.next()) {
	    	String logtype = Util.null2String(RecordSet.getString("logtype"));
	    	if("3".equals(logtype)) {
	    		lastnodeid = Util.getIntValue(Util.null2String(RecordSet.getString("lastnodeid")), 0);
	    		break;
	    	}
	    	if("0".equals(logtype) || "2".equals(logtype) || "e".equals(logtype) || "i".equals(logtype) || "j".equals(logtype)){
	    		break;
	    	}
	    }
	    if(lastnodeid != 0&&!new weaver.workflow.request.WFLinkInfo().isCanSubmitToRejectNode(requestid,currentnodeid,lastnodeid)){
	    	lastnodeid = 0 ;
	    }
	    if(lastnodeid != 0) {
	    	String isSubmitDirectNode = ""; // \u4e0a\u4e00\u6b21\u9000\u56de\u64cd\u4f5c\u7684\u8282\u70b9\u662f\u5426\u542f\u7528\u9000\u56de\u540e\u518d\u63d0\u4ea4\u76f4\u8fbe\u672c\u8282\u70b9
	    	RecordSet.executeSql("select * from workflow_flownode where workflowid=" + workflowid + " and nodeid=" + lastnodeid);
	    	if(RecordSet.next()) {
	    		isSubmitDirectNode = Util.null2String(RecordSet.getString("isSubmitDirectNode"));
	    	}
	    	if(!"1".equals(isSubmitDirectNode)) { // \u5982\u679c\u4e0d\u542f\u7528
	    		lastnodeid = 0;
			}
	    }
    }
    
    //System.out.println("6:\u6d41\u7a0b" + i + "\u65f6\u95f4:" + (new Date().getTime() - d1.getTime()));
    RequestManager.setSrc(src) ;
    RequestManager.setIscreate(iscreate) ;
    RequestManager.setRequestid(requestid) ;
    RequestManager.setWorkflowid(workflowid) ;
    RequestManager.setWorkflowtype(workflowtype) ;
    RequestManager.setIsremark(isremark) ;
    RequestManager.setFormid(formid) ;
    RequestManager.setIsbill(isbill) ;
    RequestManager.setBillid(billid) ;
    RequestManager.setNodeid(nodeid) ;
    RequestManager.setNodetype(nodetype) ;
    RequestManager.setRequestname(requestname) ;
    RequestManager.setRequestlevel(requestlevel) ;
    RequestManager.setRemark(remark) ;
    RequestManager.setRequest(request) ;
    RequestManager.setMessageType(messageType) ;
    RequestManager.setUser(user) ;
	RequestManager.setRequestKey(requestKey);
	RequestManager.setSubmitToNodeid(lastnodeid);
    
    /**Start \u6279\u91cf\u63d0\u4ea4\u65f6\u4e5f\u5fc5\u987b\u505a\u8282\u70b9\u9644\u52a0\u64cd\u4f5c by alan on 2009-04-23**/
    if(!src.equals("save")){
		try {
			 //\u7531\u4e8eobjtype\u4e3a"1: \u8282\u70b9\u81ea\u52a8\u8d4b\u503c",\u4e0d\u4e3a"0 :\u51fa\u53e3\u81ea\u52a8\u8d4b\u503c"\uff0c\u4e0d\u7528\u6539\u53d8\u9664\u72b6\u6001\u5916\u7684\u6587\u6863\u76f8\u5173\u4fe1\u606f\uff0c\u6545\u53ef\u4e0d\u7528\u7ed9user\u3001clienIp\u3001src\u8d4b\u503c  fanggsh TD5121			
			weaver.workflow.request.RequestCheckAddinRules requestCheckAddinRules = new weaver.workflow.request.RequestCheckAddinRules();
			requestCheckAddinRules.resetParameter();
			//add by cyril on 2008-07-28 for td:8835 \u4e8b\u52a1\u65e0\u6cd5\u5f00\u542f\u67e5\u8be2,\u53ea\u80fd\u4f20\u5165
            requestCheckAddinRules.setTrack(isTrack);
            requestCheckAddinRules.setStart(isStart);
            requestCheckAddinRules.setNodeid(nodeid);
            //end by cyril on 2008-07-28 for td:8835
			requestCheckAddinRules.setRequestid(requestid);
			requestCheckAddinRules.setWorkflowid(workflowid);
			requestCheckAddinRules.setObjid(nodeid);
			requestCheckAddinRules.setObjtype(1);               // 1: \u8282\u70b9\u81ea\u52a8\u8d4b\u503c 0 :\u51fa\u53e3\u81ea\u52a8\u8d4b\u503c

			requestCheckAddinRules.setIsbill(isbill);
			requestCheckAddinRules.setFormid(formid);
			requestCheckAddinRules.setIspreadd("0");//xwj for td3130 20051123
			requestCheckAddinRules.setRequestManager(RequestManager);
			requestCheckAddinRules.setUser(user);
			requestCheckAddinRules.checkAddinRules();
		} catch (Exception e) {
			response.sendRedirect("/notice/RequestError.jsp");
	        return ;
		}
	}
    //System.out.println("7:\u6d41\u7a0b" + i + "\u65f6\u95f4:" + (new Date().getTime() - d1.getTime()));
    /**End \u6279\u91cf\u63d0\u4ea4\u65f6\u4e5f\u5fc5\u987b\u505a\u8282\u70b9\u9644\u52a0\u64cd\u4f5c by alan on 2009-04-23**/
	//TD10974 \u5904\u7406\u6d41\u7a0b\u6279\u91cf\u63d0\u4ea4\u7684\u65f6\u5019\uff0c\u6587\u6863\u3001\u5ba2\u6237\u3001\u8d44\u4ea7\u3001\u9879\u76ee\u65e0\u6cd5\u9644\u6743\u4e0b\u4e00\u8282\u70b9\u64cd\u4f5c\u8005\u7684\u95ee\u9898 Start
	int docRightByOperator=0;
	rs.execute("select docRightByOperator from workflow_base where id="+workflowid);
	if(rs.next()){
		docRightByOperator=Util.getIntValue(rs.getString("docRightByOperator"),0);
	}
	String maintable = "workflow_form";
	if (isbill == 1) {
		rs.execute("select tablename from workflow_bill where id = " + formid);
		if(rs.next()){
			maintable = Util.null2String(rs.getString("tablename"));
		}
		rs.executeProc("workflow_billfield_Select", formid + "");
	} else {
		rs.executeSql("select t2.fieldid,t2.fieldorder,t2.isdetail,t1.fieldlable,t1.langurageid from workflow_fieldlable t1,workflow_formfield t2 where t1.formid=t2.formid and t1.fieldid=t2.fieldid and (t2.isdetail<>'1' or t2.isdetail is null)  and t2.formid="+formid+"  and t1.langurageid="+user.getLanguage()+" order by t2.fieldorder");
	}	
	//System.out.println("8:\u6d41\u7a0b" + i + "\u65f6\u95f4:" + (new Date().getTime() - d1.getTime()));
    ArrayList fieldidList = new ArrayList();
    ArrayList fieldnameList = new ArrayList();
    ArrayList fielddbtypeList = new ArrayList();
    ArrayList fieldhtmltypeList = new ArrayList();
    ArrayList fieldtypeList = new ArrayList();
    String fieldnames = "";
    String fieldid = "";
    String fieldname = "";
    String fielddbtype = "";
    String fieldhtmltype = "";
    String fieldtype = "";
    FieldComInfo fieldComInfo = new FieldComInfo();
    String hrmids = "";
    String crmids = "";
    String prjids = "";
    String docids = "";
    String cptids = "";
    boolean hasmanager=false;
    char separarorFlag = Util.getSeparator();
	while (rs.next()) {
		if (isbill == 1) {
			String viewtype = Util.null2String(rs.getString("viewtype"));   // \u5982\u679c\u662f\u5355\u636e\u7684\u4ece\u8868\u5b57\u6bb5,\u4e0d\u8fdb\u884c\u64cd\u4f5c

			if (viewtype.equals("1")) continue;
			fieldid = Util.null2String(rs.getString("id"));
			fieldname = Util.null2String(rs.getString("fieldname"));
			fielddbtype = Util.null2String(rs.getString("fielddbtype"));
			fieldhtmltype = Util.null2String(rs.getString("fieldhtmltype"));
			fieldtype = Util.null2String(rs.getString("type"));
		} else {
			fieldid = Util.null2String(rs.getString(1));
			fieldname = Util.null2String(fieldComInfo.getFieldname(fieldid));
			fielddbtype = Util.null2String(fieldComInfo.getFielddbtype(fieldid));
			fieldhtmltype = Util.null2String(fieldComInfo.getFieldhtmltype(fieldid));
			fieldtype = Util.null2String(fieldComInfo.getFieldType(fieldid));
		}
        if(fieldname.toLowerCase().equals("manager")){
            hasmanager=true;
        }
		fieldidList.add(fieldid);
		fieldnameList.add(fieldname);
		fielddbtypeList.add(fielddbtype);
		fieldhtmltypeList.add(fieldhtmltype);
		fieldtypeList.add(fieldtype);
		fieldnames = fieldnames + fieldname + ",";
	}
	//System.out.println("9:\u6d41\u7a0b" + i + "\u65f6\u95f4:" + (new Date().getTime() - d1.getTime()));
    if(hasmanager){
        String beagenter=""+userid;
        //\u83b7\u5f97\u88ab\u4ee3\u7406\u4eba
        RecordSet.executeSql("select agentorbyagentid from workflow_currentoperator where usertype=0 and isremark='0' and requestid="+requestid+" and userid="+userid+" and nodeid="+nodeid+" order by id desc");
        if(RecordSet.next()){
          int tembeagenter=RecordSet.getInt(1);
          if(tembeagenter>0) beagenter=""+tembeagenter;
        }
        String tmpmanagerid = ResourceComInfo.getManagerID(beagenter);
        rs2.executeSql("update " + maintable + " set manager="+tmpmanagerid+" where requestid=" + requestid);
    }
	if(fieldnames.length() > 0){
		fieldnames = fieldnames.substring(0, fieldnames.length()-1);
		rs2.execute("select " + fieldnames + " from " + maintable + " where requestid=" + requestid);
		if(rs2.next()){
			for(int j=0; j<fieldidList.size(); j++){
				fieldid = Util.null2String((String)fieldidList.get(j));
				fieldname = Util.null2String((String)fieldnameList.get(j));
				fielddbtype = Util.null2String((String)fielddbtypeList.get(j));
				fieldhtmltype = Util.null2String((String)fieldhtmltypeList.get(j));
				fieldtype = Util.null2String((String)fieldtypeList.get(j));
				if (fieldhtmltype.equals("3") && (fieldtype.equals("1") || fieldtype.equals("17"))) { // \u4eba\u529b\u8d44\u6e90\u5b57\u6bb5
					String tempvalueid="";
					tempvalueid = Util.null2String(rs2.getString(fieldname));
					if (!tempvalueid.equals("")) hrmids += "," + tempvalueid;
				} else if (fieldhtmltype.equals("3") && (fieldtype.equals("7") || fieldtype.equals("18"))) {   // \u5ba2\u6237\u5b57\u6bb5
					String tempvalueid ="";
					tempvalueid = Util.null2String(rs2.getString(fieldname));
					if (!tempvalueid.equals("")) crmids += "," + tempvalueid;
				} else if (fieldhtmltype.equals("3") && (fieldtype.equals("8")|| fieldtype.equals("135"))) {                             // \u9879\u76ee\u5b57\u6bb5
					String tempvalueid ="";
					tempvalueid = Util.null2String(rs2.getString(fieldname));
					if (!tempvalueid.equals("")) prjids += "," + tempvalueid;
				} else if (fieldhtmltype.equals("3") && (fieldtype.equals("9") || fieldtype.equals("37"))) {  // \u6587\u6863\u5b57\u6bb5
					String tempvalueid ="";
					tempvalueid = Util.null2String(rs2.getString(fieldname));
					if (!tempvalueid.equals("")) docids += "," + tempvalueid;
					//\u8ddf\u968f\u6587\u6863\u5173\u8054\u4eba\u8d4b\u6743

					if(docRightByOperator==1){
						//\u5728Workflow_DocSource\u8868\u4e2d\u5220\u9664\u5f53\u524d\u5b57\u6bb5\u88ab\u5220\u9664\u7684\u6587\u6863
						if (!tempvalueid.equals("")){
							rs1.execute("delete from Workflow_DocSource where requestid =" + requestid + " and fieldid =" + fieldid + " and docid not in (" + tempvalueid + ")");
						}else{
							rs1.execute("delete from Workflow_DocSource where requestid =" + requestid + " and fieldid =" + fieldid);
						}
						//\u5728Workflow_DocSource\u8868\u4e2d\u6dfb\u52a0\u5f53\u524d\u5b57\u6bb5\u65b0\u589e\u52a0\u7684\u6587\u6863
						String[] mdocid=Util.TokenizerString2(tempvalueid,",");
						for(int cx=0;cx<mdocid.length; cx++){
							if(mdocid[cx]!=null && !mdocid[cx].equals("")){
								rs1.executeProc("Workflow_DocSource_Insert",""+requestid + separarorFlag + nodeid + separarorFlag + fieldid + separarorFlag + mdocid[cx] + separarorFlag + userid + separarorFlag + "1");//\u7531\u4e8eusertype\u4e0d\u4e00\u81f4\uff0c\u8fd9\u91cc\u7684usertype\u76f4\u63a5\u6307\u5b9a\u4e3a1\uff0c\u53ea\u5904\u7406\u5185\u90e8\u7528\u6237
							}
						}
					}
				} else if (fieldhtmltype.equals("3") && fieldtype.equals("23")) {                           // \u8d44\u4ea7\u5b57\u6bb5
					String tempvalueid ="";
					tempvalueid = Util.null2String(rs2.getString(fieldname));
					if (!tempvalueid.equals("")) cptids += "," + tempvalueid;
				}
			}
			if (!hrmids.equals("")) hrmids = hrmids.substring(1);
			if (!crmids.equals("")) crmids = crmids.substring(1);
			if (!prjids.equals("")) prjids = prjids.substring(1);
			if (!docids.equals("")) docids = docids.substring(1);
			if (!cptids.equals("")) cptids = cptids.substring(1);
			RequestManager.setHrmids(hrmids);
			RequestManager.setCrmids(crmids);
			RequestManager.setPrjids(prjids);
			RequestManager.setDocids(docids);
			RequestManager.setCptids(cptids);
		}
	}
	//TD10974 End
	//System.out.println("10:\u6d41\u7a0b" + i + "\u65f6\u95f4:" + (new Date().getTime() - d1.getTime()));
  if (formid != 180){
    boolean flowstatus = RequestManager.flowNextNode() ;
    //System.out.println("11:\u6d41\u7a0b" + i + "\u65f6\u95f4:" + (new Date().getTime() - d1.getTime()));
    if (flowstatus) {
                //added by mackjoe at 2007-01-10 TD5567
                //\u589e\u52a0\u6587\u6863,\u9879\u76ee,\u5ba2\u6237\u6279\u91cf\u5ba1\u6279\u5904\u7406
                if (RequestManager.getNextNodetype().equals("3") && isbill == 1) {
                    //\u6587\u6863
                    if (formid == 28) {
                        RecordSet.executeSql("update bill_Approve set status='1' where requestid=" + requestid);
                        RecordSet.executeSql("select approveid from bill_Approve where requestid=" + requestid);
                        if(RecordSet.next()){
							String approveid=Util.null2String(RecordSet.getString("approveid"));
							int intapproveid=Util.getIntValue(approveid,0);
							RecordSet.executeSql("select max(b.id) from DocDetail a,DocDetail b where a.docEditionId=b.docEditionId and a.docEditionId>0 and a.id="+intapproveid);
							if(RecordSet.next()){
								intapproveid=Util.getIntValue(RecordSet.getString(1),intapproveid);
								if(intapproveid>0){
									approveid=""+intapproveid;
								}
							}
                            DocManager.approveDocFromWF("approve", approveid, currentdate, currenttime, userid + "");
                        }
                    }
                    //\u9879\u76ee
                    if (formid == 74) {
                        RecordSet.executeSql("select approveid from Bill_ApproveProj where requestid=" + requestid);
                        if(RecordSet.next()){
                            char flag = 2 ;
                            String approveid=RecordSet.getString("approveid");
                            RecordSet.executeProc("Prj_Plan_Approve",approveid);
                            String tmpsql="update prj_taskprocess set isactived=2 where prjid="+approveid ;
                            RecordSet.executeSql(tmpsql);
                            tmpsql = "update Prj_ProjectInfo set status = 5 where id = "+ approveid;
                            RecordSet.executeSql(tmpsql);

                            //\u66f4\u65b0\u5de5\u4f5c\u8ba1\u5212\u4e2d\u8be5\u9879\u76ee\u7684\u7ecf\u7406\u7684\u65f6\u95f4Begin
                            String begindate01 = "";
                            String enddate01 = "";

                            RecordSet.executeProc("Prj_TaskProcess_Sum",""+approveid);
                            if(RecordSet.next() && !RecordSet.getString("workday").equals("")){

                                if(!RecordSet.getString("begindate").equals("x")) begindate01 = RecordSet.getString("begindate");
                                if(!RecordSet.getString("enddate").equals("-")) enddate01 = RecordSet.getString("enddate");

                            }
                            if (!begindate01.equals("")){
                                RecordSet.executeSql("update workplan set status = '0',begindate = '" + begindate01 + "',enddate = '" + enddate01 + "' where type_n = '2' and projectid = '" + approveid + "' and taskid = -1");
                            }
                            //\u66f4\u65b0\u5de5\u4f5c\u8ba1\u5212\u4e2d\u8be5\u9879\u76ee\u7684\u7ecf\u7406\u7684\u65f6\u95f4End

                            //\u6dfb\u52a0\u5de5\u4f5c\u8ba1\u5212Begin
                            String para = "";
                            String workid = "";
                            String manager="";
                            String TaskID="";
                            RecordSet.executeProc("Prj_ProjectInfo_SelectByID",approveid);
                            if (RecordSet.next()){
                                manager=RecordSet.getString("manager");
                            }

                            tmpsql = "SELECT * FROM Prj_TaskProcess WHERE prjid = " + approveid + " and isdelete<>'1' order by id";
                            RecordSet.executeSql(tmpsql);

                            while (RecordSet.next()) {
                                TaskID = RecordSet.getString("id");
                                para = "2"; //type_n
                                para +=flag+Util.toScreen(RecordSet.getString("subject"),user.getLanguage());
                                para +=flag+Util.toScreen(RecordSet.getString("hrmid"),user.getLanguage());
                                para +=flag+Util.toScreen(RecordSet.getString("begindate"),user.getLanguage());
                                para +=flag+""; //BeginTime
                                para +=flag+Util.toScreen(RecordSet.getString("enddate"),user.getLanguage());
                                para +=flag+""; //EndTime
                                para +=flag+Util.toScreen(RecordSet.getString("content"),user.getLanguage());
                                para +=flag+"0";//requestid
                                para +=flag+approveid;//projectid
                                para +=flag+"0";//crmid
                                para +=flag+"0";//docid
                                para +=flag+"0";//meetingid
                                para +=flag+"0";//status;
                                para +=flag+"1";//isremind;
                                para +=flag+"0";//waketime;
                                para +=flag+manager;//createid;
                                para +=flag+currentdate;
                                para +=flag+currenttime;
                                para +=flag+"0";
                                para += flag + "0";			//taskid
                                para += flag + "1";	//urgent level
                                para += flag + "0";	//agentId level

                                RecordSet1.executeProc("WorkPlan_Insert",para);
                                if (RecordSet1.next()) workid = RecordSet1.getString("id");

                                //write "add" of view log
                                String[] logParams = new String[] {workid,
                                                            WorkPlanLogMan.TP_CREATE,
                                                            String.valueOf(userid),
                                                            request.getRemoteAddr()};
                                WorkPlanLogMan logMan = new WorkPlanLogMan();
                                logMan.writeViewLog(logParams);
                                //end

                                RecordSet1.executeSql("update workplan set taskid = " + TaskID + " where id =" + workid);
                                WorkPlanViewer.setWorkPlanShareById(workid);
                            }
                            //\u6dfb\u52a0\u5de5\u4f5c\u8ba1\u5212End
                        }
                    }
                    //\u5ba2\u6237
                    if (formid == 79) {
                        String sql= "select approveid,approvevalue,approvetype from bill_ApproveCustomer where requestid="+requestid;
                        RecordSet.executeSql(sql);
                        String approveid="";
                        String approvetype="";
                        String approvevalue="";
                        if(RecordSet.next()){
                            approveid=RecordSet.getString("approveid");
                            approvetype=RecordSet.getString("approvetype");
                            approvevalue = RecordSet.getString("approvevalue");
                        }
                        //\u66f4\u6539\u5355\u636e\u7684\u72b6\u6001\uff0c1\uff1a\u5df2\u7ecf\u5f52\u6863

                        RecordSet.executeSql("update bill_ApproveCustomer set status=1 where requestid="+requestid);
                        RecordSet.executeProc("CRM_CustomerInfo_SelectByID",approveid);
                        RecordSet.first();
                        String statusTemp = RecordSet.getString("status");
                        String Manager2 = RecordSet.getString("manager");
                        String name = RecordSet.getString("name");
                        String ProcPara="";
                        char flag = 2 ;
                        String fieldName="";
                        if(approvetype.equals("1")){
                            ProcPara = approveid;
                            ProcPara += flag+approvevalue;
                            ProcPara += flag+"1";

                            RecordSet.executeProc("CRM_CustomerInfo_Approve",ProcPara);

                            ProcPara = approveid;
                            ProcPara += flag+"a";
                            ProcPara += flag+"0";
                            ProcPara += flag+"a";
                            ProcPara += flag+currentdate;
                            ProcPara += flag+currenttime;
                            ProcPara += flag+""+user.getUID();
                            ProcPara += flag+""+user.getLogintype();
                            ProcPara += flag+request.getRemoteAddr();
                            RecordSet.executeProc("CRM_Log_Insert",ProcPara);

                            fieldName = SystemEnv.getHtmlLabelName(23247,user.getLanguage());

                            ProcPara = approveid+flag+"1"+flag+"0"+flag+"0";
                            ProcPara += flag+fieldName+flag+currentdate+flag+currenttime+flag+statusTemp+flag+approvevalue;
                            ProcPara += flag+""+user.getUID()+flag+""+user.getLogintype()+flag+request.getRemoteAddr();
                            RecordSet.executeProc("CRM_Modify_Insert",ProcPara);
                        }else if(approvetype.equals("2")){
                            ProcPara = approveid;
                            ProcPara += flag+approvevalue;

                            RecordSet.executeProc("CRM_CustomerInfo_Portal",ProcPara);
                            String PortalLoginid = "";
                            String PortalPassword = "";

                            if(approvevalue.equals("2")){
                                if (approveid.length()<5){
                                    PortalLoginid = "U" + Util.add0(Util.getIntValue(approveid),5);
                                }else{
                                    PortalLoginid = "U" + approveid;
                                }

                                PortalPassword = Util.getPortalPassword();

                                ProcPara = approveid;
                                ProcPara += flag+PortalLoginid;
                                ProcPara += flag+PortalPassword;

                                RecordSet.executeProc("CRM_CustomerInfo_PortalPasswor",ProcPara);
                            }
                            ProcPara = approveid;
                            ProcPara += flag+"p";
                            ProcPara += flag+"0";
                            ProcPara += flag+"p";
                            ProcPara += flag+currentdate;
                            ProcPara += flag+currenttime;
                            ProcPara += flag+""+user.getUID();
                            ProcPara += flag+""+user.getLogintype();
                            ProcPara += flag+request.getRemoteAddr();
                            RecordSet.executeProc("CRM_Log_Insert",ProcPara);

                            fieldName = SystemEnv.getHtmlLabelName(23249,user.getLanguage());

                            ProcPara = approveid+flag+"1"+flag+"0"+flag+"0";
                            ProcPara += flag+fieldName+flag+currentdate+flag+currenttime+flag+statusTemp+flag+approvevalue;
                            ProcPara += flag+""+user.getUID()+flag+""+user.getLogintype()+flag+request.getRemoteAddr();
                            RecordSet.executeProc("CRM_Modify_Insert",ProcPara);
                        }else if(approvetype.equals("3")){
                            String PortalLoginid = "";
                            String PortalPassword = "";

                            if(approvevalue.equals("2")){
                                if (approveid.length()<5){
                                    PortalLoginid = "U" + Util.add0(Util.getIntValue(approveid),5);
                                }else{
                                    PortalLoginid = "U" + approveid;
                                }

                                PortalPassword = Util.getPortalPassword();

                                ProcPara = approveid;
                                ProcPara += flag+PortalLoginid;
                                ProcPara += flag+PortalPassword;

                                RecordSet.executeProc("CRM_CustomerInfo_PortalPasswor",ProcPara);
                            }
                        }
                    }
                }
                PoppupRemindInfoUtil.updatePoppupRemindInfo(userid, 0, (logintype).equals("1") ? "0" : "1", requestid); //add by sean for td3999
int takisremark = -1;
int handleforwardid = -1;
String zsql = "select * from workflow_currentoperator where requestid= "+ requestid + "and nodeid = "+ nodeid +" and userid = "+ userid;
RecordSet.executeSql(zsql);
if(RecordSet.next()){
takisremark = Util.getIntValue(RecordSet.getString("takisremark"));
handleforwardid = Util.getIntValue(RecordSet.getString("handleforwardid"));
}
if(takisremark==2){
  
RecordSet.executeSql("update workflow_requestlog set logtype='b' where  requestid= "+ requestid + " and nodeid = "+ nodeid +" and operator = "+ userid);
}
if(handleforwardid>0){
RecordSet.executeSql("update workflow_requestlog set logtype='j' where  requestid= "+ requestid + "and nodeid = "+ nodeid +" and operator = "+ userid);
}
if(takisremark!=2 && handleforwardid<0){

  boolean logstatus = RequestManager.saveRequestLog();
}

String taksql = "select * from workflow_currentoperator where requestid= "+ requestid + "and nodeid = "+ nodeid +" and userid = "+ userid +" and takisremark = 2";
RecordSet.executeSql(taksql);
if(RecordSet.next()){
			String taksql1 = "select count(*) as cou from workflow_currentoperator where requestid= "+ requestid + "and nodeid = "+ nodeid +" and takisremark = 2 and isremark=1";
			RecordSet.executeSql(taksql1);
		if(RecordSet.next()){
			if(RecordSet.getInt("cou")==0){
				String taksql2 = "select * from workflow_currentoperator where requestid= "+ requestid + "and nodeid = "+ nodeid +" and isremark = 0 and takisremark = -2";
RecordSet.executeSql(taksql2);
if(RecordSet.next()){
	
String uptaksql2 = "update workflow_currentoperator set takisremark=0 where requestid= "+ requestid + "and nodeid = "+ nodeid +" and isremark = 0 and takisremark = -2";
RecordSet.executeSql(uptaksql2);
				}
			}
		}
}
/*
				RecordSet.execute("select * from workflow_currentoperator where requestid = " + requestid + "and workflowid = " +workflowid+ "and userid = "+ userid + "and nodeid = "+nodeid+"and takisremark = 2 ");
				if(RecordSet.next()){
				int tkisremark = RecordSet.getInt("isremark");
				if(tkisremark ==2){
				RecordSet.execute("update workflow_currentoperator set takisremark = 0 where requestid = " + requestid + "and workflowid = " +workflowid+  "and nodeid = "+nodeid+"and takisremark = -2 ");
				}
				}*/
				
            }
    //System.out.println("12:\u6d41\u7a0b" + i + "\u65f6\u95f4:" + (new Date().getTime() - d1.getTime()));
  }
  
  //\u8bf7\u5047\u7533\u8bf7\u5355
  if (formid == 180 && isbill == 1) {
	 
	  String sql = "";
	  int urger=Util.getIntValue((String)session.getAttribute(user.getUID()+"_"+requestid+"urger"),0);
	  HrmScheduleDiffUtil.setUser(user);
	  HrmScheduleDiffUtil.setForSchedule(true);
	
	  //add by chengfeng.han 2011-7-28 td20647 
	  int isagentCreater = Util.getIntValue((String)session.getAttribute(workflowid+"isagent"+user.getUID()));
	  int beagenter = Util.getIntValue((String)session.getAttribute(workflowid+"beagenter"+user.getUID()),0);
	  RequestManager.setIsagentCreater(isagentCreater);
	  RequestManager.setBeAgenter(beagenter);
	  //end

      sql = "select resourceid from Bill_BoHaiLeave where requestid = " + requestid;
      RecordSet.executeSql(sql);
      RecordSet.next();
      String workflowcreater = RecordSet.getString("resourceid");    

      sql = "select * from Bill_BoHaiLeave where requestid = " + requestid;
      RecordSet.executeSql(sql);
      RecordSet.next();
    
      if("submit".equalsIgnoreCase(src) && RequestManager.getIsremark()==0){
  		//TD15253 \u63a7\u5236\u7ed3\u675f\u65e5\u671f\uff08\u65f6\u95f4\uff09\u4e0d\u80fd\u5728\u5f00\u59cb\u65e5\u671f\uff08\u65f6\u95f4\u4e4b\u524d\uff09 Start
  	
  	    String fromDateAll = Util.null2String(RecordSet.getString("fromDate")).trim();
  	    String fromTimeAll = Util.null2String(RecordSet.getString("fromTime")).trim();
  	    String toDateAll = Util.null2String(RecordSet.getString("toDate")).trim();
  	    String toTimeAll = Util.null2String(RecordSet.getString("toTime")).trim();
  	    if(!"".equals(fromDateAll) && !"".equals(toDateAll)){//\u5f00\u59cb\u3001\u7ed3\u675f\u65e5\u671f\u90fd\u4e0d\u80fd\u4e3a\u7a7a\uff0c\u5426\u5219\u4e0d\u5224\u65ad
  	    	if("".equals(fromTimeAll)){
  	    		fromTimeAll = "00:00:00";
  	    	}else if(fromTimeAll.length() == 5){
  	    		fromTimeAll = fromTimeAll + ":00";
  	    	}
  	    	if("".equals(toTimeAll)){
  	    		toTimeAll = "23:59:59";
  	    	}else if(toTimeAll.length() == 5){
  	    		toTimeAll = toTimeAll + ":00";
  	    	}
  	    	
  	    	long leaveTimesAll = TimeUtil.timeInterval(fromDateAll+" "+fromTimeAll, toDateAll+" "+toTimeAll);
  	    	
  	    	if(leaveTimesAll < 0){//\u7ed3\u675f\u65e5\u671f\uff08\u65f6\u95f4\uff09\u5728\u5f00\u59cb\u4e4b\u524d
  	    		basebean.writeLog("requestid="+requestid+"&message=24569");
                continue;

  	    	}
  	    }
      }
  	//TD15253 \u63a7\u5236\u7ed3\u675f\u65e5\u671f\uff08\u65f6\u95f4\uff09\u4e0d\u80fd\u5728\u5f00\u59cb\u65e5\u671f\uff08\u65f6\u95f4\u4e4b\u524d\uff09 End

    String leaveType = RecordSet.getString("newLeaveType");
    String otherLeaveType = RecordSet.getString("otherLeaveType");
    ArrayList annualsql = new ArrayList();//\u5b58\u653e\u9500\u5047\u7684sql\u8bed\u53e5
    float leavedaysAll = 0;//\u5b58\u653e\u672c\u6b21\u8bf7\u5047\u5929\u6570\uff0c\u7528\u4e8e\u66f4\u65b0Bill_BoHaiLeave
//\u5982\u679c\u7528\u6237\u8bf7\u5047\u7c7b\u578b\u4e3a\u5e74\u5047\uff0c\u5219\u68c0\u67e5\uff0c\u5e74\u5047\u65f6\u95f4\u662f\u5426\u5927\u4e8e\u53ef\u8bf7\u5e74\u5047\u65f6\u95f4\uff0c\u5982\u679c\u5927\u4e8e\u5219\u4e0d\u5141\u8bb8\u63d0\u4ea4
if(src.equals("submit")&&!nodetype.equals("3")&&leaveType.equals(String.valueOf(HrmAttVacation.L6))) {
    
    String fromDate = RecordSet.getString("fromDate");
    String fromTime = RecordSet.getString("fromTime");
    String toDate = RecordSet.getString("toDate");
    String toTime = RecordSet.getString("toTime"); 
    
    String creater = RecordSet.getString("resourceid");
    
	int subcompanyid1=user.getUserSubCompany1();
    RecordSet.executeSql("select b.subcompanyid1 from hrmresource a,hrmdepartment b where a.departmentid=b.id and a.id="+creater);
    if(RecordSet.next()){
		subcompanyid1=Util.getIntValue(RecordSet.getString("subcompanyid1"),-1);
		if(subcompanyid1<=0){
			subcompanyid1=user.getUserSubCompany1();
		}
	}

      //\u672c\u6b21\u8bf7\u5047\u65f6\u95f4
      String leavetime = HrmScheduleDiffUtil.getTotalWorkingDays(fromDate,fromTime,toDate,toTime,subcompanyid1);
      
      Calendar today = Calendar.getInstance() ; 
      String thisyear = Util.add0(today.get(Calendar.YEAR),4);
      String lastyear = Util.add0(today.get(Calendar.YEAR)-1,4);
      //\u53ef\u8bf7\u5e74\u5047\u603b\u65f6\u95f4
      String allannualtime = "";
      //\u4e0a\u4e00\u5e74\u5269\u4f59\u5e74\u5047\u5929\u6570
      String lastyearannualtime = "";
      //\u4eca\u5929\u5269\u4f59\u5e74\u5047\u5929\u6570
      String thisyearannualtime = "";
      
      try{
          String tempvalue = HrmAnnualManagement.getUserAannualInfo(workflowcreater,currentdate);
          thisyearannualtime = Util.TokenizerString2(tempvalue,"#")[0];
          lastyearannualtime = Util.TokenizerString2(tempvalue,"#")[1];
          allannualtime = Util.TokenizerString2(tempvalue,"#")[2];    
      }catch(Exception e){
          
      }
      
      float leavedays = Util.getFloatValue(leavetime,0);//\u672c\u6b21\u8bf7\u5047\u65f6\u95f4
      leavedaysAll = leavedays;
      float allannualdays = Util.getFloatValue(allannualtime,0);//\u7528\u6237\u5269\u4f59\u5e74\u5047\u65f6\u95f4
      float lastyearannualdays = Util.getFloatValue(lastyearannualtime,0);
      float thisyearannualdays = Util.getFloatValue(thisyearannualtime,0);
      DecimalFormat   df   =   new   DecimalFormat("0.##");
         
      if(allannualdays<leavedays){
         //response.sendRedirect("/workflow/request/ViewRequest.jsp?requestid="+requestid+"&message=182");
         out.print("<script>wfforward('/workflow/request/ViewRequest.jsp?requestid="+requestid+"&message=182');</script>");
         return ;
      }else{
         //\u9500\u5047sql\uff0c\u5148\u8bf7\u4e0a\u4e00\u5e74\u5e74\u5047\uff0c\u518d\u8bf7\u5f53\u524d\u5e74\u5e74\u5047
         if(leavedays<lastyearannualdays){
           sql = "update hrmannualmanagement set annualdays = (annualdays - " + leavedays + ") where annualyear = " + lastyear + " and resourceid = " + creater;     
           annualsql.add(sql);
         }else{
           sql = "update hrmannualmanagement set annualdays = 0 where annualyear = " + lastyear + " and resourceid = " + creater;
           annualsql.add(sql);
           sql = "update hrmannualmanagement set annualdays = (annualdays - " + Util.getFloatValue(df.format(leavedays - lastyearannualdays),0) + ") where annualyear = " + thisyear + " and resourceid = " + creater;
           annualsql.add(sql);
         }                   
      }
}else if(src.equals("submit")&&!nodetype.equals("3")&&leaveType.equals(String.valueOf(HrmAttVacation.L12))) {//\u5e26\u85aa\u75c5\u5047
    
    String fromDate = RecordSet.getString("fromDate");
    String fromTime = RecordSet.getString("fromTime");
    String toDate = RecordSet.getString("toDate");
    String toTime = RecordSet.getString("toTime"); 
    
    String creater = RecordSet.getString("resourceid");

  	int subcompanyid1=user.getUserSubCompany1();
      RecordSet.executeSql("select b.subcompanyid1 from hrmresource a,hrmdepartment b where a.departmentid=b.id and a.id="+creater);
      if(RecordSet.next()){
  		subcompanyid1=Util.getIntValue(RecordSet.getString("subcompanyid1"),-1);
  		if(subcompanyid1<=0){
  			subcompanyid1=user.getUserSubCompany1();
  		}
  	}	
      //\u672c\u6b21\u8bf7\u5047\u65f6\u95f4
      String leavetime = HrmScheduleDiffUtil.getTotalWorkingDays(fromDate,fromTime,toDate,toTime,subcompanyid1);
      
      Calendar today = Calendar.getInstance() ; 
      
      String thisyear = Util.add0(today.get(Calendar.YEAR),4);
      String lastyear = Util.add0(today.get(Calendar.YEAR)-1,4);
    //\u53ef\u8bf7\u5e26\u85aa\u75c5\u5047\u603b\u65f6\u95f4
      String allpsltime = "";
      //\u4e0a\u4e00\u5e74\u5269\u4f59\u5e26\u85aa\u75c5\u5047\u5929\u6570
      String lastyearpsltime = "";
      //\u4eca\u5e74\u5269\u4f59\u5e26\u85aa\u75c5\u5047\u5929\u6570
      String thisyearpsltime = "";
      
      try{
          String tempvalue = HrmPaidSickManagement.getUserPaidSickInfo(workflowcreater,currentdate);
          thisyearpsltime = Util.TokenizerString2(tempvalue,"#")[0];
          lastyearpsltime = Util.TokenizerString2(tempvalue,"#")[1];
          allpsltime = Util.TokenizerString2(tempvalue,"#")[2];    
      }catch(Exception e){
          
      }
      
      float leavedays = Util.getFloatValue(leavetime,0);//\u672c\u6b21\u8bf7\u5047\u65f6\u95f4
      leavedaysAll = leavedays;
      float allpsldays = Util.getFloatValue(allpsltime,0);//\u7528\u6237\u5269\u4f59\u5e26\u85aa\u75c5\u5047\u65f6\u95f4
      float lastyearpsldays = Util.getFloatValue(lastyearpsltime,0);
      float thisyearpsldays = Util.getFloatValue(thisyearpsltime,0);
      DecimalFormat   df   =   new   DecimalFormat("0.##");
         
      if(allpsldays<leavedays){
          basebean.writeLog("requestid="+requestid+"&message=183");
          continue;
      }else{
          //\u9500\u5047sql\uff0c\u5148\u8bf7\u4e0a\u4e00\u5e74\u5e26\u85aa\u75c5\u5047\uff0c\u518d\u8bf7\u5f53\u524d\u5e74\u5e26\u85aa\u75c5\u5047
          if(leavedays<lastyearpsldays){
            sql = "update HrmPSLManagement set psldays = (psldays - " + leavedays + ") where pslyear = " + lastyear + " and resourceid = " + creater;
            annualsql.add(sql);
          }else{
            sql = "update HrmPSLManagement set psldays = 0 where pslyear = " + lastyear + " and resourceid = " + creater;
            annualsql.add(sql);
            sql = "update HrmPSLManagement set psldays = (psldays - " + Util.getFloatValue(df.format(leavedays - lastyearpsldays),0) + ") where pslyear = " + thisyear + " and resourceid = " + creater;
            annualsql.add(sql);
          }                   
      }
  }else{//\u8ba1\u7b97\u8bf7\u5047\u5929\u6570
  	String fromDate = RecordSet.getString("fromDate");
  	String fromTime = RecordSet.getString("fromTime");
  	String toDate = RecordSet.getString("toDate");
  	String toTime = RecordSet.getString("toTime");
      
  	String resourceId = RecordSet.getString("resourceid");
      String sqlHrmResource = "select locationid from HrmResource where id ="+resourceId;
  	RecordSet.executeSql(sqlHrmResource);
  	String locationid = "";
  	if (RecordSet.next()){
  	   locationid=RecordSet.getString("locationid");
  	}
  	String sqlHrmLocations = "select countryid from HrmLocations where id="+locationid;
  	RecordSet.executeSql(sqlHrmLocations);
  	String countryId = "";
  	if (RecordSet.next()){
  	   countryId =  RecordSet.getString("countryid");
  	}
	User tmpUser = User.getUser(Util.getIntValue(resourceId),0);
	HrmScheduleDiffUtil.setUser(tmpUser);
  	HrmScheduleDiffUtil.setForSchedule(true);

  	int subcompanyid1=user.getUserSubCompany1();
      RecordSet.executeSql("select b.subcompanyid1 from hrmresource a,hrmdepartment b where a.departmentid=b.id and a.id="+resourceId);
      if(RecordSet.next()){
  		subcompanyid1=Util.getIntValue(RecordSet.getString("subcompanyid1"),-1);
  		if(subcompanyid1<=0){
  			subcompanyid1=user.getUserSubCompany1();
  		}
  	}
  	//\u672c\u6b21\u8bf7\u5047\u65f6\u95f4
  	String leavetime = HrmScheduleDiffUtil.getTotalWorkingDays(fromDate,fromTime,toDate,toTime,subcompanyid1);
  	float leavedays = Util.getFloatValue(leavetime,0);//\u672c\u6b21\u8bf7\u5047\u65f6\u95f4
      leavedaysAll = leavedays;
  }
  if(("submit".equalsIgnoreCase(src)||"save".equalsIgnoreCase(src)) && RequestManager.getIsremark()==0){
  	sql = "update Bill_BoHaiLeave set leaveDays="+leavedaysAll+" where requestid="+requestid;
  	RecordSet.executeSql(sql);
  }
  boolean flowstatus = RequestManager.flowNextNode() ;
  if( !flowstatus ) {
          basebean.writeLog("requestid="+requestid+"&message=2");
          continue;
  }

  //\u5982\u679c\u6d41\u7a0b\u5f52\u6863\u4e86\uff0c\u5219\u4f7f\u5e74\u5047\u751f\u6548\uff0c\u5728\u7528\u6237\u53ef\u8bf7\u5e74\u5047\u51cf\u53bb\u5f53\u524d\u672c\u6b21\u8bf7\u7684\u5e74\u5047
  sql = "select currentnodetype from workflow_requestbase where requestid = " + requestid;
  RecordSet.executeSql(sql);
  RecordSet.next();
  String currentnodetype = RecordSet.getString("currentnodetype");

  if(src.equals("submit")&&!nodetype.equals("3")&&currentnodetype.equals("3")) {
      
      sql = "select * from Bill_BoHaiLeave where requestid = " + requestid;
      RecordSet.executeSql(sql);
      RecordSet.next();
      String fromDate = RecordSet.getString("fromDate");
      String fromTime = RecordSet.getString("fromTime");
      String toDate = RecordSet.getString("toDate");
      String toTime = RecordSet.getString("toTime"); 
      String creater = RecordSet.getString("resourceid");

  	int subcompanyid1=user.getUserSubCompany1();
      RecordSet.executeSql("select b.subcompanyid1 from hrmresource a,hrmdepartment b where a.departmentid=b.id and a.id="+creater);
      if(RecordSet.next()){
  		subcompanyid1=Util.getIntValue(RecordSet.getString("subcompanyid1"),-1);
  		if(subcompanyid1<=0){
  			subcompanyid1=user.getUserSubCompany1();
  		}
  	}	
      //\u672c\u6b21\u8bf7\u5047\u65f6\u95f4
      String leavetime = HrmScheduleDiffUtil.getTotalWorkingDays(fromDate,fromTime,toDate,toTime,subcompanyid1);
      
      Calendar today = Calendar.getInstance() ; 
      
      String thisyear = Util.add0(today.get(Calendar.YEAR),4);
      String lastyear = Util.add0(today.get(Calendar.YEAR)-1,4);
      
      float leavedays = Util.getFloatValue(leavetime,0);//\u672c\u6b21\u8bf7\u5047\u65f6\u95f4
      DecimalFormat   df   =   new   DecimalFormat("0.##");
      
    //\u901a\u8fc7HrmAnnualLeaveInfo\u7684status\u8fdb\u884c\u5e74\u5047\u7684\u8bb0\u5f551\u4ee3\u8868\u672a\u8fdb\u5165\u5e74\u5047 2\u4ee3\u8868\u51c6\u5907\u6263\u51cf\u5e74\u5047 3\u4ee3\u8868\u9500\u4e0a\u4e00\u5e74\u5e74\u5047 4\u4ee3\u8868\u5148\u9500\u4e0a\u4e00\u5e74\u5e74\u5047\uff0c\u518d\u9500\u5f53\u524d\u5e74\u5e74\u5047
      sql = "delete from HrmAnnualLeaveInfo where requestid = " + requestid;
      RecordSet.executeSql(sql);
      sql = "insert into HrmAnnualLeaveInfo (requestid,resourceid,startdate,starttime,enddate,endtime,leavetime,occurdate,leavetype,otherleavetype,status) values ("+requestid+","+creater+",'"+fromDate+"','"+fromTime+"','"+toDate+"','"+toTime+"','"+leavedays+"','"+currentdate+"','"+leaveType+"','"+otherLeaveType+"',1)";
      RecordSet.executeSql(sql);
      
    RecordSet.executeSql("select * from Bill_BoHaiLeave where requestid = "+requestid);
    RecordSet.next();
    String confirmNewLeavetype = RecordSet.getString("newLeaveType");
    if(!leaveType.equals(confirmNewLeavetype)) leaveType = confirmNewLeavetype;
    if(leaveType.equals(String.valueOf(HrmAttVacation.L6))){
          //\u53ef\u8bf7\u5e74\u5047\u603b\u65f6\u95f4
          String allannualtime = "";
          //\u4e0a\u4e00\u5e74\u5269\u4f59\u5e74\u5047\u5929\u6570
          String lastyearannualtime = "";
          //\u4eca\u5929\u5269\u4f59\u5e74\u5047\u5929\u6570
          String thisyearannualtime = "";
          
          try{
              String tempvalue = HrmAnnualManagement.getUserAannualInfo(workflowcreater,currentdate);
              thisyearannualtime = Util.TokenizerString2(tempvalue,"#")[0];
              lastyearannualtime = Util.TokenizerString2(tempvalue,"#")[1];
              allannualtime = Util.TokenizerString2(tempvalue,"#")[2];    
          }catch(Exception e){
              
          }
        RecordSet.executeSql("update HrmAnnualLeaveInfo set status=2 where requestid = " + requestid);
          float allannualdays = Util.getFloatValue(allannualtime,0);//\u7528\u6237\u5269\u4f59\u5e74\u5047\u65f6\u95f4
          float lastyearannualdays = Util.getFloatValue(lastyearannualtime,0);
          float thisyearannualdays = Util.getFloatValue(thisyearannualtime,0);
        //\u9500\u5047sql\uff0c\u5148\u9500\u4e0a\u4e00\u5e74\u5e74\u5047\uff0c\u518d\u9500\u5f53\u524d\u5e74\u5e74\u5047
        if(leavedays<lastyearannualdays){
		RecordSet.executeSql("update HrmAnnualLeaveInfo set status=3 where requestid = " + requestid);
           sql = "update hrmannualmanagement set annualdays = (annualdays - " + leavedays + ") where annualyear = " + lastyear + " and resourceid = " + creater;     
           RecordSet.executeSql(sql);
        }else{
       	RecordSet.executeSql("update HrmAnnualLeaveInfo set status=4 where requestid = " + requestid);
           sql = "update hrmannualmanagement set annualdays = 0 where annualyear = " + lastyear + " and resourceid = " + creater;
           RecordSet.executeSql(sql);
           sql = "update hrmannualmanagement set annualdays = (annualdays - " + Util.getFloatValue(df.format(leavedays - lastyearannualdays),0) + ") where annualyear = " + thisyear + " and resourceid = " + creater;
           RecordSet.executeSql(sql);
        }
    }else if(leaveType.equals(String.valueOf(HrmAttVacation.L12))){//\u5e26\u85aa\u75c5\u5047
          //\u53ef\u8bf7\u5e26\u85aa\u75c5\u5047\u603b\u65f6\u95f4
          String allannualtime = "";
          //\u4e0a\u4e00\u5e74\u5269\u4f59\u5e26\u85aa\u75c5\u5047\u5929\u6570
          String lastyearannualtime = "";
          //\u4eca\u5e74\u5269\u4f59\u5e26\u85aa\u75c5\u5047\u5929\u6570
          String thisyearannualtime = "";
          
          try{
              String tempvalue = HrmPaidSickManagement.getUserPaidSickInfo(workflowcreater,currentdate);
              thisyearannualtime = Util.TokenizerString2(tempvalue,"#")[0];
              lastyearannualtime = Util.TokenizerString2(tempvalue,"#")[1];
              allannualtime = Util.TokenizerString2(tempvalue,"#")[2];    
          }catch(Exception e){
              
          }
          float allannualdays = Util.getFloatValue(allannualtime,0);//\u7528\u6237\u5269\u4f59\u5e26\u85aa\u75c5\u5047\u65f6\u95f4
          float lastyearannualdays = Util.getFloatValue(lastyearannualtime,0);
          float thisyearannualdays = Util.getFloatValue(thisyearannualtime,0);
          //\u9500\u5047sql\uff0c\u5148\u9500\u4e0a\u4e00\u5e74\u5e74\u5047\uff0c\u518d\u9500\u5f53\u524d\u5e74\u5e74\u5047\uff0c\u5982\u679c\u5e74\u5047\u5c0f\u4e8e0\uff0c\u5219\u5e74\u5047\u5728\u672c\u5e74\u4e0a\u589e\u52a0\u5e74\u5047
          if(leavedays<0){
       	     sql = "update HrmPSLManagement set psldays = (psldays - " + leavedays + ") where pslyear = " + thisyear + " and resourceid = " + creater;     
                RecordSet.executeSql(sql);  
       	  }else if(leavedays<lastyearannualdays){
                sql = "update HrmPSLManagement set psldays = (psldays - " + leavedays + ") where pslyear = " + lastyear + " and resourceid = " + creater;     
                RecordSet.executeSql(sql);
             }else{
                sql = "update HrmPSLManagement set psldays = 0 where pslyear = " + lastyear + " and resourceid = " + creater;
                RecordSet.executeSql(sql);
                sql = "update HrmPSLManagement set psldays = (psldays - " + Util.getFloatValue(df.format(leavedays - lastyearannualdays),0) + ") where pslyear = " + thisyear + " and resourceid = " + creater;
                RecordSet.executeSql(sql);
          }
	} else if(leaveType.equals(String.valueOf(HrmAttVacation.L13))){//\u8c03\u4f11
		HrmPaidLeaveManager.paidLeaveDeduction(creater, fromDate, fromTime, toDate, toTime);
        }
  	  }
  		boolean logstatus = RequestManager.saveRequestLog() ;
    }
    //System.out.println("13:\u6d41\u7a0b" + i + "\u65f6\u95f4:" + (new Date().getTime() - d1.getTime()));
  }
    //\u4e0b\u4e00\u8282\u70b9\u4e3a\u5f52\u6863\u8282\u70b9,\u82e5\u6709\u6284\u9001\u65e0\u9700\u63d0\u4ea4\u7684\u8bb0\u5f55\uff0c
    if("3".equals(RequestManager.getNextNodetype())){
        rs.executeUpdate("update workflow_currentoperator set isremark = '4' where isremark = '8' and requestid = ? and nodeid = ? and userid = ?",RequestManager.getRequestid(),RequestManager.getNextNodeid(),user.getUID());
    }
    
  //\u7cfb\u7edf\u8868\u5355\u6279\u91cf\u6267\u884c
    try{
    	BatchSubmitAction batchSubmitAction = new BatchSubmitAction();
        batchSubmitAction.setRequestId(requestid);
        batchSubmitAction.batchSubmit();
    }catch(Exception e){
    	response.sendRedirect("/notice/RequestError.jsp");
    	return;
    }
    
}

int isfrommobile = Util.getIntValue(Util.null2String(request.getParameter("isfrommobile")));
if (isfrommobile == 1) {
    response.getWriter().write("{\"result\":1}");
    return;
}

String pagefromtype = Util.null2String(request.getParameter("pagefromtype"));
if ("1".equals(pagefromtype)) {
    response.getWriter().write("1");
    return;
}

if(method.equals("reqeustByWfTypeAndComplete")){
	response.sendRedirect("/workflow/search/WFSearchTemp.jsp?method="+method+"&wftype="+wftype+"&flowAll="+flowAll+"&flowNew="+flowNew+"&viewScope=doing&complete=0&numberType=flowAll&viewcondition="+viewcondition);
}else if(method.equals("reqeustbywfidNode")){
	response.sendRedirect("/workflow/search/WFSearchTemp.jsp?method="+method+"&workflowid="+wfid+"&flowAll="+flowAll+"&flowNew="+flowNew+"&viewScope=doing&complete=0&numberType=flowAll&viewcondition="+viewcondition);
}else{
	response.sendRedirect("/workflow/search/WFSearchTemp.jsp?method=all&viewScope=doing&complete=0&wftypes="+wftypes+"&flowAll="+flowAll+"&flowNew="+flowNew+"&viewcondition="+viewcondition);
}

    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("workflow/request/RequestListOperation.jsp"), 8402832810561735695L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string2;
  private final static char []_jsp_string1;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string2 = "\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
  }
}
