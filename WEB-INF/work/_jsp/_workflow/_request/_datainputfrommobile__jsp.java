/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._workflow._request;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.workflow.datainput.DynamicDataInput;
import java.util.List;
import java.util.ArrayList;
import java.util.Map;
import java.util.HashMap;
import java.util.Hashtable;
import net.sf.json.JSONArray;
import net.sf.json.JSONObject;
import weaver.general.Util;
import weaver.workflow.workflow.WorkflowComInfo;

public class _datainputfrommobile__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;

  
  
  public int getNewGroupid(int billid,int groupid){
  	weaver.conn.RecordSet rs = new weaver.conn.RecordSet();
  	int newgroupid = 0 ;
  	String sql = "";
  	if(rs.getDBType().equals("oracle")){
  		sql = " SELECT t.rid FROM (select rownum as rid,orderid from (SELECT tablename, orderid FROM Workflow_billdetailtable  WHERE billid = ? order by id) t1) t WHERE t.orderid=?" ;
  	}else{
  		sql = "SELECT t.rowid FROM (SELECT ROW_NUMBER() OVER (ORDER BY ORDERid) AS rowid ,tablename,orderid FROM Workflow_billdetailtable WHERE billid=? ) t WHERE t.orderid=?" ;
  	}
  	rs.executeQuery(sql,billid+"",groupid+"");
  	if(rs.next()){
  		newgroupid = rs.getInt(1);
  	}else{
  		newgroupid = groupid ;
  	}
  
  	return newgroupid ;
  }

  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.conn.RecordSet rs;
      rs = (weaver.conn.RecordSet) pageContext.getAttribute("rs");
      if (rs == null) {
        rs = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs", rs);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet rsObj;
      rsObj = (weaver.conn.RecordSet) pageContext.getAttribute("rsObj");
      if (rsObj == null) {
        rsObj = new weaver.conn.RecordSet();
        pageContext.setAttribute("rsObj", rsObj);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      
String workflowId = request.getParameter("id");
String strTrgFieldNames = request.getParameter("trg");
String nodenumstr = request.getParameter("nodenumstr");
WorkflowComInfo wfComInfo = new WorkflowComInfo();
String fformid = wfComInfo.getFormId(workflowId);
String isbill = wfComInfo.getIsBill(workflowId);
String nodeid = request.getParameter("node");

//\u83b7\u53d6\u5f53\u524d\u8282\u70b9\u6240\u6709\u53ef\u89c1\u5b57\u6bb5\u7684\u7c7b\u578b\u4fe1\u606f\u3002
Map<String, String[]> mapFieldInfos = DynamicDataInput.getFieldInfos(workflowId, nodeid, isbill);
//\u7528\u4e8e\u8bbe\u503c\u7684\u5b57\u6bb5(\u5b57\u6bb5id\u53f7 \u5b57\u6bb5\u503c)\u5217\u8868
List lstValues = new ArrayList();
//\u7528\u4e8e\u8bbe\u7f6e\u524d\u7aef\u663e\u793a\u7684(\u6d4f\u89c8\u6309\u94ae)\u5b57\u6bb5(\u5b57\u6bb5id\u53f7 \u5b57\u6bb5\u503c)\u5217\u8868
List lstDisplays = new ArrayList();
List lstGroupIds = new ArrayList();
List lstDetailDisplays = new ArrayList();
List lstDetailValues = new ArrayList();

ArrayList arrTrgFieldNames = Util.TokenizerString(strTrgFieldNames, ",");
Map<String,String> gropIdMap = new HashMap<String,String>();
Map<String,String> dsiplayGropIdMap = new HashMap<String,String>();
for(int temp=0; temp<arrTrgFieldNames.size(); temp++){
	String trgFieldName = Util.null2String((String)arrTrgFieldNames.get(temp));
	String suffixField = "";
	if(trgFieldName.indexOf("_")>=0){
		String[] trgFieldNames = trgFieldName.split("_");
		trgFieldName = trgFieldNames[0];
        if(trgFieldNames.length==3){
        	suffixField = "_"+trgFieldNames[1]+"_"+trgFieldNames[2];
        }else if(trgFieldNames.length==2){
        	suffixField = "_"+trgFieldNames[1];
        }
	}
	if(trgFieldName != null && !trgFieldName.trim().equals("") ){
		DynamicDataInput DDI = new DynamicDataInput(workflowId,trgFieldName,isbill);

		//\u67e5\u8be2\u5c06\u5f53\u524d\u5b57\u6bb5\u4f5c\u4e3a\u53d6\u503c\u53c2\u6570\u7684\u6240\u6709\u8054\u52a8\u4fe1\u606f
		String sql="select id from Workflow_DataInput_entry where WorkFlowID=? and TriggerFieldName=? ";
		rs.executeQuery(sql,workflowId,trgFieldName);
		String entryid = "";
		String datainputid = "";
		Hashtable outdatahash = new Hashtable();
		Hashtable detailoutdatahash = new Hashtable();
		while(rs.next()){
			entryid = rs.getString("id");
			rsObj.executeSql("select id,IsCycle,WhereClause from Workflow_DataInput_main where entryID="+entryid+" order by orderid");

			ArrayList outdatasList=new ArrayList();
			ArrayList outfieldnamelist=new ArrayList();
			ArrayList detailoutdatasList=new ArrayList();
			ArrayList detailoutfieldnamelist=new ArrayList();
			 ArrayList groupids = null ;
			while(rsObj.next()){
				datainputid = rsObj.getString("id");
				
				groupids = DDI.GetOutFieldIndex(datainputid);//\u67e5\u8be2\u51fa\u660e\u7ec6\u4e2a\u6570
				//\u83b7\u53d6\u8054\u52a8\u4fe1\u606f\u4e2d\u7684 \u6240\u6709\u53d6\u503c\u5b57\u6bb5\u540d\u79f0 \u53ca \u53d6\u503c\u5b57\u6bb5\u503c\u3002
				ArrayList infieldnamelist = DDI.GetInFieldName(datainputid);
				for(int i=0;i<infieldnamelist.size();i++){
					String paramName = datainputid+"|"+(String)infieldnamelist.get(i)+suffixField;
					String inputFieldValue = Util.null2String(request.getParameter(paramName));
					if(!"".equals(suffixField)&&"".equals(inputFieldValue)){
                          inputFieldValue = Util.null2String(request.getParameter(paramName+"_d"));      
					}
					//\u8bb0\u5f55\u65e5\u5fd7\u4fe1\u606f
					//System.out.println("The 'paramName' value:\t" + paramName);
					//System.out.println("The 'inputFieldValue' value:\t" + inputFieldValue);
					DDI.SetInFields((String)infieldnamelist.get(i),inputFieldValue);
				}
				//\u83b7\u53d6\u8054\u52a8\u4fe1\u606f\u4e2d\u7684 \u6240\u6709\u6761\u4ef6\u5b57\u6bb5\u540d\u79f0 \u53ca \u6761\u4ef6\u5b57\u6bb5\u503c\u3002
				ArrayList conditionfieldnameList = DDI.GetConditionFieldName(datainputid);
				for(int j=0;j<conditionfieldnameList.size();j++){
					DDI.SetConditonFields((String)conditionfieldnameList.get(j),Util.null2String(request.getParameter(datainputid+"|"+(String)conditionfieldnameList.get(j)+suffixField)));
				}
		        DDI.GetOutData(datainputid);
		        outfieldnamelist = DDI.GetOutFieldNameList();
		        outdatasList = DDI.GetOutDataList();
		        
		      	//\u8d4b\u503c\u5b57\u6bb5\u4e3a\u4e3b\u8868\u5b57\u6bb5\u7684\u66f4\u65b0
				if(DDI.GetIsCycle().equals("1")){
					//\u5f53\u8d4b\u503c\u5b57\u6bb5\u4e3a\u4e3b\u8868\u5b57\u6bb5\u65f6\uff0c outdatasList\u4ec5\u5305\u542b\u4e00\u4e2a\u5143\u7d20\u3002
				 	for(int i=0;i<outdatasList.size();i++){
				 		outdatahash = (Hashtable)outdatasList.get(i);
				 		
				 		List tempObj = new ArrayList();
				 		//\u5bf9\u8d4b\u503c\u5b57\u6bb5\u8fdb\u884c\u5faa\u73af\u3002
				 		for(int j=0; j<outfieldnamelist.size(); j++){
				 			String fieldName = (String)outfieldnamelist.get(j);
				 		    String fieldValue = (String)outdatahash.get(fieldName);
				 		   	fieldValue = Util.toExcelData(fieldValue);
				 		   	
				 		   	//\u5224\u65ad\u5f53\u524d\u5b57\u6bb5\u662f\u5426\u652f\u6301\u7f16\u8f91
				 		   	String[] fieldType = DynamicDataInput.getFieldType(fieldName, mapFieldInfos);
				 		   	if(fieldType != null){
				 		   		Map fieldObj = DynamicDataInput.getChangeFieldMobile(fieldName+suffixField, fieldValue, fieldType);
						 		tempObj.add(fieldObj);
				 		   	}
				 		}
				 		lstValues.add(tempObj);
	       			}
					
					//\u83b7\u53d6\u6b64\u6b21\u53d6\u503c\u6240\u9700\u8981\u8bbe\u7f6e\u524d\u7aef\u503c\u7684\u5217\u8868
					List tempObj = DynamicDataInput.getBrowserButtonValue(outfieldnamelist, outdatasList, mapFieldInfos,isbill);
					if(tempObj != null){
						if(!"".equals(suffixField)){
							for(int i=0;i<tempObj.size();i++){
								Map map=(Map)tempObj.get(i);
								map.put("fieldId",map.get("fieldId")+suffixField);
							}
						}
						lstDisplays.add(tempObj);
										}
					try{
						if("".equals(suffixField)){
							for(int dtidx = 0 ; dtidx < groupids.size() ; dtidx++){
					   			Map mopObj = new HashMap();
								int tmpgroupid = Util.getIntValue(groupids.get(dtidx).toString(),1) ;
				      			int groupid = getNewGroupid(Util.getIntValue(fformid,0),tmpgroupid);
				      			int jsgroupid = groupid -1 ;
				      			detailoutfieldnamelist = DDI.GetOutFieldNameListWithIndex(datainputid,tmpgroupid+"") ;
				      			detailoutdatasList = DDI.GetOutDataWithIndex(datainputid,tmpgroupid+"");
				      			int addRowCount=detailoutdatasList.size();
				      			int defaultsum = 0;
				      		    if(!"".equals(nodenumstr)){
				      		    	String[] nodenumArray=Util.splitString(nodenumstr,",");
				      		    	for(int detnodei=0;detnodei<nodenumArray.length;detnodei++){
				      		    		if(jsgroupid == Util.getIntValue(Util.splitString(nodenumArray[detnodei],"-")[0],-1)){
				      		    			defaultsum =Util.getIntValue(Util.splitString(nodenumArray[detnodei],"-")[1],0);
				      		    			break;
				      		    		}
				      		    	}
				      		    }
								if(gropIdMap.get((jsgroupid+""))!=null&&!"".equals(Util.null2String(gropIdMap.get((jsgroupid+""))))){
								       defaultsum = Util.getIntValue(gropIdMap.get((jsgroupid+"")));
								}
				      			for(int dtirow=0;dtirow<addRowCount;dtirow++){
				      				int detailsum =defaultsum+ dtirow;
				      				detailoutdatahash = (Hashtable)detailoutdatasList.get(dtirow);
				      				List detailtempObj = new ArrayList();
							 		//\u5bf9\u8d4b\u503c\u5b57\u6bb5\u8fdb\u884c\u5faa\u73af\u3002
							 		for(int j=0; j<detailoutfieldnamelist.size(); j++){
							 			String fieldName = (String)detailoutfieldnamelist.get(j);
							 		    String fieldValue = (String)detailoutdatahash.get(fieldName);
							 		   	fieldValue = Util.toExcelData(fieldValue);
							 		   	
							 		   	//\u5224\u65ad\u5f53\u524d\u5b57\u6bb5\u662f\u5426\u652f\u6301\u7f16\u8f91
							 		   	String[] fieldType = DynamicDataInput.getFieldType(fieldName, mapFieldInfos);
							 		   	if(fieldType != null){
							 		   		Map fieldObj = DynamicDataInput.getChangeFieldMobile(fieldName+"_"+detailsum+"", fieldValue, fieldType);
							 		   	    detailtempObj.add(fieldObj);
							 		   	}
							 		}
							 		lstDetailValues.add(detailtempObj);
				      			}
							    if(gropIdMap.get((jsgroupid+""))==null||"".equals(Util.null2String(gropIdMap.get((jsgroupid+""))))){
                                          gropIdMap.put(""+jsgroupid,addRowCount+"");
								}
				      			
				      			List detailDtempObj = DynamicDataInput.getBrowserButtonValue(detailoutfieldnamelist, detailoutdatasList, mapFieldInfos,isbill,nodenumstr,jsgroupid,dsiplayGropIdMap);
								if(detailDtempObj != null){
										for(int i=0;i<detailDtempObj.size();i++){
											Map map=(Map)detailDtempObj.get(i);
											map.put("fieldId",map.get("fieldId")+suffixField);
										}
									lstDetailDisplays.add(detailDtempObj);
								}
								
								mopObj.put("values",lstDetailValues);
								mopObj.put("displays", lstDetailDisplays);
				      			mopObj.put("groupid",jsgroupid);
				      			mopObj.put("rowcount",addRowCount);
				      			lstGroupIds.add(mopObj);
							}
						}
					}catch(Exception e){
					}
		       	} 
			}
		}
	}
}

//\u5fc5\u586b\u5b57\u6bb5\u7684\u72b6\u6001\u4fee\u6539\u3002
String[] arrInputChecks = DynamicDataInput.getIsMandatoryField(workflowId, nodeid, isbill);
//\u8d4b\u503c\u5b57\u6bb5\u7684\u5217\u8868\uff0c\u8d4b\u503c\u4e4b\u524d\u5148\u6e05\u7a7a\u5b57\u6bb5\u503c\u3002
List<String> arrayList=new ArrayList<String>();
for(int temp=0; temp<arrTrgFieldNames.size(); temp++){
	String suffixField = "";
	String trgFieldName = Util.null2String((String)arrTrgFieldNames.get(temp));
	if(trgFieldName.indexOf("_")>=0){
		String[] trgFieldNames = trgFieldName.split("_");
		trgFieldName = trgFieldNames[0];
        if(trgFieldNames.length==3){
        	suffixField = "_"+trgFieldNames[1]+"_"+trgFieldNames[2];
        }else if(trgFieldNames.length==2){
        	suffixField = "_"+trgFieldNames[1];
        }
	}
	String[] arrOutputFields = DynamicDataInput.getTriggerOutputFieldName(workflowId, trgFieldName, mapFieldInfos);
	for(int k=0;k<arrOutputFields.length;k++){
		if(!"".equals(suffixField)){
			String arroutputfield = arrOutputFields[k];
			if(arroutputfield.indexOf("_span")>=0){
				if(!trgFieldName.equals(arroutputfield.replace("_span",""))){
				  arroutputfield = arroutputfield.replace("_span","")+suffixField+"_span";
				  arrayList.add(arroutputfield);
				}
			}else{
				if(!trgFieldName.equals(arroutputfield)){
					arroutputfield = arroutputfield+suffixField;
					arrayList.add(arroutputfield);
				}
			}
		}else{
			String arroutputfield = arrOutputFields[k];
			if(arroutputfield.indexOf("_span")>=0){
				if(!trgFieldName.equals(arroutputfield.replace("_span",""))){
				  arroutputfield = arroutputfield.replace("_span","")+suffixField+"_span";
				  arrayList.add(arroutputfield);
				}
			}else{
				if(!trgFieldName.equals(arroutputfield)){
					arroutputfield = arroutputfield+suffixField;
					arrayList.add(arroutputfield);
				}
			}
		}
	}
}
String[] arrOutputFields = (String[])arrayList.toArray(new String[arrayList.size()]);
Map mapResult = new HashMap();
mapResult.put("groupids",lstGroupIds);
mapResult.put("values",lstValues);
mapResult.put("mandField",arrInputChecks);
mapResult.put("displays", lstDisplays);
mapResult.put("clearField", arrOutputFields);

JSONObject jsonObj = JSONObject.fromObject(mapResult);
String strResult = jsonObj.toString();
out.println(strResult);

      out.write(_jsp_string1, 0, _jsp_string1.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("workflow/request/DataInputFromMobile.jsp"), 6684093096959807301L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string1;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
  }
}
