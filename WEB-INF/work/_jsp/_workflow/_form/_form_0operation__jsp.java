/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._workflow._form;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import com.weaver.formmodel.util.StringHelper;
import java.util.*;
import java.net.URLEncoder;
import weaver.hrm.*;
import weaver.systeminfo.*;
import weaver.general.*;
import ln.LN;
import weaver.hrm.settings.RemindSettings;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import weaver.workflow.workflow.TestWorkflowCheck;
import weaver.systeminfo.template.UserTemplate;
import weaver.systeminfo.setting.*;
import weaver.general.Util;
import weaver.workflow.workflow.WorkflowBillComInfo;
import java.util.regex.*;

public class _form_0operation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.conn.RecordSet rs2;
      rs2 = (weaver.conn.RecordSet) pageContext.getAttribute("rs2");
      if (rs2 == null) {
        rs2 = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs2", rs2);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.form.FormManager FormManager;
      synchronized (pageContext.getSession()) {
        FormManager = (weaver.workflow.form.FormManager) pageContext.getSession().getAttribute("FormManager");
        if (FormManager == null) {
          FormManager = new weaver.workflow.form.FormManager();
          pageContext.getSession().setAttribute("FormManager", FormManager);
        }
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.form.FormComInfo FormComInfo;
      FormComInfo = (weaver.workflow.form.FormComInfo) pageContext.getAttribute("FormComInfo");
      if (FormComInfo == null) {
        FormComInfo = new weaver.workflow.form.FormComInfo();
        pageContext.setAttribute("FormComInfo", FormComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.form.FormFieldUtil formFieldUtil;
      formFieldUtil = (weaver.workflow.form.FormFieldUtil) pageContext.getAttribute("formFieldUtil");
      if (formFieldUtil == null) {
        formFieldUtil = new weaver.workflow.form.FormFieldUtil();
        pageContext.setAttribute("formFieldUtil", formFieldUtil);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.form.FormFieldMainManager FormFieldMainManager;
      FormFieldMainManager = (weaver.workflow.form.FormFieldMainManager) pageContext.getAttribute("FormFieldMainManager");
      if (FormFieldMainManager == null) {
        FormFieldMainManager = new weaver.workflow.form.FormFieldMainManager();
        pageContext.setAttribute("FormFieldMainManager", FormFieldMainManager);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.form.FormFieldlabelMainManager FormFieldlabelMainManager;
      FormFieldlabelMainManager = (weaver.workflow.form.FormFieldlabelMainManager) pageContext.getAttribute("FormFieldlabelMainManager");
      if (FormFieldlabelMainManager == null) {
        FormFieldlabelMainManager = new weaver.workflow.form.FormFieldlabelMainManager();
        pageContext.setAttribute("FormFieldlabelMainManager", FormFieldlabelMainManager);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet RecordSet;
      RecordSet = (weaver.conn.RecordSet) pageContext.getAttribute("RecordSet");
      if (RecordSet == null) {
        RecordSet = new weaver.conn.RecordSet();
        pageContext.setAttribute("RecordSet", RecordSet);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet rs1;
      rs1 = (weaver.conn.RecordSet) pageContext.getAttribute("rs1");
      if (rs1 == null) {
        rs1 = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs1", rs1);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.field.FieldCommon fieldCommon;
      fieldCommon = (weaver.workflow.field.FieldCommon) pageContext.getAttribute("fieldCommon");
      if (fieldCommon == null) {
        fieldCommon = new weaver.workflow.field.FieldCommon();
        pageContext.setAttribute("fieldCommon", fieldCommon);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.systeminfo.label.LabelComInfo LabelComInfo;
      LabelComInfo = (weaver.systeminfo.label.LabelComInfo) pageContext.getAttribute("LabelComInfo");
      if (LabelComInfo == null) {
        LabelComInfo = new weaver.systeminfo.label.LabelComInfo();
        pageContext.setAttribute("LabelComInfo", LabelComInfo);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.workflow.workflow.BillComInfo BillComInfo;
      BillComInfo = (weaver.workflow.workflow.BillComInfo) pageContext.getAttribute("BillComInfo");
      if (BillComInfo == null) {
        BillComInfo = new weaver.workflow.workflow.BillComInfo();
        pageContext.setAttribute("BillComInfo", BillComInfo);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.conn.RecordSetTrans RecordSetTrans;
      RecordSetTrans = (weaver.conn.RecordSetTrans) pageContext.getAttribute("RecordSetTrans");
      if (RecordSetTrans == null) {
        RecordSetTrans = new weaver.conn.RecordSetTrans();
        pageContext.setAttribute("RecordSetTrans", RecordSetTrans);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.field.BrowserComInfo BrowserComInfo;
      BrowserComInfo = (weaver.workflow.field.BrowserComInfo) pageContext.getAttribute("BrowserComInfo");
      if (BrowserComInfo == null) {
        BrowserComInfo = new weaver.workflow.field.BrowserComInfo();
        pageContext.setAttribute("BrowserComInfo", BrowserComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.field.WorkflowSubwfFieldManager WorkflowSubwfFieldManager;
      WorkflowSubwfFieldManager = (weaver.workflow.field.WorkflowSubwfFieldManager) pageContext.getAttribute("WorkflowSubwfFieldManager");
      if (WorkflowSubwfFieldManager == null) {
        WorkflowSubwfFieldManager = new weaver.workflow.field.WorkflowSubwfFieldManager();
        pageContext.setAttribute("WorkflowSubwfFieldManager", WorkflowSubwfFieldManager);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.selectItem.SelectItemManager SelectItemManager;
      SelectItemManager = (weaver.workflow.selectItem.SelectItemManager) pageContext.getAttribute("SelectItemManager");
      if (SelectItemManager == null) {
        SelectItemManager = new weaver.workflow.selectItem.SelectItemManager();
        pageContext.setAttribute("SelectItemManager", SelectItemManager);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.moduledetach.ManageDetachComInfo manageDetachComInfo;
      manageDetachComInfo = (weaver.hrm.moduledetach.ManageDetachComInfo) pageContext.getAttribute("manageDetachComInfo");
      if (manageDetachComInfo == null) {
        manageDetachComInfo = new weaver.hrm.moduledetach.ManageDetachComInfo();
        pageContext.setAttribute("manageDetachComInfo", manageDetachComInfo);
      }
      out.write(_jsp_string3, 0, _jsp_string3.length);
      FormFieldlabelMainManager.resetParameter();
User user = HrmUserVarify.getUser (request , response) ;

      out.write(_jsp_string3, 0, _jsp_string3.length);
      
  boolean isoracle = (RecordSet.getDBType()).equals("oracle") ;
  boolean isdb2 = (RecordSet.getDBType()).equals("db2") ;
  boolean issqlserver = (RecordSet.getDBType()).equals("sqlserver") ;
  String appid = Util.null2String(request.getParameter("appid"));
  String ajax=Util.null2String(request.getParameter("ajax"));
  String src = Util.null2String(request.getParameter("src"));
  String fromWFCode = Util.null2String(request.getParameter("fromWFCode"));
  String dialog = Util.null2String(request.getParameter("dialog"),"1");//qyw
  String saveOrSet = Util.null2String(request.getParameter("saveOrSet"));//qyw
  int groupId=Util.getIntValue(Util.null2String(request.getParameter("groupId")),0);
  int isFromMode = Util.getIntValue(request.getParameter("isFromMode"),0);
  int tmpFormid = -1;
////\u5f97\u5230\u6807\u8bb0\u4fe1\u606f
  if(src.equalsIgnoreCase("addform")){
    //int isformadd = Util.getIntValue(request.getParameter("isformadd"));
    //System.out.println("isformadd:"+isformadd);
    //FormManager.reset();
  	//FormManager.setAction("addform");
  	//FormManager.setFormname(Util.null2String(request.getParameter("formname")));
  	//FormManager.setFormdes(Util.null2String(request.getParameter("formdes")));
  	//FormManager.setSubCompanyId2(Util.getIntValue(request.getParameter("subcompanyid"),-1) );
  	//FormManager.setFormInfo();
  	//FormComInfo.removeFormCache();
    //RecordSet.executeSql("select max(id) as id from workflow_formbase");
    //int formid=0;
    //if(RecordSet.next()){
  	//	formid = Util.getIntValue(Util.null2String(RecordSet.getString("id")),0);
  	//}
  	
  	//\u65b0\u5efa\u8868\u5355\u91c7\u7528\u4e0e\u5355\u636e\u76f8\u540c\u7684\u6a21\u5f0f TD8730 MYQ\u4fee\u6539
  	int formid = -1;
	tmpFormid = formid;
  	//System.out.println("formid=="+formid);
  	String from = Util.null2String(request.getParameter("from"));
  	String formname = Util.null2String(request.getParameter("formname"));
  	formname = formname.replaceAll("<","\uff1c").replaceAll(">","\uff1e").replaceAll("'","''");
  	formname = Util.toHtmlForSplitPage(formname);
  	//\u540c\u540d\u9a8c\u8bc1 \u5f00\u59cb TD10194
  	boolean issamename = false;
  	RecordSet.executeSql("select namelabel from workflow_bill");
  	
    while(RecordSet.next()){//\u65b0\u8868\u5355\u540d\u548c\u5355\u636e\u540d
  	    int namelabel = Util.getIntValue(Util.null2String(RecordSet.getString("namelabel")),0);
  	    if(namelabel!=0)
  	    {
  	        if(formname.equals(SystemEnv.getHtmlLabelName(namelabel,user.getLanguage())))
  	        {
  	            issamename = true;
  	            break;
  	        }
  	    }
  	}
  	RecordSet.executeSql("select formname from workflow_formbase");
    while(RecordSet.next()){//\u65e7\u8868\u5355\u540d
  	    String tempformname = Util.null2String(RecordSet.getString("formname"));
  	    if(!tempformname.equals(""))
  	    {
  	        if(formname.equals(tempformname))
  	        {
  	            issamename = true;
  	            break;
  	        }
  	    }
  	}
  	if(issamename){
  	    if(from.equals("addDefineForm")){
  	        response.sendRedirect("/workflow/form/addform.jsp?from=addDefineForm&message=issamename&isFromMode="+isFromMode+"&ajax="+ajax+"&dialog="+dialog+"&appid="+appid);//gzt update TD27194
  	        return;
  	    }else{
  	        response.sendRedirect("/workflow/form/editform.jsp?message=issamename&isFromMode="+isFromMode+"&ajax="+ajax+"&dialog="+dialog);//gzt update TD27194
  	        return;
  	    }
  	}
  	//\u540c\u540d\u9a8c\u8bc1 \u7ed3\u675f TD10194
	
  	String formdes = Util.null2String(request.getParameter("formdes"));
  	formdes = formdes.replaceAll("<","\uff1c").replaceAll(">","\uff1e").replaceAll("'","''");
  	formdes = Util.toHtmlForSplitPage(formdes);
  	int subcompanyid = Util.getIntValue(request.getParameter("subcompanyid"),-1);
  	int subCompanyId3 = Util.getIntValue(request.getParameter("subcompanyid3"),-1);
  	formid = FormManager.getNewFormId();
  	String formtable_main;
  	if(isFromMode == 1){	//\u8bf7\u6c42\u6765\u81ea\u8868\u5355\u5efa\u6a21
  		formtable_main = "uf_" + Util.null2String(request.getParameter("tablename"));
		if(from.equals("addDefineForm")){ //\u9a8c\u8bc1\u6570\u636e\u5e93\u8868\u540d\u662f\u5426\u5b58\u653e(\u540e\u53f0\u9a8c\u8bc1\uff0c\u9632\u6b62\u76f8\u540c\u9875\u9762\u540c\u65f6\u63d0\u4ea4)
	  		boolean tableISExists = FormManager.isHaveSameTableInDB(formtable_main);
	  		if(tableISExists){
	  			response.sendRedirect("/workflow/form/addDefineForm.jsp?message=issametablename&isFromMode="+isFromMode+"&ajax="+ajax+"&dialog="+dialog);
	  			return;
	  		}
		}
  	}else{
  		formtable_main = "formtable_main_"+formid*(-1);
  	}
  	if(formid<-1){
  		boolean success = false;
  		//String formtable_main = "formtable_main_"+formid*(-1);//\u4e3b\u8868\u540d
  		formname = formname.replaceAll("<","\uff1c").replaceAll(">","\uff1e");
  		//String formtable_detail = "formtable_detail_"+formid;//\u660e\u7ec6\u8868\u540d
  		RecordSetTrans.setAutoCommit(false);
  		try{
		  	int namelabelid = -1;
		  	if(issqlserver) RecordSetTrans.executeSql("select indexid from HtmlLabelInfo where labelname='"+formname+"' collate Chinese_PRC_CS_AI and languageid="+Util.getIntValue(""+user.getLanguage(),7));
		  	else RecordSetTrans.executeSql("select indexid from HtmlLabelInfo where labelname='"+formname+"' and languageid="+Util.getIntValue(""+user.getLanguage(),7));
		  	if(RecordSetTrans.next()) namelabelid = RecordSetTrans.getInt("indexid");//\u5982\u679c\u8868\u5355\u540d\u79f0\u5728\u6807\u7b7e\u5e93\u4e2d\u5b58\u5728\uff0c\u53d6\u5f97\u6807\u7b7eid
		  	else{
		  		namelabelid = FormManager.getNewIndexId(RecordSetTrans);//\u751f\u6210\u65b0\u7684\u6807\u7b7eid
			  	if(namelabelid!=-1){//\u66f4\u65b0\u6807\u7b7e\u5e93
			  		RecordSetTrans.executeSql("delete from HtmlLabelIndex where id="+namelabelid);
			  		RecordSetTrans.executeSql("delete from HtmlLabelInfo where indexid="+namelabelid);
			  		RecordSetTrans.executeSql("INSERT INTO HtmlLabelIndex values("+namelabelid+",'"+formname+"')");
			  		RecordSetTrans.executeSql("INSERT INTO HtmlLabelInfo values("+namelabelid+",'"+formname+"',7)");
			  		RecordSetTrans.executeSql("INSERT INTO HtmlLabelInfo values("+namelabelid+",'"+formname+"',8)");
			  		RecordSetTrans.executeSql("INSERT INTO HtmlLabelInfo values("+namelabelid+",'"+formname+"',9)");
			  	}
			  }
		  	//\u4e0d\u7ba1\u662f\u6d41\u7a0b\u8fd8\u662f\u5efa\u6a21\u65b0\u5efa\u7684\u8868\u5355\u4fdd\u8bc1subCompanyId3\u548csubcompanyid\u4e00\u81f4\u4e3a\u9875\u9762\u4e0a\u8bbe\u7f6e\u7684\u673a\u6784
		  	if(subcompanyid!=-1){
		  		subCompanyId3 = subcompanyid;
		  	}else if(subCompanyId3!=-1&&subCompanyId3!=0){
		  		subcompanyid = subCompanyId3;
		  	}else{
		  	if(subcompanyid==-1){//\u5206\u6743\u5206\u90e8\u7684\u53d6\u5f97\u3002\u5982\u679c\u9875\u9762\u6ca1\u6709\uff0c\u5219\u9996\u5148\u4ece\u5206\u6743\u8bbe\u7f6e\u7684\u9ed8\u8ba4\u673a\u6784\u53d6\u5f97\uff0c\u5982\u679c\u9ed8\u8ba4\u673a\u6784\u6ca1\u6709\u8bbe\u7f6e\u5219\u53d6\u6240\u6709\u5206\u90e8\u4e2did\u6700\u5c0f\u7684\u90a3\u4e2a\u5206\u90e8\u3002
		  		//RecordSetTrans.executeSql("select dftsubcomid from SystemSet");
		  		//if(RecordSetTrans.next()) subcompanyid = Util.getIntValue(RecordSetTrans.getString("dftsubcomid"),-1);
		  		
		  		subcompanyid = Util.getIntValue(manageDetachComInfo.getWfdftsubcomid(), -1);
		  		
		  		if(subcompanyid==-1){
		  			RecordSetTrans.executeSql("select min(id) as id from HrmSubCompany");
		  			if(RecordSetTrans.next()) subcompanyid = RecordSetTrans.getInt("id");
		  		}
		  	}
		  	
		  	
			if(subCompanyId3==-1||subCompanyId3==0){//\u5206\u6743\u5206\u90e8\u7684\u53d6\u5f97\u3002\u5982\u679c\u9875\u9762\u6ca1\u6709\uff0c\u5219\u9996\u5148\u4ece\u5206\u6743\u8bbe\u7f6e\u7684\u9ed8\u8ba4\u673a\u6784\u53d6\u5f97\uff0c\u5982\u679c\u9ed8\u8ba4\u673a\u6784\u6ca1\u6709\u8bbe\u7f6e\u5219\u53d6\u6240\u6709\u5206\u90e8\u4e2did\u6700\u5c0f\u7684\u90a3\u4e2a\u5206\u90e8\u3002
		  		//RecordSetTrans.executeSql("select fmdftsubcomid,dftsubcomid from SystemSet");
		  		//if(RecordSetTrans.next()){
		  		//	subCompanyId3 = Util.getIntValue(RecordSetTrans.getString("fmdftsubcomid"),-1);
		  		//	if(subCompanyId3==-1||subCompanyId3==0){
		  		//		subCompanyId3 = Util.getIntValue(RecordSetTrans.getString("dftsubcomid"),-1);
		  		//	}
		  		//}
		  		subCompanyId3 = Util.getIntValue(manageDetachComInfo.getWfdftsubcomid(), -1);
		  		if(subCompanyId3==-1||subCompanyId3==0){
		  			RecordSetTrans.executeSql("select min(id) as id from HrmSubCompany");
		  			if(RecordSetTrans.next()) subCompanyId3 = RecordSetTrans.getInt("id");
		  		}
		  	}
			if(isFromMode == 1){
				RecordSetTrans.executeSql("select fmdetachable,fmdftsubcomid,dftsubcomid from SystemSet");
		  		if(RecordSetTrans.next()){
		  			int fmdetachable = Util.getIntValue(RecordSetTrans.getString("fmdetachable"),0);
		  			if(fmdetachable == 1){
				  		subCompanyId3 = Util.getIntValue(RecordSetTrans.getString("fmdftsubcomid"),-1);
				  		if(subCompanyId3==-1||subCompanyId3==0){
				  			subCompanyId3 = Util.getIntValue(RecordSetTrans.getString("dftsubcomid"),-1);
			  			}
		  			}else{
		  				subCompanyId3 = -1;
		  			}
				}
			}
		  	}
  			RecordSetTrans.executeSql("insert into workflow_bill(id,namelabel,tablename,detailkeyfield,formdes,subcompanyid,subCompanyId3) values("+formid+","+namelabelid+",'"+formtable_main+"','mainid','"+formdes+"',"+subcompanyid+","+subCompanyId3+")");
  			String dbType = RecordSet.getDBType();
  			if("oracle".equals(dbType)){//\u521b\u5efa\u8868\u5355\u4e3b\u8868\uff0c\u660e\u7ec6\u8868\u7684\u521b\u5efa\u5728\u65b0\u5efa\u5b57\u6bb5\u7684\u65f6\u5019\u5982\u679c\u6709\u660e\u7ec6\u5b57\u6bb5\u5219\u521b\u5efa\u660e\u7ec6\u8868
	  			RecordSetTrans.executeSql("create table " + formtable_main + "(id integer primary key not null, requestId integer)");
	  			//RecordSetTrans.executeSql("create sequence "+formtable_main+"_Id start with 1 increment by 1 nomaxvalue nocycle");
	  			//RecordSetTrans.executeSql("CREATE OR REPLACE TRIGGER "+formtable_main+"_Id_Trigger before insert on "+formtable_main+" for each row begin select "+formtable_main+"_Id.nextval into :new.id from dual; end;");
	  		}else{
	  			RecordSetTrans.executeSql("create table " + formtable_main + "(id int IDENTITY(1,1) primary key CLUSTERED, requestId integer)");
	  		}
	  		if(!StringHelper.isEmpty(appid)){
	  			RecordSetTrans.executeSql("insert into AppFormInfo(appid,formid)values("+appid+","+formid+")");
	  		}
  			RecordSetTrans.commit();
  			if("oracle".equals(dbType)){//\u4e3b\u8868id\u81ea\u589e\u957f
	  			RecordSet.executeSql("create sequence "+formtable_main+"_Id start with 1 increment by 1 nomaxvalue nocycle nocache");
	  			RecordSet.setChecksql(false);
	  			RecordSet.executeSql("CREATE OR REPLACE TRIGGER "+formtable_main+"_Id_Trigger before insert on "+formtable_main+" for each row begin select "+formtable_main+"_Id.nextval into :new.id from dual; end;");
	  		}
			  LabelComInfo.addLabeInfoCache(""+namelabelid);//\u5f80\u7f13\u5b58\u4e2d\u6dfb\u52a0\u8868\u5355\u540d\u79f0\u7684\u6807\u7b7e
			  BillComInfo.addBillCache(""+formid);
			  WorkflowBillComInfo workflowBillComInfo=new WorkflowBillComInfo();
			  workflowBillComInfo.addWorkflowBillCache(String.valueOf(formid));
			  
			  //System.out.println("test:"+from+";dialog:"+dialog+";saveOrSet:"+saveOrSet);
			  if(from.equals("addDefineForm")){
				if("1".equals(dialog) && "0".equals(saveOrSet)){
  				 response.sendRedirect("/workflow/form/addform.jsp?isadd=false&formid="+formid+"&isFromMode="+isFromMode+"&ajax="+ajax+"&isclose=1");
  			    }else if("1".equals(dialog) && "1".equals(saveOrSet)){
  				 response.sendRedirect("/workflow/form/addform.jsp?isadd=true&formid="+formid+"&isFromMode="+isFromMode+"&ajax="+ajax+"&isclose=1");
  			    }
			  }else{ 
  				response.sendRedirect("/workflow/form/editform.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax="+ajax);
  			  }
			 
			  success = true;
  		}catch(Exception exception){
			success = false;
			  RecordSetTrans.rollback();
		  }
  		//TD10835 \u6839\u636e\u5df2\u6709\u8868\u5355\u65b0\u5efa\u8868\u5355\uff0c\u9700\u8981\u628a\u539f\u8868\u5355\u7684\u4fe1\u606f\u590d\u5236\u8fc7\u6765 chujun
  		if(success == true){//\u5982\u679c\u4e0a\u9762\u5931\u8d25\u4e86\uff0c\u5c31\u4e0d\u8981\u4e0b\u9762\u7684\u64cd\u4f5c\u4e86
	  		int oldformid = Util.getIntValue(request.getParameter("oldformid"), 0);
	  		if(oldformid != 0){
	  			int detachable=Util.getIntValue(String.valueOf(session.getAttribute("detachable")),0);
	  			FormManager.setFormInfoByTemplate(formid, oldformid);
	  		}
  		}
  		if(issqlserver){//\u56e0\u4e3a\u5728sql\u91cc\u9762detailtable\u7684\u9ed8\u8ba4\u503cNULL\uff0c\u663e\u793a\u6392\u5e8f\u7684\u65f6\u5019\u6309\u7167detailtable\u6392\u5e8f\uff0c\u5f53detailtable\u6709\u7a7a\u503c\u548cnull\u65f6\uff0c\u6392\u5e8f\u4f1a\u4e71
  			RecordSet.executeSql("update workflow_billfield set detailtable = '' where detailtable is null");
  		}
  	}
  	//\u65b0\u5efa\u8868\u5355\u91c7\u7528\u4e0e\u5355\u636e\u76f8\u540c\u7684\u6a21\u5f0f TD8730 MYQ\u4fee\u6539
    //response.sendRedirect("/workflow/form/editform.jsp?src=editform&formid="+formid+"&ajax="+ajax+"&isformadd="+isformadd);

  }
  else if(src.equalsIgnoreCase("editform")){
  	int formid=Util.getIntValue(Util.null2String(request.getParameter("formid")),0);
	tmpFormid = formid;
	String formname = request.getParameter("formname").replaceAll("<","\uff1c").replaceAll(">","\uff1e").replaceAll("'","''");
	boolean issamename = false;
  	RecordSet.executeSql("select namelabel from workflow_bill where id !="+formid);
    while(RecordSet.next()){//\u65b0\u8868\u5355\u540d\u548c\u5355\u636e\u540d
  	    int namelabel = Util.getIntValue(Util.null2String(RecordSet.getString("namelabel")),0);
  	    if(namelabel!=0)
  	    {
  	        if(formname.equals(SystemEnv.getHtmlLabelName(namelabel,user.getLanguage())))
  	        {
  	            issamename = true;
  	            break;
  	        }
  	    }
  	}
  	RecordSet.executeSql("select formname from workflow_formbase where id !="+formid);
    while(RecordSet.next()){//\u65e7\u8868\u5355\u540d
  	    String tempformname = Util.null2String(RecordSet.getString("formname"));
  	    if(!tempformname.equals(""))
  	    {
  	        if(formname.equals(tempformname))
  	        {
  	            issamename = true;
  	            break;
  	        }
  	    }
  	}
    String isoldform = Util.null2String(request.getParameter("isoldform"));
  	if(issamename){
  		response.sendRedirect("/workflow/form/addform.jsp?src=editform&formid="+formid+"&isFromMode="+isFromMode+"&ajax="+ajax+"&message=issamename&isoldform="+isoldform);
	    return;
  	}
	FormManager.reset();
  	FormManager.setAction("editform");
  	FormManager.setFormid(formid);
  	FormManager.setFormname(Util.null2String(formname));
  	String formdes = request.getParameter("formdes").replaceAll("<","\uff1c").replaceAll(">","\uff1e").replaceAll("'","''");
  	FormManager.setFormdes( Util.null2String(formdes));
    FormManager.setSubCompanyId2(Util.getIntValue(request.getParameter("subcompanyid"),-1) );
    FormManager.setSubCompanyId3(Util.getIntValue(request.getParameter("subcompanyid3"),-1) );
  	FormManager.setFormInfo();
  	FormComInfo.removeFormCache();
    response.sendRedirect("/workflow/form/addform.jsp?src=editform&formid="+formid+"&isFromMode="+isFromMode+"&ajax="+ajax+"&isoldform="+isoldform);

  }
  else if(src.equalsIgnoreCase("formfield")){
  	//\u8001\u8868\u5355\u7684\u5b57\u6bb5\u7ba1\u7406\u6dfb\u52a0\u96c6\u6210\u591a\u9009\u6d4f\u89c8\u6309\u94aezzl
  	int formid=Util.getIntValue(Util.null2String(request.getParameter("formid")),0);
  	int sapclos=Util.getIntValue(Util.null2String(request.getParameter("sapclos")),0);//\u8bb0\u5f55\u6dfb\u52a0\u8fc7\u7684\u660e\u7ec6\u8868\u7684\u4e2a\u6570
	tmpFormid = formid;
	FormFieldMainManager.resetParameter();
    FormFieldMainManager.setGroupId(groupId);
	FormFieldMainManager.setFormid(formid);
	
	  String[] mulId;  
	  String ids=Util.null2String(request.getParameter("formfields"));//added by xwj for td3325 20051205
	  String ids2=Util.null2String(request.getParameter("formfields2"));//added by xwj for td3325 20051205
	  String mulIds=""; 
	   //\u65b0\u589e\u591a\u660e\u7ec6 by ben 2006-04-27
	  int rownum=Util.getIntValue(request.getParameter("rownum"),0);
	 
	for(int i = 0; i < rownum; i++)
	{
	    mulId = request.getParameterValues("destListMul" + i);
	      
	    if (mulId != null)
	    {
	    	for (int j = 0; j < mulId.length; j++)
	    	{ 
	    		mulIds += mulId[j];
	    		mulIds += ",";
	    	}
	    }
	}
	
	if(FormFieldMainManager.checkByRef(Util.null2String(request.getParameter("formfields")),mulIds+Util.null2String(request.getParameter("formfields2")))){
	        response.sendRedirect("/workflow/form/addformfield.jsp?formid="+formid+"&errorcode=1&isFromMode="+isFromMode+"&ajax="+ajax);
	        return;
	    }

	if(WorkflowSubwfFieldManager.hasSubWfSettingForForm(","+Util.null2String(request.getParameter("formfields"))+","+mulIds+Util.null2String(request.getParameter("formfields2")),formid,0)){
		response.sendRedirect("/workflow/form/addformfield.jsp?formid="+formid+"&errorcode=2&isFromMode="+isFromMode+"&ajax="+ajax);
	    return;
	}

    //fieldCommon.initNewFieldIsView(""+formid,Util.TokenizerString2(ids,","),Util.TokenizerString2(ids2,","));//added by xwj for td3325 20051205
    
	FormFieldMainManager.deleteFormfield();
	//delete by  by xwj for td3325 20051205
	FormFieldMainManager.saveFormfield(Util.TokenizerString2(ids,","));
    //begin \u738b\u91d1\u6c38 add
    
    FormFieldMainManager.deleteDetailFormfield();
   //delete by  xwj for td3325 20051205
    FormFieldMainManager.setGroupId(0);
	FormFieldMainManager.saveDetailFormfield(Util.TokenizerString2(ids2,","));
	//System.out.println("\u4e3b\u8868\u4e0b\u7684\u660e\u7ec6\u8868\u7684"+ids2);
	String mul01=Util.null2String(request.getParameter("newsapmultiBrowservalue_0" ));
	if(!"".equals(mul01)){
		RecordSet.execute("select * from sap_multiBrowser where mxformname='0' and mxformid='"+formid+"'");
		if(!RecordSet.next()){
			RecordSet.execute(" insert  into  sap_multiBrowser (mxformname,mxformid,browsermark,isbill) values('0','"+formid+"','"+mul01+"','0')");
		}
	}
    //end
    
     //\u5148\u5220\u9664\uff0c\u518d\u6dfb\u52a0
    RecordSet.execute("delete   sap_multiBrowser where mxformid='"+formid+"' and mxformname!='0' and isbill=0");
    
    List listsap=new ArrayList();
    //\u65b0\u589e\u591a\u660e\u7ec6 by ben 2006-04-27
    //int rownum=Util.getIntValue(request.getParameter("rownum"),0);
    for(int i = 0; i < rownum; i++)
    { 
    	mulId = request.getParameterValues("destListMul" + i);
    
    	if (mulId != null)
    	{
    		String[] temp;
    		temp=request.getParameterValues("null");
    		//fieldCommon.initNewFieldIsView("" + formid, temp, mulId);
    		FormFieldMainManager.setGroupId(i + 1);
    		listsap.add((i + 1));//\u8bb0\u5f55\u6709\u6548\u7684\u660e\u7ec6\u8868\u7684id
			FormFieldMainManager.saveDetailFormfield(mulId);			
		}else{
			listsap.add("");//\u8bb0\u5f55\u65e0\u6548\u7684\u660e\u7ec6\u8868\u7684id
		}
    }
    int tempsap=0;
    if(listsap.size()>0){
	    for(int i=1;i<sapclos;i++){
	  			String mul=Util.null2String(request.getParameter("newsapmultiBrowservalue_" + i));
	  			if(!"".equals(mul)&&tempsap<listsap.size()){
	  					if(!"".equals(listsap.get(tempsap))){
							RecordSet.execute(" insert  into  sap_multiBrowser (mxformname,mxformid,browsermark,isbill) values('"+listsap.get(tempsap)+"','"+formid+"','"+mul+"','0')");
							
						}
				}
				tempsap++;
	    }
    }
    
    fieldCommon.initNewFieldIsView("" + formid, Util.TokenizerString2(ids, ","), Util.TokenizerString2(ids2 + mulIds, ","));
    
    //\u6e05\u9664\u88ab\u5220\u9664\u5b57\u6bb5\u7684\u8282\u70b9\u5b57\u6bb5\u4fe1\u606f
    FormFieldMainManager.deleteNodefield();
	response.sendRedirect("/workflow/form/addformfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax="+ajax);
	
 	
  }
  else if(src.equalsIgnoreCase("formfieldlabel")){
  	int formid=Util.getIntValue(Util.null2String(request.getParameter("formid")),0);
	tmpFormid = formid;
  	ArrayList fields = new ArrayList();
  	ArrayList idarray = new ArrayList();

	FormFieldlabelMainManager.resetParameter();
	FormFieldlabelMainManager.setFormid(formid);
	//FormFieldlabelMainManager.deleteFormfield();
	String ids=Util.null2String(request.getParameter("formfieldlabels"));
	if(!ids.equals("")){  //add by king for formfieldlabels is null
		int defaultlang=Util.getIntValue(Util.null2String(request.getParameter("isdefault")));
		idarray = Util.TokenizerString(ids,",");

		if(defaultlang==-1) defaultlang = user.getLanguage();//TD14315

		FormFieldMainManager.setFormid(formid);
		FormFieldMainManager.selectAllFormField();
		while(FormFieldMainManager.next()){
			int curid=FormFieldMainManager.getFieldid();
			fields.add(""+curid);
		}
		for(int i=0;i<idarray.size();i++) {
			int languageid = Util.getIntValue((String)idarray.get(i),0);
			String isdef = "0";
			if( languageid < 1)
				break;
			if(languageid == defaultlang)
				isdef = "1";
			for(int j=0; j< fields.size();j++) {
				String tfieldid=(String)fields.get(j);
				int fieldid = Util.getIntValue(tfieldid,0);
				FormFieldlabelMainManager.resetParameter();
				FormFieldlabelMainManager.setFormid(formid);
				FormFieldlabelMainManager.setFieldid(fieldid);
				FormFieldlabelMainManager.setLanguageid(languageid);
				String label = request.getParameter("label_"+languageid+"_"+fieldid);
				if(label == null){
					break;
                }
				label = Util.StringReplace(label, "\"", "");//TD10108 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u53cc\u5f15\u53f7\u201c"\u201d
				label = Util.StringReplace(label, "'", "");//TD31514 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u5355\u5f15\u53f7\u201c'\u201d
				FormFieldlabelMainManager.setFieldlabel(label);
				FormFieldlabelMainManager.setIsdefault(isdef);
				FormFieldlabelMainManager.saveFormfieldlabel();
			}
		}
	}

	response.sendRedirect("/workflow/form/addformfieldlabel.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax="+ajax);
  }
  else if (src.equalsIgnoreCase("formfielddetail"))
  {
    int formid=Util.getIntValue(Util.null2String(request.getParameter("formid")),0);
	tmpFormid = formid;
	String ids2=Util.null2String(request.getParameter("formfields2"));
	groupId=Util.getIntValue(Util.null2String(request.getParameter("groupId")),1);
	FormFieldMainManager.resetParameter();
    FormFieldMainManager.setGroupId(groupId);
	FormFieldMainManager.setFormid(formid);
	 FormFieldMainManager.deleteDetailFormfield();
   //delete by  xwj for td3325 20051205
	FormFieldMainManager.saveDetailFormfield(Util.TokenizerString2(ids2,","));
	response.sendRedirect("/workflow/form/addformfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax="+ajax);
    return;
}else if(src.equals("eidtform")){
	String formname = Util.null2String(request.getParameter("formname"));
	String formid = Util.null2String(request.getParameter("formid"));
  	formname = formname.replaceAll("<","\uff1c").replaceAll(">","\uff1e").replaceAll("'","''");
	formname = Util.toHtmlForSplitPage(formname);
  		boolean issamename = false;
  	RecordSet.executeSql("select namelabel from workflow_bill where id !="+formid);
    while(RecordSet.next()){//\u65b0\u8868\u5355\u540d\u548c\u5355\u636e\u540d
  	    int namelabel = Util.getIntValue(Util.null2String(RecordSet.getString("namelabel")),0);
  	    if(namelabel!=0)
  	    {
  	        if(formname.equals(SystemEnv.getHtmlLabelName(namelabel,user.getLanguage())))
  	        {
  	            issamename = true;
  	            break;
  	        }
  	    }
  	}
  	RecordSet.executeSql("select formname from workflow_formbase where id !="+formid);
    while(RecordSet.next()){//\u65e7\u8868\u5355\u540d
  	    String tempformname = Util.null2String(RecordSet.getString("formname"));
  	    if(!tempformname.equals(""))
  	    {
  	        if(formname.equals(tempformname))
  	        {
  	            issamename = true;
  	            break;
  	        }
  	    }
  	}
  	if(issamename){
  		response.sendRedirect("/workflow/form/editform.jsp?ajax=1&formid="+formid+"&isFromMode="+isFromMode+"&message=issamename");
	    return;
  	}
  	int namelabelid = -1;
  	if(issqlserver) RecordSet.executeSql("select indexid from HtmlLabelInfo where labelname='"+formname+"' collate Chinese_PRC_CS_AI and languageid="+Util.getIntValue(""+user.getLanguage(),7));
		else RecordSet.executeSql("select indexid from HtmlLabelInfo where labelname='"+formname+"' and languageid="+Util.getIntValue(""+user.getLanguage(),7));
		if(RecordSet.next()) namelabelid = RecordSet.getInt("indexid");//\u5982\u679c\u8868\u5355\u540d\u79f0\u5728\u6807\u7b7e\u5e93\u4e2d\u5b58\u5728\uff0c\u53d6\u5f97\u6807\u7b7eid
		else{
			namelabelid = FormManager.getNewIndexId(RecordSetTrans);//\u751f\u6210\u65b0\u7684\u6807\u7b7eid
			if(namelabelid!=-1){//\u66f4\u65b0\u6807\u7b7e\u5e93
				RecordSet.executeSql("delete from HtmlLabelIndex where id="+namelabelid);
				RecordSet.executeSql("delete from HtmlLabelInfo where indexid="+namelabelid);
				RecordSet.executeSql("INSERT INTO HtmlLabelIndex values("+namelabelid+",'"+formname+"')");
				RecordSet.executeSql("INSERT INTO HtmlLabelInfo values("+namelabelid+",'"+formname+"',7)");
				RecordSet.executeSql("INSERT INTO HtmlLabelInfo values("+namelabelid+",'"+formname+"',8)");
				RecordSet.executeSql("INSERT INTO HtmlLabelInfo values("+namelabelid+",'"+formname+"',9)");
			}
		}
		LabelComInfo.addLabeInfoCache(""+namelabelid);//\u5f80\u7f13\u5b58\u4e2d\u6dfb\u52a0\u8868\u5355\u540d\u79f0\u7684\u6807\u7b7e
		BillComInfo.addBillCache(formid,namelabelid);
			  
  	String formdes = Util.null2String(request.getParameter("formdes"));
  	formdes = formdes.replaceAll("<","\uff1c").replaceAll(">","\uff1e").replaceAll("'","''");
  	formdes = Util.toHtmlForSplitPage(formdes);
  	int subcompanyid = Util.getIntValue(request.getParameter("subcompanyid"),-1);
  	int subCompanyId3 = Util.getIntValue(request.getParameter("subcompanyid3"),-1);
  	if(subcompanyid==-1){//\u5206\u6743\u5206\u90e8\u7684\u53d6\u5f97\u3002\u5982\u679c\u9875\u9762\u6ca1\u6709\uff0c\u5219\u9996\u5148\u4ece\u5206\u6743\u8bbe\u7f6e\u7684\u9ed8\u8ba4\u673a\u6784\u53d6\u5f97\uff0c\u5982\u679c\u9ed8\u8ba4\u673a\u6784\u6ca1\u6709\u8bbe\u7f6e\u5219\u53d6\u6240\u6709\u5206\u90e8\u4e2did\u6700\u5c0f\u7684\u90a3\u4e2a\u5206\u90e8\u3002
			RecordSet.executeSql("select dftsubcomid from SystemSet");
			if(RecordSetTrans.next()) subcompanyid = Util.getIntValue(RecordSet.getString("dftsubcomid"),-1);
			if(subcompanyid==-1){
		  	RecordSet.executeSql("select min(id) as id from HrmSubCompany");
		  	if(RecordSet.next()) subcompanyid = RecordSet.getInt("id");
			}
		}
  	
  	if(subCompanyId3==-1){//\u5206\u6743\u5206\u90e8\u7684\u53d6\u5f97\u3002\u5982\u679c\u9875\u9762\u6ca1\u6709\uff0c\u5219\u9996\u5148\u4ece\u5206\u6743\u8bbe\u7f6e\u7684\u9ed8\u8ba4\u673a\u6784\u53d6\u5f97\uff0c\u5982\u679c\u9ed8\u8ba4\u673a\u6784\u6ca1\u6709\u8bbe\u7f6e\u5219\u53d6\u6240\u6709\u5206\u90e8\u4e2did\u6700\u5c0f\u7684\u90a3\u4e2a\u5206\u90e8\u3002
  		RecordSetTrans.executeSql("select fmdftsubcomid,dftsubcomid from SystemSet");
  		if(RecordSetTrans.next()){
  			subCompanyId3 = Util.getIntValue(RecordSetTrans.getString("fmdftsubcomid"),-1);
  			if(subCompanyId3==-1){
  				subCompanyId3 = Util.getIntValue(RecordSetTrans.getString("dftsubcomid"),-1);
  			}
  		}
  		if(subCompanyId3==-1){
  			RecordSetTrans.executeSql("select min(id) as id from HrmSubCompany");
  			if(RecordSetTrans.next()) subCompanyId3 = RecordSetTrans.getInt("id");
  		}
  	}
  	RecordSet.executeSql("update workflow_bill set subcompanyid="+subcompanyid+",subcompanyid3="+subCompanyId3+", namelabel="+namelabelid+",formdes='"+formdes+"' where id="+formid);
  	response.sendRedirect("/workflow/form/editform.jsp?ajax=1&isFromMode="+isFromMode+"&formid="+formid);
}else if(src.equals("addfieldbatch")){
	//\u6279\u91cf\u6dfb\u52a0\u5b57\u6bb5
  	char flag=2;
  	RecordSetTrans.setAutoCommit(false);
  	boolean modifyFieldtypeSuccess = true;	//\u72b6\u6001\u53d8\u91cf(\u5224\u65ad\u4fee\u6539\u5b57\u6bb5\u65f6\u4fee\u6539\u5b57\u6bb5\u7c7b\u578b\u662f\u5426\u6210\u529f)
  	
  	int formid = Util.getIntValue((request.getParameter("formid")),0);//\u8868\u5355id
  	
  	try{
	tmpFormid = formid;
	String maintablename = FormManager.getTablename(formid); //\u4e3b\u8868\u540d
  	//String maintablename = "formtable_main_"+formid*(-1);//\u4e3b\u8868\u540d
  	int recordNum = Util.getIntValue(Util.null2String(request.getParameter("recordNum")),0);//\u5b57\u6bb5\u884c\u6570
  	String delids = Util.null2String(request.getParameter("delids"));//\u5220\u9664\u884cid\u96c6
  	String changeRowIndexs = Util.null2String(request.getParameter("changeRowIndexs"));//\u6709\u6539\u53d8\u7684\u884cid\u96c6
  	String labelidsCache = ",";//\u66f4\u65b0\u7f13\u5b58\u7528
  	String jumpRowindex = Util.null2String(request.getParameter("jumpRowindex"));
  	int jumpfieldid = 0;
  	
  	Map<String,String> field_pubchoice_map = new LinkedHashMap<String,String>();
	Map<String,String> field_pubchilchoice_map = new LinkedHashMap<String,String>();
  	
  	//\u4e3b\u5b57\u6bb5 \u5f00\u59cb
  	ArrayList delidsArray = Util.TokenizerString(delids,",");
  	//\u5220\u9664\u6307\u5b9a\u7684\u5b57\u6bb5
  	for(int i=0;i<delidsArray.size();i++){
  		String fieldnameForDel = "";
  		String delFieldId = (String)delidsArray.get(i);
		//\u5982\u679c\u4e3b\u5b57\u6bb5\u88ab\u5217\u89c4\u5219\u5f15\u7528\uff0c\u5219\u9000\u51fa\u3002
		RecordSetTrans.executeSql("select * from workflow_formdetailinfo where maincalstr like '%!_"+delFieldId+"_%' escape '!' or maincalstr like '%!_"+delFieldId+"' escape '!'");
		if(RecordSetTrans.next()){
		    RecordSetTrans.rollback();
		    response.sendRedirect("/workflow/form/editformfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0&message=nodelete");
		    return;
		}

          if(WorkflowSubwfFieldManager.hasSubWfSetting(RecordSetTrans,Util.getIntValue(delFieldId,0),1)){
		    RecordSetTrans.rollback();
		    response.sendRedirect("/workflow/form/editformfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0&message=nodeleteForSubWf");
		    return;
		}

  		RecordSetTrans.executeSql("select fieldname from workflow_billfield where id="+delFieldId);
  		if(RecordSetTrans.next()) fieldnameForDel = RecordSetTrans.getString("fieldname");//\u53d6\u5f97\u5b57\u6bb5\u540d
  		RecordSetTrans.executeSql("delete from workflow_billfield where id="+delFieldId);//\u5220\u9664\u5b57\u6bb5
  		RecordSetTrans.execute("update workflow_billfield set childfieldid=0 where childfieldid="+delFieldId);//\u5982\u679c\u88ab\u5220\u9664\u5b57\u6bb5\u662f\u5b50\u5b57\u6bb5\uff0c\u5219\u9700\u8981\u4fee\u6539
  		RecordSetTrans.executeSql("alter table "+maintablename+" drop column "+fieldnameForDel);//\u4fee\u6539\u8868\u7ed3\u6784
  		RecordSetTrans.executeSql("delete from workflow_SelectItem where isbill=1 and fieldid="+delFieldId);//\u5220\u9664\u8868workflow_SelectItem\u4e2d\u8be5\u5b57\u6bb5\u5bf9\u5e94\u6570\u636e
  		RecordSetTrans.executeSql("delete from workflow_specialfield where isbill=1 and fieldid="+delFieldId);//\u5220\u9664\u8868workflow_specialfield\u4e2d\u8be5\u5b57\u6bb5\u5bf9\u5e94\u6570\u636e
  		
		//\u5220\u9664\u4e0e\u8be5\u5b57\u6bb5\u76f8\u5173\u7684\u51fa\u53e3\u6761\u4ef6
		Pattern mpattern = null;
		Matcher mmatcher = null;
		String partStr = "\\b"+fieldnameForDel+"\\b";
		mpattern = Pattern.compile(partStr);
		ArrayList nodelinkidList = new ArrayList();
		ArrayList conditionList = new ArrayList();
			
		String strSql = "select * from workflow_nodelink where condition like '%"+fieldnameForDel+"%' and workflowid in (select id from workflow_base where formid="+formid+")";
		weaver.conn.ConnStatement statement=new weaver.conn.ConnStatement();
		weaver.conn.RecordSet rs = new weaver.conn.RecordSet();
		String docContent = "";
		statement.setStatementSql(strSql, false);
		statement.executeQuery();
		if(statement.next()){
			if(statement.getDBType().equals("oracle"))
			{
				oracle.sql.CLOB theclob = statement.getClob("condition"); 
				String readline = "";
				StringBuffer clobStrBuff = new StringBuffer("");
				java.io.BufferedReader clobin = new java.io.BufferedReader(theclob.getCharacterStream());
				while ((readline = clobin.readLine()) != null) clobStrBuff = clobStrBuff.append(readline);
				clobin.close() ;
				docContent = clobStrBuff.toString();
			}else{
					docContent=statement.getString("condition");
			}
		
			int nlid = Util.getIntValue(statement.getString("id"));
			nodelinkidList.add(""+nlid);
			conditionList.add(""+docContent);
		}
			
		//\u8c03\u6574\u5b57\u6bb5\u540e\u65b0\u7684\u8bfb\u53d6\u65b9\u5f0f\u7ed3\u675f
		for(int cx=0; cx<nodelinkidList.size(); cx++){
		    String nlid = Util.null2String((String)nodelinkidList.get(cx));
		    String condition = Util.null2String((String)conditionList.get(cx));
		    mmatcher = mpattern.matcher(condition);
		    boolean find = mmatcher.find();
		    if(find==true){
		        //RecordSetTrans.execute("update workflow_nodelink set condition='' , conditioncn='' where id="+nlid);
		        String sql = "update workflow_nodelink set condition='' , conditioncn='' where id="+nlid;
		        if(statement.getDBType().equals("oracle"))
		            sql = "update workflow_nodelink set condition=empty_clob() , conditioncn=empty_clob() where id="+nlid;
		              statement.setStatementSql(sql);
		              statement.executeUpdate();
		    }
		}
		//\u5220\u9664\u4e0e\u8be5\u5b57\u6bb5\u76f8\u5173\u7684\u51fa\u53e3\u6761\u4ef6
		
		//\u5220\u9664\u8282\u70b9\u9644\u52a0\u64cd\u4f5c
		RecordSetTrans.executeSql("delete from  workflow_addinoperate where isnode=1 and objid in (select t1.nodeid from  workflow_flownode t1, workflow_base t2 where t1.workflowid=t2.id and t2.isbill='1' and t2.formid=" + formid + ") and (fieldid =" + delFieldId + " or fieldop1id = " + delFieldId + " or fieldop2id = " + delFieldId + ")" );
		//\u5220\u9664\u51fa\u53e3\u9644\u52a0\u64cd\u4f5c
		RecordSetTrans.executeSql("delete from  workflow_addinoperate where isnode=0 and objid in (select t1.id from  workflow_nodelink t1, workflow_base t2 where t1.workflowid=t2.id and t2.isbill='1' and t2.formid=" + formid + ") and (fieldid =" + delFieldId + " or fieldop1id = " + delFieldId + " or fieldop2id = " + delFieldId + ")");
		//\u5220\u9664\u7531\u81ea\u5b9a\u4e49\u5b57\u6bb5\u4ea7\u751f\u7684\u64cd\u4f5c\u4eba\uff0c\u4e3b\u8981\u662f\u7531\u6d4f\u89c8\u6846\u5e26\u6765\u7684
		RecordSetTrans.executeSql("delete from  workflow_groupdetail where type in(5,6,31,32,7,38,42,43,8,33,9,10,47,34,11,12,13,35,14,15,44,45,46,16) and groupid in(select id from workflow_nodegroup where nodeid in (select t1.nodeid from  workflow_flownode t1, workflow_base t2 where t1.workflowid=t2.id and t2.isbill='1' and t2.formid=" + formid + ")) and objid=" + delFieldId);
		//\u5220\u9664\u8282\u70b9\u4e0a\u54ea\u4e9b\u5b57\u6bb5\u53ef\u89c6\u3001\u53ef\u7f16\u8f91\u3001\u5fc5\u8f93\u7684\u4fe1\u606f
		RecordSetTrans.executeSql("delete from  workflow_nodeform where nodeid in (select t1.nodeid from  workflow_flownode t1, workflow_base t2 where t1.workflowid=t2.id and t2.isbill='1' and t2.formid=" + formid + ") and fieldid= " + delFieldId);
		//\u5220\u9664\u7279\u6b8a\u5b57\u6bb5\u7684\u4fe1\u606f
		RecordSetTrans.executeSql("delete from workflow_specialfield where isbill=1 and fieldid =" + delFieldId);
		if(null!=statement){
			statement.close();
		}
  	}
  	
  	ArrayList changeRowIndexsArray = Util.TokenizerString(changeRowIndexs,",");
  	for(int i=0;i<changeRowIndexsArray.size();i++){//\u4fee\u6539\u6709\u6539\u53d8\u7684\u884c(\u5305\u62ec\u65b0\u589e\u884c\u548c\u7f16\u8f91\u884c)
  		String index = (String)changeRowIndexsArray.get(i);
  		String new_OR_modify = Util.null2String(request.getParameter("modifyflag_"+index));
  		//\u4e0d\u4e3a\u7a7a\u8868\u793a\u662f\u7f16\u8f91\u5b57\u6bb5\uff0c\u4e3a\u7a7a\u8868\u793a\u65b0\u6dfb\u52a0\u5b57\u6bb5\u3002
  		if(!new_OR_modify.equals("")){
			//\u5bf9\u7f16\u8f91\u5b57\u6bb5\u5148\u5220\u9664\uff0c\u518d\u6dfb\u52a0
			//\u5b57\u6bb5\u7f16\u8f91\u65f6\u4e0d\u5141\u8bb8\u4fee\u6539\u5b57\u6bb5\u6570\u636e\u5e93\u540d\uff0c\u4e0d\u9700\u8981\u91cd\u65b0\u751f\u6210id\uff0c\u907f\u514d\u6d41\u7a0b\u4e2d\u6570\u636e\u4e22\u5931\u3002TD10290
			//RecordSetTrans.executeSql("delete from workflow_SelectItem where isbill=1 and fieldid="+new_OR_modify);//\u5220\u9664\u8868workflow_SelectItem\u4e2d\u8be5\u5b57\u6bb5\u5bf9\u5e94\u6570\u636e
	  		RecordSetTrans.executeSql("delete from workflow_specialfield where isbill=1 and fieldid="+new_OR_modify);//\u5220\u9664\u8868workflow_specialfield\u4e2d\u8be5\u5b57\u6bb5\u5bf9\u5e94\u6570\u636e	
  		}
  			String fieldname = "";//\u6570\u636e\u5e93\u5b57\u6bb5\u540d\u79f0
  			int fieldlabel = 0;//\u5b57\u6bb5\u663e\u793a\u540d\u6807\u7b7eid
  			String fielddbtype = "";//\u5b57\u6bb5\u6570\u636e\u5e93\u7c7b\u578b
			String _fielddbtype = "";//\u5b57\u6bb5\u6570\u636e\u5e93\u7c7b\u578b
  			String fieldhtmltype = "";//\u5b57\u6bb5\u9875\u9762\u7c7b\u578b
  			String type = "";//\u5b57\u6bb5\u8be6\u7ec6\u7c7b\u578b
  			String dsporder = "";//\u663e\u793a\u987a\u5e8f
  			int selectitem = 0;//\u516c\u5171\u9009\u62e9\u9879\u5b57\u6bb5
  			int linkfield = 0;//\u5173\u8054\u9009\u62e9\u9879\u5b57\u6bb5
  			String viewtype = "0";//viewtype="0"\u8868\u793a\u4e3b\u8868\u5b57\u6bb5,viewtype="1"\u8868\u793a\u660e\u7ec6\u8868\u5b57\u6bb5
  			String detailtable = "";//\u660e\u7ec6\u8868\u540d
  			int textheight = 0;//\u591a\u884c\u6587\u672c\u6846\u7684\u9ad8\u5ea6
  			String textheight_2 = ""; //\u5206\u6743 \u7ea7\u522b 
  			String locateType = "";  //\u5b9a\u4f4d\u7c7b\u578b\uff1a2\uff1a\u81ea\u52a8\u30011\uff1a\u624b\u52a8
  			int  qfws=0;
  			int  places=0;
  			
  			
  			String selectItemType = Util.null2String(request.getParameter("selectItemType"+index));
			int pubchoiceId = Util.getIntValue(Util.null2String(request.getParameter("pubchoiceId"+index)),0);
			int pubchilchoiceId = Util.getIntValue(Util.null2String(request.getParameter("pubchilchoiceId"+index)),0);
			
			if(selectItemType.equals("0")){
				pubchoiceId = 0;
				pubchilchoiceId = 0;
			}
			if(selectItemType.equals("1")){
				pubchilchoiceId = 0;
			}
			if(selectItemType.equals("2")){
				//pubchoiceId = 0;
			}
  			
  			fieldname = Util.null2String(request.getParameter("itemDspName_"+index));
  			if(fieldname.equals("")) continue;//\u5148\u6dfb\u52a0\u540e\u5220\u9664\u7684
  			int imgwidth = Util.getIntValue(request.getParameter("imgwidth_"+index),0);
            int imgheight = Util.getIntValue(request.getParameter("imgheight_"+index),0);
  			String fieldlabelname = Util.null2String(request.getParameter("itemFieldName_"+index));
  			fieldlabelname = Util.StringReplace(fieldlabelname, "\"", "");//TD10108 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u53cc\u5f15\u53f7\u201c"\u201d
  			fieldlabelname = Util.StringReplace(fieldlabelname, "'", "");//TD31514 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u5355\u5f15\u53f7\u201c'\u201d
  			if(issqlserver) RecordSetTrans.executeSql("select indexid from HtmlLabelInfo where labelname='"+fieldlabelname+"' collate Chinese_PRC_CS_AI and languageid="+Util.getIntValue(""+user.getLanguage(),7));
		  	else RecordSetTrans.executeSql("select indexid from HtmlLabelInfo where labelname='"+fieldlabelname+"' and languageid="+Util.getIntValue(""+user.getLanguage(),7));
		  	if(RecordSetTrans.next()) fieldlabel = RecordSetTrans.getInt("indexid");//\u5982\u679c\u5b57\u6bb5\u540d\u79f0\u5728\u6807\u7b7e\u5e93\u4e2d\u5b58\u5728\uff0c\u53d6\u5f97\u6807\u7b7eid
		  	else{
		  		fieldlabel = FormManager.getNewIndexId(RecordSetTrans);//\u751f\u6210\u65b0\u7684\u6807\u7b7eid
			  	if(fieldlabel!=-1){//\u66f4\u65b0\u6807\u7b7e\u5e93
			  		labelidsCache+=fieldlabel+",";
			  		RecordSetTrans.executeSql("delete from HtmlLabelIndex where id="+fieldlabel);
			  		RecordSetTrans.executeSql("delete from HtmlLabelInfo where indexid="+fieldlabel);
			  		RecordSetTrans.executeSql("INSERT INTO HtmlLabelIndex values("+fieldlabel+",'"+fieldlabelname+"')");
			  		RecordSetTrans.executeSql("INSERT INTO HtmlLabelInfo values("+fieldlabel+",'"+fieldlabelname+"',7)");
			  		RecordSetTrans.executeSql("INSERT INTO HtmlLabelInfo values("+fieldlabel+",'"+fieldlabelname+"',8)");
			  		RecordSetTrans.executeSql("INSERT INTO HtmlLabelInfo values("+fieldlabel+",'"+fieldlabelname+"',9)");
			  	}
			  }
			  
			  fieldhtmltype = Util.null2String(request.getParameter("itemFieldType_"+index));
			  if(!fieldhtmltype.equals("5")){
			  	selectItemType = "0";
			  	pubchilchoiceId=0;
			  	pubchoiceId=0;
			  }
			  
			  if(fieldhtmltype.equals("1")){
				  int decimaldigits = Util.getIntValue(request.getParameter("decimaldigits_"+index),2);
			  	type = Util.null2String(request.getParameter("documentType_"+index));	
				  if(type.equals("1")){
				  	String strlength = Util.null2String(request.getParameter("itemFieldScale1_"+index));
				  	if(Util.getIntValue(strlength,1)<=1) strlength = "1";
			    	if(isoracle) fielddbtype="varchar2("+strlength+")";
			    	else fielddbtype="varchar("+strlength+")";
			    	
			   	}
				 	if(type.equals("2")){
			   		if(isoracle) fielddbtype="integer";
			   		else fielddbtype="int";
			   	}
				 	if(type.equals("3")){
				   		if(isoracle) fielddbtype="number(15,"+decimaldigits+")";
				   		else fielddbtype="decimal(15,"+decimaldigits+")";
			   		
			 	 	}
				 	
				
			   	if(type.equals("4")){
			   		if(isoracle) fielddbtype="number(15,2)";
			   		else fielddbtype="decimal(15,2)";
					}
			   	if(type.equals("5")){
			   		if(isoracle) fielddbtype="varchar2(30)";
			   		else fielddbtype="varchar(30)";
			   			 qfws=decimaldigits;
					}
			    	if(!new_OR_modify.equals("")){
			    	    String oldfielddbtype = "";
			    	    RecordSetTrans.executeSql("select fielddbtype from workflow_billfield where id="+new_OR_modify);
			    	    if(RecordSetTrans.next()) oldfielddbtype = RecordSetTrans.getString("fielddbtype");
			    	    
			    	    if(!fielddbtype.equals(oldfielddbtype)){
			    	        try{
				    	        if(isoracle) RecordSetTrans.executeSql("ALTER TABLE "+maintablename+" MODIFY "+fieldname+" "+fielddbtype);
				    	        else RecordSetTrans.executeSql("ALTER TABLE "+maintablename+" ALTER COLUMN "+fieldname+" "+fielddbtype);
			    	    	}catch(Exception ep){
			    	    		modifyFieldtypeSuccess = false;			    	    		
			    	    		throw ep;
			    	    	}
			    	    }
			    	}
			  }
			  if(fieldhtmltype.equals("2")){
			  	String htmledit = Util.null2String(request.getParameter("htmledit_"+index));
			  	if(htmledit.equals("")) type="1";
			  	else type=htmledit;
				  	if(isoracle) {
						if(!"1".equals(type)) {
							fielddbtype="clob";
						} else {
							fielddbtype="varchar2(4000)";
						}
					} else if(isdb2) {
					    fielddbtype="varchar(2000)";
					} else {
						fielddbtype="text";
					}
					textheight = Util.getIntValue(Util.null2String(request.getParameter("textheight_"+index)),4);
			  }
			  if(fieldhtmltype.equals("3")){
			  	int temptype = Util.getIntValue(Util.null2String(request.getParameter("broswerType_"+index)),0);
			  	type = ""+temptype;
			  	if(temptype>0)
			  		fielddbtype=BrowserComInfo.getBrowserdbtype(type+"");
				  	if(temptype==118){
				  		if(isoracle) fielddbtype="varchar2(200)";
			              else fielddbtype="varchar(200)";
				  	}
					if(temptype==161||temptype==162){
						fielddbtype=Util.null2String(request.getParameter("definebroswerType_"+index));
						if(temptype==161){
							if(isoracle) _fielddbtype="varchar2(1000)";
							else if(isdb2) _fielddbtype="varchar(1000)";
							else _fielddbtype="varchar(1000)";
						}else{
							if(isoracle) _fielddbtype="varchar2(4000)";
							else if(isdb2) _fielddbtype="varchar(2000)";
							else _fielddbtype="text";
						}
					}
					if(temptype==256||temptype==257){
						fielddbtype=Util.null2String(request.getParameter("defineTreeBroswerType_"+index));
						if(temptype==256){
							if(isoracle) _fielddbtype="varchar2(1000)";
							else if(isdb2) _fielddbtype="varchar(1000)";
							else _fielddbtype="varchar(1000)";
						}else{
							if(isoracle) _fielddbtype="varchar2(4000)";
							else if(isdb2) _fielddbtype="varchar(2000)";
							else _fielddbtype="varchar(4000)";
						}
					}
					if(temptype==224||temptype==225){
						fielddbtype=Util.null2String(request.getParameter("sapbrowser_"+index));
						if(temptype==224){
							if(isoracle) _fielddbtype="varchar2(1000)";
							else if(isdb2) _fielddbtype="varchar(1000)";
							else _fielddbtype="varchar(1000)";
						}else{
							if(isoracle) _fielddbtype="varchar2(4000)";
							else if(isdb2) _fielddbtype="varchar(2000)";
							else _fielddbtype="text";
						}
					}
					
					if(temptype==226||temptype==227){
						fielddbtype=Util.null2String(request.getParameter("showvalue_"+index));
						if(temptype==226){
							if(isoracle) _fielddbtype="varchar2(1000)";
							else if(isdb2) _fielddbtype="varchar(1000)";
							else _fielddbtype="varchar(1000)";
						}else{
							if(isoracle) _fielddbtype="varchar2(4000)";
							else if(isdb2) _fielddbtype="varchar(2000)";
							else _fielddbtype="text";
						}
					}
					if(temptype==17){
				  		if(isoracle) {
				  			fielddbtype="clob";
				  			_fielddbtype="clob";
				  		}else if(isdb2){
				  			_fielddbtype="varchar(2000)";
				  		}
						else {
							fielddbtype="text";
							_fielddbtype="text";
						}
				  	}
					
					
				  if(temptype==165||temptype==166||temptype==167||temptype==168) 
				  	//textheight=Util.getIntValue(Util.null2String(request.getParameter("decentralizationbroswerType_"+index)),0);
				  	textheight_2 = Util.null2String(request.getParameter("decentralizationbroswerType_"+index)); 
			  }
			  if(fieldhtmltype.equals("4")){
			  	type = "1";
			  	fielddbtype="char(1)";
			  }
			  if(fieldhtmltype.equals("5"))	{
			  	type = "1";
			  	if(isoracle) fielddbtype="integer";
			  	else fielddbtype="int";
			  }
			  if(fieldhtmltype.equals("6"))	{
			  	type = "" + Util.getIntValue(Util.null2String(request.getParameter("uploadtype_"+index)), 1);
			    if(isoracle) fielddbtype="varchar2(4000)";
				  else if(isdb2) fielddbtype="varchar(2000)";
			    else fielddbtype="text";
                textheight = Util.getIntValue(Util.null2String(request.getParameter("strlength_"+index)), 0);  
			  }
			  if(fieldhtmltype.equals("7"))	{
			  	type = Util.null2String(request.getParameter("specialfield_"+index));
			    if(isoracle) fielddbtype="varchar2(4000)";
				  else if(isdb2) fielddbtype="varchar(2000)";
			    else fielddbtype="text";
			  }
			  if(fieldhtmltype.equals("8"))	{
				  selectitem = Util.getIntValue(Util.null2String(request.getParameter("selectType_"+index)),0);
				  linkfield = Util.getIntValue(Util.null2String(request.getParameter("childCommonItem_"+index)),0);
				  type = "1";
				  if(isoracle) fielddbtype="integer";
				  else fielddbtype="int";
			  }
			  if(fieldhtmltype.equals("9")){
			      locateType = Util.null2String(request.getParameter("locateType_"+index)); //\u5b9a\u4f4d\u65b9\u5f0f\uff1a\u624b\u52a8\u6216\u81ea\u52a8
				  type = Util.null2String(request.getParameter("locationType_"+index));	//\u7c7b\u578b\uff1a\u4f4d\u7f6e				  
				  if(isoracle) fielddbtype = "clob";
				  else fielddbtype = "text"; 

			  }
			  dsporder = Util.null2String(request.getParameter("itemDspOrder_"+index));
			  //if(dsporder.equals("")) dsporder="0";
			  dsporder = ""+Util.getFloatValue(dsporder,0);
			  int childfieldid_tmp = Util.getIntValue(request.getParameter("childfieldid_"+index), 0);
			  if(!new_OR_modify.equals("")){//\u4e0d\u4e3a\u7a7a\u8868\u793a\u662f\u7f16\u8f91\u5b57\u6bb5\uff0c\u4e3a\u7a7a\u8868\u793a\u65b0\u6dfb\u52a0\u5b57\u6bb5\u3002
			  	String oldfieldname = "";
			  	String oldfielddbtype = "";
			  	String oldtype = "";
			  	RecordSetTrans.executeSql("select fieldname,fielddbtype,type from workflow_billfield where id="+new_OR_modify);
			  	if(RecordSetTrans.next()){
			  	    oldfieldname = RecordSetTrans.getString("fieldname");
			  	    oldfielddbtype = RecordSetTrans.getString("fielddbtype");
			  	  	oldtype = RecordSetTrans.getString("type");
			  	}
			  	RecordSetTrans.executeSql("update workflow_billfield set billid="+formid+",fieldname='"+fieldname+"',fieldlabel="+fieldlabel+",fielddbtype='"+fielddbtype+"',fieldhtmltype="+fieldhtmltype+",type="+type+",dsporder="+dsporder+",viewtype="+viewtype+",detailtable='"+detailtable+"',textheight="+textheight+",textheight_2='"+textheight_2+"',imgwidth="+imgwidth+",imgheight="+imgheight+" ,places="+places+" ,qfws="+qfws+",selectitem='"+selectitem+"',linkfield='"+linkfield+"',selectItemType='"+selectItemType+"',pubchoiceId="+pubchoiceId+",pubchilchoiceId="+pubchilchoiceId+",locatetype='"+ locateType +"' where id="+new_OR_modify);
			  	if(!fieldname.equals(oldfieldname)||(!fielddbtype.equals(oldfielddbtype) && !"1".equals(fieldhtmltype) && !"".equals(type))){//\u4fee\u6539\u4e86\u6570\u636e\u5e93\u5b57\u6bb5\u540d\u79f0\u6216\u7c7b\u578b
			  	    RecordSetTrans.executeSql("select "+oldfieldname+" from "+maintablename);
			  	    if(!RecordSetTrans.next()){
			  	    	RecordSetTrans.executeSql("alter table "+maintablename+" drop column "+oldfieldname);
			  	    	if(fieldhtmltype.equals("3")&&(type.equals("161")||type.equals("162"))){
			  	        RecordSetTrans.executeSql("alter table "+maintablename+" add "+fieldname+" "+_fielddbtype);
				  	    }else if(fieldhtmltype.equals("3")&&(type.equals("256")||type.equals("257"))){
			  	        	RecordSetTrans.executeSql("alter table "+maintablename+" add "+fieldname+" "+_fielddbtype);
				  	    }else if(fieldhtmltype.equals("3")&&(type.equals("224")||type.equals("225"))){
				  	        RecordSetTrans.executeSql("alter table "+maintablename+" add "+fieldname+" "+_fielddbtype);
				  	    }else if(fieldhtmltype.equals("3")&&(type.equals("226")||type.equals("227"))){
				  	        RecordSetTrans.executeSql("alter table "+maintablename+" add "+fieldname+" "+_fielddbtype);
				  	    }
				  	    else{
				  	        RecordSetTrans.executeSql("alter table "+maintablename+" add "+fieldname+" "+fielddbtype);
				  	    }
			  	    }else{	//\u7269\u7406\u8868\u4e2d\u6709\u6570\u636e\u65f6
			  	    	if(!fieldname.equals(oldfieldname)){	//\u4fee\u6539\u7684\u662f\u6570\u636e\u5e93\u5b57\u6bb5\u540d\u79f0
			  	    		if(issqlserver){
			  	    			//("\u8c03\u8bd5\u6253\u53702:" + "EXEC sp_rename '"+maintablename+".["+oldfieldname+"]','"+fieldname+"','COLUMN'");
			  	    			RecordSetTrans.executeSql("EXEC sp_rename '"+maintablename+".["+oldfieldname+"]','"+fieldname+"','COLUMN'");
			  	    		}else if(isoracle){
			  	    			RecordSetTrans.executeSql("alter table "+maintablename+" rename column "+oldfieldname+" to "+fieldname);
			  	    		}
			  	    	}
			  	    	if((!fielddbtype.equals(oldfielddbtype) && !"1".equals(fieldhtmltype) && !"".equals(type))){ //\u4fee\u6539\u7684\u662f\u6570\u636e\u5e93\u5b57\u6bb5\u7c7b\u578b
			  	    		String modifyFieldTypeSQL = "";
			  	    		if(fieldhtmltype.equals("3")&&(type.equals("161")||type.equals("162"))){
			  	    			if(isoracle){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+maintablename+" MODIFY "+fieldname+" "+_fielddbtype;
			  	    			}else if(issqlserver){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+maintablename+" ALTER COLUMN "+fieldname+" "+_fielddbtype;
				    	        }
							}else if(fieldhtmltype.equals("3")&&(type.equals("256")||type.equals("257"))){
			  	    			if(isoracle){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+maintablename+" MODIFY "+fieldname+" "+_fielddbtype;
			  	    			}else if(issqlserver){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+maintablename+" ALTER COLUMN "+fieldname+" "+_fielddbtype;
				    	        }
							}else if(fieldhtmltype.equals("3")&&(type.equals("224")||type.equals("225"))){
								if(isoracle){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+maintablename+" MODIFY "+fieldname+" "+_fielddbtype;
			  	    			}else if(issqlserver){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+maintablename+" ALTER COLUMN "+fieldname+" "+_fielddbtype;
				    	        }
						  	}else if(fieldhtmltype.equals("3")&&(type.equals("226")||type.equals("227"))){
						  		if(isoracle){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+maintablename+" MODIFY "+fieldname+" "+_fielddbtype;
			  	    			}else if(issqlserver){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+maintablename+" ALTER COLUMN "+fieldname+" "+_fielddbtype;
				    	        }
						  	}else{
						  		if(isoracle){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+maintablename+" MODIFY "+fieldname+" "+fielddbtype;
			  	    			}else if(issqlserver){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+maintablename+" ALTER COLUMN "+fieldname+" "+fielddbtype;
				    	        }
						  	}
			  	    		try{
			  	    			RecordSetTrans.executeSql(modifyFieldTypeSQL);	
			  	    		}catch(Exception ep){
			  	    			modifyFieldtypeSuccess = false;
			  	    			throw ep;
			  	    		}
					  	}
			  	    }
			  	}else if(fieldhtmltype.equals("3")&&type.equals("257")&&oldtype.equals("256")){//\u4ece\u6811\u5f62\u5355\u9009\u6539\u5230\u591a\u9009
			  		String modifyFieldTypeSQL = "";
  	    			if(isoracle){
  	    				modifyFieldTypeSQL = "ALTER TABLE "+maintablename+" MODIFY "+fieldname+" "+_fielddbtype;
  	    			}else if(issqlserver){
  	    				modifyFieldTypeSQL = "ALTER TABLE "+maintablename+" ALTER COLUMN "+fieldname+" "+_fielddbtype;
	    	        }
  	    			
  	    			try{
	  	    			RecordSetTrans.executeSql(modifyFieldTypeSQL);	
	  	    		}catch(Exception ep){
	  	    			modifyFieldtypeSuccess = false;
	  	    			throw ep;
	  	    		}
	  	    		
				}
				}else{
				  //\u63d2\u5165\u5b57\u6bb5\u4fe1\u606f
				  RecordSetTrans.executeSql("INSERT INTO workflow_billfield(billid,fieldname,fieldlabel,fielddbtype,fieldhtmltype,type,dsporder,viewtype,detailtable,textheight,textheight_2,childfieldid,imgwidth,imgheight,places,qfws,selectitem,linkfield,selectItemType,pubchoiceId,pubchilchoiceId,locatetype) "+
				  " VALUES ("+formid+",'"+fieldname+"',"+fieldlabel+",'"+fielddbtype+"',"+fieldhtmltype+","+type+","+dsporder+","+viewtype+",'"+detailtable+"',"+textheight+",'"+textheight_2+"',"+childfieldid_tmp+","+imgwidth+","+imgheight+","+places+","+qfws+",'"+selectitem+"','"+linkfield+"','"+selectItemType+"',"+pubchoiceId+","+pubchilchoiceId+",'"+locateType+"')");
			  }
			  if(new_OR_modify.equals("")){//\u65b0\u6dfb\u52a0\u5b57\u6bb5
			  //\u66f4\u65b0\u4e3b\u8868\u7ed3\u6784
			  if(fieldhtmltype.equals("3")&&(type.equals("161")||type.equals("162"))){
			  	  RecordSetTrans.executeSql("alter table "+maintablename+" add "+fieldname+" "+_fielddbtype);
			  }else if(fieldhtmltype.equals("3")&&(type.equals("256")||type.equals("257"))){
			  	  RecordSetTrans.executeSql("alter table "+maintablename+" add "+fieldname+" "+_fielddbtype);
			  }else if(fieldhtmltype.equals("3")&&(type.equals("224")||type.equals("225"))){
			  	  RecordSetTrans.executeSql("alter table "+maintablename+" add "+fieldname+" "+_fielddbtype);
			  }else if(fieldhtmltype.equals("3")&&(type.equals("226")||type.equals("227"))){
			  	  RecordSetTrans.executeSql("alter table "+maintablename+" add "+fieldname+" "+_fielddbtype);
			  }
			  else{
			  	  RecordSetTrans.executeSql("alter table "+maintablename+" add "+fieldname+" "+fielddbtype);
			  }
			  }
			  
			  
			  //\u5982\u679c\u662f\u9009\u62e9\u6846\uff0c\u66f4\u65b0\u8868workflow_SelectItem
			  String curfieldid = "";
			  if(new_OR_modify.equals("")){
			      RecordSetTrans.executeSql("select max(id) as id from workflow_billfield");
			      if(RecordSetTrans.next()) curfieldid = RecordSetTrans.getString("id");
			  }else{
			      curfieldid = new_OR_modify;
			  }
			  
			  if(jumpRowindex.equals(index)){
			      jumpfieldid = Util.getIntValue(curfieldid);
			  }
			  
			  if(fieldhtmltype.equals("5")){
			    
			    if(selectItemType.equals("0") && false){//\u4e0d\u6267\u884c
			    	int rowsum = Util.getIntValue(Util.null2String(request.getParameter("choiceRows_"+index)));
	                int curvalue=0;
				  	for(int temprow=1;temprow<=rowsum;temprow++){
				  		String curname = Util.null2String(request.getParameter("field_"+index+"_"+temprow+"_name"));
				  		if(curname.equals("")) continue;
				  		String curorder = Util.null2String(request.getParameter("field_count_"+index+"_"+temprow+"_name"));
				  		String isdefault = "n";
				  		String checkValue = Util.null2String(request.getParameter("field_checked_"+index+"_"+temprow+"_name"));
				  		String cancel = Util.null2String(request.getParameter("cancel_"+index+"_"+temprow+"_name")); 
				  		if(cancel!=null && !cancel.equals("") && cancel.equals("1")){
							cancel = "1";
						}else{
							cancel = "0";
						}
						if(checkValue.equals("1")) isdefault="y";
				  			int isAccordToSubCom_tmp = Util.getIntValue(request.getParameter("isAccordToSubCom"+index+"_"+temprow), 0);
							String doccatalog = Util.null2String(request.getParameter("maincategory_"+index+"_"+temprow));
							String docPath = Util.null2String(request.getParameter("pathcategory_"+index+"_"+temprow));
							String childItem_tmp = Util.null2String(request.getParameter("childItem_"+index+"_"+temprow));
							if(childfieldid_tmp==0)childItem_tmp="";
							String para=curfieldid+flag+"1"+flag+""+curvalue+flag+curname+flag+curorder+flag+isdefault+flag+cancel; 
							RecordSetTrans.executeProc("workflow_selectitem_insert_new",para);//\u66f4\u65b0\u8868workflow_SelectItem
							RecordSetTrans.executeSql("update workflow_SelectItem set docpath='"+docPath+"', docCategory='"+doccatalog+"',childitemid='"+childItem_tmp+"',isAccordToSubCom='"+isAccordToSubCom_tmp+"' where fieldid="+curfieldid+" and selectvalue="+curvalue);
	                        curvalue++;
				  	}
			    }else if (selectItemType.equals("1")){
			    	field_pubchoice_map.put(curfieldid,""+pubchoiceId);
			    }else if (selectItemType.equals("2")){
			    	field_pubchilchoice_map.put(curfieldid,""+pubchilchoiceId);
			    }
			    
			  	
			  }
			  if(fieldhtmltype.equals("7")){              
	               String displayname = Util.null2String(request.getParameter("displayname_"+index));//\u663e\u793a\u540d
	               String linkaddress = Util.null2String(request.getParameter("linkaddress_"+index));//\u94fe\u63a5\u5730\u5740
	               String descriptivetext = Util.null2String(request.getParameter("descriptivetext_"+index));//\u63cf\u8ff0\u6027\u6587\u5b57
	               descriptivetext = Util.spacetoHtml(descriptivetext);	
	               descriptivetext = Util.htmlFilter4UTF8(descriptivetext);
		  	       String specialfield = Util.null2String(request.getParameter("specialfield_"+index));//\u7c7b\u578b
		  	       //String sql = "select max(id) from workflow_billfield";
			       //RecordSetTrans.executeSql(sql);
			       //RecordSetTrans.next();
			       //String curfieldid=RecordSetTrans.getString(1);
			       //if(!new_OR_modify.equals("")) curfieldid = new_OR_modify;
		           String sql = "";
		           if(specialfield.equals("1")){
		              sql = "insert into workflow_specialfield(fieldid,displayname,linkaddress,isform,isbill) values("+curfieldid+",'"+displayname+"','"+linkaddress+"',0,1)";    
		           }else{
		              sql = "insert into workflow_specialfield(fieldid,descriptivetext,isform,isbill) values("+curfieldid+",'"+descriptivetext+"',0,1)";    
		           }
			       RecordSetTrans.executeSql(sql);
			  }
			  
			  if(new_OR_modify.equals("")){//\u65b0\u5efa\u5b57\u6bb5\u63d2\u5165\u5230\u8282\u70b9
				String insertFieldId = curfieldid;
			  	RecordSetTrans.execute("select count(nodeid) as wfnfc from workflow_nodeform where fieldid="+insertFieldId);
			  	int wf_nf_count = 0;
			  	if(RecordSetTrans.next()){
			  		wf_nf_count = Util.getIntValue(RecordSetTrans.getString(1), 0);
			  	}
			  	if(wf_nf_count<1){
					ArrayList arrNodeId = new ArrayList();
					RecordSetTrans.executeSql("select nodeid from workflow_flownode where workflowid in (select id from workflow_base where formid="+formid+" and isbill=1)");
					while(RecordSetTrans.next()){
						arrNodeId.add(RecordSetTrans.getString("nodeid"));
					}
					for(int h=0; h < arrNodeId.size(); h++){
						RecordSetTrans.executeSql("insert into workflow_nodeform(nodeid,fieldid,isview,isedit,ismandatory) values("+(String)arrNodeId.get(h)+","+insertFieldId+",'0','0','0')");
					}
			  	}//if(wf_nf_count<1){
			  }
			  
  	}
  	//\u4e3b\u5b57\u6bb5 \u7ed3\u675f
  	
  	//\u660e\u7ec6\u5b57\u6bb5 \u5f00\u59cb
  	int detailtables = Util.getIntValue((request.getParameter("detailtables")),0);//\u660e\u7ec6\u6570\u91cf
  	String detailtableIndexs = Util.null2String(request.getParameter("detailtableIndexs"));//\u660e\u7ec6\u8868\u5e8f\u53f7\u96c6
  	ArrayList detailtableIndexsArray = Util.TokenizerString(detailtableIndexs,",");
  	
  	for(int tempi=0;tempi<detailtables;tempi++){
  		int i = Util.getIntValue((String)detailtableIndexsArray.get(tempi),0);
  		boolean isexist = false;
			String detailtable = Util.null2String(request.getParameter("detailtablename_db_"+i));	//\u660e\u7ec6\u8868\u540d\u79f0
			String newsapmultiBrowservalue= Util.null2String(request.getParameter("newsapmultiBrowservalue_"+i));
			RecordSetTrans.executeSql("select * from Workflow_billdetailtable where billid="+formid+" and tablename='"+detailtable+"'");
			if(RecordSetTrans.next()) isexist=true;//\u660e\u7ec6\u8868\u5df2\u5b58\u5728
			
			String dbtype = RecordSet.getDBType();
			String sql = "";
			if (dbtype.equalsIgnoreCase("oracle")) {
			    sql = "select 1 from user_tables where TABLE_NAME = upper('" + detailtable + "')";
			} else if (dbtype.toLowerCase().indexOf("sqlserver")>-1||dbtype.equalsIgnoreCase("sybase")) {
			    sql = "select 1 from sysobjects where name = '" + detailtable + "' ";
			} else if (dbtype.equalsIgnoreCase("informix")) {
			    sql = "select 1 from systables where lower(tabname) = lower('" + detailtable + "') ";
			} else if (dbtype.equalsIgnoreCase("mysql")) {
			    sql = "select 1 from information_schema.Tables where LOWER(Table_Name)=LOWER('" + detailtable + "') ";
			} else if (dbtype.equalsIgnoreCase("db2")) {
			    sql = "select 1 from SYSIBM.SYSTABLES where lower(name)= lower('" + detailtable + "') ";
			}else{
			    sql="select 1 from "+detailtable;
			}
			RecordSetTrans.executeSql(sql);
			if(RecordSetTrans.next()) isexist=true;//\u660e\u7ec6\u8868\u5df2\u5b58\u5728
			
			if(!isexist){//\u660e\u7ec6\u8868\u4e0d\u5b58\u5728\uff0c\u5219\u65b0\u5efa\u660e\u7ec6\u8868
	  		if(isoracle){
		  		RecordSetTrans.executeSql("create table " + detailtable + "(id integer primary key not null,mainid integer)");
		  	}else{
		  		RecordSetTrans.executeSql("create table " + detailtable + "(id int IDENTITY(1,1) primary key CLUSTERED,mainid int)");
		 		}
		 		//\u63d2\u5165\u8868\u5355\u660e\u7ec6\u8868\u4fe1\u606fworkflow_billdetailtable
		 		RecordSetTrans.executeSql("INSERT INTO workflow_billdetailtable(billid,tablename,orderid) values("+formid+",'"+detailtable+"',"+i+")");
	 		}
		//\u660e\u7ec6\u8868\u7684\u540d\u5b57--detailtable
		//\u660e\u7ec6\u8868\u7684formid  
			  
		
	  	String detaildelids = Util.null2String(request.getParameter("detaildelids_"+i));//\u5220\u9664\u884cid\u96c6
	  	String detailChangeRowIndexs = Util.null2String(request.getParameter("detailChangeRowIndexs_"+i));//\u6709\u6539\u53d8\u7684\u884cid\u96c6
	  	
	  	ArrayList detaildelidsArray = Util.TokenizerString(detaildelids,",");
	  	for(int j=0;j<detaildelidsArray.size();j++){//\u5220\u9664\u6307\u5b9a\u7684\u5b57\u6bb5
	  		String fieldnameForDel = "";
	  		String delFieldId = (String)detaildelidsArray.get(j);

				//\u5982\u679c\u5b57\u6bb5\u88ab\u884c\u5217\u89c4\u5219\u5f15\u7528\uff0c\u5219\u9000\u51fa\u3002
				RecordSetTrans.executeSql("select * from workflow_formdetailinfo where rowcalstr like '%!_"+delFieldId+"_%' escape '!' or rowcalstr like '%!_"+delFieldId+"' escape '!' or colcalstr like '%!_"+delFieldId+"_%' escape '!' or colcalstr like '%!_"+delFieldId+"' escape '!' or maincalstr like '%!_"+delFieldId+"_%' escape '!' or maincalstr like '%!_"+delFieldId+"' escape '!'");
				if(RecordSetTrans.next()){
				    RecordSetTrans.rollback();
				    response.sendRedirect("/workflow/form/editformfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0&message=nodelete");
				    return;
				}

               if(WorkflowSubwfFieldManager.hasSubWfSetting(RecordSetTrans,Util.getIntValue(delFieldId,0),1)){
			        RecordSetTrans.rollback();
			        response.sendRedirect("/workflow/form/editformfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0&message=nodeleteForSubWf");
			        return;
			    }

	  		RecordSetTrans.executeSql("select fieldname from workflow_billfield where id="+delFieldId);
	  		if(RecordSetTrans.next()) fieldnameForDel = RecordSetTrans.getString("fieldname");//\u53d6\u5f97\u5b57\u6bb5\u540d
	  		RecordSetTrans.executeSql("delete from workflow_billfield where id="+delFieldId);//\u5220\u9664\u5b57\u6bb5
	  		RecordSetTrans.executeSql("alter table "+detailtable+" drop column "+fieldnameForDel);//\u4fee\u6539\u8868\u7ed3\u6784
	  		RecordSetTrans.executeSql("delete from workflow_SelectItem where isbill=1 and fieldid="+delFieldId);//\u5220\u9664\u8868workflow_SelectItem\u4e2d\u8be5\u5b57\u6bb5\u5bf9\u5e94\u6570\u636e
	  		RecordSetTrans.execute("update workflow_billfield set childfieldid=0 where childfieldid="+delFieldId);//\u5982\u679c\u88ab\u5220\u9664\u5b57\u6bb5\u662f\u5b50\u5b57\u6bb5\uff0c\u5219\u9700\u8981\u4fee\u6539
				//\u5220\u9664\u8282\u70b9\u9644\u52a0\u64cd\u4f5c
				RecordSetTrans.executeSql("delete from  workflow_addinoperate where isnode=1 and objid in (select t1.nodeid from  workflow_flownode t1, workflow_base t2 where t1.workflowid=t2.id and t2.isbill='1' and t2.formid=" + formid + ") and (fieldid =" + delFieldId + " or fieldop1id = " + delFieldId + " or fieldop2id = " + delFieldId + ")" );
				//\u5220\u9664\u51fa\u53e3\u9644\u52a0\u64cd\u4f5c
				RecordSetTrans.executeSql("delete from  workflow_addinoperate where isnode=0 and objid in (select t1.id from  workflow_nodelink t1, workflow_base t2 where t1.workflowid=t2.id and t2.isbill='1' and t2.formid=" + formid + ") and (fieldid =" + delFieldId + " or fieldop1id = " + delFieldId + " or fieldop2id = " + delFieldId + ")");
				//\u5220\u9664\u7531\u81ea\u5b9a\u4e49\u5b57\u6bb5\u4ea7\u751f\u7684\u64cd\u4f5c\u4eba\uff0c\u4e3b\u8981\u662f\u7531\u6d4f\u89c8\u6846\u5e26\u6765\u7684
				RecordSetTrans.executeSql("delete from  workflow_groupdetail where type in(5,6,31,32,7,38,42,43,8,33,9,10,47,34,11,12,13,35,14,15,44,45,46,16) and groupid in(select id from workflow_nodegroup where nodeid in (select t1.nodeid from  workflow_flownode t1, workflow_base t2 where t1.workflowid=t2.id and t2.isbill='1' and t2.formid=" + formid + ")) and objid=" + delFieldId);
				//\u5220\u9664\u8282\u70b9\u4e0a\u54ea\u4e9b\u5b57\u6bb5\u53ef\u89c6\u3001\u53ef\u7f16\u8f91\u3001\u5fc5\u8f93\u7684\u4fe1\u606f
				RecordSetTrans.executeSql("delete from  workflow_nodeform where nodeid in (select t1.nodeid from  workflow_flownode t1, workflow_base t2 where t1.workflowid=t2.id and t2.isbill='1' and t2.formid=" + formid + ") and fieldid= " + delFieldId);
				//\u5220\u9664\u7279\u6b8a\u5b57\u6bb5\u7684\u4fe1\u606f
				RecordSetTrans.executeSql("delete from workflow_specialfield where isbill=1 and fieldid =" + delFieldId);

					  		
	  	}
	  	
	  	ArrayList detailChangeRowIndexsArray = Util.TokenizerString(detailChangeRowIndexs,",");
	  	for(int j=0;j<detailChangeRowIndexsArray.size();j++){//\u4fee\u6539\u6709\u6539\u53d8\u7684\u884c(\u5305\u62ec\u65b0\u589e\u884c\u548c\u7f16\u8f91\u884c)
	  		String temprowindex = (String)detailChangeRowIndexsArray.get(j);

	  		String new_OR_modify = Util.null2String(request.getParameter("modifyflag_"+i+"_"+temprowindex));
	  		if(!new_OR_modify.equals("")){//\u4e0d\u4e3a\u7a7a\u8868\u793a\u662f\u7f16\u8f91\u5b57\u6bb5\uff0c\u4e3a\u7a7a\u8868\u793a\u65b0\u6dfb\u52a0\u5b57\u6bb5\u3002
	  			//\u5bf9\u7f16\u8f91\u5b57\u6bb5\u5148\u5220\u9664\uff0c\u518d\u6dfb\u52a0
	  			
	  			//\u5b57\u6bb5\u7f16\u8f91\u65f6\u4e0d\u5141\u8bb8\u4fee\u6539\u5b57\u6bb5\u6570\u636e\u5e93\u540d\uff0c\u4e0d\u9700\u8981\u91cd\u65b0\u751f\u6210id\uff0c\u907f\u514d\u6d41\u7a0b\u4e2d\u6570\u636e\u4e22\u5931\u3002TD10290
	  			//String fieldnameForDrop = "";
	  			//RecordSetTrans.executeSql("select fieldname from workflow_billfield where id="+new_OR_modify);
	  			//if(RecordSetTrans.next()) fieldnameForDrop = RecordSetTrans.getString("fieldname");//\u53d6\u5f97\u5b57\u6bb5\u540d
	  			//RecordSetTrans.executeSql("delete from workflow_billfield where id="+new_OR_modify);//\u5220\u9664\u5b57\u6bb5
	  			//RecordSetTrans.executeSql("alter table "+detailtable+" drop column "+fieldnameForDrop);//\u4fee\u6539\u8868\u7ed3\u6784

	  			//\u5b57\u6bb5\u7f16\u8f91\u65f6\u4e0d\u5141\u8bb8\u4fee\u6539\u5b57\u6bb5\u6570\u636e\u5e93\u540d\uff0c\u4e0d\u9700\u8981\u91cd\u65b0\u751f\u6210id\uff0c\u907f\u514d\u6d41\u7a0b\u4e2d\u6570\u636e\u4e22\u5931\u3002TD10290
	  			
				 // RecordSetTrans.executeSql("delete from workflow_SelectItem where isbill=1 and fieldid="+new_OR_modify);//\u5220\u9664\u8868workflow_SelectItem\u4e2d\u8be5\u5b57\u6bb5\u5bf9\u5e94\u6570\u636e
	  		}
	  		
	  		String detailfieldname = "";//\u6570\u636e\u5e93\u5b57\u6bb5\u540d\u79f0
  			int detailfieldlabel = 0;//\u5b57\u6bb5\u663e\u793a\u540d\u6807\u7b7eid
  			String detailfielddbtype = "";//\u5b57\u6bb5\u6570\u636e\u5e93\u7c7b\u578b
  			String _detailfielddbtype = "";//\u5b57\u6bb5\u6570\u636e\u5e93\u7c7b\u578b
  			String detailfieldhtmltype = "";//\u5b57\u6bb5\u9875\u9762\u7c7b\u578b
  			String detailtype = "";//\u5b57\u6bb5\u8be6\u7ec6\u7c7b\u578b
  			String detaildsporder = "";//\u663e\u793a\u987a\u5e8f
  			String viewtype = "1";//viewtype="0"\u8868\u793a\u4e3b\u8868\u5b57\u6bb5,viewtype="1"\u8868\u793a\u660e\u7ec6\u8868\u5b57\u6bb5
  			//String detailtable = "";//\u660e\u7ec6\u8868\u540d
  			int detailtextheight = 0;//\u591a\u884c\u6587\u672c\u6846\u7684\u9ad8\u5ea6
  			String detailtextheight_2 = "";//\u5206\u6743\u7ea7\u522b
  			int detailplaces = 0;//\u591a\u884c\u6587\u672c\u6846\u7684\u9ad8\u5ea6
  			int qfws = 0;
  			int detailselectitem = 0;
  			int detaillinkfield = 0;
  			detailfieldname = Util.null2String(request.getParameter("itemDspName_detail"+i+"_"+temprowindex));
  			detailfieldname = Util.StringReplace(detailfieldname, "\"", "");//TD10108 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u53cc\u5f15\u53f7\u201c"\u201d
  			detailfieldname = Util.StringReplace(detailfieldname, "'", "");//TD31514 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u5355\u5f15\u53f7\u201c'\u201d
  			if(detailfieldname.equals("")) continue;//\u5148\u6dfb\u52a0\u540e\u5220\u9664\u7684
  			
  			int detailimgwidth = Util.getIntValue(request.getParameter("imgwidth_"+i+"_"+temprowindex),0);
            int detailimgheight = Util.getIntValue(request.getParameter("imgheight_"+i+"_"+temprowindex),0);
            
            String detailselectItemType = Util.null2String(request.getParameter("selectItemType"+i+"_"+temprowindex));
			int detailpubchoiceId = Util.getIntValue(Util.null2String(request.getParameter("pubchoiceId"+i+"_"+temprowindex)),0);
			int detailpubchilchoiceId = Util.getIntValue(Util.null2String(request.getParameter("pubchilchoiceId"+i+"_"+temprowindex)),0);
			if(detailselectItemType.equals("0")){
				detailpubchoiceId = 0;
				detailpubchilchoiceId = 0;
			}
			if(detailselectItemType.equals("1")){
				detailpubchilchoiceId = 0;
			}
			if(detailselectItemType.equals("2")){
				detailpubchoiceId = 0;
			}
			
  			String detailfieldlabelname = Util.null2String(request.getParameter("itemFieldName_detail"+i+"_"+temprowindex));
  			detailfieldlabelname = Util.StringReplace(detailfieldlabelname, "\"", "");//TD10108 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u53cc\u5f15\u53f7\u201c"\u201d
  			detailfieldlabelname = Util.StringReplace(detailfieldlabelname, "'", "");//TD31514 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u5355\u5f15\u53f7\u201c'\u201d
  			if(issqlserver) RecordSetTrans.executeSql("select indexid from HtmlLabelInfo where labelname='"+detailfieldlabelname+"' collate Chinese_PRC_CS_AI and languageid="+Util.getIntValue(""+user.getLanguage(),7));
		  	else RecordSetTrans.executeSql("select indexid from HtmlLabelInfo where labelname='"+detailfieldlabelname+"' and languageid="+Util.getIntValue(""+user.getLanguage(),7));
		  	if(RecordSetTrans.next()) detailfieldlabel = RecordSetTrans.getInt("indexid");//\u5982\u679c\u5b57\u6bb5\u540d\u79f0\u5728\u6807\u7b7e\u5e93\u4e2d\u5b58\u5728\uff0c\u53d6\u5f97\u6807\u7b7eid
		  	else{
		  		detailfieldlabel = FormManager.getNewIndexId(RecordSetTrans);//\u751f\u6210\u65b0\u7684\u6807\u7b7eid
			  	if(detailfieldlabel!=-1){//\u66f4\u65b0\u6807\u7b7e\u5e93
			  		labelidsCache+=detailfieldlabel+",";
			  		RecordSetTrans.executeSql("delete from HtmlLabelIndex where id="+detailfieldlabel);
			  		RecordSetTrans.executeSql("delete from HtmlLabelInfo where indexid="+detailfieldlabel);
			  		RecordSetTrans.executeSql("INSERT INTO HtmlLabelIndex values("+detailfieldlabel+",'"+detailfieldlabelname+"')");
			  		RecordSetTrans.executeSql("INSERT INTO HtmlLabelInfo values("+detailfieldlabel+",'"+detailfieldlabelname+"',7)");
			  		RecordSetTrans.executeSql("INSERT INTO HtmlLabelInfo values("+detailfieldlabel+",'"+detailfieldlabelname+"',8)");
			  		RecordSetTrans.executeSql("INSERT INTO HtmlLabelInfo values("+detailfieldlabel+",'"+detailfieldlabelname+"',9)");
			  	}
			  }
  			
			  detailfieldhtmltype = Util.null2String(request.getParameter("itemFieldType_"+i+"_"+temprowindex));
			  if(!detailfieldhtmltype.equals("5")){
			  	detailselectItemType = "0";
			  	detailpubchoiceId=0;
			  	detailpubchilchoiceId=0;
			  }
			  if(detailfieldhtmltype.equals("1")){
			  	detailtype = Util.null2String(request.getParameter("documentType_"+i+"_"+temprowindex));
			  	int decimaldigits = Util.getIntValue(request.getParameter("decimaldigits_"+i+"_"+temprowindex),2);
				  if(detailtype.equals("1")){
				  	String strlength = Util.null2String(request.getParameter("itemFieldScale1_"+i+"_"+temprowindex));
				  	if(Util.getIntValue(strlength,1)<=1) strlength = "1";
			    	if(isoracle) detailfielddbtype="varchar2("+strlength+")";
			    	else detailfielddbtype="varchar("+strlength+")";
			    	
			   	}
				 	if(detailtype.equals("2")){
			   		if(isoracle) detailfielddbtype="integer";
			   		else detailfielddbtype="int";
			   	}
				 	if(detailtype.equals("3")){
				   		if(isoracle) detailfielddbtype="number(15,"+decimaldigits+")";
				   		else detailfielddbtype="decimal(15,"+decimaldigits+")";
				   		qfws=decimaldigits;
			 	 	}
			   	if(detailtype.equals("4")){
			   		if(isoracle) detailfielddbtype="number(15,2)";
			   		else detailfielddbtype="decimal(15,2)";
					}
			   	if(detailtype.equals("5")){
			   		if(isoracle) detailfielddbtype="varchar2(30)";
			   		else detailfielddbtype="varchar(30)";
			   		 qfws=decimaldigits;
					}
			    	if(!new_OR_modify.equals("")){
			    	    String olddetailfielddbtype = "";
			    	    RecordSetTrans.executeSql("select fielddbtype from workflow_billfield where id="+new_OR_modify);
			    	    if(RecordSetTrans.next()) olddetailfielddbtype = RecordSetTrans.getString("fielddbtype");
			    	    
			    	    if(!detailfielddbtype.equals(olddetailfielddbtype)){
			    	        try{
				    	        if(isoracle) RecordSetTrans.executeSql("ALTER TABLE "+detailtable+" MODIFY "+detailfieldname+" "+detailfielddbtype);
				    	        else RecordSetTrans.executeSql("ALTER TABLE "+detailtable+" ALTER COLUMN "+detailfieldname+" "+detailfielddbtype);
			    	    	}catch(Exception ep){
			  	    			modifyFieldtypeSuccess = false;
			  	    			throw ep;
			  	    		}
			    	    }
			    	}
			  }
			  if(detailfieldhtmltype.equals("2")){
			  	detailtype = "1";
			  	String htmledit = Util.null2String(request.getParameter("htmledit_"+i+"_"+temprowindex));
					if(isoracle) detailfielddbtype="varchar2(4000)";
					else if(isdb2) detailfielddbtype="varchar(2000)";
					else detailfielddbtype="text";
					if(!htmledit.equals("")) detailtype=htmledit;
					detailtextheight = Util.getIntValue(Util.null2String(request.getParameter("textheight_"+i+"_"+temprowindex)),0);
			  }
			  if(detailfieldhtmltype.equals("3")){
			  	int temptype = Util.getIntValue(Util.null2String(request.getParameter("broswerType_"+i+"_"+temprowindex)),0);
			  	detailtype = ""+temptype;
			  	
			  	if(temptype>0)
			  		detailfielddbtype=BrowserComInfo.getBrowserdbtype(detailtype+"");
				  	if(temptype==118){
				  		if(isoracle) detailfielddbtype="varchar2(200)";
			              else detailfielddbtype="varchar(200)";
				  	}
					if(temptype==161||temptype==162){
						detailfielddbtype=Util.null2String(request.getParameter("definebroswerType_"+i+"_"+temprowindex));
						if(temptype==161){
							if(isoracle) _detailfielddbtype="varchar2(1000)";
							else if(isdb2) _detailfielddbtype="varchar(1000)";
							else _detailfielddbtype="varchar(1000)";
						}else{
							if(isoracle) _detailfielddbtype="varchar2(4000)";
							else if(isdb2) _detailfielddbtype="varchar(2000)";
							else _detailfielddbtype="text";
						}
					}	
					
					if(temptype==256||temptype==257){
						detailfielddbtype=Util.null2String(request.getParameter("defineTreeBroswerType_"+i+"_"+temprowindex));
						if(temptype==256){
							if(isoracle) _detailfielddbtype="varchar2(1000)";
							else if(isdb2) _detailfielddbtype="varchar(1000)";
							else _detailfielddbtype="varchar(1000)";
						}else{
							if(isoracle) _detailfielddbtype="varchar2(4000)";
							else if(isdb2) _detailfielddbtype="varchar(2000)";
							else _detailfielddbtype="varchar(4000)";
						}
					}	
					
					if(temptype==224||temptype==225){
						detailfielddbtype=Util.null2String(request.getParameter("sapbrowser_"+i+"_"+temprowindex));
						if(temptype==224){
							if(isoracle) _detailfielddbtype="varchar2(1000)";
							else if(isdb2) _detailfielddbtype="varchar(1000)";
							else _detailfielddbtype="varchar(1000)";
						}else{
							if(isoracle) _detailfielddbtype="varchar2(4000)";
							else if(isdb2) _detailfielddbtype="varchar(2000)";
							else _detailfielddbtype="text";
						}
					}
					
					if(temptype==226||temptype==227){
						detailfielddbtype=Util.null2String(request.getParameter("showvalue_"+i+"_"+temprowindex));
						if(temptype==226){
							if(isoracle) _detailfielddbtype="varchar2(1000)";
							else if(isdb2) _detailfielddbtype="varchar(1000)";
							else _detailfielddbtype="varchar(1000)";
						}else{
							if(isoracle) _detailfielddbtype="varchar2(4000)";
							else if(isdb2) _detailfielddbtype="varchar(2000)";
							else _detailfielddbtype="text";
						}
					}
					if(temptype==17){
				  		if(isoracle) {
				  			detailfielddbtype="clob";
				  			_detailfielddbtype="clob";
				  		}else if(isdb2){
				  			_detailfielddbtype="varchar(2000)";
				  		}
						else {
							detailfielddbtype="text";
							_detailfielddbtype="text";
						}
				  	}
				  if(temptype==165||temptype==166||temptype==167||temptype==168) 
				  	//detailtextheight=Util.getIntValue(Util.null2String(request.getParameter("decentralizationbroswerType_"+i+"_"+temprowindex)),0);
				  	detailtextheight_2=Util.null2String(request.getParameter("decentralizationbroswerType_"+i+"_"+temprowindex)); 
			  }
			  if(detailfieldhtmltype.equals("4")){
			  	detailtype = "1";
			  	detailfielddbtype="char(1)";
			  }
			  if(detailfieldhtmltype.equals("5"))	{
			  	detailtype = "1";
			  	if(isoracle) detailfielddbtype="integer";
			  	else detailfielddbtype="int";
			  }
			  if(detailfieldhtmltype.equals("6"))	{
			  	detailtype = "" + Util.getIntValue(Util.null2String(request.getParameter("uploadtype_"+i+"_"+temprowindex)), 1);
			    if(isoracle) detailfielddbtype="varchar2(4000)";
				  else if(isdb2) detailfielddbtype="varchar(2000)";
			    else detailfielddbtype="text";
			    detailtextheight = Util.getIntValue(Util.null2String(request.getParameter("strlength_"+i+"_"+temprowindex)), 0);  
			  }
			  if(detailfieldhtmltype.equals("8")){
				  detailselectitem = Util.getIntValue(Util.null2String(request.getParameter("selectType_"+i+"_"+temprowindex)),0);
				  detaillinkfield = Util.getIntValue(Util.null2String(request.getParameter("childCommonItem_"+i+"_"+temprowindex)),0);
				  detailtype = "1";
				  if(isoracle) detailfielddbtype="integer";
				  	else detailfielddbtype="int";
			  }
  			
			  detaildsporder = Util.null2String(request.getParameter("itemDspOrder_detail"+i+"_"+temprowindex));
			  detaildsporder = ""+Util.getFloatValue(detaildsporder,0);
			  int childfieldid_tmp = Util.getIntValue(request.getParameter("childfieldid_detail"+i+"_"+temprowindex), 0);
			  if(!new_OR_modify.equals("")){//\u4e0d\u4e3a\u7a7a\u8868\u793a\u662f\u7f16\u8f91\u5b57\u6bb5\uff0c\u4e3a\u7a7a\u8868\u793a\u65b0\u6dfb\u52a0\u5b57\u6bb5\u3002
			  	String olddetailfieldname = "";
			  	String olddetailfielddbtype = "";
			  	RecordSetTrans.executeSql("select fieldname,fielddbtype from workflow_billfield where id="+new_OR_modify);
			  	if(RecordSetTrans.next()){
			  	    olddetailfieldname = RecordSetTrans.getString("fieldname");
			  	    olddetailfielddbtype = RecordSetTrans.getString("fielddbtype");
			  	}
			  	RecordSetTrans.executeSql("update workflow_billfield set billid="+formid+",fieldname='"+detailfieldname+"',fieldlabel="+detailfieldlabel+",fielddbtype='"+detailfielddbtype+"',fieldhtmltype="+detailfieldhtmltype+",type="+detailtype+",dsporder="+detaildsporder+",viewtype="+viewtype+",detailtable='"+detailtable+"',textheight="+detailtextheight+",textheight_2='"+detailtextheight_2+"',imgwidth="+detailimgwidth+",imgheight="+detailimgheight+",places="+detailplaces+" ,qfws="+qfws+",selectitem='"+detailselectitem+"',linkfield='"+detaillinkfield+"',selectItemType='"+detailselectItemType+"',pubchoiceId="+detailpubchoiceId+",pubchilchoiceId="+detailpubchilchoiceId+" where id="+new_OR_modify);
			  	if(!detailfieldname.equals(olddetailfieldname) || (!detailfielddbtype.equals(olddetailfielddbtype) && !"1".equals(detailfieldhtmltype) && !"".equals(detailtype))){//\u4fee\u6539\u4e86\u6570\u636e\u5e93\u5b57\u6bb5\u540d\u79f0\u6216\u7c7b\u578b
			  	    RecordSetTrans.executeSql("select "+olddetailfieldname+" from "+detailtable);
			  	    if(!RecordSetTrans.next()){
				  	    RecordSetTrans.executeSql("alter table "+detailtable+" drop column "+olddetailfieldname);
				  	    if(detailfieldhtmltype.equals("3")&&(detailtype.equals("161")||detailtype.equals("162"))){
				  	        RecordSetTrans.executeSql("alter table "+detailtable+" add "+detailfieldname+" "+_detailfielddbtype);
				  	    }else if(detailfieldhtmltype.equals("3")&&(detailtype.equals("256")||detailtype.equals("257"))){
				  	        RecordSetTrans.executeSql("alter table "+detailtable+" add "+detailfieldname+" "+_detailfielddbtype);
				  	    }else if(detailfieldhtmltype.equals("3")&&(detailtype.equals("224")||detailtype.equals("225"))){
				  	        RecordSetTrans.executeSql("alter table "+detailtable+" add "+detailfieldname+" "+_detailfielddbtype);
				  	    }else if(detailfieldhtmltype.equals("3")&&(detailtype.equals("226")||detailtype.equals("227"))){
				  	        RecordSetTrans.executeSql("alter table "+detailtable+" add "+detailfieldname+" "+_detailfielddbtype);
				  	    }
				  	    else{
				  	        RecordSetTrans.executeSql("alter table "+detailtable+" add "+detailfieldname+" "+detailfielddbtype);
				  	    }
				  	 }else{ //\u7269\u7406\u8868\u4e2d\u6709\u6570\u636e\u65f6
			  	    	if(!detailfieldname.equals(olddetailfieldname)){	//\u4fee\u6539\u7684\u662f\u6570\u636e\u5e93\u5b57\u6bb5\u540d\u79f0
			  	    		if(issqlserver){
			  	    			RecordSetTrans.executeSql("EXEC sp_rename '"+detailtable+".["+olddetailfieldname+"]','"+detailfieldname+"','COLUMN'");
			  	    		}else if(isoracle){
			  	    			RecordSetTrans.executeSql("alter table "+detailtable+" rename column "+olddetailfieldname+" to "+detailfieldname);
			  	    		}
			  	    	}
			  	    	
			  	    	if((!detailfielddbtype.equals(olddetailfielddbtype) && !"1".equals(detailfieldhtmltype) && !"".equals(detailtype))){ //\u4fee\u6539\u7684\u662f\u6570\u636e\u5e93\u5b57\u6bb5\u7c7b\u578b
			  	    		String modifyFieldTypeSQL = "";
			  	    		if(detailfieldhtmltype.equals("3")&&(detailtype.equals("161")||detailtype.equals("162"))){
			  	    			if(isoracle){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+detailtable+" MODIFY "+detailfieldname+" "+_detailfielddbtype;
			  	    			}else if(issqlserver){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+detailtable+" ALTER COLUMN "+detailfieldname+" "+_detailfielddbtype;
				    	        }
			  	    		}else if(detailfieldhtmltype.equals("3")&&(detailtype.equals("256")||detailtype.equals("257"))){
			  	    			if(isoracle){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+detailtable+" MODIFY "+detailfieldname+" "+_detailfielddbtype;
			  	    			}else if(issqlserver){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+detailtable+" ALTER COLUMN "+detailfieldname+" "+_detailfielddbtype;
				    	        }
			  	    		}else if(detailfieldhtmltype.equals("3")&&(detailtype.equals("224")||detailtype.equals("225"))){
			  	    			if(isoracle){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+detailtable+" MODIFY "+detailfieldname+" "+_detailfielddbtype;
			  	    			}else if(issqlserver){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+detailtable+" ALTER COLUMN "+detailfieldname+" "+_detailfielddbtype;
				    	        }
			  	    		}else if(detailfieldhtmltype.equals("3")&&(detailtype.equals("226")||detailtype.equals("227"))){
			  	    			if(isoracle){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+detailtable+" MODIFY "+detailfieldname+" "+_detailfielddbtype;
			  	    			}else if(issqlserver){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+detailtable+" ALTER COLUMN "+detailfieldname+" "+_detailfielddbtype;
				    	        }
						  	}else{
						  		if(isoracle){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+detailtable+" MODIFY "+detailfieldname+" "+detailfielddbtype;
			  	    			}else if(issqlserver){
			  	    				modifyFieldTypeSQL = "ALTER TABLE "+detailtable+" ALTER COLUMN "+detailfieldname+" "+detailfielddbtype;
				    	        }
						  	}
			  	    		try{
			  	    			RecordSetTrans.executeSql(modifyFieldTypeSQL);	
			  	    		}catch(Exception ep){
			  	    			modifyFieldtypeSuccess = false;
			  	    			throw ep;
			  	    		}
					  	}
			  	    }
			  	}
				}else{
			  	//\u63d2\u5165\u5b57\u6bb5\u4fe1\u606f
			  	RecordSetTrans.executeSql("INSERT INTO workflow_billfield(billid,fieldname,fieldlabel,fielddbtype,fieldhtmltype,type,dsporder,viewtype,detailtable,textheight,textheight_2,childfieldid,imgwidth,imgheight,places,qfws,selectitem,linkfield,selectItemType,pubchoiceId,pubchilchoiceId) "+
			  	" VALUES ("+formid+",'"+detailfieldname+"',"+detailfieldlabel+",'"+detailfielddbtype+"',"+detailfieldhtmltype+","+detailtype+","+detaildsporder+","+viewtype+",'"+detailtable+"',"+detailtextheight+",'"+detailtextheight_2+"',"+childfieldid_tmp+","+detailimgwidth+","+detailimgheight+","+detailplaces+","+qfws+",'"+detailselectitem+"','"+detaillinkfield+"','"+detailselectItemType+"',"+detailpubchoiceId+","+detailpubchilchoiceId+")");
			  }
			  if(new_OR_modify.equals("")){//\u65b0\u6dfb\u52a0\u5b57\u6bb5
			  //\u66f4\u65b0\u660e\u7ec6\u8868\u7ed3\u6784
			  if(detailfieldhtmltype.equals("3")&&(detailtype.equals("161")||detailtype.equals("162"))){
			  	  RecordSetTrans.executeSql("alter table "+detailtable+" add "+detailfieldname+" "+_detailfielddbtype);
			  }else if(detailfieldhtmltype.equals("3")&&(detailtype.equals("256")||detailtype.equals("257"))){
			  	  RecordSetTrans.executeSql("alter table "+detailtable+" add "+detailfieldname+" "+_detailfielddbtype);
			  }else if(detailfieldhtmltype.equals("3")&&(detailtype.equals("224")||detailtype.equals("225"))){
			  	  RecordSetTrans.executeSql("alter table "+detailtable+" add "+detailfieldname+" "+_detailfielddbtype);
			  }else if(detailfieldhtmltype.equals("3")&&(detailtype.equals("226")||detailtype.equals("227"))){
			  	  RecordSetTrans.executeSql("alter table "+detailtable+" add "+detailfieldname+" "+_detailfielddbtype);
			  }
			  else{
			  	  RecordSetTrans.executeSql("alter table "+detailtable+" add "+detailfieldname+" "+detailfielddbtype);
			  } 
			  }
			  
			  //\u5982\u679c\u662f\u9009\u62e9\u6846\uff0c\u66f4\u65b0\u8868workflow_SelectItem
			  String curfieldid = "";
			  if(new_OR_modify.equals("")){
			      RecordSetTrans.executeSql("select max(id) as id from workflow_billfield");
			      if(RecordSetTrans.next()) curfieldid = RecordSetTrans.getString("id");
			  }else{
			      curfieldid = new_OR_modify;
			  }
			  
			  if(jumpRowindex.equals(i+"_"+temprowindex)){
			      jumpfieldid = Util.getIntValue(curfieldid);
			  }
			  
			  if(detailfieldhtmltype.equals("5")){
			  	
			  	if(detailselectItemType.equals("0") && false){ //\u4e0d\u6267\u884c
			    	int rowsum = Util.getIntValue(Util.null2String(request.getParameter("choiceRows_"+i+"_"+temprowindex)));
	                int curvalue=0;
				  	for(int temprow=1;temprow<=rowsum;temprow++){
				  		String curname = Util.null2String(request.getParameter("field_"+i+"_"+temprowindex+"_"+temprow+"_name"));
				  		if(curname.equals("")) continue;
				  		String curorder = Util.null2String(request.getParameter("field_count_"+i+"_"+temprowindex+"_"+temprow+"_name"));
				  		String isdefault = "n";
				  		String checkValue = Util.null2String(request.getParameter("field_checked_"+i+"_"+temprowindex+"_"+temprow+"_name"));
				  		String cancel = Util.null2String(request.getParameter("cancel_"+i+"_"+temprowindex+"_"+temprow+"_name"));
				  		if(cancel!=null && !cancel.equals("") && cancel.equals("1")){
							cancel = "1";
						}else{
							cancel = "0";
						}
						if(checkValue.equals("1")) isdefault="y";
				  		int isAccordToSubCom_tmp = Util.getIntValue(request.getParameter("isAccordToSubCom"+i+"_"+temprowindex+"_"+temprow), 0);
							String doccatalog = Util.null2String(request.getParameter("maincategory_"+i+"_"+temprowindex+"_"+temprow));
							String docPath = Util.null2String(request.getParameter("pathcategory_"+i+"_"+temprowindex+"_"+temprow));
							String childItem_tmp = Util.null2String(request.getParameter("childItem_"+i+"_"+temprowindex+"_"+temprow));
							String para=curfieldid+flag+"1"+flag+""+curvalue+flag+curname+flag+curorder+flag+isdefault+flag+cancel;
							if(childfieldid_tmp==0)childItem_tmp="";
							RecordSetTrans.executeProc("workflow_selectitem_insert_new",para);//\u66f4\u65b0\u8868workflow_SelectItem
							RecordSetTrans.executeSql("update workflow_SelectItem set docpath='"+docPath+"', docCategory='"+doccatalog+"',childitemid='"+childItem_tmp+"',isAccordToSubCom='"+isAccordToSubCom_tmp+"' where fieldid="+curfieldid+" and selectvalue="+curvalue);
	                        curvalue++;
				  	}
			    }else if (detailselectItemType.equals("1")){
			    	field_pubchoice_map.put(curfieldid,""+detailpubchoiceId);
			    }else if (detailselectItemType.equals("2")){
			    	field_pubchilchoice_map.put(curfieldid,""+detailpubchilchoiceId);
			    }
			  	
			  }
			  
			  if(new_OR_modify.equals("")){//\u65b0\u5efa\u5b57\u6bb5\u63d2\u5165\u5230\u8282\u70b9
			  String insertFieldId = curfieldid;
			  RecordSetTrans.execute("select count(nodeid) as wfnfc from workflow_nodeform where fieldid="+insertFieldId);
			  	int wf_nf_count = 0;
			  	if(RecordSetTrans.next()){
			  		wf_nf_count = Util.getIntValue(RecordSetTrans.getString(1), 0);
			  	}
			  	if(wf_nf_count<1){
					ArrayList arrNodeId = new ArrayList();
					RecordSetTrans.executeSql("select nodeid from workflow_flownode where workflowid in (select id from workflow_base where formid="+formid+" and isbill=1)");
					while(RecordSetTrans.next()){
						arrNodeId.add(RecordSetTrans.getString("nodeid"));
					}
					for(int h=0; h < arrNodeId.size(); h++){
						RecordSetTrans.executeSql("insert into workflow_nodeform(nodeid,fieldid,isview,isedit,ismandatory) values("+(String)arrNodeId.get(h)+","+insertFieldId+",'0','0','0')");
					}
			  	}
			  }
	  	}
	  	
/* 	    	if(!"".equals(newsapmultiBrowservalue)){
	  	
	  		RecordSetTrans.executeSql("select count(*) s from sap_multiBrowser where browsermark='"+newsapmultiBrowservalue+"' and  mxformid='"+formid+"' ");
	  		if(RecordSetTrans.next()&&RecordSetTrans.getInt("s")<=0){
	  			   //\u5982\u679c\u914d\u7f6e\u4e86sap\u96c6\u6210\u591a\u9009\u6d4f\u89c8\u6309\u94ae---\u63d2\u5165sap_multiBrowser\u7684\u6570\u636e
	    	 		RecordSetTrans.executeSql("insert into sap_multiBrowser (mxformname,mxformid,browsermark,isbill) values('"+detailtable+"',"+formid+",'"+newsapmultiBrowservalue+"','1')");
	  		}else{
	  				//\u7531\u4e8e\u591a\u9009\u6d4f\u89c8\u6309\u94ae\u6dfb\u52a0\u4ee5\u540e\u3001\u5220\u9664\u4e0d\u4e86\uff0c\u6240\u4ee5\u4fee\u6539\u64cd\u4f5c\u6ca1\u6709\u4e86\u610f\u4e49
	  		} 
	  	}else{ */
	  			//\u5220\u9664\u4e86\u8868\uff0c\u540c\u6837\u9700\u8981\u5220\u9664sap_multiBrowser\u8868\u4e2d\u7684\u6570\u636e
			  	RecordSetTrans.executeSql("delete  sap_multiBrowser where mxformname='"+detailtable+"' and  mxformid='"+formid+"' ");
	  			//\u4e3a\u4e86\u4e0e\u8001\u8868\u5355\u517c\u5bb9\uff0c\u51e1\u662f\u660e\u7ec6\u8868\u4e2d\u6ca1\u5b57\u6bb5\u7684\u90fd\u9ed8\u8ba4\u628a\u96c6\u6210\u591a\u9009\u6d4f\u89c8\u6309\u94ae\u5220\u9664
		  		//\u6ca1\u6709\u5b57\u6bb5\u5219\u5220\u9664\u8868
		 	 	RecordSetTrans.executeSql("select * from workflow_billfield where billid="+formid+" and detailtable='"+detailtable+"'");
			  	if(!RecordSetTrans.next()){
			  		RecordSetTrans.executeSql("drop table "+detailtable);
			  		RecordSetTrans.executeSql("delete from Workflow_billdetailtable where billid="+formid+" and tablename='"+detailtable+"'");
			  		
			  	} else{
			  			if(!"".equals(newsapmultiBrowservalue)){
				  			//\u8bf4\u660e\u660e\u7ec6\u8868\u4e2d\u6709\u5b57\u6bb5
				  			RecordSetTrans.executeSql("select count(*) s from sap_multiBrowser where browsermark='"+newsapmultiBrowservalue+"' and  mxformid='"+formid+"' ");
					  		if(RecordSetTrans.next()&&RecordSetTrans.getInt("s")<=0){
					  			   //\u5982\u679c\u914d\u7f6e\u4e86sap\u96c6\u6210\u591a\u9009\u6d4f\u89c8\u6309\u94ae---\u63d2\u5165sap_multiBrowser\u7684\u6570\u636e
					    	 		RecordSetTrans.executeSql("insert into sap_multiBrowser (mxformname,mxformid,browsermark,isbill) values('"+detailtable+"',"+formid+",'"+newsapmultiBrowservalue+"','1')");
					  		}else{
					  				//\u7531\u4e8e\u591a\u9009\u6d4f\u89c8\u6309\u94ae\u6dfb\u52a0\u4ee5\u540e\u3001\u5220\u9664\u4e0d\u4e86\uff0c\u6240\u4ee5\u4fee\u6539\u64cd\u4f5c\u6ca1\u6709\u4e86\u610f\u4e49
					  		} 
				  	}
			  	}
			  	
	  /* 	}  */
	  	 
  		
  		/* 	//\u6ca1\u6709\u5b57\u6bb5\u5219\u5220\u9664\u8868
		 	 	RecordSetTrans.executeSql("select * from workflow_billfield where billid="+formid+" and detailtable='"+detailtable+"'");
			  	if(!RecordSetTrans.next()){
			  		RecordSetTrans.executeSql("drop table "+detailtable);
			  		RecordSetTrans.executeSql("delete from Workflow_billdetailtable where billid="+formid+" and tablename='"+detailtable+"'");
			  	} 
			  	//\u5220\u9664\u4e86\u8868\uff0c\u540c\u6837\u9700\u8981\u5220\u9664sap_multiBrowser\u8868\u4e2d\u7684\u6570\u636e
			  	RecordSetTrans.executeSql("delete  sap_multiBrowser where browsermark='"+detailtable+"' and  mxformid='"+formid+"' "); */
	  
	  	
  	}
  	//\u660e\u7ec6\u5b57\u6bb5 \u7ed3\u675f
  	
		RecordSetTrans.commit();
  	
		//\u516c\u5171\u9009\u62e9\u6846\u5b50\u9879 \u4e0a\u7ea7\u9009\u62e9\u6846\u4e0d\u80fd\u91cd\u590d\uff0c\u5982\u679c\u91cd\u590d\u5c06\u5931\u6548\u7684\u4e0a\u7ea7\u9009\u62e9\u6846\u6e05\u7a7a\uff0c\u5e76\u63d0\u793a\u3002
		ArrayList<String> needUpdfieldidList = new ArrayList<String>();
  		String needUpdateIds = "";
  		StringBuffer sqltmp = new StringBuffer();
  		sqltmp.append("SELECT MAX(id) fieldid FROM workflow_billfield WHERE billid = ").append(formid).append(" AND selectItemType='2' AND pubchilchoiceId>0");
  		sqltmp.append(" GROUP BY pubchilchoiceId");
  		sqltmp.append(" HAVING COUNT(pubchilchoiceId) >1");
  		rs2.executeSql(sqltmp.toString());
  		while(rs2.next()){
  			needUpdfieldidList.add(rs2.getString("fieldid"));
  		}
		
		for(Map.Entry<String, String> entry: field_pubchoice_map.entrySet()){
		    int fieldid = Util.getIntValue(entry.getKey(),0);
		    int pubchoiceId = Util.getIntValue(entry.getValue(),0);
			SelectItemManager.setSelectOpBypubid(formid+"",pubchoiceId,fieldid+"",1,user.getLanguage());
		}
		for(Map.Entry<String, String> entry: field_pubchilchoice_map.entrySet()){
		    int fieldid = Util.getIntValue(entry.getKey(),0);
		    int pubchilchoiceId = Util.getIntValue(entry.getValue(),0);
		    
		    if(needUpdfieldidList.contains(fieldid+"")){
		    	needUpdateIds += ","+fieldid;
		    	continue;
		    }
			SelectItemManager.setSuperSelectOp(formid+"",1,pubchilchoiceId,fieldid,user.getLanguage());
		}
		
		
		if(isoracle){
				RecordSet.executeSql("select tablename from Workflow_billdetailtable where billid="+formid);
				while(RecordSet.next()){
						String tempdetailtablename = RecordSet.getString("tablename");
						rs1.executeSql("select * from user_triggers where upper(trigger_name)=upper('"+tempdetailtablename+"_Id_Tr')");
						if(!rs1.next()){//\u660e\u7ec6\u8868id\u81ea\u589e\u957f
								int maxid_tmp = 0;
								rs2.execute("select max(id) from "+tempdetailtablename+"");
								if(rs2.next()){
									maxid_tmp = Util.getIntValue(rs2.getString(1), 0);
								}
								maxid_tmp++;
								try{
									//rs2.executeSql("drop sequence "+tempdetailtablename+"_Id");
									rs2.executeSql("select  1 from user_sequences where upper(sequence_name)=upper('"+tempdetailtablename+"_Id')");
									if(rs2.next()){
										rs2.executeSql("drop sequence "+tempdetailtablename+"_Id");
									}
								}catch(Exception e){}
								rs2.executeSql("create sequence "+tempdetailtablename+"_Id start with "+maxid_tmp+" increment by 1 nomaxvalue nocycle nocache");
								rs2.setChecksql(false);
								rs2.executeSql("CREATE OR REPLACE TRIGGER "+tempdetailtablename+"_Id_Tr before insert on "+tempdetailtablename+" for each row begin select "+tempdetailtablename+"_Id.nextval into :new.id from dual; end;");
						}
				}
		}
		
		//\u6279\u91cf\u5904\u7406pubchoiceid
		rs2.execute("select pubchilchoiceid,id from workflow_billfield where billid = "+formid+" and pubchoiceid = 0 and pubchilchoiceid > 0 and pubchoiceid = 0 and pubchilchoiceid > 0 ");
		while(rs2.next()){
			int pubchilchoiceid_temp = Util.getIntValue(rs2.getString(1),0);
			int id_temp = Util.getIntValue(rs2.getString(2),0);
	    	rs1.execute("update workflow_billfield set pubchoiceid =(select pubchoiceId from workflow_billfield where id = " + pubchilchoiceid_temp + ") where id = " + id_temp);
	    }
		
		ArrayList labelidsArray = Util.TokenizerString(labelidsCache,",");
		for(int i=0;i<labelidsArray.size();i++){//\u6dfb\u52a0\u6807\u7b7eid\u5230\u7f13\u5b58
			LabelComInfo.addLabeInfoCache((String)labelidsArray.get(i));
		}
  		if(issqlserver){//\u56e0\u4e3a\u5728sql\u91cc\u9762detailtable\u7684\u9ed8\u8ba4\u503cNULL\uff0c\u663e\u793a\u6392\u5e8f\u7684\u65f6\u5019\u6309\u7167detailtable\u6392\u5e8f\uff0c\u5f53detailtable\u6709\u7a7a\u503c\u548cnull\u65f6\uff0c\u6392\u5e8f\u4f1a\u4e71
  			RecordSet.executeSql("update workflow_billfield set detailtable = '' where detailtable is null");
  		}
  		
  		if(!needUpdateIds.equals("")){
  			needUpdateIds = needUpdateIds.substring(1);
  			rs2.executeSql("update workflow_billfield set pubchilchoiceId=0 where id in ("+needUpdateIds+")");
  			
  			response.sendRedirect("/workflow/form/editfieldbatch.jsp?formid="+formid+"&dialog=1&isFromMode="+isFromMode+"&message=pubchilchoiceId");
  			return ;
  		}
  		
  		if(jumpfieldid>0){
  			response.sendRedirect("/workflow/form/editfieldbatch.jsp?formid="+formid+"&dialog=1&isFromMode="+isFromMode+"&jumpfieldid="+jumpfieldid);
  			return ;
  		}
  		
  		
  		String fromwhere = Util.null2String(request.getParameter("fromwhere"));
  		if("1".equals(dialog)){ 
			response.sendRedirect("/workflow/form/addfieldbatch.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0&isclose=1&isValue=1&fromwhere="+fromwhere);
		}else{
		 response.sendRedirect("/workflow/form/editformfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0");
  		}
  }catch(Exception e){
		e.printStackTrace();
		RecordSetTrans.rollback();
		String url = "/workflow/form/editformfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0";
		if(!modifyFieldtypeSuccess){
			url += "&message=modifyFieldtypeError";
		}
		
		response.sendRedirect(url);
	}finally{
		formFieldUtil.syncDB(tmpFormid);
	}
}else if(src.equals("deleteField")){
	RecordSetTrans.setAutoCommit(false);
	try{
		String formid = Util.null2String(request.getParameter("formid"));
		int fieldid = Util.getIntValue(Util.null2String(request.getParameter("fieldid")),0);
		String viewtype = Util.null2String(request.getParameter("viewtype"));
		String tablename = "";
		if(viewtype.equals("0")) tablename = Util.null2String(request.getParameter("maintable"));
		if(viewtype.equals("1")) tablename = Util.null2String(request.getParameter("detailtable"));
		
		//\u5982\u679c\u5b57\u6bb5\u88ab\u884c\u5217\u89c4\u5219\u5f15\u7528\uff0c\u5219\u9000\u51fa\u3002
		RecordSetTrans.executeSql("select * from workflow_formdetailinfo where rowcalstr like '%!_"+fieldid+"_%' escape '!' or rowcalstr like '%!_"+fieldid+"' escape '!' or colcalstr like '%!_"+fieldid+"_%' escape '!' or colcalstr like '%!_"+fieldid+"' escape '!' or maincalstr like '%!_"+fieldid+"_%' escape '!' or maincalstr like '%!_"+fieldid+"' escape '!'");
		if(RecordSetTrans.next()){
		    RecordSetTrans.rollback();
		    response.sendRedirect("/workflow/form/editformfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0&message=nodelete");
		    return;
		}

		if(WorkflowSubwfFieldManager.hasSubWfSetting(RecordSetTrans,fieldid,1)){
			RecordSetTrans.rollback();
			response.sendRedirect("/workflow/form/editformfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0&message=nodeleteForSubWf");
			return;
		}

		String fieldnameForDel="";
		RecordSetTrans.executeSql("select fieldname from workflow_billfield where id="+fieldid);
		if(RecordSetTrans.next()) fieldnameForDel = RecordSetTrans.getString("fieldname");//\u53d6\u5f97\u5b57\u6bb5\u540d
		RecordSetTrans.executeSql("delete from workflow_billfield where id="+fieldid);//\u5220\u9664\u5b57\u6bb5
		RecordSetTrans.executeSql("alter table "+tablename+" drop column "+fieldnameForDel);//\u4fee\u6539\u8868\u7ed3\u6784
		RecordSetTrans.executeSql("delete from workflow_SelectItem where isbill=1 and fieldid="+fieldid);//\u5220\u9664\u8868workflow_SelectItem\u4e2d\u8be5\u5b57\u6bb5\u5bf9\u5e94\u6570\u636e
		RecordSetTrans.execute("update workflow_billfield set childfieldid=0 where childfieldid="+fieldid);//\u5982\u679c\u88ab\u5220\u9664\u5b57\u6bb5\u662f\u5b50\u5b57\u6bb5\uff0c\u5219\u9700\u8981\u4fee\u6539
		
		//\u5220\u9664\u4e0e\u8be5\u5b57\u6bb5\u76f8\u5173\u7684\u51fa\u53e3\u6761\u4ef6
		if(viewtype.equals("0")){
		Pattern mpattern = null;
		Matcher mmatcher = null;
		String partStr = "\\b"+fieldnameForDel+"\\b";
		mpattern = Pattern.compile(partStr);
		ArrayList nodelinkidList = new ArrayList();
		ArrayList conditionList = new ArrayList();
		
		//RecordSetTrans.execute("select * from workflow_nodelink where condition like '%"+fieldnameForDel+"%' and workflowid in (select id from workflow_base where formid="+formid+")");
		//while(RecordSetTrans.next()){
		//		int nlid = Util.getIntValue(RecordSetTrans.getString("id"));
		//		String condition = Util.null2String(RecordSetTrans.getString("condition"));
		//		nodelinkidList.add(""+nlid);
		//		conditionList.add(""+condition);
		//}
		
		//\u8c03\u6574\u5b57\u6bb5\u540e\u65b0\u7684\u8bfb\u53d6\u65b9\u5f0f\u5f00\u59cb
		 String strSql = "select * from workflow_nodelink where condition like '%"+fieldnameForDel+"%' and workflowid in (select id from workflow_base where formid="+formid+")";
		 weaver.conn.ConnStatement statement=new weaver.conn.ConnStatement();
   	 	 weaver.conn.RecordSet rs = new weaver.conn.RecordSet();
		 String docContent = "";
	   	 statement.setStatementSql(strSql, false);
	   	 statement.executeQuery();
 		 if(statement.next()){
		  	 if(statement.getDBType().equals("oracle"))
		  	 {
		  			oracle.sql.CLOB theclob = statement.getClob("condition"); 
			  		String readline = "";
			        StringBuffer clobStrBuff = new StringBuffer("");
			        java.io.BufferedReader clobin = new java.io.BufferedReader(theclob.getCharacterStream());
			        while ((readline = clobin.readLine()) != null) clobStrBuff = clobStrBuff.append(readline);
			        clobin.close() ;
			        docContent = clobStrBuff.toString();
		  	  }else{
				  		docContent=statement.getString("condition");
		  }
	  	 
	  	 int nlid = Util.getIntValue(statement.getString("id"));
	  	 nodelinkidList.add(""+nlid);
		 conditionList.add(""+docContent);
 		}
	  	 //\u8c03\u6574\u5b57\u6bb5\u540e\u65b0\u7684\u8bfb\u53d6\u65b9\u5f0f\u7ed3\u675f
		
		for(int cx=0; cx<nodelinkidList.size(); cx++){
				String nlid = Util.null2String((String)nodelinkidList.get(cx));
				String condition = Util.null2String((String)conditionList.get(cx));
				mmatcher = mpattern.matcher(condition);
				boolean find = mmatcher.find();
				if(find==true){
						//RecordSetTrans.execute("update workflow_nodelink set condition='' , conditioncn='' where id="+nlid);
						String sql = "update workflow_nodelink set condition='' , conditioncn='' where id="+nlid;
				        if(statement.getDBType().equals("oracle"))
				            sql = "update workflow_nodelink set condition=empty_clob() , conditioncn=empty_clob() where id="+nlid;
		                statement.setStatementSql(sql);
		                statement.executeUpdate();
				}
		}
		if(null!=statement){
			statement.close();
		}
		}
		//\u5220\u9664\u4e0e\u8be5\u5b57\u6bb5\u76f8\u5173\u7684\u51fa\u53e3\u6761\u4ef6

		//\u5220\u9664\u8282\u70b9\u9644\u52a0\u64cd\u4f5c
		RecordSetTrans.executeSql("delete from  workflow_addinoperate where isnode=1 and objid in (select t1.nodeid from  workflow_flownode t1, workflow_base t2 where t1.workflowid=t2.id and t2.isbill='1' and t2.formid=" + formid + ") and (fieldid =" + fieldid + " or fieldop1id = " + fieldid + " or fieldop2id = " + fieldid + ")" );
		//\u5220\u9664\u51fa\u53e3\u9644\u52a0\u64cd\u4f5c
		RecordSetTrans.executeSql("delete from  workflow_addinoperate where isnode=0 and objid in (select t1.id from  workflow_nodelink t1, workflow_base t2 where t1.workflowid=t2.id and t2.isbill='1' and t2.formid=" + formid + ") and (fieldid =" + fieldid + " or fieldop1id = " + fieldid + " or fieldop2id = " + fieldid + ")");
		//\u5220\u9664\u7531\u81ea\u5b9a\u4e49\u5b57\u6bb5\u4ea7\u751f\u7684\u64cd\u4f5c\u4eba\uff0c\u4e3b\u8981\u662f\u7531\u6d4f\u89c8\u6846\u5e26\u6765\u7684
		RecordSetTrans.executeSql("delete from  workflow_groupdetail where type in(5,6,31,32,7,38,42,43,8,33,9,10,47,34,11,12,13,35,14,15,44,45,46,16) and groupid in(select id from workflow_nodegroup where nodeid in (select t1.nodeid from  workflow_flownode t1, workflow_base t2 where t1.workflowid=t2.id and t2.isbill='1' and t2.formid=" + formid + ")) and objid=" + fieldid);
		//\u5220\u9664\u8282\u70b9\u4e0a\u54ea\u4e9b\u5b57\u6bb5\u53ef\u89c6\u3001\u53ef\u7f16\u8f91\u3001\u5fc5\u8f93\u7684\u4fe1\u606f
		RecordSetTrans.executeSql("delete from  workflow_nodeform where nodeid in (select t1.nodeid from  workflow_flownode t1, workflow_base t2 where t1.workflowid=t2.id and t2.isbill='1' and t2.formid=" + formid + ") and fieldid= " + fieldid);
		//\u5220\u9664\u7279\u6b8a\u5b57\u6bb5\u7684\u4fe1\u606f
		RecordSetTrans.executeSql("delete from workflow_specialfield where isbill=1 and fieldid =" + fieldid);

		
		//\u5982\u679c\u5220\u9664\u7684\u662f\u660e\u7ec6\u8868\u6700\u540e\u4e00\u4e2a\u5b57\u6bb5\uff0c\u5219\u5c06\u8be5\u8868\u540c\u65f6\u5220\u9664
		if(viewtype.equals("1")){
		  RecordSetTrans.executeSql("select * from workflow_billfield where billid="+formid+" and detailtable='"+tablename+"'");
		  if(!RecordSetTrans.next()){
		  	RecordSetTrans.executeSql("drop table "+tablename);
		  	RecordSetTrans.executeSql("delete from Workflow_billdetailtable where billid="+formid+" and tablename='"+tablename+"'");
		  }
	  }
		
		RecordSetTrans.commit();
		response.sendRedirect("/workflow/form/editformfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0");
		
	}catch(Exception e){
		RecordSetTrans.rollback();
	}
}else if(src.equals("editField")){
	char flag=2;
	String hasChanged = Util.null2String(request.getParameter("hasChanged"));
	String canChange = Util.null2String(request.getParameter("canChange"));
	String openrownum = Util.null2String(request.getParameter("openrownum"));
    int imgwidth = Util.getIntValue(request.getParameter("imgwidth"),0);
    int imgheight = Util.getIntValue(request.getParameter("imgheight"),0);
	String formid = Util.null2String(request.getParameter("formid"));
	int fieldid = Util.getIntValue(Util.null2String(request.getParameter("fieldid")),0);
	String selectItemType = Util.null2String(request.getParameter("selectItemType"));
	int pubchoiceId = Util.getIntValue(Util.null2String(request.getParameter("pubchoiceId")),0);
	int pubchilchoiceId = Util.getIntValue(Util.null2String(request.getParameter("pubchilchoiceId")),0);
	if(selectItemType.equals("0")){
		pubchoiceId = 0;
		pubchilchoiceId = 0;
	}
	if(selectItemType.equals("1")){
		pubchilchoiceId = 0;
	}
	if(selectItemType.equals("2")){
		//pubchoiceId = 0;
	}
	
	String needUpdateIds = "";
	String fieldHtmlType = Util.null2String(request.getParameter("FieldHtmlType"));
	if("5".equals(fieldHtmlType)){
		hasChanged = "true";
		if(selectItemType.equals("2")){
			rs2.executeSql("SELECT id FROM workflow_billfield b WHERE b.billid = "+formid+" AND fieldhtmltype='5' AND id !="+fieldid+" AND pubchilchoiceId = "+pubchilchoiceId);
			if(rs2.next()){
				needUpdateIds = ""+fieldid;
			}
		}
	}
	
	if(hasChanged.equals("true")){
		RecordSetTrans.setAutoCommit(false);
		try{
			
			String viewtype = "0";
			String tablename = Util.null2String(request.getParameter("updateTableName"));
			String detailtable = "";
			RecordSetTrans.executeSql("select * from Workflow_billdetailtable where billid="+formid+" and tablename='"+tablename+"'");
			if(RecordSetTrans.next()){
				viewtype = "1";
			    detailtable = tablename;
			}
			
			String fieldname = Util.null2String(request.getParameter("fieldname"));
			String fieldlabelname = Util.null2String(request.getParameter("fieldlabelname"));
			fieldlabelname = Util.StringReplace(fieldlabelname, "\"", "");//TD10108 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u53cc\u5f15\u53f7\u201c"\u201d
			fieldlabelname = Util.StringReplace(fieldlabelname, "'", "");//TD31514 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u5355\u5f15\u53f7\u201c'\u201d
			int lableid = 0;
			if(issqlserver) RecordSetTrans.executeSql("select indexid from HtmlLabelInfo where labelname='"+fieldlabelname+"' collate Chinese_PRC_CS_AI and languageid="+Util.getIntValue(""+user.getLanguage(),7));
			else RecordSetTrans.executeSql("select indexid from HtmlLabelInfo where labelname='"+fieldlabelname+"' and languageid="+Util.getIntValue(""+user.getLanguage(),7));
		  if(RecordSetTrans.next()) lableid = RecordSetTrans.getInt("indexid");//\u5982\u679c\u5b57\u6bb5\u540d\u79f0\u5728\u6807\u7b7e\u5e93\u4e2d\u5b58\u5728\uff0c\u53d6\u5f97\u6807\u7b7eid
		 	else{
				lableid = FormManager.getNewIndexId(RecordSetTrans);//\u751f\u6210\u65b0\u7684\u6807\u7b7eid
			 	if(lableid!=-1){//\u66f4\u65b0\u6807\u7b7e\u5e93
			  	RecordSetTrans.executeSql("delete from HtmlLabelIndex where id="+lableid);
			 		RecordSetTrans.executeSql("delete from HtmlLabelInfo where indexid="+lableid);
			 		RecordSetTrans.executeSql("INSERT INTO HtmlLabelIndex values("+lableid+",'"+fieldlabelname+"')");
			 		RecordSetTrans.executeSql("INSERT INTO HtmlLabelInfo values("+lableid+",'"+fieldlabelname+"',7)");
			 		RecordSetTrans.executeSql("INSERT INTO HtmlLabelInfo values("+lableid+",'"+fieldlabelname+"',8)");
			 		RecordSetTrans.executeSql("INSERT INTO HtmlLabelInfo values("+lableid+",'"+fieldlabelname+"',9)");
			 	}
			}
			
			String documentType = Util.null2String(request.getParameter("DocumentType"));
			String textheight = Util.null2String(request.getParameter("textheight"));
			String textheight_2 = "";
			String fielddbtype = Util.null2String(request.getParameter("fielddbtype"));
			String _fielddbtype = "";//\u5b57\u6bb5\u6570\u636e\u5e93\u7c7b\u578b
			String dsporder = Util.null2String(request.getParameter("itemDspOrder"));
			dsporder = ""+Util.getFloatValue(dsporder,0);
			int qfws=0;
			int places=0;
			int childfieldid = Util.getIntValue(request.getParameter("childfieldid"), 0);
			//if(dsporder.equals("")) dsporder = "0";
			if(!fieldHtmlType.equals("5")){
			  	selectItemType = "0";
			  	pubchoiceId=0;
			  	pubchilchoiceId=0;
			 }
			
			if(fieldHtmlType.equals("1")&&documentType.equals("1")){//\u5355\u884c\u6587\u672c\u6846\u2014\u2014\u6587\u672c\uff0c\u91cd\u65b0\u751f\u6210\u6570\u636e\u5e93\u7c7b\u578b
				String oldfielddbtype = "";
				RecordSetTrans.executeSql("select fielddbtype from workflow_billfield where id="+fieldid);
				if(RecordSetTrans.next()) oldfielddbtype = RecordSetTrans.getString("fielddbtype");
				
				String strlength = Util.null2String(request.getParameter("itemFieldScale1"));
				if(Util.getIntValue(strlength,1)<=1) strlength = "1";
				if(isoracle) fielddbtype="varchar2("+strlength+")";
				else fielddbtype="varchar("+strlength+")";
				
				if(!fielddbtype.equals(oldfielddbtype)){
				    if(isoracle) RecordSetTrans.executeSql("ALTER TABLE "+tablename+" MODIFY "+fieldname+" "+fielddbtype);
				    else RecordSetTrans.executeSql("ALTER TABLE "+tablename+" ALTER COLUMN "+fieldname+" "+fielddbtype);
				}
			} 
			if(canChange.equals("true")){
			    String type = Util.null2String(request.getParameter("DocumentType"));
			    int decimaldigits = Util.getIntValue(request.getParameter("decimaldigits"),2);
			    if(fieldHtmlType.equals("1")){
			        if(type.equals("1")){
			            String strlength = Util.null2String(request.getParameter("itemFieldScale1"));
			            if(Util.getIntValue(strlength,1)<=1) strlength = "1";
			            if(isoracle) fielddbtype="varchar2("+strlength+")";
			            else fielddbtype="varchar("+strlength+")";
			        }
			        if(type.equals("2")){
			            if(isoracle) fielddbtype="integer";
			            else fielddbtype="int";
			        }
			        if(type.equals("3")){
			            if(isoracle) fielddbtype="number(15,"+decimaldigits+")";
			            else fielddbtype="decimal(15,"+decimaldigits+")";
			            qfws=decimaldigits;
			        }
			        if(type.equals("4")){
			            if(isoracle) fielddbtype="number(15,2)";
			            else fielddbtype="decimal(15,2)";
			        }
			        if(type.equals("5")){
			        	if(isoracle) fielddbtype="varchar2(30)";
			            else fielddbtype="varchar(30)";
			            	qfws=decimaldigits;
			        }
			    }
			    if(fieldHtmlType.equals("2")){
			        String htmledit = Util.null2String(request.getParameter("htmledit"));
			        if(htmledit.equals("")) documentType="1";
			        else documentType=htmledit;
			        //if(isoracle) fielddbtype="varchar2(4000)";
			        //else if(isdb2) fielddbtype="varchar(2000)";
			        //else fielddbtype="text";
			        if(isoracle) {
			        	if(!"1".equals(documentType)) {
			        		fielddbtype="clob";
			        	} else {
			        		fielddbtype="varchar2(4000)";
			        	}
			        } else if(isdb2) {
			         	fielddbtype="varchar(2000)";
			        } else {
			        	fielddbtype="text";
			        }
			        textheight = ""+Util.getIntValue(Util.null2String(request.getParameter("textheight")),4);
			    }
			    if(fieldHtmlType.equals("3")){
			        int temptype = Util.getIntValue(Util.null2String(request.getParameter("browsertype")),0);
			        documentType = ""+temptype;
			        if(temptype>0)
			            fielddbtype=BrowserComInfo.getBrowserdbtype(temptype+"");
			        if(temptype==118){
				  		if(isoracle) fielddbtype="varchar2(200)";
			              else fielddbtype="varchar(200)";
				  	}
			        if(temptype==161||temptype==162){
			            fielddbtype=Util.null2String(request.getParameter("definebroswerType"));
			            if(temptype==161){
			                if(isoracle) _fielddbtype="varchar2(1000)";
			                else if(isdb2) _fielddbtype="varchar(1000)";
			                else _fielddbtype="varchar(1000)";
			            }else{
			                if(isoracle) _fielddbtype="varchar2(4000)";
			                else if(isdb2) _fielddbtype="varchar(2000)";
			                else _fielddbtype="text";
			            }
			        }
			        
			        if(temptype==256||temptype==257){//\u6811\u5f62browser
						fielddbtype=Util.null2String(request.getParameter("defineTreeBroswerType"));
						if(temptype==256){
			                if(isoracle) _fielddbtype="varchar2(1000)";
			                else if(isdb2) _fielddbtype="varchar(1000)";
			                else _fielddbtype="varchar(1000)";
			            }else{
			                if(isoracle) _fielddbtype="varchar2(4000)";
			                else if(isdb2) _fielddbtype="varchar(2000)";
			                else _fielddbtype="varchar(4000)";
			            }
				  	}
			        
			        if(temptype==224||temptype==225){
			            fielddbtype=Util.null2String(request.getParameter("sapbrowser"));
			            if(temptype==224){
			                if(isoracle) _fielddbtype="varchar2(1000)";
			                else if(isdb2) _fielddbtype="varchar(1000)";
			                else _fielddbtype="varchar(1000)";
			            }else{
			                if(isoracle) _fielddbtype="varchar2(4000)";
			                else if(isdb2) _fielddbtype="varchar(2000)";
			                else _fielddbtype="text";
			            }
			        }
			        
			        	//zzl-start
				  	if(temptype==226||temptype==227){
						fielddbtype=Util.null2String(request.getParameter("showvalue"));
				  		if(temptype==226){
							if(isoracle) _fielddbtype="varchar2(1000)";
							else if(isdb2) _fielddbtype="varchar(1000)";
							else _fielddbtype="varchar(1000)";
						}else{
							if(isoracle) _fielddbtype="varchar2(4000)";
							else if(isdb2) _fielddbtype="varchar(2000)";
							else _fielddbtype="text";
						}
				  	}

				  	if(temptype==17){
				  		if(isoracle) {
				  			fielddbtype="clob";
				  			_fielddbtype="clob";
				  		}else if(isdb2){
				  			_fielddbtype="varchar(2000)";
				  		}
						else {
							fielddbtype="text";
							_fielddbtype="text";
						}
				  	}
				  	//zzl-end
				  				        
			    }
			    if(fieldHtmlType.equals("4")){
			        documentType = "1";
			        fielddbtype="char(1)";
			    }
			    if(fieldHtmlType.equals("5"))	{
			        documentType = "1";
			        if(isoracle) fielddbtype="integer";
			        else fielddbtype="int";
			    }
			    if(fieldHtmlType.equals("6"))	{
			        if(isoracle) fielddbtype="varchar2(4000)";
			        else if(isdb2) fielddbtype="varchar(2000)";
			        else fielddbtype="text";
			    }
			    if(fieldHtmlType.equals("7"))	{
			        documentType = Util.null2String(request.getParameter("specialfield"));//\u7c7b\u578b
			        if(isoracle) fielddbtype="varchar2(4000)";
			        else if(isdb2) fielddbtype="varchar(2000)";
			        else fielddbtype="text";
			    }
			}
            if (fieldHtmlType.equals("6")) {
                documentType = "" + Util.getIntValue(Util.null2String(request.getParameter("uploadtype")), 1);
                textheight = "" + Util.getIntValue(Util.null2String(request.getParameter("strlength")), 0);
            }
			
			if (fieldHtmlType.equals("3")) {
			    int temptype = Util.getIntValue(Util.null2String(request.getParameter("browsertype")),0);
                if(temptype==165||temptype==166||temptype==167||temptype==168) {
			        //textheight=""+Util.getIntValue(Util.null2String(request.getParameter("decentralizationbroswerType")),0); 
			        textheight_2=Util.null2String(request.getParameter("decentralizationbroswerType")); 
				}
			}

            
            //\u5982\u679c canChange\u4e3atrue\uff0c\u5e76\u4e14 \u5b57\u6bb5\u662f\u4e0b\u62c9\u6846 \u516c\u5171\u9009\u62e9\u6846\u3001\u516c\u5171\u9009\u62e9\u6846\u5b50\u9879 \u5219\u4e0d\u80fd\u5220\u6389\u65b0\u589e\uff0c\u53ea\u80fd\u4fee\u6539 \u5426\u5219fieldid\u53d8\u4e86\u5f71\u54cd\u5f15\u7528
            boolean isUpdate = (canChange.equals("true") && fieldid>0 && fieldHtmlType.equals("5") && (selectItemType.equals("1") || selectItemType.equals("2")))?true:false;           

            
			if(canChange.equals("true")&&isFromMode!=1 && !isUpdate){
			    //\u5148\u5220\u9664\u5b57\u6bb5\u76f8\u5173\u4fe1\u606f\u518d\u63d2\u5165  
			    String fieldnameForDel="";
			    RecordSetTrans.executeSql("select fieldname from workflow_billfield where id="+fieldid);
			    if(RecordSetTrans.next()) fieldnameForDel = RecordSetTrans.getString("fieldname");//\u53d6\u5f97\u5b57\u6bb5\u540d
			    String oldtablename = Util.null2String(request.getParameter("oldtablename"));
			    RecordSetTrans.executeSql("delete from workflow_billfield where id="+fieldid);//\u5220\u9664\u5b57\u6bb5
				/*
				 * \u67e5\u8be2\u5982\u679c\u5f53\u524d\u8fd9\u4e2a\u8868\u5355\u6ca1\u6709\u88ab\u6d41\u7a0b\u5f15\u7528\uff0c\u90a3\u4e48\u6211\u66f4\u65b0formtable\u7684\u7edf\u4e00\u90fd\u7528drop\u7136\u540eadd
				*/
				boolean canChangeFieldDbType = true;
				String sqlForCanChangeFieldDbType = " select 1 from " + tablename + " where " + fieldname + " is not null ";
				rs2.writeLog("==========szg==========sqlForCanChangeFieldDbType:" + " select 1 from " + tablename + " where " + fieldname + " is not null ");
                rs2.executeSql(sqlForCanChangeFieldDbType);
				if(rs2.next()){
                    canChangeFieldDbType = false;
				}
                rs2.writeLog("==========szg==========canChangeFieldDbType:" + canChangeFieldDbType);
			    if(!fieldname.equals(fieldnameForDel)||!oldtablename.equals(tablename) || canChangeFieldDbType){//TD10207 chujun
			        RecordSetTrans.executeSql("alter table "+oldtablename+" drop column "+fieldnameForDel);//\u4fee\u6539\u8868\u7ed3\u6784
			        int temptype = Util.getIntValue(Util.null2String(request.getParameter("browsertype")),0);
			        if(!"".equals(_fielddbtype)){
						rs2.writeLog("==========szg==========alterSql:" + "alter table "+tablename+" add "+fieldname+" "+_fielddbtype);
			        	RecordSetTrans.executeSql("alter table "+tablename+" add "+fieldname+" "+_fielddbtype);//\u66f4\u65b0\u8868\u7ed3\u6784
			        }else{
						rs2.writeLog("==========szg==========alterSql:" + "alter table "+tablename+" add "+fieldname+" "+_fielddbtype);
			        	RecordSetTrans.executeSql("alter table "+tablename+" add "+fieldname+" "+fielddbtype);//\u66f4\u65b0\u8868\u7ed3\u6784
			        }
			    }
			    			
			    //RecordSetTrans.executeSql("delete from workflow_SelectItem where fieldid="+fieldid);//\u5220\u9664\u8868workflow_SelectItem\u4e2d\u8be5\u5b57\u6bb5\u5bf9\u5e94\u6570\u636e

			    //\u66f4\u65b0\u5b57\u6bb5\u4fe1\u606f
			    RecordSetTrans.executeSql("INSERT INTO workflow_billfield(billid,fieldname,fieldlabel,fielddbtype,fieldhtmltype,type,dsporder,viewtype,detailtable,textheight,textheight_2,imgwidth,imgheight,places,qfws,selectItemType,pubchoiceId,pubchilchoiceId) "+
			    " VALUES ("+formid+",'"+fieldname+"',"+lableid+",'"+fielddbtype+"',"+fieldHtmlType+","+documentType+","+dsporder+","+viewtype+",'"+detailtable+"',"+textheight+",'"+textheight_2+"',"+imgwidth+","+imgheight+","+places+","+qfws+",'"+selectItemType+"',"+pubchoiceId+","+pubchilchoiceId+")");
			}else if(canChange.equals("true")&&isFromMode==1){
			    String fieldnameForDel="";
			    RecordSetTrans.executeSql("select fieldname from workflow_billfield where id="+fieldid);
			    if(RecordSetTrans.next()) fieldnameForDel = RecordSetTrans.getString("fieldname");//\u53d6\u5f97\u5b57\u6bb5\u540d
			    String oldtablename = Util.null2String(request.getParameter("oldtablename"));
			    if(!fieldname.equals(fieldnameForDel)||!oldtablename.equals(tablename)){//TD10207 chujun
			        RecordSetTrans.executeSql("alter table "+oldtablename+" drop column "+fieldnameForDel);//\u4fee\u6539\u8868\u7ed3\u6784
			        int temptype = Util.getIntValue(Util.null2String(request.getParameter("browsertype")),0);
			        if(!"".equals(_fielddbtype)){
			        	RecordSetTrans.executeSql("alter table "+tablename+" add "+fieldname+" "+_fielddbtype);//\u66f4\u65b0\u8868\u7ed3\u6784
			        }else{
			        	RecordSetTrans.executeSql("alter table "+tablename+" add "+fieldname+" "+fielddbtype);//\u66f4\u65b0\u8868\u7ed3\u6784
			        }
			    }
				RecordSetTrans.executeSql("update workflow_billfield set billid="+formid+",fieldname='"+fieldname+"',fieldlabel="+lableid+",fielddbtype='"+fielddbtype+"',fieldhtmltype="+fieldHtmlType+",type="+documentType+",dsporder="+dsporder+",viewtype="+viewtype+",detailtable='"+detailtable+"',textheight="+textheight+",textheight_2='"+textheight_2+"',childfieldid="+childfieldid+",imgwidth="+imgwidth+",imgheight="+imgheight+" ,places="+places+" ,qfws="+qfws+",selectItemType='"+selectItemType+"',pubchoiceId="+pubchoiceId+",pubchilchoiceId="+pubchilchoiceId+" where id="+fieldid);
			}else{
                RecordSetTrans.executeSql("update workflow_billfield set billid="+formid+",fieldname='"+fieldname+"',fieldlabel="+lableid+",fielddbtype='"+fielddbtype+"',fieldhtmltype="+fieldHtmlType+",type="+documentType+",dsporder="+dsporder+",viewtype="+viewtype+",detailtable='"+detailtable+"',textheight="+textheight+",textheight_2='"+textheight_2+"',childfieldid="+childfieldid+",imgwidth="+imgwidth+",imgheight="+imgheight+" ,places="+places+" ,qfws="+qfws+",selectItemType='"+selectItemType+"',pubchoiceId="+pubchoiceId+",pubchilchoiceId="+pubchilchoiceId+" where id="+fieldid);
			}
			
			String curfieldid = "";
			if(canChange.equals("true")&&isFromMode!=1 && !isUpdate){
			    RecordSetTrans.executeSql("select max(id) as id from workflow_billfield where billid="+formid);
			    if(RecordSetTrans.next()) curfieldid = RecordSetTrans.getString("id");
			    RecordSetTrans.executeSql("update  Workflow_Selectitem set fieldid="+curfieldid+" where fieldid="+fieldid+" and isbill=1");
			    RecordSetTrans.executeSql("update  Workflow_SelectitemObj set fieldid="+curfieldid+" where fieldid="+fieldid+" and isbill=1");
			}else{
			    curfieldid = ""+fieldid;
			}  
			fieldid = Util.getIntValue(curfieldid,0);		
			//\u5982\u679c\u662f\u9009\u62e9\u6846\uff0c\u66f4\u65b0\u8868workflow_SelectItem
			if(fieldHtmlType.equals("5") && selectItemType.equals("0")){
			  RecordSetTrans.executeSql("update workflow_billfield set childfieldid="+childfieldid +" where id="+curfieldid);
			  int rowsum = Util.getIntValue(Util.null2String(request.getParameter("choiceRows_rows")));
			  String ids = "";
	          for(int temprow=1;temprow<=rowsum;temprow++){
	          	String id_temp = Util.null2String(request.getParameter("id_"+temprow));
	          	if(!"".equals(id_temp))
	          		ids += "," + id_temp;
	          }
	          
	          String delsql = "delete from workflow_SelectItem where isbill=1 and fieldid="+fieldid;
	      	  if(!"".equals(ids)){
	      		  ids = ids.substring(1);
	      		  delsql += " and id not in ("+ids+")";
	      	  }
	      	  RecordSetTrans.executeSql(delsql);
			  
	      	  int curvalue = -1;
	    	  RecordSet.execute("select max(selectvalue) from workflow_SelectItem where isbill = 1 and fieldid="+fieldid);
	    	  if(RecordSet.next())
	    		 curvalue = Util.getIntValue(Util.null2String(RecordSet.getString(1)),-1);
              
			  for(int temprow=1;temprow<=rowsum;temprow++){
				String id_temp = Util.null2String(request.getParameter("id_"+temprow));
				String curname = Util.null2String(request.getParameter("field_name_"+temprow));
			  	if(curname.equals("")) continue;
			  	String curorder = Util.null2String(request.getParameter("field_count_name_"+temprow));
			  	String isdefault = "n";
			  	String checkValue = Util.null2String(request.getParameter("field_checked_name_"+temprow));
			  	String cancel = Util.null2String(request.getParameter("cancel_"+temprow+"_name")); 
			  	if(cancel!=null && !cancel.equals("") && cancel.equals("1")){
						cancel = "1";
					}else{
						cancel = "0";
					}
			  	if(checkValue.equals("1")) isdefault="y";
			  	int isAccordToSubCom_tmp = Util.getIntValue(request.getParameter("isAccordToSubCom"+temprow), 0);
					String doccatalog = Util.null2String(request.getParameter("maincategory_"+temprow));
					String docPath = Util.null2String(request.getParameter("pathcategory_"+temprow));
					String childItem = Util.null2String(request.getParameter("childItem"+temprow));
					if(childfieldid==0)childItem="";
					if("".equals(id_temp)){
						curvalue++;
						String para=curfieldid+flag+"1"+flag+""+curvalue+flag+curname+flag+curorder+flag+isdefault+flag+cancel;
						RecordSetTrans.executeProc("workflow_selectitem_insert_new",para);//\u66f4\u65b0\u8868workflow_SelectItem
						RecordSetTrans.executeSql("update workflow_SelectItem set docpath='"+docPath+"', docCategory='"+doccatalog+"',childitemid='"+childItem+"',isAccordToSubCom='"+isAccordToSubCom_tmp+"' where fieldid="+curfieldid+" and selectvalue="+curvalue);
					}else{
						String updatesql = "update workflow_selectitem set selectname = '"+curname+"'," +
						"listorder="+curorder+"," +
						"isdefault='"+isdefault+"',"+
						"cancel='"+cancel+"',"+
						"docpath='"+docPath+"',"+
						"docCategory='"+doccatalog+"',"+
						"childitemid='"+childItem+"',"+
						"isAccordToSubCom='"+isAccordToSubCom_tmp+"'"+
						" where  fieldid = " + fieldid + "  and id = " + id_temp;
						RecordSetTrans.execute(updatesql);
					}
				}
			}

	        if(fieldHtmlType.equals("7")){
               String displayname = Util.null2String(request.getParameter("displayname"));//\u663e\u793a\u540d
               String linkaddress = Util.null2String(request.getParameter("linkaddress"));//\u94fe\u63a5\u5730\u5740
			  
               String descriptivetext = Util.null2String(request.getParameter("descriptivetext"));//\u63cf\u8ff0\u6027\u6587\u5b57
               descriptivetext = Util.spacetoHtml(descriptivetext);	
               descriptivetext = Util.htmlFilter4UTF8(descriptivetext);
	  	       String specialfield = Util.null2String(request.getParameter("specialfield"));//\u7c7b\u578b
               String sql = "delete from workflow_specialfield where isbill = 1 and fieldid = " + fieldid;
	           RecordSetTrans.executeSql(sql);
	           if(specialfield.equals("1")){
	              sql = "insert into workflow_specialfield(fieldid,displayname,linkaddress,isform,isbill) values("+fieldid+",'"+displayname+"','"+linkaddress+"',0,1)";    
	           }else{
	              sql = "insert into workflow_specialfield(fieldid,descriptivetext,isform,isbill) values("+fieldid+",'"+descriptivetext+"',0,1)";    
	           }
		       RecordSetTrans.executeSql(sql);	
	        }

			RecordSetTrans.commit();
			
			if(fieldHtmlType.equals("5")){
				if(selectItemType.equals("1")){
					SelectItemManager.setSelectOpBypubid(formid,pubchoiceId,fieldid+"",1,user.getLanguage());
				}else if(selectItemType.equals("2")){
					if(needUpdateIds.equals("")){
						SelectItemManager.setSuperSelectOp(formid,1,pubchilchoiceId,fieldid,user.getLanguage(),pubchoiceId);
					}
				}
			}
			
			
			LabelComInfo.addLabeInfoCache(""+lableid);
	  		
			if(!needUpdateIds.equals("")){
				RecordSet.executeSql("update workflow_billfield set pubchilchoiceId=0 where id in ("+needUpdateIds+")");
				response.sendRedirect("/workflow/field/editfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&fieldid="+fieldid+"&message=pubchilchoiceId");
				return;
			}
			
			if(issqlserver){//\u56e0\u4e3a\u5728sql\u91cc\u9762detailtable\u7684\u9ed8\u8ba4\u503cNULL\uff0c\u663e\u793a\u6392\u5e8f\u7684\u65f6\u5019\u6309\u7167detailtable\u6392\u5e8f\uff0c\u5f53detailtable\u6709\u7a7a\u503c\u548cnull\u65f6\uff0c\u6392\u5e8f\u4f1a\u4e71
	  			RecordSet.executeSql("update workflow_billfield set detailtable = '' where detailtable is null");
	  		}
			if(!openrownum.equals("")){
			      response.sendRedirect("/workflow/field/editfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0&src=editfield&isused=true&fieldid="+fieldid+"&dialog=1&isclose=1");
			}else{
			response.sendRedirect("/workflow/form/editformfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0");
			}
		}catch(Exception e){
			RecordSetTrans.rollback();
		}finally{
		formFieldUtil.syncDB(tmpFormid);
	}
	}else{
		if(!openrownum.equals("")){
			      response.sendRedirect("/workflow/field/editfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0&src=editfield&isused=true&dialog=1&isclose=1");
			}else{
		    response.sendRedirect("/workflow/form/editformfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0");
			}
	}
}else if(src.equals("addFieldSingle")){
	char flag=2;
	String isAccordToSubComFieldid ="";
	String openrownum="";
	boolean isToEditSubComFieldid=false;
	RecordSetTrans.setAutoCommit(false);
	boolean needUpdate = false;
	try{
			String formid = Util.null2String(request.getParameter("formid"));
			String updateTableName = Util.null2String(request.getParameter("updateTableName"));//\u9700\u8981\u66f4\u65b0\u7684\u8868
			String documentType = Util.null2String(request.getParameter("DocumentType"));
			 openrownum= Util.null2String(request.getParameter("openrownum"));
			String fieldname = Util.null2String(request.getParameter("fieldname"));
			String fieldlabelname = Util.null2String(request.getParameter("fieldlabelname"));
			int selectitem = 0;//\u516c\u5171\u9009\u62e9\u9879\u5b57\u6bb5
  			int linkfield = 0;//\u5173\u8054\u9009\u62e9\u9879\u5b57
  			selectitem = Util.getIntValue(Util.null2String(request.getParameter("selectType")),0);
			linkfield = Util.getIntValue(Util.null2String(request.getParameter("childCommonItem")),0);
			String fieldHtmlType = Util.null2String(request.getParameter("FieldHtmlType"));
			String selectItemType = Util.null2String(request.getParameter("selectItemType"));
			int pubchoiceId = Util.getIntValue(Util.null2String(request.getParameter("pubchoiceId")),0);
			int pubchilchoiceId = Util.getIntValue(Util.null2String(request.getParameter("pubchilchoiceId")),0);
			String locateType = Util.null2String(request.getParameter("locateType"));
			if(selectItemType.equals("0")){
				pubchoiceId = 0;
				pubchilchoiceId = 0;
			}
			if(selectItemType.equals("1")){
				pubchilchoiceId = 0;
			}
			if(selectItemType.equals("2")){
				//pubchoiceId = 0;
			}
			
			if(fieldHtmlType.equals("5") && selectItemType.equals("2")){
				rs2.executeSql("SELECT id FROM workflow_billfield b WHERE b.billid = "+formid+" AND fieldhtmltype='5' AND pubchilchoiceId = "+pubchilchoiceId);
				if(rs2.next()){
					needUpdate = true;
					pubchilchoiceId = 0;
				}
			}
			
			fieldlabelname = Util.StringReplace(fieldlabelname, "\"", "");//TD10108 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u53cc\u5f15\u53f7\u201c"\u201d
			fieldlabelname = Util.StringReplace(fieldlabelname, "'", "");//TD31514 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u5355\u5f15\u53f7\u201c'\u201d
			int lableid = 0;
			if(issqlserver) RecordSetTrans.executeSql("select indexid from HtmlLabelInfo where labelname='"+fieldlabelname+"' collate Chinese_PRC_CS_AI and languageid="+Util.getIntValue(""+user.getLanguage(),7));
			else RecordSetTrans.executeSql("select indexid from HtmlLabelInfo where labelname='"+fieldlabelname+"' and languageid="+Util.getIntValue(""+user.getLanguage(),7));
		  if(RecordSetTrans.next()) lableid = RecordSetTrans.getInt("indexid");//\u5982\u679c\u5b57\u6bb5\u540d\u79f0\u5728\u6807\u7b7e\u5e93\u4e2d\u5b58\u5728\uff0c\u53d6\u5f97\u6807\u7b7eid
		 	else{
				lableid = FormManager.getNewIndexId(RecordSetTrans);//\u751f\u6210\u65b0\u7684\u6807\u7b7eid
			 	if(lableid!=-1){//\u66f4\u65b0\u6807\u7b7e\u5e93
			  	RecordSetTrans.executeSql("delete from HtmlLabelIndex where id="+lableid);
			 		RecordSetTrans.executeSql("delete from HtmlLabelInfo where indexid="+lableid);
			 		RecordSetTrans.executeSql("INSERT INTO HtmlLabelIndex values("+lableid+",'"+fieldlabelname+"')");
			 		RecordSetTrans.executeSql("INSERT INTO HtmlLabelInfo values("+lableid+",'"+fieldlabelname+"',7)");
			 		RecordSetTrans.executeSql("INSERT INTO HtmlLabelInfo values("+lableid+",'"+fieldlabelname+"',8)");
			 		RecordSetTrans.executeSql("INSERT INTO HtmlLabelInfo values("+lableid+",'"+fieldlabelname+"',9)");
			 	}
			}
			
			String type = "";
			String fielddbtype = "";
			String _fielddbtype = "";
			String dsporder = Util.null2String(request.getParameter("itemDspOrder"));
			dsporder = ""+Util.getFloatValue(dsporder,0);
			int childfieldid = Util.getIntValue(request.getParameter("childfieldid"),0);
			//if(dsporder.equals("")) dsporder="0";
			String viewtype = "0";
			String detailtable = "";
			int tableIndex=-1;
			int places =0;
			int qfws =0;
			RecordSetTrans.executeSql("select * from Workflow_billdetailtable where billid="+formid+" and tablename='"+updateTableName+"'");
			if(RecordSetTrans.next()){
				viewtype = "1";
				detailtable = updateTableName;
				tableIndex=Util.getIntValue(RecordSetTrans.getString("orderid"),1)-1;
			}
			int textheight = 0;
			String textheight_2 = "";
            int imgwidth = Util.getIntValue(request.getParameter("imgwidth"),0);
            int imgheight = Util.getIntValue(request.getParameter("imgheight"),0);
            
            if(!fieldHtmlType.equals("5")){
			  	selectItemType = "0";
			  	pubchoiceId=0;
			  	pubchilchoiceId=0;
			 }else{
				 if(pubchilchoiceId > 0){
					 rs2.execute("select pubchoiceid from workflow_billfield where id = " + pubchilchoiceId);
					 rs2.next();
					 pubchoiceId = rs2.getInt(1);
				 }
			 }

			if(fieldHtmlType.equals("1")){
				int decimaldigits = Util.getIntValue(request.getParameter("decimaldigits"),2);
			  	type = Util.null2String(request.getParameter("DocumentType"));	
				  if(type.equals("1")){
				  	String strlength = Util.null2String(request.getParameter("itemFieldScale1"));
				  	if(Util.getIntValue(strlength,1)<=1) strlength = "1";
			    	if(isoracle) fielddbtype="varchar2("+strlength+")";
			    	else fielddbtype="varchar("+strlength+")";
			   	}
				 	if(type.equals("2")){
			   		if(isoracle) fielddbtype="integer";
			   		else fielddbtype="int";
			   	}
				 	if(type.equals("3")){
			   		if(isoracle) fielddbtype="number(15,"+decimaldigits+")";
			   		else fielddbtype="decimal(15,"+decimaldigits+")";
			   		qfws=decimaldigits;
			 	 	}
			   	if(type.equals("4")){
			   		if(isoracle) fielddbtype="number(15,2)";
			   		else fielddbtype="decimal(15,2)";
					}
					if(type.equals("5")){
						if(isoracle) fielddbtype="varchar2(30)";
			              else fielddbtype="varchar(30)";
			              	 qfws=decimaldigits;
          			}
			  }
			  if(fieldHtmlType.equals("9")){
			      type = Util.null2String(request.getParameter("locationType"));	  
				   
				  if(isoracle) fielddbtype = "clob";
				  else fielddbtype = "text";
			  }
			  if(fieldHtmlType.equals("2")){
			  	String htmledit = Util.null2String(request.getParameter("htmledit"));
			  	type = htmledit.isEmpty() ? "1" : htmledit;
					//if(isoracle) fielddbtype="varchar2(4000)";
				    //else if(isdb2) fielddbtype="varchar(2000)";
				    //else fielddbtype="text";
				    if(isoracle) {
				   		fielddbtype = "1".equals(type) ? "varchar2(4000)" : "clob";
				    } else if(isdb2) {
				         	fielddbtype="varchar(2000)";
				    } else {
				        fielddbtype="text";
				    }
					textheight = Util.getIntValue(Util.null2String(request.getParameter("textheight")),4);
			  }
			  if(fieldHtmlType.equals("3")){
			  	int temptype = Util.getIntValue(Util.null2String(request.getParameter("browsertype")),0);
			  	type = ""+temptype;
			  	if(temptype>0)
			  		fielddbtype=BrowserComInfo.getBrowserdbtype(type+"");
			  	if(temptype==118){
			  		if(isoracle) fielddbtype="varchar2(200)";
		              else fielddbtype="varchar(200)";
			  	}
					if(temptype==161||temptype==162){
						fielddbtype=Util.null2String(request.getParameter("definebroswerType"));
				  		if(temptype==161){
							if(isoracle) _fielddbtype="varchar2(1000)";
							else if(isdb2) _fielddbtype="varchar(1000)";
							else _fielddbtype="varchar(1000)";
						}else{
							if(isoracle) _fielddbtype="varchar2(4000)";
							else if(isdb2) _fielddbtype="varchar(2000)";
							else _fielddbtype="text";
						}
				  	}
					
					if(temptype==256||temptype==257){//\u6811\u5f62browser
						fielddbtype=Util.null2String(request.getParameter("defineTreeBroswerType"));
						if(temptype==256){
							if(isoracle) _fielddbtype="varchar2(1000)";
							else if(isdb2) _fielddbtype="varchar(1000)";
							else _fielddbtype="varchar(1000)";
						}else{
							if(isoracle) _fielddbtype="varchar2(4000)";
							else if(isdb2) _fielddbtype="varchar(2000)";
							else _fielddbtype="varchar(4000)";
						}
				  	}
					
					if(temptype==224||temptype==225){
						fielddbtype=Util.null2String(request.getParameter("sapbrowser"));
				  		if(temptype==224){
							if(isoracle) _fielddbtype="varchar2(1000)";
							else if(isdb2) _fielddbtype="varchar(1000)";
							else _fielddbtype="varchar(1000)";
						}else{
							if(isoracle) _fielddbtype="varchar2(4000)";
							else if(isdb2) _fielddbtype="varchar(2000)";
							else _fielddbtype="text";
						}
				  	}
				  	//zzl-start
				  	if(temptype==226||temptype==227){
						fielddbtype=Util.null2String(request.getParameter("showvalue"));
				  		if(temptype==226){
							if(isoracle) _fielddbtype="varchar2(1000)";
							else if(isdb2) _fielddbtype="varchar(1000)";
							else _fielddbtype="varchar(1000)";
						}else{
							if(isoracle) _fielddbtype="varchar2(4000)";
							else if(isdb2) _fielddbtype="varchar(2000)";
							else _fielddbtype="text";
						}
				  	}
				  	if(temptype==17){
				  		if(isoracle) {
				  			fielddbtype="clob";
				  			_fielddbtype="clob";
				  		}else if(isdb2){
				  			_fielddbtype="varchar(2000)";
				  		}
						else {
							fielddbtype="text";
							_fielddbtype="text";
						}
				  	}
				  	//zzl-end
				  	
				  if(temptype==165||temptype==166||temptype==167||temptype==168) 
				  	//textheight=Util.getIntValue(Util.null2String(request.getParameter("decentralizationbroswerType")),0); 
				  	textheight_2=Util.null2String(request.getParameter("decentralizationbroswerType")); 
			  }
			  if(fieldHtmlType.equals("4")){
			  	type = "1";
			  	fielddbtype="char(1)";
			  }
			  if(fieldHtmlType.equals("5"))	{
			  	type = "1";
			  	if(isoracle) fielddbtype="integer";
			  	else fielddbtype="int";
			  }
			  if(fieldHtmlType.equals("8"))	{
			  	type = "1";
			  	if(isoracle) fielddbtype="integer";
			  	else fielddbtype="int";
			  }
			  if(fieldHtmlType.equals("6"))	{
			  	type = ""+Util.getIntValue(Util.null2String(request.getParameter("uploadtype")),1);
			    if(isoracle) fielddbtype="varchar2(4000)";
				  else if(isdb2) fielddbtype="varchar(2000)";
			    else fielddbtype="text";
                  textheight=Util.getIntValue(Util.null2String(request.getParameter("strlength")),0);
			  }
			  if(fieldHtmlType.equals("7"))	{
			  	type = Util.null2String(request.getParameter("specialfield"));//\u7c7b\u578b
			    if(isoracle) fielddbtype="varchar2(4000)";
				  else if(isdb2) fielddbtype="varchar(2000)";
			    else fielddbtype="text";
			  }
			if(isoracle == false&&fielddbtype.indexOf("varchar2")!=-1){
				fielddbtype = fielddbtype.replaceAll("varchar2","varchar");
	  		}
			//\u66f4\u65b0\u660e\u7ec6\u8868\u7ed3\u6784
			if(fieldHtmlType.equals("3")&&(type.equals("161")||type.equals("162"))){
				RecordSetTrans.executeSql("alter table "+updateTableName+" add "+fieldname+" "+_fielddbtype);
			}else if(fieldHtmlType.equals("3")&&(type.equals("224")||type.equals("225"))){
				RecordSetTrans.executeSql("alter table "+updateTableName+" add "+fieldname+" "+_fielddbtype);
			}else if(fieldHtmlType.equals("3")&&(type.equals("226")||type.equals("227"))){
				RecordSetTrans.executeSql("alter table "+updateTableName+" add "+fieldname+" "+_fielddbtype);
			}else if(fieldHtmlType.equals("3")&&(type.equals("256")||type.equals("257"))){
				RecordSetTrans.executeSql("alter table "+updateTableName+" add "+fieldname+" "+_fielddbtype);
			}else if(fieldHtmlType.equals("3")&&type.equals("17")){
				RecordSetTrans.executeSql("alter table "+updateTableName+" add "+fieldname+" "+_fielddbtype);
			}
			else{
				RecordSetTrans.executeSql("alter table "+updateTableName+" add "+fieldname+" "+fielddbtype);
			}
			//\u63d2\u5165\u5b57\u6bb5\u4fe1\u606f
			RecordSetTrans.executeSql("INSERT INTO workflow_billfield(billid,fieldname,fieldlabel,fielddbtype,fieldhtmltype,type,dsporder,viewtype,detailtable,textheight,textheight_2,childfieldid,imgwidth,imgheight,places,qfws,selectitem,linkfield,selectItemType,pubchoiceId,pubchilchoiceId,locatetype) "+
			" VALUES ("+formid+",'"+fieldname+"',"+lableid+",'"+fielddbtype+"',"+fieldHtmlType+","+type+","+dsporder+","+viewtype+",'"+detailtable+"',"+textheight+",'"+textheight_2+"',"+childfieldid+","+imgwidth+","+imgheight+","+places+","+qfws+","+selectitem+","+linkfield+",'"+selectItemType+"',"+pubchoiceId+","+pubchilchoiceId+",'"+locateType+"')");
			String curfieldid = "";
			RecordSetTrans.executeSql("select max(id) as id from workflow_billfield");
			if(RecordSetTrans.next()) curfieldid = RecordSetTrans.getString("id");
			//\u5982\u679c\u662f\u9009\u62e9\u6846\uff0c\u66f4\u65b0\u8868workflow_SelectItem
			if(fieldHtmlType.equals("5") && selectItemType.equals("0")){
			  int rowsum = Util.getIntValue(Util.null2String(request.getParameter("choiceRows_rows")));
              int curvalue=0;
			  for(int temprow=1;temprow<=rowsum;temprow++){
			  	String curname = Util.null2String(request.getParameter("field_name_"+temprow));
			  	if(curname.equals("")) continue;
			  	String curorder = Util.null2String(request.getParameter("field_count_name_"+temprow));
			  	String isdefault = "n";
			  	String checkValue = Util.null2String(request.getParameter("field_checked_name_"+temprow));
				String childItem = Util.null2String(request.getParameter("childItem"+temprow));
				if(childfieldid==0)childItem="";
			  	if(checkValue.equals("1")) isdefault="y";
			  	int isAccordToSubCom_tmp = Util.getIntValue(request.getParameter("isAccordToSubCom"+temprow), 0);
					String doccatalog = Util.null2String(request.getParameter("maincategory_"+temprow));
					String docPath = Util.null2String(request.getParameter("pathcategory_"+temprow));
				String cancel = Util.null2String(request.getParameter("field_cancel_"+temprow));
                 if(isAccordToSubCom_tmp==1){
				isToEditSubComFieldid=true;
			     }
				 isAccordToSubComFieldid=curfieldid;
					String para=curfieldid+flag+"1"+flag+""+curvalue+flag+curname+flag+curorder+flag+isdefault;
					RecordSetTrans.executeProc("workflow_SelectItem_Insert",para);//\u66f4\u65b0\u8868workflow_SelectItem
					RecordSetTrans.executeSql("update workflow_SelectItem set docpath='"+docPath+"', docCategory='"+doccatalog+"', childitemid='"+childItem+"',isAccordToSubCom='"+isAccordToSubCom_tmp+"',cancel='"+cancel+"' where fieldid="+curfieldid+" and selectvalue="+curvalue);
                    curvalue++;
				}
			}
		
	        if(fieldHtmlType.equals("7")){
               String displayname = Util.null2String(request.getParameter("displayname"));//\u663e\u793a\u540d
               String linkaddress = Util.null2String(request.getParameter("linkaddress"));//\u94fe\u63a5\u5730\u5740
               String descriptivetext = Util.null2String(request.getParameter("descriptivetext"));//\u63cf\u8ff0\u6027\u6587\u5b57
               descriptivetext = Util.spacetoHtml(descriptivetext);	
               descriptivetext = Util.htmlFilter4UTF8(descriptivetext);
	  	       String specialfield = Util.null2String(request.getParameter("specialfield"));//\u7c7b\u578b
	  	       String sql = "";
	           if(specialfield.equals("1")){
	              sql = "insert into workflow_specialfield(fieldid,displayname,linkaddress,isform,isbill) values("+curfieldid+",'"+displayname+"','"+linkaddress+"',0,1)";    
	           }else{
	              sql = "insert into workflow_specialfield(fieldid,descriptivetext,isform,isbill) values("+curfieldid+",'"+descriptivetext+"',0,1)";    
	           }
		       RecordSetTrans.executeSql(sql);	
	        }
	    
	    
	        String insertFieldId = curfieldid;
		  	RecordSetTrans.execute("select count(nodeid) as wfnfc from workflow_nodeform where fieldid="+insertFieldId);
		  	int wf_nf_count = 0;
		  	if(RecordSetTrans.next()){
		  		wf_nf_count = Util.getIntValue(RecordSetTrans.getString(1), 0);
		  	}
		  	if(wf_nf_count<1){
				ArrayList arrNodeId = new ArrayList();
				RecordSetTrans.executeSql("select nodeid from workflow_flownode where workflowid in (select id from workflow_base where formid="+formid+" and isbill=1)");
				while(RecordSetTrans.next()){
					arrNodeId.add(RecordSetTrans.getString("nodeid"));
				}
				for(int h=0; h < arrNodeId.size(); h++){
					RecordSetTrans.executeSql("insert into workflow_nodeform(nodeid,fieldid,isview,isedit,ismandatory) values("+(String)arrNodeId.get(h)+","+insertFieldId+",'0','0','0')");
				}    
		  	}
			RecordSetTrans.commit();
			
			if(fieldHtmlType.equals("5")){
				if(selectItemType.equals("1")){
					SelectItemManager.setSelectOpBypubid(formid,pubchoiceId,insertFieldId,1,user.getLanguage());
				}else if(selectItemType.equals("2")){
					if(!needUpdate){
						SelectItemManager.setSuperSelectOp(formid,1,pubchilchoiceId,Util.getIntValue(insertFieldId,0),user.getLanguage(),pubchoiceId);						
					}
				}
			}
			
	  		if(issqlserver){//\u56e0\u4e3a\u5728sql\u91cc\u9762detailtable\u7684\u9ed8\u8ba4\u503cNULL\uff0c\u663e\u793a\u6392\u5e8f\u7684\u65f6\u5019\u6309\u7167detailtable\u6392\u5e8f\uff0c\u5f53detailtable\u6709\u7a7a\u503c\u548cnull\u65f6\uff0c\u6392\u5e8f\u4f1a\u4e71
	  			RecordSet.executeSql("update workflow_billfield set detailtable = '' where detailtable is null");
	  		}
			LabelComInfo.addLabeInfoCache(""+lableid);
			
			if(needUpdate){
				response.sendRedirect("/workflow/field/editfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&fieldid="+curfieldid+"&message=pubchilchoiceId");
				return;
			}
			
			if("1".equals(dialog)){
				if("wfcode".equals(fromWFCode)){
					if(isToEditSubComFieldid){
			      response.sendRedirect("/workflow/field/editfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0&src=editfield&isused=true&fieldid="+isAccordToSubComFieldid+"&dialog=1&isclose=0&openrownum="+openrownum);
				}else{
					response.sendRedirect("/workflow/field/addfield0.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0&isclose=1&isValue=2&fieldHtmlType="+fieldHtmlType+"&fieldname="+fieldname+"&lableid="+lableid);
				  }
				}else if("exceldesign".equals(fromWFCode)){
					if(isToEditSubComFieldid){
			      response.sendRedirect("/workflow/field/editfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0&src=editfield&isused=true&fieldid="+isAccordToSubComFieldid+"&dialog=1&isclose=0&openrownum="+openrownum);
				}else{
					response.sendRedirect("/workflow/field/addfield0.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0&isclose=1&isValue=3&curfieldid="+curfieldid+"&fieldlabelname="+URLEncoder.encode(fieldlabelname, "utf-8")+"&tableIndex="+tableIndex);
				 }
				}else{
					if(isToEditSubComFieldid){
			      response.sendRedirect("/workflow/field/editfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0&src=editfield&isused=true&fieldid="+isAccordToSubComFieldid+"&dialog=1&isclose=0&openrownum="+openrownum);
				}else{
					response.sendRedirect("/workflow/field/addfield0.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0&isclose=1&isValue=1");
				  }
				}
			}else{
			   response.sendRedirect("/workflow/form/editformfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0");
			}
		}catch(Exception e){
			RecordSetTrans.rollback();
		}finally{
		formFieldUtil.syncDB(tmpFormid);
	}
}else if(src.equals("listDelete")){
	
	try{
		RecordSetTrans.setAutoCommit(false);
		
		String deleteids = Util.null2String(request.getParameter("deleteids"));
		int formid = Util.getIntValue(Util.null2String(request.getParameter("formid")),0);
		tmpFormid = formid;
		ArrayList deleteidsArray = Util.TokenizerString(deleteids,",");
		for(int i=0;i<deleteidsArray.size();i++){
			String fieldid = (String)deleteidsArray.get(i);
			String tablename = "";
			String viewtype = "";
			
			String fieldnameForDel="";
			RecordSetTrans.executeSql("select * from workflow_billfield where id="+fieldid);
			if(RecordSetTrans.next()){
				fieldnameForDel = RecordSetTrans.getString("fieldname");//\u53d6\u5f97\u5220\u9664\u5b57\u6bb5\u7684\u5b57\u6bb5\u540d
				viewtype = RecordSetTrans.getString("viewtype");//\u53d6\u5f97\u5220\u9664\u5b57\u6bb5\u7684\u5b57\u6bb5\u7c7b\u578b
				if(viewtype.equals("1")){
					tablename = RecordSetTrans.getString("detailtable");//\u53d6\u5f97\u660e\u7ec6\u5b57\u6bb5\u6240\u5728\u8868\u540d
				}else if(viewtype.equals("0")){
					RecordSetTrans.executeSql("select tablename from workflow_bill where id="+formid);
					if(RecordSetTrans.next()){
						tablename = RecordSetTrans.getString("tablename");//\u53d6\u5f97\u4e3b\u5b57\u6bb5\u6240\u5728\u8868\u540d
					}
				}
			}

			//\u5982\u679c\u5b57\u6bb5\u88ab\u884c\u5217\u89c4\u5219\u5f15\u7528\uff0c\u5219\u9000\u51fa\u3002
			RecordSetTrans.executeSql("select * from workflow_formdetailinfo where rowcalstr like '%!_"+fieldid+"_%' escape '!' or rowcalstr like '%!_"+fieldid+"' escape '!' or colcalstr like '%!_"+fieldid+"_%' escape '!' or colcalstr like '%!_"+fieldid+"' escape '!' or maincalstr like '%!_"+fieldid+"_%' escape '!' or maincalstr like '%!_"+fieldid+"' escape '!'");
			if(RecordSetTrans.next()){
			    RecordSetTrans.rollback();
			    response.sendRedirect("/workflow/form/editformfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0&message=nodelete");
			    return;
			}			

            if(WorkflowSubwfFieldManager.hasSubWfSetting(RecordSetTrans,Util.getIntValue(fieldid,0),1)){
			    RecordSetTrans.rollback();
			    response.sendRedirect("/workflow/form/editformfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0&message=nodeleteForSubWf");
			    return;
			}

            RecordSetTrans.executeSql("delete from workflow_billfield where id="+fieldid);//\u5220\u9664\u5b57\u6bb5
			RecordSetTrans.executeSql("alter table "+tablename+" drop column "+fieldnameForDel);//\u4fee\u6539\u8868\u7ed3\u6784
			RecordSetTrans.executeSql("delete from workflow_SelectItem where isbill=1 and fieldid="+fieldid);//\u5220\u9664\u8868workflow_SelectItem\u4e2d\u8be5\u5b57\u6bb5\u5bf9\u5e94\u6570\u636e

	    //\u5220\u9664\u4e0e\u8be5\u5b57\u6bb5\u76f8\u5173\u7684\u51fa\u53e3\u6761\u4ef6
	    if(viewtype.equals("0")){
			Pattern mpattern = null;
			Matcher mmatcher = null;
			String partStr = "\\b"+fieldnameForDel+"\\b";
			mpattern = Pattern.compile(partStr);
			ArrayList nodelinkidList = new ArrayList();
			ArrayList conditionList = new ArrayList();
			/*
			RecordSetTrans.execute("select * from workflow_nodelink where condition like '%"+fieldnameForDel+"%' and workflowid in (select id from workflow_base where formid="+formid+")");
			while(RecordSetTrans.next()){
			    int nlid = Util.getIntValue(RecordSetTrans.getString("id"));
			    String condition = Util.null2String(RecordSetTrans.getString("condition"));
			    nodelinkidList.add(""+nlid);
			    conditionList.add(""+condition);
			}
			*/
			
			//\u8c03\u6574\u5b57\u6bb5\u540e\u65b0\u7684\u8bfb\u53d6\u65b9\u5f0f\u5f00\u59cb
			 String strSql = "select * from workflow_nodelink where condition like '%"+fieldnameForDel+"%' and workflowid in (select id from workflow_base where formid="+formid+")";
			 weaver.conn.ConnStatement statement=new weaver.conn.ConnStatement();
	    	 weaver.conn.RecordSet rs = new weaver.conn.RecordSet();
			 String docContent = "";
	    	 statement.setStatementSql(strSql, false);
	    	 statement.executeQuery();
	  		if(statement.next()){
			  	 if(statement.getDBType().equals("oracle"))
			  	 {
			  			oracle.sql.CLOB theclob = statement.getClob("condition"); 
				  		String readline = "";
				        StringBuffer clobStrBuff = new StringBuffer("");
				        java.io.BufferedReader clobin = new java.io.BufferedReader(theclob.getCharacterStream());
				        while ((readline = clobin.readLine()) != null) clobStrBuff = clobStrBuff.append(readline);
				        clobin.close() ;
				        docContent = clobStrBuff.toString();
			  	  }else{
					  		docContent=statement.getString("condition");
			  }
		  	 
		  	 int nlid = Util.getIntValue(statement.getString("id"));
		  	 nodelinkidList.add(""+nlid);
		     conditionList.add(""+docContent);
	  		}
		  	 //\u8c03\u6574\u5b57\u6bb5\u540e\u65b0\u7684\u8bfb\u53d6\u65b9\u5f0f\u7ed3\u675f
			
			for(int cx=0; cx<nodelinkidList.size(); cx++){
			    String nlid = Util.null2String((String)nodelinkidList.get(cx));
			    String condition = Util.null2String((String)conditionList.get(cx));
			    mmatcher = mpattern.matcher(condition);
			    boolean find = mmatcher.find();
			    if(find==true){
			        RecordSetTrans.execute("update workflow_nodelink set condition='' , conditioncn='' where id="+nlid);
			        String sql = "update workflow_nodelink set condition='' , conditioncn='' where id="+nlid;
			        if(statement.getDBType().equals("oracle"))
			            sql = "update workflow_nodelink set condition=empty_clob() , conditioncn=empty_clob() where id="+nlid;
	                statement.setStatementSql(sql);
	                statement.executeUpdate();
			    }
			}
			if(null!=statement){
			statement.close();
			}
			}
			//\u5220\u9664\u4e0e\u8be5\u5b57\u6bb5\u76f8\u5173\u7684\u51fa\u53e3\u6761\u4ef6
		
			//\u5220\u9664\u8282\u70b9\u9644\u52a0\u64cd\u4f5c
			RecordSetTrans.executeSql("delete from  workflow_addinoperate where isnode=1 and objid in (select t1.nodeid from  workflow_flownode t1, workflow_base t2 where t1.workflowid=t2.id and t2.isbill='1' and t2.formid=" + formid + ") and (fieldid =" + fieldid + " or fieldop1id = " + fieldid + " or fieldop2id = " + fieldid + ")" );
			//\u5220\u9664\u51fa\u53e3\u9644\u52a0\u64cd\u4f5c
			RecordSetTrans.executeSql("delete from  workflow_addinoperate where isnode=0 and objid in (select t1.id from  workflow_nodelink t1, workflow_base t2 where t1.workflowid=t2.id and t2.isbill='1' and t2.formid=" + formid + ") and (fieldid =" + fieldid + " or fieldop1id = " + fieldid + " or fieldop2id = " + fieldid + ")");
			//\u5220\u9664\u7531\u81ea\u5b9a\u4e49\u5b57\u6bb5\u4ea7\u751f\u7684\u64cd\u4f5c\u4eba\uff0c\u4e3b\u8981\u662f\u7531\u6d4f\u89c8\u6846\u5e26\u6765\u7684
			RecordSetTrans.executeSql("delete from  workflow_groupdetail where type in(5,6,31,32,7,38,42,43,8,33,9,10,47,34,11,12,13,35,14,15,44,45,46,16) and groupid in(select id from workflow_nodegroup where nodeid in (select t1.nodeid from  workflow_flownode t1, workflow_base t2 where t1.workflowid=t2.id and t2.isbill='1' and t2.formid=" + formid + ")) and objid=" + fieldid);
			//\u5220\u9664\u8282\u70b9\u4e0a\u54ea\u4e9b\u5b57\u6bb5\u53ef\u89c6\u3001\u53ef\u7f16\u8f91\u3001\u5fc5\u8f93\u7684\u4fe1\u606f
			RecordSetTrans.executeSql("delete from  workflow_nodeform where nodeid in (select t1.nodeid from  workflow_flownode t1, workflow_base t2 where t1.workflowid=t2.id and t2.isbill='1' and t2.formid=" + formid + ") and fieldid= " + fieldid);
			//\u5220\u9664\u7279\u6b8a\u5b57\u6bb5\u7684\u4fe1\u606f
			RecordSetTrans.executeSql("delete from workflow_specialfield where isbill=1 and fieldid =" + fieldid);
			RecordSetTrans.execute("update workflow_billfield set childfieldid=0 where childfieldid="+fieldid);//\u5982\u679c\u88ab\u5220\u9664\u5b57\u6bb5\u662f\u5b50\u5b57\u6bb5\uff0c\u5219\u9700\u8981\u4fee\u6539

						
			//\u5982\u679c\u5220\u9664\u7684\u662f\u660e\u7ec6\u8868\u6700\u540e\u4e00\u4e2a\u5b57\u6bb5\uff0c\u5219\u5c06\u8be5\u8868\u540c\u65f6\u5220\u9664
			if(viewtype.equals("1")){
			  RecordSetTrans.executeSql("select * from workflow_billfield where billid="+formid+" and detailtable='"+tablename+"'");
			  if(!RecordSetTrans.next()){
			  	RecordSetTrans.executeSql("drop table "+tablename);
			  	RecordSetTrans.executeSql("delete from Workflow_billdetailtable where billid="+formid+" and tablename='"+tablename+"'");
			  }
		  }	
		}
		RecordSetTrans.commit();
		response.sendRedirect("/workflow/form/editformfield.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=0");
		
	}catch(Exception e){
		RecordSetTrans.rollback();
	}
	
}else if(src.equals("editfieldlabel")){
	String formid = Util.null2String(request.getParameter("formid"));
	String changefieldids = Util.null2String(request.getParameter("changefieldids"));
	String isfromformid = Util.null2String(request.getParameter("isfromformid"));
	RecordSetTrans.setAutoCommit(false);
	try{
		ArrayList changefieldidsArray = Util.TokenizerString(changefieldids,",");
		for(int i=0;i<changefieldidsArray.size();i++){
			String fieldid = (String)changefieldidsArray.get(i);
			String fieldnameCN = Util.null2String(request.getParameter("field_"+fieldid+"_CN"));
			String fieldnameEn = Util.null2String(request.getParameter("field_"+fieldid+"_En"));
			String fieldnameTW = Util.null2String(request.getParameter("field_"+fieldid+"_TW"));
			fieldnameCN = Util.StringReplace(fieldnameCN, "\"", "");//TD10108 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u53cc\u5f15\u53f7\u201c"\u201d
			fieldnameCN = Util.StringReplace(fieldnameCN, "'", "");//TD31514 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u5355\u5f15\u53f7\u201c'\u201d
			fieldnameEn = Util.StringReplace(fieldnameEn, "\"", "");//TD10108 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u53cc\u5f15\u53f7\u201c"\u201d
			fieldnameEn = Util.StringReplace(fieldnameEn, "'", "");//TD31514 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u5355\u5f15\u53f7\u201c'\u201d
			fieldnameTW = Util.StringReplace(fieldnameTW, "\"", "");//TD10108 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u53cc\u5f15\u53f7\u201c"\u201d
			fieldnameTW = Util.StringReplace(fieldnameTW, "'", "");//TD31514 \u8868\u5355\u5b57\u6bb5\u663e\u793a\u540d\u4e0d\u53ef\u4ee5\u542b\u6709\u534a\u89d2\u5355\u5f15\u53f7\u201c'\u201d
			int lableid = 0;
			if(issqlserver) RecordSetTrans.executeSql("select indexid from HtmlLabelInfo where labelname='"+fieldnameCN+"' collate Chinese_PRC_CS_AI and languageid=7");
			else RecordSetTrans.executeSql("select indexid from HtmlLabelInfo where labelname='"+fieldnameCN+"' and languageid=7");
		  if(RecordSet.next()) lableid = RecordSet.getInt("indexid");//\u5982\u679c\u5b57\u6bb5\u540d\u79f0\u5728\u6807\u7b7e\u5e93\u4e2d\u5b58\u5728\uff0c\u53d6\u5f97\u6807\u7b7eid,\u4ee5\u4e2d\u6587\u4e3a\u51c6\u3002
			else{//\u4e0d\u5b58\u5728\u5219\u751f\u6210\u65b0\u7684\u6807\u7b7eid
				lableid = FormManager.getNewIndexId(RecordSetTrans);
			}
			if(lableid!=-1){//\u66f4\u65b0\u6807\u7b7e\u5e93
				RecordSet.executeSql("delete from HtmlLabelIndex where id="+lableid);
				RecordSet.executeSql("delete from HtmlLabelInfo where indexid="+lableid);
				RecordSet.executeSql("INSERT INTO HtmlLabelIndex values("+lableid+",'"+fieldnameCN+"')");
				RecordSet.executeSql("INSERT INTO HtmlLabelInfo values("+lableid+",'"+fieldnameCN+"',7)");//\u4e2d\u6587
				RecordSet.executeSql("INSERT INTO HtmlLabelInfo values("+lableid+",'"+fieldnameEn+"',8)");//\u82f1\u6587
				RecordSet.executeSql("INSERT INTO HtmlLabelInfo values("+lableid+",'"+fieldnameTW+"',9)");//\u7e41\u4f53
			}
			
			RecordSet.executeSql("update workflow_billfield set fieldlabel="+lableid+" where id="+fieldid);
			
			LabelComInfo.addLabeInfoCache(""+lableid);//\u66f4\u65b0\u7f13\u5b58
			
		}
		RecordSetTrans.commit();
	}catch(Exception exception){
		RecordSetTrans.rollback();
	}
	if(!isfromformid.equals("")){
		response.sendRedirect("/workflow/form/editformfield.jsp?formid="+isfromformid+"&isFromMode="+isFromMode+"&ajax=0");
	}else{
		response.sendRedirect("/workflow/form/addformfieldlabel0.jsp?formid="+formid+"&isFromMode="+isFromMode+"&ajax=1");
	}
} else if(src.equalsIgnoreCase("checktablename")){
	response.reset();
	String checkStatus = "-1";	//-1:\u6b63\u5e38  0:\u68c0\u6d4b\u8868\u540d\u65f6\u51fa\u73b0\u672a\u77e5\u9519\u8bef   1:\u8868\u540d\u5df2\u5b58\u5728  2.\u8868\u540d\u4e0d\u5408\u6cd5
	String tablename = Util.null2String(request.getParameter("tablename"));
	
	try{
		boolean tableISExists = FormManager.isHaveSameTableInDB(tablename);
		
	    if (tableISExists) {
	    	checkStatus = "1";
	    }else{	//\u68c0\u67e5\u8868\u540d\u662f\u5426\u5408\u6cd5(\u6a21\u62df\u521b\u5efa\u8868)
	    	try{
	    		boolean createTableSuccess = RecordSet.executeSql("create table " + tablename + "(id varchar(10))");
	    		if(!createTableSuccess){
	    			checkStatus = "2";
	    		}
	    	}finally{
	    		try{
	    			RecordSet.executeSql("drop table " + tablename);
	    		}catch(Exception e){}
	    	}
	    }
	    //Thread.sleep(2000);
	}catch(Exception ep){
		ep.printStackTrace();
		checkStatus = "0";
	}
	out.print(checkStatus);
	return;
}else if(src.equalsIgnoreCase("getDetailTablename")){
	response.reset();
	String maintablename = Util.null2String(request.getParameter("maintablename"));
	String detailtablename = "";
	if(maintablename.startsWith("uf_")){
		maintablename = maintablename.substring(3);
	}
	
	int detailEndIndex = Util.getIntValue(request.getParameter("detailEndIndex"), 1);
	String pageNoSaveTablenames = Util.null2String(request.getParameter("pageNoSaveTablenames")).toLowerCase();
	
	for(; detailEndIndex <Integer.MAX_VALUE; detailEndIndex++){
		detailtablename = maintablename + "_dt" + detailEndIndex;
		if(pageNoSaveTablenames.indexOf(detailtablename.toLowerCase() + ",") == -1){
			String testTablename = maintablename.startsWith("uf_") ? ("uf_" + detailtablename) : detailtablename;
			boolean tableISExists = FormManager.isHaveSameTableInDB(testTablename);
			if(!tableISExists){
				break;
			}
		}
	}
	out.print(detailtablename);
}

    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("workflow/form/form_operation.jsp"), -5557871994891709911L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string2;
  private final static char []_jsp_string1;
  private final static char []_jsp_string3;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string2 = "	\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
    _jsp_string3 = "\r\n\r\n".toCharArray();
  }
}
