/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._workflow._workflow;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.general.Util;
import java.util.*;
import oracle.sql.CLOB;
import java.io.BufferedReader;
import java.io.Writer;
import weaver.conn.*;
import weaver.workflow.workflow.WorkflowVersion;
import weaver.rdeploy.workflow.WorkflowInitialization;
import weaver.workflow.workflow.GroupDetailMatrix;
import weaver.workflow.workflow.GroupDetailMatrixDetail;
import weaver.workflow.workflow.WfRightManager;
import java.net.*;
import weaver.hrm.*;
import weaver.systeminfo.*;
import weaver.general.*;
import ln.LN;
import weaver.hrm.settings.ChgPasswdReminder;
import weaver.hrm.settings.HrmSettingsComInfo;
import weaver.hrm.settings.RemindSettings;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import weaver.workflow.workflow.TestWorkflowCheck;
import weaver.systeminfo.template.UserTemplate;
import weaver.systeminfo.setting.*;
import weaver.login.LicenseCheckLogin;
import weaver.hrm.online.IPUtil;
import java.util.Map;
import weaver.fna.general.FnaWfInitE8;
import weaver.workflow.workflow.WFMainManager;
import weaver.workflow.workflow.WorkflowComInfo2;

public class _wf_0operation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;

  
  private String getCurrWuiConfig(HttpSession session, User user, String keyword) throws Exception {
  	
  	if (keyword == null || "".equals(keyword)) {
  		return "";
  	}
  	
  	String curTheme = "";
  	String curskin = "";
  
  	
  		String[] rtnValue = getHrmUserSetting(user);
  		
  		curTheme = rtnValue[0];
  		curskin = rtnValue[1];
  		if(curTheme.equals("")||curskin.equals("")){
  			String templatetype = getCurrE8TemplateType(user);
  			if("".equals(templatetype)){
  				curTheme = "ecologyBasic";
  				curskin = "default";
  			}else if("ecology7".equals(templatetype)){
  				curTheme ="ecology7";
  				curskin = getCurrE8SkinInfo(user);
  			}else{
  				curTheme ="ecology8";
  				curskin = "default";
  			}
  			
  			
  			
  			
  		}else{
  			curTheme = rtnValue[0];
  			curskin = rtnValue[1];
  		}
  		
  		if(curTheme.equals("custom")){
  			curTheme ="ecology8";
  		}
  		
  		session.setAttribute("SESSION_CURRENT_THEME", curTheme);
  		session.setAttribute("SESSION_CURRENT_SKIN", curskin);
  	
  	if ("THEME".equals(keyword.toUpperCase())) {
  		return curTheme;
  	}
  	
  	if ("SKIN".equals(keyword.toUpperCase())) {
  		return curskin;
  	}
  	return "";
  }
  
  
  
  private String getCurrSkinFolder(User user) throws Exception {
  	String pslSkinfolder = "";
  	weaver.conn.RecordSet rs = new weaver.conn.RecordSet();
  
  	int userid = user.getUID();
  
  	rs.executeSql("select skin from HrmUserSetting where resourceId=" + userid);
  	
  	if (rs.next()) {
  		pslSkinfolder = rs.getString("skin");
  	}
  
  	if (pslSkinfolder == null || "".equals(pslSkinfolder)) {
  	    pslSkinfolder = "default";
  	}
  	return pslSkinfolder;
  }
  
  private String getCurrE8TemplateType(User user){
  	weaver.conn.RecordSet rs = new weaver.conn.RecordSet();
  	weaver.systeminfo.template.UserTemplate  userTemplate = new weaver.systeminfo.template.UserTemplate();
  	userTemplate.getTemplateByUID(user.getUID(),user.getUserSubCompany1());
  	
  	
  	String skin =  userTemplate.getTemplatetype();
  	
  	
  	return skin;
  	
  }
  
  private String getCurrE8SkinInfo(User user){
  	weaver.conn.RecordSet rs = new weaver.conn.RecordSet();
  	weaver.systeminfo.template.UserTemplate  userTemplate = new weaver.systeminfo.template.UserTemplate();
  	userTemplate.getTemplateByUID(user.getUID(),user.getUserSubCompany1());
  	
  	
  	String skin =  userTemplate.getSkin();
  	
  	
  	return skin;
  	
  }
  
  private int getCurrTemplateId(User user){
  	weaver.conn.RecordSet rs = new weaver.conn.RecordSet();
  	weaver.systeminfo.template.UserTemplate  userTemplate = new weaver.systeminfo.template.UserTemplate();
  	userTemplate.getTemplateByUID(user.getUID(),user.getUserSubCompany1());
  	
  	
  	int id =  userTemplate.getTemplateId();
  	
  	
  	return id;
  	
  }
  
  private String getCurrTemplateLogo(User user){
  	weaver.conn.RecordSet rs = new weaver.conn.RecordSet();
  	weaver.systeminfo.template.UserTemplate  userTemplate = new weaver.systeminfo.template.UserTemplate();
  	userTemplate.getTemplateByUID(user.getUID(),user.getUserSubCompany1());
  	
  	
  	String logo =  userTemplate.getLogo();
  	
  	
  	return logo;
  	
  }
  
  private String[] getHrmUserSetting(User user) throws Exception {
  	weaver.conn.RecordSet rs = new weaver.conn.RecordSet();
  
  	String[] result = new String[2];
  	String theme = "";
  	String skin = "";
  	
  	String sql="select templateid from SystemTemplateSubComp where subcompanyid="+user.getUserSubCompany1();
  	rs.executeSql(sql);
  	if(rs.next()){	
  	
  		String curUserCanUse = rs.getString("templateid");
  		sql = "SELECT a.* FROM HrmUserSetting a, SystemTemplate  b WHERE a.resourceId="+user.getUID()+" AND a.templateId=b.id  and  b.id="+curUserCanUse;
  		rs.execute(sql);
  		if(rs.next()){
  			theme = rs.getString("theme");
  			skin = rs.getString("skin");
  			if("ecology8".equals(theme)){
  				skin = "default";
  			}
  			result[0] = theme;
  			result[1] = skin;
  			return result;
  		}
  	}
  	
  	
  
  	
  	int userid = user.getUID();
  	rs.executeSql("select theme, skin from HrmUserSetting where resourceId=" + userid);
  	
  	if (rs.next()) {
  		theme = rs.getString("theme");
  		skin = rs.getString("skin");
  	}
  	
  	//rs.executeSql("select * from extandHpThemeItem where extandHpThemeId=" + sqltemplateid1 + " and isopen=1 and theme='" + theme + "' and skin='" + skin + "'");
  	result[0] = theme;
  	result[1] = skin;
  	
  	
  	
  	//System.out.println("result"+result[0]+result[1]);
  	return result;
  }
  
  
  private java.util.Map getPageConfigInfo(HttpSession session, User user) throws Exception{
  	
  	weaver.conn.RecordSet rs = new weaver.conn.RecordSet();
  	java.util.Map pageConfigkv = new java.util.HashMap();
  	
  	weaver.systeminfo.template.UserTemplate  userTemplate = new weaver.systeminfo.template.UserTemplate();
  	userTemplate.getTemplateByUID(user.getUID(),user.getUserSubCompany1());
  	
  	pageConfigkv.put("logoTop",userTemplate.getLogo());
  	pageConfigkv.put("logoBottom", userTemplate.getLogo());
  	pageConfigkv.put("isopen", userTemplate.getIsopen());
  	//pageConfigkv.put("islock", rs.getString("islock"));
  	
  	int extendtempletvalueid = userTemplate.getExtendtempletvalueid();
  	rs.executeSql("select * from extandHpThemeItem where extandHpThemeId=" + extendtempletvalueid + " and isopen=1 and theme='" + getCurrWuiConfig(session, user, "THEME") + "' and skin='" + getCurrWuiConfig(session, user, "SKIN") + "'");
  	
  	if (rs.next()) {
  	
  		
  		/**
  		 * ecologybasic\u4e3b\u9898\u7528\u8bbe\u7f6e\u9879
  		 */
  		pageConfigkv.put("bodyBg", rs.getString("bodyBg"));
  		pageConfigkv.put("topBgImage", rs.getString("topBgImage"));
  		pageConfigkv.put("toolbarBgColor", rs.getString("toolbarBgColor"));
  		pageConfigkv.put("menuborderColor", rs.getString("menuborderColor"));
  
  		pageConfigkv.put("leftbarBgImage", rs.getString("leftbarBgImage"));
  		pageConfigkv.put("leftbarBgImageH", rs.getString("leftbarBgImageH"));
  
  		pageConfigkv.put("leftbarborderColor", rs.getString("leftbarborderColor"));
  		pageConfigkv.put("leftbarFontColor", rs.getString("leftbarFontColor"));
  
  		pageConfigkv.put("topleftbarBgImage_left", rs.getString("topleftbarBgImage_left"));
  		pageConfigkv.put("topleftbarBgImage_center", rs.getString("topleftbarBgImage_center"));
  		pageConfigkv.put("topleftbarBgImage_right", rs.getString("topleftbarBgImage_right"));
  
  		pageConfigkv.put("bottomleftbarBgImage_left", rs.getString("bottomleftbarBgImage_left"));
  		pageConfigkv.put("bottomleftbarBgImage_center", rs.getString("bottomleftbarBgImage_center"));
  		pageConfigkv.put("bottomleftbarBgImage_right", rs.getString("bottomleftbarBgImage_right"));
  
  	}
  	
  	return pageConfigkv;
  	
  }

  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, "/notice/error.jsp", session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      
	try{
		response.setBufferSize(1*1024*1024);
	}catch(Exception e){}

      out.write(_jsp_string1, 0, _jsp_string1.length);
      
// \u589e\u52a0\u53c2\u6570\u5224\u65ad\u7f13\u5b58
int isIncludeToptitle = 0;
response.setHeader("cache-control", "no-cache");
response.setHeader("pragma", "no-cache");
response.setHeader("expires", "Mon 1 Jan 1990 00:00:00 GMT");

      out.write(_jsp_string2, 0, _jsp_string2.length);
      
//
User user = HrmUserVarify.getUser (request , response) ;
LicenseCheckLogin licenseCheckLogin = new LicenseCheckLogin();
licenseCheckLogin.setOutLineDate(user.getUID(),IPUtil.getIp(request));

//\u95ee\u98981
TestWorkflowCheck twc=new TestWorkflowCheck();
if(twc.checkURI(session,request.getRequestURI(),request.getQueryString())){
    /*
    response.sendRedirect("/login/Logout.jsp");
    */
    String forwardurl = twc.reLoginMrg(request, response, request.getRequestURI());
    if (!"".equals(forwardurl)) { 
        response.sendRedirect(forwardurl);
        return;
    }
}
String userOffline = Util.null2String((String)session.getAttribute("userOffline"));	
if(userOffline.equals("1")){
	//\u5f3a\u5236\u4e0b\u7ebf
	String loginfile = Util.getCookie(request , "loginfileweaver") ;
	Map userSessions = (Map) application.getAttribute("userSessions");
	if (userSessions != null) {
		Map logmessages = (Map) application.getAttribute("logmessages");
		if (logmessages != null)logmessages.remove("" + user.getUID());
		session.removeValue("moniter");
		session.removeValue("WeaverMailSet");
		userSessions.remove(user.getUID());
		//session.invalidate();
	}
      out.write(_jsp_string3, 0, _jsp_string3.length);
      out.print((SystemEnv.getErrorMsgName(175,user.getLanguage())));
      out.write(_jsp_string4, 0, _jsp_string4.length);
      out.print(("/Refresh.jsp?loginfile="+loginfile+"&message=175"));
      out.write(_jsp_string5, 0, _jsp_string5.length);
      
  return;
}
if(user == null)  return ;
String isIE = (String)session.getAttribute("browser_isie");
if (isIE == null || "".equals(isIE)) {
	isIE = "true";
	session.setAttribute("browser_isie", "true");
}
String agentT = request.getHeader("user-agent");
//if(!"true".equals(isIE)){
//if((agentT.contains("Firefox")||agentT.contains(" Chrome")||agentT.contains("Safari") )&& !agentT.contains("Edge")){
if(agentT.contains("Firefox")||agentT.contains(" Chrome")||agentT.contains("Safari") || agentT.contains("Edge")){	
    isIE = "false";	
}
else{
    isIE = "true";	
}
//}

Log logger= LogFactory.getLog(this.getClass());



//************************************************
//\u8d85\u65f6\u6216\u8005\u91cd\u542fresin\u670d\u52a1\u65f6\uff0c\u5f39\u51fa\u767b\u9646\u5c0f\u7a97\u53e3(TD 2227)
//hubo,050707

//************************************************

String pagepath = request.getServletPath();
if(pagepath.indexOf("HrmResourceOperation.jsp")<0&&pagepath.indexOf("RemindLogin.jsp")<0&&pagepath.indexOf("HrmResourcePassword.jsp")<0){
	String changepwd = (String)request.getSession().getAttribute("changepwd");
	if("n".equals(changepwd)){
		request.getSession().removeAttribute("changepwd");
		response.sendRedirect("/login/Login.jsp");
		return;
	}else if("y".equals(changepwd)){
		request.getSession().removeAttribute("changepwd");
	}
}



//licence\u4fe1\u606f
String companyNametools="";
LN Licenseinit_1 = new LN();
try{
	Licenseinit_1.CkHrmnum();
}catch(Exception e){
	e.printStackTrace();
	out.println("<script type='text/javascript'> top.location.href='/system/InLicense.jsp?message=6&code=';</script>");
	return;
}
companyNametools = Licenseinit_1.getCompanyname();

//\u7248\u672c\u4fe1\u606f
StaticObj staticobj = null;
staticobj = StaticObj.getInstance();
String software = (String)staticobj.getObject("software") ;
if(software == null) software="ALL";
String portal = (String)staticobj.getObject("portal") ;
if(portal == null) portal="n";
boolean isPortalOK = false;
if(portal.equals("y")) isPortalOK = true;
String multilanguage = (String)staticobj.getObject("multilanguage") ;
if(multilanguage == null) multilanguage="n";
boolean isMultilanguageOK = false;
if(multilanguage.equals("y")) isMultilanguageOK = true;


      out.write(_jsp_string2, 0, _jsp_string2.length);
      
  String fromlogin=(String)session.getAttribute("fromlogin");
  session.removeAttribute("fromlogin");
  if(fromlogin==null) fromlogin="no";

  ChgPasswdReminder reminder0 = new ChgPasswdReminder();
  RemindSettings settings0=reminder0.getRemindSettings();
  String firmcode0=settings0.getFirmcode();
  String usercode0=settings0.getUsercode();

  int needusb0=user.getNeedusb();
  String usbtype0 = settings0.getUsbType();
  String serial0=user.getSerial();

//\u9650\u5236\u6bcf\u4e2a\u7528\u6237\u53ea\u80fd\u6709\u4e00\u4e2a\u767b\u5165\u7684\u7a97\u53e3
String frommain = Util.null2String(request.getParameter("frommain")) ;

Map logmessages=(Map)application.getAttribute("logmessages");
String a_logmessage="";
if(logmessages!=null)
	a_logmessage=Util.null2String((String)logmessages.get(""+user.getUID()));

String s_logmessage=Util.null2String((String)session.getAttribute("logmessage"));


//TD2125 by mackjoe \u89e3\u51b3\u6570\u636e\u4e2d\u5fc3\u767b\u9646\u4e0d\u4e86\u95ee\u9898
if(s_logmessage==null)  s_logmessage="";

String relogin0=Util.null2String(settings0.getRelogin());

String changepwd = (String)session.getAttribute("changepwd");

if(!relogin0.equals("1")&&"yes".equals(changepwd)){
logmessages=(Map)application.getAttribute("logmessages");
logmessages.put(""+user.getUID(),s_logmessage);
if(logmessages!=null)
	a_logmessage=Util.null2String((String)logmessages.get(""+user.getUID()));
}

String layoutStyle = (String)request.getSession(true).getAttribute("layoutStyle");
if(layoutStyle==null) layoutStyle ="";

String rtxFromLogintmp = (String)session.getAttribute("RtxFromLogin");


if("1".equals(user.getLogintype())&&!relogin0.equals("1")&&!fromlogin.equals("yes")&&!frommain.equals("yes")&&!s_logmessage.equals(a_logmessage) && !"true".equals(rtxFromLogintmp)){
	if(layoutStyle.equals("") || !layoutStyle.equals("1")){	//\u5982\u679c\u662f\u5c0f\u7a97\u53e3\u767b\u5f55\uff0c\u5219\u4e0d\u5224\u65ad\u662f\u5426\u4e3a\u5f53\u524d\u5de5\u4f5c\u7a97\u53e3


      out.write(_jsp_string6, 0, _jsp_string6.length);
      out.print((SystemEnv.getHtmlLabelName(23274,user.getLanguage())));
      out.write(_jsp_string7, 0, _jsp_string7.length);
      return;}}
      out.write(_jsp_string2, 0, _jsp_string2.length);
      
//\u6d41\u7a0b\u7684\u4e09\u4e2a\u9875\u9762\u9700\u8981\u4f7f\u7528\u9ad8\u7248\u672c\u7684jQuery
if (request.getRequestURI().indexOf("/workflow/request/") != -1 &&
        (request.getRequestURI().indexOf("/workflow/request/ManageRequestNoForm") != -1 
                || request.getRequestURI().indexOf("/workflow/request/ViewRequestIframe.jsp") != -1
                || request.getRequestURI().indexOf("/workflow/request/RemarkFrame.jsp") != -1)) {

      out.write(_jsp_string8, 0, _jsp_string8.length);
      
} else {

      out.write(_jsp_string9, 0, _jsp_string9.length);
      
}

      out.write(_jsp_string10, 0, _jsp_string10.length);
      
//\u6a21\u677f\u6a21\u5f0f\u5bfc\u5165
if ((request.getRequestURI().indexOf("/workflow/") != -1 && request.getRequestURI().indexOf("mode") != -1)
        || request.getRequestURI().indexOf("/workflow/request/AddRequest") != -1) {
        
      out.write(_jsp_string11, 0, _jsp_string11.length);
      
}

      out.write(_jsp_string12, 0, _jsp_string12.length);
      out.print((user.getLanguage()));
      out.write(_jsp_string13, 0, _jsp_string13.length);
      out.print((request.getSession().getId()));
      out.write(_jsp_string14, 0, _jsp_string14.length);
      out.print((SystemEnv.getHtmlLabelName(21403,user.getLanguage())));
      out.write(_jsp_string15, 0, _jsp_string15.length);
      out.print((SystemEnv.getHtmlLabelName(21791,user.getLanguage())));
      out.write(_jsp_string16, 0, _jsp_string16.length);
      out.print((SystemEnv.getHtmlLabelNames("17480",user.getLanguage())));
      out.write(_jsp_string17, 0, _jsp_string17.length);
      out.print((SystemEnv.getHtmlLabelNames("25484,83",user.getLanguage())));
      out.write(_jsp_string18, 0, _jsp_string18.length);
      out.print((user.getUID()));
      out.write(_jsp_string19, 0, _jsp_string19.length);
      out.print((user.getUID()));
      out.write(_jsp_string20, 0, _jsp_string20.length);
      out.print((user.getType()));
      out.write(_jsp_string21, 0, _jsp_string21.length);
      out.print((SystemEnv.getHtmlLabelName(26263,user.getLanguage())));
      out.write(_jsp_string22, 0, _jsp_string22.length);
      out.print((URLEncoder.encode(user.getLoginid())));
      out.write(_jsp_string23, 0, _jsp_string23.length);
      out.print((SystemEnv.getHtmlLabelName(21403,user.getLanguage())));
      out.write(_jsp_string24, 0, _jsp_string24.length);
      out.print((SystemEnv.getHtmlLabelName(23670,user.getLanguage())));
      out.write(_jsp_string25, 0, _jsp_string25.length);
      out.print((SystemEnv.getHtmlLabelName(21791,user.getLanguage())));
      out.write(_jsp_string26, 0, _jsp_string26.length);
      if(new weaver.conn.RecordSet().getDBType().equals("oracle")){
      out.write(_jsp_string27, 0, _jsp_string27.length);
      out.print((SystemEnv.getHtmlLabelName(524,user.getLanguage())));
      out.print((SystemEnv.getHtmlLabelName(698,user.getLanguage())));
      out.write(_jsp_string28, 0, _jsp_string28.length);
      out.print((SystemEnv.getHtmlLabelName(20246,user.getLanguage())));
      out.write(_jsp_string28, 0, _jsp_string28.length);
      out.print((SystemEnv.getHtmlLabelName(124962,user.getLanguage())));
      out.write(_jsp_string29, 0, _jsp_string29.length);
      }
      out.write(_jsp_string30, 0, _jsp_string30.length);
      out.print((SystemEnv.getHtmlLabelName(21423,user.getLanguage())));
      out.write(_jsp_string31, 0, _jsp_string31.length);
      out.print((SystemEnv.getHtmlLabelName(21423,user.getLanguage())));
      out.write(_jsp_string32, 0, _jsp_string32.length);
      out.print((SystemEnv.getHtmlNoteName(14,user.getLanguage())));
      out.write(_jsp_string33, 0, _jsp_string33.length);
      out.print((SystemEnv.getHtmlNoteName(14,user.getLanguage())));
      out.write(_jsp_string34, 0, _jsp_string34.length);
      out.print((SystemEnv.getHtmlNoteName(14,user.getLanguage())));
      out.write(_jsp_string33, 0, _jsp_string33.length);
      out.print((SystemEnv.getHtmlNoteName(14,user.getLanguage())));
      out.write(_jsp_string35, 0, _jsp_string35.length);
      out.print((SystemEnv.getHtmlLabelName(21423,user.getLanguage())));
      out.write(_jsp_string36, 0, _jsp_string36.length);
      out.print((SystemEnv.getHtmlLabelName(21423,user.getLanguage())));
      out.write(_jsp_string37, 0, _jsp_string37.length);
      out.print((SystemEnv.getHtmlNoteName(14,user.getLanguage())));
      out.write(_jsp_string38, 0, _jsp_string38.length);
      out.print((SystemEnv.getHtmlNoteName(14,user.getLanguage())));
      out.write(_jsp_string39, 0, _jsp_string39.length);
      out.print((SystemEnv.getHtmlLabelName(15097,user.getLanguage())));
      out.write(_jsp_string40, 0, _jsp_string40.length);
      out.print((SystemEnv.getHtmlLabelName(22161,user.getLanguage())));
      out.write(_jsp_string41, 0, _jsp_string41.length);
      out.print((companyNametools));
      out.write(_jsp_string42, 0, _jsp_string42.length);
      out.print((SystemEnv.getHtmlLabelName(23714,user.getLanguage())));
      out.write(_jsp_string43, 0, _jsp_string43.length);
      
  if(!fromlogin.equals("yes")&&needusb0==1&&"1".equals(usbtype0)){

      out.write(_jsp_string44, 0, _jsp_string44.length);
      out.print((firmcode0));
      out.write(_jsp_string45, 0, _jsp_string45.length);
      out.print((usercode0));
      out.write(_jsp_string46, 0, _jsp_string46.length);
      out.print((serial0));
      out.write(_jsp_string47, 0, _jsp_string47.length);
      out.print((user.getLanguage()));
      out.write(_jsp_string48, 0, _jsp_string48.length);
      }
      out.write(_jsp_string49, 0, _jsp_string49.length);
      weaver.workflow.workflow.TestWorkflowCheck TestWorkflowCheckInitWui;
      TestWorkflowCheckInitWui = (weaver.workflow.workflow.TestWorkflowCheck) pageContext.getAttribute("TestWorkflowCheckInitWui");
      if (TestWorkflowCheckInitWui == null) {
        TestWorkflowCheckInitWui = new weaver.workflow.workflow.TestWorkflowCheck();
        pageContext.setAttribute("TestWorkflowCheckInitWui", TestWorkflowCheckInitWui);
      }
      out.write(_jsp_string50, 0, _jsp_string50.length);
      out.println(TestWorkflowCheckInitWui.ReloadByDialogClose(request));
      out.write(_jsp_string51, 0, _jsp_string51.length);
      
    if(TestWorkflowCheckInitWui.checkURI(session,request.getRequestURI(),request.getQueryString())){
        response.sendRedirect("/login/Login.jsp");
        return;
    }

      out.write(_jsp_string52, 0, _jsp_string52.length);
      

String curTheme = "ecology7";
//\u5f53\u524d\u76ae\u80a4
String curskin = "";
String cutoverWay = "";
String transitionTime = "";
String transitionWay = "";

HrmUserSettingComInfo instance = new HrmUserSettingComInfo();

String huscifId = String.valueOf(instance.getId(String.valueOf(user.getUID())));

curTheme = getCurrWuiConfig(session, user, "theme");
curskin = getCurrWuiConfig(session, user, "skin");

cutoverWay = instance.getCutoverWay(huscifId);
transitionTime = instance.getTransitionTime(huscifId);
transitionWay = instance.getTransitionWays(huscifId);

      out.write(_jsp_string53, 0, _jsp_string53.length);
      
String ely6flg = "";
if ("ecology6".equals(curTheme.toLowerCase())) {
	curTheme = "ecology7";
	ely6flg = "ecology6";
}

      out.write(_jsp_string54, 0, _jsp_string54.length);
      out.print((curTheme ));
      out.write(_jsp_string55, 0, _jsp_string55.length);
      out.print((curskin ));
      out.write(_jsp_string56, 0, _jsp_string56.length);
      
curTheme = "ecology8";//\u540e\u53f0\u914d\u7f6e\u9875\u9762\u5747\u4e3aE8\u4e3b\u9898\uff0c\u5982\u4f7f\u7528\u5176\u4ed6\u4e3b\u9898\u65f6\uff0c\u4f1a\u5bfc\u81f4\u6837\u5f0f\u6df7\u4e71\u3002\u6240\u4ee5\u6b64\u5904\u4e3b\u9898\u5f3a\u5236\u8d4b\u503cecology8
if("ecology8".equals(curTheme)) curskin="default";
session.setAttribute("SESSION_TEMP_CURRENT_THEME", curTheme);
session.setAttribute("SESSION_TEMP_CURRENT_SKIN", curskin);

      out.write(_jsp_string57, 0, _jsp_string57.length);
      
    if (transitionTime != null && !transitionTime.equals("") && !transitionTime.equals("0")) {

      out.write(_jsp_string58, 0, _jsp_string58.length);
      out.print((cutoverWay ));
      out.write(_jsp_string59, 0, _jsp_string59.length);
      out.print((transitionTime ));
      out.write(_jsp_string60, 0, _jsp_string60.length);
      out.print((transitionWay ));
      out.write(_jsp_string61, 0, _jsp_string61.length);
      
    }

      out.write(_jsp_string62, 0, _jsp_string62.length);
      out.print((curTheme ));
      out.write(_jsp_string63, 0, _jsp_string63.length);
      out.print((curskin ));
      out.write(_jsp_string64, 0, _jsp_string64.length);
      if(!"1".equals(session.getAttribute("istest"))){//\u6d41\u7a0b\u6d4b\u8bd5
      out.write(_jsp_string53, 0, _jsp_string53.length);
      pageContext.include("/synergy/showSynergy.jsp", "requestid=" + com.caucho.el.Expr.toString(Util.getIntValue(request.getParameter("requestid"),-1), null), false);
      out.write(_jsp_string53, 0, _jsp_string53.length);
      }
      out.write(_jsp_string65, 0, _jsp_string65.length);
      weaver.conn.RecordSet RecordSet;
      RecordSet = (weaver.conn.RecordSet) pageContext.getAttribute("RecordSet");
      if (RecordSet == null) {
        RecordSet = new weaver.conn.RecordSet();
        pageContext.setAttribute("RecordSet", RecordSet);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.conn.RecordSet rs;
      rs = (weaver.conn.RecordSet) pageContext.getAttribute("rs");
      if (rs == null) {
        rs = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs", rs);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.workflow.workflow.WFManager WFManager;
      synchronized (pageContext.getSession()) {
        WFManager = (weaver.workflow.workflow.WFManager) pageContext.getSession().getAttribute("WFManager");
        if (WFManager == null) {
          WFManager = new weaver.workflow.workflow.WFManager();
          pageContext.getSession().setAttribute("WFManager", WFManager);
        }
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.workflow.form.FormComInfo FormComInfo;
      FormComInfo = (weaver.workflow.form.FormComInfo) pageContext.getAttribute("FormComInfo");
      if (FormComInfo == null) {
        FormComInfo = new weaver.workflow.form.FormComInfo();
        pageContext.setAttribute("FormComInfo", FormComInfo);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.workflow.workflow.WFNodeMainManager WFNodeMainManager;
      WFNodeMainManager = (weaver.workflow.workflow.WFNodeMainManager) pageContext.getAttribute("WFNodeMainManager");
      if (WFNodeMainManager == null) {
        WFNodeMainManager = new weaver.workflow.workflow.WFNodeMainManager();
        pageContext.setAttribute("WFNodeMainManager", WFNodeMainManager);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.workflow.field.FieldComInfo FieldComInfo;
      FieldComInfo = (weaver.workflow.field.FieldComInfo) pageContext.getAttribute("FieldComInfo");
      if (FieldComInfo == null) {
        FieldComInfo = new weaver.workflow.field.FieldComInfo();
        pageContext.setAttribute("FieldComInfo", FieldComInfo);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.workflow.form.FormFieldMainManager FormFieldMainManager;
      FormFieldMainManager = (weaver.workflow.form.FormFieldMainManager) pageContext.getAttribute("FormFieldMainManager");
      if (FormFieldMainManager == null) {
        FormFieldMainManager = new weaver.workflow.form.FormFieldMainManager();
        pageContext.setAttribute("FormFieldMainManager", FormFieldMainManager);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.matrix.MatrixUtil matrixUtil;
      matrixUtil = (weaver.matrix.MatrixUtil) pageContext.getAttribute("matrixUtil");
      if (matrixUtil == null) {
        matrixUtil = new weaver.matrix.MatrixUtil();
        pageContext.setAttribute("matrixUtil", matrixUtil);
      }
      out.write(_jsp_string66, 0, _jsp_string66.length);
      weaver.systeminfo.SysMaintenanceLog SysMaintenanceLog;
      SysMaintenanceLog = (weaver.systeminfo.SysMaintenanceLog) pageContext.getAttribute("SysMaintenanceLog");
      if (SysMaintenanceLog == null) {
        SysMaintenanceLog = new weaver.systeminfo.SysMaintenanceLog();
        pageContext.setAttribute("SysMaintenanceLog", SysMaintenanceLog);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      FormFieldMainManager.resetParameter();
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.workflow.workflow.WFNodeFieldMainManager WFNodeFieldMainManager;
      WFNodeFieldMainManager = (weaver.workflow.workflow.WFNodeFieldMainManager) pageContext.getAttribute("WFNodeFieldMainManager");
      if (WFNodeFieldMainManager == null) {
        WFNodeFieldMainManager = new weaver.workflow.workflow.WFNodeFieldMainManager();
        pageContext.setAttribute("WFNodeFieldMainManager", WFNodeFieldMainManager);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      WFNodeFieldMainManager.resetParameter();
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.workflow.workflow.WFNodeDtlFieldManager WFNodeDtlFieldManager;
      WFNodeDtlFieldManager = (weaver.workflow.workflow.WFNodeDtlFieldManager) pageContext.getAttribute("WFNodeDtlFieldManager");
      if (WFNodeDtlFieldManager == null) {
        WFNodeDtlFieldManager = new weaver.workflow.workflow.WFNodeDtlFieldManager();
        pageContext.setAttribute("WFNodeDtlFieldManager", WFNodeDtlFieldManager);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      WFNodeDtlFieldManager.resetParameter();
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.workflow.workflow.WFNodePortalMainManager WFNodePortalMainManager;
      WFNodePortalMainManager = (weaver.workflow.workflow.WFNodePortalMainManager) pageContext.getAttribute("WFNodePortalMainManager");
      if (WFNodePortalMainManager == null) {
        WFNodePortalMainManager = new weaver.workflow.workflow.WFNodePortalMainManager();
        pageContext.setAttribute("WFNodePortalMainManager", WFNodePortalMainManager);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      WFNodePortalMainManager.resetParameter();
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.workflow.workflow.WFNodeOperatorManager WFNodeOperatorManager;
      WFNodeOperatorManager = (weaver.workflow.workflow.WFNodeOperatorManager) pageContext.getAttribute("WFNodeOperatorManager");
      if (WFNodeOperatorManager == null) {
        WFNodeOperatorManager = new weaver.workflow.workflow.WFNodeOperatorManager();
        pageContext.setAttribute("WFNodeOperatorManager", WFNodeOperatorManager);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.workflow.workflow.WorkflowAllComInfo WorkflowAllComInfo;
      WorkflowAllComInfo = (weaver.workflow.workflow.WorkflowAllComInfo) pageContext.getAttribute("WorkflowAllComInfo");
      if (WorkflowAllComInfo == null) {
        WorkflowAllComInfo = new weaver.workflow.workflow.WorkflowAllComInfo();
        pageContext.setAttribute("WorkflowAllComInfo", WorkflowAllComInfo);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.workflow.workflow.WorkflowComInfo WorkflowComInfo;
      WorkflowComInfo = (weaver.workflow.workflow.WorkflowComInfo) pageContext.getAttribute("WorkflowComInfo");
      if (WorkflowComInfo == null) {
        WorkflowComInfo = new weaver.workflow.workflow.WorkflowComInfo();
        pageContext.setAttribute("WorkflowComInfo", WorkflowComInfo);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.workflow.workflow.TestWorkflowComInfo TestWorkflowComInfo;
      TestWorkflowComInfo = (weaver.workflow.workflow.TestWorkflowComInfo) pageContext.getAttribute("TestWorkflowComInfo");
      if (TestWorkflowComInfo == null) {
        TestWorkflowComInfo = new weaver.workflow.workflow.TestWorkflowComInfo();
        pageContext.setAttribute("TestWorkflowComInfo", TestWorkflowComInfo);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      WFNodeOperatorManager.resetParameter();
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.workflow.request.RequestCheckUser RequestCheckUser;
      RequestCheckUser = (weaver.workflow.request.RequestCheckUser) pageContext.getAttribute("RequestCheckUser");
      if (RequestCheckUser == null) {
        RequestCheckUser = new weaver.workflow.request.RequestCheckUser();
        pageContext.setAttribute("RequestCheckUser", RequestCheckUser);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      RequestCheckUser.resetParameter();
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.workflow.request.RequestUserDefaultManager RequestUserDefaultManager;
      RequestUserDefaultManager = (weaver.workflow.request.RequestUserDefaultManager) pageContext.getAttribute("RequestUserDefaultManager");
      if (RequestUserDefaultManager == null) {
        RequestUserDefaultManager = new weaver.workflow.request.RequestUserDefaultManager();
        pageContext.setAttribute("RequestUserDefaultManager", RequestUserDefaultManager);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.workflow.workflow.WFNodeFieldManager wFNodeFieldManager;
      wFNodeFieldManager = (weaver.workflow.workflow.WFNodeFieldManager) pageContext.getAttribute("wFNodeFieldManager");
      if (wFNodeFieldManager == null) {
        wFNodeFieldManager = new weaver.workflow.workflow.WFNodeFieldManager();
        pageContext.setAttribute("wFNodeFieldManager", wFNodeFieldManager);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.workflow.exceldesign.ExcelsetInitManager excelsetInitManager;
      excelsetInitManager = (weaver.workflow.exceldesign.ExcelsetInitManager) pageContext.getAttribute("excelsetInitManager");
      if (excelsetInitManager == null) {
        excelsetInitManager = new weaver.workflow.exceldesign.ExcelsetInitManager();
        pageContext.setAttribute("excelsetInitManager", excelsetInitManager);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.workflow.exceldesign.HtmlLayoutOperate htmlLayoutOperate;
      htmlLayoutOperate = (weaver.workflow.exceldesign.HtmlLayoutOperate) pageContext.getAttribute("htmlLayoutOperate");
      if (htmlLayoutOperate == null) {
        htmlLayoutOperate = new weaver.workflow.exceldesign.HtmlLayoutOperate();
        pageContext.setAttribute("htmlLayoutOperate", htmlLayoutOperate);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      weaver.general.DateUtil DateUtil;
      DateUtil = (weaver.general.DateUtil) pageContext.getAttribute("DateUtil");
      if (DateUtil == null) {
        DateUtil = new weaver.general.DateUtil();
        pageContext.setAttribute("DateUtil", DateUtil);
      }
      out.write(_jsp_string53, 0, _jsp_string53.length);
      
  WfRightManager wfrm = new WfRightManager();
  boolean haspermission = wfrm.hasPermission3(Util.getIntValue(request.getParameter("wfid"), 0), 0, user, WfRightManager.OPERATION_CREATEDIR);
  if(!HrmUserVarify.checkUserRight("WorkflowManage:All", user) && !haspermission){
		response.sendRedirect("/notice/noright.jsp");
    		return;
	}  
  int design = Util.getIntValue(request.getParameter("design"),0);
  String ajax=Util.null2String(request.getParameter("ajax"));
  String isTemplate=Util.null2String(request.getParameter("isTemplate"));
  int templateid=Util.getIntValue(request.getParameter("templateid"),0);
  int selectedCateLog = Util.getIntValue(request.getParameter("selectcatalog"),0);
  int catelogType = Util.getIntValue(request.getParameter("catalogtype"),0);
  String src = Util.null2String(request.getParameter("src"));
    int subCompanyId = Util.getIntValue(request.getParameter("subcompanyid"),-1); //add by wjy


    /* start \u540c\u6b65\u5230\u5176\u4ed6\u8def\u5f84\u521b\u5efa\u8282\u70b9***************************************/
    String wfids = Util.null2String(request.getParameter("workflowids"));
    String deleteBeforeAdd =  Util.null2String(request.getParameter("deleteBeforeAdd"));
    String selectwfids[] = wfids.split(",");

    for(int index=0;index<selectwfids.length;index++){
        int wfid = Util.getIntValue(selectwfids[index],0);
        int nodeid=0;
        int formid=0;
        String isbill="";
        String iscust="0";
          
        String sql = "";
        sql = "select a.formid,a.isbill,a.iscust,b.nodeid from workflow_base a,workflow_flownode b where a.id = b.workflowid and b.nodetype = 0 and a.id = " + wfid;
        RecordSet.executeSql(sql);
        if(RecordSet.next()){
            nodeid=Util.getIntValue(RecordSet.getString("nodeid"),0);
            formid=Util.getIntValue(RecordSet.getString("formid"),0);
            isbill=Util.null2String(RecordSet.getString("isbill"));
            iscust=Util.null2String(RecordSet.getString("iscust"));
        }
        
        //\u5148\u505a\u5220\u9664\u73b0\u6709\u64cd\u4f5c\u8005


        if( deleteBeforeAdd.trim().equals("true") && wfid > 0){
            String nodetype="0";
            String tmp = "";//groupid
            RecordSet.executeSql("delete from workflow_groupdetail where groupid in (select id from workflow_nodegroup where nodeid = "+nodeid+")");
            RecordSet.executeSql("delete from Workflow_HrmOperator where groupid in (select id from workflow_nodegroup where nodeid = "+nodeid+")");
            RecordSet.executeSql("delete from workflow_nodegroup where nodeid = "+nodeid);
            RecordSet.executeSql("update workflow_nodebase set totalgroups=0 where id = "+nodeid);
            String hisWorkflowCreater=RequestUserDefaultManager.getWorkflowCreater(String.valueOf(wfid));
            RequestCheckUser.setWorkflowid(wfid);
            RequestCheckUser.setNodeid(nodeid);
            RequestCheckUser.updateCreateList(Util.getIntValue(tmp));
            RequestUserDefaultManager.addDefaultOfNoSysAdmin(String.valueOf(wfid),hisWorkflowCreater);

            //\u5220\u9664\u8282\u70b9\u64cd\u4f5c\u7ec4\u65e5\u5fd7



            SysMaintenanceLog.resetParameter();
            SysMaintenanceLog.setRelatedId(nodeid);
            SysMaintenanceLog.setRelatedName(SystemEnv.getHtmlLabelName(15545,user.getLanguage()));
            SysMaintenanceLog.setOperateType("3");
            SysMaintenanceLog.setOperateDesc("WrokFlowNodeOperator_delete");
            SysMaintenanceLog.setOperateItem("87");
            SysMaintenanceLog.setOperateUserid(user.getUID());
            SysMaintenanceLog.setClientAddress(request.getRemoteAddr());
            SysMaintenanceLog.setSysLogInfo();
        }
        int id = 0;
        sql = "select max(id) as id from workflow_nodegroup";
        RecordSet.executeSql(sql);
    
        if(RecordSet.next()){
          id = Util.getIntValue(Util.null2String(RecordSet.getString("id")),0);
        }
        id += 1;
      
        int rowsum = Util.getIntValue(Util.null2String(request.getParameter("groupnum")));
        WFNodeOperatorManager.resetParameter();
        WFNodeOperatorManager.setId(id);
        WFNodeOperatorManager.setNodeid(nodeid);
        String groupname = Util.null2String(request.getParameter("groupname"));
        int canview = 1;
        WFNodeOperatorManager.setName(groupname);
        WFNodeOperatorManager.setCanview(canview);
        WFNodeOperatorManager.setAction("add");
        WFNodeOperatorManager.AddGroupInfo();
          String para="";  
        for(int i=0;i<rowsum;i++) {
          String type = Util.null2String(request.getParameter("group_"+i+"_type"));
          String virtualid = Util.null2String(request.getParameter("group_"+i+"_virtual"));
          String ruleRelationship = Util.null2String(request.getParameter("group_"+i+"_ruleRelationship"));
          String groupid = Util.null2String(request.getParameter("group_"+i+"_id"));
          int level = Util.getIntValue(Util.null2String(request.getParameter("group_"+i+"_level")),0);
          int level2 = Util.getIntValue(Util.null2String(request.getParameter("group_"+i+"_level2")),0);
          String conditions=Util.null2String(request.getParameter("group_"+i+"_condition"));
          String orders=Util.null2String(request.getParameter("group_"+i+"_order"));
          String signorder=Util.null2String(request.getParameter("group_"+i+"_signorder"));
          String IsCoadjutant=Util.null2String(request.getParameter("group_"+i+"_IsCoadjutant"));
          String signtype=Util.null2String(request.getParameter("group_"+i+"_signtype"));
          String issyscoadjutant=Util.null2String(request.getParameter("group_"+i+"_issyscoadjutant"));
          String coadjutants=Util.null2String(request.getParameter("group_"+i+"_coadjutants"));
          String issubmitdesc=Util.null2String(request.getParameter("group_"+i+"_issubmitdesc"));
          String ispending=Util.null2String(request.getParameter("group_"+i+"_ispending"));
          String isforward=Util.null2String(request.getParameter("group_"+i+"_isforward"));
          String ismodify=Util.null2String(request.getParameter("group_"+i+"_ismodify"));
          String Coadjutantconditions=Util.null2String(request.getParameter("group_"+i+"_Coadjutantconditions"));
          String bhxj=Util.null2String(request.getParameter("group_"+i+"_bhxj"));
          String jobfield=Util.null2String(request.getParameter("group_"+i+"_jobfield"));
          String jobobj=Util.null2String(request.getParameter("group_"+i+"_jobobj"));
          signorder = "-1".equals(signorder) ? "" : signorder;
          //\u5bf9\u5e94\u4e3a\u7a7a\uff0c\u6ca1\u9009\u60c5\u51b5\u5224\u65ad\u51fa\u6765\u4e0b
          if(signorder.equals("[object]")){
            signorder="";
          }
          
		  	String hrmgroupidn="";
		 	if(type.equals("3")){//\u4e00\u822c\u7c7b\u578b\uff1a\u4eba\u529b\u8d44\u6e90\u7c7b\u578b
		 		hrmgroupidn=groupid;
				groupid="0";
		 	}
          String conditioncn=Util.fromScreen(Util.null2String(request.getParameter("group_"+i+"_conditioncn")),user.getLanguage());
          if (orders.equals("")) orders="0";
          if(!type.equals("")){
            String matrixValue = groupid;
  			//\u5173\u8054\u8d23\u4efb\u4eba

  			if ("99".equals(type)) {
  				groupid = "0";
  			}
            char flag=2;
            para=""+id+flag+type+flag+groupid+flag+level+flag+level2+flag+conditions+flag+conditioncn+flag+orders+flag+signorder+flag+IsCoadjutant+
                          flag+signtype+flag+issyscoadjutant+flag+issubmitdesc+flag+ispending+flag+isforward+flag+ismodify+flag+coadjutants+flag+Coadjutantconditions+flag+virtualid+flag+ruleRelationship;
            
            RecordSet.executeProc("workflow_groupdetail_Insert",para);
		   //\u5904\u7406\u90e8\u95e8\u3001\u5206\u90e8\u81ea\u5b9a\u4e49\u5b57\u6bb5
		   int maxID=-1;
		   if(RecordSet.next()){
		      maxID =Util.getIntValue(""+RecordSet.getInt(1));
		      RecordSet.execute("update workflow_groupdetail set bhxj ='"+bhxj+ "',jobobj ='"+jobobj+ "',jobfield ='"+jobfield+ "'  where id = " + maxID);
	       }
             if(type.equals("3")){//\u4e00\u822c\u7c7b\u578b\uff1a\u4eba\u529b\u8d44\u6e90\u7c7b\u578b
	        	  RecordSet.executeSql("delete from Workflow_HrmOperator where groupdetailid='"+maxID+"'");
		          //\u5c06\u4eba\u529b\u8d44\u6e90\u7c7b\u578b\u503c\u5199\u5165\u4e2d\u95f4\u8868\u4e2dstart==
		          List hrmoperatorlist=Util.TokenizerString(hrmgroupidn,",");
		          for(int j=0;j<hrmoperatorlist.size();j++){
			          RecordSet.executeSql("insert into Workflow_HrmOperator(type,objid,signorder,orders,groupid,groupdetailid)values('"+type+"','"+hrmoperatorlist.get(j)+"','"+signorder+"','"+j+"','"+id+"','"+maxID+"')");
		          }	  
	          //\u5c06\u4eba\u529b\u8d44\u6e90\u7c7b\u578b\u503c\u5199\u5165\u4e2d\u95f4\u8868\u4e2dend== 
	          }
          }
        }
        int iscreate = Util.getIntValue(request.getParameter("iscreate"),0);
        if(iscreate==1 && wfid > 0){
          String hisWorkflowCreater=RequestUserDefaultManager.getWorkflowCreater(String.valueOf(wfid));
          RequestCheckUser.setWorkflowid(wfid);
          RequestCheckUser.setNodeid(nodeid);
          RequestCheckUser.updateCreateList(id);
          RequestUserDefaultManager.addDefaultOfNoSysAdmin(String.valueOf(wfid),hisWorkflowCreater);
        }
      
        //\u65b0\u589e\u64cd\u4f5c\u4eba\u7ec4\u65e5\u5fd7
        SysMaintenanceLog.resetParameter();
        SysMaintenanceLog.setRelatedId(nodeid);
        SysMaintenanceLog.setRelatedName(groupname);
        SysMaintenanceLog.setOperateType("1");
        SysMaintenanceLog.setOperateDesc("WrokFlowNodeOperator_insert");
        SysMaintenanceLog.setOperateItem("87");
        SysMaintenanceLog.setOperateUserid(user.getUID());
        SysMaintenanceLog.setClientAddress(request.getRemoteAddr());
        SysMaintenanceLog.setSysLogInfo();
      }
      /* end \u540c\u6b65\u5230\u5176\u4ed6\u8def\u5f84\u521b\u5efa\u8282\u70b9***************************************/
  //System.out.println("--src--"+src);
////\u5f97\u5230\u6807\u8bb0\u4fe1\u606f
	//System.out.println("src="+src);
  if(src.equalsIgnoreCase("addwf")){      
      int wfid=0;
    if(templateid>0){
		
        WFManager.reset();
        WFManager.setWfname(Util.null2String(request.getParameter("wfname")));
  	    WFManager.setWfdes(Util.null2String(request.getParameter("wfdes")));
		WFManager.setSubCompanyId2(subCompanyId);
		WFManager.setTypeid(Util.getIntValue(Util.null2String(request.getParameter("typeid"))));
        wfid=WFManager.setWFTemplate(templateid,isTemplate,user.getUID(),request.getRemoteAddr());
        WorkflowAllComInfo.removeWorkflowCache();
		WorkflowComInfo.removeWorkflowCache();
        TestWorkflowComInfo.removeWorkflowCache();
        
      	//\u5c06\u65b0\u6dfb\u52a0\u7684\u6d41\u7a0b\u52a0\u5165\u7248\u672c\u4fe1\u606f\u8868
    	WorkflowVersion wv=new WorkflowVersion();
    	wv.saveWorkflowVersionInfo(wfid+"");
        
		RequestUserDefaultManager.addDefaultOfSysAdmin(String.valueOf(wfid));
		String hisWorkflowCreater="";
		RequestUserDefaultManager.addDefaultOfNoSysAdmin(String.valueOf(wfid),hisWorkflowCreater);

    }else{
	WFManager.reset();
  	WFManager.setAction("addwf");
  	WFManager.setWfname(Util.null2String(request.getParameter("wfname")));
  	WFManager.setWfdes(Util.null2String(request.getParameter("wfdes")));        
  	WFManager.setTypeid(Util.getIntValue(Util.null2String(request.getParameter("typeid"))));
  	String isbill = Util.null2String(request.getParameter("isbill"));
  	int fnaWfType1 = -1;//\u81ea\u5b9a\u4e49\u8868\u5355-\u8d39\u7528\u7c7b\u6d41\u7a0b\u7c7b\u578b
  	int fnaWfType2 = -1;//\u81ea\u5b9a\u4e49\u8868\u5355-\u8d39\u7528\u7c7b\u6d41\u7a0b\u662f\u5426\u6709\u4e8b\u524d\u6d41\u7a0b
  	if("4".equals(isbill)){
  		isbill = "0";
  	  	fnaWfType1 = Util.getIntValue(request.getParameter("fnaWfType1"),-1);
  	  	fnaWfType2 = Util.getIntValue(request.getParameter("fnaWfType2"),-1);
  	}
  	String iscust = Util.null2String(request.getParameter("iscust"));
  	int helpdocid = Util.getIntValue(request.getParameter("helpdocid"),0);
    String isvalid= Util.null2String(request.getParameter("isvalid"));
    String needmark= Util.null2String(request.getParameter("needmark"));
    //add by xhheng @ 2005/01/24 for \u6d88\u606f\u63d0\u9192 Request06
    String messageType= Util.null2String(request.getParameter("messageType"));
    //add by xwj  20051101 for \u90ae\u4ef6\u63d0\u9192 td2965
    String mailMessageType= Util.null2String(request.getParameter("mailMessageType"));
    String archiveNoMsgAlert = Util.null2String(request.getParameter("archiveNoMsgAlert")); // \u5f52\u6863\u8282\u70b9\u4e0d\u9700\u77ed\u4fe1\u63d0\u9192
    String archiveNoMailAlert = Util.null2String(request.getParameter("archiveNoMailAlert")); // \u5f52\u6863\u8282\u70b9\u4e0d\u9700\u90ae\u4ef6\u63d0\u9192
    String forbidAttDownload= Util.null2String(request.getParameter("forbidAttDownload"));
    String docRightByOperator= Util.null2String(request.getParameter("docRightByOperator"));
  	//\u5fae\u4fe1\u63d0\u9192START(QC:98106)
    //add by fyg @ 20140319 for \u5fae\u4fe1\u63d0\u9192 
    String chatsType=Util.null2String(request.getParameter("chatsType"));
    String chatsAlertType=Util.null2String(request.getParameter("chatsAlertType"));
    String notRemindifArchived=Util.null2String(request.getParameter("notRemindifArchived")); 
  	//\u5fae\u4fe1\u63d0\u9192END(QC:98106)
    //add by xhheng @ 20050302 for TD 1545
    String multiSubmit= Util.null2String(request.getParameter("multiSubmit"));
    //add by xhheng @ 20050303 for TD 1689
    String defaultName= Util.null2String(request.getParameter("defaultName"));

	if(defaultName.equals("1")){//\u6807\u9898\u9ed8\u8ba4\u589e\u52a0\u89c4\u5219
		DateUtil.InitializationWFTitle(""+wfid);
	}
	
	
    //add by xhheng @ 20050317 for \u9644\u4ef6\u4e0a\u4f20
    String pathcategory= Util.null2String(request.getParameter("pathcategory"));
    String maincategory= Util.null2String(request.getParameter("maincategory"));
    String subcategory= Util.null2String(request.getParameter("subcategory"));
    String seccategory= Util.null2String(request.getParameter("seccategory"));
    int docRightByHrmResource = Util.getIntValue(request.getParameter("docRightByHrmResource"),0);
    int hrmResourceShow = Util.getIntValue(request.getParameter("hrmResourceShow"),0);
    String isaffirmance= Util.null2String(request.getParameter("isaffirmance"));
   // String isSaveCheckForm = Util.null2String(request.getParameter("isSaveCheckForm")); // \u6d41\u7a0b\u4fdd\u5b58\u662f\u5426\u9a8c\u8bc1\u5fc5\u586b
	String isremak= Util.null2String(request.getParameter("isremark"));
	String isShowChart= Util.null2String(request.getParameter("isShowChart"));
	String orderbytype= Util.null2String(request.getParameter("orderbytype"));
	String isModifyLog = Util.null2String(request.getParameter("isModifyLog"));
    String isannexUpload= Util.null2String(request.getParameter("isannexUpload"));
    String annexmaincategory= Util.null2String(request.getParameter("annexmaincategory"));
    String annexsubcategory= Util.null2String(request.getParameter("annexsubcategory"));
    String annexseccategory= Util.null2String(request.getParameter("annexseccategory"));
    String isShowOnReportInput= Util.null2String(request.getParameter("isShowOnReportInput"));
    String ShowDelButtonByReject=Util.null2String(request.getParameter("ShowDelButtonByReject"));
    
    String specialApproval=Util.null2String(request.getParameter("specialApproval"));//\u662f\u5426\u7279\u6279\u4ef6



    String Frequency=Util.null2String(request.getParameter("Frequency"));
    if(Frequency.equals("")) Frequency = "0";
    String Cycle=Util.null2String(request.getParameter("Cycle"));
    
    String isimportwf=Util.null2String(request.getParameter("isimportwf"));
    String importReadOnlyField = Util.null2String(request.getParameter("importReadOnlyField")); // \u5141\u8bb8\u5bfc\u5165\u6570\u636e\u5230\u53ea\u8bfb\u5b57\u6bb5
    String fieldNotImport = Util.null2String(request.getParameter("fieldNotImport")); // \u65e0\u9700\u5bfc\u5165\u5b57\u6bb5
	String wfdocpath = Util.null2String(request.getParameter("wfdocpath"));
	String newdocpath = Util.null2String(request.getParameter("newdocpath"));
	String wfdocowner = Util.null2String(request.getParameter("wfdocowner"));
	String wfdocownertype = ""+Util.getIntValue(request.getParameter("wfdocownertype"), 0);
	String wfdocownerfieldid = ""+Util.getIntValue(request.getParameter("wfdocownerfieldid"), 0);
	String isImportDetail= Util.null2String(request.getParameter("isImportDetail")); 
    String showUploadTab = Util.null2String(request.getParameter("showUploadTab"));
    String isSignDoc = Util.null2String(request.getParameter("isSignDoc"));
    String showDocTab = Util.null2String(request.getParameter("showDocTab"));
    String isSignWorkflow = Util.null2String(request.getParameter("isSignWorkflow"));
    String showWorkflowTab = Util.null2String(request.getParameter("showWorkflowTab"));
    int isshared = Util.getIntValue(request.getParameter("isshared"),0);
    int isforwardrights = Util.getIntValue(request.getParameter("isforwardrights"),0);
    String isrejectremind=Util.null2String(request.getParameter("isrejectremind"));
    String ischangrejectnode=Util.null2String(request.getParameter("ischangrejectnode"));
	   String isselectrejectnode=Util.null2String(request.getParameter("isselectrejectnode")); 
    String issignview = Util.null2String(request.getParameter("issignview"));
	String nosynfields = Util.null2String(request.getParameter("nosynfields"));
	String isneeddelacc=Util.null2String(request.getParameter("isneeddelacc"));
	String SAPSource = Util.null2String(request.getParameter("SAPSource"));
	String smsAlertsType = Util.null2String(request.getParameter("smsAlertsType"));	
	String isForwardReceiveDef = Util.null2String(request.getParameter("isForwardReceiveDef"));
	String isAutoApprove = Util.null2String(request.getParameter("isAutoApprove"));
	String isAutoCommit = Util.null2String(request.getParameter("isAutoCommit"));
	String isAutoRemark = Util.null2s(request.getParameter("isAutoRemark"),"0");
  int dsporder = Util.getIntValue(request.getParameter("dsporder"),0);
  	int submittype = Util.getIntValue(request.getParameter("submittype"),0);
  	String isFree = request.getParameter("isFree") == null ? "0" : "1";
    if("".equals(isneeddelacc))  isneeddelacc="0";
	int formid = 0;
 	formid = Util.getIntValue(Util.null2String(request.getParameter("formid")));  		

 	boolean isFnaWfInitE8 = ("0".equals(isbill) && fnaWfType1 > 0 && (fnaWfType2 >= 0 && fnaWfType2 <= 2) && formid <= 0);
 	HashMap<String, Object> isFnaWfInitE8Hm = new HashMap<String, Object>();
  	if(isFnaWfInitE8){
  		try{
  			formid = FnaWfInitE8.initE8FnaWfForm(fnaWfType1, fnaWfType2, user.getUID(), user.getLanguage(), subCompanyId, isFnaWfInitE8Hm);
  		}catch(Exception ex1){
  			new BaseBean().writeLog(ex1);
  			out.print(ex1.getMessage());
  			return;
  		}
 	}
 	
	String tablename = "";
	RecordSet.executeSql("select tablename from workflow_bill where id="+formid);	
	if(RecordSet.next()) tablename = RecordSet.getString("tablename");
	if(tablename.equals("formtable_main_"+formid*(-1)) || tablename.startsWith("uf_")){//\u65b0\u521b\u5efa\u7684\u8868\u5355\u505a\u4e3a\u5355\u636e\u4fdd\u5b58
		isbill = "1";
	}
	/**
  	if(isbill.equals("0")){
  			formid = Util.getIntValue(Util.null2String(request.getParameter("formid")));  		
			String tablename = "";
			RecordSet.executeSql("select tablename from workflow_bill where id="+formid);	
			if(RecordSet.next()) tablename = RecordSet.getString("tablename");
			if(tablename.equals("formtable_main_"+formid*(-1)) || tablename.startsWith("uf_")){//\u65b0\u521b\u5efa\u7684\u8868\u5355\u505a\u4e3a\u5355\u636e\u4fdd\u5b58
				isbill = "1";
			}
  	}else {
  		formid = Util.getIntValue(Util.null2String(request.getParameter("billid")));
  		if (isbill.equals("1") && formid == -1)
  					formid = Util.getIntValue(Util.null2String(request.getParameter("formid")));
    }
    **/
  	
  	//\u662f\u5426\u5141\u8bb8\u521b\u5efa\u4eba\u5220\u9664\u9644\u4ef6



  	String candelacc= Util.null2String(request.getParameter("candelacc"));
  	
  	WFManager.setFormid(formid);
  	WFManager.setIsBill(isbill);
  	WFManager.setIsCust(iscust);
  	WFManager.setHelpdocid(helpdocid);
    WFManager.setIsValid(isvalid);
    WFManager.setNeedMark(needmark);
    WFManager.setMessageType(messageType);
    WFManager.setMailMessageType(mailMessageType);//added by xwj for td2965 20051101
    //\u5fae\u4fe1\u63d0\u9192START(QC:98106)
    WFManager.setChatsType(chatsType);  //add by fyg @ 20140319 for \u5fae\u4fe1\u63d0\u9192 
    WFManager.setChatsAlertType(chatsAlertType);  //add by fyg @ 20140319 for \u5fae\u4fe1\u63d0\u9192 
    WFManager.setNotRemindifArchived(notRemindifArchived);  //add by fyg @ 20140319 for \u5fae\u4fe1\u63d0\u9192
    //\u5fae\u4fe1\u63d0\u9192END(QC:98106)
    WFManager.setArchiveNoMsgAlert(archiveNoMsgAlert);
    WFManager.setArchiveNoMailAlert(archiveNoMailAlert);
    WFManager.setForbidAttDownload(forbidAttDownload);
    WFManager.setDocRightByOperator(docRightByOperator);
    WFManager.setMultiSubmit(multiSubmit);
    WFManager.setDefaultName(defaultName);
    WFManager.setDocCategory(maincategory+","+subcategory+","+seccategory);
    WFManager.setDocPath(pathcategory);
    WFManager.setSubCompanyId2(subCompanyId);
    WFManager.setIsTemplate(isTemplate);
    WFManager.setTemplateid(templateid);
    WFManager.setCatelogType(catelogType);
    WFManager.setSelectedCateLog(selectedCateLog);
    WFManager.setDocRightByHrmResource(docRightByHrmResource);
    WFManager.setHrmResourceShow(hrmResourceShow);
    WFManager.setIsaffirmance(isaffirmance);
   // WFManager.setIsSaveCheckForm(isSaveCheckForm);
	  WFManager.setIsremak(isremak);
	  WFManager.setIsShowChart(isShowChart);
	  WFManager.setOrderbytype(orderbytype);
    WFManager.setIsAnnexUpload(isannexUpload);
    WFManager.setAnnexDocCategory(annexmaincategory+","+annexsubcategory+","+annexseccategory);
    WFManager.setIsShowOnReportInput(isShowOnReportInput);
    WFManager.setIsModifyLog(isModifyLog);
    WFManager.setShowDelButtonByReject(ShowDelButtonByReject);
    
    WFManager.setSpecialApproval(specialApproval);
    WFManager.setFrequency(Frequency);
    WFManager.setCycle(Cycle);
    
    WFManager.setIsImportwf(isimportwf);
    WFManager.setImportReadOnlyField(importReadOnlyField);
    WFManager.setFieldNotImport(fieldNotImport);
	  WFManager.setWfdocpath(wfdocpath);
	  WFManager.setWfdocowner(wfdocowner);
	  WFManager.setWfdocownertype(wfdocownertype);
	  WFManager.setWfdocownerfieldid(wfdocownerfieldid);
    WFManager.setShowUploadTab(showUploadTab);
    WFManager.setSignDoc(isSignDoc);
    WFManager.setShowDocTab(showDocTab);
    WFManager.setSignWorkflow(isSignWorkflow);
    WFManager.setShowWorkflowTab(showWorkflowTab);
    WFManager.setCanDelAcc(candelacc);
    WFManager.setIsshared(""+isshared);
    WFManager.setIsforwardRights(""+isforwardrights);
    WFManager.setIsrejectremind(isrejectremind);
    WFManager.setIschangrejectnode(ischangrejectnode);
    WFManager.setNewdocpath(newdocpath);
    WFManager.setIssignview(issignview);
	  WFManager.setNosynfields(nosynfields);
	  WFManager.setSAPSource(SAPSource);
    WFManager.setIsSelectrejectNode(isselectrejectnode);
	  WFManager.setIsImportDetail(isImportDetail);
	  WFManager.setIsneeddelacc(isneeddelacc);
	  WFManager.setSmsAlertsType(smsAlertsType);
	  WFManager.setIsForwardReceiveDef(isForwardReceiveDef);
    WFManager.setDsporder(dsporder);
    WFManager.setIsFree(isFree);
    WFManager.setIsAutoApprove(isAutoApprove);
    WFManager.setIsAutoCommit(isAutoCommit);
    WFManager.setIsAutoRemark(isAutoRemark);
    WFManager.setSubmittype(submittype);
    try{
        wfid=WFManager.setWfInfo();
    }catch (Exception e){
        new weaver.general.BaseBean().writeLog(e);
        out.println("<h2 style='text-align: center;'>"+SystemEnv.getHtmlLabelName(383324,user.getLanguage())+"</h2>");
        return;
    }
    WorkflowAllComInfo.removeWorkflowCache();
    WorkflowComInfo.removeWorkflowCache();
    TestWorkflowComInfo.removeWorkflowCache();
	  RequestUserDefaultManager.addDefaultOfSysAdmin(String.valueOf(wfid));

	//\u5c06\u65b0\u6dfb\u52a0\u7684\u6d41\u7a0b\u52a0\u5165\u7248\u672c\u4fe1\u606f\u8868
	WorkflowVersion wv=new WorkflowVersion();
	wv.saveWorkflowVersionInfo(wfid+"");
	
    //Start \u624b\u673a\u63a5\u53e3\u529f\u80fd by alan
    RecordSet.executeSql("DELETE FROM workflow_mgmsworkflows WHERE workflowid="+wfid);
    if(Util.null2String(request.getParameter("isMgms")).equals("1")){
    	RecordSet.executeSql("INSERT INTO workflow_mgmsworkflows(workflowid) VALUES ("+wfid+")");
    }	
    //End \u624b\u673a\u63a5\u53e3\u529f\u80fd
    
    //add by xhheng @ 2004/12/08 for TDID 1317 start
    //\u65b0\u589e\u5de5\u4f5c\u6d41\u65e5\u5fd7



    SysMaintenanceLog.resetParameter();
    SysMaintenanceLog.setRelatedId(wfid);
    SysMaintenanceLog.setRelatedName(Util.null2String(request.getParameter("wfname")));
    SysMaintenanceLog.setOperateType("1");
    SysMaintenanceLog.setOperateDesc("WrokFlow_insert");
    SysMaintenanceLog.setOperateItem("85");
    SysMaintenanceLog.setOperateUserid(user.getUID());
    SysMaintenanceLog.setClientAddress(request.getRemoteAddr());
    SysMaintenanceLog.setIstemplate(Util.getIntValue(isTemplate));
    SysMaintenanceLog.setSysLogInfo();
    //add by xhheng @ 2004/12/08 for TDID 1317 end
    //when the workflow is free, create two default node:create node and end node.
   	if( isFree.equals("1") ){
        //create create node
        WFNodeMainManager.resetParameter();
        WFNodeMainManager.setWfid(wfid);
        WFNodeMainManager.setFormid(formid);
        WFNodeMainManager.setNodename(SystemEnv.getHtmlLabelName(125,user.getLanguage()));
        WFNodeMainManager.setNodetype("0");
        WFNodeMainManager.setNodeorder(1);
        WFNodeMainManager.setNodeattribute("0");
        WFNodeMainManager.setNodepassnum(0);
        WFNodeMainManager.setIsbill(Integer.valueOf(isbill));
        WFNodeMainManager.setIsFreeWorkflow("1");
        WFNodeMainManager.setDrawxpos(70);
        WFNodeMainManager.setDrawypos(70);
        //\u81ea\u7531\u6d41\u7a0b\u521b\u5efa\u8282\u70b9\u9ed8\u8ba4\u53ef\u4ee5\u81ea\u7531\u9000\u56de



        WFNodeMainManager.setFreefs("2");

        WFNodeMainManager.saveWfNode();
        int createNodeId = WFNodeMainManager.getNodeid2();
        
        //create node log
        SysMaintenanceLog.resetParameter();
        SysMaintenanceLog.setRelatedId(wfid);
        SysMaintenanceLog.setRelatedName(SystemEnv.getHtmlLabelName(125,user.getLanguage()));
        SysMaintenanceLog.setOperateItem("86");
        SysMaintenanceLog.setOperateUserid(user.getUID());
        SysMaintenanceLog.setClientAddress(request.getRemoteAddr());
        SysMaintenanceLog.setOperateType("1");
        SysMaintenanceLog.setOperateDesc("WrokFlowNode_insert");
        SysMaintenanceLog.setSysLogInfo();

        //create end node
        WFNodeMainManager.resetParameter();
        WFNodeMainManager.setWfid(wfid);
        WFNodeMainManager.setFormid(formid);
        WFNodeMainManager.setNodename(SystemEnv.getHtmlLabelName(251,user.getLanguage()));
        WFNodeMainManager.setNodetype("3");
        WFNodeMainManager.setNodeorder(2);
        WFNodeMainManager.setNodeattribute("0");
        WFNodeMainManager.setNodepassnum(0);
        WFNodeMainManager.setIsbill(Integer.valueOf(isbill));
        WFNodeMainManager.setIsFreeWorkflow("1");
        WFNodeMainManager.setDrawxpos(190);
        WFNodeMainManager.setDrawypos(70);

        WFNodeMainManager.saveWfNode();
        int endNodeId = WFNodeMainManager.getNodeid2();

        //end node log
        SysMaintenanceLog.resetParameter();
        SysMaintenanceLog.setRelatedId(wfid);
        SysMaintenanceLog.setRelatedName(SystemEnv.getHtmlLabelName(251,user.getLanguage()));
        SysMaintenanceLog.setOperateItem("86");
        SysMaintenanceLog.setOperateUserid(user.getUID());
        SysMaintenanceLog.setClientAddress(request.getRemoteAddr());
        SysMaintenanceLog.setOperateType("1");
        SysMaintenanceLog.setOperateDesc("WrokFlowNode_insert");
        SysMaintenanceLog.setSysLogInfo();

        //create portal
        WFNodePortalMainManager.resetParameter();
        WFNodePortalMainManager.setWfid(wfid);
        WFNodePortalMainManager.setNodeid(createNodeId);
        WFNodePortalMainManager.setIsreject("0");
        WFNodePortalMainManager.setLinkorder(0);
        WFNodePortalMainManager.setLinkname(SystemEnv.getHtmlLabelName(251,user.getLanguage()));
        WFNodePortalMainManager.setDestnodeid(endNodeId);
        WFNodePortalMainManager.setPasstime(-1);
        WFNodePortalMainManager.setIsBulidCode("1");
        WFNodePortalMainManager.setIsMustPass("0");
        WFNodePortalMainManager.setTipsinfo(SystemEnv.getHtmlLabelName(251,user.getLanguage()));   
        WFNodePortalMainManager.setStartDirection(90);
        WFNodePortalMainManager.setEndDirection(0); 
        WFNodePortalMainManager.saveWfNodePortal();


        //portal log
        SysMaintenanceLog.resetParameter();
        SysMaintenanceLog.setRelatedId(wfid);
        SysMaintenanceLog.setRelatedName(SystemEnv.getHtmlLabelName(251,user.getLanguage()));
        SysMaintenanceLog.setOperateItem("88");
        SysMaintenanceLog.setOperateUserid(user.getUID());
        SysMaintenanceLog.setClientAddress(request.getRemoteAddr());
        SysMaintenanceLog.setOperateType("1");
        SysMaintenanceLog.setOperateDesc("WrokFlowNodePortal_insert");
        SysMaintenanceLog.setSysLogInfo();
      }

  	  if(isFnaWfInitE8){
  		try{
  			FnaWfInitE8.initE8FnaWfNode(fnaWfType1, fnaWfType2, user.getUID(), user.getLanguage(), wfid, formid, subCompanyId, isFnaWfInitE8Hm);
  		}catch(Exception ex1){
  	  		try{
  	  			//\u5931\u8d25\u5219\u5220\u9664\u5f53\u524d\u6d41\u7a0b
	  		    SysMaintenanceLog.resetParameter();
	  		    SysMaintenanceLog.setRelatedId(wfid);
	  		    //modify by xhheng @20050104 for TD 1317
	  		    WFManager.setWfid(wfid);
	  		    WFManager.getWfInfo();
	  		    SysMaintenanceLog.setRelatedName(WFManager.getWfname());
	  		    SysMaintenanceLog.setOperateType("3");
	  		    SysMaintenanceLog.setOperateDesc("WrokFlow_delete");
	  		    SysMaintenanceLog.setOperateItem("85");
	  		    SysMaintenanceLog.setOperateUserid(user.getUID());
	  		    SysMaintenanceLog.setClientAddress(request.getRemoteAddr());
	  		    SysMaintenanceLog.setIstemplate(Util.getIntValue(isTemplate));    
	  		    SysMaintenanceLog.setSysLogInfo();

				new WFMainManager().DeleteWf(new String[]{wfid+""});
				
	  	  		WorkflowAllComInfo.removeWorkflowCache();
	  	  		WorkflowComInfo.removeWorkflowCache();
	  	  		TestWorkflowComInfo.removeWorkflowCache();
	  	  		new WorkflowComInfo2().removeWorkflowCache();
  	  		}catch(Exception ex2){
  	  		}
  			new BaseBean().writeLog(ex1);
  			out.print(ex1.getMessage());
  			return;
  		}
 	  }
    }

//    WorkflowComInfo.removeWorkflowCache();
  //tagtag4prjwf
    String from=Util.null2String(request.getParameter("from"));
    if("prjwf".equalsIgnoreCase(from)){
    	response.sendRedirect("addwf0.jsp?isprjwfclose=1&from=prjwf&src=editwf&isloadleft=1&wfid="+wfid+"&isTemplate="+isTemplate+"&isrefresh=1");
    	return;
    }
    if(!ajax.equals("1"))
    	response.sendRedirect("managewf.jsp");
    else{
    	response.sendRedirect("addwf0.jsp?src=editwf&isloadleft=1&wfid="+wfid+"&isTemplate="+isTemplate+"&isrefresh=1");
    }
    return;

  }
  else if(src.equalsIgnoreCase("editwf")){
  	int wfid=Util.getIntValue(Util.null2String(request.getParameter("wfid")),0);
	
    String oldisbill = Util.null2String(request.getParameter("oldisbill"));
  	String oldiscust = Util.null2String(request.getParameter("oldiscust"));
  	String isbill = Util.null2String(request.getParameter("isbill"));
  	String iscust = Util.null2String(request.getParameter("iscust"));
  	int helpdocid = Util.getIntValue(request.getParameter("helpdocid"),0);
    String isvalid= Util.null2String(request.getParameter("isvalid"));
    String needmark= Util.null2String(request.getParameter("needmark"));
    //add by xhheng @ 2005/01/24 for \u6d88\u606f\u63d0\u9192 Request06
    String messageType= Util.null2String(request.getParameter("messageType"));
     //add by xwj  20051101 for \u90ae\u4ef6\u63d0\u9192 td2965
    String mailMessageType= Util.null2String(request.getParameter("mailMessageType"));
    String archiveNoMsgAlert = Util.null2String(request.getParameter("archiveNoMsgAlert")); // \u5f52\u6863\u8282\u70b9\u4e0d\u9700\u77ed\u4fe1\u63d0\u9192
    String archiveNoMailAlert = Util.null2String(request.getParameter("archiveNoMailAlert")); // \u5f52\u6863\u8282\u70b9\u4e0d\u9700\u90ae\u4ef6\u63d0\u9192
    String forbidAttDownload= Util.null2String(request.getParameter("forbidAttDownload"));
    String docRightByOperator= Util.null2String(request.getParameter("docRightByOperator"));
    //\u5fae\u4fe1\u63d0\u9192START(QC:98106)
    //add by fyg @ 20140319 for \u5fae\u4fe1\u63d0\u9192 
    String chatsType=Util.null2String(request.getParameter("chatsType")); 
    String chatsAlertType=Util.null2String(request.getParameter("chatsAlertType"));
    String notRemindifArchived=Util.null2String(request.getParameter("notRemindifArchived"));
  	//\u5fae\u4fe1\u63d0\u9192END(QC:98106)
    //add by xhheng @ 20050302 for TD 1545
    String multiSubmit= Util.null2String(request.getParameter("multiSubmit"));
    //add by xhheng @ 20050303 for TD 1689
    String defaultName= Util.null2String(request.getParameter("defaultName"));
	 

	if(defaultName.equals("1")){//\u6807\u9898\u9ed8\u8ba4\u589e\u52a0\u89c4\u5219
		DateUtil.InitializationWFTitle(""+wfid);
	}
    //add by xhheng @ 20050317 for \u9644\u4ef6\u4e0a\u4f20
    String pathcategory= Util.null2String(request.getParameter("pathcategory"));
    String maincategory= Util.null2String(request.getParameter("maincategory"));
    String subcategory= Util.null2String(request.getParameter("subcategory"));
    String seccategory= Util.null2String(request.getParameter("seccategory"));
    int docRightByHrmResource = Util.getIntValue(request.getParameter("docRightByHrmResource"),0);
    int hrmResourceShow = Util.getIntValue(request.getParameter("hrmResourceShow"),0);
    String isaffirmance= Util.null2String(request.getParameter("isaffirmance"));
   // String isSaveCheckForm = Util.null2String(request.getParameter("isSaveCheckForm")); // \u6d41\u7a0b\u4fdd\u5b58\u662f\u5426\u9a8c\u8bc1\u5fc5\u586b
	String isremak= Util.null2String(request.getParameter("isremark"));
	String isShowChart= Util.null2String(request.getParameter("isShowChart"));
	String orderbytype= Util.null2String(request.getParameter("orderbytype"));
	String isModifyLog= Util.null2String(request.getParameter("isModifyLog"));
    String isannexUpload= Util.null2String(request.getParameter("isannexUpload"));
    String annexmaincategory= Util.null2String(request.getParameter("annexmaincategory"));
    String annexsubcategory= Util.null2String(request.getParameter("annexsubcategory"));
    String annexseccategory= Util.null2String(request.getParameter("annexseccategory"));
    String isShowOnReportInput= Util.null2String(request.getParameter("isShowOnReportInput"));
    String ShowDelButtonByReject=Util.null2String(request.getParameter("ShowDelButtonByReject"));
    
    String specialApproval=Util.null2String(request.getParameter("specialApproval"));
    String Frequency=Util.null2String(request.getParameter("Frequency"));
    if(Frequency.equals("")) Frequency = "0";
    String Cycle=Util.null2String(request.getParameter("Cycle"));
    
    String isimportwf=Util.null2String(request.getParameter("isimportwf"));
    String importReadOnlyField = Util.null2String(request.getParameter("importReadOnlyField")); // \u5141\u8bb8\u5bfc\u5165\u6570\u636e\u5230\u53ea\u8bfb\u5b57\u6bb5
    String fieldNotImport = Util.null2String(request.getParameter("fieldNotImport"));
	String wfdocpath = Util.null2String(request.getParameter("wfdocpath"));
	String wfdocowner = Util.null2String(request.getParameter("wfdocowner"));
	String wfdocownertype = ""+Util.getIntValue(request.getParameter("wfdocownertype"), 0);
	String wfdocownerfieldid = ""+Util.getIntValue(request.getParameter("wfdocownerfieldid"), 0);
    String showUploadTab = Util.null2String(request.getParameter("showUploadTab"));
    String isImportDetail= Util.null2String(request.getParameter("isImportDetail")); 
	String isSignDoc = Util.null2String(request.getParameter("isSignDoc"));
    String showDocTab = Util.null2String(request.getParameter("showDocTab"));
    String isSignWorkflow = Util.null2String(request.getParameter("isSignWorkflow"));
    String showWorkflowTab = Util.null2String(request.getParameter("showWorkflowTab"));
    int isshared = Util.getIntValue(request.getParameter("isshared"),0);
    int isforwardrights = Util.getIntValue(request.getParameter("isforwardrights"),0);
    String isrejectremind=Util.null2String(request.getParameter("isrejectremind"));
	   String isselectrejectnode=Util.null2String(request.getParameter("isselectrejectnode"));
   String ischangrejectnode=Util.null2String(request.getParameter("ischangrejectnode")); 
    String issignview = Util.null2String(request.getParameter("issignview"));
	String nosynfields = Util.null2String(request.getParameter("nosynfields"));
	String SAPSource = Util.null2String(request.getParameter("SAPSource"));
	
	String isfnacontrol = Util.null2String(request.getParameter("isfnacontrol"));
	String fnanodeid = Util.null2String(request.getParameter("fnanodeid"));
	String fnadepartmentid = Util.null2String(request.getParameter("fnadepartmentid"));
	String smsAlertsType = Util.null2String(request.getParameter("smsAlertsType"));
	String isForwardReceiveDef = Util.null2String(request.getParameter("isForwardReceiveDef"));
	String isAutoApprove = Util.null2String(request.getParameter("isAutoApprove"));
	String isAutoCommit = Util.null2String(request.getParameter("isAutoCommit"));
	String isAutoRemark = Util.null2s(request.getParameter("isAutoRemark"),"0");
  int dsporder = Util.getIntValue(request.getParameter("dsporder"),0);
  	int submittype = Util.getIntValue(request.getParameter("submittype"),0);
	//System.out.println("isfnacontrol="+isfnacontrol);
	//System.out.println("fnanodeid="+fnanodeid);
	//System.out.println("fnadepartmentid="+fnadepartmentid);
	
	
    int formid = 0;
    int oldformid=Util.getIntValue(Util.null2String(request.getParameter("oldformid")));
	String newdocpath = Util.null2String(request.getParameter("newdocpath"));
	String isneeddelacc=Util.null2String(request.getParameter("isneeddelacc"));
	 if("".equals(isneeddelacc))  isneeddelacc="0";
	RecordSet.executeSql("select * from workflow_base where id = " + wfid);
	if(RecordSet.next()){
		wfdocpath = RecordSet.getString("wfdocpath");
		wfdocowner = RecordSet.getString("wfdocowner");
		wfdocownertype = RecordSet.getString("wfdocownertype");
		wfdocownerfieldid = RecordSet.getString("wfdocownerfieldid");
	}

  	if(isbill.equals("0")){
  		formid = Util.getIntValue(Util.null2String(request.getParameter("formid")));
  		String tablename = "";
			RecordSet.executeSql("select tablename from workflow_bill where id="+formid);	
			if(RecordSet.next()) tablename = RecordSet.getString("tablename");
			if(tablename.equals("formtable_main_"+formid*(-1)) || tablename.startsWith("uf_")){//\u65b0\u521b\u5efa\u7684\u8868\u5355\u505a\u4e3a\u5355\u636e\u4fdd\u5b58
				isbill = "1";
			}
  	}
  	else
  		formid = Util.getIntValue(Util.null2String(request.getParameter("formid")));
    //\u662f\u5426\u5141\u8bb8\u521b\u5efa\u4eba\u5220\u9664\u9644\u4ef6



    String candelacc= Util.null2String(request.getParameter("candelacc"));
    
    if(Util.getIntValue(iscust)<Util.getIntValue(oldiscust)){ 
        //\u6e05\u9664type\uff1d20\uff5e25\u7684\u64cd\u4f5c\u7ec4
        WFManager.reset();
        WFManager.setWfid(wfid);
        WFManager.clearWFCRM();
    }
    if("3".equals(oldisbill) && formid>0){
        //\u589e\u52a0\u65b0\u8868\u5355\u5b57\u6bb5\u4fe1\u606f



        WFManager.reset();
        WFManager.setWfid(wfid);
        WFManager.setFormid(formid);
  	    WFManager.setIsBill(isbill);
        WFManager.addWFFieldInfo();
    }
    if(!"3".equals(oldisbill) && !isbill.equals(oldisbill)){
        //\u6e05\u9664\u9644\u52a0\u64cd\u4f5c\u4e2d\u5173\u8054\u7684\u5b57\u6bb5\u4fe1\u606f\u3001\u5b57\u6bb5\u663e\u793a\u4fe1\u606f\u53ca\u6a21\u677f\u4fe1\u606f\u3001\u51fa\u53e3\u6761\u4ef6\u4fe1\u606f\uff0c\u589e\u52a0\u65b0\u8868\u5355\u5b57\u6bb5\u4fe1\u606f



        WFManager.reset();
        WFManager.setWfid(wfid);
        WFManager.setIsBill(isbill);
        WFManager.setFormid(formid);
        WFManager.clearWFFormInfo();
    }
    if(!"3".equals(oldisbill) && isbill.equals(oldisbill) && oldformid!=formid){
        //\u6e05\u9664\u9644\u52a0\u64cd\u4f5c\u4e2d\u5173\u8054\u7684\u5b57\u6bb5\u4fe1\u606f\u3001\u5b57\u6bb5\u663e\u793a\u4fe1\u606f\u53ca\u6a21\u677f\u4fe1\u606f\u3001\u51fa\u53e3\u6761\u4ef6\u4fe1\u606f\uff0c\u589e\u52a0\u65b0\u8868\u5355\u5b57\u6bb5\u4fe1\u606f



        WFManager.reset();
        WFManager.setWfid(wfid);
        WFManager.setIsBill(isbill);
        WFManager.setFormid(formid);
        WFManager.clearWFFormInfo();
    }
    //\u6709\u65f6\u5019subcompanyid \u83ab\u540d\u5176\u5999\u4f1a\u53d8\u4e3a-1\uff0c\u8fd9\u91cc\u9a8c\u8bc1\u4e0b
    if(subCompanyId == -1){
        WFManager.reset();
        WFManager.setWfid(wfid);
        WFManager.getWfInfo();
        subCompanyId = WFManager.getSubCompanyId2();
    }
    
    WFManager.reset();
  	WFManager.setAction("editwf");
  	WFManager.setWfid(wfid);
  	WFManager.setWfname(Util.null2String(request.getParameter("wfname")));
  	WFManager.setWfdes(Util.null2String(request.getParameter("wfdes")));
  	WFManager.setTypeid(Util.getIntValue(Util.null2String(request.getParameter("typeid"))));
    WFManager.setOldTypeid(Util.getIntValue(Util.null2String(request.getParameter("oldtypeid"))));
    WFManager.setSubCompanyId2(subCompanyId);

  	WFManager.setFormid(formid);
  	WFManager.setIsBill(isbill);
  	WFManager.setIsCust(iscust);
  	WFManager.setHelpdocid(helpdocid);
    WFManager.setIsValid(isvalid);
    WFManager.setNeedMark(needmark);
    WFManager.setMessageType(messageType);
    WFManager.setMailMessageType(mailMessageType);//added by xwj for td2965 20051101
    //\u5fae\u4fe1\u63d0\u9192START(QC:98106)
    WFManager.setChatsType(chatsType);  //add by fyg @ 20140319 for \u5fae\u4fe1\u63d0\u9192 
    WFManager.setChatsAlertType(chatsAlertType);  //add by fyg @ 20140319 for \u5fae\u4fe1\u63d0\u9192 
    WFManager.setNotRemindifArchived(notRemindifArchived);  //add by fyg @ 20140319 for \u5fae\u4fe1\u63d0\u9192 
    //\u5fae\u4fe1\u63d0\u9192END(QC:98106)
    WFManager.setArchiveNoMsgAlert(archiveNoMsgAlert);
    WFManager.setArchiveNoMailAlert(archiveNoMailAlert);
    WFManager.setForbidAttDownload(forbidAttDownload);
    WFManager.setDocRightByOperator(docRightByOperator);
    WFManager.setMultiSubmit(multiSubmit);
    WFManager.setDefaultName(defaultName);
    WFManager.setDocCategory(maincategory+","+subcategory+","+seccategory);
    WFManager.setDocPath(pathcategory);
    WFManager.setTemplateid(templateid);
    WFManager.setCatelogType(catelogType);
    WFManager.setSelectedCateLog(selectedCateLog);
    WFManager.setDocRightByHrmResource(docRightByHrmResource);
    WFManager.setHrmResourceShow(hrmResourceShow);
    WFManager.setIsaffirmance(isaffirmance);
   // WFManager.setIsSaveCheckForm(isSaveCheckForm);
	WFManager.setIsremak(isremak);
	WFManager.setIsShowChart(isShowChart);
	WFManager.setOrderbytype(orderbytype);
	WFManager.setIsModifyLog(isModifyLog);
    WFManager.setIsAnnexUpload(isannexUpload);
    WFManager.setAnnexDocCategory(annexmaincategory+","+annexsubcategory+","+annexseccategory);
    WFManager.setIsShowOnReportInput(isShowOnReportInput);
    WFManager.setShowDelButtonByReject(ShowDelButtonByReject);
    WFManager.setNosynfields(nosynfields);
    WFManager.setSAPSource(SAPSource);
    WFManager.setSpecialApproval(specialApproval);
    WFManager.setFrequency(Frequency);
    WFManager.setCycle(Cycle);
    
    WFManager.setIsImportwf(isimportwf);
    WFManager.setImportReadOnlyField(importReadOnlyField);
    WFManager.setFieldNotImport(fieldNotImport);
	WFManager.setWfdocpath(wfdocpath);
	WFManager.setWfdocowner(wfdocowner);
	WFManager.setWfdocownertype(wfdocownertype);
	WFManager.setWfdocownerfieldid(wfdocownerfieldid);
    WFManager.setShowUploadTab(showUploadTab);
    WFManager.setSignDoc(isSignDoc);
    WFManager.setShowDocTab(showDocTab);
    WFManager.setSignWorkflow(isSignWorkflow);
    WFManager.setShowWorkflowTab(showWorkflowTab);
    WFManager.setCanDelAcc(candelacc);
    WFManager.setIsshared(""+isshared);
    WFManager.setIsforwardRights(""+isforwardrights);
    WFManager.setIsrejectremind(isrejectremind);
    WFManager.setIschangrejectnode(ischangrejectnode);  
	WFManager.setNewdocpath(newdocpath);
	WFManager.setIssignview(issignview);
	  WFManager.setIsSelectrejectNode(isselectrejectnode);
	  	WFManager.setIsImportDetail(isImportDetail);
	  	WFManager.setIsneeddelacc(isneeddelacc);
	  	WFManager.setSmsAlertsType(smsAlertsType);
		WFManager.setIsForwardReceiveDef(isForwardReceiveDef);
    WFManager.setDsporder(dsporder);
    WFManager.setIsAutoApprove(isAutoApprove);
    WFManager.setIsAutoCommit(isAutoCommit);
    WFManager.setIsAutoRemark(isAutoRemark);
    WFManager.setSubmittype(submittype);
      try{
    WFManager.setWfInfo();
      }catch (Exception e){
          new weaver.general.BaseBean().writeLog(e);
          out.println("<h2 style='text-align: center;'>"+SystemEnv.getHtmlLabelName(383324,user.getLanguage())+"</h2>");
          return;
      }
    
    //\u4fdd\u5b58submitnode
    String submitnodes = "";
    if("1".equals(multiSubmit)){
    	if(submittype == 1){
    		submitnodes = Util.null2String(request.getParameter("submitnode"));
    	}else if(submittype == 2){
    		submitnodes = Util.null2String(request.getParameter("submitnode2"));
    	}
    }
    
    rs.execute("update workflow_flownode set batchsubmit = 0 where workflowid = " + wfid + " and batchsubmit = 1");
    if(!"".equals(submitnodes)){
		if(submitnodes.startsWith(","))
			submitnodes = submitnodes.substring(1);
		if(submitnodes.endsWith(","))
			submitnodes = submitnodes.substring(0,submitnodes.length() - 1);
		
		rs.execute("update workflow_flownode set batchsubmit = 1 where workflowid = " + wfid + " and nodeid in ("+submitnodes+")");
	}

    //Start \u624b\u673a\u63a5\u53e3\u529f\u80fd by alan
    RecordSet.executeSql("DELETE FROM workflow_mgmsworkflows WHERE workflowid="+wfid);
    if(Util.null2String(request.getParameter("isMgms")).equals("1")){
    	RecordSet.executeSql("INSERT INTO workflow_mgmsworkflows(workflowid) VALUES ("+wfid+")");
    }	
    //End \u624b\u673a\u63a5\u53e3\u529f\u80fd
    
    //add by xhheng @ 2004/12/08 for TDID 1317 start
    //\u4fee\u6539\u5de5\u4f5c\u6d41\u65e5\u5fd7



    SysMaintenanceLog.resetParameter();
    SysMaintenanceLog.setRelatedId(wfid);
    SysMaintenanceLog.setRelatedName(Util.null2String(request.getParameter("wfname")));
    SysMaintenanceLog.setOperateType("2");
    SysMaintenanceLog.setOperateDesc("WrokFlow_update");
    SysMaintenanceLog.setOperateItem("85");
    SysMaintenanceLog.setOperateUserid(user.getUID());
    SysMaintenanceLog.setClientAddress(request.getRemoteAddr());
    SysMaintenanceLog.setIstemplate(Util.getIntValue(isTemplate));
    SysMaintenanceLog.setSysLogInfo();
    //add by xhheng @ 2004/12/08 for TDID 1317 end
    
    
    
    //\u66f4\u65b0\u76f8\u5173\u8d39\u63a7\u5b57\u6bb5\u7684\u503c



    if(isfnacontrol.equals("")){
    	RecordSet.executeSql("update workflow_base set isfnacontrol='' where id="+wfid);
    	RecordSet.executeSql("update workflow_base set fnanodeid='' where id="+wfid);
    	RecordSet.executeSql("update workflow_base set fnadepartmentid='' where id="+wfid);
    }else{
	    RecordSet.executeSql("update workflow_base set isfnacontrol='"+isfnacontrol+"' where id="+wfid);
	    if(!fnanodeid.equals("")){
	    	RecordSet.executeSql("update workflow_base set fnanodeid='"+fnanodeid+"' where id="+wfid);
	    }
	    if(!fnadepartmentid.equals("")){
	    	RecordSet.executeSql("update workflow_base set fnadepartmentid='"+fnadepartmentid+"' where id="+wfid);
	    }
    }
    
    
    
    WorkflowAllComInfo.removeWorkflowCache();
    WorkflowComInfo.removeWorkflowCache();
    TestWorkflowComInfo.removeWorkflowCache();
    if(!ajax.equals("1")){
    response.sendRedirect("managewfTab.jsp");
    }else{
    response.sendRedirect("addwf0.jsp?ajax=1&src=editwf&wfid="+wfid+"&isTemplate="+isTemplate);
    }
    return;

  }
  else if(src.equalsIgnoreCase("bywhat")){

  	int nodeid=Util.getIntValue(Util.null2String(request.getParameter("nodeid")),0);
  	int wfid=Util.getIntValue(Util.null2String(request.getParameter("wfid")),0);
  	int formid=Util.getIntValue(Util.null2String(request.getParameter("formid")),0);
  	String isbill=Util.null2String(request.getParameter("isbill"));
  	int bywhat=Util.getIntValue(Util.null2String(request.getParameter("bywhat")),0);
  	String[] userids = request.getParameterValues("userids");
  	String tmp = "";
  	if(userids!=null){
  	for(int i=0;i<userids.length;i++){
  		String ismanager = Util.null2String(request.getParameter("ismanager_"+userids[i]));
  		if(ismanager.equals("1"))
  			tmp += ",M"+userids[i];
  		else
  			tmp += ","+userids[i];
  	}
  	}
  	if(bywhat ==0){
  		if(!tmp.equals("")){
  			tmp = tmp.substring(1);
  		}
  		String sql = "update workflow_nodebase set userbyform='0',userids='"+tmp+"' where id="+nodeid;
  		RecordSet.executeSql(sql);
  	}
  	else if(bywhat == 1){
  		String sql = "update workflow_nodebase set userbyform='1' where id = "+nodeid;
  		RecordSet.executeSql(sql);
  	}
  	  response.sendRedirect("Editwfnode.jsp?wfid="+wfid);
  	  return;


  }
  else if(src.equalsIgnoreCase("delgroups")){

  	int nodeid=Util.getIntValue(Util.null2String(request.getParameter("nodeid")),0);
  	int wfid=Util.getIntValue(Util.null2String(request.getParameter("wfid")),0);
  	int formid=Util.getIntValue(Util.null2String(request.getParameter("formid")),0);
  	String isbill=Util.null2String(request.getParameter("isbill"));
    //add by xhheng @ 2004/12/10 for TDID 1448
    String nodetype=Util.null2String(request.getParameter("nodetype"));
  	String iscust=Util.null2String(request.getParameter("iscust"));
  	String[] deleteids = request.getParameterValues("delete_wf_id");

  	String tmp = "";

	 nodetype="";
	char flag=2;
	RecordSet.executeProc("workflow_NodeType_Select",""+wfid+flag+nodeid);

	if(RecordSet.next())
		nodetype = RecordSet.getString("nodetype");

  	if(deleteids!=null){
	  	for(int i=0;i<deleteids.length;i++){
	  		tmp = deleteids[i];
	  		//\u5148\u8981\u5220\u9664\u76f8\u5173\u8d1f\u8d23\u4eba\u77e9\u9635



	  		GroupDetailMatrix.deleteAllByGroup(RecordSet, tmp);
	  		GroupDetailMatrixDetail.deleteAllByGroup(RecordSet, tmp);

	  		RecordSet.executeProc("workflow_nodegroup_Delete",tmp);
	  		RecordSet.executeProc("workflow_groupdetail_DbyGroup",tmp);
	  		String sql1 = " update workflow_nodebase set totalgroups=totalgroups-1 where id = "+nodeid;
	  		RecordSet.executeSql(sql1);
	  		RecordSet.executeSql(" delete Workflow_HrmOperator  where groupid='"+tmp+"'  ");
        //add by xhheng @ 2004/12/10 for TDID 1448
        //\u521b\u5efa\u8282\u70b9\u65f6\uff0c\u624d\u505a\u521b\u5efa\u4eba\u8868\u66f4\u65b0
	        if(nodetype!=null && nodetype.equals("0")){
			  
		         // RequestCheckUser.setWorkflowid(wfid);
		         // RequestCheckUser.updateCreateList(Util.getIntValue(tmp));
		       
				String hisWorkflowCreater=RequestUserDefaultManager.getWorkflowCreater(String.valueOf(wfid));
				RequestCheckUser.setWorkflowid(wfid);
				RequestCheckUser.setNodeid(nodeid);
			    RequestCheckUser.updateCreateList(Util.getIntValue(tmp));
				RequestUserDefaultManager.addDefaultOfNoSysAdmin(String.valueOf(wfid),hisWorkflowCreater);
	        }
	  	}
  	}

    //add by xhheng @ 2004/12/08 for TDID 1317 start
    //\u5220\u9664\u8282\u70b9\u64cd\u4f5c\u7ec4\u65e5\u5fd7



    SysMaintenanceLog.resetParameter();
    SysMaintenanceLog.setRelatedId(nodeid);
    SysMaintenanceLog.setRelatedName(SystemEnv.getHtmlLabelName(15545,user.getLanguage()));
    SysMaintenanceLog.setOperateType("3");
    SysMaintenanceLog.setOperateDesc("WrokFlowNodeOperator_delete");
    SysMaintenanceLog.setOperateItem("87");
    SysMaintenanceLog.setOperateUserid(user.getUID());
    SysMaintenanceLog.setClientAddress(request.getRemoteAddr());
    SysMaintenanceLog.setSysLogInfo();
    //add by xhheng @ 2004/12/08 for TDID 1317 end
	if(design==1)//add by cyril on 2008-12-10
		response.sendRedirect("addnodeoperator.jsp?design="+design+"&wfid="+wfid+"&nodeid="+nodeid+"&formid="+formid+"&isbill="+isbill+"&iscust="+iscust);
	else
  	  	response.sendRedirect("/workflow/workflow/editoperatorgroup.jsp?isclose=1");
  	  return;
 // response.sendRedirect("addnodeoperator.jsp?wfid="+wfid+"&nodeid="+nodeid+"&isbill="+isbill+"&iscust="+iscust+"&formid="+formid);

  }
  else if(src.equalsIgnoreCase("wfnodeadd")){
  	int wfid=Util.getIntValue(Util.null2String(request.getParameter("wfid")),0);
  	int formid=Util.getIntValue(Util.null2String(request.getParameter("formid")),0);
  	String isSaveNewVersionAndEdit=Util.null2String(request.getParameter("isSaveNewVersionAndEdit"));
  	String delids = Util.null2String(request.getParameter("delids"));
  	//\u4fdd\u5b58\u4e3a\u65b0\u6a21\u677f
  	int newwfid = -1 ;
    WorkflowVersion wv=new WorkflowVersion(""+wfid);
  	if("1".equals(isSaveNewVersionAndEdit)){
	    newwfid = wv.saveAsVersion(user,"",request.getRemoteAddr());  	  
  	    //wv.setActiveVersion();
  	    if(delids.startsWith(",")){
    	      delids = delids.substring(1);
   	    }
  	    delids = wv.getWFNodesByParentNodeIDs(newwfid+"",delids);
  	}
  	int rowsum = Util.getIntValue(Util.null2String(request.getParameter("nodesnum")));
    
  	int createnum = 0;

  	String sqltmp = "";

//  	if(!delids.equals("")){
//  		delids = delids.substring(1);
//	  	String del_ids[] =Util.TokenizerString2(delids,",");
//		for(int i=0;i<del_ids.length;i++){
//			int tmpid = Util.getIntValue(del_ids[i]);
//			sqltmp = " select count(nodeid) from workflow_flownode where nodeid="+tmpid+" and nodetype='0'";
//			RecordSet.executeSql(sqltmp);
//  			if(RecordSet.next())
//  				createnum -= RecordSet.getInt(1);
//  		}
//	}
	for(int i=0;i<rowsum;i++) {
		String tmptype = Util.null2String(request.getParameter("node_"+i+"_type"));
		if(tmptype.equals("0")){
			createnum += 1;
		}
	}
	if(createnum != 1){
        if(!ajax.equals("1"))
        response.sendRedirect("addwfnode.jsp?message=1&wfid="+wfid);
        else
        response.sendRedirect("addwfnode.jsp?ajax=1&message=1&wfid="+wfid);
        return;
	}

  	if(!delids.equals("")){
	  	String del_ids[] =Util.TokenizerString2(delids,",");
	  	WFNodeMainManager.resetParameter();
        WFNodeMainManager.deleteWfNode(del_ids,user.getUID());
      //add by xhheng @ 2004/12/08 for TDID 1317 start
      //\u5220\u9664\u8282\u70b9\u65e5\u5fd7
      for(int i=0;i<del_ids.length;i++){
        SysMaintenanceLog.resetParameter();
        //\u8bb0\u5f55\u5de5\u4f5c\u6d41id
        SysMaintenanceLog.setRelatedId(newwfid == -1 ?wfid:newwfid);
        SysMaintenanceLog.setRelatedName(SystemEnv.getHtmlLabelName(15070,user.getLanguage()));
        SysMaintenanceLog.setOperateType("3");
        SysMaintenanceLog.setOperateDesc("WrokFlowNode_delete");
        SysMaintenanceLog.setOperateItem("86");
        SysMaintenanceLog.setOperateUserid(user.getUID());
        SysMaintenanceLog.setClientAddress(request.getRemoteAddr());
        SysMaintenanceLog.setSysLogInfo();
      }
      //add by xhheng @ 2004/12/08 for TDID 1317 end
	}

    //add by mackjoe at 2005-12-19 \u8868\u5355\u4e2d\u662f\u5426\u8bbe\u7f6e\u4e86\u6a21\u677f
    int isbill=Util.getIntValue(Util.null2String(request.getParameter("isbill")),0);
    String ismode="0";
    RecordSet.executeSql("select id from workflow_formmode where formid="+formid+" and isbill='"+isbill+"'");
    if(RecordSet.next()){
        ismode="1";
    }
    //end by mackjoe
	for(int i=0;i<rowsum;i++) {
		WFNodeMainManager.resetParameter();
		WFNodeMainManager.setWfid(newwfid == -1 ?wfid:newwfid);
		WFNodeMainManager.setFormid(formid);
		String nodename = Util.null2String(request.getParameter("node_"+i+"_name"));
		int nodeid = Util.getIntValue(Util.null2String(request.getParameter("node_"+i+"_id")),0);
		if(newwfid != -1){
			nodeid = Util.getIntValue(wv.getWFNodesByParentNodeIDs(newwfid+"",nodeid+""),-1);
		}
		int nodeorder = Util.getIntValue(Util.null2String(request.getParameter("node_order_" + i)), -1);
		String nodetype = Util.null2String(request.getParameter("node_"+i+"_type"));
        String nodeattribute = Util.null2String(request.getParameter("node_"+i+"_attribute"));
        int nodepassnum = Util.getIntValue(request.getParameter("node_"+i+"_passnum"),0);

/*
		if(ismode.equals("1")){
				RecordSet.executeSql("select * from workflow_modeview where formid="+formid+" and nodeid=0");
        while(RecordSet.next()){
        	int isbill_workflow_modeview = RecordSet.getInt("isbill");
        	int fieldid = RecordSet.getInt("fieldid");
        	String isview = RecordSet.getString("isview");
        	String isedit = RecordSet.getString("isedit");
        	String ismandatory = RecordSet.getString("ismandatory");
        	rs.executeSql("select * from workflow_modeview where formid="+formid+" and nodeid="+nodeid+" and fieldid="+fieldid);
        	if(!rs.next()){
        		rs.executeSql("insert into workflow_modeview values("+formid+","+nodeid+","+isbill_workflow_modeview+","+fieldid+",'"+isview+"','"+isedit+"','"+ismandatory+"')");
        	}
        }
     }
*/     
		WFNodeMainManager.setNodename(nodename);
		WFNodeMainManager.setNodetype(nodetype);
		WFNodeMainManager.setNodeorder(nodeorder);
        WFNodeMainManager.setNodeattribute(nodeattribute);
        WFNodeMainManager.setNodepassnum(nodepassnum);
        WFNodeMainManager.setIsbill(isbill);
        //modify by xhheng @ 2004/12/08 for TDID 1317 start
		SysMaintenanceLog.resetParameter();
		SysMaintenanceLog.setRelatedId(newwfid==-1 ? wfid:newwfid);
		SysMaintenanceLog.setRelatedName(nodename);
		SysMaintenanceLog.setOperateItem("86");
		SysMaintenanceLog.setOperateUserid(user.getUID());
		SysMaintenanceLog.setClientAddress(request.getRemoteAddr());
		if(!nodename.equals("") && !nodetype.equals("") && nodeid > 0){
			//\u4fee\u6539\u8282\u70b9\u65e5\u5fd7
			SysMaintenanceLog.setOperateType("2");
			SysMaintenanceLog.setOperateDesc("WrokFlowNode_update");
            SysMaintenanceLog.setSysLogInfo();
			WFNodeMainManager.setNodeid(nodeid);
			WFNodeMainManager.updateWfNode();
		}

		if(!nodename.equals("") && !nodetype.equals("") && nodeid < 1){
			//\u65b0\u589e\u8282\u70b9\u65e5\u5fd7
			SysMaintenanceLog.setOperateType("1");
			SysMaintenanceLog.setOperateDesc("WrokFlowNode_insert");
            SysMaintenanceLog.setSysLogInfo();
			WFNodeMainManager.saveWfNode();
			nodeid=WFNodeMainManager.getNodeid2();
        }

		if(ismode.equals("1")){
			RecordSet.executeSql("select  distinct * from workflow_modeview where formid="+formid+" and nodeid=0 and not exists(select * from workflow_modeview where formid="+formid+" and nodeid="+nodeid+" and fieldId=workflow_modeview.fieldId)");

            while(RecordSet.next()){
        	    int isbill_workflow_modeview = RecordSet.getInt("isbill");
        	    int fieldid = RecordSet.getInt("fieldid");
        	    String isview = RecordSet.getString("isview");
        	    String isedit = RecordSet.getString("isedit");
        	    String ismandatory = RecordSet.getString("ismandatory");

        		rs.executeSql("insert into workflow_modeview(formId,nodeId,isBill,fieldId,isview,isedit,ismandatory)  values("+formid+","+nodeid+","+isbill_workflow_modeview+","+fieldid+",'"+isview+"','"+isedit+"','"+ismandatory+"')");
           }
		}
		//modify by xhheng @ 2004/12/08 for TDID 1317 end
	}
    //add by mackjoe at 2005-12-19 \u8868\u5355\u4e2d\u8bbe\u7f6e\u6709\u6a21\u677f\uff0c\u81ea\u52a8\u5f15\u7528\u6a21\u677f  \u79fb\u5230WFNodeMainManager\u4e2d\u5904\u7406
	/////////
	if(!delids.equals("") || rowsum > 0){
		WorkflowInitialization wfinza = new WorkflowInitialization();
		wfinza.recordInformation(wfid);
	}
	/////////


    //RecordSet.executeSql("update workflow_flownode set ismode='"+ismode+"' where workflowid="+wfid);
    //end by mackjoe
    if(!ajax.equals("1")) {
    	if(design==1) {//added by cyril on 2008-12-10
    		int nodeid=Util.getIntValue(Util.null2String(request.getParameter("nodeid")),0);
    		response.sendRedirect("addnodeoperator.jsp?design=1&wfid="+wfid+"&nodeid="+nodeid+"&formid="+formid+"&isbill="+isbill+"&iscust="+WFManager.getIsCust());
    	}
    	else	
			response.sendRedirect("Editwfnode.jsp?wfid="+wfid);
    }
    else {
    	response.sendRedirect("Editwfnode.jsp?ajax=1&wfid="+wfid);
    }
    return;

  }
    else if(src.equalsIgnoreCase("addoperatorgroup")){
  	int nodeid=Util.getIntValue(Util.null2String(request.getParameter("nodeid")),0);
  	
  	int nodetype = -1;
    RecordSet.executeSql("SELECT nodetype FROM workflow_flownode WHERE nodeid="+nodeid);
    if(RecordSet.next()){
         nodetype = Util.getIntValue(RecordSet.getString("nodetype"));
    }
    
  	int wfid=Util.getIntValue(Util.null2String(request.getParameter("wfid")),0);
  	int formid=Util.getIntValue(Util.null2String(request.getParameter("formid")),0);
  	String isbill=Util.null2String(request.getParameter("isbill"));
  	String iscust=Util.null2String(request.getParameter("iscust"));

	int id = 0;
  	String sql = "select max(id) as id from workflow_nodegroup";
  	RecordSet.executeSql(sql);

  	if(RecordSet.next()){
  		id = Util.getIntValue(Util.null2String(RecordSet.getString("id")),0);
  	}
  	id += 1;

	int rowsum = Util.getIntValue(Util.null2String(request.getParameter("groupnum")));
	WFNodeOperatorManager.resetParameter();
	WFNodeOperatorManager.setId(id);
	WFNodeOperatorManager.setNodeid(nodeid);
	String groupname = Util.null2String(request.getParameter("groupname"));
	int canview = Util.getIntValue(request.getParameter("canview"),0);
	WFNodeOperatorManager.setName(groupname);
	WFNodeOperatorManager.setCanview(canview);
	WFNodeOperatorManager.setAction("add");
	WFNodeOperatorManager.AddGroupInfo();
    String para="";  
	for(int i=0;i<rowsum;i++) {

		String type = Util.null2String(request.getParameter("group_"+i+"_type"));
		String virtualid = Util.null2String(request.getParameter("group_"+i+"_virtual"));
		String ruleRelationship = Util.null2String(request.getParameter("group_"+i+"_ruleRelationship"));
		String groupid = Util.null2String(request.getParameter("group_"+i+"_id"));
		int level = Util.getIntValue(Util.null2String(request.getParameter("group_"+i+"_level")),0);
		int level2 = Util.getIntValue(Util.null2String(request.getParameter("group_"+i+"_level2")),0);
		String deptField = Util.null2String(request.getParameter("group_"+i+"_deptField"));
		String subcompanyField = Util.null2String(request.getParameter("group_"+i+"_subcompanyField"));
        String conditions=Util.null2String(request.getParameter("group_"+i+"_condition"));
        String orders=Util.null2String(request.getParameter("group_"+i+"_order"));
		String signorder=Util.null2String(request.getParameter("group_"+i+"_signorder"));
		//\u5bf9\u5e94\u4e3a\u7a7a\uff0c\u6ca1\u9009\u60c5\u51b5\u5224\u65ad\u51fa\u6765\u4e0b
		if(signorder.equals("[object]")){
			signorder="";
		}
		String hrmgroupidn="";
		 if(type.equals("3")){//\u4e00\u822c\u7c7b\u578b\uff1a\u4eba\u529b\u8d44\u6e90\u7c7b\u578b
			 hrmgroupidn=groupid;
			 if (nodetype != 0) {
			     groupid="0";
			 }
		  }
        String jobobj=Util.null2String(request.getParameter("group_"+i+"_jobobj"));
        String jobfield=Util.null2String(request.getParameter("group_"+i+"_jobfield"));
        String IsCoadjutant=Util.null2String(request.getParameter("group_"+i+"_IsCoadjutant"));
        String signtype=Util.null2String(request.getParameter("group_"+i+"_signtype"));
		String issyscoadjutant=Util.null2String(request.getParameter("group_"+i+"_issyscoadjutant"));
        String coadjutants=Util.null2String(request.getParameter("group_"+i+"_coadjutants"));
        String issubmitdesc=Util.null2String(request.getParameter("group_"+i+"_issubmitdesc"));
		String ispending=Util.null2String(request.getParameter("group_"+i+"_ispending"));
        String isforward=Util.null2String(request.getParameter("group_"+i+"_isforward"));
        String ismodify=Util.null2String(request.getParameter("group_"+i+"_ismodify"));
		String Coadjutantconditions=Util.null2String(request.getParameter("group_"+i+"_Coadjutantconditions"));
		int bhxj = Util.getIntValue(request.getParameter("group_"+i+"_bhxj"),0);
		//td13272
		signorder = "-1".equals(signorder) ? "" : signorder;
        String conditioncn=Util.fromScreen(Util.null2String(request.getParameter("group_"+i+"_conditioncn")),user.getLanguage());
		if (orders.equals("")) orders="0";
		if(!type.equals("")){
			String matrixValue = groupid;
			//\u5173\u8054\u8d23\u4efb\u4eba



			if ("99".equals(type)) {
				groupid = "0";
			}
			char flag=2;
			para=""+id+flag+type+flag+groupid+flag+level+flag+level2+flag+conditions+flag+conditioncn+flag+orders+flag+signorder+flag+IsCoadjutant+
                    flag+signtype+flag+issyscoadjutant+flag+issubmitdesc+flag+ispending+flag+isforward+flag+ismodify+flag+coadjutants+flag+Coadjutantconditions+flag+virtualid+flag+ruleRelationship;

			RecordSet.executeProc("workflow_groupdetail_Insert",para);
			
		   //\u5904\u7406\u90e8\u95e8\u3001\u5206\u90e8\u81ea\u5b9a\u4e49\u5b57\u6bb5
		   int maxID=-1;
		   if(RecordSet.next()){
		      maxID = RecordSet.getInt(1);
	       }

	       if(maxID>0){
	    	   String updateDeptFieldSQL="update workflow_groupdetail set jobobj ='"+jobobj+ "',jobfield ='"+jobfield+ "',deptField ='"+deptField+"',subcompanyField='"+subcompanyField+"',bhxj = "+bhxj+" where id="+maxID;
	          //String updateDeptFieldSQL="update workflow_groupdetail set deptField ='"+deptField+"',subcompanyField='"+subcompanyField+"' where id="+maxID;
	          RecordSet.executeSql(updateDeptFieldSQL);

	          if(type.equals("3")){//\u4e00\u822c\u7c7b\u578b\uff1a\u4eba\u529b\u8d44\u6e90\u7c7b\u578b
	        	  
	        	  RecordSet.executeSql("delete from Workflow_HrmOperator where groupdetailid='"+maxID+"'");
		          //\u5c06\u4eba\u529b\u8d44\u6e90\u7c7b\u578b\u503c\u5199\u5165\u4e2d\u95f4\u8868\u4e2dstart==
		         List hrmoperatorlist=Util.TokenizerString(hrmgroupidn,",");
		          for(int index=0;index<hrmoperatorlist.size();index++){
			          RecordSet.executeSql("insert into Workflow_HrmOperator(type,objid,signorder,orders,groupid,groupdetailid)values('"+type+"','"+hrmoperatorlist.get(index)+"','"+signorder+"','"+index+"','"+id+"','"+maxID+"')");
		          }	  
	          //\u5c06\u4eba\u529b\u8d44\u6e90\u7c7b\u578b\u503c\u5199\u5165\u4e2d\u95f4\u8868\u4e2dend== 
	          }
	          
	          if ("99".equals(type)) {
	        	  int groupdetailid = maxID;
		          String[] valueAry = matrixValue.split(",");
		          String matrix = valueAry[0];
		          String value_field = valueAry[1];
		          GroupDetailMatrix gdMatrix = new GroupDetailMatrix();
		          gdMatrix.setGroupdetailid(String.valueOf(groupdetailid));
		          gdMatrix.setMatrix(matrix);
		          gdMatrix.setValue_field(value_field);
		          gdMatrix.save(RecordSet);
		          for (int z = 2; z < valueAry.length; z++) {
		        	  String rowValue = valueAry[z];
		        	  String[] rowValueAry = rowValue.split(":");
		        	  String condition_field = rowValueAry[0];
		        	  String workflow_field = rowValueAry[1];
		        	  GroupDetailMatrixDetail gdMatrixDetail = new GroupDetailMatrixDetail();
		        	  gdMatrixDetail.setGroupdetailid(String.valueOf(groupdetailid));
		        	  gdMatrixDetail.setCondition_field(condition_field);
		        	  gdMatrixDetail.setWorkflow_field(workflow_field);
		        	  gdMatrixDetail.save(RecordSet);
		          }
	          }
	       }

	       //\u89c4\u5219\u903b\u8f91  ===== START =========
	    	String rulemaplistid = Util.null2String(request.getParameter("group_"+i+"_rulemaplistids"));
	    	if(!rulemaplistid.equals(""))
	    	{
	    		String[] _mlid = Util.TokenizerString2(rulemaplistid,",");
	    		for(int j=0;j<_mlid.length;j++)
	    		{
	    			RecordSet.executeSql(" select * from rule_maplist where id="+_mlid[j]);
	    			String nm = "";
	    			String ruleid = "";
	    			String mapid = "";
	    			if(RecordSet.first())
	    			{
	    				nm = Util.null2String(RecordSet.getString("nm"));
	    				ruleid = Util.null2String(RecordSet.getString("ruleid"));
	    				mapid = Util.null2String(RecordSet.getString("id"));
	    			}
	   				RecordSet.executeSql("update rule_maplist set linkid='"+maxID+"',rowidenty='0' where id='"+mapid+"'");
	   				RecordSet.executeSql("update rule_mapitem set linkid='"+maxID+"',rowidenty='0' where linkid='"+nodeid+"' and rulesrc=2 and rowidenty="+(i+1));
	    			if(nm.equals("0"))
	    			{
	    				RecordSet.executeSql(" update rule_base set linkid="+maxID+",rulename='"+WorkflowComInfo.getWorkflowname(wfid+"")+"-"+SystemEnv.getHtmlLabelName(21223,user.getLanguage())+SystemEnv.getHtmlLabelName(15364,user.getLanguage())+"-"+maxID+"' where id="+ruleid);
	    			}
	    		}
	    	}
		}
	}
	
	RecordSet.executeSql("delete from rule_maplist where  rowidenty<>0 and linkid='"+nodeid+"' and rulesrc=2");
	
	int iscreate = Util.getIntValue(request.getParameter("iscreate"),0);
	if(iscreate==1 && wfid > 0){
        String hisWorkflowCreater=RequestUserDefaultManager.getWorkflowCreater(String.valueOf(wfid));
		RequestCheckUser.setWorkflowid(wfid);
		RequestCheckUser.setNodeid(nodeid);
	    RequestCheckUser.updateCreateList(id);
		RequestUserDefaultManager.addDefaultOfNoSysAdmin(String.valueOf(wfid),hisWorkflowCreater);

	}

	//add by xhheng @ 2004/12/08 for TDID 1317 start
	//\u65b0\u589e\u64cd\u4f5c\u4eba\u7ec4\u65e5\u5fd7
	SysMaintenanceLog.resetParameter();
	SysMaintenanceLog.setRelatedId(nodeid);
	SysMaintenanceLog.setRelatedName(groupname);
	SysMaintenanceLog.setOperateType("1");
	SysMaintenanceLog.setOperateDesc("WrokFlowNodeOperator_insert");
	SysMaintenanceLog.setOperateItem("87");
	SysMaintenanceLog.setOperateUserid(user.getUID());
	SysMaintenanceLog.setClientAddress(request.getRemoteAddr());
	SysMaintenanceLog.setSysLogInfo();
	
	/////////
	if(rowsum > 0){
		WorkflowInitialization wfinza = new WorkflowInitialization();
		wfinza.recordInformation(wfid);
	}
	/////////
	
	//add by xhheng @ 2004/12/08 for TDID 1317 end
    if(!ajax.equals("1"))
    response.sendRedirect("addnodeoperator.jsp?design="+design+"&wfid="+wfid+"&isbill="+isbill+"&iscust="+iscust+"&formid="+formid+"&nodeid="+nodeid);
    else{
    response.sendRedirect("/workflow/workflow/addoperatorgroup.jsp?isclose=1");
    }
    return;

  }
  else if(src.equalsIgnoreCase("editoperatorgroup")){
	 // System.out.println("--editoperatorgroup--");
  	int nodeid=Util.getIntValue(Util.null2String(request.getParameter("nodeid")),0);
  	
  	int nodetype = -1;
    RecordSet.executeSql("SELECT nodetype FROM workflow_flownode WHERE nodeid="+nodeid);
    if(RecordSet.next()){
         nodetype = Util.getIntValue(RecordSet.getString("nodetype"));
    }
  	
  	int wfid=Util.getIntValue(Util.null2String(request.getParameter("wfid")),0);
  	int formid=Util.getIntValue(Util.null2String(request.getParameter("formid")),0);
  	int id=Util.getIntValue(Util.null2String(request.getParameter("id")),0);
  	String isbill=Util.null2String(request.getParameter("isbill"));
  	String iscust=Util.null2String(request.getParameter("iscust"));
	String oldids=Util.null2String(request.getParameter("oldids"));

  	char flag1 = 2;
  	//RecordSet.executeProc("workflow_groupdetail_DbyGroup",""+id);

	int rowsum = Util.getIntValue(Util.null2String(request.getParameter("groupnum")));
	WFNodeOperatorManager.resetParameter();
	WFNodeOperatorManager.setId(id);
	WFNodeOperatorManager.setNodeid(nodeid);
	String groupname = Util.null2String(request.getParameter("groupname"));
	int canview = Util.getIntValue(request.getParameter("canview"),0);
	WFNodeOperatorManager.setName(groupname);
	WFNodeOperatorManager.setCanview(canview);
    String para="";  
	for(int i=0;i<rowsum;i++) {

		String type = Util.null2String(request.getParameter("group_"+i+"_type"));
		String virtualid = Util.null2String(request.getParameter("group_"+i+"_virtual"));
		String ruleRelationship = Util.null2String(request.getParameter("group_"+i+"_ruleRelationship"));
		String groupid = Util.null2String(request.getParameter("group_"+i+"_id"));
		
		int level = Util.getIntValue(Util.null2String(request.getParameter("group_"+i+"_level")),0);
		int level2 = Util.getIntValue(Util.null2String(request.getParameter("group_"+i+"_level2")),0);
		String deptField = Util.null2String(request.getParameter("group_"+i+"_deptField"));
		String subcompanyField = Util.null2String(request.getParameter("group_"+i+"_subcompanyField"));
        String conditions=Util.null2String(request.getParameter("group_"+i+"_condition"));
		String signorder=Util.null2String(request.getParameter("group_"+i+"_signorder"));
		//\u5bf9\u5e94\u4e3a\u7a7a\uff0c\u6ca1\u9009\u60c5\u51b5\u5224\u65ad\u51fa\u6765\u4e0b
		if(signorder.equals("[object]")){
			signorder="";
		}
		
		
		//td13272
		signorder = "-1".equals(signorder) ? "" : signorder;
		
		
		
		String hrmgroupidn="";
        String orders=Util.null2String(request.getParameter("group_"+i+"_order"));
        String conditioncn=Util.htmlFilter4UTF8(Util.fromScreen(Util.null2String(request.getParameter("group_"+i+"_conditioncn")),user.getLanguage()));
		String oldid=Util.null2String(request.getParameter("group_"+i+"_oldid"));
        String IsCoadjutant=Util.null2String(request.getParameter("group_"+i+"_IsCoadjutant"));
        String signtype=Util.null2String(request.getParameter("group_"+i+"_signtype"));
		String issyscoadjutant=Util.null2String(request.getParameter("group_"+i+"_issyscoadjutant"));
        String coadjutants=Util.null2String(request.getParameter("group_"+i+"_coadjutants"));
        String issubmitdesc=Util.null2String(request.getParameter("group_"+i+"_issubmitdesc"));
		String ispending=Util.null2String(request.getParameter("group_"+i+"_ispending"));
        String isforward=Util.null2String(request.getParameter("group_"+i+"_isforward"));
        String ismodify=Util.null2String(request.getParameter("group_"+i+"_ismodify"));
		String Coadjutantconditions=Util.null2String(request.getParameter("group_"+i+"_Coadjutantconditions"));
		String jobobj=Util.null2String(request.getParameter("group_"+i+"_jobobj"));
        String jobfield=Util.null2String(request.getParameter("group_"+i+"_jobfield"));
		int bhxj = Util.getIntValue(request.getParameter("group_"+i+"_bhxj"),0);
		if (orders.equals("")) orders="0";
	 
		if(!type.equals("")){
			String matrixValue = groupid;
			//\u5173\u8054\u8d23\u4efb\u4eba
			if ("99".equals(type)) {
				groupid = "0";
			}
			char flag=2;
			 if(type.equals("3")){//\u4e00\u822c\u7c7b\u578b\uff1a\u4eba\u529b\u8d44\u6e90\u7c7b\u578b
				 hrmgroupidn=groupid;
				 if (nodetype != 0) {
				     groupid="0";
				 }
			  }
			
			 if(virtualid.equals("undefined")){//\u6807\u51c6\u589e\u52a0\u8fd9\u4e2a\u5b57\u6bb5\uff0c\u5728\u4fdd\u5b58\u4e00\u822c\u7c7b\u578b \u4eba\u529b\u8d44\u6e90\u3001\u6240\u6709\u4eba\u7b49\u60c5\u51b5\uff0c\u4fdd\u5b58\u4f1a\u63d0\u793a\u5b58\u50a8\u8fc7\u7a0b\u5f02\u5e38 
				 virtualid="";
			 } 
			 
		    if (oldid.equals("")){
				 
				 
                para=""+id+flag+type+flag+groupid+flag+level+flag+level2+flag+conditions+flag+conditioncn+flag+orders+flag+signorder+flag+IsCoadjutant+
                    flag+signtype+flag+issyscoadjutant+flag+issubmitdesc+flag+ispending+flag+isforward+flag+ismodify+flag+coadjutants+flag+Coadjutantconditions+flag+virtualid+flag+ruleRelationship;
                RecordSet.executeProc("workflow_groupdetail_Insert",para);
			   //\u5904\u7406\u90e8\u95e8\u81ea\u5b9a\u4e49\u5b57\u6bb5

			   int maxID=-1;
			   if(RecordSet.next()){
			      maxID = RecordSet.getInt(1);
		       }
			   
			//   System.out.println("--editoperatorgroup-maxID:"+maxID);
			 
		       if(maxID>0){
		    	  String updateDeptFieldSQL="update workflow_groupdetail set jobobj = '"+jobobj+"',jobfield ='"+jobfield+"',deptField ='"+deptField+"',subcompanyField='"+subcompanyField+"',bhxj = "+bhxj+" where id="+maxID;
//		          String updateDeptFieldSQL="update workflow_groupdetail set deptField ='"+deptField+"',subcompanyField='"+subcompanyField+"' where id="+maxID;
		          RecordSet.executeSql(updateDeptFieldSQL);
		          if(type.equals("3")){//\u4e00\u822c\u7c7b\u578b\uff1a\u4eba\u529b\u8d44\u6e90\u7c7b\u578b
			          //\u5c06\u4eba\u529b\u8d44\u6e90\u7c7b\u578b\u503c\u5199\u5165\u4e2d\u95f4\u8868\u4e2dstart==
			          RecordSet.executeSql(" delete from Workflow_HrmOperator where groupdetailid='"+maxID+"' ");  
		        	  List hrmoperatorlist=Util.TokenizerString(hrmgroupidn,",");
			          for(int index=0;index<hrmoperatorlist.size();index++){
				          RecordSet.executeSql("insert into Workflow_HrmOperator(type,objid,signorder,orders,groupid,groupdetailid)values('"+type+"','"+hrmoperatorlist.get(index)+"','"+signorder+"','"+index+"','"+id+"','"+maxID+"')");
			          }	
			          //\u5c06\u4eba\u529b\u8d44\u6e90\u7c7b\u578b\u503c\u5199\u5165\u4e2d\u95f4\u8868\u4e2dend== 
		          }  
		          if ("99".equals(type)) {
		        	  int groupdetailid = maxID;
			          String[] valueAry = matrixValue.split(",");
			          String matrix = valueAry[0];
			          String value_field = valueAry[1];
			          GroupDetailMatrix gdMatrix = new GroupDetailMatrix();
			          gdMatrix.setGroupdetailid(String.valueOf(groupdetailid));
			          gdMatrix.setMatrix(matrix);
			          gdMatrix.setValue_field(value_field);
			          gdMatrix.save(RecordSet);
			          for (int z = 2; z < valueAry.length; z++) {
			        	  String rowValue = valueAry[z];
			        	  String[] rowValueAry = rowValue.split(":");
			        	  String condition_field = rowValueAry[0];
			        	  String workflow_field = rowValueAry[1];
			        	  GroupDetailMatrixDetail gdMatrixDetail = new GroupDetailMatrixDetail();
			        	  gdMatrixDetail.setGroupdetailid(String.valueOf(groupdetailid));
			        	  gdMatrixDetail.setCondition_field(condition_field);
			        	  gdMatrixDetail.setWorkflow_field(workflow_field);
			        	  gdMatrixDetail.save(RecordSet);
			          }
		          }
		        //\u89c4\u5219\u903b\u8f91  ===== START =========
			    	String rulemaplistid = Util.null2String(request.getParameter("group_"+i+"_rulemaplistids"));
			    	if(!rulemaplistid.equals(""))
			    	{
			    		String[] _mlid = Util.TokenizerString2(rulemaplistid,",");
			    		for(int j=0;j<_mlid.length;j++)
			    		{
			    			RecordSet.executeSql(" select * from rule_maplist where id="+_mlid[j]);
			    			String nm = "";
			    			String ruleid = "";
			    			String mapid = "";
			    			if(RecordSet.first())
			    			{
			    				nm = Util.null2String(RecordSet.getString("nm"));
			    				ruleid = Util.null2String(RecordSet.getString("ruleid"));
			    				mapid = Util.null2String(RecordSet.getString("id"));
			    			}
			   				RecordSet.executeSql("update rule_maplist set linkid='"+maxID+"',rowidenty='0' where id='"+mapid+"'");
			   				RecordSet.executeSql("update rule_mapitem set linkid='"+maxID+"',rowidenty='0' where linkid='"+nodeid+"' and rulesrc=2 and rowidenty="+(i + 1));
			    			if(nm.equals("0"))
			    			{
			    				RecordSet.executeSql(" update rule_base set linkid="+maxID+",rulename='"+WorkflowComInfo.getWorkflowname(wfid+"")+"-"+SystemEnv.getHtmlLabelName(21223,user.getLanguage())+SystemEnv.getHtmlLabelName(15364,user.getLanguage())+"-"+maxID+"' where id="+ruleid);
			    			}
			    		}
			    		
			    	}
		       }                
            }
			else
			{
				
				 
				RecordSet.execute("update workflow_groupdetail set  type="+type+", objid="+groupid+", level_n="+level+", level2_n="+level2+", conditions='"+conditions+"', conditioncn='"+conditioncn+"', orders='"+orders+"', signorder='"+signorder+
	                    "',IsCoadjutant='"+IsCoadjutant+"',signtype='"+signtype+"'," +
	                    "issyscoadjutant='"+issyscoadjutant+"',issubmitdesc='"+issubmitdesc+"',ispending='"+ispending+"',isforward='"+isforward+"',ismodify='"+ismodify+"'," +
	                   // "coadjutants='"+coadjutants+"',coadjutantcn='"+Coadjutantconditions+"',deptField='"+deptField+"',subcompanyField='"+subcompanyField+"',virtualid='"+virtualid+"',ruleRelationship='"+ruleRelationship+"' where id="+oldid);
                		"coadjutants='"+coadjutants+"',coadjutantcn='"+Coadjutantconditions+"',deptField='"+deptField+"',subcompanyField='"+subcompanyField+"',virtualid='"+virtualid+"',ruleRelationship='"+ruleRelationship+"',bhxj = "+bhxj+",jobfield = '"+jobfield+"',jobobj = '"+jobobj+"' where id="+oldid);
				oldids=Util.StringReplace(oldids,","+oldid+",",",-1,");
				
				
				
				//\u66f4\u65b0
				
				 if(type.equals("3")){//\u4e00\u822c\u7c7b\u578b\uff1a\u4eba\u529b\u8d44\u6e90\u7c7b\u578b
				  //\u5c06\u4eba\u529b\u8d44\u6e90\u7c7b\u578b\u503c\u5199\u5165\u4e2d\u95f4\u8868\u4e2dstart==
					      RecordSet.executeSql(" delete from Workflow_HrmOperator where groupdetailid='"+oldid+"' ");  
			        	  List hrmoperatorlist=Util.TokenizerString(hrmgroupidn,",");
				          for(int index=0;index<hrmoperatorlist.size();index++){
					          RecordSet.executeSql("insert into Workflow_HrmOperator(type,objid,signorder,orders,groupid,groupdetailid)values('"+type+"','"+hrmoperatorlist.get(index)+"','"+signorder+"','"+index+"','"+id+"','"+oldid+"')");
					          
				          }	
		          //\u5c06\u4eba\u529b\u8d44\u6e90\u7c7b\u578b\u503c\u5199\u5165\u4e2d\u95f4\u8868\u4e2dend== 
				 }

				if ("99".equals(type)) {
					
		        	  String groupdetailid = oldid;
			          String[] valueAry = matrixValue.split(",");
			          String matrix = valueAry[0];
			          String value_field = valueAry[1];
			          GroupDetailMatrix gdMatrix = new GroupDetailMatrix();
			          gdMatrix.setGroupdetailid(String.valueOf(groupdetailid));
			          gdMatrix.setMatrix(matrix);
			          gdMatrix.setValue_field(value_field);
			          gdMatrix.update(RecordSet);
						GroupDetailMatrixDetail.delete(RecordSet, groupdetailid);
			          for (int z = 2; z < valueAry.length; z++) {
			        	  String rowValue = valueAry[z];
			        	  String[] rowValueAry = rowValue.split(":");
			        	  String condition_field = rowValueAry[0];
			        	  String workflow_field = rowValueAry[1];
					
			        	  //\u5220\u9664\u65e7\u7684
			        	  
						  //GroupDetailMatrixDetail.delete(RecordSet, groupdetailid,condition_field,workflow_field);
			        	  //\u6dfb\u52a0\u65b0\u7684
			        	  GroupDetailMatrixDetail gdMatrixDetail = new GroupDetailMatrixDetail();
			        	  gdMatrixDetail.setGroupdetailid(String.valueOf(groupdetailid));
			        	  gdMatrixDetail.setCondition_field(condition_field);
			        	  gdMatrixDetail.setWorkflow_field(workflow_field);
			        	  gdMatrixDetail.save(RecordSet);
			          }
		          }
			}
		}

	}
	
	//\u9352\u72bb\u6ace\u93bf\u5d84\u7d94\u9470\u546c\u9a87\u9422\u71ba\u6b91\u9368\u51a8\u6e87\u93c1\u7248\u5d41
	RecordSet.executeSql("delete workflow_groupdetail where groupid in (select id from workflow_nodegroup where nodeid=0)");
	
    RecordSet.execute("delete from workflow_groupdetail where groupid in (select id from workflow_nodegroup where nodeid=0)");
	
	RecordSet.executeSql("delete workflow_nodegroup where nodeid=0");
	
	RecordSet.executeSql("delete from rule_maplist where  rowidenty<>0 and linkid='"+nodeid+"' and rulesrc=2");
	    //\u5220\u9664
	if (!oldids.equals(",")&&!oldids.equals(""))
	{
	oldids="-1"+oldids+"-1";
    RecordSet.execute("delete from workflow_groupdetail where id in ("+oldids+") ");
    	//\u5220\u9664\u76f8\u5173\u8d23\u4efb\u4eba\u77e9\u9635
   RecordSet.executeSql(" delete from Workflow_HrmOperator where groupdetailid in ("+oldids+") ");


   	 	GroupDetailMatrix.deleteAll(RecordSet, oldids);
   	 	GroupDetailMatrixDetail.deleteAll(RecordSet, oldids);
   	 	//\u5220\u9664\u5f15\u7528\u89c4\u5219
   	 	RecordSet.execute("delete from rule_maplist where linkid in (" + oldids + ") and rulesrc=2 ");
   		RecordSet.execute("delete from rule_mapitem where linkid in (" + oldids + ") and rulesrc=2 ");
   	 	
	}
		WFNodeOperatorManager.setAction("edit");
		WFNodeOperatorManager.AddGroupInfo();

		
	int iscreate = Util.getIntValue(request.getParameter("iscreate"),0);
	if(iscreate==1 && wfid > 0){
        String hisWorkflowCreater=RequestUserDefaultManager.getWorkflowCreater(String.valueOf(wfid));
		RequestCheckUser.setWorkflowid(wfid);
		RequestCheckUser.setNodeid(nodeid);
	    RequestCheckUser.updateCreateList(id);
		RequestUserDefaultManager.addDefaultOfNoSysAdmin(String.valueOf(wfid),hisWorkflowCreater);
	}

	//add by xhheng @ 2004/12/08 for TDID 1317 start
	//\u7f16\u8f91\u64cd\u4f5c\u4eba\u7ec4\u65e5\u5fd7
	SysMaintenanceLog.resetParameter();
	SysMaintenanceLog.setRelatedId(nodeid);
	SysMaintenanceLog.setRelatedName(groupname);
	SysMaintenanceLog.setOperateType("2");
	SysMaintenanceLog.setOperateDesc("WrokFlowNodeOperator_update");
	SysMaintenanceLog.setOperateItem("87");
	SysMaintenanceLog.setOperateUserid(user.getUID());
	SysMaintenanceLog.setClientAddress(request.getRemoteAddr());
	SysMaintenanceLog.setSysLogInfo();
	//add by xhheng @ 2004/12/08 for TDID 1317 end
    if(!ajax.equals("1")) {
    	response.sendRedirect("addnodeoperator.jsp?design="+design+"&wfid="+wfid+"&isbill="+isbill+"&iscust="+iscust+"&formid="+formid+"&nodeid="+nodeid);
    }
    else
    	response.sendRedirect("/workflow/workflow/editoperatorgroup.jsp?isclose=1");
    return;

  }else if(src.equalsIgnoreCase("nodefieldhtml")){
		wFNodeFieldManager.setRequest(request);
  		wFNodeFieldManager.setUser(user);
  		int modeid = wFNodeFieldManager.setNodeFieldInfo4Html();
  		int wfid = Util.getIntValue(request.getParameter("wfid"), 0);//
  		int nodeid = Util.getIntValue(request.getParameter("nodeid"), 0);//
  		int formid = Util.getIntValue(request.getParameter("formid"), 0);//
  		int isbill = Util.getIntValue(request.getParameter("isbill"), 0);//
  		int needprep = Util.getIntValue(request.getParameter("needprep"), 0);//
		int design_tmp = Util.getIntValue(request.getParameter("design"), 0);//
		int isExcel = Util.getIntValue(request.getParameter("isExcel"),0);
		if(isExcel != 0 ){	//\u5f53\u5982\u679c\u662f\u65b0\u7248\u6d41\u7a0b\u8868\u5355\u8bbe\u8ba1\u5668\u65f6\uff0c\u8fd9\u91cc\u4e0d\u9700\u8981\u91cd\u5b9a\u5411\u4e86



			//\u6839\u636e\u4fdd\u5b58\u7684\u4fe1\u606f\uff0c \u9700\u8981\u62fc2\u4e2ajson \uff1a\u81ea\u5b9a\u4e49\u5c5e\u6027json \u548c\u63a7\u4ef6\u6240\u9700\u7684json
			int excelStyle = Util.getIntValue(request.getParameter("excelStyle"),0);
			String issys = Util.null2String(request.getParameter("excelIssys"));
			int exceloutype = Util.getIntValue(request.getParameter("exceloutype"));
			//1\u8868\u793a\u6279\u91cf\u8bbe\u7f6e\u5b57\u6bb5\u5c5e\u6027\u53ea\u4fdd\u5b58\uff0c2\u8868\u793a\u6279\u91cf\u8bbe\u7f6e\u5b57\u6bb5\u5c5e\u6027\u5e76\u521d\u59cb\u5316\uff0c3\u8868\u793a\u6a21\u677f\u5217\u8868\u9875\u9762\u521d\u59cb\u5316\u5b57\u6bb5\u5c5e\u6027



			int saveAttrFlag=Util.getIntValue(request.getParameter("saveAttrFlag"),0);
			if(saveAttrFlag==1){
				out.print("<script>jQuery(document).ready(function(){parent.closeCurDialog()});</script>");
			}else{
				excelsetInitManager.setRequest(request);
				excelsetInitManager.setUser(user);
				excelsetInitManager.setIsSys(issys);
				excelsetInitManager.setExcelStyle(excelStyle);
				modeid = excelsetInitManager.createSheetJson(exceloutype,1,excelStyle);
				if(saveAttrFlag==2){
					out.print("<script>jQuery(document).ready(function(){parent.closeCurDialog()});</script>");
				}else if(saveAttrFlag==3){
					out.print("<script>jQuery(document).ready(function(){parent.initExcel("+excelStyle+","+modeid+")});</script>");
				}
			}
			return;
		}
  		if(needprep == 0){
	  		response.sendRedirect("/workflow/workflow/addwfnodefield.jsp?ajax=1&wfid="+wfid+"&nodeid="+nodeid);
			return;
  		}else if(needprep == 1){
  			response.sendRedirect("/workflow/workflow/edithtmlnodefield.jsp?needprep=1&wfid="+wfid+"&nodeid="+nodeid+"&ajax="+ajax+"&modeid="+modeid);
			return;
  		}else if(needprep == 2){//\u9884\u89c8\u4ee5\u540e\u518d\u6279\u91cf\u8bbe\u7f6e\u540e\uff0c\u5173\u95ed\u8bbe\u7f6e\u9875\u9762\uff0c\u5e76\u4e14\u5237\u65b0\u539f\u6765\u9875\u9762
  			if(design_tmp == 1){
  				response.sendRedirect("/workflow/workflow/addwfnodefield.jsp?ajax="+ajax+"&wfid="+wfid+"&nodeid="+nodeid+"&design="+design);
  				return;
  			}else{
	  			out.println("<script>try{window.opener.location.href=\"/workflow/html/LayoutEditFrame.jsp?formid="+formid+"&wfid="+wfid+"&nodeid="+nodeid+"&isbill="+isbill+"&layouttype=0&ajax=0&modeid="+modeid+"\";}catch(e){}");
	  			out.println("window.close();");
	  			out.println("</script>");
  			}
  		}
  		return;
  }else if(src.equalsIgnoreCase("saveGeneralField")){
	  	int wfid=Util.getIntValue(Util.null2String(request.getParameter("wfid")),0);
	  	int nodeid=Util.getIntValue(Util.null2String(request.getParameter("nodeid")),0);
	  	int formid=Util.getIntValue(Util.null2String(request.getParameter("formid")),0);
	  	String isbill = Util.null2String(request.getParameter("isbill"));
	    String isnew = Util.null2String(request.getParameter("isnew"));
	    String _modename = Util.null2String(request.getParameter("modename"));
      	//\u65b0\u5efa\u6a21\u677f
     	if(_modename.equals("")){
     		RecordSet.executeSql("select nodename from workflow_nodebase where id="+nodeid);
     		RecordSet.first();
     		_modename = RecordSet.getString("nodename") + SystemEnv.getHtmlLabelName(16450,user.getLanguage());
     	}
        if(!isnew.equals("")){
	      	RecordSet.executeSql(" select id from wfnodegeneralmode where formid="+formid+" and isbill="+isbill+" and nodeid="+nodeid+" and wfid="+wfid);
	      	RecordSet.first();
	      	int moid = Util.getIntValue(RecordSet.getString("id"),0);
	      	if( moid> 0)
	      		RecordSet.executeSql(" update wfnodegeneralmode set modename='"+_modename+"' where id="+moid);
	      	else
	      		RecordSet.executeSql(" insert into wfnodegeneralmode(modename,formid,isbill,wfid,nodeid) values ('"+
	      			_modename+"',"+formid+","+isbill+","+wfid+","+nodeid+")");
       }
       int nodetype = -1;
       RecordSet.executeSql("SELECT nodetype FROM workflow_flownode WHERE nodeid="+nodeid);
       if(RecordSet.next()){
       		nodetype = Util.getIntValue(RecordSet.getString("nodetype"));
       }
       /*\u4fdd\u5b58\u7cfb\u7edf\u5b57\u6bb5 begin*/
       if(nodetype !=0){		//\u521b\u5efa\u8282\u70b9\u4e0d\u53ef\u7f16\u8f91\u5219\u4e0d\u6539\u53d8\u7cfb\u7edf\u5b57\u6bb5\u5c5e\u6027\uff0c\u5426\u5219\u4f1a\u5bfc\u81f4\u4fdd\u5b58\u540eHtml\u5b57\u6bb5\u5c5e\u6027\u88ab\u6539\u53d8QC148566
	        String curedit_ = Util.null2String(request.getParameter("title_edit"));
		 	String curview_ = Util.null2String(request.getParameter("title_view"));
		 	String curman_ = Util.null2String(request.getParameter("title_man"));
		 	WFNodeFieldMainManager.resetParameter();
		 	WFNodeFieldMainManager.setNodeid(nodeid);
			WFNodeFieldMainManager.setFieldid(-1);
			WFNodeFieldMainManager.setIsview("1");
		 	WFNodeFieldMainManager.setIsedit("0");
		 	WFNodeFieldMainManager.setIsmandatory("0");
		 	if(curedit_.equals("on")){
		 		WFNodeFieldMainManager.setIsedit("1");
		 		WFNodeFieldMainManager.setIsmandatory("1");
		 	}
			WFNodeFieldMainManager.saveWfNodeField2();
	
	        String curview1 = Util.null2String(request.getParameter("level_view"));
		 	String curedit1 = Util.null2String(request.getParameter("level_edit"));
		 	String curman1 = Util.null2String(request.getParameter("level_man"));
		 	WFNodeFieldMainManager.resetParameter();
		 	WFNodeFieldMainManager.setNodeid(nodeid);
			WFNodeFieldMainManager.setFieldid(-2);
			WFNodeFieldMainManager.setIsview("1");
		 	WFNodeFieldMainManager.setIsedit("0");
		 	WFNodeFieldMainManager.setIsmandatory("0");
		 	if(curedit1.equals("on")){
		 		WFNodeFieldMainManager.setIsedit("1");
		 		WFNodeFieldMainManager.setIsmandatory("1");
		 	}
			WFNodeFieldMainManager.saveWfNodeField2();
	  			
	        String curview2 = Util.null2String(request.getParameter("ismessage_view"));
		 	String curedit2 = Util.null2String(request.getParameter("ismessage_edit"));
		 	String curman2 = Util.null2String(request.getParameter("ismessage_man"));
		 	WFNodeFieldMainManager.resetParameter();
		 	WFNodeFieldMainManager.setNodeid(nodeid);
			WFNodeFieldMainManager.setFieldid(-3);
			WFNodeFieldMainManager.setIsview("1");
		 	WFNodeFieldMainManager.setIsedit("0");
		 	WFNodeFieldMainManager.setIsmandatory("0");
		 	if(curedit2.equals("on"))
		 		WFNodeFieldMainManager.setIsedit("1");
			WFNodeFieldMainManager.saveWfNodeField2();
       }
		
		String curview3 = Util.null2String(request.getParameter("ischats_view"));
	 	String curedit3 = Util.null2String(request.getParameter("ischats_edit"));
	 	String curman3 = Util.null2String(request.getParameter("ischats_man"));
	 	WFNodeFieldMainManager.resetParameter();
	 	WFNodeFieldMainManager.setNodeid(nodeid);
		WFNodeFieldMainManager.setFieldid(-5);
		WFNodeFieldMainManager.setIsview("1");
	 	WFNodeFieldMainManager.setIsedit("0");
	 	WFNodeFieldMainManager.setIsmandatory("0"); 
	 	if(curedit3.equals("on"))
	 		WFNodeFieldMainManager.setIsedit("1");
		WFNodeFieldMainManager.saveWfNodeField2();
		/*\u4fdd\u5b58\u7cfb\u7edf\u5b57\u6bb5 end*/
   /*--xwj for td1834 on 005-05-18 begin--*/
   if(isbill.equals("0")){
	  	FormFieldMainManager.setFormid(formid);
		FormFieldMainManager.selectAllFormField();
        int groupid=-1;
		while(FormFieldMainManager.next()){
			int curid=FormFieldMainManager.getFieldid();
            int curgroupid=FormFieldMainManager.getGroupid();
            if(curgroupid==-1) curgroupid=999;
            String isdetail = FormFieldMainManager.getIsdetail();
			WFNodeFieldMainManager.resetParameter();
			WFNodeFieldMainManager.setNodeid(nodeid);
			WFNodeFieldMainManager.setFieldid(curid);
		 	String curedit = Util.null2String(request.getParameter("node"+curid+"_edit_g"+curgroupid));
		 	String curview = Util.null2String(request.getParameter("node"+curid+"_view_g"+curgroupid));
		 	String curman = Util.null2String(request.getParameter("node"+curid+"_man_g"+curgroupid));

		 	WFNodeFieldMainManager.setIsview("0");
		 	WFNodeFieldMainManager.setIsedit("0");
		 	WFNodeFieldMainManager.setIsmandatory("0");
		 	if(curview.equals("on"))
		 		WFNodeFieldMainManager.setIsview("1");
		 	if(curedit.equals("on"))
		 		WFNodeFieldMainManager.setIsedit("1");
		 	if(curman.equals("on"))
		 		WFNodeFieldMainManager.setIsmandatory("1");
			WFNodeFieldMainManager.saveWfNodeField2();

            if(isdetail.equals("1") && curgroupid>groupid) {
                groupid=curgroupid;
                String dtladd = Util.null2String(request.getParameter("dtl_add_"+curgroupid));
                String dtledit = Util.null2String(request.getParameter("dtl_edit_"+curgroupid));
                String dtldelete = Util.null2String(request.getParameter("dtl_del_"+curgroupid));
                String dtlhide = Util.null2String(request.getParameter("hide_del_"+curgroupid));
                String dtldefault = Util.null2String(request.getParameter("dtl_def_"+curgroupid));
                String dtlneed = Util.null2String(request.getParameter("dtl_ned_"+curgroupid));

				  String dtlmul = Util.null2String(request.getParameter("dtl_mul_"+curgroupid));//zzl
				  
				  int dt1defaultrows = Util.getIntValue(request.getParameter("dtl_defrow"+curgroupid),0);
				  dt1defaultrows = dt1defaultrows<=0?1:dt1defaultrows;
				  
                WFNodeDtlFieldManager.setNodeid(nodeid);
                WFNodeDtlFieldManager.setGroupid(curgroupid);
                WFNodeDtlFieldManager.setIsadd("0");
                WFNodeDtlFieldManager.setIsedit("0");
                WFNodeDtlFieldManager.setIsdelete("0");
                WFNodeDtlFieldManager.setIshide("0");
                WFNodeDtlFieldManager.setIsdefault("0");
                WFNodeDtlFieldManager.setIsopensapmul("0");//zzl
                WFNodeDtlFieldManager.setIsneed("0");
                WFNodeDtlFieldManager.setDefaultrows(dt1defaultrows);
                if(dtladd.equals("on"))
                    WFNodeDtlFieldManager.setIsadd("1");
                if(dtledit.equals("on"))
                    WFNodeDtlFieldManager.setIsedit("1");
                if(dtldelete.equals("on"))
                    WFNodeDtlFieldManager.setIsdelete("1");
                if(dtlhide.equals("on"))
                    WFNodeDtlFieldManager.setIshide("1");
                if(dtldefault.equals("on"))
                    WFNodeDtlFieldManager.setIsdefault("1");
                 if(dtlmul.equals("on"))
                    WFNodeDtlFieldManager.setIsopensapmul("1");//zzl
                if(dtlneed.equals("on"))
                    WFNodeDtlFieldManager.setIsneed("1");
                WFNodeDtlFieldManager.saveWfNodeDtlField();
            }
		}
	}else if(isbill.equals("1")){
		boolean isNewForm = false;//\u662f\u5426\u662f\u65b0\u8868\u5355 modify by myq for TD8730 on 2008.9.12
		RecordSet.executeSql("select tablename from workflow_bill where id = "+formid);
		if(RecordSet.next()){
			String temptablename = Util.null2String(RecordSet.getString("tablename"));
			if(temptablename.equals("formtable_main_"+formid*(-1)) || temptablename.startsWith("uf_")) isNewForm = true;
		}
		String sql = "select * from workflow_billfield where billid = "+formid+"  order by viewtype,detailtable,dsporder";
		if(isNewForm == true){
			if("ORACLE".equalsIgnoreCase(RecordSet.getDBType())){
				sql = "select * from workflow_billfield where billid = "+formid +" order by viewtype,TO_NUMBER((select orderid from Workflow_billdetailtable bd where bd.billid = billid and bd.tablename = detailtable)),dsporder ";
			}else{
				sql = "select * from workflow_billfield where billid = "+formid +" order by viewtype,convert(int, (select orderid from Workflow_billdetailtable bd where bd.billid = billid and bd.tablename = detailtable)),dsporder ";
			}
		}else{
			sql = "select * from workflow_billfield where billid = "+formid +" order by viewtype,detailtable,dsporder ";
		}
		RecordSet.executeSql(sql);
       int curgroupid=0;
       String predetailtable=null;
        while(RecordSet.next()){
			int curid=RecordSet.getInt("id");
            int viewtype=RecordSet.getInt("viewtype");
            String detailtable = Util.null2String(RecordSet.getString("detailtable"));
            WFNodeFieldMainManager.resetParameter();
			WFNodeFieldMainManager.setNodeid(nodeid);
			WFNodeFieldMainManager.setFieldid(curid);
            if(viewtype==1 && !detailtable.equals(predetailtable)){
                predetailtable=detailtable;
                curgroupid++;
            }
            String curedit = Util.null2String(request.getParameter("node"+curid+"_edit_g"+curgroupid));
		 	String curview = Util.null2String(request.getParameter("node"+curid+"_view_g"+curgroupid));
		 	String curman = Util.null2String(request.getParameter("node"+curid+"_man_g"+curgroupid));

		 	WFNodeFieldMainManager.setIsview("0");
		 	WFNodeFieldMainManager.setIsedit("0");
		 	WFNodeFieldMainManager.setIsmandatory("0");
		 	if(curview.equals("on"))
		 		WFNodeFieldMainManager.setIsview("1");
		 	if(curedit.equals("on"))
		 		WFNodeFieldMainManager.setIsedit("1");
		 	if(curman.equals("on"))
		 		WFNodeFieldMainManager.setIsmandatory("1");

			WFNodeFieldMainManager.saveWfNodeField2();
		}        
        for(int i=0;i<curgroupid;i++){
            String dtladd = Util.null2String(request.getParameter("dtl_add_"+(i+1)));
                String dtledit = Util.null2String(request.getParameter("dtl_edit_"+(i+1)));
                String dtldelete = Util.null2String(request.getParameter("dtl_del_"+(i+1)));
                String dtlhide = Util.null2String(request.getParameter("hide_del_"+(i+1)));
                String dtldefault = Util.null2String(request.getParameter("dtl_def_"+(i+1)));
                String dtlneed = Util.null2String(request.getParameter("dtl_ned_"+(i+1)));
				  String dtlmul = Util.null2String(request.getParameter("dtl_mul_"+(i+1)));//zzl
				  int dt1defaultrows = Util.getIntValue(request.getParameter("dtl_defrow"+(i+1)),0);
				  dt1defaultrows = dt1defaultrows<=0?1:dt1defaultrows;
                WFNodeDtlFieldManager.setNodeid(nodeid);
                WFNodeDtlFieldManager.setGroupid(i);
                WFNodeDtlFieldManager.setIsadd("0");
                WFNodeDtlFieldManager.setIsedit("0");
                WFNodeDtlFieldManager.setIsdelete("0");
                WFNodeDtlFieldManager.setIshide("0");
                WFNodeDtlFieldManager.setIsdefault("0");
                WFNodeDtlFieldManager.setIsneed("0");
                WFNodeDtlFieldManager.setIsopensapmul("0");//zzl
                WFNodeDtlFieldManager.setDefaultrows(dt1defaultrows);
                if(dtladd.equals("on"))
                    WFNodeDtlFieldManager.setIsadd("1");
                if(dtledit.equals("on"))
                    WFNodeDtlFieldManager.setIsedit("1");
                if(dtldelete.equals("on"))
                    WFNodeDtlFieldManager.setIsdelete("1");
                if(dtlhide.equals("on"))
                    WFNodeDtlFieldManager.setIshide("1");
                if(dtldefault.equals("on"))
                    WFNodeDtlFieldManager.setIsdefault("1");
                 if(dtlmul.equals("on"))
                    WFNodeDtlFieldManager.setIsopensapmul("1");//zzl
                if(dtlneed.equals("on"))
                    WFNodeDtlFieldManager.setIsneed("1");
                WFNodeDtlFieldManager.saveWfNodeDtlField();
			}
		}
  		RecordSet.executeSql("update workflow_flownode set ismode='0' where workflowid="+wfid+" and nodeid="+nodeid);
  		response.sendRedirect("/workflow/workflow/addwfnodegeneral.jsp?isclose=1&wfid="+wfid+"&isbill="+isbill+"&nodeid="+nodeid+"&formid="+formid);
  }else if(src.equalsIgnoreCase("wfnodefield")){
  	int wfid=Util.getIntValue(Util.null2String(request.getParameter("wfid")),0);
  	int nodeid=Util.getIntValue(Util.null2String(request.getParameter("nodeid")),0);
  	int formid=Util.getIntValue(Util.null2String(request.getParameter("formid")),0);
  	String isbill = Util.null2String(request.getParameter("isbill"));
    String modetype=Util.null2String(request.getParameter("modetype"));
    String _modename = Util.null2String(request.getParameter("modename"));
    String _sql="";
    if(modetype.equals("0")){
    	String ischoose = Util.null2String(request.getParameter("ischoose"));
    	int _nodeid = -1;
    	if("y".equals(ischoose)){	//y\uff1a\u9009\u62e9\u4e86\u6a21\u677f
    		int choosemodeid = Util.getIntValue(request.getParameter("choosemodeid"),0);
    		RecordSet.executeSql(" select nodeid from wfnodegeneralmode where id="+choosemodeid);
    		if(RecordSet.next()){
    			_nodeid = RecordSet.getInt("nodeid");
    		}
    	}else{
    		_nodeid = nodeid;
    	}
    	String gensyncNodes=Util.null2String(request.getParameter("gensyncNodes"));
    	gensyncNodes += ","+nodeid;
    	ArrayList syncnodeids = Util.TokenizerString(gensyncNodes, ",");
		for(int i=0;i<syncnodeids.size();i++){
			int syncnodeid= Util.getIntValue(syncnodeids.get(i).toString());
			if(syncnodeid == _nodeid)
				continue;
			//\u666e\u901a\u6a21\u5f0f\u6a21\u677f\u8868\u4fee\u6539
			RecordSet.executeSql(" select nodename from workflow_nodebase where id="+syncnodeid);
	       	RecordSet.first();
	       	_modename = RecordSet.getString("nodename") + SystemEnv.getHtmlLabelName(16450,user.getLanguage());
			RecordSet.executeSql(" select id from wfnodegeneralmode where formid="+formid+" and isbill="+isbill+" and nodeid="+syncnodeid+" and wfid="+wfid);
        	RecordSet.first();
        	int moid = Util.getIntValue(RecordSet.getString("id"),0);
        	if(moid>0){
        		RecordSet.executeSql(" update wfnodegeneralmode set modename='"+_modename+"' where id="+moid);
        	}else{
        		RecordSet.executeSql(" insert into wfnodegeneralmode(modename,formid,isbill,wfid,nodeid) values ('"+
        			_modename+"',"+formid+","+isbill+","+wfid+","+syncnodeid+")");
        	}
			//\u5b57\u6bb5\u8868\u5148\u5220\u540e\u63d2
			RecordSet.executeSql(" delete from workflow_nodeform where nodeid="+syncnodeid);
			_sql=" insert into workflow_nodeform(nodeid,fieldid,isview,isedit,ismandatory,orderid) "+
				 " select "+syncnodeid+",fieldid,isview,isedit,ismandatory,orderid from workflow_nodeform where nodeid="+_nodeid;
			RecordSet.executeSql(_sql);
			//\u660e\u7ec6\u5b57\u6bb5\u5220\u9664\u63d2\u5165
			RecordSet.executeSql(" delete from workflow_NodeFormGroup where nodeid="+syncnodeid);
			RecordSet.executeSql(" select count(*) as count from workflow_NodeFormGroup where nodeid="+_nodeid);
			RecordSet.first();
			if(RecordSet.getInt("count")>0){
				_sql=" insert into workflow_NodeFormGroup(nodeid,groupid,isadd,isedit,isdelete,ishidenull,isdefault,isneed,isopensapmul,defaultrows) "+
					 " select "+syncnodeid+",groupid,isadd,isedit,isdelete,ishidenull,isdefault,isneed,isopensapmul,defaultrows from workflow_NodeFormGroup where nodeid="+_nodeid;
				RecordSet.executeSql(_sql);
			}
			//\u6539\u53d8\u8282\u70b9\u6a21\u677f\u6a21\u5f0f
			RecordSet.executeSql("update workflow_flownode set ismode='"+modetype+"' where workflowid="+wfid+" and nodeid="+syncnodeid);
		}
		//\u4fdd\u5b58\u6253\u5370\u6a21\u677f  liuzy 20140830
		int gen_belmodetype=Util.getIntValue(Util.null2String(request.getParameter("gen_belmodetype")),0);
		String genprintsyncNodes=Util.null2String(request.getParameter("genprintsyncNodes"));
	    String printsyncNodes = genprintsyncNodes;
        printsyncNodes += ","+nodeid ;
    	ArrayList printsyncNodeList = Util.TokenizerString(printsyncNodes, ",");
		if(gen_belmodetype==1){
		    ConnStatement statement=new ConnStatement();
        	try {
       			boolean isoracle = (statement.getDBType()).equals("oracle");
        		String sqlstr="";
        		String modestr="";
                int modeids=Util.getIntValue(Util.null2String(request.getParameter("printmodeid")),0);
                String modename=Util.null2String(request.getParameter("printmodename"));
                int i=1;
                String updatestr="printdes";
                String modetable="workflow_nodemode";
                if(Util.getIntValue(Util.null2String(request.getParameter("printisform")),0)==1){
                    modetable="workflow_formmode";
                }
                ArrayList list = printsyncNodeList ; 
                for(int k = 0 ; k<list.size();k++){
                	nodeid = Util.getIntValue(list.get(k).toString());
               	    RecordSet.executeSql("select n.nodename, f.nodetype from workflow_nodebase n left join workflow_flownode f on f.nodeid=n.id where n.id="+nodeid);
               	    if(RecordSet.next()){
               		   modename = RecordSet.getString("nodename") + SystemEnv.getHtmlLabelName(16450,user.getLanguage());
               	    }
	                RecordSet.executeSql("select id from workflow_nodemode where workflowid="+wfid+" and nodeid="+nodeid+" and isprint='"+i+"'");
	                //\u5df2\u7ecf\u6709\u6a21\u677f



	                if(RecordSet.next()){
	                    int modeid=RecordSet.getInt("id");          
	                    if(modeids>0){		//\u66f4\u65b0\u6a21\u677f
	                        if(modetable.equals("workflow_nodemode")){
	                            sqlstr="select modedesc from "+modetable+" where id="+modeids;
	                            statement.setStatementSql(sqlstr);
	                            statement.executeQuery();
	                            if (statement.next()) {
	                                if(isoracle){
	                                    CLOB theclob = statement.getClob(1);
	                                    String readline = "" ;
	                                    StringBuffer clobStrBuff = new StringBuffer("") ;
	                                    BufferedReader clobin = new BufferedReader(theclob.getCharacterStream());
	                                    while ((readline = clobin.readLine()) != null) clobStrBuff = clobStrBuff.append(readline) ;
	                                    clobin.close() ;
	                                    modestr=clobStrBuff.toString();
	                                }else{
	                                	modestr = statement.getString("modedesc");
	                                }
	                            }
	                            if(isoracle){
	                                sqlstr="update workflow_nodemode set modename=? where id="+modeid;
	                                statement.setStatementSql(sqlstr);
	                                statement.setString(1 , modename);
	                                statement.executeUpdate();
	
	                                sqlstr = "select modedesc from workflow_nodemode where id = "+modeid;
	                                statement.setStatementSql(sqlstr, false);
	                                statement.executeQuery();
	                                if(statement.next()){
	                                    CLOB theclob = statement.getClob(1);
	                                    char[] contentchar = modestr.toCharArray();
	                                    Writer contentwrite = theclob.getCharacterOutputStream();
	                                    contentwrite.write(contentchar);
	                                    contentwrite.flush();
	                                    contentwrite.close();
	                                }
	                            }else{
	                                sqlstr="update workflow_nodemode set modedesc=?,modename=? where id="+modeid;
	                                statement.setStatementSql(sqlstr);
	                                statement.setString(1 , modestr);
	                                statement.setString(2 , modename);
	                                statement.executeUpdate();
	                            }
	                        }else{
	                            RecordSet.executeSql("delete from workflow_nodemode where workflowid="+wfid+" and nodeid="+nodeid+" and isprint='"+i+"'");
	                        }
	                    }else{
	                        //\u5220\u9664\u6a21\u677f
	                        RecordSet.executeSql("delete from workflow_nodemode where workflowid="+wfid+" and nodeid="+nodeid+" and isprint='"+i+"'");
	                        RecordSet.executeSql("select id from workflow_nodemode where formid="+formid+" and nodeid="+nodeid+" and isprint!='"+i+"'");
	                        if(RecordSet.getCounts() <= 0) {
	                        	RecordSet.executeSql("delete from workflow_modeview where formid="+formid+" and nodeid="+nodeid+" and isbill="+isbill);
	                        }
	                        RecordSet.executeSql("update workflow_flownode set "+updatestr+"='1' where workflowid="+wfid+" and nodeid="+nodeid);
	                    }
	                }else{
	                    //\u6ca1\u6709\u6a21\u677f,\u63d2\u5165\u6a21\u677f
	                    if(modeids>0){
	                        if(modetable.equals("workflow_nodemode")){
	                            sqlstr="select modedesc from "+modetable+" where id="+modeids;
	                            statement.setStatementSql(sqlstr);
	                            statement.executeQuery();
	                            if (statement.next()) {
	                                if(isoracle){
	                                    CLOB theclob = statement.getClob(1);
	                                    String readline = "" ;
	                                    StringBuffer clobStrBuff = new StringBuffer("") ;
	                                    BufferedReader clobin = new BufferedReader(theclob.getCharacterStream());
	                                    while ((readline = clobin.readLine()) != null) clobStrBuff = clobStrBuff.append(readline) ;
	                                    clobin.close() ;
	                                    modestr=clobStrBuff.toString();
	                                }else{
	                                    modestr = statement.getString("modedesc");
	                                }
	                            }
	                            if(isoracle){
	                                sqlstr="insert into workflow_nodemode(formid,nodeid,isprint,modedesc,workflowid,modename) values(?,?,?,empty_clob(),?,?)";
	                                statement.setStatementSql(sqlstr);
	                                statement.setInt(1 ,formid);
	                                statement.setInt(2 ,nodeid);
	                                statement.setString(3 ,""+i);
	                                statement.setInt(4 ,wfid);
	                                statement.setString(5 ,modename);
	                                statement.executeUpdate();
	
	                                sqlstr = "select modedesc from workflow_nodemode where formid = "+formid+" and nodeid="+nodeid+" and isprint='"+i+"' and workflowid="+wfid+" order by id desc";
	                                statement.setStatementSql(sqlstr, false);
	                                statement.executeQuery();
	                                if(statement.next()){
	                                    CLOB theclob = statement.getClob(1);
	                                    char[] contentchar = modestr.toCharArray();
	                                    Writer contentwrite = theclob.getCharacterOutputStream();
	                                    contentwrite.write(contentchar);
	                                    contentwrite.flush();
	                                    contentwrite.close();
	                                }
	                            }else{
	                                sqlstr="insert into workflow_nodemode(formid,nodeid,isprint,modedesc,workflowid,modename) values(?,?,?,?,?,?)";
	                                statement.setStatementSql(sqlstr);
	                                statement.setInt(1 ,formid);
	                                statement.setInt(2 ,nodeid);
	                                statement.setString(3 ,""+i);
	                                statement.setString(4 , modestr);
	                                statement.setInt(5 ,wfid);
	                                statement.setString(6 ,modename);
	                                statement.executeUpdate();
	                            }
	                        }
	                        RecordSet.executeSql("update workflow_flownode set "+updatestr+"='0' where workflowid="+wfid+" and nodeid="+nodeid);                   
	                    }else{
	                        RecordSet.executeSql("update workflow_flownode set "+updatestr+"='1' where workflowid="+wfid+" and nodeid="+nodeid);
	                    }
	                }
            	}
            }catch(Exception e){
	            e.printStackTrace();
	        }finally{
	            statement.close();
	        }
		}else if(gen_belmodetype==2){
			//\u9700\u5220\u9664\u5b58\u5728\u7684\u8282\u70b9\u4e0a\u7684 \u6a21\u677f\u6a21\u5f0f\u6253\u5370\u6a21\u677f
			RecordSet.executeSql("delete from workflow_nodemode where workflowid="+wfid+" and nodeid="+nodeid+" and isprint='1' ");
	    	htmlLayoutOperate.setRequest(request);
	    	htmlLayoutOperate.setUser(user);
	    	htmlLayoutOperate.saveLayout_print();
		}
  		//add by mackjoe at 2005-12-19 \u4fdd\u5b58\u663e\u793a\u7c7b\u578b
    }else if(modetype.equals("1")){
        int showmodeid=Util.getIntValue(Util.null2String(request.getParameter("showmodeid")),0);
        int printmodeid=Util.getIntValue(Util.null2String(request.getParameter("printmodeid")),0);
        int showisform=Util.getIntValue(Util.null2String(request.getParameter("showisform")),0);
        int printisform=Util.getIntValue(Util.null2String(request.getParameter("printisform")),0);
        String showmodename=Util.null2String(request.getParameter("showmodename"));
        String printmodename=Util.null2String(request.getParameter("printmodename"));
        int showtype=Util.getIntValue(Util.null2String(request.getParameter("showtype")),0);   
        int vtapprove=0;
        int vtrealize=0;
        int vtforward=0;
		int vtpostil=0;
		int vtHandleForward = 0;
		int vtTakingOpinions = 0;
		int vttpostil=0;   
        int vtrecipient=0;
		int vtrpostil=0; 
        int vtreject=0;
        int vtsuperintend=0;
        int vtover=0;
        int vtintervenor=0;
        int vdcomments=0;
        int vddeptname=0;
        int vdoperator=0;
        int vddate=0;
        int vdtime=0;
        int stnull=Util.getIntValue(Util.null2String(request.getParameter("showtype_null")),0);
        int vsignupload=0;
		int vmobilesource=0;
        int vsigndoc=0;
        int vsignworkflow=0;
        int toexcel=0;
        toexcel=Util.getIntValue(Util.null2String(request.getParameter("toexcel")),0);
        String viewtypeall=Util.null2String(request.getParameter("viewtype_all"));
        String viewdescall=Util.null2String(request.getParameter("viewdesc_all"));
        if(viewtypeall.indexOf("viewtype_all")!=-1||viewtypeall.equals("1")){
        	viewtypeall = "1";
        }else{
        	if(viewtypeall.indexOf("viewtype_approve")!=-1)
        		vtapprove=1;
        	if(viewtypeall.indexOf("viewtype_realize")!=-1)
        		vtrealize=1;
        	if(viewtypeall.indexOf("viewtype_forward")!=-1)
        		vtforward=1;
        	if(viewtypeall.indexOf("viewtype_postil")!=-1)
        		vtpostil=1;
			if(viewtypeall.indexOf("view_handleForward")!=-1)
        		vtHandleForward=1;
			if(viewtypeall.indexOf("view_takingOpinions")!=-1)
        		vtTakingOpinions=1;
			if(viewtypeall.indexOf("viewtype_tpostil")!=-1)
        		vttpostil=1;
			if(viewtypeall.indexOf("viewtype_recipient")!=-1)
        		vtrecipient=1;
        	if(viewtypeall.indexOf("viewtype_rpostil")!=-1)
        		vtrpostil=1;
			if(viewtypeall.indexOf("viewtype_reject")!=-1)
        		vtreject=1;
        	if(viewtypeall.indexOf("viewtype_superintend")!=-1)
        		vtsuperintend=1;
        	if(viewtypeall.indexOf("viewtype_over")!=-1)
        		vtover=1;
        	if(viewtypeall.indexOf("viewtype_intervenor")!=-1)
        		vtintervenor=1;
        	viewtypeall = "0";
        }
        if(viewdescall.indexOf("viewdesc_all")!=-1||viewdescall.equals("1")){
        	viewdescall = "1";
			vdcomments=1;
			vddeptname=1;
			vdoperator=1;
			vddate=1;
			vdtime=1;
			vsignupload=1;
			vsigndoc=1;
			vsignworkflow=1;
			vmobilesource=1;
        }else{
        	if(viewdescall.indexOf("viewdesc_comments")!=-1)
        		vdcomments=1;
        	if(viewdescall.indexOf("viewdesc_deptname")!=-1)
        		vddeptname=1;
        	if(viewdescall.indexOf("viewdesc_operator")!=-1)
        		vdoperator=1;
        	if(viewdescall.indexOf("viewdesc_date")!=-1)
        		vddate=1;
        	if(viewdescall.indexOf("viewdesc_time")!=-1)
        		vdtime=1;
        	if(viewdescall.indexOf("viewdesc_signupload")!=-1)
        		vsignupload=1;
        	if(viewdescall.indexOf("viewdesc_signdoc")!=-1)
        		vsigndoc=1;
        	if(viewdescall.indexOf("viewdesc_signworkflow")!=-1)
        		vsignworkflow=1;
			if(viewdescall.indexOf("viewdesc_mobilesource")!=-1)
        		vmobilesource=1;
        	viewdescall = "0";
        }
        
        
        /*************************/
        String syncNodes = Util.null2String(request.getParameter("modesyncNodes")) ;
        String printsyncNodes = Util.null2String(request.getParameter("modeprintsyncNodes")) ;
        syncNodes += ","+nodeid ;
        printsyncNodes += ","+nodeid ;
        
        ConnStatement statement=new ConnStatement();
        try {
        boolean isoracle = (statement.getDBType()).equals("oracle");
        String sqlstr="";
        String modestr="";
        int modeids=showmodeid;
        String modename=showmodename;
        String modetable="workflow_nodemode";
        String updatestr="";
        //RecordSet.executeSql("delete from workflow_modeview where formid="+formid+" and nodeid="+nodeid+" and isbill="+isbill);
        ArrayList syncnodeids = Util.TokenizerString(syncNodes, ",");
        ArrayList syncprintnodeids = Util.TokenizerString(printsyncNodes, ",");
        for(int i=0;i<2;i++){
                if(i==0){
                    modeids=showmodeid;
                    modename=showmodename;
                    updatestr="showdes";
                    modetable="workflow_nodemode";
                    if(showisform==1){
                        modetable="workflow_formmode";
                    }
                }else{
                    modeids=printmodeid;
                    modename=printmodename;
                    updatestr="printdes";
                    modetable="workflow_nodemode";
                    if(printisform==1){
                        modetable="workflow_formmode";
                    }
                }
                 ArrayList list = null ;
                if(i==0) list = syncnodeids ;
                else list = syncprintnodeids ;
                int _tempnodeid = nodeid ; 
                for(int k = 0 ; k<list.size();k++){
                	nodeid = Util.getIntValue(list.get(k).toString());
					//add by liaodong for qc80560 in 2013-12-11 start
                	   RecordSet.executeSql("select n.nodename, f.nodetype from workflow_nodebase n left join workflow_flownode f on f.nodeid=n.id where n.id="+nodeid);
                	   if(RecordSet.next()){
                		   modename = RecordSet.getString("nodename");
                		   if(i == 0)
                			   modename += SystemEnv.getHtmlLabelName(16450,user.getLanguage());
                		   else if(i == 1)
                			   modename += SystemEnv.getHtmlLabelNames("257,64",user.getLanguage());
                	   }
                	//end
                RecordSet.executeSql("select id from workflow_nodemode where workflowid="+wfid+" and nodeid="+nodeid+" and isprint='"+i+"'");
                //\u5df2\u7ecf\u6709\u6a21\u677f



                if(RecordSet.next()){
                    int modeid=RecordSet.getInt("id");
                    //\u66f4\u65b0\u6a21\u677f
                    if(modeids>0){
                        if(modetable.equals("workflow_nodemode")){
                            if(i==0){
                                sqlstr="select formid,nodeid from "+modetable+" where id="+modeids;
                                RecordSet.executeSql(sqlstr);
                                if(RecordSet.next()){
                                    int tempformid=RecordSet.getInt("formid");
                                    int tempnodeid=RecordSet.getInt("nodeid");
                                    if(formid!=tempformid || tempnodeid!=nodeid){
                                        RecordSet.executeSql("delete from workflow_modeview where formid="+formid+" and nodeid="+nodeid+" and isbill="+isbill);
                                        RecordSet.executeSql("select fieldid,isview,isedit,ismandatory from workflow_modeview where formid="+tempformid+" and nodeid="+tempnodeid+" and isbill="+isbill);
                                        while(RecordSet.next()){
                                            rs.executeSql("insert into workflow_modeview(formid,nodeid,isbill,fieldid,isview,isedit,ismandatory) values("+formid+","+nodeid+","+isbill+","+RecordSet.getInt("fieldid")+",'"+RecordSet.getString("isview")+"','"+RecordSet.getString("isedit")+"','"+RecordSet.getString("ismandatory")+"')");
                                        }
                                    }
                                }
                            }
                            sqlstr="select modedesc from "+modetable+" where id="+modeids;
                            statement.setStatementSql(sqlstr);
                            statement.executeQuery();
                            if (statement.next()) {
                                if(isoracle){
                                    CLOB theclob = statement.getClob(1);
                                    String readline = "" ;
                                    StringBuffer clobStrBuff = new StringBuffer("") ;
                                    BufferedReader clobin = new BufferedReader(theclob.getCharacterStream());
                                    while ((readline = clobin.readLine()) != null) clobStrBuff = clobStrBuff.append(readline) ;
                                    clobin.close() ;
                                    modestr=clobStrBuff.toString();
                                }else{
                                modestr = statement.getString("modedesc");
                                }
                            }
                            if(isoracle){
                                sqlstr="update workflow_nodemode set modename=? where id="+modeid;
                                statement.setStatementSql(sqlstr);
                                statement.setString(1 , modename);
                                statement.executeUpdate();

                                sqlstr = "select modedesc from workflow_nodemode where id = "+modeid;
                                statement.setStatementSql(sqlstr, false);
                                statement.executeQuery();
                                if(statement.next()){
                                    CLOB theclob = statement.getClob(1);
                                    char[] contentchar = modestr.toCharArray();
                                    Writer contentwrite = theclob.getCharacterOutputStream();
                                    contentwrite.write(contentchar);
                                    contentwrite.flush();
                                    contentwrite.close();
                                    //statement.close();
                                }
                            }else{
                                sqlstr="update workflow_nodemode set modedesc=?,modename=? where id="+modeid;
                                statement.setStatementSql(sqlstr);
                                statement.setString(1 , modestr);
                                statement.setString(2 , modename);
                                statement.executeUpdate();
                            }
                        }else{
                            if(i==0){
                                RecordSet.executeSql("delete from workflow_modeview where formid="+formid+" and nodeid="+nodeid+" and isbill="+isbill);
                                RecordSet.executeSql("select fieldid,isview,isedit,ismandatory from workflow_modeview where formid="+formid+" and nodeid=0 and isbill="+isbill);
                                while(RecordSet.next()){
                                   rs.executeSql("insert into workflow_modeview(formid,nodeid,isbill,fieldid,isview,isedit,ismandatory) values("+formid+","+nodeid+","+isbill+","+RecordSet.getInt("fieldid")+",'"+RecordSet.getString("isview")+"','"+RecordSet.getString("isedit")+"','"+RecordSet.getString("ismandatory")+"')");
                                }
                            }
                            RecordSet.executeSql("delete from workflow_nodemode where workflowid="+wfid+" and nodeid="+nodeid+" and isprint='"+i+"'");
                        }
                    }else{
                        //\u5220\u9664\u6a21\u677f
                        //RecordSet.executeSql("delete from workflow_modeview where formid="+formid+" and nodeid="+nodeid+" and isbill="+isbill);
                        RecordSet.executeSql("delete from workflow_nodemode where workflowid="+wfid+" and nodeid="+nodeid+" and isprint='"+i+"'");
						//(TD23195)\u662f\u5426\u8fd8\u6709\u5176\u4ed6\u6a21\u677f\u4f7f\u7528
                        RecordSet.executeSql("select id from workflow_nodemode where formid="+formid+" and nodeid="+nodeid+" and isprint!='"+i+"'");
                        if(RecordSet.getCounts() <= 0) {
                        	RecordSet.executeSql("delete from workflow_modeview where formid="+formid+" and nodeid="+nodeid+" and isbill="+isbill);
                        }
                        RecordSet.executeSql("update workflow_flownode set "+updatestr+"='1' where workflowid="+wfid+" and nodeid="+nodeid);
                    }
                }else{
                    //\u6ca1\u6709\u6a21\u677f
                    //\u63d2\u5165\u6a21\u677f
                    if(i==0) RecordSet.executeSql("delete from workflow_modeview where formid="+formid+" and nodeid="+nodeid+" and isbill="+isbill);
                    if(modeids>0){
                        if(modetable.equals("workflow_nodemode")){
                            if(i==0){
                                sqlstr="select formid,nodeid from "+modetable+" where id="+modeids;
                                RecordSet.executeSql(sqlstr);
                                if(RecordSet.next()){
                                    int tempformid=RecordSet.getInt("formid");
                                    int tempnodeid=RecordSet.getInt("nodeid");
                                    RecordSet.executeSql("select fieldid,isview,isedit,ismandatory from workflow_modeview where formid="+tempformid+" and nodeid="+tempnodeid+" and isbill="+isbill);
                                    while(RecordSet.next()){
                                        rs.executeSql("insert into workflow_modeview(formid,nodeid,isbill,fieldid,isview,isedit,ismandatory) values("+formid+","+nodeid+","+isbill+","+RecordSet.getInt("fieldid")+",'"+RecordSet.getString("isview")+"','"+RecordSet.getString("isedit")+"','"+RecordSet.getString("ismandatory")+"')");
                                    }
                                }
                            }
                            sqlstr="select modedesc from "+modetable+" where id="+modeids;
                            statement.setStatementSql(sqlstr);
                            statement.executeQuery();
                            if (statement.next()) {
                                if(isoracle){
                                    CLOB theclob = statement.getClob(1);
                                    String readline = "" ;
                                    StringBuffer clobStrBuff = new StringBuffer("") ;
                                    BufferedReader clobin = new BufferedReader(theclob.getCharacterStream());
                                    while ((readline = clobin.readLine()) != null) clobStrBuff = clobStrBuff.append(readline) ;
                                    clobin.close() ;
                                    modestr=clobStrBuff.toString();
                                }else{
                                    modestr = statement.getString("modedesc");
                                }
                            }
                            if(isoracle){
                                sqlstr="insert into workflow_nodemode(formid,nodeid,isprint,modedesc,workflowid,modename) values(?,?,?,empty_clob(),?,?)";
                                statement.setStatementSql(sqlstr);
                                statement.setInt(1 ,formid);
                                statement.setInt(2 ,nodeid);
                                statement.setString(3 ,""+i);
                                statement.setInt(4 ,wfid);
                                statement.setString(5 ,modename);
                                statement.executeUpdate();

                                sqlstr = "select modedesc from workflow_nodemode where formid = "+formid+" and nodeid="+nodeid+" and isprint='"+i+"' and workflowid="+wfid+" order by id desc";
                                statement.setStatementSql(sqlstr, false);
                                statement.executeQuery();
                                if(statement.next()){
                                    CLOB theclob = statement.getClob(1);
                                    char[] contentchar = modestr.toCharArray();
                                    Writer contentwrite = theclob.getCharacterOutputStream();
                                    contentwrite.write(contentchar);
                                    contentwrite.flush();
                                    contentwrite.close();
                                    //statement.close();
                                }
                            }else{
                                sqlstr="insert into workflow_nodemode(formid,nodeid,isprint,modedesc,workflowid,modename) values(?,?,?,?,?,?)";
                                statement.setStatementSql(sqlstr);
                                statement.setInt(1 ,formid);
                                statement.setInt(2 ,nodeid);
                                statement.setString(3 ,""+i);
                                statement.setString(4 , modestr);
                                statement.setInt(5 ,wfid);
                                statement.setString(6 ,modename);
                                statement.executeUpdate();
                            }
                        }else{
                            if(i==0){
                                RecordSet.executeSql("select fieldid,isview,isedit,ismandatory from workflow_modeview where formid="+formid+" and nodeid=0 and isbill="+isbill);
                                while(RecordSet.next()){
                                   rs.executeSql("insert into workflow_modeview(formid,nodeid,isbill,fieldid,isview,isedit,ismandatory) values("+formid+","+nodeid+","+isbill+","+RecordSet.getInt("fieldid")+",'"+RecordSet.getString("isview")+"','"+RecordSet.getString("isedit")+"','"+RecordSet.getString("ismandatory")+"')");
                                }
                            }
                        }
                        RecordSet.executeSql("update workflow_flownode set "+updatestr+"='0' where workflowid="+wfid+" and nodeid="+nodeid);
                        
                    }else{
                        RecordSet.executeSql("update workflow_flownode set "+updatestr+"='1' where workflowid="+wfid+" and nodeid="+nodeid);
                    }
                }
                if(i==0){
                    RecordSet.executeSql("update workflow_flownode set ismode='"+modetype+"' where workflowid="+wfid+" and nodeid="+nodeid);
                }
            }
           } 
        
	        String noderemarksync = Util.null2String(request.getParameter("noderemarksync"));
	    	String nodeid_new = "";
	    	if("".equals(noderemarksync))
	    		nodeid_new = nodeid + "";
	    	else
	    		nodeid_new = nodeid + "," + noderemarksync;
    	
	        String mysql="update workflow_flownode set viewtypeall='"+viewtypeall+"',viewdescall='"+viewdescall+"',showtype='"+showtype+"',vtapprove='"+vtapprove+"',vtforward='"+vtforward+"',vtTakingOpinions='"+vtTakingOpinions+"',vtHandleForward='"+vtHandleForward+"',vttpostil='"+vttpostil+"',vtrpostil='"+vtrpostil+
	        "',vtover='"+vtover+"',vtintervenor='"+vtintervenor+"',vtpostil='"+vtpostil+"',vtrealize='"+vtrealize+"',vtrecipient='"+vtrecipient+"',vtreject='"+vtreject+"',vtsuperintend='"+vtsuperintend+
	        "',vdcomments='"+vdcomments+"',vddate='"+vddate+"',vddeptname='"+vddeptname+"',vdoperator='"+vdoperator+"',vdtime='"+vdtime+"',stnull='"+stnull+"',toexcel='"+toexcel+
	        "',vsignupload='"+vsignupload+"',vmobilesource='"+vmobilesource+"',vsigndoc='"+vsigndoc+"',vsignworkflow='"+vsignworkflow+"' where workflowid="+wfid+" and nodeid in ("+nodeid_new+")";
	        RecordSet.executeSql(mysql);
                    
            if(isbill.equals("0")){
		  	  	FormFieldMainManager.setFormid(formid);
		  		FormFieldMainManager.selectAllFormField();
		        int groupid=-1;
		  		while(FormFieldMainManager.next()){
		  			int curid=FormFieldMainManager.getFieldid();
		            int curgroupid=FormFieldMainManager.getGroupid();
		            if(curgroupid==-1) curgroupid=999;
		            String isdetail = FormFieldMainManager.getIsdetail();
		  			WFNodeFieldMainManager.resetParameter();
		  			WFNodeFieldMainManager.setNodeid(nodeid);
		  			WFNodeFieldMainManager.setFieldid(curid);
		            if(isdetail.equals("1") && curgroupid>groupid) {
		                  groupid=curgroupid;
		                  int dt1defaultrows = Util.getIntValue(request.getParameter("dtl_defrow_"+curgroupid),0);
		                  dt1defaultrows = dt1defaultrows<=0?1:dt1defaultrows;
			              WFNodeDtlFieldManager.resetParameter();
		                  WFNodeDtlFieldManager.setNodeid(nodeid);
		                  WFNodeDtlFieldManager.setGroupid(curgroupid);
		                  WFNodeDtlFieldManager.setDefaultrows(dt1defaultrows);
		                  WFNodeDtlFieldManager.saveWfNodeDtlField_defaultRow();
		             }
		  		}
		  	}else if(isbill.equals("1")){
		  		boolean isNewForm = false;//\u662f\u5426\u662f\u65b0\u8868\u5355 modify by myq for TD8730 on 2008.9.12
		  		RecordSet.executeSql("select tablename from workflow_bill where id = "+formid);
		  		if(RecordSet.next()){
		  			String temptablename = Util.null2String(RecordSet.getString("tablename"));
		  			if(temptablename.equals("formtable_main_"+formid*(-1)) || temptablename.startsWith("uf_")) isNewForm = true;
		  		}
		  		String sql = "select * from workflow_billfield where billid = "+formid+"  order by viewtype,detailtable,dsporder";
		  		if(isNewForm == true){
		  			if("ORACLE".equalsIgnoreCase(RecordSet.getDBType())){
		  				sql = "select * from workflow_billfield where billid = "+formid +" order by viewtype,TO_NUMBER((select orderid from Workflow_billdetailtable bd where bd.billid = billid and bd.tablename = detailtable)),dsporder ";
		  			}else{
		  				sql = "select * from workflow_billfield where billid = "+formid +" order by viewtype,convert(int, (select orderid from Workflow_billdetailtable bd where bd.billid = billid and bd.tablename = detailtable)),dsporder ";
		  			}
		  		}else{
		  			sql = "select * from workflow_billfield where billid = "+formid +" order by viewtype,detailtable,dsporder ";
		  		}
	  		
		  		RecordSet.executeSql(sql);
		        int curgroupid=0;
		        String predetailtable=null;
		        while(RecordSet.next()){
	  				int curid=RecordSet.getInt("id");
	              	int viewtype=RecordSet.getInt("viewtype");
	              	String detailtable = Util.null2String(RecordSet.getString("detailtable"));
	              	WFNodeFieldMainManager.resetParameter();
	  				WFNodeFieldMainManager.setNodeid(nodeid);
	  				WFNodeFieldMainManager.setFieldid(curid);
	              	if(viewtype==1 && !detailtable.equals(predetailtable)){
	                  	predetailtable=detailtable;
	                  	curgroupid++;
	              	}
	  			}   
	  		  
	          for(int i=0;i<curgroupid;i++){
                  int dt1defaultrows = Util.getIntValue(request.getParameter("dtl_defrow_"+i),0);
                  dt1defaultrows = dt1defaultrows<=0?1:dt1defaultrows;                  
                  WFNodeDtlFieldManager.resetParameter();
                  WFNodeDtlFieldManager.setNodeid(nodeid);
                  WFNodeDtlFieldManager.setGroupid(i);	                  
                  WFNodeDtlFieldManager.setDefaultrows(dt1defaultrows);
                  WFNodeDtlFieldManager.saveWfNodeDtlField_defaultRow();
	          }
	      }
        }catch(Exception e){
            e.printStackTrace();
        }finally{
            statement.close();
        }
    }else if(modetype.equals("2")){ //Html\u7f16\u8f91\u6a21\u5f0f
    	//\u4fdd\u5b58Html\u6a21\u677f\u4fe1\u606f\uff0c\u5f53\u524d\u8282\u70b9\u53ca\u9700\u8981\u540c\u6b65\u7684\u8282\u70b9\u6a21\u677f
    	htmlLayoutOperate.setRequest(request);
    	htmlLayoutOperate.setUser(user);
    	htmlLayoutOperate.saveLayout_all();
        
    	//\u4fdd\u5b58\u8f6cPDF\u6253\u5370\u3001\u6253\u5370\u6d41\u8f6c\u610f\u89c1\u9009\u9879
    	String printsyncNodes = Util.null2String(request.getParameter("printsyncNodes"));
        printsyncNodes = "".equals(printsyncNodes) ? (""+nodeid) : (printsyncNodes+","+nodeid);
        String pdfprint = "on".equals(Util.null2String(request.getParameter("pdfprint"))) ? "1" : "0";
      	//\u89e3\u51b3\u9ed8\u8ba4\u72b6\u6001\u4e3a\u9009\u62e9\uff0c\u800c\u9ed8\u8ba4\u72b6\u6001 \u6570\u636e\u5e93\u5b57\u6bb5printflowcomment \u4e3anull \u8bfb\u51fa\u4ee5\u540e\u4e3a0\uff0c\u65450 \u4e3a\u9009\u62e9
        int printflowcomment=Util.getIntValue(Util.null2String(request.getParameter("printflowcomment")),1);
    	String syncsql = "update workflow_flownode set pdfprint='"+pdfprint+"',printflowcomment='"+printflowcomment+"' where workflowid="+wfid;
    	syncsql += " and nodeid in ("+printsyncNodes+")";
    	RecordSet.executeSql(syncsql);
    	
    	//\u589e\u52a0html\u6a21\u5f0f \u663e\u793a\u5185\u5bb9\u4fdd\u5b58 Start
        int showtype=Util.getIntValue(Util.null2String(request.getParameter("showtype2")),0);
        int vtapprove=0;
        int vtrealize=0;
        int vtforward=0;
		int vtpostil=0;
		int vtHandleForward = 0;
		int vtTakingOpinions = 0;
		int vttpostil=0;   
        int vtrecipient=0;
		int vtrpostil=0; 
        int vtreject=0;
        int vtsuperintend=0;
        int vtover=0;
        int vtintervenor=0;
        //\u5904\u7406\u610f\u89c1,\u5982\u679c\u4e3a\u7a7a\u5148\u9ed8\u8ba4\u7f6e\u4e3a1,\u8bbe\u7f6e\u8868\u5355\u4e2d\u6ca1\u6709\u8fd9\u4e2a\u5b57\u6bb5\uff0c\u4f46\u662f\u7b7e\u5b57\u610f\u89c1\u52a0\u5165\u8868\u5355\u4e2d\u53d6\u610f\u89c1\u9700\u8981\u7528
        int vdcomments=0;
        int vddeptname=0;
        int vdoperator=0;
        int vddate=0;
        int vdtime=0;
        int stnull=Util.getIntValue(Util.null2String(request.getParameter("showtype_null2")),0);

        int vsignupload=0;
        int vsigndoc=0;
        int vsignworkflow=0;
		int vmobilesource=0;
        int toexcel=0;
        String viewtypeall=Util.null2String(request.getParameter("viewtype_all2"));
        String viewdescall=Util.null2String(request.getParameter("viewdesc_all2"));
        if(viewtypeall.indexOf("viewtype_all")!=-1||viewtypeall.equals("1")){
        	viewtypeall = "1";
        }else{
        	if(viewtypeall.indexOf("viewtype_approve")!=-1)
        		vtapprove=1;
        	if(viewtypeall.indexOf("viewtype_realize")!=-1)
        		vtrealize=1;
        	if(viewtypeall.indexOf("viewtype_forward")!=-1)
        		vtforward=1;
        	if(viewtypeall.indexOf("viewtype_postil")!=-1)
        		vtpostil=1;
			if(viewtypeall.indexOf("view_handleForward")!=-1)
        		vtHandleForward=1;
			if(viewtypeall.indexOf("view_takingOpinions")!=-1)
        		vtTakingOpinions=1;
			if(viewtypeall.indexOf("viewtype_tpostil")!=-1)
        		vttpostil=1;
			if(viewtypeall.indexOf("viewtype_recipient")!=-1)
        		vtrecipient=1;
        	if(viewtypeall.indexOf("viewtype_rpostil")!=-1)
        		vtrpostil=1;
        	if(viewtypeall.indexOf("viewtype_reject")!=-1)
        		vtreject=1;
        	if(viewtypeall.indexOf("viewtype_superintend")!=-1)
        		vtsuperintend=1;
        	if(viewtypeall.indexOf("viewtype_over")!=-1)
        		vtover=1;
        	if(viewtypeall.indexOf("viewtype_intervenor")!=-1)
        		vtintervenor=1;
        	viewtypeall = "0";
        }
        if(viewdescall.indexOf("viewdesc_all")!=-1||viewdescall.equals("1")){
        	viewdescall = "1";
			vdcomments=1;
			vddeptname=1;
			vdoperator=1;
			vddate=1;
			vdtime=1;
			vsignupload=1;
			vsigndoc=1;
			vsignworkflow=1;
			vmobilesource=1;
        }else{
        	if(viewdescall.indexOf("viewdesc_comments")!=-1)
        		vdcomments=1;
        	if(viewdescall.indexOf("viewdesc_deptname")!=-1)
        		vddeptname=1;
        	if(viewdescall.indexOf("viewdesc_operator")!=-1)
        		vdoperator=1;
        	if(viewdescall.indexOf("viewdesc_date")!=-1)
        		vddate=1;
        	if(viewdescall.indexOf("viewdesc_time")!=-1)
        		vdtime=1;
        	if(viewdescall.indexOf("viewdesc_signupload")!=-1)
        		vsignupload=1;
        	if(viewdescall.indexOf("viewdesc_signdoc")!=-1)
        		vsigndoc=1;
        	if(viewdescall.indexOf("viewdesc_signworkflow")!=-1)
        		vsignworkflow=1;
			if(viewdescall.indexOf("viewdesc_mobilesource")!=-1)
        		vmobilesource=1;

        	viewdescall = "0";
        }
        String noderemarksync = Util.null2String(request.getParameter("noderemarksync2"));
    	String nodeid_new = "";
    	if("".equals(noderemarksync))
    		nodeid_new = nodeid + "";
    	else
    		nodeid_new = nodeid + "," + noderemarksync;
    	
        String mysql="update workflow_flownode set viewtypeall='"+viewtypeall+"',viewdescall='"+viewdescall+"',showtype='"+showtype+"',vtapprove='"+vtapprove+"',vtforward='"+vtforward+"',vtTakingOpinions='"+vtTakingOpinions+"',vtHandleForward='"+vtHandleForward+"',vttpostil='"+vttpostil+"',vtrpostil='"+vtrpostil+"',vtover='"+vtover+"',vtintervenor='"+vtintervenor+"',vtpostil='"+vtpostil+"',vtrealize='"+vtrealize+"',vtrecipient='"+vtrecipient+"',vtreject='"+vtreject+"',vtsuperintend='"+vtsuperintend+
            "',vdcomments='"+vdcomments+"',vddate='"+vddate+"',vddeptname='"+vddeptname+"',vdoperator='"+vdoperator+"',vdtime='"+vdtime+"',stnull='"+stnull+"',vsignupload='"+vsignupload+"',vmobilesource='"+vmobilesource+"',vsigndoc='"+vsigndoc+"',vsignworkflow='"+vsignworkflow+"' where workflowid="+wfid+" and nodeid in ("+nodeid_new+")";
        boolean b= RecordSet.executeSql(mysql);
    	//\u589e\u52a0html\u6a21\u5f0f \u663e\u793a\u5185\u5bb9\u4fdd\u5b58 End
    }
    RecordSet.executeSql("update workflow_flownode set ismode='"+modetype+"' where workflowid="+wfid+" and nodeid="+nodeid);
	response.sendRedirect("addwfnodefield.jsp?ajax="+ajax+"&design="+design+"&wfid="+wfid+"&nodeid="+nodeid);
    return;
  }
   else if(src.equalsIgnoreCase("wfnodeportal")){
  	int wfid=Util.getIntValue(Util.null2String(request.getParameter("wfid")),0);

  	String delids = Util.null2String(request.getParameter("delids"));

  	if(!delids.equals("")){
  		delids = delids.substring(1);
	  	String del_ids[] =Util.TokenizerString2(delids,",");
	  	for(int i=0;i<del_ids.length;i++){
	  		WFNodePortalMainManager.resetParameter();
        WFNodePortalMainManager.setId(Util.getIntValue(del_ids[i],0));
        WFNodePortalMainManager.deleteWfNodePortal();
        //add by xhheng @ 2004/12/08 for TDID 1317 start
        //\u5220\u9664\u51fa\u53e3\u65e5\u5fd7
        SysMaintenanceLog.resetParameter();
        SysMaintenanceLog.setRelatedId(wfid);
        SysMaintenanceLog.setRelatedName(SystemEnv.getHtmlLabelName(15611,user.getLanguage()));
        SysMaintenanceLog.setOperateType("3");
        SysMaintenanceLog.setOperateDesc("WrokFlowNodePortal_delete");
        SysMaintenanceLog.setOperateItem("88");
        SysMaintenanceLog.setOperateUserid(user.getUID());
        SysMaintenanceLog.setClientAddress(request.getRemoteAddr());
        SysMaintenanceLog.setSysLogInfo();
        //add by xhheng @ 2004/12/08 for TDID 1317 end
 	 	  }
	  }

  	int rowsum = Util.getIntValue(Util.null2String(request.getParameter("nodessum")));
        		
  	String postValue = Util.null2String(request.getParameter("portValueStr"));
  	String[] members = Util.TokenizerString2(postValue,"\u001b");
	for(int i=0;i<members.length;i++) {
		String linkvalue = members[i];
  		WFNodePortalMainManager.resetParameter();
  		WFNodePortalMainManager.setWfid(wfid);

  		int id = Util.getIntValue(Util.null2String(request.getParameter("por"+linkvalue+"_id")),0);

      WFNodePortalMainManager.setNodeid(Util.getIntValue(Util.null2String(request.getParameter("por"+linkvalue+"_nodeid")),0));
      WFNodePortalMainManager.setIsreject(Util.null2String(request.getParameter("por"+linkvalue+"_rej")));
      WFNodePortalMainManager.setLinkorder(Util.getIntValue(Util.null2String(request.getParameter("por_order_" + linkvalue)), -1));

      WFNodePortalMainManager.setLinkname(Util.null2String(request.getParameter("por"+linkvalue+"_link")));
      //WFNodePortalMainManager.setCondition(Util.null2String(request.getParameter("por"+i+"_con")));
      //add by xhheng @20050205 for TD 1537
      //WFNodePortalMainManager.setConditioncn(Util.null2String(request.getParameter("por"+i+"_con_cn")));
      WFNodePortalMainManager.setDestnodeid(Util.getIntValue(request.getParameter("por"+linkvalue+"_des")));
      WFNodePortalMainManager.setPasstime(Util.getFloatValue((String)request.getSession(true).getAttribute("por"+linkvalue+"_passtime"),-1));
      WFNodePortalMainManager.setIsBulidCode(Util.null2String(request.getParameter("por"+linkvalue+"_isBulidCode")));
      WFNodePortalMainManager.setIsMustPass(Util.null2String(request.getParameter("por"+linkvalue+"_ismustpass")));
      WFNodePortalMainManager.setTipsinfo(Util.null2String(request.getParameter("por"+linkvalue+"_tipsinfo")));    
      //modify by xhheng @ 2004/12/08 for TDID 1317 start
      SysMaintenanceLog.resetParameter();
      SysMaintenanceLog.setRelatedId(wfid);
      SysMaintenanceLog.setRelatedName(Util.null2String(request.getParameter("por"+linkvalue+"_link")));
      SysMaintenanceLog.setOperateItem("88");
      SysMaintenanceLog.setOperateUserid(user.getUID());
      SysMaintenanceLog.setClientAddress(request.getRemoteAddr());
      if(Util.getIntValue(request.getParameter("por"+linkvalue+"_des"))!=-1 && id ==0){
        WFNodePortalMainManager.saveWfNodePortal();
        //\u65b0\u589e\u51fa\u53e3\u65e5\u5fd7
        SysMaintenanceLog.setOperateType("1");
        SysMaintenanceLog.setOperateDesc("WrokFlowNodePortal_insert");
        SysMaintenanceLog.setSysLogInfo();
      }
      if(Util.getIntValue(request.getParameter("por"+linkvalue+"_des"))!=-1 && id !=0){
        WFNodePortalMainManager.setId(id);
        WFNodePortalMainManager.updateWfNodePortal();
        //\u4fee\u6539\u51fa\u53e3\u65e5\u5fd7
        SysMaintenanceLog.setOperateType("2");
        SysMaintenanceLog.setOperateDesc("WrokFlowNodePortal_update");
        SysMaintenanceLog.setSysLogInfo();
      }
      //modify by xhheng @ 2004/12/08 for TDID 1317 end
	}
	/////////
	if(!delids.equals("") || rowsum > 0){
		WorkflowInitialization wfinza = new WorkflowInitialization();
		wfinza.recordInformation(wfid);
	}
	/////////
	
      if(!ajax.equals("1"))
    response.sendRedirect("addwf.jsp?src=editwf&wfid="+wfid);
      else
   response.sendRedirect("addwfnodeportal.jsp?ajax=1&wfid="+wfid);   
    return;

  }
 /* else if(src.equalsIgnoreCase("formfieldlabel")){
  	int formid=Util.getIntValue(Util.null2String(request.getParameter("formid")),0);
  	ArrayList fields = new ArrayList();
  	ArrayList idarray = new ArrayList();

	FormFieldlabelMainManager.resetParameter();
	FormFieldlabelMainManager.setFormid(formid);
	FormFieldlabelMainManager.deleteFormfield();
	String ids=Util.null2String(request.getParameter("formfieldlabels"));
	int defaultlang=Util.getIntValue(Util.null2String(request.getParameter("isdefault")));
	idarray = Util.TokenizerString(ids,",");

	FormFieldMainManager.setFormid(formid);
	FormFieldMainManager.selectFormField();
	while(FormFieldMainManager.next()){
		int curid=FormFieldMainManager.getFieldid();
		fields.add(""+curid);
	}
	for(int i=0;i<idarray.size();i++) {
		int languageid = Util.getIntValue((String)idarray.get(i),0);
		String isdef = "0";
		if( languageid < 1)
			break;
		if(languageid == defaultlang)
			isdef = "1";
		for(int j=0; j< fields.size();j++) {
			String tfieldid=(String)fields.get(j);
			int fieldid = Util.getIntValue(tfieldid,0);
			FormFieldlabelMainManager.resetParameter();
			FormFieldlabelMainManager.setFormid(formid);
			FormFieldlabelMainManager.setFieldid(fieldid);
			FormFieldlabelMainManager.setLanguageid(languageid);
			String label = Util.null2String(request.getParameter("label_"+languageid+"_"+fieldid));
			if(label.equals(""))
				break;
			FormFieldlabelMainManager.setFieldlabel(label);
			FormFieldlabelMainManager.setIsdefault(isdef);
			FormFieldlabelMainManager.saveFormfieldlabel();
		}
	}

	response.sendRedirect("manageform.jsp");
	return;
  }
*/

    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("workflow/workflow/wf_operation.jsp"), -2702868595536493133L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
    depend = new com.caucho.vfs.Depend(appDir.lookup("systeminfo/init_wev8.jsp"), 2425449460466103212L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
    depend = new com.caucho.vfs.Depend(appDir.lookup("wui/common/page/initWui.jsp"), 3390533274175540290L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string20;
  private final static char []_jsp_string21;
  private final static char []_jsp_string63;
  private final static char []_jsp_string8;
  private final static char []_jsp_string66;
  private final static char []_jsp_string32;
  private final static char []_jsp_string48;
  private final static char []_jsp_string38;
  private final static char []_jsp_string43;
  private final static char []_jsp_string54;
  private final static char []_jsp_string19;
  private final static char []_jsp_string16;
  private final static char []_jsp_string18;
  private final static char []_jsp_string12;
  private final static char []_jsp_string56;
  private final static char []_jsp_string17;
  private final static char []_jsp_string61;
  private final static char []_jsp_string44;
  private final static char []_jsp_string6;
  private final static char []_jsp_string46;
  private final static char []_jsp_string5;
  private final static char []_jsp_string51;
  private final static char []_jsp_string14;
  private final static char []_jsp_string27;
  private final static char []_jsp_string57;
  private final static char []_jsp_string64;
  private final static char []_jsp_string34;
  private final static char []_jsp_string11;
  private final static char []_jsp_string25;
  private final static char []_jsp_string9;
  private final static char []_jsp_string42;
  private final static char []_jsp_string7;
  private final static char []_jsp_string33;
  private final static char []_jsp_string45;
  private final static char []_jsp_string30;
  private final static char []_jsp_string3;
  private final static char []_jsp_string31;
  private final static char []_jsp_string36;
  private final static char []_jsp_string26;
  private final static char []_jsp_string52;
  private final static char []_jsp_string47;
  private final static char []_jsp_string55;
  private final static char []_jsp_string37;
  private final static char []_jsp_string15;
  private final static char []_jsp_string62;
  private final static char []_jsp_string41;
  private final static char []_jsp_string1;
  private final static char []_jsp_string13;
  private final static char []_jsp_string0;
  private final static char []_jsp_string35;
  private final static char []_jsp_string4;
  private final static char []_jsp_string50;
  private final static char []_jsp_string23;
  private final static char []_jsp_string65;
  private final static char []_jsp_string53;
  private final static char []_jsp_string10;
  private final static char []_jsp_string49;
  private final static char []_jsp_string40;
  private final static char []_jsp_string22;
  private final static char []_jsp_string29;
  private final static char []_jsp_string58;
  private final static char []_jsp_string60;
  private final static char []_jsp_string59;
  private final static char []_jsp_string28;
  private final static char []_jsp_string24;
  private final static char []_jsp_string39;
  private final static char []_jsp_string2;
  static {
    _jsp_string20 = "&f_weaver_belongto_usertype=".toCharArray();
    _jsp_string21 = "\";\r\n	    xmlhttp.open(\"GET\",URL, false);\r\n	    xmlhttp.send(null);\r\n	    var result = xmlhttp.status;\r\n	    if(result==200) {\r\n		    isconn = true;\r\n	    	var response_flag = xmlhttp.responseText;\r\n	    	if(response_flag!='0') {\r\n	    		var flag_msg = '';\r\n	    		if(response_flag=='1') {\r\n	    			var diag = new Dialog();\r\n					diag.Width = 300;\r\n					diag.Height = 180;\r\n					diag.ShowCloseButton=false;\r\n					diag.Title = \"".toCharArray();
    _jsp_string63 = "\";\r\n//\u5f53\u524d\u4e3b\u9898\u4f7f\u7528\u7684\u76ae\u80a4\r\nvar GLOBAL_SKINS_FOLDER = \"".toCharArray();
    _jsp_string8 = "\r\n<script type=\"text/javascript\" src=\"/js/select/script/jquery-1.8.3.min_wev8.js\"></script>	    \r\n".toCharArray();
    _jsp_string66 = "\r\n<!--add by xhheng @ 2004/12/08 for TDID 1317-->\r\n".toCharArray();
    _jsp_string32 = "\", function () {\r\n						    formElementFocus(tempElement);						\r\n							});\r\n						}\r\n						return false;\r\n					}else{\r\n						if(window.__oriAlert__){\r\n							try{\r\n								window.top.Dialog.alert(\"".toCharArray();
    _jsp_string48 = "\";\r\ndoCheckusb();\r\n</script>\r\n".toCharArray();
    _jsp_string38 = "\");\r\n						}else{\r\n							window.top.Dialog.alert(\"".toCharArray();
    _jsp_string43 = "\";\r\n\r\n  if(companyname.length >0 ){\r\n  	window.status = str1+companyname;\r\n  }\r\n</script>\r\n<!-- \u5220\u9664 -->\r\n</head></html>\r\n\r\n<!--USB \u9a8c\u8bc1 -->\r\n".toCharArray();
    _jsp_string54 = "\r\n<!--For wui-->\r\n<link type='text/css' rel='stylesheet'  href='/wui/theme/".toCharArray();
    _jsp_string19 = "&time=\"+new Date()+\"&f_weaver_belongto_userid=".toCharArray();
    _jsp_string16 = "');\r\n}\r\n\r\nfunction _onViewLog(operateitem,sqlwhere,id){\r\n	if(!sqlwhere)sqlwhere = \"\";\r\n	var dialog = new window.top.Dialog();\r\n	dialog.currentWindow = window;\r\n	dialog.Title = \"".toCharArray();
    _jsp_string18 = "\";\r\n		}\r\n	}\r\n	dialog.Width = jQuery(window).width();\r\n	dialog.Height = 610;\r\n	dialog.Drag = true;\r\n	dialog.checkDataChange = false;\r\n	dialog.maxiumnable = true;\r\n	dialog.URL = url;\r\n	dialog.show();\r\n}\r\n\r\n\r\nfunction check_form(thiswins,items)\r\n{\r\n	/* added by cyril on 2008-08-14 for td:8521 */\r\n	var isconn = false;\r\n	try {\r\n		var xmlhttp;\r\n	    if (window.XMLHttpRequest) {\r\n	    	xmlhttp = new XMLHttpRequest();\r\n	    }  \r\n	    else if (window.ActiveXObject) {\r\n	    	xmlhttp = new ActiveXObject(\"Microsoft.XMLHTTP\");  \r\n	    }\r\n	    var URL = \"/systeminfo/CheckConn.jsp?userid=".toCharArray();
    _jsp_string12 = "\r\n<!-- js \u6574\u5408\u5230 init_wev8.js -->\r\n<script type=\"text/javascript\" src=\"/js/jquery.table_wev8.js\"></script>\r\n<script language=\"javascript\" type=\"text/javascript\" src=\"/js/init_wev8.js\"></script>\r\n<script language=\"javascript\"  src=\"/js/wbusb_wev8.js\"></script>\r\n<script type=\"text/javascript\" src=\"/js/jquery/plugins/client/jquery.client_wev8.js\"></script>\r\n<script type=\"text/javascript\" src=\"/js/ecology8/jNice/jNice/jquery.jNice_wev8.js\"></script>\r\n<script type='text/javascript' src='/js/jquery-autocomplete/jquery.autocomplete_wev8.js'></script>\r\n<script type='text/javascript' src='/js/jquery-autocomplete/browser_wev8.js'></script>\r\n<script language=javascript src=\"/wui/theme/ecology8/jquery/js/zDialog_wev8.js\"></script>\r\n<script type=\"text/javascript\" src=\"/js/ecology8/request/hoverBtn_wev8.js\"></script>\r\n<script type=\"text/javascript\" src=\"/js/ecology8/lang/weaver_lang_".toCharArray();
    _jsp_string56 = "/wui_wev8.css'/>\r\n".toCharArray();
    _jsp_string17 = "\";\r\n	var url = \"/docs/tabs/DocCommonTab.jsp?_fromURL=3&operateitem=\"+operateitem+\"&sqlwhere=\"+sqlwhere;\r\n	if(id){\r\n		url = \"/docs/tabs/DocCommonTab.jsp?_fromURL=3&relatedid=\"+id+\"&operateitem=\"+operateitem+\"&sqlwhere=\"+sqlwhere;\r\n		if(operateitem==418||operateitem==419||operateitem==420){\r\n			dialog.Title = \"".toCharArray();
    _jsp_string61 = ")\">\r\n".toCharArray();
    _jsp_string44 = "\r\n<script language=javascript>\r\nubsfirmcode0 = ".toCharArray();
    _jsp_string6 = "\r\n\r\n\r\n<script language=javascript>;\r\ntop.Dialog.alert(\"".toCharArray();
    _jsp_string46 = ";\r\nusbserial0 = \"".toCharArray();
    _jsp_string5 = "\";\r\n		});		\r\n	</script>\r\n	".toCharArray();
    _jsp_string51 = "\r\n}\r\n\r\nfunction doScannerEscape(ev, obj){\r\n	IMCarousel.doScannerEscape(ev, obj);\r\n}\r\n\r\nfunction scaleImg(obj, tag){\r\n	IMCarousel.scaleImg(obj, tag);\r\n}\r\n\r\nfunction rotateImg(obj){\r\n	IMCarousel.rotateImg(obj);\r\n}\r\n\r\nfunction downloadImg(obj){\r\n	IMCarousel.downloadImg(obj);\r\n}\r\n\r\nfunction slideImg(obj, direction){\r\n	IMCarousel.slideImg(obj, direction);\r\n}\r\n\r\nfunction showImgScanner(ev, isShow, id){\r\n	IMCarousel.showImgScanner(ev, isShow, id);\r\n}\r\n\r\nfunction downloads(id){\r\n	document.location.href=\"/weaver/weaver.file.FileDownload?fileid=\"+id+\"&download=1\";\r\n}\r\n</script>\r\n".toCharArray();
    _jsp_string14 = "\";\r\nfunction check_conn() {\r\n	return confirm('".toCharArray();
    _jsp_string27 = "\r\n	    try {\r\n		    var lenck = true;\r\n		    var tempfieldvlaue = document.getElementById(\"htmlfieldids\").value;\r\n		    while(true) {\r\n			    var tempfield = tempfieldvlaue.substring(0, tempfieldvlaue.indexOf(\",\"));\r\n			    tempfieldvlaue = tempfieldvlaue.substring(tempfieldvlaue.indexOf(\",\")+1);\r\n			    var fieldid = tempfield.substring(0, tempfield.indexOf(\";\"));\r\n			    var fieldname = tempfield.substring(tempfield.indexOf(\";\")+1);\r\n			    if(fieldname=='') break;\r\n			    if(!checkLengthOnly(fieldid,'4000',fieldname,'".toCharArray();
    _jsp_string57 = "\r\n\r\n\r\n<!-- \u5b57\u4f53\u8bbe\u7f6e\uff0cwin7\u3001vista\u7cfb\u7edf\u4f7f\u7528\u96c5\u9ed1\u5b57\u4f53,\u5176\u4ed6\u7cfb\u7edf\u4f7f\u7528\u5b8b\u4f53 Start -->\r\n<!--\r\n\u6dfb\u52a0\u81f3init_wev8.css \r\n<link type='text/css' rel='stylesheet'  href='/wui/common/css/w7OVFont_wev8.css' id=\"FONT2SYSTEMF\">\r\n -->\r\n<script language=\"javascript\"> \r\n/*\r\nif (jQuery.client.version< 6) {\r\n	document.getElementById('FONT2SYSTEMF').href = \"/wui/common/css/notW7AVFont_wev8.css\";\r\n}\r\n*/\r\n</script> \r\n<!-- \u5b57\u4f53\u8bbe\u7f6e\uff0cwin7\u3001vista\u7cfb\u7edf\u4f7f\u7528\u96c5\u9ed1\u5b57\u4f53,\u5176\u4ed6\u7cfb\u7edf\u4f7f\u7528\u5b8b\u4f53 End -->\r\n\r\n<!-- \u9875\u9762\u5207\u6362\u6548\u679cStart -->\r\n".toCharArray();
    _jsp_string64 = "\";\r\n</script>\r\n\r\n<!--For wuiForm-->\r\n<script type=\"text/javascript\" src=\"/wui/common/jquery/plugin/wuiform/jquery.wuiform_wev8.js\"></script>\r\n<script language=\"javascript\">\r\njQuery(document).ready(function(){\r\n	wuiform.init();\r\n});\r\n</script>\r\n".toCharArray();
    _jsp_string34 = "\");\r\n							}\r\n						}else{\r\n							try{\r\n								window.top.Dialog.alert(\"".toCharArray();
    _jsp_string11 = "\r\n<!-- IE\u4e0b\u4e13\u7528vbs\uff08\u4e34\u65f6\uff09 -->\r\n<script language=\"vbs\" src=\"/js/string2VbArray.vbs\"></script>        \r\n        ".toCharArray();
    _jsp_string25 = "';\r\n	   \r\n	    			return false;\r\n	    		}\r\n	    		flag_msg += '\\r\\n\\r\\n".toCharArray();
    _jsp_string9 = "\r\n<script type=\"text/javascript\" src=\"/wui/common/jquery/jquery.min_wev8.js\"></script>\r\n".toCharArray();
    _jsp_string42 = "\";\r\n  var str1 = \"".toCharArray();
    _jsp_string7 = "\",function(){\r\n	window.top.location=\"/login/Login.jsp\";\r\n});\r\n</script>\r\n".toCharArray();
    _jsp_string33 = "\");\r\n							}catch(e){\r\n								Dialog.alert(\"".toCharArray();
    _jsp_string45 = ";\r\nusbusercode0 = ".toCharArray();
    _jsp_string30 = "\r\n	}\r\n	catch(e) {\r\n		return check_conn();\r\n	}\r\n	if(!isconn)\r\n		return check_conn();\r\n    /* end by cyril on 2008-08-14 for td:8521 */\r\n	\r\n	thiswin = thiswins\r\n	items = \",\"+items + \",\";\r\n	\r\n	var tempfieldvlaue1 = \"\";\r\n	try{\r\n		tempfieldvlaue1 = document.getElementById(\"htmlfieldids\").value;\r\n	}catch (e) {\r\n	}\r\n\r\n	for(i=1;i<=thiswin.length;i++){\r\n		tmpname = thiswin.elements[i-1].name;\r\n		tmpvalue = thiswin.elements[i-1].value;\r\n	    if(tmpvalue==null){\r\n	        continue;\r\n	    }\r\n\r\n		if(tmpname!=\"\" && items.indexOf(\",\"+tmpname+\",\")!=-1){		\r\n			var __fieldhtmltype = jQuery(\"input[name=\" + tmpname + \"]\").attr(\"__fieldhtmltype\");\r\n		    if (__fieldhtmltype == '9') {\r\n		        continue;\r\n		    }\r\n		\r\n			var href = location.href;\r\n			if(href && href.indexOf(\"Ext.jsp\")!=-1){\r\n				window.__oriAlert__ = true;\r\n			}\r\n			if(tempfieldvlaue1.indexOf(tmpname+\";\") == -1){\r\n				while(tmpvalue.indexOf(\" \") >= 0){\r\n					tmpvalue = tmpvalue.replace(\" \", \"\");\r\n				}\r\n				while(tmpvalue.indexOf(\"\\r\\n\") >= 0){\r\n					tmpvalue = tmpvalue.replace(\"\\r\\n\", \"\");\r\n				}\r\n\r\n				if(tmpvalue == \"\"){\r\n					if(thiswin.elements[i-1].getAttribute(\"temptitle\")!=null && thiswin.elements[i-1].getAttribute(\"temptitle\")!=\"\"){\r\n						if(window.__oriAlert__){\r\n							window.top.Dialog.alert(\"\\\"\"+thiswin.elements[i-1].getAttribute(\"temptitle\")+\"\\\"\"+\"".toCharArray();
    _jsp_string3 = "\r\n	<script language=\"javascript\">\r\n		window.top.Dialog.alert(\"".toCharArray();
    _jsp_string31 = "\");\r\n						}else{\r\n							var tempElement = thiswin.elements[i-1];\r\n							//ueditor\u5fc5\u586b\u9a8c\u8bc1\r\n							if (checkueditorContent(tempElement)) {\r\n								continue;\r\n							}\r\n							\r\n							window.top.Dialog.alert(\"&quot;\"+thiswin.elements[i-1].getAttribute(\"temptitle\")+\"&quot;\"+\"".toCharArray();
    _jsp_string36 = "\");\r\n						}else{\r\n							var tempElement = thiswin.elements[i-1];\r\n							\r\n							//ueditor\u5fc5\u586b\u9a8c\u8bc1\r\n							if (checkueditorContent(tempElement)) {\r\n								continue;\r\n							}\r\n							\r\n							window.top.Dialog.alert(\"&quot;\"+thiswin.elements[i-1].getAttribute(\"temptitle\")+\"&quot;\"+\"".toCharArray();
    _jsp_string26 = "';\r\n	        	//alert(xmlhttp.responseText);\r\n	        	return confirm(flag_msg);\r\n	        }\r\n	    }\r\n	    xmlhttp = null;\r\n\r\n	  	//\u68c0\u67e5\u591a\u884c\u6587\u672c\u6846 oracle\u4e0b\u68c0\u67e5HTML\u4e0d\u80fd\u8d85\u8fc74000\u4e2a\u5b57\u7b26\r\n	    ".toCharArray();
    _jsp_string52 = "\r\n\r\n\r\n<!--For wui-->\r\n".toCharArray();
    _jsp_string47 = "\";\r\nusblanguage = \"".toCharArray();
    _jsp_string55 = "/skins/".toCharArray();
    _jsp_string37 = "\", function () {\r\n								formElementFocus(tempElement);\r\n							});\r\n							\r\n						}\r\n						return false;\r\n					}else{\r\n						if(window.__oriAlert__){\r\n							window.top.Dialog.alert(\"".toCharArray();
    _jsp_string15 = "\\r\\n\\r\\n".toCharArray();
    _jsp_string62 = "\r\n<!-- \u9875\u9762\u5207\u6362\u6548\u679cEnd -->\r\n\r\n\r\n<script language=\"javascript\">\r\n\r\n//------------------------------\r\n// the folder of current skins \r\n//------------------------------\r\n//\u5f53\u524d\u4f7f\u7528\u7684\u4e3b\u9898\r\nvar GLOBAL_CURRENT_THEME = \"".toCharArray();
    _jsp_string41 = "\";\r\n   if(!confirm(str)){\r\n       return false;\r\n   }\r\n       return true;\r\n   } \r\n\r\n///*\u6d41\u7a0b\u91cc\u9762\u4f7f\u7528\uff0c\u4e3b\u8981\u662f\u56e0\u4e3a\u6d41\u7a0b\u5185\u5bb9\u653e\u5230iframe\u91cc\u9762\uff0c\u901a\u8fc7response\u8fd4\u56de\u7684\u65f6\u5019\uff0c\u8981\u8fd4\u56de\u7684\u5230\u5176\u7236\u7a97\u53e3*/\r\nfunction wfforward(wfurl){\r\n	parent.location.href = wfurl;\r\n}\r\n\r\nfunction myescapecode(str)\r\n{\r\n	return encodeURIComponent(str);\r\n}\r\n</script>\r\n\r\n\r\n\r\n<meta http-equiv=Content-Type content=\"text/html; charset=UTF-8\">\r\n<script language=JavaScript> \r\n  var companyname = \"".toCharArray();
    _jsp_string1 = "\r\n<!DOCTYPE HTML>\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n<html>\r\n<head>\r\n<!-- \r\n\u6dfb\u52a0\u81f3init.css\r\n<style type=\"text/css\">\r\n	html{height:100%;}\r\n</style>\r\n -->\r\n".toCharArray();
    _jsp_string13 = "_wev8.js\"></script>\r\n<script type=\"text/javascript\" src=\"/js/messagejs/highslide/highslide-full_wev8.js\"></script>\r\n<script type=\"text/javascript\">\r\n    hs.graphicsDir = '/js/messagejs/highslide/graphics/';\r\n    hs.align = 'center';\r\n    hs.transitions = ['expand', 'crossfade'];\r\n    hs.outlineType = 'rounded-white';\r\n    hs.fadeInOut = true;\r\n</script>\r\n<!-- init.css, \u6240\u6709css\u6587\u4ef6\u90fd\u5728\u6b64\u6587\u4ef6\u4e2d\u5f15\u5165 -->\r\n<link rel=\"stylesheet\" href=\"/css/init_wev8.css\" type=\"text/css\" />\r\n\r\n\r\n<script language=javascript>\r\nwindow[\"_jsessionid\"] = \"".toCharArray();
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string35 = "\");\r\n							}\r\n						}\r\n						return false;\r\n					}\r\n				}\r\n			} else {\r\n				var divttt=document.createElement(\"div\");\r\n				divttt.innerHTML = tmpvalue;\r\n				var tmpvaluettt = jQuery.trim(jQuery(divttt).text());\r\n				if(tmpvaluettt == \"\"){\r\n					if(thiswin.elements[i-1].getAttribute(\"temptitle\")!=null && thiswin.elements[i-1].getAttribute(\"temptitle\")!=\"\"){\r\n						if(window.__oriAlert__){\r\n							window.top.Dialog.alert(\"\\\";\"+thiswin.elements[i-1].getAttribute(\"temptitle\")+\"\\\"\"+\"".toCharArray();
    _jsp_string4 = "\",function(){\r\n			window.top.location=\"".toCharArray();
    _jsp_string50 = "\r\n<LINK href=\"/js/jquery/jquery_dialog_wev8.css\" type=text/css rel=STYLESHEET>\r\n<script type=\"text/javascript\" src=\"/wui/common/jquery/jquery.min_wev8.js\"></script>\r\n<script type=\"text/javascript\" language=\"javascript\" src=\"/js/jquery/jquery_dialog_wev8.js\"></script>\r\n\r\n<script src=\"/social/js/drageasy/drageasy.js\"></script>\r\n<script type=\"text/javascript\" src=\"/social/js/bootstrap/js/bootstrap.js\"></script>\r\n<script type=\"text/javascript\" src=\"/social/im/js/IMUtil_wev8.js\"></script>\r\n\r\n<script type=\"text/javascript\" src=\"/social/js/imcarousel/imcarousel.js\"></script>\r\n<script type=\"text/javascript\" language=\"javascript\">\r\nfunction ReloadOpenerByDialogClose() {\r\n    ".toCharArray();
    _jsp_string23 = "\";\r\n					diag.show();\r\n			        return false;\r\n	    		}\r\n	    		else if(response_flag=='2') {\r\n	    			flag_msg = '".toCharArray();
    _jsp_string65 = "\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string53 = "\r\n".toCharArray();
    _jsp_string10 = "\r\n<script language=\"javascript\" type=\"text/javascript\" src=\"/FCKEditor/swfobject_wev8.js\"></script>\r\n\r\n".toCharArray();
    _jsp_string49 = "\r\n\r\n<!--WUI -->\r\n".toCharArray();
    _jsp_string40 = "\";\r\n   if(!confirm(str)){\r\n       return false;\r\n   }\r\n       return true;\r\n } \r\n\r\nfunction issubmit(){\r\n	var str = \"".toCharArray();
    _jsp_string22 = "\";\r\n					//diag.InvokeElementId=\"pageOverlay\"\r\n					diag.URL = \"/wui/theme/ecology7/page/loginSmall.jsp?username=".toCharArray();
    _jsp_string29 = "')) {\r\n				    lenck = false;\r\n				    break;\r\n			    }\r\n		    }\r\n		    if(lenck==false) return false;\r\n	    }\r\n	    catch(e) {}\r\n	    ".toCharArray();
    _jsp_string58 = "\r\n<meta http-equiv=\"".toCharArray();
    _jsp_string60 = ",transition=".toCharArray();
    _jsp_string59 = "\" content=\"revealTrans(duration=".toCharArray();
    _jsp_string28 = "','".toCharArray();
    _jsp_string24 = "';\r\n	    		}\r\n	    		//\u4e3b\u4ece\u5e10\u6237\u7279\u6b8a\u5904\u7406 by alan for TD10156\r\n	    		if(response_flag=='3') {\r\n	    			flag_msg = '".toCharArray();
    _jsp_string39 = "\");\r\n						}\r\n						return false;\r\n					}\r\n				}\r\n			}\r\n		}\r\n	}\r\n	return true;\r\n}\r\n\r\nfunction isdel(){\r\n	var str = \"".toCharArray();
    _jsp_string2 = "\r\n\r\n".toCharArray();
  }
}
