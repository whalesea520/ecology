/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._js._hrm;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.hrm.passwordprotection.dao.HrmResourceDao;
import weaver.hrm.company.DepartmentComInfo;
import weaver.common.StringUtil;
import weaver.general.Util;
import weaver.conn.RecordSet;
import weaver.hrm.passwordprotection.domain.HrmResource;
import weaver.systeminfo.SystemEnv;
import weaver.hrm.passwordprotection.manager.HrmPasswordProtectionSetManager;
import weaver.hrm.passwordprotection.manager.HrmResourceManager;
import weaver.hrm.passwordprotection.manager.HrmResourceManagerManager;
import weaver.hrm.common.Constants;
import weaver.common.MessageUtil;
import weaver.hrm.passwordprotection.domain.HrmPasswordProtectionQuestion;
import weaver.hrm.passwordprotection.manager.HrmPasswordProtectionQuestionManager;
import java.util.Map;
import java.util.HashMap;
import java.util.Enumeration;
import java.util.Arrays;
import java.util.LinkedHashMap;
import weaver.common.DateUtil;
import weaver.hrm.HrmUserVarify;
import weaver.hrm.common.Tools;
import weaver.hrm.common.AjaxManager;
import ln.LN;
import java.util.List;
import org.json.JSONObject;
import org.json.JSONException;
import weaver.hrm.User;
import weaver.file.Prop;
import weaver.general.GCONST;
import weaver.ldap.LdapUtil;
import java.util.Random;
import java.util.Calendar;

public class _getdata__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;

  
  public static boolean ifEqlTarget(String val, String target) {
  	if(val == null || val.equals("")) {
  		return false;
  	}
  	if(!val.equals(target)) {
  		return false;
  	}
  	return true;
  }
  
  private static String checkLoginIdMsg(String id, String resourceid, boolean needJson,String type,int languageid){
  		RecordSet RS = new RecordSet();
  		StringBuffer sql = new StringBuffer("select id,lastname,loginid,{fEmail},mobile,(select COUNT(id) from hrm_protection_question where user_id = {tName}.id and delflag = 0) as qCount from {tName} where loginid = ? ");
  		//.append(StringUtil.vString(id)).append("' ");
  		if(StringUtil.isNotNull(resourceid)){
  			sql.append(" and id != ? ");
  			//.append(resourceid);
  		}
  		String message = "";
  		String _sql = StringUtil.replace(sql.toString(), "{fEmail}", "email");
  		_sql = StringUtil.replace(_sql, "{tName}", "HrmResource");
  		String needJsonSql = (needJson ? " and (accounttype = 0 or accounttype is null) " : "");
  		_sql += needJsonSql;
  		if(StringUtil.isNotNull(resourceid)){
  			RS.executeQuery(_sql,StringUtil.vString(id),resourceid);
  		}else{
  			RS.executeQuery(_sql,StringUtil.vString(id));
  		}
  		StringBuffer result = new StringBuffer();
  		HrmResource resource = new HrmResource();
  		int qCount = 0;
  		if(RS.next()){
  			resource.setId(RS.getInt(1));
  			resource.setLastname(StringUtil.vString(RS.getString(2)));
  			resource.setLoginid(StringUtil.vString(RS.getString(3)));
  			resource.setEmail(StringUtil.vString(RS.getString(4)));
  			resource.setMobile(StringUtil.vString(RS.getString(5)));
  			qCount = RS.getInt("qCount");
  		}
  		if(resource.getId().intValue() == 0){
  			_sql = StringUtil.replace(sql.toString(), "{fEmail}", "'' as email");
  			_sql = StringUtil.replace(_sql, "{tName}", "HrmResourceManager");
  			
  			if(StringUtil.isNotNull(resourceid)){
  				RS.executeQuery(_sql,StringUtil.vString(id),resourceid);
  			}else{
  				RS.executeQuery(_sql,StringUtil.vString(id));
  			}
  			if(RS.next()){
  				resource.setId(RS.getInt(1));
  				resource.setLastname(StringUtil.vString(RS.getString(2)));
  				resource.setLoginid(StringUtil.vString(RS.getString(3)));
  				resource.setEmail(StringUtil.vString(RS.getString(4)));
  				resource.setMobile(StringUtil.vString(RS.getString(5)));
  				qCount = RS.getInt("qCount");
  			}
  		}
  		int rid = Util.getIntValue(resource.getId()+"",0);
  		int typeid = Util.getIntValue(type,0);
  		String email = StringUtil.vString(resource.getEmail());
  		String mobile = StringUtil.vString(resource.getMobile());
  		
  		String ret = "0";
  		String mode=Prop.getPropValue(GCONST.getConfigFile() , "authentic");
  		if(mode.equals("ldap")){
  			RecordSet rs = new RecordSet();
  			//rs.executeSql("select isADAccount from hrmresource where id="+rid);
  			rs.executeQuery("select isADAccount from hrmresource where id= ? ",rid);
  			if(rs.next() &&  "1".equals(Util.null2String(rs.getString("isADAccount")))){
  				ret = "1";
  			}
  		} 
  	if(!ret.equals("1")){
  		if(rid == 0){
  			message = SystemEnv.getHtmlLabelName(127829, languageid);
  		} else {
  			if(typeid == 0 && mobile == ""){
  				message = SystemEnv.getHtmlLabelName(81618, languageid);
  			}else if(typeid == 1 && qCount == 0){
  				message = SystemEnv.getHtmlLabelName(125970, languageid);
  			}else if(typeid == 2 && email == ""){
  				message = SystemEnv.getHtmlLabelName(125971, languageid);
  			}
  		}
  	}else{
  		//QC273665  Ldap\u7528\u6237\u652f\u6301\u5fd8\u8bb0\u5bc6\u7801\u529f\u80fd START  \u5bf9\u8f93\u5165\u7528\u6237\u540d\u540eonblur\u4e8b\u4ef6\u7684\u6539\u9020\uff0cAD\u8d26\u53f7\uff0c\u53ef\u4ee5\u4fee\u6539\u5bc6\u7801  
  		RecordSet rs = new RecordSet();
  	    String retsql = "select l.needSynPassword,l.isuseldap from ldapset l";
  	    rs.executeSql(retsql);
  	    String istrue = "";
  	   // String isuseldap = "";
  	    if(rs.next()){
  	        istrue = Util.null2String(rs.getString("needSynPassword"));
  	        //isuseldap = Util.null2String(rs.getString("isuseldap"));
  	    }
  		if(!("".equals(istrue)||null==istrue)){	       	
  			LdapUtil ldap = LdapUtil.getInstance();
  			String certificate = ldap.judgeAdCertificate();//\u9a8c\u8bc1\u8bc1\u4e66\u662f\u5426\u53ef\u7528
  			if(certificate.indexOf("ok") > -1){			
  				if(typeid == 0 && mobile == ""){
  					message = SystemEnv.getHtmlLabelName(81618, languageid);
  				}else if(typeid == 1 && qCount == 0){
  					message = SystemEnv.getHtmlLabelName(125970, languageid);
  				}else if(typeid == 2 && email == ""){
  					message = SystemEnv.getHtmlLabelName(125971, languageid);
  				}
  			}else{
  				message = SystemEnv.getHtmlLabelNames("33268,126690", languageid);
  			}
  		}else{
  			message = SystemEnv.getHtmlLabelNames("33268,126690", languageid);
  		}
  		//QC273665  Ldap\u7528\u6237\u652f\u6301\u5fd8\u8bb0\u5bc6\u7801\u529f\u80fd END 
  	}
  		if("".equals(message)){
  			message = rid+"";
  		}else{
  			//\u7edf\u4e00\u8fd4\u56de\u7684\u9519\u8bef\u6d88\u606f\uff0c\u4ee5\u9632\u6076\u610f\u731c\u6d4b\u653b\u51fb\u3002
  			if(!message.equals(SystemEnv.getHtmlLabelName(127829, languageid))){
  				//System.out.println(message);
  				message = SystemEnv.getHtmlLabelName(127829, languageid);
  			}
  		}
  		
  		return message;
  	}
  
  	private static String getReceiverByLoginid(String loginid,String type){
  		RecordSet RS = new RecordSet();
  		String receiver = "";
  		//String sql = "select * from HrmResource where loginid='"+loginid+"' and (accounttype = 0 or accounttype is null)";
  		String sql = "select * from HrmResource where loginid= ? and (accounttype = 0 or accounttype is null)";
  		RS.executeQuery(sql,loginid);
  		String mobile="",email="";
  		if(RS.next()){
  			mobile = RS.getString("mobile");
  			email = RS.getString("email");
  		}
  		if("sendSMS".equals(type)){
  			receiver = mobile;
  		}else if("sendEmail".equals(type)){
  			receiver = email;
  		}
  		return receiver;
  	}
  	
  	public static String getData(String str, String param){
  		RecordSet RS = new RecordSet();
  		String result = "";
  		str = StringUtil.vString(str);
  		param = StringUtil.vString(param);
  		String[] params = param.split(";");
  		if(params == null || params.length != 2) return "";
  		String cmd = StringUtil.vString(params[0]);
  		String data = StringUtil.vString(params[1]);
  		if(cmd.equals("getHrmChoiceImage")){
  			String[] dataArray = StringUtil.split(data,"+");
  			StringBuffer sb = new StringBuffer();
  			for(String _d : dataArray){
  				sb.append(_d);
  			}
  			String[] allDate = sb.toString().split(",");
  			if(allDate.length == 2){
  				String currentdate = DateUtil.getCurrentDate();
  				if((currentdate.compareTo(dataArray[0])>=0 || StringUtil.isNull(dataArray[0])) && (currentdate.compareTo(dataArray[1])<=0 || StringUtil.isNull(dataArray[1]))){
  					result = "<img src='/images/BacoCheck.gif'>";
  				}
  			}
  			if(HrmUserVarify.isUserOnline(str)) {
  				result += "<img src='/images/State_LoggedOn.gif'>";
  			}
  		} else if(cmd.equals("getTResourceName")){
  			RS.executeQuery("select 1 from HrmResourceManager where loginid = ?",str);
  			if(RS.next()) result = "HrmResourceManager";
  			
  			result = Tools.vString(result, data);
  		} else if(cmd.equals("getAccountType")){
  			//RS.executeSql("select accounttype from HrmResource where id = "+str);
  			RS.executeQuery("select accounttype from HrmResource where id = ?",str);
  			if(RS.next()) result = RS.getString(1);
  			
  			result = Tools.vString(result, data);
  		} else if(cmd.equals("getLnScCount")){
  			result = getLnScResult(data);
  		}
  		return result;
  	}
  	
  	private static String getLnScResult(String param){
  		RecordSet RS = new RecordSet();
  		final int F_Y = 0;
  		final int F_N = 1;
  		int type = F_N;
  		int count = 0;
  		LN license = new LN();
  		license.InLicense();
  		type = StringUtil.parseToInt(license.getScType(), F_N);
  		count = StringUtil.parseToInt(license.getScCount(), 0);
  		count = type == F_Y ? (count < 0 ? 0 : count) : 0;
  		
  		String result = "";
  		if(param.equals("ct")){
  			result = String.valueOf(count);
  		} else if(param.equals("mf")){
  			int allSubCompany = 0;
  			RS.executeSql("select COUNT(id) from HrmSubCompany where supsubcomid = 0 and (canceled is null or canceled != '1')");
  			if(RS.next()) 
  				allSubCompany = RS.getInt(1);
  			result = String.valueOf(count == 0 || allSubCompany < count);
  		}
  		return result;
  	}
  	
  	private static String checkLoginId(String id, String resourceid, boolean needJson){
  		RecordSet RS = new RecordSet();
  		StringBuffer sql = new StringBuffer("select id,lastname,loginid,{fEmail},mobile,(select COUNT(id) from hrm_protection_question where user_id = {tName}.id and delflag = 0) as qCount from {tName} where loginid = '")
  		.append(StringUtil.vString(id)).append("' ");
  		if(StringUtil.isNotNull(resourceid)){
  			sql.append(" and id != ").append(resourceid);
  		}
  		String _sql = StringUtil.replace(sql.toString(), "{fEmail}", "email");
  		_sql = StringUtil.replace(_sql, "{tName}", "HrmResource");
  		RS.executeSql(_sql + (needJson ? " and (accounttype = 0 or accounttype is null) " : ""));
  		StringBuffer result = new StringBuffer();
  		HrmResource resource = new HrmResource();
  		int qCount = 0;
  		if(RS.next()){
  			resource.setId(RS.getInt(1));
  			resource.setLastname(StringUtil.vString(RS.getString(2)));
  			resource.setLoginid(StringUtil.vString(RS.getString(3)));
  			resource.setEmail(StringUtil.vString(RS.getString(4)));
  			resource.setMobile(StringUtil.vString(RS.getString(5)));
  			qCount = RS.getInt("qCount");
  		}
  		if(resource.getId().intValue() == 0){
  			_sql = StringUtil.replace(sql.toString(), "{fEmail}", "'' as email");
  			_sql = StringUtil.replace(_sql, "{tName}", "HrmResourceManager");
  			RS.executeSql(_sql);
  			if(RS.next()){
  				resource.setId(RS.getInt(1));
  				resource.setLastname(StringUtil.vString(RS.getString(2)));
  				resource.setLoginid(StringUtil.vString(RS.getString(3)));
  				resource.setEmail(StringUtil.vString(RS.getString(4)));
  				resource.setMobile(StringUtil.vString(RS.getString(5)));
  				qCount = RS.getInt("qCount");
  			}
  		}
  		if(needJson){
  			JSONObject obj = new JSONObject();
  			try {
  				obj.put("id", resource.getId());
  			} catch (JSONException e) {}
  			
  			result.append(obj.toString());
  		} else {
  			result.append(resource.getId().intValue() != 0 ? "1" : "0");
  		}
  		return result.toString();
  	}
  	
   
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      
	request.setCharacterEncoding("UTF-8");
	response.setContentType("text/html; charset=UTF-8");
	response.setHeader("Cache-Control", "no-cache");
	java.io.PrintWriter pout = response.getWriter();
	try{
		StringBuffer result = new StringBuffer();
		String id = StringUtil.getURLDecode(request.getParameter("id"));
		String cmd = StringUtil.getURLDecode(request.getParameter("cmd"));
		if(cmd.equalsIgnoreCase("forgotPasswordCheckMsg")){
			String loginid = StringUtil.getURLDecode(request.getParameter("loginid"));
			String type = StringUtil.getURLDecode(request.getParameter("type"));
			int languageid = Util.getIntValue(StringUtil.getURLDecode(request.getParameter("languageid")), 7) ;
			String validatecode = StringUtil.getURLDecode(request.getParameter("validatecode"));
            String validateRand="";
            validateRand=Util.null2String((String)request.getSession(true).getAttribute("validateRand"));
			System.out.println("validateRand>>"+validateRand+">>validatecode>>"+validatecode);
            if(!validateRand.toLowerCase().equals(validatecode.trim().toLowerCase()) || "".equals(validatecode.trim().toLowerCase()) ){
				result.append(SystemEnv.getHtmlLabelName(127829, languageid));
            }else{
    			result.append(checkLoginIdMsg(loginid, null, true,type,languageid));
            }
            
		}else if(cmd.equalsIgnoreCase("checkValicateCode")){
		
			String loginid = StringUtil.getURLDecode(request.getParameter("loginid"));
			String validatecode = StringUtil.getURLDecode(request.getParameter("validatecode"));
            String validateRand="";
            validateRand=Util.null2String((String)request.getSession(true).getAttribute("validateRand"));
            if(!validateRand.toLowerCase().equals(validatecode.trim().toLowerCase()) || "".equals(validatecode.trim().toLowerCase()) ){
				result.append("");
            }else{
				result.append(new Random().nextInt()+"");
            }
            
		}else if(cmd.equalsIgnoreCase("checkSMSCode")){
		
			String loginid = StringUtil.getURLDecode(request.getParameter("loginid"));
			String validatecode = StringUtil.getURLDecode(request.getParameter("validatecode"));
			String phoneCodeInp = StringUtil.getURLDecode(request.getParameter("phoneCode"));
		
			HttpSession session1 = request.getSession(true);
			Map<String,String> sessionMap = (Map<String,String>)session.getAttribute("phoneSessionMap");
			sessionMap = sessionMap==null? new HashMap<String,String>():sessionMap;
			if(sessionMap.get(loginid) == null){
				result.append("");
			}else{
				String nowtime = DateUtil.getFullDate();
				String sixtyTime = sessionMap.get(loginid);
				if(nowtime.compareTo(sixtyTime) > 0 ){
					result.append("");
					sessionMap.remove(loginid);
					request.getSession(true).removeAttribute("phoneCode");
					return ;
				}
	            String validateRand="";
	            validateRand=Util.null2String((String)request.getSession(true).getAttribute("validateRand"));
	            String phoneCode="";
	            phoneCode=Util.null2String((String)request.getSession(true).getAttribute("phoneCode"));	
	            if(!validateRand.toLowerCase().equals(validatecode.trim().toLowerCase()) || "".equals(validatecode.trim().toLowerCase()) ){
					result.append("");
	            }else{
		            if("".equals(phoneCodeInp.trim().toLowerCase())){
							result.append("");
		            }else{
			            if(!phoneCode.toLowerCase().equals(phoneCodeInp.trim().toLowerCase())){
							result.append("");
			            }else{
						request.getSession(true).setAttribute("validateLoginid",loginid);
							result.append(new Random().nextInt()+"");
			            }
		            }
	            }
            }
            
		}else if(cmd.equalsIgnoreCase("checkEmailCode")){
		
			String loginid = StringUtil.getURLDecode(request.getParameter("loginid"));
			String validatecode = StringUtil.getURLDecode(request.getParameter("validatecode"));
			String emailCodeInp = StringUtil.getURLDecode(request.getParameter("emailCode"));
			
			HttpSession session1 = request.getSession(true);
			Map<String,String> sessionMap = (Map<String,String>)session.getAttribute("emailSessionMap");
			sessionMap = sessionMap==null? new HashMap<String,String>():sessionMap;
			
			if(sessionMap.get(loginid) == null){
				result.append("");
			}else{
				String nowtime = DateUtil.getFullDate();
				String sixtyTime = sessionMap.get(loginid);
				if(nowtime.compareTo(sixtyTime) > 0 ){
					result.append("");
					sessionMap.remove(loginid);
					request.getSession(true).removeAttribute("emailCode");
					return ;
				}
	            String validateRand="";
	            validateRand=Util.null2String((String)request.getSession(true).getAttribute("validateRand"));
	            String emailCode="";
	            emailCode=Util.null2String((String)request.getSession(true).getAttribute("emailCode"));
	            if(!validateRand.toLowerCase().equals(validatecode.trim().toLowerCase()) || "".equals(validatecode.trim().toLowerCase()) ){
					result.append("");
	            }else{
		            if("".equals(emailCodeInp.trim().toLowerCase())){
							result.append("");
		            }else{
			            if(!emailCode.toLowerCase().equals(emailCodeInp.trim().toLowerCase())){
							result.append("");
			            }else{
						request.getSession(true).setAttribute("validateLoginid",loginid);
							result.append(new Random().nextInt()+"");
			            }
		            }
	            }
			}
            
		}else if(cmd.equalsIgnoreCase("sendSMS")){

		}else if(cmd.equalsIgnoreCase("sendSMSCode")){
			String content = StringUtil.getURLDecode(request.getParameter("content"));
			String loginid = StringUtil.getURLDecode(request.getParameter("loginid"));
			String validatecode = StringUtil.getURLDecode(request.getParameter("validatecode"));
			String receiver = getReceiverByLoginid(loginid,"sendSMS");
//			if(StringUtil.isNotNull(receiver)) receiver = StringUtil.decode(receiver);

			HttpSession session1 = request.getSession(true);
			Map<String,String> sessionMap = (Map<String,String>)session.getAttribute("phoneSessionMap");
			sessionMap = sessionMap==null? new HashMap<String,String>():sessionMap;
			if(sessionMap.get(loginid) != null ){
				String nowtime = DateUtil.getFullDate();
				String sixtyTime = sessionMap.get(loginid);
				if(nowtime.compareTo(sixtyTime) > 0 ){
					sessionMap.remove(loginid);
					request.getSession(true).removeAttribute("phoneCode");
				} else {
					result.append("outoftime_");
				}
			}
			
			if(sessionMap.get(loginid) != null ){
				result.append("");
			}else{
				String newPassword = "";
				boolean isChange = false;
	             String validateRand="";
	             validateRand=Util.null2String((String)request.getSession(true).getAttribute("validateRand"));
	             if(!validateRand.toLowerCase().equals(validatecode.trim().toLowerCase()) || "".equals(validatecode.trim().toLowerCase()) ){
						result.append("");
	             }else{
					HrmPasswordProtectionSetManager manager = new HrmPasswordProtectionSetManager();
					if(StringUtil.isNotNull(id) && !id.equals("0")){
						newPassword = StringUtil.randomString(6, 0);//\u5f88\u5bf9get\u65b9\u6cd5\u63d0\u4ea4\u7684\u65f6\u5019\u7279\u6b8a\u5b57\u7b26\u5bfc\u81f4\u6570\u636e\u4f20\u8f93\u6709\u8bef\u7684\u95ee\u9898\uff0c\u628a\u9a8c\u8bc1\u7801\u53d6\u503c\u5185\u5bb9\u5199\u6b7b\u62106\u4f4d\u968f\u673a\u6570\u5b57
						content = StringUtil.replace(Constants.PHONECODE_MESSSAGE, "{pswd}", newPassword);
						isChange = true;
					}
					String phone = "";
					boolean bool = MessageUtil.sendSMS(receiver, content);
				
				
					if(bool && isChange){
						//manager.changePassword(id, loginid, newPassword);
						if(receiver.length() - 4 > 0){
							phone = receiver.substring(0, receiver.length() - 4);
						}
						phone += "****";
					}
					if(!phone.equals("")){
						try {
						   if(!"".equals(newPassword)){
								// \u5c06\u624b\u673a\u9a8c\u8bc1\u7801\u5b58\u5165session
								session1.setAttribute("phoneCode", newPassword);
						        Calendar cal = DateUtil.getCalendar(DateUtil.getFullDate());
						        cal.add(Calendar.SECOND, Constants.SessionSec);
								String sixtyTime = DateUtil.getFullDate(cal.getTime());
								sessionMap.put(loginid,sixtyTime);
								session.setAttribute("phoneSessionMap",sessionMap);
						   }
						}catch (Exception e) {
					  	}	
					}
					result.append(phone);
	             }
			}
		} else if(cmd.equalsIgnoreCase("sendEmailCode")){
			String subject = StringUtil.getURLDecode(request.getParameter("subject"));
			String content = StringUtil.getURLDecode(request.getParameter("content"));
			String loginid = StringUtil.getURLDecode(request.getParameter("loginid"));
			String validatecode = StringUtil.getURLDecode(request.getParameter("validatecode"));
			String receiver = getReceiverByLoginid(loginid,"sendEmail");
			
			HttpSession session1 = request.getSession(true);
			Map<String,String> sessionMap = (Map<String,String>)session.getAttribute("emailSessionMap");
			sessionMap = sessionMap==null? new HashMap<String,String>():sessionMap;
			if(sessionMap.get(loginid) != null ){
				String nowtime = DateUtil.getFullDate();
				String sixtyTime = sessionMap.get(loginid);
				if(nowtime.compareTo(sixtyTime) > 0 ){
					sessionMap.remove(loginid);
					request.getSession(true).removeAttribute("emailCode");
				} else {
					result.append("outoftime_");
				}
			}

			if(sessionMap.get(loginid) != null){
				result.append("");
			}else{
				if(StringUtil.isNull(subject)) subject = "E-cology\u5bc6\u7801\u627e\u56de";
				String newPassword = "";
				boolean isChange = false;
	             String validateRand="";
	             validateRand=Util.null2String((String)request.getSession(true).getAttribute("validateRand"));
	             if(!validateRand.toLowerCase().equals(validatecode.trim().toLowerCase()) || "".equals(validatecode.trim().toLowerCase()) ){
						result.append("");
	             }else{
					HrmPasswordProtectionSetManager manager = new HrmPasswordProtectionSetManager();
					if(StringUtil.isNotNull(id) && !id.equals("0")){
						newPassword = StringUtil.randomString(6, 0);//\u5f88\u5bf9get\u65b9\u6cd5\u63d0\u4ea4\u7684\u65f6\u5019\u7279\u6b8a\u5b57\u7b26\u5bfc\u81f4\u6570\u636e\u4f20\u8f93\u6709\u8bef\u7684\u95ee\u9898\uff0c\u628a\u9a8c\u8bc1\u7801\u53d6\u503c\u5185\u5bb9\u5199\u6b7b\u62106\u4f4d\u968f\u673a\u6570\u5b57
						content = StringUtil.replace(Constants.EMAILCODE_MESSSAGE, "{pswd}", newPassword);
						isChange = true;
					}
					boolean bool = MessageUtil.sendEmail(receiver, subject, content);
					String email = "";
					if(bool && isChange) {
						//manager.changePassword(id, loginid, newPassword);
						if(receiver.length() - 4 > 0){
							email = receiver.substring(0, receiver.length() - 4);
						}
						email += "****";
					}
					if(!email.equals("")){
						try {
						   if(!"".equals(newPassword)){
								
								// \u5c06\u90ae\u7bb1\u9a8c\u8bc1\u7801\u5b58\u5165session
								session1.setAttribute("emailCode", newPassword);
						        Calendar cal = DateUtil.getCalendar(DateUtil.getFullDate());
						        cal.add(Calendar.SECOND, Constants.SessionSec);
								String sixtyTime = DateUtil.getFullDate(cal.getTime());
								sessionMap.put(loginid,sixtyTime);
								session.setAttribute("emailSessionMap",sessionMap);
						   }
						}catch (Exception e) {
					  	}	
					}
					result.append(email);
	             }
             }
		}else if(cmd.equalsIgnoreCase("sendEmail")){

		} else if(cmd.equalsIgnoreCase("verifyQuestion")){
			String loginid = StringUtil.getURLDecode(request.getParameter("loginid"));
			String qid = StringUtil.getURLDecode(request.getParameter("qid"));
			String answer = StringUtil.getURLDecode(request.getParameter("answer"));
			HrmPasswordProtectionQuestionManager manager = new HrmPasswordProtectionQuestionManager();
			Map<String, Comparable> map = new HashMap<String, Comparable>();
			map.put("sql_userId", "and t.user_id in (select id from "+getData(loginid, "getTResourceName;HrmResource")+" where loginid = '"+loginid+"') ");
			map.put("id", qid);
			map.put("answer", answer);
			List<HrmPasswordProtectionQuestion> list = manager.find(map);
			if(list != null && list.size() > 0&&((HrmPasswordProtectionQuestion)list.get(0)).getUserId()>0){
				request.getSession(true).setAttribute("validateLoginid",loginid);
			}
//			result.append(list != null && list.size() > 0);
			result.append((list != null && list.size() > 0)?((HrmPasswordProtectionQuestion)list.get(0)).getUserId():("false"));
		}else if(cmd.equalsIgnoreCase("forgotPasswordCheck")){
			String loginid = StringUtil.getURLDecode(request.getParameter("loginid"));
			result.append(checkLoginId(loginid, null, true));
		}else if(cmd.equalsIgnoreCase("saveNewPassword")){
			RecordSet rs = new RecordSet();
			String loginid = StringUtil.getURLDecode(request.getParameter("loginid"));
			String type = StringUtil.getURLDecode(request.getParameter("type"));
			//QC273665 start  Ldap\u7528\u6237\u652f\u6301\u5fd8\u8bb0\u5bc6\u7801\u529f\u80fd \uff0c\u4fdd\u5b58\u65b0\u5bc6\u7801
			String ret = "0";
			String mode=Prop.getPropValue(GCONST.getConfigFile(), "authentic");
			if(mode.equals("ldap")){
				rs.executeQuery("select isADAccount from hrmresource where loginid= ? ",loginid);
				if(rs.next() &&  "1".equals(Util.null2String(rs.getString("isADAccount")))){
					ret = "1";
				}
			}
			//QC273665 end   Ldap\u7528\u6237\u652f\u6301\u5fd8\u8bb0\u5bc6\u7801\u529f\u80fd \uff0c\u4fdd\u5b58\u65b0\u5bc6\u7801

			    String validateLoginid=Util.null2String((String)request.getSession(true).getAttribute("validateLoginid"));
			  	try {
					   request.getSession(true).removeAttribute("validateLoginid");
					}catch (Exception e) {}	
			    if(validateLoginid.length()==0 || !validateLoginid.toLowerCase().equals(loginid.trim().toLowerCase())){
			    	response.sendRedirect("/Refresh.jsp?loginfile=/login/Login.jsp?logintype=1");
						return;
			    }
		    
			// String newPassword = StringUtil.getURLDecode(request.getParameter("newpswd"));
			String newPassword = request.getParameter("newpswd");
			rs.executeSql("select id from "+AjaxManager.getData(loginid, "getTResourceName;HrmResource")+" where loginid='"+loginid+"'");
			rs.next();
			String userid = StringUtil.vString(rs.getString("id"),"0");
			String qid = StringUtil.vString(request.getParameter("qid"),"0");
    		if(!"".equals(type)){
    		//QC273665 start Ldap\u7528\u6237\u652f\u6301\u5fd8\u8bb0\u5bc6\u7801\u529f\u80fd 
    		    //System.out.println("QC273665 TYPE is null saveNewPassword ISAD===" + ret);
	    		if(ret.equals("1")){
						LdapUtil ldap=LdapUtil.getInstance();
						java.util.HashMap map=ldap.updateUserInfo(loginid,"","",newPassword,"","1");
						String isSuccess = (String)map.get("isSuccess");
						if("false".equals(isSuccess)){
							result.append("false");
						}
						//System.out.println("QC273665 saveNewPassword=====isSuccess---"+isSuccess);					
				}else{
					new HrmPasswordProtectionSetManager().changePassword(null, loginid, newPassword);
				}
				//QC273665 end Ldap\u7528\u6237\u652f\u6301\u5fd8\u8bb0\u5bc6\u7801\u529f\u80fd 
			}else{
				rs.executeSql("select 1 from hrm_protection_question where user_id="+userid+" and id in("+qid+")");
				if(rs.next()){
				//QC273665 start Ldap\u7528\u6237\u652f\u6301\u5fd8\u8bb0\u5bc6\u7801\u529f\u80fd 
					//System.out.println("QC273665 TYPE is not null saveNewPassword ISAD===" + ret);
					if(ret.equals("1")){
						LdapUtil ldap=LdapUtil.getInstance();
						java.util.HashMap map=ldap.updateUserInfo(loginid,"","",newPassword,"","1");
						String isSuccess = (String)map.get("isSuccess");
						if("false".equals(isSuccess)){
							result.append("false");
						}
						//System.out.println("QC273665 TYPE is not nullsaveNewPassword=====isSuccess---"+isSuccess);					
					}else{
						new HrmPasswordProtectionSetManager().changePassword(id, loginid, newPassword);
					}
				//QC273665 end Ldap\u7528\u6237\u652f\u6301\u5fd8\u8bb0\u5bc6\u7801\u529f\u80fd 
				}else{
					response.sendRedirect("/hrm/password/forgotPassword.jsp");
				}
			}
		} else if(cmd.equalsIgnoreCase("ppset")){
			User user = HrmUserVarify.getUser (request , response) ;
			if(user == null){
				response.sendRedirect("/login/Login.jsp");
				return ;
			}else if(!id.equals(""+user.getUID())){
	    	response.sendRedirect("/Refresh.jsp?loginfile=/login/Login.jsp?logintype=1");
				return;
	    }
			HrmPasswordProtectionSetManager manager = new HrmPasswordProtectionSetManager();
			String checked = StringUtil.getURLDecode(request.getParameter("checked"));
			manager.set(StringUtil.parseToLong(id), Boolean.valueOf(checked));
		} else if(cmd.equalsIgnoreCase("insertQuestion")){
			User user = HrmUserVarify.getUser (request , response) ;
			if(user == null){
				response.sendRedirect("/login/Login.jsp");
				return ;
			}else{
				long userid = StringUtil.parseToLong(user.getUID()+"");
				HrmPasswordProtectionQuestion bean = null;
				Map<String, HrmPasswordProtectionQuestion> qmap = new LinkedHashMap<String, HrmPasswordProtectionQuestion>();
				Enumeration enu = request.getParameterNames();
				int maxSize = 0;
				String indexs = "";
				while(enu.hasMoreElements()){  
					String paraName = StringUtil.vString(enu.nextElement());  
					if(paraName.equalsIgnoreCase("userid") || paraName.equalsIgnoreCase("cmd")) continue;
					String[] params = paraName.split("_"); 
					if(params == null || params.length != 2) continue;
					String key = "q"+params[1];
					if(qmap.containsKey(key)){
						bean = qmap.get(key);
					} else {
						bean = new HrmPasswordProtectionQuestion();
						qmap.put(key, bean);
						maxSize++;
						indexs += (indexs.length()==0?"":",") +params[1];
					}
					if(params[0].equalsIgnoreCase("question")){
						bean.setQuestion(StringUtil.getURLDecode(request.getParameter(paraName)));
					} else if(params[0].equalsIgnoreCase("answer")){
						bean.setAnswer(StringUtil.getURLDecode(request.getParameter(paraName)));
					}
				}
				HrmPasswordProtectionQuestionManager manager = new HrmPasswordProtectionQuestionManager();
				Map<String, Long> map = new HashMap<String, Long>();
				map.put("userId", userid);
				manager.delete(map);
				
				String[] indexArray = indexs.split(",");
				int[] iArray = new int[indexArray.length];
				for(int i=0; i<indexArray.length; i++){
					iArray[i] = StringUtil.parseToInt(indexArray[i]);
				}
				Arrays.sort(iArray);
				for(int i=0; i<iArray.length; i++){
					if(qmap.containsKey("q"+iArray[i])){
						bean = (HrmPasswordProtectionQuestion)qmap.get("q"+iArray[i]);
						bean.setUserId(userid);
						manager.insert(bean);
					}
				}
			}
		}else if(cmd.equalsIgnoreCase("verifyPswd")){
			session.setAttribute("verifyPswd",null);
			JSONObject obj = new JSONObject();
			User user = HrmUserVarify.getUser (request , response) ;
			if(user == null){
				obj.put("result", "false");
				result.append(obj.toString());
			}else{
				boolean isExsit = true;
				RecordSet rs = new RecordSet();
				String isADAccount = "";
		        //String isADAccountSql = "select isADAccount from HrmResource where id = "+id;
		        String isADAccountSql = "select isADAccount from HrmResource where id = ?";
		        rs.executeQuery(isADAccountSql,id);
		        if(rs.next()) {
		        	isADAccount = rs.getString("isADAccount");
		        }
		        String isUseLdap = Prop.getPropValue(GCONST.getConfigFile(), "authentic");    
	            if (ifEqlTarget(isUseLdap, "ldap") && ifEqlTarget(isADAccount, "1") && !"1".equals(id)) {
	            	LdapUtil util = LdapUtil.getInstance();
	            	isExsit = util.authentic(user.getLoginid(), request.getParameter("pswd"));
	            }else{
	            	String pswd = Util.getEncrypt(request.getParameter("pswd"));
					Map<String, Comparable> map = new HashMap<String, Comparable>();
					map.put("id", id);
					map.put("password", pswd);
					isExsit = new HrmResourceManager().get(map) != null;
					if(!isExsit){
						isExsit = new HrmResourceManagerManager().get(map) != null;
					}
	            }
				try {
					if(isExsit){
						session.setAttribute("verifyPswd",user);
					}
					obj.put("result", String.valueOf(isExsit));
				} catch (JSONException e) {}
				result.append(obj.toString());
			}
		}else if(cmd.equalsIgnoreCase("verifyIsADAccount")){
			String ret = "0";
			String mode=Prop.getPropValue(GCONST.getConfigFile() , "authentic");
			if(mode.equals("ldap")){
				RecordSet rs = new RecordSet();
				//rs.executeSql("select isADAccount from hrmresource where id="+id);
				rs.executeQuery("select isADAccount from hrmresource where id=?",id);
				if(rs.next() &&  "1".equals(Util.null2String(rs.getString("isADAccount")))){
					ret = "1";
				}
			}  
			result.append(ret);
		}else if(cmd.equalsIgnoreCase("checkBatchNewDeptUsers")){
			String resourceid = Util.null2o(request.getParameter("resourceid")) ;
			String newDeptid = Util.null2o(request.getParameter("arg")) ;
			String subId = "";
			
			RecordSet rst = new RecordSet();
			
			try {
				subId = new DepartmentComInfo().getSubcompanyid1(newDeptid);
			} catch (Exception e) {}
			
			int _subId = Integer.parseInt(subId) ;
			
			String limitSql = "select a.limitUsers from HrmSubCompany a where a.id ="+subId ;
			rst.execute(limitSql) ;
			int limits = 0 ;
			if(rst.next()){
				limits = rst.getInt("limitUsers") ;
			}
			boolean flag = false ;
			if(limits > 0){
				// current has
				HrmResourceDao resourceDao = new HrmResourceDao();
				int count = resourceDao.count(0, _subId) ;
				
				// current move
				String moveSql = "select count(1) as cnt from hrmresource where id in ("+resourceid+") and subcompanyid1 !="+subId +" and (loginid is not null or loginid !='') ";
				int moveCnt = 0 ;
				rst.executeSql(moveSql) ;
				if(rst.next()){
					moveCnt = rst.getInt("cnt") ;
				}
				flag = 	moveCnt+count > limits ; // over limit
			}
			
			result.append(flag) ;
		}else if(cmd.equalsIgnoreCase("checkValidatecode")){
			String validatecode = Util.null2o(request.getParameter("validatecode")) ;
            String validateRand=Util.null2String((String)request.getSession(true).getAttribute("validateRand"));
            if(!validateRand.toLowerCase().equals(validatecode.trim().toLowerCase()) || "".equals(validatecode.trim().toLowerCase()) ){
				result.append("");
            }else{
				result.append(new Random().nextLong()) ;
            }
		}else{
			result.append(weaver.hrm.common.AjaxManager.getData(request, application));
		}
		pout.print(result.toString());
		
	} catch (Exception e) {
		pout.print(e.toString());
	}

      out.write(_jsp_string1, 0, _jsp_string1.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("js/hrm/getdata.jsp"), 159024116223778248L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string1;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
  }
}
