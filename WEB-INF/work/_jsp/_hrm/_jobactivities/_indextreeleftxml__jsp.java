/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._hrm._jobactivities;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.general.Util;
import weaver.hrm.*;
import net.sf.json.*;
import weaver.hrm.resource.TreeNode;
import weaver.general.*;
import weaver.file.Prop;
import weaver.hrm.company.*;
import java.util.ArrayList;
import weaver.hrm.resource.ResourceComInfo;
import weaver.conn.RecordSet;
import weaver.hrm.appdetach.AppDetachComInfo;
import weaver.hrm.resource.MutilResourceBrowser;
import weaver.systeminfo.SystemEnv;
import weaver.hrm.country.CountryComInfo;
import weaver.hrm.province.ProvinceComInfo;
import weaver.hrm.city.CityComInfo;
import weaver.hrm.city.CitytwoComInfo;
import weaver.hrm.job.JobGroupsComInfo;
import weaver.hrm.job.JobActivitiesComInfo;
import java.util.List;
import java.util.Map;
import java.util.HashMap;
import com.alibaba.fastjson.JSON;
import java.net.URLDecoder;

public class _indextreeleftxml__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;

  
  public  TreeNode getCountryTreeList(TreeNode treeList,String searchStr) throws Exception{
  
  	List<String> jcid = new ArrayList<String>();
  	List<String> jcName = new ArrayList<String>();
  	
  	List<String> rsid = new ArrayList<String>();
  	List<String> rsName = new ArrayList<String>();
  	List<String> rsSubId = new ArrayList<String>();
  	
  	JobGroupsComInfo jc = new JobGroupsComInfo();
  	JobActivitiesComInfo rs = new JobActivitiesComInfo();
  
  	RecordSet recordSet = new RecordSet();
      
  	recordSet.executeSql("select * from HrmJobActivities where jobactivityname like   '%"+searchStr+"%'");
      while(recordSet.next()){
      	rsid.add(recordSet.getString("id"));
      	rsName.add(recordSet.getString("jobactivityname"));
      	rsSubId.add(recordSet.getString("jobgroupid"));
      }
      
  	recordSet = new RecordSet();
  	recordSet.executeSql("select * from HrmJobGroups where jobgroupname like   '%"+searchStr+"%'");
      while(recordSet.next()){
      	jcid.add(recordSet.getString("id"));
      	jcName.add(recordSet.getString("jobgroupname"));
      }
      
  	recordSet = new RecordSet();
      for(String subid : rsSubId){
  		recordSet.executeSql("select * from HrmJobGroups where id='"+subid+"'");
  		while(recordSet.next()){
  			if(!jcid.contains(recordSet.getString("id"))){
  		    	jcid.add(recordSet.getString("id"));
  		    	jcName.add(recordSet.getString("jobgroupname"));
  			}
      	}
      }
  	
  	
  	 Map<String,TreeNode> counMap = new HashMap<String,TreeNode>();
  	 
  	for(int n = 0;n<rsid.size();n++){
  		TreeNode counNode = new TreeNode();
      	counNode.setId(rsid.get(n));
      	counNode.setNodeid("province_"+rsid.get(n));
      	counNode.setPid(rsSubId.get(n));
  		counNode.setType("province");
  		counNode.setName(rsName.get(n));
  		counMap.put(""+rsSubId.get(n),counNode);
  	}
  	
  	for(int n = 0;n<jcid.size();n++){
  		TreeNode counNode = new TreeNode();
      	counNode.setId(jcid.get(n));
      	counNode.setNodeid("country_"+jcid.get(n));
      	counNode.setPid("0");
  		counNode.setType("country");
  		counNode.setName(jcName.get(n));
  		if(counMap.get(jcid.get(n)+"") != null){
     			counNode.setOpen("true");
        		counNode.AddChildren(counMap.get(jcid.get(n)+""));
  		}else{
     			counNode.setOpen("false");
  		}
          treeList.AddChildren(counNode);
  	}
  	return treeList;
  }
  
  
  public TreeNode getCountryTreeList(TreeNode companyTreeList, String subId, ArrayList selectedids, String isNoAccount, User user, String sqlwhere) throws Exception {
  	//getDepartTreeList(companyTreeList, subId, "0",selectedids,isNoAccount, user, sqlwhere);
  	
  	JobGroupsComInfo jc = new JobGroupsComInfo();
  	jc.setTofirstRow();
  	
   	while(jc.next()){
  		String id = jc.getJobGroupsid();
  		String name = jc.getJobGroupsname();
  		TreeNode jobGroupsNode = new TreeNode();
  		jobGroupsNode.setId(id);
  		jobGroupsNode.setNodeid("country_"+id);
  		jobGroupsNode.setPid(subId);
  		jobGroupsNode.setNocheck("N");
  		int childNum= hasChild(id);
  		if(childNum>0){
  			jobGroupsNode.setIsParent("true");
  			jobGroupsNode.setName(name+"("+childNum+")");
  		}else{
  			jobGroupsNode.setName(name);
  		}
  		jobGroupsNode.setType("country");
  		companyTreeList.AddChildren(jobGroupsNode);
   	
   	}
   	
  	return companyTreeList;
  }
  
  public TreeNode getProvinceTreeList(TreeNode departTreeList, String subId, ArrayList selectedids, String isNoAccount, User user, String sqlwhere) throws Exception {
  	JobActivitiesComInfo rs = new JobActivitiesComInfo();
  	rs.setTofirstRow();
     
      while (rs.next()) {
      	String curgroupid = rs.getJobgroupid();
      	if(!curgroupid.equals(subId))continue;
  
   		String name=rs.getJobActivitiesname();
   		String id = rs.getJobActivitiesid();
   		
          TreeNode jobActivitiesNode = new TreeNode();
          jobActivitiesNode.setNocheck("Y");
          jobActivitiesNode.setId(id);
          jobActivitiesNode.setNodeid("province_"+id);
          jobActivitiesNode.setPid(subId);
  		jobActivitiesNode.setName(name);
          jobActivitiesNode.setType("province");
         	departTreeList.AddChildren(jobActivitiesNode);
      }
  
        return departTreeList;
    }
  
  
  /**
   * \u6307\u5b9a\u8282\u70b9\u4e0b\u662f\u5426\u6709\u5b50\u8282\u70b9
   * @param type  com:\u5206\u90e8;dept:\u90e8\u95e8
   * @param id   \u8282\u70b9id
   * @return  boolean
   * @throws Exception
   */
  private int hasChild(String id) throws Exception {
  	int hasChild = 0;
  
    JobActivitiesComInfo rs = new JobActivitiesComInfo();
  	rs.setTofirstRow();
  	while (rs.next()) {
  		if (rs.getJobgroupid().equals(id))
  			hasChild++;
  	}
  	return hasChild;
  }
  

  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.hrm.resource.MutilResourceBrowser MutilResourceBrowser;
      MutilResourceBrowser = (weaver.hrm.resource.MutilResourceBrowser) pageContext.getAttribute("MutilResourceBrowser");
      if (MutilResourceBrowser == null) {
        MutilResourceBrowser = new weaver.hrm.resource.MutilResourceBrowser();
        pageContext.setAttribute("MutilResourceBrowser", MutilResourceBrowser);
      }
      weaver.hrm.companyvirtual.CompanyVirtualComInfo CompanyVirtualComInfo;
      CompanyVirtualComInfo = (weaver.hrm.companyvirtual.CompanyVirtualComInfo) pageContext.getAttribute("CompanyVirtualComInfo");
      if (CompanyVirtualComInfo == null) {
        CompanyVirtualComInfo = new weaver.hrm.companyvirtual.CompanyVirtualComInfo();
        pageContext.setAttribute("CompanyVirtualComInfo", CompanyVirtualComInfo);
      }
      weaver.hrm.company.CompanyComInfo CompanyComInfo;
      CompanyComInfo = (weaver.hrm.company.CompanyComInfo) pageContext.getAttribute("CompanyComInfo");
      if (CompanyComInfo == null) {
        CompanyComInfo = new weaver.hrm.company.CompanyComInfo();
        pageContext.setAttribute("CompanyComInfo", CompanyComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      
response.setHeader("cache-control", "no-cache");
response.setHeader("pragma", "no-cache");
response.setHeader("expires", "Mon 1 Jan 1990 00:00:00 GMT");
User user = HrmUserVarify.getUser (request , response) ;
if(user == null)  return ;

String id=Util.null2String(request.getParameter("id"));
if(id.equals("0")) id="";

String type=Util.null2String(request.getParameter("type"));
String virtualtype=Util.null2String(request.getParameter("virtualtype"));
String selectedids=Util.null2String(request.getParameter("selectedids"));
String alllevel=Util.null2String(request.getParameter("alllevel"));
String isNoAccount=Util.null2String(request.getParameter("isNoAccount"));
String sqlwhere=Util.null2String(request.getParameter("sqlwhere"));
String cmd=Util.null2String(request.getParameter("cmd"));
String searchStr=URLDecoder.decode(Util.null2String(request.getParameter("searchStr")),"UTF-8");

selectedids = MutilResourceBrowser.getExcludeSqlWhere(selectedids,alllevel,isNoAccount,user, sqlwhere);

ArrayList selectList = new ArrayList();
if(selectedids.length()>0){
	String[] tmp_selectedids = selectedids.split(",");
	for(String selectedid:tmp_selectedids){
		selectList.add(selectedid);
	}
}
JSONArray jObject = null;
TreeNode envelope=new TreeNode();
if(!searchStr.equals("")){
	TreeNode root1 = new TreeNode();
	String titleName=SystemEnv.getHtmlLabelNames("332,357",user.getLanguage());
	root1.setNodeid("country_"+0);
	root1.setName(titleName);
	root1.setId("0");
	root1.setOpen("true");
	root1.setTarget("_self"); 
  	//root1.setIcon("/images/treeimages/global_wev8.gif");
  	root1.setIconClose("y");
	root1.setType("country");
	//root.AddChildren(root1);
	try{
		getCountryTreeList(root1,searchStr);
		if(root1.getChildren().size() == 0){
			out.println("[]");
		}else{
		
			out.println(JSON.toJSONString(root1));
		}
	}catch(Exception e){
		e.printStackTrace();
	}
}else{
	if("".equals(id)){
		//\u521d\u59cb\u5316
		//TreeNode root = new TreeNode();
		TreeNode root1 = new TreeNode();
		//String companyname = CompanyComInfo.getCompanyname("1");
		String titleName=SystemEnv.getHtmlLabelNames("332,357",user.getLanguage());
		root1.setNodeid("country_"+0);
		root1.setName(titleName);
		root1.setId("0");
		root1.setOpen("true");
		root1.setTarget("_self"); 
	  	//root1.setIcon("/images/treeimages/global_wev8.gif");
	  	root1.setIconClose("y");
		root1.setType("country");
		//root.AddChildren(root1);
		getCountryTreeList(root1,"0",selectList,isNoAccount, user, sqlwhere);
		jObject = JSONArray.fromObject(root1);
	}  else if(!"".equals(id)){
		getProvinceTreeList(envelope,id,selectList,isNoAccount, user, sqlwhere);
		ArrayList<TreeNode> lsChild = envelope.getChildren();
		jObject = JSONArray.fromObject(lsChild);		
	}
	out.println(jObject.toString());
}

    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("hrm/jobactivities/indexTreeLeftXML.jsp"), -6114302151315138628L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string1;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n\r\n".toCharArray();
  }
}
