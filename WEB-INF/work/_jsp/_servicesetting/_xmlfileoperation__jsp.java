/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._servicesetting;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import java.util.*;
import weaver.hrm.*;
import weaver.systeminfo.*;
import weaver.general.*;
import weaver.workflow.action.*;
import ln.LN;
import weaver.hrm.settings.RemindSettings;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import weaver.workflow.workflow.TestWorkflowCheck;
import weaver.systeminfo.template.UserTemplate;
import weaver.systeminfo.setting.*;
import weaver.general.Util;
import weaver.interfaces.datasource.*;
import weaver.servicefiles.ResetXMLFileCache;
import weaver.interfaces.schedule.*;
import net.sf.json.JSONObject;
import org.quartz.CronExpression;

public class _xmlfileoperation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.conn.RecordSet rs1;
      rs1 = (weaver.conn.RecordSet) pageContext.getAttribute("rs1");
      if (rs1 == null) {
        rs1 = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs1", rs1);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet rs2;
      rs2 = (weaver.conn.RecordSet) pageContext.getAttribute("rs2");
      if (rs2 == null) {
        rs2 = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs2", rs2);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet RecordSet;
      RecordSet = (weaver.conn.RecordSet) pageContext.getAttribute("RecordSet");
      if (RecordSet == null) {
        RecordSet = new weaver.conn.RecordSet();
        pageContext.setAttribute("RecordSet", RecordSet);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.servicefiles.DataSourceXML DataSourceXML;
      DataSourceXML = (weaver.servicefiles.DataSourceXML) pageContext.getAttribute("DataSourceXML");
      if (DataSourceXML == null) {
        DataSourceXML = new weaver.servicefiles.DataSourceXML();
        pageContext.setAttribute("DataSourceXML", DataSourceXML);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.servicefiles.SMSXML SMSXML;
      SMSXML = (weaver.servicefiles.SMSXML) pageContext.getAttribute("SMSXML");
      if (SMSXML == null) {
        SMSXML = new weaver.servicefiles.SMSXML();
        pageContext.setAttribute("SMSXML", SMSXML);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.servicefiles.ActionXML ActionXML;
      ActionXML = (weaver.servicefiles.ActionXML) pageContext.getAttribute("ActionXML");
      if (ActionXML == null) {
        ActionXML = new weaver.servicefiles.ActionXML();
        pageContext.setAttribute("ActionXML", ActionXML);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.servicefiles.BrowserXML BrowserXML;
      BrowserXML = (weaver.servicefiles.BrowserXML) pageContext.getAttribute("BrowserXML");
      if (BrowserXML == null) {
        BrowserXML = new weaver.servicefiles.BrowserXML();
        pageContext.setAttribute("BrowserXML", BrowserXML);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.servicefiles.ScheduleXML ScheduleXML;
      ScheduleXML = (weaver.servicefiles.ScheduleXML) pageContext.getAttribute("ScheduleXML");
      if (ScheduleXML == null) {
        ScheduleXML = new weaver.servicefiles.ScheduleXML();
        pageContext.setAttribute("ScheduleXML", ScheduleXML);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.action.BaseAction BaseAction;
      BaseAction = (weaver.workflow.action.BaseAction) pageContext.getAttribute("BaseAction");
      if (BaseAction == null) {
        BaseAction = new weaver.workflow.action.BaseAction();
        pageContext.setAttribute("BaseAction", BaseAction);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      
User user = HrmUserVarify.getUser (request , response) ;

if(user == null)  return ;


String operation = Util.null2String(request.getParameter("operation"));
String isdialog = Util.null2String(request.getParameter("isdialog"));
String istest = "";
if(operation.equals("datasource")){
	if(!HrmUserVarify.checkUserRight("intergration:datasourcesetting", user)){
	    response.sendRedirect("/notice/noright.jsp");
	    return;
	}
    String method = Util.null2String(request.getParameter("method"));
	String from = Util.null2String(request.getParameter("from"));
    int dsnums = Util.getIntValue(Util.null2String(request.getParameter("dsnums")),0);
    if(method.equals("add")){
        Hashtable dataHST = new Hashtable();
        String pointid = Util.null2String(request.getParameter("datasource")).trim();
        if(pointid.equals("")){
            response.sendRedirect("datasourcesetting.jsp");
            return;
        }
        
    	String customid = Util.null2String(request.getParameter("customid"));
    	String typename = Util.null2String(request.getParameter("typename"));
        String dbtype = Util.null2String(request.getParameter("dbtype"));
        String iscluster = Util.null2String(request.getParameter("iscluster"));
        if("".equals(iscluster)) {
        	iscluster = "1";
        }
        String url = Util.null2String(request.getParameter("url"));
        String HostIP = Util.null2String(request.getParameter("HostIP"));
        String Port = Util.null2String(request.getParameter("Port"));
        String DBname = Util.null2String(request.getParameter("DBname"));
        String username = Util.null2String(request.getParameter("user"));
        String password = Util.null2String(request.getParameter("password"));
        String minconn = Util.null2String(request.getParameter("minconn"));
		if(minconn.equals("")) minconn = "5";
        String maxconn = Util.null2String(request.getParameter("maxconn"));
		if(maxconn.equals("")) maxconn = "10";
        String iscode = Util.null2String(request.getParameter("iscode"));
        
        if("1".equals(iscode))
        {
        	username = SecurityHelper.encrypt("ecology",username);
        	password = SecurityHelper.encrypt("ecology",password);
        }
        dataHST.put("type",dbtype);
        dataHST.put("datasourcename",pointid);
        dataHST.put("iscluster",iscluster);
        dataHST.put("url",url);
        dataHST.put("host",HostIP);
        dataHST.put("port",Port);
        dataHST.put("dbname",DBname);
        dataHST.put("user",username);
        dataHST.put("password",password);
        dataHST.put("minconn",minconn);
        dataHST.put("maxconn",maxconn);
        dataHST.put("iscode",iscode);
        dataHST.put("typename",typename);
        dataHST.put("customid",customid);
        
        DataSourceXML.writeToDataSourceXMLAdd(pointid,dataHST);
        if(!typename.equals(""))
        {
        	ResetXMLFileCache.resetCache();
	    	response.sendRedirect("/servicesetting/datasourcesettingnew.jsp?typename="+typename);
	    	return;
        }
    }else if(method.equals("edit")){
        ArrayList dspointids = new ArrayList();
        ArrayList dataHSTArr = new ArrayList();
        for(int i=0;i<dsnums;i++){
            Hashtable dataHST = new Hashtable();
            String pointid = Util.null2String(request.getParameter("datasource_"+i)).trim();
            String oldpointid = Util.null2String(request.getParameter("olddatasource_"+i));
            if(pointid.equals("")) continue;
    		
    		String typename = Util.null2String(request.getParameter("typename_"+i));
            String dbtype = Util.null2String(request.getParameter("dbtype_"+i));
            String iscluster = Util.null2String(request.getParameter("iscluster_"+i));
            if("".equals(iscluster)) {
            	iscluster = "1";
            }
            String url = Util.null2String(request.getParameter("url_"+i));
            String HostIP = Util.null2String(request.getParameter("HostIP_"+i));
            String Port = Util.null2String(request.getParameter("Port_"+i));
            String DBname = Util.null2String(request.getParameter("DBname_"+i));
            String username = Util.null2String(request.getParameter("user_"+i));
            String password = Util.null2String(request.getParameter("password_"+i));
            String minconn = Util.null2String(request.getParameter("minconn_"+i));
			if(minconn.equals("")) minconn = "5";
            String maxconn = Util.null2String(request.getParameter("maxconn_"+i));
			if(maxconn.equals("")) maxconn = "10";
            String iscode = Util.null2String(request.getParameter("iscode_"+i));
            
            if("1".equals(iscode))
	        {
	        	username = SecurityHelper.encrypt(SecurityHelper.KEY,username);
	        	password = SecurityHelper.encrypt(SecurityHelper.KEY,password);
	        }
        
            dataHST.put("type",dbtype);
            dataHST.put("datasourcename",pointid);
            dataHST.put("iscluster",iscluster);
        	dataHST.put("url",url);
            dataHST.put("host",HostIP);
            dataHST.put("port",Port);
            dataHST.put("dbname",DBname);
            dataHST.put("user",username);
            dataHST.put("password",password);
            dataHST.put("minconn",minconn);
            dataHST.put("maxconn",maxconn);
            dataHST.put("iscode",iscode);
            dataHST.put("typename",typename);
            
            dspointids.add(pointid);
            dataHSTArr.add(dataHST);
        }
        DataSourceXML.writeToDataSourceXMLEdit(dspointids,dataHSTArr);
        for(int i=0;i<dsnums;i++){
            String pointid = Util.null2String(request.getParameter("datasource_"+i)).trim();
            String oldpointid = Util.null2String(request.getParameter("olddatasource_"+i));
            if(pointid.equals("")||oldpointid.equals("")) continue;
            if(pointid.compareTo(oldpointid)!=0)
            {
            	DataSourceXML.updateDataSourceUsed(oldpointid,pointid);
            }
        }
    }else if(method.equals("delete")){
        for(int i=0;i<dsnums;i++){
            String isdel = Util.null2String(request.getParameter("del_"+i));
            if(isdel.equals("1")) {
                String pointid = Util.null2String(request.getParameter("datasource_"+i)).trim();
                if(pointid.equals("")) continue;
                rs1.execute("delete from datasourcesetting where pointid='"+pointid+"'");
            }
        }
    }
    else if(method.equals("test"))
    {
    	String dbtype = Util.null2String(request.getParameter("dbtype"));
        String iscluster = Util.null2String(request.getParameter("iscluster"));
        String url = Util.null2String(request.getParameter("url"));
        String HostIP = Util.null2String(request.getParameter("HostIP"));
        String Port = Util.null2String(request.getParameter("Port"));
        String DBname = Util.null2String(request.getParameter("DBname"));
        String username = Util.null2String(request.getParameter("user"));
        String password = Util.null2String(request.getParameter("password"));
        String minconn = Util.null2String(request.getParameter("minconn"));
		if(minconn.equals("")) minconn = "5";
        String maxconn = Util.null2String(request.getParameter("maxconn"));
		if(maxconn.equals("")) maxconn = "10";
        
		
		

        if("2".equals(iscluster)){
        	
        	String errormsg="";
        	if(dbtype.toLowerCase().contains("mysql")){
           		 if(!url.toLowerCase().contains("mysql")){
           				 errormsg="7";
           		    	 out.print(errormsg);
         			return;
           		 }

        		 }if(dbtype.toLowerCase().contains("oracle")){
           		 if(!url.toLowerCase().contains("oracle")){
           				 errormsg="7";
           				 out.print(errormsg);
         			return;
           		 }

        		 }
        		 if(dbtype.toLowerCase().contains("sqlserver")){
           		 if(!url.toLowerCase().contains("sqlserver")){
           				 errormsg="7";
           				 out.print(errormsg);
           		    	// System.out.println(errormsg);
        			return;
           		 }

        		 }
        }
        	
		
		
        BaseDataSource BaseDataSource = new BaseDataSource();
        BaseDataSource.setType(dbtype);
        BaseDataSource.setUrl(url);
        BaseDataSource.setHost(HostIP);
        BaseDataSource.setPort(Port);
        BaseDataSource.setDbname(DBname);
        
        BaseDataSource.setUser(username);
        BaseDataSource.setPassword(password);
        BaseDataSource.setIscluster(iscluster);
        //System.out.println("dbtype : "+dbtype+" url : "+url+" HostIP : "+HostIP+" Port : "+Port+" DBname : "+DBname);
        istest = ""+BaseDataSource.testDataSource();
    }
	else if(method.equals("getDataSourceUsed")){//\u83b7\u53d6\u6570\u636e\u6e90\u5df2\u88ab\u4f7f\u7528\u60c5\u51b5
		String pointid = Util.null2String(request.getParameter("pointid"));
		//System.out.println("operation="+operation+", method="+method);
		String datasourceused = Util.null2String(DataSourceXML.getDataSourceUsed(pointid,user)).trim();
		datasourceused = "{\"datasourceused\":\""+datasourceused+"\"}";
		out.print(datasourceused);
		//System.out.println("datasourceused: "+datasourceused);
		return;
	}
	
    if(method.equals("test"))
    {
    	out.print(istest);
    }
    else
    {
	    ResetXMLFileCache.resetCache();
	    if("1".equals(isdialog))
	    {
	    
      out.write(_jsp_string2, 0, _jsp_string2.length);
      out.print((from));
      out.write(_jsp_string3, 0, _jsp_string3.length);
      
	    }
	    else
	    	response.sendRedirect("datasourcesetting.jsp");
    }
}else if(operation.equals("sms")){
    String interfacetype = Util.null2String(request.getParameter("interfacetype"));
    String constructclass = Util.null2String(request.getParameter("constructclass"));
    ArrayList propertyArr = new ArrayList();
    ArrayList valueArr = new ArrayList();
    if(interfacetype.equals("1")){//\u901a\u7528\u77ed\u4fe1\u63a5\u53e3
        constructclass = "weaver.sms.JdbcSmsService";
        String type = Util.null2String(request.getParameter("type"));
        String host = Util.null2String(request.getParameter("host"));
        String port = Util.null2String(request.getParameter("port"));
        String dbname = Util.null2String(request.getParameter("dbname"));
        String username = Util.null2String(request.getParameter("username"));
        String password = Util.null2String(request.getParameter("password"));
        String sql = Util.null2String(request.getParameter("sql"));
        propertyArr.add("type");
        propertyArr.add("host");
        propertyArr.add("port");
        propertyArr.add("dbname");
        propertyArr.add("username");
        propertyArr.add("password");
        propertyArr.add("sql");
        
        valueArr.add(type);
        valueArr.add(host);
        valueArr.add(port);
        valueArr.add(dbname);
        valueArr.add(username);
        valueArr.add(password);
        valueArr.add(sql);
        
    }else{//\u81ea\u5b9a\u4e49\u77ed\u4fe1\u63a5\u53e3
        int propertynum = Util.getIntValue(Util.null2String(request.getParameter("propertynum")),0);
        for(int i=1;i<=propertynum;i++){
            String propertyS = Util.null2String(request.getParameter("property_"+i));
            if(propertyS.equals("")) continue;
            String valueS = Util.null2String(request.getParameter("value_"+i));
            propertyArr.add(propertyS);
            valueArr.add(valueS);
        }
    }
    
   	SMSXML.writeToSMSXML(constructclass,propertyArr,valueArr);
    
    ResetXMLFileCache.resetCache();
    
    response.sendRedirect("smssetting.jsp");
}else if(operation.equals("action")){
	if(!HrmUserVarify.checkUserRight("intergration:formactionsetting", user)){
	    response.sendRedirect("/notice/noright.jsp");
	    return;
	}
	String errormsg = "";
    String method = Util.null2String(request.getParameter("method"));
    if(method.equals("add")){
        String actionid = Util.null2String(request.getParameter("actionid"));
        String oldactionid = Util.null2String(request.getParameter("oldactionid"));
        if(actionid.equals("")){
            response.sendRedirect("/integration/formactionlist.jsp");
            return;
        }
        String id = Util.null2String(request.getParameter("id"));
        String classname = Util.null2String(request.getParameter("classname"));
        String actionname = Util.null2String(request.getParameter("actionname"));
        String[] fieldnames = request.getParameterValues("fieldname");
        String[] fieldvalues = request.getParameterValues("fieldvalue");
        String[] isdatasources = request.getParameterValues("isdatasource");
        //QC274140 start [80][90]\u6d41\u7a0b\u6d41\u8f6c\u96c6\u6210-\u81ea\u5b9a\u4e49\u63a5\u53e3\u5f39\u51fa\u7a97\u53e3\u6309Backspace\u4f1a\u91cd\u590d\u63d2\u5165\u4e00\u6761\u6570\u636e
        int reallyid = Util.getIntValue(id,0);
        String Chinese_PRC_CS_AS_WS = " ";
        if(RecordSet.getDBType().toLowerCase().indexOf("sqlserver") > -1) {
            Chinese_PRC_CS_AS_WS = " collate Chinese_PRC_CS_AS_WS ";
        }
        String sql = "select 1 from actionsetting where actionname " + Chinese_PRC_CS_AS_WS + " = '" + actionid + "' ";
        if(reallyid > 0) {
            sql += " and id <> " + reallyid;
        }
        RecordSet.executeSql(sql);
        if(RecordSet.getCounts() > 0) {
            if("1".equals(isdialog)) {
    
      out.write(_jsp_string4, 0, _jsp_string4.length);
      
            }
            return;
        }
     //QC274140 end [80][90]\u6d41\u7a0b\u6d41\u8f6c\u96c6\u6210-\u81ea\u5b9a\u4e49\u63a5\u53e3\u5f39\u51fa\u7a97\u53e3\u6309Backspace\u4f1a\u91cd\u590d\u63d2\u5165\u4e00\u6761\u6570\u636e


        //System.out.println("actionid : "+actionid+"  classname : "+classname+" fieldnames : "+fieldnames+"  fieldvalues : "+fieldvalues);
        ActionXML.writeToActionXMLAdd(oldactionid,actionname,actionid,classname,fieldnames,fieldvalues,isdatasources);
        id = ActionXML.updateAction(actionname,id,actionid,classname,fieldnames,fieldvalues);
        ResetXMLFileCache.resetCache();
        String workflowid = Util.null2String(request.getParameter("workflowid"));
        String nodeid = Util.null2String(request.getParameter("nodeid"));
        String nodelinkid = Util.null2String(request.getParameter("nodelinkid"));
        String ispreoperator = Util.null2String(request.getParameter("ispreoperator"));
        if(!"".equals(workflowid))
        {
	        WorkflowActionManager workflowActionManager = new WorkflowActionManager();
	        workflowActionManager.setActionid(0);
			workflowActionManager.setWorkflowid(Util.getIntValue(workflowid));
			workflowActionManager.setNodeid(Util.getIntValue(nodeid));
			workflowActionManager.setActionorder(0);
			workflowActionManager.setNodelinkid(Util.getIntValue(nodelinkid));
			workflowActionManager.setIspreoperator(Util.getIntValue(ispreoperator));
			workflowActionManager.setActionname(actionname);
			workflowActionManager.setInterfaceid(actionname);
			workflowActionManager.setInterfacetype(3);
			workflowActionManager.setIsused(1);
			workflowActionManager.doSaveWsAction();
		
        }
    	if("1".equals(isdialog))
	    {
			//System.out.println("isdialog : "+isdialog);
	    
      out.write(_jsp_string5, 0, _jsp_string5.length);
      
	    }else{
        response.sendRedirect("/servicesetting/actionsettingnew.jsp?urlType=24&isdialog="+isdialog+"&typename=&backto=&fromintegration=1&actionid="+id);
	    }
	    return;
    }else if(method.equals("edit")){
        int atnums = Util.getIntValue(Util.null2String(request.getParameter("atnums")),0);
        ArrayList actionids = new ArrayList();
        ArrayList dataHSTArr = new ArrayList();
        ArrayList datafieldArr = new ArrayList();
        ArrayList datavalueArr = new ArrayList();
        for(int i=0;i<atnums;i++){
            String actionid = Util.null2String(request.getParameter("actionid_"+i));
            if(actionid.equals("")) continue;
            String classname = Util.null2String(request.getParameter("classname_"+i));
            String[] fieldnames = request.getParameterValues("fieldname_"+i);
            String[] fieldvalues = request.getParameterValues("fieldvalue_"+i);
            Hashtable dataHST = new Hashtable();
            dataHST.put("classname",classname);
            
            actionids.add(actionid);
            dataHSTArr.add(dataHST);
            datafieldArr.add(fieldnames);
            datavalueArr.add(fieldvalues);
        }
        ActionXML.writeToActionXMLEdit(actionids,dataHSTArr,datafieldArr,datavalueArr);
		ResetXMLFileCache.resetCache();
		
		if("1".equals(isdialog))
		{
		
      out.write(_jsp_string6, 0, _jsp_string6.length);
      
		}
		return;
    }else if(method.equals("delete")){
        int atnums = Util.getIntValue(Util.null2String(request.getParameter("atnums")),0);
        ArrayList actionids = new ArrayList();
        ArrayList dataHSTArr = new ArrayList();
        ArrayList datafieldArr = new ArrayList();
        ArrayList datavalueArr = new ArrayList();
        for(int i=0;i<atnums;i++){
            String isdel = Util.null2String(request.getParameter("del_"+i));
            if(isdel.equals("1")) continue;
            String actionid = Util.null2String(request.getParameter("actionid_"+i));
            if(actionid.equals("")) continue;
            
            actionids.add(actionid);
        }
        ActionXML.writeToActionXMLEdit(actionids);
		ResetXMLFileCache.resetCache();
    }
    else if(method.equals("deletesingle")){
    	String id = Util.null2String(request.getParameter("actionid"));
    	if(Util.getIntValue(id,0)>0)
    	{
    		String pointid = "";
    		String sql = "select * from actionsetting where id="+id;
    		rs1.executeSql(sql);
    		if(rs1.next())
    		{
    			pointid = rs1.getString("actionname");
    		}
    		if(!"".equals(pointid))
    		{
    			boolean isused = BaseAction.checkFromActionUsed(""+pointid,"3");
        		if(!isused)
        		{
	    			rs1.executeSql("delete from actionsetting where id="+id);
					rs1.executeSql("delete from actionsettingdetail where actionid="+id);
		    		//ActionXML.writeToActionXMLDelete(pointid);/*QC331430 [80][90][\u7f3a\u9677]\u6d41\u7a0b\u6d41\u8f6c\u96c6\u6210-\u89e3\u51b3\u5220\u9664\u81ea\u5b9a\u4e49\u63a5\u53e3\u65f6\u6709\u5bf9action.xml\u8fdb\u884c\u64cd\u4f5c\u7684\u95ee\u9898*/
					ResetXMLFileCache.resetCache();
        		}
        		else
        		{
        			errormsg = "1";
        		}
    		}
    	}
        response.sendRedirect("/integration/formactionlist.jsp");
        return;
    }
    else if(method.equals("deletesingle1")){
    	String actionid = Util.null2String(request.getParameter("actionid"));
    	if(!"".equals(actionid))
    	{
    		boolean isused = BaseAction.checkFromActionUsed(""+actionid,"3");
    		if(!isused)
    		{
	    		String id = "";
	    		String sql = "select * from actionsetting where actionname='"+actionid+"'";
	    		rs1.executeSql(sql);
	    		if(rs1.next())
	    		{
	    			id = rs1.getString("id");
	    		}
	    		if(!"".equals(id))
	    		{
	    			rs1.executeSql("delete from actionsetting where id="+id);
	    			rs1.executeSql("delete from actionsettingdetail where actionid="+id);
		    		//ActionXML.writeToActionXMLDelete(actionid);/*QC331430 [80][90][\u7f3a\u9677]\u6d41\u7a0b\u6d41\u8f6c\u96c6\u6210-\u89e3\u51b3\u5220\u9664\u81ea\u5b9a\u4e49\u63a5\u53e3\u65f6\u6709\u5bf9action.xml\u8fdb\u884c\u64cd\u4f5c\u7684\u95ee\u9898*/
					ResetXMLFileCache.resetCache();
	    		}
    		}
    		else
    		{
    			errormsg = "1";
    		}
    	}
        
    }
    out.println("<script language=javascript>var parentWin = parent.parent.getParentWindow(parent);parentWin.doRefresh();setTimeout(top.Dialog.close,2);</script>");
}else if(operation.equals("browser")){
	if(!HrmUserVarify.checkUserRight("intergration:datashowsetting", user)){
	    response.sendRedirect("/notice/noright.jsp");
	    return;
	}
    String method = Util.null2String(request.getParameter("method"));
    if(method.equals("add")){
        String browserid = Util.null2String(request.getParameter("browserid"));
        String oldbrowserid = Util.null2String(request.getParameter("oldbrowserid"));
        String customid = Util.null2String(request.getParameter("customid"));//\u8868\u5355\u5efa\u6a21\u4e2d\u5bf9\u5e94\u6d4f\u89c8\u6846id
        
        String name = Util.null2String(request.getParameter("name"));
        String typename = Util.null2String(request.getParameter("typename"));
        if(browserid.equals("") || "".equals(name)){
            response.sendRedirect("browsersetting.jsp");
            return;
        }
        String ds = "datasource."+Util.null2String(request.getParameter("ds"));
        if("".equals(Util.null2String(request.getParameter("ds"))))
        {
        	ds = "";
        }
        String search = Util.null2String(request.getParameter("search"));
        String searchById = Util.null2String(request.getParameter("searchById"));
        String searchByName = Util.null2String(request.getParameter("searchByName"));
        String nameHeader = Util.null2String(request.getParameter("nameHeader"));
        String descriptionHeader = Util.null2String(request.getParameter("descriptionHeader"));
        String outPageURL = Util.null2String(request.getParameter("outPageURL"));
        String from = Util.null2String(request.getParameter("from"));
        String href = Util.null2String(request.getParameter("href"));
        String showtree = Util.null2String(request.getParameter("showtree"));
        String nodename = Util.null2String(request.getParameter("nodename"));
        String parentid = Util.null2String(request.getParameter("parentid"));
        String ismutil = Util.null2String(request.getParameter("ismutil"));
        
        Hashtable dataHST = new Hashtable();
        dataHST.put("ds",ds);
        dataHST.put("search",search);
        dataHST.put("searchById",searchById);
        dataHST.put("searchByName",searchByName);
        dataHST.put("nameHeader",nameHeader);
        dataHST.put("descriptionHeader",descriptionHeader);
        dataHST.put("outPageURL",outPageURL);
        dataHST.put("from",from);
        dataHST.put("href",href);
        dataHST.put("showtree",showtree);
        dataHST.put("nodename",nodename);
        dataHST.put("parentid",parentid);
        dataHST.put("ismutil",ismutil);
        dataHST.put("name",name);
        dataHST.put("customid",customid);
        
        BrowserXML.writeToBrowserXMLAdd(browserid,dataHST);
       	ResetXMLFileCache.resetCache();
       	
       	BrowserXML.updateData(browserid);
       	boolean isused = BrowserXML.isUsed(oldbrowserid,"1","1");
        if(isused)
        {
        	BrowserXML.updateUseField(""+oldbrowserid,"1","1",browserid,"1","1");
        }
    	
		if("1".equals(isdialog))
		{
		
      out.write(_jsp_string7, 0, _jsp_string7.length);
      out.print((typename));
      out.write(_jsp_string8, 0, _jsp_string8.length);
      
		}else{
			response.sendRedirect("/integration/WsShowEditSetList.jsp?typename="+typename);
		}
    	return;
    }else if(method.equals("edit")){
		String typename = Util.null2String(request.getParameter("typename"));
        int bsnums = Util.getIntValue(Util.null2String(request.getParameter("bsnums")),0);
        ArrayList browserids = new ArrayList();
        ArrayList dataHSTArr = new ArrayList();
        for(int i=0;i<bsnums;i++){
            String browserid = Util.null2String(request.getParameter("browserid_"+i));
            if(browserid.equals("")) continue;
            String ds = "datasource."+Util.null2String(request.getParameter("ds_"+i));
	        if("".equals(Util.null2String(request.getParameter("ds_"+i))))
	        {
	        	ds = "";
	        }
            String search = Util.null2String(request.getParameter("search_"+i));
            String searchById = Util.null2String(request.getParameter("searchById_"+i));
            String searchByName = Util.null2String(request.getParameter("searchByName_"+i));
            String nameHeader = Util.null2String(request.getParameter("nameHeader_"+i));
            String descriptionHeader = Util.null2String(request.getParameter("descriptionHeader_"+i));
            String outPageURL = Util.null2String(request.getParameter("outPageURL_"+i));
            String from = Util.null2String(request.getParameter("from_"+i));
            String href = Util.null2String(request.getParameter("href_"+i));
            
            String showtree = Util.null2String(request.getParameter("showtree_"+i));
            String nodename = Util.null2String(request.getParameter("nodename_"+i));
            String parentid = Util.null2String(request.getParameter("parentid_"+i));
            String ismutil = Util.null2String(request.getParameter("ismutil_"+i));
    
            Hashtable dataHST = new Hashtable();
            dataHST.put("ds",ds);
            dataHST.put("search",search);
            dataHST.put("searchById",searchById);
            dataHST.put("searchByName",searchByName);
            dataHST.put("nameHeader",nameHeader);
            dataHST.put("descriptionHeader",descriptionHeader);
            dataHST.put("outPageURL",outPageURL);
            dataHST.put("from",from);
            dataHST.put("href",href);
            dataHST.put("showtree",showtree);
        	dataHST.put("nodename",nodename);
        	dataHST.put("parentid",parentid);
        	dataHST.put("ismutil",ismutil);
            
            browserids.add(browserid);
            dataHSTArr.add(dataHST);
            
        }
        BrowserXML.writeToBrowserXMLEdit(browserids,dataHSTArr);
		if("1".equals(isdialog))
		{
		
      out.write(_jsp_string7, 0, _jsp_string7.length);
      out.print((typename));
      out.write(_jsp_string8, 0, _jsp_string8.length);
      
		}else{
			response.sendRedirect("/integration/WsShowEditSetList.jsp?typename="+typename);
		}
    	return;
    }else if(method.equals("delete")){
        int bsnums = Util.getIntValue(Util.null2String(request.getParameter("bsnums")),0);
        ArrayList browserids = new ArrayList();
        ArrayList dataHSTArr = new ArrayList();
        for(int i=0;i<bsnums;i++){
            String isdel = Util.null2String(request.getParameter("del_"+i));
            if(isdel.equals("1")) continue;
            String browserid = Util.null2String(request.getParameter("browserid_"+i));
            if(browserid.equals("")) continue;
            String ds = "datasource."+Util.null2String(request.getParameter("ds_"+i));
            if("".equals(Util.null2String(request.getParameter("ds_"+i))))
	        {
	        	ds = "";
	        }
            String search = Util.null2String(request.getParameter("search_"+i));
            String searchById = Util.null2String(request.getParameter("searchById_"+i));
            String searchByName = Util.null2String(request.getParameter("searchByName_"+i));
            String nameHeader = Util.null2String(request.getParameter("nameHeader_"+i));
            String descriptionHeader = Util.null2String(request.getParameter("descriptionHeader_"+i));
            String outPageURL = Util.null2String(request.getParameter("outPageURL_"+i));
            String from = Util.null2String(request.getParameter("from_"+i));
            String href = Util.null2String(request.getParameter("href_"+i));
            String showtree = Util.null2String(request.getParameter("showtree_"+i));
            String nodename = Util.null2String(request.getParameter("nodename_"+i));
            String parentid = Util.null2String(request.getParameter("parentid_"+i));
            String ismutil = Util.null2String(request.getParameter("ismutil_"+i));
    
            Hashtable dataHST = new Hashtable();
            dataHST.put("ds",ds);
            dataHST.put("search",search);
            dataHST.put("searchById",searchById);
            dataHST.put("searchByName",searchByName);
            dataHST.put("nameHeader",nameHeader);
            dataHST.put("descriptionHeader",descriptionHeader);
            dataHST.put("outPageURL",outPageURL);
            dataHST.put("from",from);
            dataHST.put("href",href);
            dataHST.put("showtree",showtree);
        	dataHST.put("nodename",nodename);
        	dataHST.put("parentid",parentid);
        	dataHST.put("ismutil",ismutil);
            
            browserids.add(browserid);
            dataHSTArr.add(dataHST);
        }
        BrowserXML.writeToBrowserXMLEdit(browserids,dataHSTArr);
    }
    else if(method.equals("deletesingle"))
    {
    	String typename = Util.null2String(request.getParameter("typename"));
    	String browserid = Util.null2String(request.getParameter("browserid"));
    	String SQL = "delete from datashowset where showname='"+browserid+"'";
		rs1.executeSql(SQL);
    	BrowserXML.writeToBrowserXMLDel(browserid);
    	ResetXMLFileCache.resetCache();
    	
		if("1".equals(isdialog))
		{
		
      out.write(_jsp_string7, 0, _jsp_string7.length);
      out.print((typename));
      out.write(_jsp_string8, 0, _jsp_string8.length);
      
		}else{
			response.sendRedirect("/integration/WsShowEditSetList.jsp?typename="+typename);
		}
    	return;
    }
    response.sendRedirect("browsersetting.jsp");
}else if(operation.equals("schedule")){
	if(!HrmUserVarify.checkUserRight("intergration:schedulesetting", user)){
	    response.sendRedirect("/notice/noright.jsp");
	    return;
	}
    String method = Util.null2String(request.getParameter("method"));
    String scheduleStaticKey = "schedule.";
    if(method.equals("add")){
        String scheduleid = Util.null2String(request.getParameter("scheduleid")).trim();
        if(scheduleid.equals("")){
            response.sendRedirect("schedulesetting.jsp");
            return;
        }
        String ClassName = Util.null2String(request.getParameter("ClassName"));
        String CronExpr = Util.null2String(request.getParameter("CronExpr"));
        Hashtable dataHST = new Hashtable();
        dataHST.put("construct",ClassName);
        dataHST.put("cronExpr",CronExpr);
        
        ScheduleXML.writeToScheduleXMLAdd(scheduleid,dataHST);
        ScheduleManage.addJob(scheduleStaticKey+scheduleid,CronExpr);//\u89e6\u53d1\u65b0\u589e\u7684\u8ba1\u5212\u4efb\u52a1
    }else if(method.equals("edit")){
        int sdnums = Util.getIntValue(Util.null2String(request.getParameter("sdnums")),0);
        ArrayList scheduleids = new ArrayList();
        ArrayList dataHSTArr = new ArrayList();
        for(int i=0;i<sdnums;i++){
            String scheduleid = Util.null2String(request.getParameter("scheduleid_"+i)).trim();
            if(scheduleid.equals("")) continue;
            String ClassName = Util.null2String(request.getParameter("ClassName_"+i));
            String CronExpr = Util.null2String(request.getParameter("CronExpr_"+i));
            Hashtable dataHST = new Hashtable();
            dataHST.put("construct",ClassName);
            dataHST.put("cronExpr",CronExpr);
            
            scheduleids.add(scheduleid);
            dataHSTArr.add(dataHST);
            
	    	CronJob job = (CronJob) StaticObj.getServiceByFullname(scheduleStaticKey+scheduleid, CronJob.class);
	    	//1:\u4fee\u6539\u4e86\u8ba1\u5212\u4efb\u52a1\u6807\u8bc6
	    	if(null == job){
	    		ScheduleManage.addJob(scheduleStaticKey+scheduleid,CronExpr);//\u6267\u884c\u89e6\u53d1\u65b0\u6807\u8bc6\u540d\u79f0\u7684\u8ba1\u5212\u4efb\u52a1
	    	}
	    	//2:\u53ea\u4fee\u6539\u4e86\u89e6\u53d1\u65f6\u95f4
	    	else if(!CronExpr.equals(job.getCronExpr())){
	    		ScheduleManage.modifyJobTime(scheduleStaticKey+scheduleid,CronExpr);//\u6267\u884c\u66f4\u65b0\u8ba1\u5212\u4efb\u52a1\u89e6\u53d1\u65f6\u95f4
	    	}
        }
        ScheduleXML.writeToScheduleXMLEdit(scheduleids,dataHSTArr);
        
        
        	//3:\u5220\u9664\u5f03\u7528\u8ba1\u5212\u4efb\u52a1\u6807\u793a\u7684\u5bf9\u5e94\u7684\u8ba1\u5212\u4efb\u52a1
        	List l = StaticObj.getServiceIds(CronJob.class);
			for (int i = 0; i < l.size(); i++) {
				String schedulename = ((String) l.get(i)).replace(scheduleStaticKey,"");//\u8001\u7684\u7f13\u5b58\u7684\u8ba1\u5212\u4efb\u52a1\u6807\u793a\u540d\u79f0
				if(!scheduleids.contains(schedulename)){
					ScheduleManage.removeJob(scheduleStaticKey+schedulename);//\u6267\u884c\u79fb\u9664\u6267\u884c\u7684\u8ba1\u5212\u4efb\u52a1
				}
			}
        
    }else if(method.equals("delete")){
        int sdnums = Util.getIntValue(Util.null2String(request.getParameter("sdnums")),0);
        ArrayList scheduleids = new ArrayList();
        //ArrayList dataHSTArr = new ArrayList();
        
        for(int i=0;i<sdnums;i++){
            String isdel = Util.null2String(request.getParameter("del_"+i));
            if(isdel.equals("1")) {
                String scheduleid = Util.null2String(request.getParameter("scheduleid_"+i)).trim();
                scheduleids.add(scheduleid);
	            ScheduleManage.removeJob(scheduleStaticKey+scheduleid);//\u6267\u884c\u79fb\u9664\u6267\u884c\u7684\u8ba1\u5212\u4efb\u52a1
            }
            /*
            String scheduleid = Util.null2String(request.getParameter("scheduleid_"+i));
            if(scheduleid.equals("")) continue;
            String ClassName = Util.null2String(request.getParameter("ClassName_"+i));
            String CronExpr = Util.null2String(request.getParameter("CronExpr_"+i));
            Hashtable dataHST = new Hashtable();
            dataHST.put("construct",ClassName);
            dataHST.put("cronExpr",CronExpr);
            
            scheduleids.add(scheduleid);
            dataHSTArr.add(dataHST);*/
        }
        ScheduleXML.deleteSchedule(scheduleids);
    }
    else if(method.equals("checkSchedule")){
    	String[] clasz = request.getParameterValues("clasz[]");
    	String[] cron = request.getParameterValues("cron[]");
    	
    	
    	StringBuffer msg = new StringBuffer();
    	Map map = new HashMap();
    	map.put("ok",true);
    	
    	String di =	SystemEnv.getHtmlLabelName(15323,user.getLanguage());
    	String hang =	SystemEnv.getHtmlLabelName(27592,user.getLanguage());
    	String fei =	SystemEnv.getHtmlLabelName(33614,user.getLanguage());
    	String lei =	SystemEnv.getHtmlLabelName(33615,user.getLanguage());
    	String shili =	SystemEnv.getHtmlLabelName(33617,user.getLanguage());
    	String crons =	SystemEnv.getHtmlLabelName(33613,user.getLanguage());
    	
    	
    	for (int i=0;i<clasz.length;i++){
    		String h = clasz.length==1?"":di+(i+1)+hang;
    		
    		try{
    			Class claz = Class.forName(clasz[i]);
        		Object object = claz.newInstance();
        		if(!((object instanceof BaseCronJob) || (object instanceof CronJob))){
        			map.put("ok",false);
        			msg.append(h);
        			msg.append(fei);
        			msg.append(BaseCronJob.class.getName());
        			msg.append(lei.substring(0, lei.length()-1));
        			msg.append("\uff1b\u4e5f\u672a\u5b9e\u73b0weaver.interfaces.schedule.CronJob\u63a5\u53e3");
        			msg.append("\n");
        		}
    		}catch(Throwable e){
    			map.put("ok",false);
    			msg.append(h);
    			msg.append(shili);
    			msg.append("\n");
    		}
    		
    	  boolean falg = CronExpression.isValidExpression(cron[i]);
    	  if(!falg){
    		map.put("ok",false);
    		msg.append(h);
    		msg.append(crons);
  			msg.append("\n");
    	  }
    	  
    	}
    	map.put("msg",msg.toString());
       
    //	out.clear();
    //	out.write(JSONObject.fromObject(map).toString());
    //	out.close();   	
  	  out.print(JSONObject.fromObject(map).toString());
    	return ;
    }
    ResetXMLFileCache.resetCache();
    if("1".equals(isdialog))
    {
    
      out.write(_jsp_string9, 0, _jsp_string9.length);
      
    }
    else
    	response.sendRedirect("schedulesetting.jsp");
}

    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("servicesetting/XMLFileOperation.jsp"), 1716624668849289651L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string6;
  private final static char []_jsp_string3;
  private final static char []_jsp_string7;
  private final static char []_jsp_string2;
  private final static char []_jsp_string9;
  private final static char []_jsp_string5;
  private final static char []_jsp_string8;
  private final static char []_jsp_string0;
  private final static char []_jsp_string1;
  private final static char []_jsp_string4;
  static {
    _jsp_string6 = "\r\n		<script language=javascript >\r\n		try\r\n		{\r\n			var parentWin = parent.parent.getParentWindow(parent);\r\n			parentWin.location.href=\"/integration/formactionlist.jsp\";\r\n			parentWin.closeDialog();\r\n		}\r\n		catch(e)\r\n		{\r\n		}\r\n		</script>\r\n		".toCharArray();
    _jsp_string3 = "\"){\r\n				parentWin.closeRefDialog();\r\n			}else{\r\n				parentWin.location.href=\"/servicesetting/datasourcesetting.jsp\";\r\n				parentWin.closeDialog();\r\n			}\r\n		}\r\n		catch(e)\r\n		{\r\n		}\r\n		</script>\r\n	    ".toCharArray();
    _jsp_string7 = "\r\n		<script language=javascript >\r\n		try\r\n		{\r\n			var parentWin = parent.parent.getParentWindow(parent);\r\n			parentWin.location.href=\"/integration/WsShowEditSetList.jsp?typename=".toCharArray();
    _jsp_string2 = "\r\n	    <script language=javascript >\r\n	    try\r\n	    {\r\n			//var parentWin = parent.getParentWindow(window);\r\n			var parentWin = parent.parent.getParentWindow(parent);\r\n			if(\"sms\"==\"".toCharArray();
    _jsp_string9 = "\r\n    <script language=javascript >\r\n    try\r\n    {\r\n		var parentWin = parent.parent.getParentWindow(parent);\r\n		parentWin.location.href=\"/servicesetting/schedulesetting.jsp\";\r\n		parentWin.closeDialog();\r\n	}\r\n	catch(e)\r\n	{\r\n	}\r\n	</script>\r\n    ".toCharArray();
    _jsp_string5 = "\r\n	    <script language=javascript >\r\n	    try\r\n	    {\r\n			var parentWin = parent.parent.getParentWindow(parent);\r\n			parentWin.doRefresh();\r\n			setTimeout(top.Dialog.close,2);\r\n		}\r\n		catch(e)\r\n		{\r\n		}\r\n		  try\r\n		    {\r\n				var parentWin = parent.parent.getParentWindow(parent);\r\n				parentWin.closeDialogAction();\r\n				parentWin.reloadDMLAtion();\r\n			}\r\n			catch(e)\r\n			{}\r\n		</script>\r\n	    ".toCharArray();
    _jsp_string8 = "\";\r\n			parentWin.closeDialog();\r\n		}\r\n		catch(e)\r\n		{\r\n			console.error(e);\r\n		}\r\n		</script>\r\n		".toCharArray();
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
    _jsp_string4 = "\r\n            <script language=javascript >\r\n                try {\r\n                    var parentWin = parent.parent.getParentWindow(parent);\r\n                    parentWin.location.href = \"/integration/formactionlist.jsp\";\r\n                    var dialog = parent.parent.getDialog(parent);\r\n                    dialog.close();\r\n                } catch(e) {\r\n                    \r\n                }\r\n            </script>\r\n    ".toCharArray();
  }
}
