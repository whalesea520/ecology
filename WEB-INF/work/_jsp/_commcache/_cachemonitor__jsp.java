/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._commcache;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import javax.servlet.http.*;
import javax.servlet.*;
import java.io.*;
import java.util.*;
import weaver.monitor.cache.monitor.*;
import weaver.monitor.cache.Util.*;
import weaver.monitor.cache.*;

public class _cachemonitor__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=GBK");
    request.setCharacterEncoding("GBK");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      
String title = "";
String cacheStr = "";
String logStr = "";
String logUpdateStr = "";
String cacheParam = "";
String logParam ="";
String logUpdateParam ="";

String cache = request.getParameter("isCache"); 
String log = request.getParameter("islog"); 
String cacheparam = request.getParameter("cachelevel"); 
String urlskey = "";
String searchkey = request.getParameter("searchkey"); 
if(searchkey == null){
	searchkey = "";
}else {
	urlskey = "&searchkey="+searchkey.toLowerCase();
}

String isreload = request.getParameter("isreload"); 

if(isreload != null && "1".equals(isreload)){
	CacheFactory.getInstance().reset();
}







if("1".equals(cache)){
	ConfigMap.update("iscache","1");
}else if("0".equals(cache)){
	ConfigMap.update("iscache","0");
	CacheFactory.getInstance().clear();
}

if("1".equals(cacheparam)){
	ConfigMap.update("cachelevel","1");
}else if("2".equals(cacheparam)){
	ConfigMap.update("cachelevel","2");
}else if("3".equals(cacheparam)){
	ConfigMap.update("cachelevel","3");
	CacheFactory.getInstance().clearCacheMap();
}
String cachelevel = ConfigMap.get("cachelevel");
	String isCache = ConfigMap.get("iscache");
	if("1".equals(isCache)){
		title = "\u7f13\u5b58\u5df2\u5f00\u542f";
		cacheStr = "\u5173\u95ed\u7f13\u5b58";
		cacheParam = "0";
	}else if("0".equals(isCache)){
		title = "\u7f13\u5b58\u5df2\u7981\u7528";
		cacheStr = "\u5f00\u542f\u7f13\u5b58";
		cacheParam = "1";
	}
	
 
	 if("1".equals(log)){
		 ConfigMap.update("islog","1");
	 }else if("0".equals(log)){
		 ConfigMap.update("islog","0");
	 }else if("2".equals(log)){
		 ConfigMap.update("islog","2");
	 }

	String islog = ConfigMap.get("islog");
	if("1".equals(islog)){
		title +="(\u65e5\u5fd7\u5df2\u5f00\u542f)";
		logStr = "\u5173\u95ed\u65e5\u5fd7";
		logUpdateStr = "\u5173\u95ed\u65e5\u5fd7";
		logUpdateParam ="0";
		logParam = "0";
	}else if("0".equals(islog)){
		title +="(\u65e5\u5fd7\u5df2\u5173\u95ed)";
		logStr = "\u5f00\u542f\u65e5\u5fd7";
		logUpdateStr = "\u5f00\u542f\u4fee\u6539\u65e5\u5fd7";
		logUpdateParam ="2";
		logParam = "1";
	}else if("2".equals(islog)){
		title +="(\u4fee\u6539\u65e5\u5fd7\u5df2\u5f00\u542f)";
		logUpdateStr = "\u5173\u95ed\u65e5\u5fd7";
		logStr = "\u5f00\u542f\u65e5\u5fd7";
		logUpdateParam ="0";
		logParam = "1";
	}
	

      out.write(_jsp_string1, 0, _jsp_string1.length);
      out.print(( cachelevel.equals("1") ? "Checked":"" ));
      out.write(_jsp_string2, 0, _jsp_string2.length);
      out.print(( cachelevel.equals("2") ? "Checked":"" ));
      out.write(_jsp_string3, 0, _jsp_string3.length);
      out.print(( cachelevel.equals("3") ? "Checked":"" ));
      out.write(_jsp_string4, 0, _jsp_string4.length);
      out.print((searchkey ));
      out.write(_jsp_string5, 0, _jsp_string5.length);
      out.print(( cacheParam));
      out.write(_jsp_string6, 0, _jsp_string6.length);
      out.print((cacheStr));
      out.write(_jsp_string7, 0, _jsp_string7.length);
      out.print(( logParam));
      out.write(_jsp_string6, 0, _jsp_string6.length);
      out.print((logStr));
      out.write(_jsp_string8, 0, _jsp_string8.length);
      out.print(( logUpdateParam));
      out.write(_jsp_string6, 0, _jsp_string6.length);
      out.print((logUpdateStr));
      out.write(_jsp_string9, 0, _jsp_string9.length);
      out.print(( urlskey));
      out.write(_jsp_string10, 0, _jsp_string10.length);
      out.print(( urlskey));
      out.write(_jsp_string11, 0, _jsp_string11.length);
      out.print(( urlskey));
      out.write(_jsp_string12, 0, _jsp_string12.length);
      
    final int PAGESIZE = 15;  
    int pageCount;  
    int curPage = 1;  
    String tablesort ="";
    String cachetype ="";
	final String queryCountStr ="queryCount";
		final String queryDbCountStr ="queryDbCount";
		final String queryLostTimeStr ="queryLostTime";
		CacheFactory sintance = CacheFactory.getInstance();
		int size =0;
		LRULinkedHashMap<String, Object> cacheMap =  sintance.getCacheMap();
   	  
		List cacheList = ListSorter.converMapToList(cacheMap,searchkey);
       	size = cacheList.size(); 
        pageCount = (size%PAGESIZE==0)?(size/PAGESIZE):(size/PAGESIZE+1); 
		
		long tt =  TableCacheBean.sumQueryCount.longValue();


      out.write(_jsp_string13, 0, _jsp_string13.length);
      out.print(( title ));
      out.write(_jsp_string14, 0, _jsp_string14.length);
      out.print(( size ));
      out.write(_jsp_string15, 0, _jsp_string15.length);
      out.print(( tt ));
      out.write(_jsp_string16, 0, _jsp_string16.length);
        
    //\u4e00\u9875\u653e5\u4e2a  
    try{  
    	 
        String tmp = request.getParameter("curPage");  

		 tablesort = request.getParameter("tablesort"); 
		 cachetype = request.getParameter("cachetype"); 

		if("2".equals(cachetype)){
			ListSorter.sort(cacheList,queryDbCountStr);
		}else if("1".equals(cachetype)){
			ListSorter.sort(cacheList,queryCountStr);
		}else if("3".equals(cachetype)){
			ListSorter.sort(cacheList,queryLostTimeStr);
		}
		 
        if(tmp == null){  
            tmp="1";  
        }  
        curPage = Integer.parseInt(tmp);  
        if(curPage>=pageCount) curPage = pageCount;  
        int currIndex = (curPage-1)*PAGESIZE;  
        out.println(curPage);  
        int count = 0;  
        do{  
            if(count>=PAGESIZE || currIndex>= cacheList.size() || currIndex <0)break;  
            SQLCacheBean bean =(SQLCacheBean) cacheList.get(currIndex);
            String tName = new Date(bean.getLastCacheTime()).toLocaleString();
            String sql = bean.getSql();
            long qCount = bean.getQueryCount();
            long rCount = bean.getQueryDbCount();
            long lostTime = bean.getQueryLostTime();
            count ++;  
            currIndex ++;
            
      out.write(_jsp_string17, 0, _jsp_string17.length);
      out.print((tName));
      out.write(_jsp_string18, 0, _jsp_string18.length);
      out.print((rCount));
      out.write(_jsp_string19, 0, _jsp_string19.length);
      out.print((lostTime));
      out.write(_jsp_string20, 0, _jsp_string20.length);
      out.print((sql));
      out.write(_jsp_string18, 0, _jsp_string18.length);
      out.print((qCount));
      out.write(_jsp_string21, 0, _jsp_string21.length);
        
        }while(currIndex<cacheList.size());  
    }  
    catch(Exception e){  
          e.printStackTrace();
    }  

      out.write(_jsp_string22, 0, _jsp_string22.length);
      out.print((cachetype));
      out.print(( urlskey));
      out.write(_jsp_string23, 0, _jsp_string23.length);
      out.print((curPage-1));
      out.write(_jsp_string24, 0, _jsp_string24.length);
      out.print((cachetype));
      out.print(( urlskey));
      out.write(_jsp_string25, 0, _jsp_string25.length);
      out.print((curPage+1));
      out.write(_jsp_string24, 0, _jsp_string24.length);
      out.print((cachetype));
      out.print(( urlskey));
      out.write(_jsp_string26, 0, _jsp_string26.length);
      out.print((pageCount));
      out.write(_jsp_string24, 0, _jsp_string24.length);
      out.print((cachetype));
      out.print(( urlskey));
      out.write(_jsp_string27, 0, _jsp_string27.length);
      out.print((curPage));
      out.write(_jsp_string28, 0, _jsp_string28.length);
      out.print((pageCount));
      out.write(_jsp_string29, 0, _jsp_string29.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("commcache/cacheMonitor.jsp"), -464814072198698216L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
    depend = new com.caucho.vfs.Depend(appDir.lookup("commcache/commoncache.jsp"), 5693479326593560001L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string11;
  private final static char []_jsp_string22;
  private final static char []_jsp_string8;
  private final static char []_jsp_string28;
  private final static char []_jsp_string23;
  private final static char []_jsp_string20;
  private final static char []_jsp_string9;
  private final static char []_jsp_string24;
  private final static char []_jsp_string27;
  private final static char []_jsp_string21;
  private final static char []_jsp_string15;
  private final static char []_jsp_string1;
  private final static char []_jsp_string7;
  private final static char []_jsp_string13;
  private final static char []_jsp_string5;
  private final static char []_jsp_string6;
  private final static char []_jsp_string10;
  private final static char []_jsp_string17;
  private final static char []_jsp_string0;
  private final static char []_jsp_string25;
  private final static char []_jsp_string14;
  private final static char []_jsp_string26;
  private final static char []_jsp_string19;
  private final static char []_jsp_string29;
  private final static char []_jsp_string12;
  private final static char []_jsp_string18;
  private final static char []_jsp_string2;
  private final static char []_jsp_string4;
  private final static char []_jsp_string16;
  private final static char []_jsp_string3;
  static {
    _jsp_string11 = "\" >\u67e5\u8be2\u6570\u636e\u5e93\u6b21\u6570\u6392\u5e8f</a>  &nbsp;&nbsp;&nbsp;\r\n\r\n	<a href = \"cacheMonitor.jsp?cachetype=3".toCharArray();
    _jsp_string22 = "  \r\n</table>  \r\n\r\n\r\n<a href = \"cacheMonitor.jsp?curPage=1&cachetype=".toCharArray();
    _jsp_string8 = "</a>  </button>\r\n	 <button><a onclick =\"updatelog(".toCharArray();
    _jsp_string28 = "\u9875/\u5171".toCharArray();
    _jsp_string23 = "\" >\u9996\u9875</a>  \r\n<a href = \"cacheMonitor.jsp?curPage=".toCharArray();
    _jsp_string20 = "</td> \r\n            <td>".toCharArray();
    _jsp_string9 = "</a>  </button>\r\n	 \r\n	  <br /><br />\r\n\r\n</body>  \r\n\r\n<script>\r\n	function updateCacheLevel(level){\r\n		var url = window.location.href;\r\n		url = url.substring(0,url.indexOf('?'));\r\n		url = url + \"?cachelevel=\"+level;	\r\n		location.href = url;\r\n	}\r\n\r\n/**\r\n	function updateProp(key,value){\r\n		var mapkey = document.getElementById(key).value;\r\n		mapkey = trim(mapkey);\r\n		var url = window.location.href;\r\n		url = url.substring(0,url.indexOf('?'));\r\n\r\n		var mapvalue = document.getElementById(value).value;\r\n		mapvalue = trim(mapvalue);\r\n		url = url + \"?mapkey=\"+mapkey + \"&mapvalue=\" +mapvalue;			\r\n			\r\n		location.href = url;\r\n	}\r\n\r\n\r\n	function queryProp(key){\r\n		var mapkey = document.getElementById(key).value;\r\n		mapkey = trim(mapkey);\r\n		var url = window.location.href;\r\n		url = url.substring(0,url.indexOf('?'));	\r\n			\r\n		url = url + \"?mapkey=\"+mapkey;			\r\n			\r\n		location.href = url;\r\n	}\r\n	**/\r\n\r\n	\r\n	function reloadConfig(){\r\n	\r\n		var url = window.location.href;\r\n		url = url.substring(0,url.indexOf('?'));\r\n		url = url + \"?isreload=1\";			\r\n			\r\n		location.href = url;\r\n	}\r\n\r\n\r\n	function updateCache(key){\r\n		var url = window.location.href;\r\n		url = url.substring(0,url.indexOf('?'));\r\n		url = url + \"?isCache=\"+key;			\r\n			\r\n		location.href = url;\r\n	}\r\n\r\n	function updatelog(key){\r\n		\r\n		var url = window.location.href;\r\n		url = url.substring(0,url.indexOf('?'));\r\n		url = url + \"?islog=\"+key;			\r\n			\r\n		location.href = url;\r\n	}\r\n\r\n\r\n	function trim(str) {\r\n  return str.replace(/(^\\s+)|(\\s+$)/g, \"\");\r\n}\r\n\r\n</script>\r\n</html> \r\n  \r\n    <body>  \r\n    <br/>\r\n	<a href = \"cacheMonitor.jsp?cachetype=1".toCharArray();
    _jsp_string24 = "&cachetype=".toCharArray();
    _jsp_string27 = "\" >\u5c3e\u9875</a>  \r\n\u7b2c".toCharArray();
    _jsp_string21 = "</td>  \r\n        </tr>  \r\n            ".toCharArray();
    _jsp_string15 = ")&nbsp;&nbsp;&nbsp;&nbsp;".toCharArray();
    _jsp_string1 = "  \r\n\r\n  \r\n    <body>  \r\n    \r\n  <input type=\"radio\" ".toCharArray();
    _jsp_string7 = "</a> </button>\r\n	  <button><a onclick =\"reloadConfig()\" >\u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e</a> </button>&nbsp;&nbsp;&nbsp;\r\n	 <button><a onclick =\"updatelog(".toCharArray();
    _jsp_string13 = "  \r\n	<h1>".toCharArray();
    _jsp_string5 = "\"></input>&nbsp;&nbsp;\r\n	<button><a onclick=\"dosearch('searchkey')\">\u641c\u7d22</a> </button>\r\n	\r\n	  \r\n	 <span style=\"margin-right:30px;padding-right:30px;\">\r\n	\r\n	 </span>\r\n	  <button><a onclick =\"updateCache(".toCharArray();
    _jsp_string6 = ")\" >".toCharArray();
    _jsp_string10 = "\" >\u67e5\u8be2\u7f13\u5b58\u6b21\u6570\u6392\u5e8f</a>  &nbsp;&nbsp;&nbsp;\r\n\r\n	<a href = \"cacheMonitor.jsp?cachetype=2".toCharArray();
    _jsp_string17 = "  \r\n        <tr>  \r\n            <td>".toCharArray();
    _jsp_string0 = "\r\n\r\n<html>  \r\n\r\n\r\n<html>  \r\n".toCharArray();
    _jsp_string25 = "\" >\u4e0a\u4e00\u9875</a>  \r\n<a href = \"cacheMonitor.jsp?curPage=".toCharArray();
    _jsp_string14 = "&nbsp;&nbsp;&nbsp;&nbsp;\u7f13\u5b58\u6570\u91cf(".toCharArray();
    _jsp_string26 = "\" >\u4e0b\u4e00\u9875</a>  \r\n<a href = \"cacheMonitor.jsp?curPage=".toCharArray();
    _jsp_string19 = "</td>  \r\n             <td>".toCharArray();
    _jsp_string29 = "\u9875  \r\n  \r\n</body>  \r\n<script>\r\nfunction dosearch(key){\r\n		var searchkey = document.getElementById(key).value;\r\n		var url = window.location.href;\r\n		url = url.substring(0,url.indexOf('?'));\r\n		url = url + \"?searchkey=\"+searchkey;			\r\n			\r\n		location.href = url;\r\n	}\r\n\r\n</script>\r\n</html> ".toCharArray();
    _jsp_string12 = "\" >\u67e5\u8be2\u6570\u636e\u5e93\u65f6\u95f4\u6392\u5e8f</a>  &nbsp;&nbsp;&nbsp;\r\n\r\n	&nbsp;&nbsp;&nbsp;\r\n	<button><a href = \"tableCacheMonitor.jsp\" >\u8868\u7f13\u5b58\u76d1\u63a7</a>  </button>\r\n\r\n	<button><a href = \"export.jsp?type=sql\" >\u5bfc\u51fa</a>  </button>\r\n	".toCharArray();
    _jsp_string18 = "</td>  \r\n            <td>".toCharArray();
    _jsp_string2 = " name=\"cachelevel\" value=\"1\" onclick=\"updateCacheLevel(1)\"/>\r\n	 \u7ef4\u62a4\u8bfb\u5199\u7f13\u5b58 &nbsp;&nbsp;\r\n	\r\n	 	\r\n	  <input type=\"radio\" ".toCharArray();
    _jsp_string4 = " name=\"cachelevel\" value=\"3\" onclick=\"updateCacheLevel(3)\"/>\r\n\r\n	 \u53ea\u7ef4\u62a4\u7f13\u5b58\u540c\u6b65&nbsp;&nbsp;\r\n\r\n	<input id=\"searchkey\" type=\"textfield\" value=\"".toCharArray();
    _jsp_string16 = "</h1>\r\n    <table border=\"1\" spacing=\"2\">  \r\n\r\n\r\n  		<tr>  \r\n            <td>\u7f13\u5b58\u65f6\u95f4</td>  \r\n            <td>sql\u67e5\u8be2\u6570\u636e\u5e93\u6b21\u6570</td>  \r\n            <td>sql\u67e5\u8be2\u6570\u636e\u5e93\u82b1\u8d39\u65f6\u95f4</td>  \r\n            <td>sql</td>  \r\n            <td>sql\u7f13\u5b58\u67e5\u8be2\u6b21\u6570</td>  \r\n        </tr>  \r\n".toCharArray();
    _jsp_string3 = " name=\"cachelevel\" value=\"2\" onclick=\"updateCacheLevel(2)\"/>\r\n	\u7981\u7528\u8bfb\u7f13\u5b58 &nbsp;&nbsp;\r\n\r\n		 <input type=\"radio\" ".toCharArray();
  }
}
