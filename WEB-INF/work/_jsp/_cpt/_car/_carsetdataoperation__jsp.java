/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._cpt._car;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.general.Util;
import weaver.file.FileUpload;
import java.util.*;
import java.io.PrintWriter;
import net.sf.json.JSONArray;
import net.sf.json.JSONObject;
import weaver.hrm.HrmUserVarify;
import weaver.hrm.User;
import weaver.systeminfo.SystemEnv;
import weaver.formmode.ThreadLocalUser;
import weaver.systeminfo.systemright.CheckSubCompanyRight;
import java.io.IOException;

public class _carsetdataoperation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;

  
  private Map getCheckRightSubCompanyParam(String userRightStr,User user,String fmdetachable,int subCompanyId,String subCompanyIdName,
  	HttpServletRequest request,HttpServletResponse response,HttpSession session){
  	int operatelevel=0;
  	Map map = new HashMap();
  	if(subCompanyIdName.equals("")){
  		subCompanyIdName = "subCompanyId";
  	}
  	
  	if(fmdetachable.equals("1")){  
  		if(subCompanyId==-1){
  		    if(request.getParameter(subCompanyIdName)==null){
  		        subCompanyId=Util.getIntValue(String.valueOf(session.getAttribute("managefield_subCompanyId")),-1);
  		    }else{
  		        subCompanyId=Util.getIntValue(request.getParameter(subCompanyIdName),-1);
  		    }
  		    if(subCompanyId == -1){
  		        subCompanyId = user.getUserSubCompany1();
  		    }
  		}
  	    CheckSubCompanyRight CheckSubCompanyRight = new CheckSubCompanyRight();
  	    operatelevel= CheckSubCompanyRight.ChkComRightByUserRightCompanyId(user.getUID(),userRightStr,subCompanyId);
  	    if(operatelevel>=0){
  		    session.setAttribute("managefield_subCompanyId",String.valueOf(subCompanyId));
  	    }
  	}else{
  	    if(HrmUserVarify.checkUserRight(userRightStr, user)){
  	        operatelevel=2;
  	    }
  	}
  	String currentSubCompanyId = ""+session.getAttribute("defaultSubCompanyId");
  	map.put("currentSubCompanyId",currentSubCompanyId);
  	map.put("subCompanyId",subCompanyId);
  	map.put("operatelevel",operatelevel);
  	return map;
  }

  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      
int isIncludeToptitle = 0;
User user = HrmUserVarify.getUser (request , response) ;
if(user==null) {
    response.sendRedirect("/login/Login.jsp");
    return;
}
ThreadLocalUser.setUser(user);

      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.hrm.moduledetach.ManageDetachComInfo ManageDetachComInfo;
      ManageDetachComInfo = (weaver.hrm.moduledetach.ManageDetachComInfo) pageContext.getAttribute("ManageDetachComInfo");
      if (ManageDetachComInfo == null) {
        ManageDetachComInfo = new weaver.hrm.moduledetach.ManageDetachComInfo();
        pageContext.setAttribute("ManageDetachComInfo", ManageDetachComInfo);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.systeminfo.systemright.CheckSubCompanyRight CheckSubCompanyRight;
      CheckSubCompanyRight = (weaver.systeminfo.systemright.CheckSubCompanyRight) pageContext.getAttribute("CheckSubCompanyRight");
      if (CheckSubCompanyRight == null) {
        CheckSubCompanyRight = new weaver.systeminfo.systemright.CheckSubCompanyRight();
        pageContext.setAttribute("CheckSubCompanyRight", CheckSubCompanyRight);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.hrm.company.SubCompanyComInfo SubCompanyComInfo;
      SubCompanyComInfo = (weaver.hrm.company.SubCompanyComInfo) pageContext.getAttribute("SubCompanyComInfo");
      if (SubCompanyComInfo == null) {
        SubCompanyComInfo = new weaver.hrm.company.SubCompanyComInfo();
        pageContext.setAttribute("SubCompanyComInfo", SubCompanyComInfo);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      
boolean isUseFmManageDetach=ManageDetachComInfo.isUseFmManageDetach();
String fmdetachable="0";
if(isUseFmManageDetach){
   fmdetachable="1";
   session.setAttribute("detachable","1");
   session.setAttribute("fmdetachable",fmdetachable);
   session.setAttribute("fmdftsubcomid",ManageDetachComInfo.getFmdftsubcomid());
}else{
   fmdetachable="0";
   session.setAttribute("detachable","0");
   session.setAttribute("fmdetachable",fmdetachable);
   session.setAttribute("fmdftsubcomid","0");
}

      out.write(_jsp_string3, 0, _jsp_string3.length);
      weaver.formmode.setup.ModeRightInfo ModeRightInfo;
      ModeRightInfo = (weaver.formmode.setup.ModeRightInfo) pageContext.getAttribute("ModeRightInfo");
      if (ModeRightInfo == null) {
        ModeRightInfo = new weaver.formmode.setup.ModeRightInfo();
        pageContext.setAttribute("ModeRightInfo", ModeRightInfo);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.conn.RecordSet RecordSet;
      RecordSet = (weaver.conn.RecordSet) pageContext.getAttribute("RecordSet");
      if (RecordSet == null) {
        RecordSet = new weaver.conn.RecordSet();
        pageContext.setAttribute("RecordSet", RecordSet);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.conn.RecordSet rs;
      rs = (weaver.conn.RecordSet) pageContext.getAttribute("rs");
      if (rs == null) {
        rs = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs", rs);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.conn.RecordSet rs2;
      rs2 = (weaver.conn.RecordSet) pageContext.getAttribute("rs2");
      if (rs2 == null) {
        rs2 = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs2", rs2);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.conn.RecordSetTrans RecordSetTrans;
      RecordSetTrans = (weaver.conn.RecordSetTrans) pageContext.getAttribute("RecordSetTrans");
      if (RecordSetTrans == null) {
        RecordSetTrans = new weaver.conn.RecordSetTrans();
        pageContext.setAttribute("RecordSetTrans", RecordSetTrans);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.formmode.data.ModeDataIdUpdate ModeDataIdUpdate;
      ModeDataIdUpdate = (weaver.formmode.data.ModeDataIdUpdate) pageContext.getAttribute("ModeDataIdUpdate");
      if (ModeDataIdUpdate == null) {
        ModeDataIdUpdate = new weaver.formmode.data.ModeDataIdUpdate();
        pageContext.setAttribute("ModeDataIdUpdate", ModeDataIdUpdate);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.workflow.form.FormManager FormManager;
      FormManager = (weaver.workflow.form.FormManager) pageContext.getAttribute("FormManager");
      if (FormManager == null) {
        FormManager = new weaver.workflow.form.FormManager();
        pageContext.setAttribute("FormManager", FormManager);
      }
      out.write(_jsp_string4, 0, _jsp_string4.length);
      
String action = Util.null2String(request.getParameter("action"));
int userid = user.getUID();
int usertype = (user.getLogintype()).equals("1") ? 0 : 1;

boolean isright = true;
if(user.getUID() == 1){ //\u7cfb\u7edf\u7ba1\u7406\u5458\u9664\u5916
	 isright = true;
}
//\u6743\u9650\u63a7\u5236 \u901a\u8fc7sql\u811a\u672c\u751f\u6210readCarReport:View \uff08\u89d2\u8272-\u529f\u80fd\u6743\u9650\u4e0b\u4f7f\u7528\uff09
if(HrmUserVarify.checkUserRight("Car:Maintenance", user)){
	isright = true;
}
if(!isright) {
	response.sendRedirect("/notice/noright.jsp") ;
	return ;
} 
if("getData".equals(action)){
	int workflowid = Util.getIntValue(request.getParameter("workflowid"),-1);
	String sql = "select isremind,remindtype from mode_carremindset";
	RecordSet.executeSql(sql);
	int isremind = 0;
	int remindtype = 0;
	if(RecordSet.next()){
		isremind = RecordSet.getInt("isremind");
		remindtype = RecordSet.getInt("remindtype");
	}
	JSONArray array = new JSONArray();
	JSONObject object = new JSONObject();
	if(isremind <= 0){
		object.put("iscontinue","no");
		object.put("remindtype",remindtype);
	}else{
		sql = "select id from carbasic where workflowid ='"+workflowid+"' and isuse=1";
		RecordSet.executeSql(sql);
		int id = 0;
		if(RecordSet.next()){
			id = RecordSet.getInt("id");
		}
		sql = "select carfieldid,modefieldid from mode_carrelatemode where mainid="+id;
		RecordSet.executeSql(sql);
		while(RecordSet.next()){
			int carfieldid = RecordSet.getInt("carfieldid");
			int modefieldid = RecordSet.getInt("modefieldid");
			switch(carfieldid)
	        {
	            case 627:
	            	object.put("field627",modefieldid); //\u8f66\u8f86
	                break;
	            case 628:
	            	object.put("field628",modefieldid); //\u53f8\u673a
	                break;
	            case 629:
	            	object.put("field629",modefieldid); //\u7528\u8f66\u4eba
	                break;
	            case 634:
	            	object.put("field634",modefieldid); //\u5f00\u59cb\u65e5\u671f
	                break;
	            case 635:
	            	object.put("field635",modefieldid); //\u5f00\u59cb\u65f6\u95f4
		            break;    
	            case 636:
	            	object.put("field636",modefieldid); //\u7ed3\u675f\u65e5\u671f
	            	break;
	            case 637:
	            	object.put("field637",modefieldid); //\u7ed3\u675f\u65f6\u95f4
	            	break;
	            case 639:
	            	object.put("field639",modefieldid); //\u64a4\u9500
	            	break;
	            default:
	              break;
	        }
		}
		object.put("iscontinue","yes");
		object.put("remindtype",remindtype);
	}
	array.add(object);
	//PrintWriter writer = response.getWriter();
	//writer.print(array.toString());
	out.print(array.toString());
    out.flush();
    out.close();
    return;
}else if("getDataSys".equals(action)){ // 128307
	int workflowid = Util.getIntValue(request.getParameter("workflowid"),-1);
	String sql = "select isremind,remindtype from mode_carremindset";
	RecordSet.executeSql(sql);
	int isremind = 0;
	int remindtype = 0;
	if(RecordSet.next()){
		isremind = RecordSet.getInt("isremind");
		remindtype = RecordSet.getInt("remindtype");
	}
	JSONArray array = new JSONArray();
	JSONObject object = new JSONObject();
	if(isremind <= 0){
		object.put("iscontinue","no");
		object.put("remindtype",remindtype);
	}else{
      	object.put("field627","627"); //\u8f66\u8f86
      	object.put("field628","628"); //\u53f8\u673a
      	object.put("field629","629"); //\u7528\u8f66\u4eba
      	object.put("field634","634"); //\u5f00\u59cb\u65e5\u671f
      	object.put("field635","635"); //\u5f00\u59cb\u65f6\u95f4
      	object.put("field636","636"); //\u7ed3\u675f\u65e5\u671f
      	object.put("field637","637"); //\u7ed3\u675f\u65f6\u95f4
      	object.put("field639","639"); //\u64a4\u9500
		object.put("iscontinue","yes");
		object.put("remindtype",remindtype);
	}
	array.add(object);
	//PrintWriter writer = response.getWriter();
	//writer.print(array.toString());
	out.print(array.toString());
    out.flush();
    out.close();
    return;
}else if("checkData".equals(action)){
	JSONArray array = new JSONArray();
	JSONObject object = new JSONObject();
	int requestid = Util.getIntValue(Util.null2String(request.getParameter("requestid"),"0"),0);
	String workflowid = Util.null2String(request.getParameter("workflowid"));
	String field627 = Util.null2String(request.getParameter("field627")); //\u8f66\u8f86
	String field634 = Util.null2String(request.getParameter("field634")); //\u5f00\u59cb\u65e5\u671f
	String field635 = Util.null2String(request.getParameter("field635")); //\u5f00\u59cb\u65f6\u95f4
	String field636 = Util.null2String(request.getParameter("field636")); //\u7ed3\u675f\u65e5\u671f
	String field637 = Util.null2String(request.getParameter("field637")); //\u7ed3\u675f\u65f6\u95f4
	
	/*begin \u67e5\u8be2\u6761\u4ef6\u62fc\u88c5*/
  	String returnStr = " and c1.id='"+field627+"' ";
  	if((RecordSet.getDBType()).equals("oracle")){
  		returnStr += " and ((c2.startDate ||' '||c2.startTime >= '"+field634+" "+field635+"' AND c2.startDate ||' '||c2.startTime <= '"+field636+" "+field637+"') OR"+
  		" (c2.startDate ||' '||c2.startTime <= '"+field634+" "+field635+"' AND c2.endDate||' '||c2.endTime >= '"+field636+" "+field637+"') OR"+
  		//" (c2.startDate||' '||c2.startTime >= '"+field634+" "+field635+"' AND c2.endDate||' '||c2.endTime >= '"+field636+" "+field637+"') OR"+
  		" (c2.endDate||' '||c2.endTime >= '"+field634+" "+field635+"' AND c2.endDate||' '||c2.endTime <= '"+field636+" "+field637+"')) ";
  	}else{
  		returnStr += " and ((c2.startDate +' '+c2.startTime >= '"+field634+" "+field635+"' AND c2.startDate +' '+c2.startTime <= '"+field636+" "+field637+"') OR"+
  		" (c2.startDate +' '+c2.startTime <= '"+field634+" "+field635+"' AND c2.endDate+' '+c2.endTime >= '"+field636+" "+field637+"') OR"+
  		//" (c2.startDate+' '+c2.startTime >= '"+field634+" "+field635+"' AND c2.endDate+' '+c2.endTime >= '"+field636+" "+field637+"') OR"+
  		" (c2.endDate+' '+c2.endTime >= '"+field634+" "+field635+"' AND c2.endDate+' '+c2.endTime <= '"+field636+" "+field637+"')) ";
  	}
  	returnStr += " and (c2.cancel =0 or c2.cancel is null) and c3.requestid != '"+requestid+"' ";
    if ((RecordSet.getDBType()).equals("oracle")) {
        returnStr = Util.StringReplace(returnStr,"SUBSTRING","substr");   
    }
    /*end \u67e5\u8be2\u6761\u4ef6\u62fc\u88c5*/
    
    String C2 = "";
    if ((RecordSet.getDBType()).equals("oracle")) {
     	C2 += "(select id,requestid,to_number(carId) as carId,to_number(driver) as driver,to_number(userid) as userid,startdate,starttime,enddate,endtime,cancel,'CarUseApprove' as tablename,'cancel' as fieldname from CarUseApprove";
    } else {
     	C2 += "(select id,requestid,carId,driver,userid,startdate,starttime,enddate,endtime,cancel,'CarUseApprove' as tablename,'cancel' as fieldname from CarUseApprove";
    }
    RecordSet.executeSql("select id,formid from carbasic where formid!=163 and isuse = 1");
    while (RecordSet.next()) {
     	String mainid = RecordSet.getString("id");
     	String _formid = RecordSet.getString("formid");
     	String _tablename = FormManager.getTablename(_formid);
     	C2 += " union all select id,requestid,";
     	Map _map = new HashMap();
     	rs2.executeSql("select carfieldid,modefieldid,fieldname from mode_carrelatemode c,workflow_billfield b where c.modefieldid=b.id and mainid="+mainid);
     	while (rs2.next()) {
     		String carfieldid = rs2.getString("carfieldid");
     		String modefieldid = rs2.getString("modefieldid");
     		String fieldname = rs2.getString("fieldname");
     		_map.put(carfieldid,fieldname);
     	}
     	
     	if ((RecordSet.getDBType()).equals("oracle")) {
     		C2 += "to_number("+Util.null2s(Util.null2String(_map.get("627")),"0") +") as carId,";
         	C2 += "to_number("+Util.null2s(Util.null2String(_map.get("628")),"0") +") as driver,";
         	C2 += "to_number("+Util.null2s(Util.null2String(_map.get("629")),"0") +") as userid,";
     	} else {
     		C2 += Util.null2s(Util.null2String(_map.get("627")),"0") +" as carId,";
	        	C2 += Util.null2s(Util.null2String(_map.get("628")),"0") +" as driver,";
	        	C2 += Util.null2s(Util.null2String(_map.get("629")),"0") +" as userid,";

     	}
     	C2 += Util.null2s(Util.null2String(_map.get("634")),"''") +" as startDate,";
     	C2 += Util.null2s(Util.null2String(_map.get("635")),"''") +" as startTime,";
     	C2 += Util.null2s(Util.null2String(_map.get("636")),"''") +" as endDate,";
     	C2 += Util.null2s(Util.null2String(_map.get("637")),"''") +" as endTime,";
     	C2 += Util.null2s(Util.null2String(_map.get("639")),"'0'") +" as cancel,";
     	C2 += "'"+_tablename +"' as tablename,";
     	C2 += "'" + Util.null2String(_map.get("639")) +"' as fieldname";
     	C2 += " from " + _tablename;
    }
    C2 += ")";
     
    String backfields = "c1.id,c2.id aid,c1.carNo,c2.driver,c2.userid,c2.startdate,c2.starttime,c2.enddate,c2.endtime,c3.requestid,c3.requestname,c.id as tid, c.name as typename,c3.currentnodetype,c2.cancel,c2.tablename,c2.fieldname ";
	String fromSql = "  Carinfo c1 left join "+C2+" c2 on c2.carId = c1.id left join workflow_requestbase c3 on c2.requestid=c3.requestid left join CarType c on c1.cartype = c.id ";
	String whereSql = " where c3.currentnodetype<>0 and c3.workflowid not in (select workflowid from carbasic where isuse=0)" + returnStr;
    String orderby = " c2.startdate ,c2.starttime , c1.id" ;
     
    //System.out.println("select "+backfields+" from "+fromSql+" "+whereSql);
    RecordSet.executeSql("select "+backfields+" from "+fromSql+" "+whereSql);
    if(RecordSet.next()){
    	object.put("iscontinue","no");
    }else{
    	object.put("iscontinue","yes");
    }
	array.add(object);
	//PrintWriter writer = response.getWriter();
	//writer.print(array.toString());
	out.print(array.toString());
    out.flush();
    out.close();
    return;
}

    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("cpt/car/CarSetDataOperation.jsp"), 5354720651408760952L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
    depend = new com.caucho.vfs.Depend(appDir.lookup("formmode/pub_init.jsp"), -4246916824298514572L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
    depend = new com.caucho.vfs.Depend(appDir.lookup("formmode/pub_function.jsp"), 5446055981984630656L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string3;
  private final static char []_jsp_string1;
  private final static char []_jsp_string2;
  private final static char []_jsp_string4;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string3 = "\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string2 = "\r\n".toCharArray();
    _jsp_string4 = "\r\n\r\n".toCharArray();
  }
}
