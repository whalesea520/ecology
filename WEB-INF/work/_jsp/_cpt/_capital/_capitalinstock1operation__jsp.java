/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._cpt._capital;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.hrm.User;
import weaver.hrm.HrmUserVarify;
import net.sf.json.JSONObject;
import net.sf.json.JSONArray;
import weaver.general.Util;
import java.util.*;

public class _capitalinstock1operation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.conn.RecordSet RecordSet;
      RecordSet = (weaver.conn.RecordSet) pageContext.getAttribute("RecordSet");
      if (RecordSet == null) {
        RecordSet = new weaver.conn.RecordSet();
        pageContext.setAttribute("RecordSet", RecordSet);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.cpt.capital.CapitalComInfo CapitalComInfo;
      CapitalComInfo = (weaver.cpt.capital.CapitalComInfo) pageContext.getAttribute("CapitalComInfo");
      if (CapitalComInfo == null) {
        CapitalComInfo = new weaver.cpt.capital.CapitalComInfo();
        pageContext.setAttribute("CapitalComInfo", CapitalComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.workflow.msg.PoppupRemindInfoUtil PoppupRemindInfoUtil;
      PoppupRemindInfoUtil = (weaver.workflow.msg.PoppupRemindInfoUtil) pageContext.getAttribute("PoppupRemindInfoUtil");
      if (PoppupRemindInfoUtil == null) {
        PoppupRemindInfoUtil = new weaver.workflow.msg.PoppupRemindInfoUtil();
        pageContext.setAttribute("PoppupRemindInfoUtil", PoppupRemindInfoUtil);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      
User user=HrmUserVarify.getUser(request, response);
if(user==null){
	out.print("[]");
	return;
}
if(!(HrmUserVarify.checkUserRight("CptCapital:InStockCheck", user)||HrmUserVarify.checkUserRight("CptCapital:InStock", user) )){
    		response.sendRedirect("/notice/noright.jsp");
    		return;
}
String Id = Util.fromScreen(request.getParameter("id"),user.getLanguage());
String contactno = Util.fromScreen(request.getParameter("contactno"),user.getLanguage());
String BuyerID = Util.fromScreen(request.getParameter("BuyerID"),user.getLanguage());
String customerid = Util.fromScreen(request.getParameter("customerid"),user.getLanguage());
String CheckerID = Util.fromScreen(request.getParameter("CheckerID"),user.getLanguage());
String StockInDate_gz = Util.fromScreen(request.getParameter("StockInDate_gz"),user.getLanguage());
String StockInDate = Util.fromScreen(request.getParameter("StockInDate"),user.getLanguage());
String Method = Util.fromScreen(request.getParameter("method"),user.getLanguage());
int totaldetail = Util.getIntValue(request.getParameter("totaldetail"),0);


char separator = Util.getSeparator() ;
String para = "";
String sql = "";

if (Method.equals("add")) {

    para = contactno;
    para +=separator+BuyerID;
    para +=separator+customerid;
    para +=separator+CheckerID;
    para +=separator+StockInDate;
	para +=separator+"0";
    RecordSet.executeProc("CptStockInMain_Insert",para);

	RecordSet.next();
	String cptstockinid=""+RecordSet.getInt(1);
	String cpttype="";
	String plannumber="";
	String price="";
    String Invoice="";
    String customerid_dtl="";
    String StockInDate_dtl="";
    String capitalspec="";
    String location="";
	String contractno="";//\u5408\u540c\u53f7

	int i=0;
	
	String dtinfo = Util.null2String(request.getParameter("dtinfo")).replaceAll("`#weaver#`", "\\\\\\\\");
	dtinfo= dtinfo.replaceAll("_[0-9]*\":\"", "\":\"");
	JSONArray dtJsonArray=JSONArray.fromObject(dtinfo);
	if(dtJsonArray!=null&&dtJsonArray.size()>0){
		for(i=0;i<dtJsonArray.size();i++){
			JSONArray dtJsonArray2= JSONArray.fromObject( dtJsonArray.get(i));
			if(dtJsonArray2!=null&&dtJsonArray2.size()>=6){
				capitalspec= dtJsonArray2.getJSONObject(1).getString("capitalspec");
				price= dtJsonArray2.getJSONObject(2).getString("price");
				plannumber= dtJsonArray2.getJSONObject(3).getString("capitalnum");
				Invoice= dtJsonArray2.getJSONObject(4).getString("invoice");
				location= dtJsonArray2.getJSONObject(5).getString("location");
				cpttype= dtJsonArray2.getJSONObject(6).getString("capitalid");
				customerid_dtl=customerid;
				StockInDate_dtl=StockInDate_gz;
				contractno=contactno;
				
				if(!cpttype.equals("")){
					para = cptstockinid;
					para +=separator+cpttype;
					para +=separator+plannumber;
					para +=separator+"0";
					para +=separator+price;
			        para +=separator+customerid_dtl;
			        para +=separator+StockInDate_dtl;
			        para +=separator+capitalspec;
			        para +=separator+location;
			        para +=separator+Invoice;
					RecordSet.executeProc("CptStockInDetail_Insert",para);
					if(RecordSet.next()){
						String detailid = Util.null2String(RecordSet.getString(1));
						if(!detailid.equals("")&&!detailid.equals("0")){
							RecordSet.executeSql("update CptStockInDetail set contractno = '" + contractno + "' where id = " + detailid);
						}			
					}
			     }
			}
		}
	}  
	PoppupRemindInfoUtil.insertPoppupRemindInfo(Util.getIntValue(CheckerID),11,"0",Util.getIntValue(cptstockinid),"",1);

    String reapplyflag=Util.null2String(request.getParameter("reapplyflag"));
    String respurl="CptCapitalInstock1tab.jsp";
    if("1".equals(reapplyflag)){
    	respurl="CptCapitalInstock1tab.jsp?isclose=1&isdialog=1";
    }
    response.sendRedirect(respurl);

}else if (Method.equals("edit")) {//\u7f16\u8f91\u6536\u56de\u7684\u5165\u5e93\u5355


    RecordSet.executeSql("update CptStockInMain set ischecked=0,buyerid='"+BuyerID+"',checkerid='"+CheckerID+"',invoice='"+contactno+"',stockindate='"+StockInDate+"' where id="+Id);
    RecordSet.executeSql("delete CptStockInDetail where cptstockinid="+Id);

	String cptstockinid=""+Id;
	String cpttype="";
	String plannumber="";
	String price="";
    String Invoice="";
    String customerid_dtl="";
    String StockInDate_dtl="";
    String capitalspec="";
    String location="";
	String contractno="";//\u5408\u540c\u53f7

	int i=0;
	
	String dtinfo = Util.null2String(request.getParameter("dtinfo")).replaceAll("`#weaver#`", "\\\\\\\\");
	dtinfo= dtinfo.replaceAll("_[0-9]*\":\"", "\":\"");
	//System.out.println("dtinfo:"+dtinfo);
	JSONArray dtJsonArray=JSONArray.fromObject(dtinfo);
	if(dtJsonArray!=null&&dtJsonArray.size()>0){
		for(i=0;i<dtJsonArray.size();i++){
			JSONArray dtJsonArray2= JSONArray.fromObject( dtJsonArray.get(i));
			if(dtJsonArray2!=null&&dtJsonArray2.size()>=6){
				capitalspec= dtJsonArray2.getJSONObject(1).getString("capitalspec");
				price= dtJsonArray2.getJSONObject(2).getString("price");
				plannumber= dtJsonArray2.getJSONObject(3).getString("capitalnum");
				Invoice= dtJsonArray2.getJSONObject(4).getString("invoice");
				location= dtJsonArray2.getJSONObject(5).getString("location");
				cpttype= dtJsonArray2.getJSONObject(6).getString("capitalid");
				customerid_dtl=customerid;
				StockInDate_dtl=StockInDate_gz;
				contractno=contactno;
				
				if(!cpttype.equals("")){
					para = cptstockinid;
					para +=separator+cpttype;
					para +=separator+plannumber;
					para +=separator+"0";
					para +=separator+price;
			        para +=separator+customerid_dtl;
			        para +=separator+StockInDate_dtl;
			        para +=separator+capitalspec;
			        para +=separator+location;
			        para +=separator+Invoice;
					RecordSet.executeProc("CptStockInDetail_Insert",para);
					if(RecordSet.next()){
						String detailid = Util.null2String(RecordSet.getString(1));
						if(!detailid.equals("")&&!detailid.equals("0")){
							RecordSet.executeSql("update CptStockInDetail set contractno = '" + contractno + "' where id = " + detailid);
						}			
					}
			     }
			}
		}
	}
    PoppupRemindInfoUtil.insertPoppupRemindInfo(Util.getIntValue(CheckerID),11,"0",Util.getIntValue(cptstockinid));

	response.sendRedirect("CptCapitalInstock1tab.jsp?isclose=1&isdialog=1");

}


else if (Method.equals("delete")) {
	sql = "update CptStockInMain set ischecked = -1 where id = " + Id ;
	RecordSet.executeSql(sql);
	int checkerid=user.getUID();
	sql="select checkerid from CptStockInMain where id="+Id;
	RecordSet.executeSql(sql);
	if(RecordSet.next()){
		checkerid=Util.getIntValue( RecordSet.getString("checkerid"));
	}
	
    PoppupRemindInfoUtil.updatePoppupRemindInfo(checkerid,11,"0",Util.getIntValue(Id));
	response.sendRedirect("/cpt/search/CptInstockSearchTab.jsp");
	
}else if (Method.equals("reject")) {//\u6536\u56de\u5f85\u9a8c\u5165\u5e93\u5355
	sql = "update CptStockInMain set ischecked = -2 where id = " + Id ;
	RecordSet.executeSql(sql);
	int checkerid=user.getUID();
	sql="select checkerid from CptStockInMain where id="+Id;
	RecordSet.executeSql(sql);
	if(RecordSet.next()){
		checkerid=Util.getIntValue( RecordSet.getString("checkerid"));
	}
	
    PoppupRemindInfoUtil.updatePoppupRemindInfo(checkerid,11,"0",Util.getIntValue(Id));
	//response.sendRedirect("/cpt/search/CptInstockSearchTab.jsp");
	return;
	
}else if (Method.equals("loaddetaildata")) {
	String from = Util.null2String(request.getParameter("from"));
	
	JSONArray arr=new JSONArray();
	if(Util.getIntValue(Id,0)>0){
		sql = "select * from CptStockInDetail where cptstockinid=" + Id+" order by id " ;
		RecordSet.executeSql(sql);
		while(RecordSet.next()){
			JSONArray jsonArray=new JSONArray();
			JSONObject jsonObject=new JSONObject();
			
			jsonObject.put("name", "capitalid");
			jsonObject.put("value", Util.null2String(RecordSet.getString("cpttype") ));
			jsonObject.put("label", CapitalComInfo.getCapitalname(Util.null2String(RecordSet.getString("cpttype") )));
			jsonObject.put("iseditable", true);
			jsonObject.put("type", "browser");
			jsonArray.add(jsonObject);
			
			jsonObject=new JSONObject();
			jsonObject.put("name", "capitalspec");
			jsonObject.put("value", Util.null2String(RecordSet.getString("capitalspec") ));
			jsonObject.put("iseditable", true);
			jsonObject.put("type", "input");
			jsonArray.add(jsonObject);
			
			jsonObject=new JSONObject();
			jsonObject.put("name", "price");
			jsonObject.put("value", Util.null2String(RecordSet.getString("price") ));
			jsonObject.put("iseditable", true);
			jsonObject.put("type", "input");
			jsonArray.add(jsonObject);
			
			jsonObject=new JSONObject();
			jsonObject.put("name", "capitalnum");
			jsonObject.put("value", Util.null2String(RecordSet.getString("plannumber") ));
			jsonObject.put("iseditable", true);
			jsonObject.put("type", "input");
			jsonArray.add(jsonObject);
			
			jsonObject=new JSONObject();
			jsonObject.put("name", "invoice");
			jsonObject.put("value", Util.null2String(RecordSet.getString("invoice") ));
			jsonObject.put("iseditable", true);
			jsonObject.put("type", "input");
			jsonArray.add(jsonObject);
			
			jsonObject=new JSONObject();
			jsonObject.put("name", "location");
			jsonObject.put("value", Util.null2String(RecordSet.getString("location") ));
			jsonObject.put("iseditable", true);
			jsonObject.put("type", "input");
			jsonArray.add(jsonObject);
			
			arr.add(jsonArray);
		}
	}else if("cptalertsearch".equalsIgnoreCase(from) ){//\u4f4e\u5e93\u5b58\u9884\u8b66\u5165\u53e3\u7684\u5165\u5e93
		String type = Util.null2String(request.getParameter("type"));
		String applyid = Util.null2String(request.getParameter("applyid"));
		if(!"".equals(applyid)){
			if(applyid.startsWith(",")){
				applyid=applyid.substring(1);
			}
			if(applyid.endsWith(",")){
				applyid=applyid.substring(0,applyid.length()-1);
			}
			sql="select * from cptcapital where id in ( select distinct t2.datatype from cptcapital t2 where t2.id in ("+applyid+") ) ";
			RecordSet.executeSql(sql);
			while(RecordSet.next()){
				
				JSONArray jsonArray=new JSONArray();
				JSONObject jsonObject=new JSONObject();
				
				jsonObject.put("name", "capitalid");
				jsonObject.put("value", Util.null2String(RecordSet.getString("id") ));
				jsonObject.put("label", CapitalComInfo.getCapitalname(Util.null2String(RecordSet.getString("id") )));
				jsonObject.put("iseditable", true);
				jsonObject.put("type", "browser");
				jsonArray.add(jsonObject);
				
				jsonObject=new JSONObject();
				jsonObject.put("name", "capitalspec");
				jsonObject.put("value", Util.null2String(RecordSet.getString("capitalspec") ));
				jsonObject.put("iseditable", true);
				jsonObject.put("type", "input");
				jsonArray.add(jsonObject);
				
				jsonObject=new JSONObject();
				jsonObject.put("name", "price");
				jsonObject.put("value", Util.null2String(RecordSet.getString("startprice") ));
				jsonObject.put("iseditable", true);
				jsonObject.put("type", "input");
				jsonArray.add(jsonObject);
				
				jsonObject=new JSONObject();
				jsonObject.put("name", "capitalnum");
				jsonObject.put("value", Util.null2String(""));
				jsonObject.put("iseditable", true);
				jsonObject.put("type", "input");
				jsonArray.add(jsonObject);
				
				jsonObject=new JSONObject();
				jsonObject.put("name", "invoice");
				jsonObject.put("value", Util.null2String("" ));
				jsonObject.put("iseditable", true);
				jsonObject.put("type", "input");
				jsonArray.add(jsonObject);
				
				jsonObject=new JSONObject();
				jsonObject.put("name", "location");
				jsonObject.put("value", Util.null2String("" ));
				jsonObject.put("iseditable", true);
				jsonObject.put("type", "input");
				jsonArray.add(jsonObject);
				
				arr.add(jsonArray);
				
			}
			
			
		}
	}
	
	out.print(arr.toString());
}else if (Method.equals("checkstate")) {
	JSONObject jsonObject=new JSONObject();
	boolean success=true;
	String[] checkids=Util.TokenizerString2( Util.null2String( request.getParameter("checkstateids")),",");
	if(checkids!=null&&checkids.length>0){
		for(int k=0;k<checkids.length;k++){
			sql = "select ischecked from CptStockInMain where id=" + checkids[k]+" and ischecked='-2' " ;
			RecordSet.executeSql(sql);
			if(RecordSet.next()){
				success=false;
				break;
			}
		}
	}
	jsonObject.put("msg", ""+success);
	out.print(jsonObject.toString());
}

      out.write(_jsp_string1, 0, _jsp_string1.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("cpt/capital/CapitalInstock1Operation.jsp"), -4452236090574416928L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string1;
  private final static char []_jsp_string2;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
    _jsp_string2 = "\r\n\r\n".toCharArray();
  }
}
