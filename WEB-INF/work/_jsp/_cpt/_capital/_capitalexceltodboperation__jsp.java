/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._cpt._capital;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.hrm.HrmUserVarify;
import weaver.hrm.User;
import org.apache.poi.hssf.usermodel.HSSFFont;
import org.apache.poi.hssf.usermodel.HSSFCellStyle;
import org.apache.poi.hssf.usermodel.HSSFCell;
import org.apache.poi.hssf.usermodel.HSSFRow;
import java.util.Map.Entry;
import org.json.JSONObject;
import org.apache.poi.poifs.filesystem.POIFSFileSystem;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.apache.poi.hssf.usermodel.HSSFSheet;
import weaver.general.Util;
import weaver.general.*;
import java.util.*;
import java.net.*;
import java.io.*;
import java.net.URLDecoder.*;
import weaver.systeminfo.*;
import weaver.file.FileUpload;
import weaver.file.FileManage;

public class _capitalexceltodboperation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.conn.RecordSet RecordSet;
      RecordSet = (weaver.conn.RecordSet) pageContext.getAttribute("RecordSet");
      if (RecordSet == null) {
        RecordSet = new weaver.conn.RecordSet();
        pageContext.setAttribute("RecordSet", RecordSet);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.cpt.ExcelToDB.CapitalExcelToDB CapitalExcelToDB;
      CapitalExcelToDB = (weaver.cpt.ExcelToDB.CapitalExcelToDB) pageContext.getAttribute("CapitalExcelToDB");
      if (CapitalExcelToDB == null) {
        CapitalExcelToDB = new weaver.cpt.ExcelToDB.CapitalExcelToDB();
        pageContext.setAttribute("CapitalExcelToDB", CapitalExcelToDB);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.cpt.util.CptFieldComInfo CptFieldComInfo;
      CptFieldComInfo = (weaver.cpt.util.CptFieldComInfo) pageContext.getAttribute("CptFieldComInfo");
      if (CptFieldComInfo == null) {
        CptFieldComInfo = new weaver.cpt.util.CptFieldComInfo();
        pageContext.setAttribute("CptFieldComInfo", CptFieldComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.cpt.capital.CapitalComInfo CapitalComInfo;
      CapitalComInfo = (weaver.cpt.capital.CapitalComInfo) pageContext.getAttribute("CapitalComInfo");
      if (CapitalComInfo == null) {
        CapitalComInfo = new weaver.cpt.capital.CapitalComInfo();
        pageContext.setAttribute("CapitalComInfo", CapitalComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.proj.util.CodeUtil CodeUtil;
      CodeUtil = (weaver.proj.util.CodeUtil) pageContext.getAttribute("CodeUtil");
      if (CodeUtil == null) {
        CodeUtil = new weaver.proj.util.CodeUtil();
        pageContext.setAttribute("CodeUtil", CodeUtil);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      
response.setHeader("cache-control", "no-cache");
response.setHeader("pragma", "no-cache");
response.setHeader("expires", "Mon 1 Jan 1990 00:00:00 GMT");

      out.write(_jsp_string2, 0, _jsp_string2.length);
      
User user=HrmUserVarify.getUser(request, response);
if(!HrmUserVarify.checkUserRight("Capital:Maintenance",user)) {
	response.sendRedirect("/notice/noright.jsp") ;
	return ;
   }
if(user==null){
	return;
}
FileUpload fu = new FileUpload(request,false,false);
FileManage fm = new FileManage();
int isdata=Util.getIntValue(fu.getParameter("isdata"));
String autocode=Util.null2String(fu.getParameter("autocode"));
String cptdata1ids=Util.null2String(fu.getParameter("cptdata1ids"));//\u5bfc\u5165\u8d44\u4ea7\u7528,\u6a21\u677f\u6dfb\u52a0\u8d44\u4ea7\u8d44\u6599\u7f16\u53f7
String isdialog=Util.null2String(fu.getParameter("isdialog"));
String generateTemplateFile= Util.null2String(fu.getParameter("generateTemplateFile"));
String method=Util.null2String( request.getParameter("method"));
if("1".equals(generateTemplateFile)){
    //\u751f\u6210\u6a21\u677f
	//String filepath=request.getRealPath(request.getServletPath().substring(0,request.getServletPath().lastIndexOf("/")));
	String filepath = GCONST.getRootPath()+"cpt"+File.separatorChar+"capital"+File.separatorChar;
	String filename="";
	String outfilename="";
	String redirect_url="";
	int startcell=0;
	if(isdata==2){
		filename=filepath +"CapitalExcelToDB1.xls";
		outfilename=filepath +"CapitalExcelToDB1new.xls";
		redirect_url="CapitalExcelToDB1.jsp?isFromTab=1&isGeneratedTemplateFile=1&isdialog="+isdialog;
		startcell=14+12+1;
	}else{
		filename=filepath +"CapitalExcelToDB.xls";
		outfilename=filepath +"CapitalExcelToDBnew.xls";
		redirect_url="CapitalExcelToDB.jsp?isFromTab=1&isGeneratedTemplateFile=1&isdialog="+isdialog;
		startcell=17+4;
	}
	
	//\u6dfb\u52a0\u81ea\u5b9a\u4e49\u5b57\u6bb5\u5230\u5bfc\u5165\u6a21\u677f
	POIFSFileSystem fs = null;
	FileInputStream finput =null;
	FileOutputStream fout =null;
	try{
		File file = new File(filename);
		File outfile=new File(outfilename);
		if(outfile.exists()){
			outfile.deleteOnExit();
		}
		if(file.exists()){
			finput = new FileInputStream(filename);
			fs = new POIFSFileSystem(finput);
			fout = new FileOutputStream(outfile);
			HSSFWorkbook workbook = new HSSFWorkbook(fs);
			HSSFSheet sheet = workbook.getSheetAt(0);
			finput.close();
			HSSFRow row= sheet.getRow(0);
			
			//\u5fc5\u586b\u6837\u5f0f
			HSSFCellStyle ismandStyle = workbook.createCellStyle();
			HSSFFont ismandfont = workbook.createFont();
			ismandfont.setColor(HSSFFont.COLOR_RED);
			ismandfont.setFontName(SystemEnv.getHtmlLabelName(16190, user.getLanguage()));
			ismandfont.setFontHeightInPoints((short)12);
			ismandStyle.setFont(ismandfont);
			ismandStyle.setAlignment(HSSFCellStyle.ALIGN_JUSTIFY );
			ismandStyle.setVerticalAlignment(HSSFCellStyle.VERTICAL_CENTER);

            //\u666e\u901a\u6837\u5f0f
            HSSFCellStyle normalStyle = workbook.createCellStyle();
            HSSFFont normalfont = workbook.createFont();
            normalfont.setColor(HSSFFont.COLOR_NORMAL);
            normalfont.setFontName(SystemEnv.getHtmlLabelName(16190, user.getLanguage()));
            normalfont.setFontHeightInPoints((short)12);
            normalStyle.setFont(normalfont);
            normalStyle.setAlignment(HSSFCellStyle.ALIGN_JUSTIFY );
            normalStyle.setVerticalAlignment(HSSFCellStyle.VERTICAL_CENTER);


            //sysfield
            HashMap<String,JSONObject> fieldInfo=CapitalExcelToDB.getFieldInfo();
            if(isdata==1){
                HSSFCell cell=null;

                //\u89c4\u683c\u578b\u53f7
                cell=row.getCell((short)3);
                if(fieldInfo.get("capitalspec").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u7b49\u7ea7
                cell=row.getCell((short)4);
                if(fieldInfo.get("capitallevel").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u5236\u9020\u5382\u5546
                cell=row.getCell((short)5);
                if(fieldInfo.get("manufacturer").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u53c2\u8003\u4ef7\u683c
                cell=row.getCell((short)10);
                if(fieldInfo.get("startprice").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u4f9b\u5e94\u5546
                cell=row.getCell((short)11);
                if(fieldInfo.get("customerid").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u5c5e\u6027
                cell=row.getCell((short)12);
                if(fieldInfo.get("attribute").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u5907\u6ce8
                cell=row.getCell((short)13);
                if(fieldInfo.get("remark").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u6298\u65e7\u5e74\u9650
                cell=row.getCell((short)15);
                if(fieldInfo.get("depreyear").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }

                //\u8d44\u4ea7\u8d44\u6599\u7f16\u53f7
                cell=row.getCell((short)17);
                if("2".equals( CodeUtil.getCptData1CodeUse())){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }

                //\u66ff\u4ee3
                cell=row.getCell((short)18);
                if(fieldInfo.get("replacecapitalid").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u7248\u672c
                cell=row.getCell((short)19);
                if(fieldInfo.get("version").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u6b8b\u503c\u7387
                cell=row.getCell((short)20);
                if(fieldInfo.get("deprerate").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }


            }else if(isdata==2){
                HSSFCell cell=null;

                //\u5165\u5e93\u5355\u4ef7
                cell=row.getCell((short)2);
                if(fieldInfo.get("startprice").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }

                //\u5b58\u653e\u5730\u70b9
                cell=row.getCell((short)8);
                if(fieldInfo.get("location").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u8d44\u4ea7\u72b6\u6001
                cell=row.getCell((short)9);
                if(fieldInfo.get("stateid").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u5165\u5e93\u65e5\u671f
                cell=row.getCell((short)10);
                if(fieldInfo.get("stockindate").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u8d2d\u7f6e\u65e5\u671f
                cell=row.getCell((short)11);
                if(fieldInfo.get("selectdate").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }

                //\u8d44\u4ea7\u7f16\u53f7
                cell=row.getCell((short)12);
                if("2".equals( CodeUtil.getCptData2CodeUse ())){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }

                //\u4f9b\u5e94\u5546
                cell=row.getCell((short)13);
                if(fieldInfo.get("customerid").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u6761\u5f62\u7801
                cell=row.getCell((short)14);
                if(fieldInfo.get("barcode").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u8d22\u52a1\u7f16\u53f7
                cell=row.getCell((short)15);
                if(fieldInfo.get("fnamark").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u751f\u6548\u65e5
                cell=row.getCell((short)16);
                if(fieldInfo.get("startdate").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u751f\u6548\u81f3
                cell=row.getCell((short)17);
                if(fieldInfo.get("enddate").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u51fa\u5382\u65e5\u671f
                cell=row.getCell((short)18);
                if(fieldInfo.get("manudate").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u66ff\u4ee3
                cell=row.getCell((short)19);
                if(fieldInfo.get("replacecapitalid").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u7248\u672c
                cell=row.getCell((short)20);
                if(fieldInfo.get("version").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u8d26\u5185\u6216\u8d26\u5916
                cell=row.getCell((short)21);
                if(fieldInfo.get("isinner").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u5408\u540c\u53f7
                cell=row.getCell((short)22);
                if(fieldInfo.get("contractno").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u53d1\u7968\u53f7\u7801
                cell=row.getCell((short)23);
                if(fieldInfo.get("invoice").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u9886\u7528\u65e5\u671f
                cell=row.getCell((short)24);
                if(fieldInfo.get("deprestartdate").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u5907\u6ce8
                cell=row.getCell((short)25);
                if(fieldInfo.get("remark").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u89c4\u683c\u578b\u53f7
                cell=row.getCell((short)26);
                if(fieldInfo.get("capitalspec").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }

            }


			//cusfield
			TreeMap<String,JSONObject> openfieldMap= CptFieldComInfo.getOpenFieldMap();
			if(!openfieldMap.isEmpty()){
				Iterator it=openfieldMap.entrySet().iterator();
				int i=startcell;
				while(it.hasNext()){
					Entry<String,JSONObject> entry=(Entry<String,JSONObject>)it.next();
					String k= entry.getKey();
					JSONObject v= entry.getValue();
					int fieldhtmltype=v.getInt("fieldhtmltype");
					if(v.getInt("fieldhtmltype")==6||v.getInt("fieldhtmltype")==7){//\u9644\u4ef6\u4e0a\u4f20\u548c\u7279\u6b8a\u5b57\u6bb5\u6ca1\u6709\u5bfc\u5165
						continue;
					}
					HSSFCell cell=null;
					if(row.getCell((short)i)==null){
						cell= row.createCell((short)i);
						cell.setEncoding(HSSFCell.ENCODING_UTF_16);
						cell.setCellValue(SystemEnv.getHtmlLabelName(v.getInt("fieldlabel"),user.getLanguage()));
						
					}else{
						cell=row.getCell((short)i);
						cell.setEncoding(HSSFCell.ENCODING_UTF_16);
						cell.setCellValue(SystemEnv.getHtmlLabelName(v.getInt("fieldlabel"),user.getLanguage()));
					}
					if(v.getInt("ismand")==1){
						cell.setCellStyle(ismandStyle);
					}
					
					i++;
				}
			}
			
			
			workbook.write(fout);
			fout.flush();
			fout.close();
		}
	}catch(Exception e){
		e.printStackTrace();
		//System.out.println("\u751f\u6210\u5bfc\u5165\u6a21\u677f\u65f6\u5f02\u5e38!");
		RecordSet.writeLog(e.getMessage());
	}finally{
		try{
			if(fout!=null){
				fout.close();
			}
			if(finput!=null){
				finput.close();
			}
		}catch(Exception e2){
			e2.printStackTrace();
		}
	}
		
	response.sendRedirect(redirect_url);
	return;
}else if("regenTemplate".equals(method)){
    //\u6dfb\u52a0\u8d44\u4ea7\u8d44\u6599\u7f16\u7801\u5728\u8d44\u4ea7\u6a21\u677f\u91cc
	JSONObject json=new JSONObject();
	json.put("result", "success");
	String cptids=Util.null2String( request.getParameter("cptids"));
	if(!"".equals(cptids)){
		//String filepath=request.getRealPath(request.getServletPath().substring(0,request.getServletPath().lastIndexOf("/")));
		String filepath = GCONST.getRootPath()+"cpt"+File.separatorChar+"capital"+File.separatorChar;
		String filename="";
		String outfilename="";
		filename=filepath +"CapitalExcelToDB1.xls";
		outfilename=filepath +"CapitalExcelToDB1new.xls";
		POIFSFileSystem fs = null;
		FileInputStream finput =null;
		FileOutputStream fout =null;
		try{
			File file = new File(filename);
			File outfile=new File(outfilename);
			if(outfile.exists()){
				outfile.deleteOnExit();
			}
			if(file.exists()){
				finput = new FileInputStream(filename);
				fs = new POIFSFileSystem(finput);
				fout = new FileOutputStream(outfile);
				HSSFWorkbook workbook = new HSSFWorkbook(fs);
				HSSFSheet sheet = workbook.getSheetAt(0);
				finput.close();
				
				HSSFRow row= sheet.getRow(0);
			
				//\u5fc5\u586b\u6837\u5f0f
				HSSFCellStyle ismandStyle = workbook.createCellStyle();
				HSSFFont ismandfont = workbook.createFont();
				ismandfont.setColor(HSSFFont.COLOR_RED);
				ismandfont.setFontName(SystemEnv.getHtmlLabelName(16190, user.getLanguage()));
				ismandfont.setFontHeightInPoints((short)12);
				ismandStyle.setFont(ismandfont);
				ismandStyle.setAlignment(HSSFCellStyle.ALIGN_JUSTIFY );
				ismandStyle.setVerticalAlignment(HSSFCellStyle.VERTICAL_CENTER);

				//\u666e\u901a\u6837\u5f0f
				HSSFCellStyle normalStyle = workbook.createCellStyle();
				HSSFFont normalfont = workbook.createFont();
				normalfont.setColor(HSSFFont.COLOR_NORMAL);
				normalfont.setFontName(SystemEnv.getHtmlLabelName(16190, user.getLanguage()));
				normalfont.setFontHeightInPoints((short)12);
				normalStyle.setFont(normalfont);
				normalStyle.setAlignment(HSSFCellStyle.ALIGN_JUSTIFY );
				normalStyle.setVerticalAlignment(HSSFCellStyle.VERTICAL_CENTER);


				//sysfield
				HashMap<String,JSONObject> fieldInfo=CapitalExcelToDB.getFieldInfo();
				HSSFCell cell=null;

                //\u5165\u5e93\u5355\u4ef7
                cell=row.getCell((short)2);
                if(fieldInfo.get("startprice").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }

                //\u5b58\u653e\u5730\u70b9
                cell=row.getCell((short)8);
                if(fieldInfo.get("location").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u8d44\u4ea7\u72b6\u6001
                cell=row.getCell((short)9);
                if(fieldInfo.get("stateid").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u5165\u5e93\u65e5\u671f
                cell=row.getCell((short)10);
                if(fieldInfo.get("stockindate").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u8d2d\u7f6e\u65e5\u671f
                cell=row.getCell((short)11);
                if(fieldInfo.get("selectdate").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }

                //\u8d44\u4ea7\u7f16\u53f7
                cell=row.getCell((short)12);
                if("2".equals( CodeUtil.getCptData2CodeUse ())){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }

                //\u4f9b\u5e94\u5546
                cell=row.getCell((short)13);
                if(fieldInfo.get("customerid").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u6761\u5f62\u7801
                cell=row.getCell((short)14);
                if(fieldInfo.get("barcode").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u8d22\u52a1\u7f16\u53f7
                cell=row.getCell((short)15);
                if(fieldInfo.get("fnamark").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u751f\u6548\u65e5
                cell=row.getCell((short)16);
                if(fieldInfo.get("startdate").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u751f\u6548\u81f3
                cell=row.getCell((short)17);
                if(fieldInfo.get("enddate").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u51fa\u5382\u65e5\u671f
                cell=row.getCell((short)18);
                if(fieldInfo.get("manudate").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u66ff\u4ee3
                cell=row.getCell((short)19);
                if(fieldInfo.get("replacecapitalid").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u7248\u672c
                cell=row.getCell((short)20);
                if(fieldInfo.get("version").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u8d26\u5185\u6216\u8d26\u5916
                cell=row.getCell((short)21);
                if(fieldInfo.get("isinner").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u5408\u540c\u53f7
                cell=row.getCell((short)22);
                if(fieldInfo.get("contractno").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u53d1\u7968\u53f7\u7801
                cell=row.getCell((short)23);
                if(fieldInfo.get("invoice").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u9886\u7528\u65e5\u671f
                cell=row.getCell((short)24);
                if(fieldInfo.get("deprestartdate").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u5907\u6ce8
                cell=row.getCell((short)25);
                if(fieldInfo.get("remark").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }
                //\u89c4\u683c\u578b\u53f7
                cell=row.getCell((short)26);
                if(fieldInfo.get("capitalspec").getBoolean("ismand")){
                    cell.setCellStyle(ismandStyle);
                }else{
                    cell.setCellStyle(normalStyle);
                }

				int startcell=14+12+1;
				//cusfield
				TreeMap<String,JSONObject> openfieldMap= CptFieldComInfo.getOpenFieldMap();
				if(!openfieldMap.isEmpty()){
					Iterator it=openfieldMap.entrySet().iterator();
					int i=startcell;
					while(it.hasNext()){
						Entry<String,JSONObject> entry=(Entry<String,JSONObject>)it.next();
						String k= entry.getKey();
						JSONObject v= entry.getValue();
						int fieldhtmltype=v.getInt("fieldhtmltype");
						if(v.getInt("fieldhtmltype")==6||v.getInt("fieldhtmltype")==7){//\u9644\u4ef6\u4e0a\u4f20\u548c\u7279\u6b8a\u5b57\u6bb5\u6ca1\u6709\u5bfc\u5165
							continue;
						}
						if(row.getCell((short)i)==null){
							cell= row.createCell((short)i);
							cell.setEncoding(HSSFCell.ENCODING_UTF_16);
							cell.setCellValue(SystemEnv.getHtmlLabelName(v.getInt("fieldlabel"),user.getLanguage()));
							
						}else{
							cell=row.getCell((short)i);
							cell.setEncoding(HSSFCell.ENCODING_UTF_16);
							cell.setCellValue(SystemEnv.getHtmlLabelName(v.getInt("fieldlabel"),user.getLanguage()));
						}
						if(v.getInt("ismand")==1){
							cell.setCellStyle(ismandStyle);
						}
						
						i++;
					}
				}
			
			
				//\u6e05\u6389\u6b8b\u7559\u884c
				int rownum=sheet.getLastRowNum();
				for(int i=1;i<rownum+1;i++){
					sheet.removeRow(sheet.getRow(i));
				}
				
				String[]cptarr=Util.TokenizerString2( cptids,",");
				for(int i=0;i<cptarr.length;i++){
					row= sheet.createRow(i+1);
					cell=row.createCell((short)0);
					cell.setEncoding(HSSFCell.ENCODING_UTF_16);
					cell.setCellValue(CapitalComInfo.getMark(cptarr[i]) );
				}
				
				workbook.write(fout);
				fout.flush();
				fout.close();
			}else{
				json.put("result", "failure");
			}
		}catch(Exception e){
			e.printStackTrace();
			json.put("result", "failure");
			RecordSet.writeLog(e.getMessage());
		}finally{
			try{
				if(fout!=null){
					fout.close();
				}
				if(finput!=null){
					finput.close();
				}
			}catch(Exception e2){
				e2.printStackTrace();
				json.put("result", "failure");
			}
		}
		
		
	}
	
	
	
	out.print(json.toString());
}else{
    //\u5bfc\u5165\u8d44\u4ea7\u6216\u8d44\u4ea7\u8d44\u6599
	String responsepage="CapitalExcelToDB.jsp?isFromTab=1&isGeneratedTemplateFile=1&isdialog="+isdialog;
	if(isdata==2) responsepage="CapitalExcelToDB1.jsp?isFromTab=1&isGeneratedTemplateFile=1&isdialog="+isdialog;
	String Excelfilepath="";

	int fileid = 0 ;

	try {
	    fileid = Util.getIntValue(fu.uploadFiles("filename"),0);

	    String filename = fu.getFileName();


	    String sql = "select filerealpath from imagefile where imagefileid = "+fileid;
	    RecordSet.executeSql(sql);
	    String uploadfilepath="";
	    if(RecordSet.next()) uploadfilepath =  RecordSet.getString("filerealpath");


	 	if(!uploadfilepath.equals("")){

	        Excelfilepath = GCONST.getRootPath()+"cpt/ExcelToDB"+File.separatorChar+filename ;
	        fm.copy(uploadfilepath,Excelfilepath);
		}


	 
	 
	String msg="";
	String msg1="";
	String msg2="";
	String msg3="";
	int    msgsize=0;
    session.removeAttribute("cptexceltodb_totalCount");
    session.removeAttribute("cptexceltodb_successCount");
	CapitalExcelToDB.ExcelToDB(Excelfilepath,isdata,user.getUID(),user.getLanguage(),request.getRemoteAddr(),autocode);
	msgsize=CapitalExcelToDB.getMsg1().size();
    session.setAttribute("cptexceltodb_totalCount",""+ CapitalExcelToDB.getTotalCount());
    session.setAttribute("cptexceltodb_successCount", "" + CapitalExcelToDB.getSuccessCount());
	String msgType = CapitalExcelToDB.getMsgType();
	 
	
	if(msgsize==0){
	    msg="success";
	    response.sendRedirect(responsepage+"&msg="+msg+"&msgType="+msgType);
	}else{
	    for (int i = 0; i <msgsize; i++){
	    msg1=msg1+(String)CapitalExcelToDB.getMsg1().elementAt(i)+",";	    
	    msg2=msg2+(String)CapitalExcelToDB.getMsg2().elementAt(i)+",";	   
	    msg3=msg3+(String)CapitalExcelToDB.getMsg3().elementAt(i)+"-";   
	    }
	    fm.DeleteFile(Excelfilepath);
		session.setAttribute("cptmsg1",msg1);
		session.setAttribute("cptmsg2",msg2);
		session.setAttribute("cptmsg3",msg3);
		
	    response.sendRedirect(responsepage+"&msg="+msg+"&msgsize="+msgsize+"&msgType="+msgType);
	}
	}
	catch(Exception e) {
		new BaseBean().writeLog(e.getMessage());
		//System.out.println(e.getMessage());
	}
}

      out.write(_jsp_string1, 0, _jsp_string1.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("cpt/capital/CapitalExcelToDBOperation.jsp"), -7816302107944004745L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string1;
  private final static char []_jsp_string2;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
    _jsp_string2 = "\r\n\r\n".toCharArray();
  }
}
