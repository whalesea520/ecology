/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._cpt._maintenance;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import net.sf.json.JSONObject;
import weaver.hrm.User;
import weaver.hrm.HrmUserVarify;
import java.net.URLDecoder;
import weaver.general.Util;
import weaver.file.FileUpload;
import java.util.*;

public class _cptassortmentoperation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=utf-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.systeminfo.SysMaintenanceLog SysMaintenanceLog;
      SysMaintenanceLog = (weaver.systeminfo.SysMaintenanceLog) pageContext.getAttribute("SysMaintenanceLog");
      if (SysMaintenanceLog == null) {
        SysMaintenanceLog = new weaver.systeminfo.SysMaintenanceLog();
        pageContext.setAttribute("SysMaintenanceLog", SysMaintenanceLog);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.cpt.maintenance.CapitalAssortmentComInfo CapitalAssortmentComInfo;
      CapitalAssortmentComInfo = (weaver.cpt.maintenance.CapitalAssortmentComInfo) pageContext.getAttribute("CapitalAssortmentComInfo");
      if (CapitalAssortmentComInfo == null) {
        CapitalAssortmentComInfo = new weaver.cpt.maintenance.CapitalAssortmentComInfo();
        pageContext.setAttribute("CapitalAssortmentComInfo", CapitalAssortmentComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet RecordSet;
      RecordSet = (weaver.conn.RecordSet) pageContext.getAttribute("RecordSet");
      if (RecordSet == null) {
        RecordSet = new weaver.conn.RecordSet();
        pageContext.setAttribute("RecordSet", RecordSet);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      
User  user= HrmUserVarify.getUser(request, response);
if(user==null){
	return;
}

JSONObject jsonObject=new JSONObject();
RecordSet.executeSql("select cptdetachable from SystemSet");
int detachable=0;
if(RecordSet.next()){
	detachable = RecordSet.getInt("cptdetachable");
}

String operation = Util.null2String(request.getParameter("operation"));
char separator = Util.getSeparator() ;

if(operation.equals("addassortment")||operation.equals("editassortment")){
	String assortmentname = Util.fromScreen(request.getParameter("assortmentname"),user.getLanguage());
	String assortmentmark = Util.fromScreen(request.getParameter("assortmentmark"),user.getLanguage());
	String supassortmentid = Util.null2String(request.getParameter("supassortmentid"));
	String supassortmentstr = Util.null2String(request.getParameter("supassortmentstr"));
	String assortmentremark=Util.fromScreen(request.getParameter("Remark"),user.getLanguage());
	int subcompanyid1=Util.getIntValue(request.getParameter("subcompanyid1"),0);
	String tempsql11 = "";
	if(1==detachable){
		tempsql11=" and subcompanyid1="+subcompanyid1+" ";
	}else{
		tempsql11=" and (subcompanyid1='' or subcompanyid1 is null or subcompanyid1=0) ";
	}

 if(operation.equals("addassortment")){
	 if(!HrmUserVarify.checkUserRight("CptCapitalGroupAdd:Add",user)) {
			response.sendRedirect("/notice/noright.jsp") ;
			return ;
		   }
	String para = "";

	para  = assortmentname;
	para += separator+assortmentmark;
	para += separator+assortmentremark;
	para += separator+supassortmentid;
	para += separator+supassortmentstr;



	/*\u5224\u65ad\u662f\u5426\u7f16\u53f7\u91cd\u590d*/
	boolean invalid=false;
	RecordSet.executeProc("CptCapitalAssortment_SelectAll","");
	while(RecordSet.next()){
		String 	tempmark = RecordSet.getString("assortmentmark");
		String  tempsupassortmentstr = RecordSet.getString("supassortmentstr");
		if(assortmentmark.equals(tempmark)&&supassortmentstr.equals(tempsupassortmentstr)){
			//response.sendRedirect("CptAssortmentAdd.jsp?msgid=31&paraid="+supassortmentid);
			invalid=true;
			break;
		}
	}
	
	if(invalid){
		jsonObject.put("msgid", 31);
		out.print(jsonObject.toString());
	}else{
		/*\u5224\u65ad\u7edf\u8ba1\u8d44\u4ea7\u7ec4\u662f\u5426\u91cd\u540d*/
		
		String sql = "select assortmentname from CptCapitalAssortment where assortmentname='"+assortmentname+"' "+tempsql11+" and supassortmentid="+supassortmentid;
		RecordSet.executeSql(sql);
		if(RecordSet.next()){
			//response.sendRedirect("CptAssortmentAdd.jsp?msgid=162&paraid="+supassortmentid);
			jsonObject.put("msgid", 162);
			out.print(jsonObject.toString());
		}else{

            RecordSet.executeSql("update CptCapitalAssortment set capitalcount=0 where id="+supassortmentid);
			RecordSet.executeProc("CptCapitalAssortment_Insert",para);
			RecordSet.next();
			int	id = RecordSet.getInt(1);
			if(id == -1)  {
				//response.sendRedirect("CptAssortmentAdd.jsp?msgid=34&paraid="+supassortmentid);
				jsonObject.put("msgid", 34);
				out.print(jsonObject.toString());
				//return ;
			}else{
				if(subcompanyid1>0){
					RecordSet.executeSql("update CptCapitalAssortment set subcompanyid1='"+subcompanyid1+"' where id= "+id);
				}
				
				

				SysMaintenanceLog.resetParameter();
				SysMaintenanceLog.setRelatedId(id);
				SysMaintenanceLog.setRelatedName(assortmentname);
				SysMaintenanceLog.setOperateType("1");
				SysMaintenanceLog.setOperateDesc("CptCapitalAssortment_Insert,"+para);
				SysMaintenanceLog.setOperateItem("43");
				SysMaintenanceLog.setOperateUserid(user.getUID(user,"CptCapitalGroupAdd:Add"));
				SysMaintenanceLog.setClientAddress(request.getRemoteAddr());
				SysMaintenanceLog.setSysLogInfo();

				CapitalAssortmentComInfo.removeCapitalAssortmentCache() ;
				
				out.print(jsonObject.toString());
			}
			
		}
		
	}
		
	//response.sendRedirect("CptAssortmentView.jsp?paraid="+id);
} //end (operation.equals("addassortment"))
 else if(operation.equals("editassortment")){
	if(!HrmUserVarify.checkUserRight("CptCapitalGroupEdit:Edit",user)) {
			response.sendRedirect("/notice/noright.jsp") ;
			return ;
		   }
  	String assortmentid = Util.null2String(request.getParameter("assortmentid"));

	String para = "";
	para = assortmentid;
	para += separator+assortmentname;
	para += separator+assortmentmark;
	para += separator+assortmentremark;
	para += separator+supassortmentid;
	para += separator+supassortmentstr;


	/*\u5224\u65ad\u662f\u5426\u7f16\u53f7\u91cd\u590d*/
	boolean invalid=false;
	RecordSet.executeProc("CptCapitalAssortment_SelectAll","");
	while(RecordSet.next()){
		String  tempid = RecordSet.getString("id");
		String 	tempmark = RecordSet.getString("assortmentmark");
		String  tempsupassortmentstr = RecordSet.getString("supassortmentstr");
		if(assortmentmark.equals(tempmark)&&supassortmentstr.equals(tempsupassortmentstr)&&!assortmentid.equals(tempid)){
			//response.sendRedirect("CptAssortmentEdit.jsp?paraid="+assortmentid+"&msgid=31");
			invalid=true;
			break;
		}
	}
	if(invalid){//\u7f16\u53f7\u91cd\u590d
		jsonObject.put("msgid", 31);
		out.print(jsonObject.toString());
	}else{
		/*\u5224\u65ad\u8d44\u4ea7\u7ec4\u662f\u5426\u91cd\u540d*/
		String sql = "select assortmentname from CptCapitalAssortment where assortmentname='"+assortmentname+"' "+tempsql11+" and supassortmentid="+supassortmentid+"and id<>"+assortmentid;
		RecordSet.executeSql(sql);
		if(RecordSet.next()){
			//response.sendRedirect("/cpt/maintenance/CptAssortmentEdit.jsp?paraid="+assortmentid+"&msgid=162");
			jsonObject.put("msgid", 162);
			out.print(jsonObject.toString());
		}else{
			//\u66f4\u65b0
			RecordSet.executeProc("CptCapitalAssortment_Update",para);

			if(RecordSet.next()) {
				//response.sendRedirect("CptAssortmentEdit.jsp?paraid="+assortmentid+"&msgid=13");
				jsonObject.put("msgid", 13);
				out.print(jsonObject.toString());
			}else{
				SysMaintenanceLog.resetParameter();
				SysMaintenanceLog.setRelatedId(Util.getIntValue(assortmentid));
				SysMaintenanceLog.setRelatedName(assortmentname);
				SysMaintenanceLog.setOperateType("2");
				SysMaintenanceLog.setOperateDesc("CptCapitalAssortment_Update,"+para);
				SysMaintenanceLog.setOperateItem("43");
				SysMaintenanceLog.setOperateUserid(user.getUID(user,"CptCapitalGroupEdit:Edit"));
				SysMaintenanceLog.setClientAddress(request.getRemoteAddr());
				SysMaintenanceLog.setSysLogInfo();
				CapitalAssortmentComInfo.removeCapitalAssortmentCache() ;
				out.print(jsonObject.toString());
			}
		}
	}
	//response.sendRedirect("CptAssortmentView.jsp?paraid="+assortmentid);
 }//end if (operation.equals("editassortment"))
}//end if (operation.equals("addassortment")||operation.equals("editassortment"))
 else if(operation.equals("deleteassortment")){
	 if(!HrmUserVarify.checkUserRight("CptCapitalGroupEdit:Edit",user)) {
			response.sendRedirect("/notice/noright.jsp") ;
			return ;
		   }
  	int assortmentid = Util.getIntValue(request.getParameter("assortmentid"));
	String para = ""+assortmentid;
	RecordSet.executeSql("update CptCapitalAssortment set capitalcount=0 where id="+para);
	RecordSet.executeProc("CptCapitalAssortment_Delete",para);

	if(RecordSet.next() && RecordSet.getString(1).equals("-1")){
		//response.sendRedirect("CptAssortmentTab.jsp?paraid="+assortmentid+"&msgid=20");
		jsonObject.put("msgid", 20);
		out.print(jsonObject.toString());
	}else{
		 CapitalAssortmentComInfo.removeCapitalAssortmentCache() ;
		 out.print(jsonObject.toString());
	}
  
 }else if("batchdeleteassortment".equalsIgnoreCase (operation)){
	String assortmentid = Util.null2String(request.getParameter("assortmentid"));

	String [] arr= Util.TokenizerString2(assortmentid, ",");
	for(int i=0;i<arr.length;i++){
		String para = ""+arr[i];
		RecordSet.executeSql("update CptCapitalAssortment set capitalcount=0 where id="+para);
		RecordSet.executeProc("CptCapitalAssortment_Delete",para);
	}

    CapitalAssortmentComInfo.removeCapitalAssortmentCache() ;
    out.print(jsonObject.toString());
 }



      out.write(_jsp_string2, 0, _jsp_string2.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("cpt/maintenance/CptAssortmentOperation.jsp"), 7211840833454898025L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string1;
  private final static char []_jsp_string2;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n \r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
    _jsp_string2 = "\r\n\r\n".toCharArray();
  }
}
