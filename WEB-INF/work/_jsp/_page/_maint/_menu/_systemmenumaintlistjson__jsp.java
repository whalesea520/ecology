/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._page._maint._menu;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import java.util.*;
import weaver.conn.*;
import weaver.hrm.*;
import weaver.general.*;
import weaver.systeminfo.*;
import weaver.systeminfo.menuconfig.*;
import net.sf.json.JSONObject;

public class _systemmenumaintlistjson__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.hrm.moduledetach.ManageDetachComInfo ManageDetachComInfo;
      ManageDetachComInfo = (weaver.hrm.moduledetach.ManageDetachComInfo) pageContext.getAttribute("ManageDetachComInfo");
      if (ManageDetachComInfo == null) {
        ManageDetachComInfo = new weaver.hrm.moduledetach.ManageDetachComInfo();
        pageContext.setAttribute("ManageDetachComInfo", ManageDetachComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      
response.setHeader("cache-control", "no-cache");
response.setHeader("pragma", "no-cache");
response.setHeader("expires", "Mon 1 Jan 1990 00:00:00 GMT");

User user = HrmUserVarify.getUser(request,response);
if(user == null)  return ;

int parentid=Util.getIntValue(Util.null2String(request.getParameter("parentid")),0);
String type = Util.null2String(request.getParameter("type"));
String mode = Util.null2String(request.getParameter("mode"));
int resourceId = Util.getIntValue(request.getParameter("resourceId"),0);
int resourceType = Util.getIntValue(Util.null2String((String)request.getParameter("resourceType")),0);
int languageId = user.getLanguage();

String tblInfo = "";
String tblConfig = "";
if ("left".equalsIgnoreCase(type)) {
	tblInfo = "leftmenuinfo";
	tblConfig = "leftmenuconfig";
} else if ("top".equalsIgnoreCase(type)) {
	tblInfo = "mainmenuinfo";
	tblConfig = "mainmenuconfig";
}

boolean isDetachable=ManageDetachComInfo.isUsePortalManageDetach();
RecordSet rs1=new RecordSet();
RecordSet rs=new RecordSet();

	MenuUtil mu=new MenuUtil(type,resourceType,resourceId,languageId);
	mu.setUser(user);
	if(parentid==0){
	new BaseBean().writeLog("in SystemMenuMaint getAllMenuRs");
	 rs = mu.getAllMenuRs(1,mode);
	}
	else {
	new BaseBean().writeLog("in SystemMenuMaint getMenuRs");
	rs = mu.getMenuRs(parentid,mode);
	}
	
	List spareList=new ArrayList();
	StringBuffer treeStr = new StringBuffer();
	treeStr.append("[");
	while (rs.next()) {
		JSONObject json = new JSONObject ();
		//treeStr = new StringBuffer();
		
		int visible = Util.getIntValue(rs.getString("visible"), 0);
		
		int infoId = rs.getInt("infoId");
		
		 int needResourcetype=rs.getInt("resourcetype");
			int needResourceid=rs.getInt("resourceid");
			if(resourceType==3){
				if(!mu.hasShareRight(infoId,needResourceid,needResourcetype)){
					continue;
				}
			}
	        
		//System.out.println(infoId);
		String iconUrl = rs.getString("iconUrl");
		String linkAddress = rs.getString("linkAddress");
		linkAddress=Util.replace(linkAddress, "&", "&#38;", 0);
		String isCustom = rs.getString("isCustom");
		int labelId = rs.getInt("labelId");
		boolean useCustomName = rs.getInt("useCustomName") == 1 ? true: false;
		String customName = rs.getString("customName");
		String customName_e = rs.getString("customName_e");
		String customName_t = rs.getString("customName_t");
		String module = Util.null2String(rs.getString("module"));
		if(!"".equals(module)){
			MouldStatusCominfo msc=new MouldStatusCominfo();
			String status=Util.null2String(msc.getStatus(module));
			//System.out.println(module+":"+status);
			if("0".equals(status)) 		continue;
		}
		
		boolean infoUseCustomName = rs.getInt("infoUseCustomName") == 1 ? true
				: false;
		String infoCustomName = rs.getString("infoCustomName");
		String infoCustomName_e = rs.getString("infoCustomName_e");
		String infoCustomName_t = rs.getString("infoCustomName_t");
		String viewIndex=rs.getString("viewIndex");
		
			
		int refersubid=Util.getIntValue(rs.getString("refersubid"),-1);		
		
		String baseTarget= Util.null2String(rs.getString("baseTarget"));			

		String text = mu.getMenuText(labelId, useCustomName, customName, customName_e,customName_t, infoUseCustomName, infoCustomName, infoCustomName_e, infoCustomName_t, languageId);			
		int parentId = Util.getIntValue(rs.getString("parentId"), 0);
		
		if(spareList.contains(""+infoId)) continue;
		spareList.add(""+infoId);
		if("top".equals(type))			
			if(infoId==1 || infoId==10  || infoId==26 ||  infoId==27 ||  infoId==19) continue;
		
		
		if("".equals(baseTarget)) baseTarget="mainFrame";
		
		if("".equals(iconUrl)) iconUrl="/images/homepage/baseelement_wev8.gif";
		
		String mainMenuId=""; 
		if(infoId==110) mainMenuId="10"; //report
		else if(infoId==114)  mainMenuId="0"; //setting
		else if(infoId==118)  mainMenuId="news"; //\u65b0\u95fb\u516c\u544a
		else if(infoId==119)  {
			continue;
			//mainMenuId="voting"; //\u7f51\u4e0a\u8c03\u67e5
		}
		else if(infoId==115)  { 
			continue;
			//mainMenuId="remind"; //\u63d0\u9192\u4fe1\u606f
		
		}
		
		linkAddress=Util.StringReplace(linkAddress, "\\", "/");

		json.put("id",infoId);
		json.put("isParent",rs.getInt("curParent") > 0); 
	    json.put("isReferedParent",rs.getInt("allParent") > 0); 
		json.put("parentId",parentId);
		json.put("name",text);
		
		json.put("openIcon",iconUrl);
		json.put("icon",iconUrl);
		json.put("linkAddress",linkAddress);
		
		json.put("isCustom",isCustom);
		json.put("visible",visible);
		json.put("baseTarget",baseTarget);
		
		json.put("refersubid",refersubid);
		json.put("action",linkAddress);
		json.put("mainMenuId",mainMenuId);

		if(resourceType==3){
			json.put("chkDisabled",true);
		}else{
			json.put("chkDisabled",false);
		}
		
		
	    if(needResourcetype==1){/*\u603b\u90e8 z* \u5206\u90e8 s*  \u4e2a\u4eba r*  */
	    	json.put("ownerid","z"+needResourceid);
	    } else if(needResourcetype==2){
	    	json.put("ownerid","s"+needResourceid);
	    }else if(needResourcetype==3){
	    	json.put("ownerid","r"+needResourceid);
	    	json.put("chkDisabled",false);
	    }
	    //System.out.println(resourceType+"%%%"+needResourcetype+"%%%"+resourceId+"%%%"+needResourceid);
	    //if(resourceType==needResourcetype&&resourceId==needResourceid)
	    json.put("hasReferedToSub",refersubid!=-1);//\u662f\u5426\u540c\u6b65\u5230\u4e0b\u7ea7
		if(refersubid==-1 || refersubid==0 && resourceType==1 ||refersubid==resourceId){
	    	// json.put("chkDisabled",false);
	    	 json.put("canEdit",true);

	    }else{
	    	 
	    	 json.put("canEdit",false);
	    }
	    json.put("remark","");
	    
	//  	rs1.executeSql("select count(0) c from " + tblInfo + " t1, "+tblConfig+" t2 where t2.infoId = t1.id and t2.resourcetype = "+resourceType+"  and t2.resourceid = "+resourceId+" and t1.parentId = " + infoId);
	 //  	rs1.executeSql("select count(0) c from " + tblInfo + " where parentId = " + infoId);//\u603b\u90e8\u5efa\u7684\u83dc\u5355\uff0c\u5206\u90e8\u5728\u8be5\u83dc\u5355\u4e0b\u5efa\u4e86\u4e0b\u7ea7\u83dc\u5355\uff0c\u603b\u90e8\u5220\u9664\u65f6\u9700\u63d0\u793a\u6709\u4e0b\u7ea7\u83dc\u5355\uff1f
	 // 	if(rs1.next()&&rs1.getInt("c")==0) json.put("isParent",false); 
	    json.put("viewIndex",viewIndex);
	    json.put("checked",visible==1?true:false);
	   
	    treeStr.append(json.toString());
	    treeStr.append(",");
	}
	if(treeStr.length()==1){
		out.print("[]");
	}else{
		out.print(treeStr.toString().substring(0,treeStr.toString().length()-1)+"]");
	}

    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("page/maint/menu/SystemMenuMaintListJSON.jsp"), -7151983106184727064L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string1;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n\r\n".toCharArray();
  }
}
