/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._system;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.general.*;
import java.util.*;
import java.io.*;
import weaver.hrm.*;
import weaver.systeminfo.*;
import weaver.file.FileUpload;
import weaver.file.FileManage;

public class _licenseoperation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      ln.LN LN;
      LN = (ln.LN) pageContext.getAttribute("LN");
      if (LN == null) {
        LN = new ln.LN();
        pageContext.setAttribute("LN", LN);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet RecordSet;
      RecordSet = (weaver.conn.RecordSet) pageContext.getAttribute("RecordSet");
      if (RecordSet == null) {
        RecordSet = new weaver.conn.RecordSet();
        pageContext.setAttribute("RecordSet", RecordSet);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      com.weaver.upgrade.FunctionUpgrade FunctionUpgrade;
      FunctionUpgrade = (com.weaver.upgrade.FunctionUpgrade) pageContext.getAttribute("FunctionUpgrade");
      if (FunctionUpgrade == null) {
        FunctionUpgrade = new com.weaver.upgrade.FunctionUpgrade();
        pageContext.setAttribute("FunctionUpgrade", FunctionUpgrade);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      
response.setHeader("cache-control", "no-cache");
response.setHeader("pragma", "no-cache");
response.setHeader("expires", "Mon 1 Jan 1990 00:00:00 GMT");

      out.write(_jsp_string2, 0, _jsp_string2.length);
      
String message = "0" ;
String imagefilename = "/images/hdSystem_wev8.gif";
String titlename = "LICENSE" ;
String needfav ="1";
String needhelp ="";

FileUpload fu = new FileUpload(request,false);
FileManage fm = new FileManage();
String code = Util.null2String(fu.getParameter("code")).trim();
char[]  c_code=new char[16];
new FileReader(GCONST.getRootPath()+File.separator+"WEB-INF"+File.separator+"code.key").read(c_code);

String realcode=new String(c_code).trim();
if(code.equals("")){//message=7 \u8868\u793acode\u4e3a\u7a7a\u6216\u8005upload\u51fa\u9519
	message = "7";
	response.sendRedirect("InLicense.jsp?message="+message+"&code="+code);
	return; 
}
if(!realcode.equals(code)&&!code.equals("")){ 
	//out.println(code);  

      out.write(_jsp_string3, 0, _jsp_string3.length);
      out.print((SystemEnv.getHtmlLabelName(129308, 7)));
      out.write(_jsp_string1, 0, _jsp_string1.length);
      return;
}  
int fileid = 0 ;
try {
	//message=0 \u8868\u793aLicense\u4fe1\u606f\u9519\u8bef;message=1 \u8868\u793a\u6210\u529f;message=2 \u8868\u793a\u6570\u636e\u5e93\u8fde\u63a5\u6216\u8005\u6267\u884c\u51fa\u9519;message=3 \u8868\u793aLicense\u6587\u4ef6\u4e0a\u4f20\u51fa\u9519;
	//message=4 \u8868\u793aLicense\u4fe1\u606f\u9519\u8bef\uff0cLicense\u8fc7\u671f;message=5 \u8868\u793aLicense\u4fe1\u606f\u9519\u8bef\uff0c\u6ce8\u518c\u7528\u6237\u6570\u5927\u4e8eLicense\u7533\u8bf7\u4eba\u6570;message=6 \u8868\u793a\u9009\u62e9\u7684License\u6587\u4ef6\u4e0d\u6b63\u786e
	fileid = Util.getIntValue(fu.uploadFiles("license"),0);
	
	String filename = fu.getFileName(); 
	
	String sql = "select isaesencrypt,aescode,filerealpath from imagefile where imagefileid = "+fileid;  
	boolean r1 = RecordSet.executeSql(sql);
	
	if(!r1) message="2";//message=2 \u8868\u793a\u6570\u636e\u5e93\u8fde\u63a5\u6216\u8005\u6267\u884c\u51fa\u9519
	
	String uploadfilepath="";
	String isaesencrypt ="";
	String aescode="";
	if(RecordSet.next()){
		uploadfilepath = RecordSet.getString("filerealpath");
		isaesencrypt = RecordSet.getString("isaesencrypt");
		aescode = RecordSet.getString("aescode");
	}
	if(!uploadfilepath.equals("")){
		String cid = Util.null2String(LN.getCid());
		String licensefilepath2 = GCONST.getRootPath()+"license"+File.separatorChar+LN.OutLicensecode()+".license" ;
		String licensefilepathOriBak = GCONST.getRootPath()+"license"+File.separatorChar+LN.OutLicensecode()+"_bak.license" ;
		try{
			fm.copy(licensefilepath2,licensefilepathOriBak);
		}catch(Exception e){}
		fm.copy(uploadfilepath,licensefilepath2,isaesencrypt,aescode);
		 String ncid = LN.ReadFromFile2(licensefilepath2);
		 if(!cid.equals("") && (!ncid.equals(cid) || ncid.equals(""))){
			message = "-99";
			fm.DeleteFile(uploadfilepath);
		 }else{
			 LN.removeLicenseComInfo();
			 LN.ReadFromFile(licensefilepath2);
			 message = LN.InLicense();
		 }
		 //fm.DeleteFile(licensefilepath2);
		//System.out.println("...............................message------>"+message);
		//if(!message.equals("-99")){
		if(message.equals("1")){
			String licensefilepath = GCONST.getRootPath()+"license"+File.separatorChar+LN.OutLicensecode()+".license" ;
			fm.copy(uploadfilepath,licensefilepath,isaesencrypt,aescode);
			fm.DeleteFile(uploadfilepath);
			LN.removeLicenseComInfo();
	        LN.ReadFromFile(licensefilepath);
			message = LN.InLicense();
			
			FunctionUpgrade.doUpgrade();
		}else{
			try{
				fm.copy(licensefilepathOriBak,licensefilepath2);
			}catch(Exception e){}
			LN.removeLicenseComInfo();
	        LN.ReadFromFile(licensefilepath2);
			//message = LN.InLicense();
			if("".equals(message) || "-99".equals(message)){
				//System.out.println(".22222..............................message------>"+message);
				RecordSet.writeLog("...............................message------>"+message);
				message = "0";
			}
		}
	}
}catch(Exception e) {
	RecordSet.writeLog(e);
    message = "3" ;//message=3 \u8868\u793aLicense\u6587\u4ef6\u4e0a\u4f20\u51fa\u9519
}

response.sendRedirect("InLicense.jsp?message="+message+"&code="+new Date().getTime());


      out.write(_jsp_string2, 0, _jsp_string2.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("system/LicenseOperation.jsp"), -3070464275666630760L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string1;
  private final static char []_jsp_string3;
  private final static char []_jsp_string2;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
    _jsp_string3 = " \r\n".toCharArray();
    _jsp_string2 = "\r\n\r\n".toCharArray();
  }
}
