/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._login;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.general.Util;
import weaver.hrm.User;
import weaver.hrm.HrmUserVarify;
import java.util.Map;
import weaver.hrm.settings.RemindSettings;
import weaver.hrm.*;
import weaver.file.Prop;
import java.net.URLEncoder;
import weaver.interfaces.sso.cas.CasSetting;
import weaver.interfaces.sso.cas.CasUtil;

public class _logout__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.login.LicenseCheckLogin LicenseCheckLogin;
      LicenseCheckLogin = (weaver.login.LicenseCheckLogin) pageContext.getAttribute("LicenseCheckLogin");
      if (LicenseCheckLogin == null) {
        LicenseCheckLogin = new weaver.login.LicenseCheckLogin();
        pageContext.setAttribute("LicenseCheckLogin", LicenseCheckLogin);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      
	User user = HrmUserVarify.getUser(request, response);
	RemindSettings settings0 = (RemindSettings) application.getAttribute("hrmsettings");
	Map logmessages = (Map) application.getAttribute("logmessages");
	String a_logmessage = "";
	if (logmessages != null)
		a_logmessage = Util.null2String((String)logmessages.get(""+ user.getUID()));
	String s_logmessage = Util.null2String((String)session.getAttribute("logmessage"));
	if (s_logmessage == null)
		s_logmessage = "";
	String relogin0 = Util.null2String(settings0.getRelogin());
	String fromPDA = Util.null2String((String)session.getAttribute("loginPAD"));
	//hubo \u6e05\u9664\u5c0f\u7a97\u53e3\u767b\u5f55\u6807\u8bc6
	if (request.getSession(true).getAttribute("layoutStyle") != null)
		request.getSession(true).setAttribute("layoutStyle", null);
	
	//xiaofeng \u6709\u6548\u7684\u767b\u5165\u8005\u5728\u9000\u51fa\u65f6\u6e05\u9664\u767b\u9646\u6807\u8bb0,\u8e22\u51fa\u7684\u7528\u6237\u76f4\u63a5\u9000\u51fa
	if (!relogin0.equals("1") && !s_logmessage.equals(a_logmessage)) {
		if (fromPDA.equals("1")) {
			response.sendRedirect("/login/LoginPDA.jsp");
		} else {
			response.sendRedirect("/login/Login.jsp");
		}
		return;
	} else {
		logmessages = (Map) application.getAttribute("logmessages");
		if (logmessages != null)
			logmessages.remove("" + user.getUID());
	}
    
	String loginfile = Util.getCookie(request, "loginfileweaver");
    //QC334358 [80]Cas\u96c6\u6210-E9\u5df2\u7ecf\u5b8c\u6210CAS\u96c6\u6210\u529f\u80fd\uff0c\u6574\u5408\u5230E8
    String logintype = Util.null2String(user.getLogintype());
	LicenseCheckLogin.updateOnlinFlag(""+ user.getUID());
    //QC334358 [80]Cas\u96c6\u6210-E9\u5df2\u7ecf\u5b8c\u6210CAS\u96c6\u6210\u529f\u80fd\uff0c\u6574\u5408\u5230E8

	//QC389586 [80]\u89e3\u51b3SSO\u57df\u5355\u70b9\u767b\u5f55\u540e\u9000\u51fa\u518d\u767b\u5f55\u63d0\u793a\u8d26\u53f7\u5bc6\u7801\u9519\u8bef\uff08IE11\u4e0b\uff09\u7684\u95ee\u9898start
	//AD\u57df\u5355\u70b9\u767b\u5f55\u6807\u8bc6
	String LOGIN_SSO_FLAG = Util.null2String((String)request.getSession(true).getAttribute("LOGIN_SSO_FLAG"));
	//\u662f\u5426IE\u6d4f\u89c8\u5668
	String isIE = Util.null2String((String)request.getSession(true).getAttribute("browser_isie"));
	//QC389586 [80]\u89e3\u51b3SSO\u57df\u5355\u70b9\u767b\u5f55\u540e\u9000\u51fa\u518d\u767b\u5f55\u63d0\u793a\u8d26\u53f7\u5bc6\u7801\u9519\u8bef\uff08IE11\u4e0b\uff09\u7684\u95ee\u9898end

    String weaver_login_type = Util.null2String((String)request.getSession(true).getAttribute("weaver_login_type"));
	request.getSession(true).removeValue("moniter");
	request.getSession(true).removeValue("WeaverMailSet");
	request.getSession(true).invalidate();
	try{
		response.addHeader("Set-Cookie","__clusterSessionIDCookieName="+Util.getCookie(request,"__clusterSessionIDCookieName")+";expires=Thu, 01-Dec-1994 16:00:00 GMT;Path=/;HttpOnly");
	}catch(Exception e){}
	weaver.hrm.HrmUserVarify.invalidateCookie(request,response);
	if (fromPDA.equals("1"))
		loginfile = "/login/LoginPDA.jsp";

	//\u8003\u8651\u8fd9\u79cd\u60c5\u51b5\uff1aCookies \u88ab\u6e05\u7a7a  loginfile\u4e3a\u7a7a  \u6b64\u65f6\u5f97\u6307\u5b9a\u4e00\u4e2a\u503c
	if (loginfile == null || loginfile.trim().equals("")) {
		loginfile = "/login/Login.jsp?logintype=1";
	}

	//QC389586 [80]\u89e3\u51b3SSO\u57df\u5355\u70b9\u767b\u5f55\u540e\u9000\u51fa\u518d\u767b\u5f55\u63d0\u793a\u8d26\u53f7\u5bc6\u7801\u9519\u8bef\uff08IE11\u4e0b\uff09\u7684\u95ee\u9898start
	if(LOGIN_SSO_FLAG.equals("true") && isIE.equals("true")){//AD\u57df\u5355\u70b9\u767b\u5f55\u6e05\u9664\u8ba4\u8bc1\u7f13\u5b58

      out.write(_jsp_string2, 0, _jsp_string2.length);
      
	}
	//QC389586 [80]\u89e3\u51b3SSO\u57df\u5355\u70b9\u767b\u5f55\u540e\u9000\u51fa\u518d\u767b\u5f55\u63d0\u793a\u8d26\u53f7\u5bc6\u7801\u9519\u8bef\uff08IE11\u4e0b\uff09\u7684\u95ee\u9898end

//	response.sendRedirect("/Refresh.jsp?loginfile=" + loginfile);
//    QC334358 [80]Cas\u96c6\u6210-E9\u5df2\u7ecf\u5b8c\u6210CAS\u96c6\u6210\u529f\u80fd\uff0c\u6574\u5408\u5230E8 -start
    request.getSession(true).setAttribute("weaver_user@bean",null);
    CasSetting cs = new CasSetting();
    CasUtil cu = new CasUtil();
    String caslogin = cs.getIsuse();
    String isFilterExist = cu.isFilterExist();
    if(weaver_login_type.equals("OALogin")){
        if(!caslogin.equals("1") || !"1".equals(isFilterExist)){
            response.sendRedirect("/Refresh.jsp?loginfile=" + loginfile);
        }else{
            response.sendRedirect("/login/OALogin.jsp?loginfile=" + loginfile);
        }
    }else{
        if(!caslogin.equals("1" ) || !"1".equals(isFilterExist)){
            response.sendRedirect("/Refresh.jsp?loginfile=" + loginfile);
        }else{
            String logoutUrl = cs.getCasserverurl()+cs.getCasserverlogoutpage();
            String service = cs.getEcologyurl();
            service = URLEncoder.encode(service, "UTF-8");

            String loginUrl = cs.getCasserverurl()+cs.getCasserverloginpage();
            loginUrl = loginUrl+"?service="+service;


      out.write(_jsp_string3, 0, _jsp_string3.length);
      out.print((logoutUrl));
      out.write(_jsp_string4, 0, _jsp_string4.length);
      out.print((service));
      out.write(_jsp_string5, 0, _jsp_string5.length);
      out.print((logintype));
      out.write(_jsp_string6, 0, _jsp_string6.length);
      
        }

    }

      out.write(_jsp_string7, 0, _jsp_string7.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("login/Logout.jsp"), 7707812400080452862L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string2;
  private final static char []_jsp_string3;
  private final static char []_jsp_string4;
  private final static char []_jsp_string1;
  private final static char []_jsp_string0;
  private final static char []_jsp_string7;
  private final static char []_jsp_string6;
  private final static char []_jsp_string5;
  static {
    _jsp_string2 = "\r\n	<script language=\"javascript\">\r\n		try {\r\n			document.execCommand(\"ClearAuthenticationCache\");\r\n			window.location.href('/login/Login.jsp?logintype=1'); // page with logout message somewhere in not protected directory\r\n		} catch (exception) {}\r\n	</script>\r\n".toCharArray();
    _jsp_string3 = "\r\n<script language=\"javascript\">\r\n    top.window.location.href=\"".toCharArray();
    _jsp_string4 = "?service=".toCharArray();
    _jsp_string1 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string7 = "\r\n".toCharArray();
    _jsp_string6 = "\";\r\n    \r\n\r\n</script>\r\n".toCharArray();
    _jsp_string5 = "?logintype=".toCharArray();
  }
}
