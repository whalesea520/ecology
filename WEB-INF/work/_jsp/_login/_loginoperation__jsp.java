/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._login;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.general.Util;
import weaver.hrm.*;
import weaver.general.*;
import weaver.systeminfo.*;
import weaver.hrm.settings.RemindSettings;
import weaver.hrm.settings.BirthdayReminder;
import weaver.conn.RecordSet;
import java.net.URLDecoder;
import weaver.login.CheckIpNetWork;
import weaver.login.VerifyLogin;
import weaver.hrm.settings.HrmSettingsComInfo;
import weaver.login.CALoginCheck;
import org.json.JSONObject;
import weaver.login.exception.CaCheckException;
import java.util.regex.Pattern;
import java.util.regex.Matcher;

public class _loginoperation__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      
response.setHeader("cache-control", "no-cache");
response.setHeader("pragma", "no-cache");
response.setHeader("expires", "Mon 1 Jan 1990 00:00:00 GMT");
String method=Util.null2String(request.getParameter("method"));

RemindSettings settings=(RemindSettings)application.getAttribute("hrmsettings");
if(settings==null){
    BirthdayReminder birth_reminder = new BirthdayReminder();
    settings=birth_reminder.getRemindSettings();
    if(settings==null){
        out.println("Cann't create connetion to database,please check your database.");
        return;
    }
    application.setAttribute("hrmsettings",settings);
}

if("add".equals(method)) {
	Thread threadSysUpgrade = null;
	threadSysUpgrade = (Thread)weaver.general.InitServer.getThreadPool().get(0);
	int filePercent = 0;
	int currentFile = 0, fileList = 0;
	if(threadSysUpgrade.isAlive()){
		currentFile = weaver.system.SystemUpgrade.getCurrentFile();
		fileList = weaver.system.SystemUpgrade.getFileList();

		if(currentFile!=0 && fileList!=0){
			double mins = MathUtil.div(currentFile*100,fileList,2);
			out.println(","+mins+",");
		}else{
			out.println(",0,");
		}
	}else{
		out.println(",0,");
	}
}else if("checkTokenKey".equals(method)){
	String loginid=URLDecoder.decode(request.getParameter("loginid"),"utf-8"); 
	RecordSet recordSet = new RecordSet();
	String tableName = "hrmresource";
	//recordSet.executeSql("select id from HrmResourcemanager where loginid='"+loginid+"'");
	recordSet.executeQuery("select id from HrmResourcemanager where loginid=?", loginid) ;
	if(recordSet.next()){
		tableName = "HrmResourcemanager";
	}
	String sysNeedusb=Util.null2String(settings.getNeedusb());
	String needusbHt=Util.null2String(settings.getNeedusbHt());
	String needusbDt=Util.null2String(settings.getNeedusbDt());
	sysNeedusb = (needusbHt.equals("1") || needusbDt.equals("1")) ? "1" : "0";
	String usbType =Util.null2String(settings.getUsbType());
	String userNeedusb="0";
	String userUsbType="";
	String tokenkey="";
	String usbstate = "";
	String id="0";
	if("HrmResourcemanager".equals(tableName)){
		//recordSet.executeSql("select id,userUsbType,tokenkey,usbstate from HrmResourcemanager where loginid='"+loginid+"'");
		recordSet.executeQuery("select id,userUsbType,tokenkey,usbstate from HrmResourcemanager where loginid=?",loginid);
		if(recordSet.next()){
			id=recordSet.getString("id");
		    userUsbType=recordSet.getString("userUsbType");
		    tokenkey=recordSet.getString("tokenkey");
			usbstate = recordSet.getString("usbstate");
		}   
	}else{
		//recordSet.executeSql("select id,needusb,userUsbType,tokenkey,usbstate from hrmresource where loginid='"+loginid+"'");
		recordSet.executeQuery("select id,needusb,userUsbType,tokenkey,usbstate from hrmresource where loginid=?",loginid);
		if(recordSet.next()){
			id=recordSet.getString("id");
		    userNeedusb=recordSet.getString("needusb");
		    userUsbType=recordSet.getString("userUsbType");
		    tokenkey=recordSet.getString("tokenkey");
			usbstate = recordSet.getString("usbstate");
		}   
	}
	
	if(userUsbType.equals(""))
		userUsbType=usbType;    
	
	/**\u68c0\u6d4b\u662f\u5426\u542f\u7528usb\u7f51\u6bb5\u7b56\u7565\u5f00\u59cb**/
	CheckIpNetWork checkipnetwork = new CheckIpNetWork();
	String clientIP = request.getRemoteAddr();
	boolean checktmp = checkipnetwork.checkIpSeg(clientIP);//true\u8868\u793a\u5728\u7f51\u6bb5\u4e4b\u5916,false\u8868\u793a\u5728\u7f51\u6bb5\u4e4b\u5185
	/**\u68c0\u6d4b\u662f\u5426\u542f\u7528usb\u7f51\u6bb5\u7b56\u7565\u7ed3\u675f**/
	if(sysNeedusb.equals("1")&&(userNeedusb.equals("1")||"HrmResourcemanager".equals(tableName)) && (usbstate.equals("0") || (usbstate.equals("2")&&checktmp))){
		VerifyLogin verifylogin = new VerifyLogin();
   		boolean isNeedIp = true;
		HrmSettingsComInfo sci = new HrmSettingsComInfo();
   		int forbidLogin = Util.getIntValue(sci.getForbidLogin(), 0);
   		if(forbidLogin == 0){
   			isNeedIp = false;
   			if(usbstate.equals("2")&&!checktmp) isNeedIp = true;
   		}else{
   			isNeedIp = verifylogin.checkIpSegByForbidLogin(request, loginid);
   		}
		//\u52a8\u6001\u4ee4\u724c \u7f51\u6bb5\u7b56\u7565-->\u7f51\u6bb5\u5185\u4e0d\u9700\u5f39\u51fa
		if(isNeedIp){
			out.print("0");
		}else{
			if(userUsbType.equals("3") ){
				// String sql="select * from tokenJscx WHERE tokenKey='"+tokenkey+"'";
				String sql="select * from tokenJscx WHERE tokenKey= ? ";
				recordSet.executeQuery(sql,tokenkey);
				if(tokenkey.equals("")||!recordSet.next()) //\u4ee4\u724c\u672a\u7ed1\u5b9a\u6216\u8005\u672a\u521d\u59cb\u5316
					out.print("0");  
				else
					out.print(userUsbType);
			}else
			   out.print(userUsbType);
		}
	}else
		out.print("0");
	
}else if("checkIsBind".equals(method)){
	
	String userid=Util.null2String(request.getParameter("userid"));
	String requestFrom=Util.null2String(request.getParameter("requestFrom"));
	String loginid=Util.null2String(request.getParameter("loginid"));
	String tokenKey=Util.null2String(request.getParameter("tokenKey"));
	
	String sysNeedusb=Util.null2String(settings.getNeedusb());
	String needusbHt=Util.null2String(settings.getNeedusbHt());
	String needusbDt=Util.null2String(settings.getNeedusbDt());
	sysNeedusb = (needusbHt.equals("1") || needusbDt.equals("1")) ? "1" : "0";
	String usbType =Util.null2String(settings.getUsbType());
	String userNeedusb="0";
	String userUsbType="";
	String tempUserid="0";
	if(sysNeedusb.equals("1")){
	RecordSet recordSet=new RecordSet();
	if(!requestFrom.equals("system")){ //\u68c0\u67e5\u7528\u6237\u662f\u5426\u542f\u7528usbkey
		//recordSet.execute("select id,loginid,needusb,userUsbType from hrmresource WHERE loginid='"+loginid+"'");
		recordSet.executeQuery("select id,loginid,needusb,userUsbType from hrmresource WHERE loginid=?",loginid);
		if(recordSet.next()){
			userNeedusb=Util.null2String(recordSet.getString("needusb"));
			userUsbType=Util.null2String(recordSet.getString("userUsbType"));
		}
	}else{
		userNeedusb="1";
		userUsbType="3";
	}
	if(userNeedusb.equals("1")&&userUsbType.equals("3")){
	//\u68c0\u67e5\u4ee4\u724c\u662f\u5426\u5df2\u7ecf\u7ed1\u5b9a\u8fc7
	boolean isBind=false; //\u662f\u5426\u7ed1\u5b9a\u8fc7
	String stauts="";     //\u88ab\u7ed1\u5b9a\u4eba\u72b6\u6001
	String tempLoginid="";//\u88ab\u7ed1\u5b9a\u4ebaid
	//String sql="select * from tokenJscx  WHERE tokenKey='"+tokenKey+"'";
	String sql="select * from tokenJscx  WHERE tokenKey=?";
	recordSet.executeQuery(sql,tokenKey);
	if(recordSet.next()){
		isBind=true;
		//\u67e5\u8be2\u5f53\u524d\u4e32\u53f7\u88ab\u7ed1\u5b9a\u7684\u7528\u6237
		//sql="select id,loginid,needusb,status from hrmresource where tokenKey='"+tokenKey+"'";
		sql="select id,loginid,needusb,status from hrmresource where tokenKey=?";
		recordSet.executeQuery(sql,tokenKey);
		if(recordSet.next()){
			tempUserid=recordSet.getString("id");
			stauts=recordSet.getString("status");
			tempLoginid=recordSet.getString("loginid");
		}
	}
	if(requestFrom.equals("system")){
	    //sql="select id,loginid,needusb,status,tokenKey from hrmresource WHERE id="+userid; //\u68c0\u67e5\u5f53\u524d\u7528\u6237\u662f\u5426\u5df2\u7ecf\u7ed1\u5b9a\u8fc7
	    sql="select id,loginid,needusb,status,tokenKey from hrmresource WHERE id=?"; 
	    recordSet.executeQuery(sql,userid);
	}else{
		//sql="select id,loginid,needusb,status,tokenKey from hrmresource WHERE loginid='"+loginid; //\u68c0\u67e5\u5f53\u524d\u7528\u6237\u662f\u5426\u5df2\u7ecf\u7ed1\u5b9a\u8fc7
		sql="select id,loginid,needusb,status,tokenKey from hrmresource WHERE loginid=?";
		 recordSet.executeQuery(sql,loginid);
	}	
	//recordSet.execute(sql);	
	String bindTokenkey=Util.null2String(recordSet.getString("tokenKey"));
	
	if(isBind){
		if((!requestFrom.equals("system")&&loginid.equals(tempLoginid))||(requestFrom.equals("system")&&userid.equals(tempUserid)))
			out.print("0");//\u88ab\u7ed1\u5b9a\u4eba\u548c\u5f53\u524d\u7528\u6237\u662f\u540c\u4e00\u4e2a\u4eba
		else{
			if(stauts.equals("0")||stauts.equals("1")||stauts.equals("2")||stauts.equals("3")){
				out.print("1"); //\u88ab\u7ed1\u5b9a\u7684\u7528\u6237\u5c5e\u4e8e\u6b63\u5e38\u72b6\u6001\u7528\u6237,\u4e0d\u80fd\u518d\u7ed1\u5b9a\u7ed9\u5176\u4ed6\u7528\u6237
			}else{
				if(!bindTokenkey.equals("")){
					out.print("5"); //\u5f53\u524d\u7528\u6237\u5df2\u7ecf\u7ed1\u5b9a\u8fc7\uff0c\u4f46\u9700\u8981\u63d0\u9192\u7528\u6237\u786e\u8ba4\u4ee4\u724c\u4e32\u53f7
				}else
				    out.print("2"); //\u4ee4\u724c\u5df2\u7ecf\u88ab\u6fc0\u6d3b\uff0c\u66f4\u6539\u7528\u6237\u9700\u8981\u9a8c\u8bc1\u4ee4\u724c\u53e3\u4ee4
			}
		}
	}else{
        if(bindTokenkey.equals(tokenKey))
        	out.print("7"); //\u4ee4\u724c\u5df2\u7ecf\u7ed1\u5b9a\u7ed9\u7528\u6237\u4f46\u8fd8\u672a\u521d\u59cb\u5316
        else if(bindTokenkey.equals(""))
        	out.print("3"); //\u5f53\u524d\u4ee4\u724c\u8fd8\u672a\u7ed1\u5b9a\u8fc7
        else
        	out.print("4"); //\u5f53\u524d\u7528\u6237\u5df2\u7ecf\u7ed1\u5b9a\u8fc7\uff0c\u4f46\u9700\u8981\u63d0\u9192\u7528\u6237\u786e\u8ba4\u4ee4\u724c\u4e32\u53f7
	}
	}else
		out.print("6"); //\u7528\u6237\u672a\u542f\u7528usbkey\u9a8c\u8bc1\uff0c\u5219\u4e0d\u9700\u8981\u8fdb\u884c\u7ed1\u5b9a
  }else 
	  out.print("6"); //\u7cfb\u7edf\u672a\u542f\u7528usbkey\u9a8c\u8bc1\uff0c\u5219\u4e0d\u9700\u8981\u8fdb\u884c\u7ed1\u5b9a
}else if("checkIsUsed".equals(method)){ //\u68c0\u67e5\u4ee4\u724c\u662f\u5426\u7ed1\u5b9a\u7ed9\u5176\u4ed6\u7528\u6237
   String tokenKey=Util.null2String(request.getParameter("tokenKey"));
   String userid=Util.null2String(request.getParameter("userid"));
   //String sql="select id,lastname from hrmresource where id <>+"+userid+" and tokenkey='"+tokenKey+"' and status in(0,1,2,3)";
   String sql="select id,lastname from hrmresource where id <> ? and tokenkey= ? and status in(0,1,2,3)";
   RecordSet recordSet=new RecordSet();
   recordSet.executeQuery(sql,userid,tokenKey);
   String result="";
   if(recordSet.next()){  //\u4ee4\u724c\u5df2\u7ecf\u88ab\u4f7f\u7528
	   String lastname=recordSet.getString("lastname");
	   result="{status:\"1\",lastname:\""+lastname+"\"}";
   }else{
	   result="{status:\"0\",lastname:\"\"}";
   }
   out.println(result);
}else if("checkSumPasswordWrong".equals(method)){ //\u5224\u65ad\u9a8c\u8bc1\u7801\u9519\u8bef\u6b21\u6570
	String loginid=URLDecoder.decode(request.getParameter("loginid"),"utf-8");
	String sql="";
	RecordSet rs=new RecordSet();
	boolean isAdmin = false;
	//sql = "select count(*) from hrmresourcemanager where loginid = '"+loginid+"'";
	sql = "select count(*) from hrmresourcemanager where loginid = ? ";
	rs.executeQuery(sql,loginid);
	if(rs.next()){
		if(rs.getInt(1)>0)isAdmin=true;
	}
	if(isAdmin){
		out.println("1");
		return;
	}
  //sql="select sumpasswordwrong from hrmresource where loginid='"+loginid+"'";
  sql="select sumpasswordwrong from hrmresource where loginid= ? ";
  rs.executeQuery(sql,loginid);
  int sumpasswordwrong = 0;
  if(rs.next()){
  	sumpasswordwrong = rs.getInt("sumpasswordwrong");
  	if(sumpasswordwrong<0)sumpasswordwrong=0;
  }
  if(sumpasswordwrong>=settings.getNumvalidatewrong()){
		out.print("1");
  }else{
		out.print("0");
  }
}else if("checkCA".equals(method)){
	boolean isOALogin = false ;
	String loginid=URLDecoder.decode(request.getParameter("loginid"),"utf-8");
	RecordSet rs=new RecordSet();
	String usbType = "" ;
	rs.executeQuery("select userusbtype,usbstate from hrmresourcemanager where loginid=?",loginid);
	if(rs.next()){
		isOALogin = true ;
	}else{
		rs.executeQuery("select userusbtype,usbstate from hrmresource where loginid=?",loginid);
		if(rs.next()) isOALogin = true ;
	}
	if(isOALogin){
		String usbTypetmp = rs.getString("userusbtype") ;
		int usbstate = rs.getInt("usbstate") ;
		CALoginCheck check = new CALoginCheck() ;
		boolean isneed = check.isNeedCheckCa(usbTypetmp,usbstate,request) ;
		if(isneed){
			usbType = usbTypetmp ;
		}
	}
	out.print("{\"usbType\":\""+usbType+"\"}") ;
}else if("getCAUnique".equals(method)){
	String cert=Util.null2String(request.getParameter("cert"));
	String sign=Util.null2String(request.getParameter("sign"));
	JSONObject obj = new JSONObject() ;
	
	CALoginCheck check = new CALoginCheck() ;
	try{
		String unique = check.findCaUnique(cert,sign) ;
		obj.put("code","1") ;
		obj.put("msg",unique) ;
	}catch(CaCheckException e){
		obj.put("code","-1") ;
		obj.put("msg",e.getMsg()) ;
	}
	out.print(obj.toString()) ;
}else if("getHtmlMsg".equals(method)){
	String msg = Util.null2String(request.getParameter("msg"));
	int islanguid = Util.getIntValue(request.getParameter("islanguid"),7);
	Pattern p = Pattern.compile("(\\d+),?") ;
	Matcher m = p.matcher(msg) ;
	StringBuffer sb = new StringBuffer();
	while(m.find()){
		String htmlId = m.group(1) ;
		m.appendReplacement(sb,SystemEnv.getHtmlLabelNames(htmlId,islanguid)) ;
	}
	m.appendTail(sb) ;
	JSONObject obj = new JSONObject() ;
	obj.put("msg",sb.toString()) ;
	out.print(obj.toString()) ;
	return ;
}else if("getCA_CHECK_ERR_MGG".equals(method)){
	String code = Util.null2String(request.getParameter("code")); //errCode
	String errCode = Util.null2String(request.getParameter("errCode")); //errCode
	JSONObject obj = new JSONObject() ;
	
	
	// -2113667017 \u957f\u5ea6\u4e0d\u6b63\u786e
	if("-2113667069|-2113667017".indexOf(errCode) >= 0 && "SEH_GetSelfCertificate".equalsIgnoreCase(code)
			 || "-2113667072".equals(errCode) && "SEH_InitialSession".equalsIgnoreCase(code) ){
	    obj.put("msg","UKEY\u8f93\u5165\u4e0d\u6b63\u786e") ;
	}else{
		obj.put("msg","\u8c03\u7528\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u63d2\u4ef6\u662f\u5426\u5b89\u88c5\uff0cUSB\u8bbe\u5907\u6b63\u786e\u63d2\u5165\uff1b") ;	
	}
	
	
/**	
	if("SEH_GetSelfCertificate".equalsIgnoreCase(code)){
		obj.put("msg","\u83b7\u53d6\u5ba2\u6237\u7aef\u8bc1\u4e66\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u63d2\u4ef6\u662f\u5426\u5b89\u88c5\uff0cUSB\u8bbe\u5907\u6b63\u786e\u63d2\u5165\uff01") ;
	}else if("SEH_InitialSession".equalsIgnoreCase(code)){
		obj.put("msg","\u7f3a\u5c11\u63d2\u4ef6\uff0c\u8bf7\u68c0\u67e5\u63d2\u4ef6\u662f\u5426\u5b89\u88c5\uff0cUSB\u8bbe\u5907\u6b63\u786e\u63d2\u5165\uff01") ;
	}else if("UCCGetPluggedeKey".equalsIgnoreCase(code)){
		obj.put("msg","\u83b7\u53d6\u8bbe\u5907\u7c7b\u578b\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u63d2\u4ef6\u662f\u5426\u5b89\u88c5\uff0cUSB\u8bbe\u5907\u6b63\u786e\u63d2\u5165\uff01") ;
	}
**/
	out.print(obj.toString()) ;
	return ;
}

      out.write(_jsp_string1, 0, _jsp_string1.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("login/LoginOperation.jsp"), -6520056778516599721L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string0;
  private final static char []_jsp_string1;
  static {
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
  }
}
