/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._login;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import weaver.general.Util;
import weaver.general.GCONST;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import weaver.hrm.settings.RemindSettings;
import weaver.hrm.User;
import weaver.hrm.HrmUserVarify;
import weaver.hrm.OnLineMonitor;
import weaver.systeminfo.template.UserTemplate;

public class _verifyrtxlogin__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;
  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.login.VerifyRtxLogin verifylogin;
      verifylogin = (weaver.login.VerifyRtxLogin) pageContext.getAttribute("verifylogin");
      if (verifylogin == null) {
        verifylogin = new weaver.login.VerifyRtxLogin();
        pageContext.setAttribute("verifylogin", verifylogin);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet rsExtend;
      rsExtend = (weaver.conn.RecordSet) pageContext.getAttribute("rsExtend");
      if (rsExtend == null) {
        rsExtend = new weaver.conn.RecordSet();
        pageContext.setAttribute("rsExtend", rsExtend);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.docs.docs.DocCheckInOutUtil DocCheckInOutUtil;
      DocCheckInOutUtil = (weaver.docs.docs.DocCheckInOutUtil) pageContext.getAttribute("DocCheckInOutUtil");
      if (DocCheckInOutUtil == null) {
        DocCheckInOutUtil = new weaver.docs.docs.DocCheckInOutUtil();
        pageContext.setAttribute("DocCheckInOutUtil", DocCheckInOutUtil);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.workflow.msg.PoppupRemindInfoUtil PoppupRemindInfoUtil;
      PoppupRemindInfoUtil = (weaver.workflow.msg.PoppupRemindInfoUtil) pageContext.getAttribute("PoppupRemindInfoUtil");
      if (PoppupRemindInfoUtil == null) {
        PoppupRemindInfoUtil = new weaver.workflow.msg.PoppupRemindInfoUtil();
        pageContext.setAttribute("PoppupRemindInfoUtil", PoppupRemindInfoUtil);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      weaver.rtx.RtxLdapLog RtxLdaplog;
      RtxLdaplog = (weaver.rtx.RtxLdapLog) pageContext.getAttribute("RtxLdaplog");
      if (RtxLdaplog == null) {
        RtxLdaplog = new weaver.rtx.RtxLdapLog();
        pageContext.setAttribute("RtxLdaplog", RtxLdaplog);
      }
      out.write(_jsp_string3, 0, _jsp_string3.length);
      
String urlfrom = Util.null2String(request.getParameter("urlfrom")) ;
String para = Util.null2String(request.getParameter("para")) ;
String linkurltmp = para;
if(urlfrom.equals("expfile")){ //\u6863\u6848\u7cfb\u7edf\u5f52\u6863\u5bfc\u51fa
	verifylogin.setIsfromwftodoc(1);
	String para1= Util.null2String(request.getParameter("para1"));
	para1 = para1.replaceAll("@","&");
	//System.out.println("para1==="+para1);
	para = para1 + "#" + Util.null2String(request.getParameter("para2")) + "#" + Util.null2String(request.getParameter("para3"));
	String requestid = "-1";
	int index = para1.indexOf("requestid=");
	if(index>0) requestid = para1.substring(index+10);
	session.setAttribute("urlfrom_workflowtodoc_"+requestid,"true");
	para = para.replace("ViewRequest.jsp","ExportRequest.jsp");
} else if(urlfrom.equals("workflowtodoc")){//\u9488\u5bf9\u6d41\u7a0b\u5b58\u4e3a\u6587\u6863
	verifylogin.setIsfromwftodoc(1);
	para = Util.null2String(request.getParameter("para1")) + "#" + PoppupRemindInfoUtil.decrypt(Util.null2String(request.getParameter("para2"))) + "#" + Util.null2String(request.getParameter("para3"));
	String para1 = Util.null2String(request.getParameter("para1"));
	String requestid = "-1";
	int index = para1.indexOf("requestid=");
	if(index>0) requestid = para1.substring(index+10);
	session.setAttribute("urlfrom_workflowtodoc_"+requestid,"true");
}else{
	para = PoppupRemindInfoUtil.decrypt(para);
}

String str[] = Util.TokenizerString2(para,"#");

String loginfile = Util.null2String(request.getParameter("loginfile")) ;
String logintype = Util.null2String(request.getParameter("logintype")) ;
String loginid = Util.null2String(str[1]);
String userpassword = "";
if(str.length==3){
	userpassword = Util.null2String(str[2]);
}
if(logintype.equals("")) logintype = "1";

//\u89e3\u51b3rtx\u6d88\u606f\u63d0\u9192\u662fldap\u767b\u5f55\u9a8c\u8bc1(ldap\u662f\u6ca1\u6709loginid\u548cpassword)td13185
if(!"1".equals(session.getAttribute("istest"))){//\u6d41\u7a0b\u6d4b\u8bd5\u4e0d\u9a8c\u8bc1rtx
boolean rtxladptmp = RtxLdaplog.checkRtxLadp(loginid,linkurltmp);
if(rtxladptmp && !urlfrom.equals("workflowtodoc")) {
	response.sendRedirect("/login/Login.jsp?logintype=1&message=19");
	return;
}
}

String serial=Util.null2String(request.getParameter("serial"));
String username = Util.null2String(request.getParameter("username"));
String rnd=Util.null2String(request.getParameter("rnd"));
String loginPDA=Util.null2String(request.getParameter("loginPDA"));
session.setAttribute("loginPAD",loginPDA);
String RedirectFile = Util.null2String(str[0]);
if(RedirectFile.indexOf("/main.jsp")>-1&&"1".equals(session.getAttribute("istest"))){
    session.removeAttribute("istest");
}
if (loginPDA.equals("1"))
{
RedirectFile= "/mainPDA.jsp";
}

String validatecode=Util.null2String(request.getParameter("validatecode"));


String gopage=Util.null2String(request.getParameter("gopage"));
if(gopage.length()>0){
    RedirectFile = "/main.jsp?gopage="+gopage ;
}
if (loginfile.equals("")) loginfile="/login/Login.jsp?logintype="+logintype+"&gopage="+gopage;

Cookie[] ck = request.getCookies();
int ckLength = 0 ;
try {
	ckLength = ck.length;
} catch (NullPointerException ex) {//\u6d41\u7a0b\u5b58\u4e3a\u6587\u6863\uff0c\u8bfb\u4e0d\u5230cookie
	//response.sendRedirect("/login/Login.jsp?logintype="+logintype+"&noAllowIe=yes") ;
	//return ;
}

String isIE = Util.null2String(request.getParameter("isie"));
if(isIE.equals("false")){
	isIE = "true";
}
session.setAttribute("browser_isie",isIE);


if (logintype.equals("2")) RedirectFile = "/portal/main.jsp" ;

if((loginid.equals("")) && !"1".equals(session.getAttribute("istest"))) response.sendRedirect(loginfile + "&message=18") ;//QC271940\u89e3\u51b3AD\u57df\u7528\u6237\u4f7f\u7528\u6d41\u7a0b\u5b58\u4e3a\u6587\u6863\u529f\u80fd
else  { RemindSettings settings=(RemindSettings)application.getAttribute("hrmsettings");
    String needusb=settings.getNeedusb();
	String usercheck ;
	if(needusb!=null&&needusb.equals("1")&& false){//\u5c4f\u853dusbkey
			usercheck= verifylogin.getUserCheck(request,response,loginid,userpassword,serial,username,rnd,logintype,loginfile,validatecode);
	}else{
		usercheck= verifylogin.getUserCheck(request,response,loginid,userpassword,logintype,loginfile,validatecode);
	}

	try {
	   request.getSession(true).removeAttribute("validateRand");
	}catch (Exception e) {

  }		
	if(usercheck.equals("15") || usercheck.equals("16") || usercheck.equals("17")|| usercheck.equals("45")|| usercheck.equals("46")|| usercheck.equals("47")|| usercheck.equals("52")|| usercheck.equals("55"))
    {
        String tmploginid=(String)session.getAttribute("tmploginid");
        if(tmploginid!=null&&loginid.equals(tmploginid))
           session.setAttribute("tmploginid1",loginid);
        else
           session.removeAttribute("tmploginid");
        response.sendRedirect(loginfile + "&message="+usercheck) ;
	}
	else if(usercheck.equals("19")){
		response.sendRedirect("/system/InLicense.jsp") ;
	} else if (usercheck.equals("26")) {
		response.sendRedirect("/login/Login.jsp?logintype=1&message="+usercheck);
	}else if(usercheck.equals("101")){
        session.setAttribute("tmploginid",loginid);
        session.setAttribute("tmploginid1",loginid);
        if (!loginPDA.equals("1")) {
        response.sendRedirect("/login/Login.jsp?logintype=1&message="+usercheck) ;
		}
		else
		{
		response.sendRedirect("/login/LoginPDA.jsp?logintype=1&message="+usercheck) ;
		}
    }
	else {
            User user = HrmUserVarify.getUser (request , response) ;

            if(user == null) { response.sendRedirect(loginfile ) ; return;}
            session.setAttribute("password",userpassword);
	        session.setAttribute("fromlogin","yes");
            session.removeAttribute("tmploginid");
            session.setAttribute("RtxFromLogin","true");
			boolean MOREACCOUNTLANDING = GCONST.getMOREACCOUNTLANDING();
			if(MOREACCOUNTLANDING){
                //\u591a\u5e10\u53f7\u767b\u9646
                if (user.getUID() != 1) {  //is not sysadmin
					weaver.login.VerifyLogin VerifyLogin = new weaver.login.VerifyLogin();
                    List accounts = VerifyLogin.getAccountsById(user.getUID());
                    request.getSession(true).setAttribute("accounts", accounts);
				}
				Util.setCookie(response, "loginfileweaver", loginfile, 172800);
				Util.setCookie(response, "loginidweaver", loginid, 172800);
             }
            DocCheckInOutUtil.docCheckInWhenVerifyLogin(user,request);

		if(request.getSession(true).getAttribute("layoutStyle")!=null && request.getSession(true).getAttribute("layoutStyle").equals("1")){
			session.setAttribute("istimeout","no");

      out.write(_jsp_string4, 0, _jsp_string4.length);
      
		}else{
			if("2".equals(logintype)){
				response.sendRedirect(RedirectFile) ;
				return;
			} else {
				UserTemplate  ut=new UserTemplate();
				
				ut.getTemplateByUID(user.getUID(),user.getUserSubCompany1());
				int templateId=ut.getTemplateId();
				int extendTempletid=ut.getExtendtempletid();
				int extendtempletvalueid=ut.getExtendtempletvalueid();

				if(extendTempletid!=0){
					rsExtend.executeSql("select id,extendname,extendurl from extendHomepage  where id="+extendTempletid);
					if(rsExtend.next()){
						int id=Util.getIntValue(rsExtend.getString("id"));
						String extendurl=Util.null2String(rsExtend.getString("extendurl"));	
						if(para.length()>0){
							response.sendRedirect(RedirectFile);
						}else{
							response.sendRedirect(extendurl+"/index.jsp") ;
						}
						return;				  
					}
				} else {
					response.sendRedirect(RedirectFile) ;
					return;
				}
			}
		}
	}
}

    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("login/VerifyRtxLogin.jsp"), 4741168659117169884L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string4;
  private final static char []_jsp_string3;
  private final static char []_jsp_string0;
  private final static char []_jsp_string2;
  private final static char []_jsp_string1;
  static {
    _jsp_string4 = "\r\n			<SCRIPT LANGUAGE=VBS>\r\n				window.parent.returnvalue = \"1\"\r\n				window.parent.close\r\n			</script>\r\n".toCharArray();
    _jsp_string3 = "\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string2 = "\r\n".toCharArray();
    _jsp_string1 = " \r\n".toCharArray();
  }
}
