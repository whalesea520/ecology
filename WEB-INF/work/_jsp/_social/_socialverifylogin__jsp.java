/*
 * JSP generated by Resin-3.1.8 (built Mon, 17 Nov 2008 12:15:21 PST)
 */

package _jsp._social;
import javax.servlet.*;
import javax.servlet.jsp.*;
import javax.servlet.http.*;
import net.sf.json.*;
import weaver.mobile.plugin.ecology.service.HrmResourceService;
import weaver.file.*;
import weaver.general.*;
import weaver.hrm.*;
import weaver.hrm.settings.*;
import weaver.systeminfo.SystemEnv;
import weaver.social.service.SocialIMService;
import weaver.social.im.SocialImLogin;
import weaver.social.SocialUtil;
import weaver.conn.RecordSet;
import java.util.*;
import weaver.login.VerifyPasswdCheck;
import weaver.login.VerifyLogin;
import weaver.login.CheckIpNetWork;
import weaver.conn.ConnStatement;
import weaver.general.BaseBean;

public class _socialverifylogin__jsp extends com.caucho.jsp.JavaPage
{
  private static final java.util.HashMap<String,java.lang.reflect.Method> _jsp_functionMap = new java.util.HashMap<String,java.lang.reflect.Method>();
  private boolean _caucho_isDead;

  
      // \u68c0\u6d4b\u7cfb\u7edf\u662f\u5426\u652f\u6301language\u7c7b\u578b\u8bed\u8a00
      public boolean judgeLanguage(int language) {
          RecordSet rs = new RecordSet();
          rs.executeQuery("select language, activable from syslanguage where activable = 1 and id = " + language);
          return rs.next();
      }

  
  public void
  _jspService(javax.servlet.http.HttpServletRequest request,
              javax.servlet.http.HttpServletResponse response)
    throws java.io.IOException, javax.servlet.ServletException
  {
    javax.servlet.http.HttpSession session = request.getSession(true);
    com.caucho.server.webapp.WebApp _jsp_application = _caucho_getApplication();
    javax.servlet.ServletContext application = _jsp_application;
    com.caucho.jsp.PageContextImpl pageContext = _jsp_application.getJspApplicationContext().allocatePageContext(this, _jsp_application, request, response, null, session, 8192, true, false);
    javax.servlet.jsp.PageContext _jsp_parentContext = pageContext;
    javax.servlet.jsp.JspWriter out = pageContext.getOut();
    final javax.el.ELContext _jsp_env = pageContext.getELContext();
    javax.servlet.ServletConfig config = getServletConfig();
    javax.servlet.Servlet page = this;
    response.setContentType("text/html; charset=UTF-8");
    request.setCharacterEncoding("UTF-8");
    try {
      out.write(_jsp_string0, 0, _jsp_string0.length);
      weaver.hrm.resource.ResourceComInfo ResourceComInfo;
      ResourceComInfo = (weaver.hrm.resource.ResourceComInfo) pageContext.getAttribute("ResourceComInfo");
      if (ResourceComInfo == null) {
        ResourceComInfo = new weaver.hrm.resource.ResourceComInfo();
        pageContext.setAttribute("ResourceComInfo", ResourceComInfo);
      }
      out.write(_jsp_string1, 0, _jsp_string1.length);
      weaver.conn.RecordSet rs;
      rs = (weaver.conn.RecordSet) pageContext.getAttribute("rs");
      if (rs == null) {
        rs = new weaver.conn.RecordSet();
        pageContext.setAttribute("rs", rs);
      }
      out.write(_jsp_string2, 0, _jsp_string2.length);
      
	request.setCharacterEncoding("UTF-8");
	response.setContentType("application/json;charset=UTF-8");

    String method = Util.null2String(request.getParameter("method"));
    if(method.isEmpty()) {
        method = "login";  // \u9ed8\u8ba4\u662f\u91c7\u7528\u767b\u5f55\u65b9\u6cd5
    }
    BaseBean log = new BaseBean();
    
    
    // \u7528\u6237\u767b\u5f55
    if("login".equals(method)) {
    	FileUpload fu = new FileUpload(request); 
    	
    	String loginId = Util.null2String(fu.getParameter("loginid"));
    	String password = Util.null2String(fu.getParameter("password"));
        
    	String dynapass = Util.null2String(fu.getParameter("dynapass"));
    	String tokenpass = Util.null2String(fu.getParameter("tokenpass"));
    	int language = Util.getIntValue(fu.getParameter("language"), 7);
    	String ipaddress = Util.null2String(fu.getParameter("ipaddress"));
    	int policy = Util.getIntValue(Util.null2String(fu.getParameter("policy")), 0);
    	String auth = Util.null2String(fu.getParameter("auth"));
    	JSONObject result = new JSONObject();
        Map<String, String> map = SocialImLogin.getBuildVersion();
        result.put("buildversion", map.get("buildversion"));
        result.put("osxBuildVersion", map.get("osxBuildVersion"));
        result.put("xpbuildVersion", map.get("xpbuildVersion"));
        result.put("runtimeVersion", map.get("runtimeVersion"));
        
    	if(loginId == null || "".equals(loginId) || password == null || "".equals(password)){
    		result.put("error", "no loginid or password!");
    	}
        if(!judgeLanguage(language)&& language != 7) {
            result.put("status", 999);
    		result.put("errorMsg", "\u7cfb\u7edf\u4e0d\u652f\u6301\u8be5\u8bed\u8a00\uff0c\u8bf7\u9009\u62e9\u5176\u4ed6\u8bed\u8a00");
        }
    	else{
    	    HrmResourceService hrs = new HrmResourceService();
    		String userid = "" + hrs.getUserId(loginId);

    	    boolean forbitLogin = SocialImLogin.checkForbitLogin(userid);
    	    boolean isAllowNewWin = SocialImLogin.checkAllowWindowDepart(userid);
    	    int isAllowNewWinNum = (isAllowNewWin==true?1:0);
    	    
    		if(!forbitLogin){
    			result.put("status", -1);  //\u7981\u6b62\u767b\u5f55
    			result.put("errorMsg","\u5f53\u524d\u8d26\u53f7\u5df2\u88ab\u7981\u6b62\u767b\u5f55e-message");
    		}else{
   			HrmSettingsComInfo sci = new HrmSettingsComInfo();
   			String needdynapass_sys = sci.getNeeddynapass();
   			String needtokenpass_sys = sci.getNeedusbDt();
   			String validitySec = sci.getValiditySec();
   			String openPasswordLock = Util.null2String(sci.getOpenPasswordLock());
            // \u68c0\u67e5\u767b\u5f55\u7c7b\u578b
    		rs.executeQuery("select userUsbType, usbstate, status, needdynapass, needusb from hrmresource where loginid =?",loginId );
            if(rs.next()){
                String userUsbType = Util.null2String(rs.getString("userUsbType"));
                String usbstate = Util.null2String(rs.getString("usbstate"));
                String status = Util.null2String(rs.getString("status"));
                String needdynapass_user = Util.null2String(rs.getString("needdynapass"));
                String needtokenpass_user = Util.null2String(rs.getString("needusb"));
                // \u5c4f\u853d\u79bb\u804c\u4eba\u5458
                if(status.equals("4") || status.equals("5") || status.equals("6") || status.equals("7")) {
                	result.put("status", -1);  //\u7981\u6b62\u767b\u5f55
        			result.put("errorMsg","\u8d26\u53f7\u5df2\u88ab\u7981\u6b62\u767b\u5f55");
	        		out.println(result);
	        		return;
                }
                // log.writeLog("socialVerfylogin----userUsbType---"+userUsbType);
                // log.writeLog("socialVerfylogin----usbstate---"+usbstate);
                if(!userUsbType.isEmpty() && (usbstate.equals("0") || usbstate.equals("2"))) {
                	// userUsbType 2 \u6d77\u6cf0key 3 \u52a8\u6001\u4ee4\u724c 4 \u52a8\u6001\u5bc6\u7801 \u5176\u4ed6\u8868\u793a\u672a\u5f00\u542f\u8f85\u52a9\u6821\u9a8c
                	// \u624b\u673a\u63a5\u53e3policy 0 \u4e0d\u542f\u7528 1 \u9a8c\u8bc1\u7801 2 \u52a8\u6001\u5bc6\u7801 3 \u52a8\u6001\u4ee4\u724c
                    if(userUsbType.equals("4")) {
                    	policy = 2;
                    }
                    if(userUsbType.equals("3")) {
                    	policy = 3;
                    }
                    
                }
                
             	// \u5224\u65ad\u52a8\u6001\u5bc6\u7801\u662f\u5426\u5f00\u542f
                if(policy == 2) {
                	// \u603b\u5f00\u5173\u672a\u5f00\u542f
                	// log.writeLog("socialVerfylogin----needdynapass_sys---"+needdynapass_sys);
                	if(needdynapass_sys != null && needdynapass_sys.equals("0")) {
                		policy = 0;
                	}
                	// \u4e2a\u4eba\u5f00\u5173\u672a\u5f00\u542f
                	// log.writeLog("socialVerfylogin----needdynapass_user---"+needdynapass_user);
                	if(!needdynapass_user.equals("1")) {
                		policy = 0;
                	}
                }
                
                // \u5224\u65ad\u52a8\u6001\u4ee4\u724c\u662f\u5426\u5f00\u542f, \u603b\u5f00\u5173\u53ef\u4ee5\u540c\u65f6\u5f00\u542f\u4e24\u79cd\u6821\u9a8c\uff0c\u4f46\u4e2a\u4eba\u53ea\u80fd\u8bbe\u7f6e\u4e00\u79cd
                if(policy == 3) {
                	// \u603b\u5f00\u5173\u672a\u5f00\u542f
                	// log.writeLog("socialVerfylogin----needtokenpass_sys---"+needtokenpass_sys);
                	if(needtokenpass_sys != null && needtokenpass_sys.equals("0")) {
                		policy = 0;
                	}
                	// \u4e2a\u4eba\u5f00\u5173\u672a\u5f00\u542f
                	// log.writeLog("socialVerfylogin----needtokenpass_user---"+needtokenpass_user);
                	if(!needtokenpass_user.equals("1")) {
                		policy = 0;
                	}
                }
                
                // \u5224\u65ad\u7f51\u6bb5\u7b56\u7565\u7684\u60c5\u51b5\uff1a usbstate: 0 \u542f\u7528 1 \u7981\u7528 2 \u7f51\u6bb5\u7b56\u7565 
                // \u53ea\u9700\u8003\u8651\u52a8\u6001\u5bc6\u7801\u548c\u52a8\u6001\u4ee4\u724c\u7684\u60c5\u51b5
                if(usbstate.equals("2") && (policy == 2 || policy == 3)) {
                	String clientIP = Util.getIpAddr(request);
                	// log.writeLog("socialVerfylogin----clientIP---"+clientIP);
                	CheckIpNetWork checkipnetwork = new CheckIpNetWork();
                	boolean checkOutter = checkipnetwork.checkIpSeg(clientIP);
                	// \u7f51\u6bb5\u5185\u8df3\u8fc7\u8f85\u52a9\u6821\u9a8c
                	// log.writeLog("socialVerfylogin----checkOutter---"+checkOutter);
                	if(!checkOutter) {
                		policy = 0;
                	}
                }
    		}
			// \u68c0\u67e5\u5bc6\u7801\u9501\u5b9a
    		boolean isWhite = false;
			rs.executeQuery("select passwordlock from hrmresource where passwordlock>0 and loginid=?",loginId);
			//\u5148\u5224\u5b9a\u8be5\u7528\u6237\u5bc6\u7801\u662f\u5426\u5df2\u88ab\u9501\u5b9a
			if(rs.next()){
				//\u83b7\u53d6\u767d\u540d\u5355\u53c2\u6570\uff0c\u662f\u5426\u5f00\u542f\u767d\u540d\u5355
				String isopen = Prop.getPropValue("EMobileWhiteList", "WhiteListOpen");
				if(isopen != null && "true".equals(isopen)){
					String iplist = Prop.getPropValue("EMobileWhiteList", "ips");
					if(iplist != null && iplist.length() > 0){
						String[] ips = iplist.split(",");
						for(int i=0;i<ips.length;i++){
							if(ipaddress.equals(ips[i])){
								isWhite=true;
								break;
							}
						}
					}
				}
				
				if(!isWhite && openPasswordLock.equals("1")){
					result.put("status", 2);
	        		result.put("errorMsg", SystemEnv.getHtmlLabelName(24594,7));
	        		out.println(result);
	        		return;
				}
			}
    		// \u68c0\u67e5\u5bc6\u7801\u9501\u5b9a-end
    		// log.writeLog("socialVerfylogin----loginId---"+loginId);
    		// log.writeLog("socialVerfylogin----password---"+password);
    		// log.writeLog("socialVerfylogin----dynapass---"+dynapass);
    		// log.writeLog("socialVerfylogin----tokenpass---"+tokenpass);
    		// log.writeLog("socialVerfylogin----policy---"+policy);
            int status = hrs.checkLogin(loginId, password, dynapass, tokenpass, policy);
			BirthdayReminder birth_reminder = new BirthdayReminder();
    		RemindSettings settings=birth_reminder.getRemindSettings();
            String userHead = "";
            String userName = "";
    		if(status == 1){
				if(settings==null){
    			    	result.put("status", status);
    	        		result.put("errorMsg", SocialIMService.getErrorMsg(status, 7));
    			}
				String OpenPasswordLock = settings.getOpenPasswordLock();
    			if("1".equals(OpenPasswordLock)){
					RecordSet rsPwd = new RecordSet();				
					String updatepwdSql = "update HrmResource set sumpasswordwrong=? where loginid=?";
					rsPwd.executeUpdate(updatepwdSql,0,loginId);
				}
                // \u6821\u9a8clicense\u662f\u5426\u6b63\u786e
                int checkLicense = SocialImLogin.checkLience();
                User user = hrs.getUserById(hrs.getUserId(loginId));
                // \u6388\u6743\u4fe1\u606f\u4e0d\u6b63\u786e \u6216\u8005 \u4e0d\u662fpc\u5176\u4ed6\u5730\u70b9\u767b\u5f55\uff0c\u4e0d\u5141\u8bb8\u767b\u5f55
                if(checkLicense == 1 || (checkLicense == 6 && SocialImLogin.checkOnlineStatus(user.getUID(), SocialImLogin.CLIENT_TYPE_PC) == 1)) {
        			user.setLanguage(language);
        			session.setAttribute("weaver_user@bean",user);
                       //\u6dfb\u52a0\u5bc6\u7801\u5230\u7f13\u5b58\u4e2d
					try {
						HashMap<Integer, String> socialUserpwdCache = new HashMap<Integer, String>();
						Object pwdObject = StaticObj.getInstance().getObject("socialUserpwdCache");
						if (pwdObject != null) {
							socialUserpwdCache = (HashMap<Integer, String>) pwdObject;
						}
						socialUserpwdCache.put(user.getUID(), password);
						StaticObj.getInstance().putObject("socialUserpwdCache", socialUserpwdCache);
					} catch (Exception e) {
						log.writeLog("socialUserpwdCache \u6dfb\u52a0\u5931\u8d25" + e.getMessage());
					}
        			//\u5c06\u7528\u6237id\u4fdd\u5b58\u5230cookie
        			//Util.setCookie(response, "loginidweaver", userid);
        			//userHead=ResourceComInfo.getMessagerUrls(userid);
                    userHead = SocialUtil.getUserHeadImage(user.getUID()+"");
                    userName = ResourceComInfo.getLastname(user.getUID()+"");
                    
                    String sessionKey = session.getId();
                    SocialImLogin.recordSocialIMSessionkey(user.getUID(), sessionKey, SocialImLogin.CLIENT_TYPE_PC);
                    SocialImLogin.updateLoginTime(user.getUID(), SocialImLogin.CLIENT_TYPE_PC);
                    SocialImLogin.setSysLogInfo(request, response);
                    //\u68c0\u67e5\u7528\u6237\u662f\u5426\u9700\u8981\u4fee\u6539OA\u5bc6\u7801
                    //if(SocialImLogin.checkIsNeedResetPassword(Integer.parseInt(userid))) {
                    //    result.put("status", -2);  //\u9700\u8981\u7528\u6237\u4fee\u6539\u5bc6\u7801\u540e\u624d\u80fd\u767b\u9646
                	//	result.put("errorMsg", "\u8bf7\u60a8\u63d0\u9ad8\u5bc6\u7801\u5f3a\u5ea6\uff0c\u5bc6\u7801\u4e0d\u5c11\u4e8e8\u4f4d\uff08\u5e76\u9700\u542b\u5b57\u6bcd\uff0c\u6570\u5b57\u53ca\u7279\u6b8a\u5b57\u7b26\uff09\uff01");
                    //    result.put("url", "/hrm/HrmTab.jsp?_fromURL=HrmResourcePassword");
                    //    result.put("sessionkey", sessionKey);
                    //} else {
                        result.put("userName",userName);
                		result.put("userHead",userHead);
                		result.put("status", status);
                		result.put("errorMsg", SocialIMService.getErrorMsg(status, 7));
                		result.put("sessionkey", sessionKey);
                		result.put("isAllowNewWin", isAllowNewWinNum);
                    //}
                } else {
                    result.put("status", -1);  //license\u9519\u8bef
            		result.put("errorMsg",SocialImLogin.getCheckLienceMsg(checkLicense, 7));
                }
    		} else {
    			// \u2018\u767b\u5f55\u5bc6\u7801\u4e0d\u6b63\u786e\u2019, \u2018\u7528\u6237\u540d\u6216\u5bc6\u7801\u9519\u8bef\u2019, \u2018\u7528\u6237\u4e0d\u5b58\u5728\u2019\u7684\u63d0\u793a\u7edf\u4e00\u6210\u2018\u7528\u6237\u540d\u6216\u5bc6\u7801\u9519\u8bef\u2019, status\u7edf\u4e00\u62102
    			// log.writeLog("socialVerfylogin----status---"+status);
    			if(status == 3 || status == 4) {
    			//\u7528\u6237\u540d\u4e0d\u5b58\u5728
    				// log.writeLog("socialVerfylogin----status---"+status);
    				result.put("status", status);
	        		result.put("errorMsg", SocialIMService.getErrorMsg(status, 7));
	        		out.println(result);
	        		return;
    			}
    			
    			// \u68c0\u67e5\u5bc6\u7801\u9501\u5b9a
            	String errorMsg = "";
    			if(status==2 && !isWhite){
    				RecordSet rs2 = new RecordSet();
    				RecordSet rs1 = new RecordSet();
    				  				
    			    if(settings==null){
    			    	result.put("status", status);
    	        		result.put("errorMsg", SocialIMService.getErrorMsg(status, 7));
    			    }
    			    String OpenPasswordLock = settings.getOpenPasswordLock();
    			    if("1".equals(OpenPasswordLock)){
    				    rs2.executeQuery("select id from HrmResourceManager where loginid=?",loginId);
    				    if(!rs2.next()){
							// log.writeLog("socialVerfylogin----sumpasswordwrong---check--start--");
    						String sql = "select sumpasswordwrong from hrmresource where loginid=?";
							// log.writeLog("socialVerfylogin----sumpasswordwrong---sql="+sql);
    						rs1.executeQuery(sql,loginId);
							int sumpasswordwrong = 0;
							if(rs1.next()) sumpasswordwrong = Util.getIntValue(rs1.getString(1));   						
							// log.writeLog("socialVerfylogin----sumpasswordwrong---sumpasswordwrong="+sumpasswordwrong);
    						int sumPasswordLock = Util.getIntValue(settings.getSumPasswordLock(),3);
							// log.writeLog("socialVerfylogin----sumpasswordwrong---sumPasswordLock="+sumPasswordLock);
    						int leftChance = sumPasswordLock-sumpasswordwrong;
							// log.writeLog("socialVerfylogin----sumpasswordwrong---leftChance="+leftChance);
    						ConnStatement statement = new ConnStatement();
    						if(leftChance==1){
    							String updateSql = "update HrmResource set passwordlock=1,sumpasswordwrong=0 where loginid=?";
								// log.writeLog("socialVerfylogin----sumpasswordwrong---updateSql="+updateSql);
    							try{
									statement.setStatementSql(updateSql);
									statement.setString(1,loginId);
									statement.executeUpdate();
								}catch(Exception e) {
									// log.writeLog("socialVerfylogin----sumpasswordwrong--\u66f4\u65b0\u5931\u8d25--");
    	    				  	}finally {
									try { 
									if(statement!=null) statement.close();
									// log.writeLog("socialVerfylogin----statement.close--");
									}catch(Exception ex) {}
								}
    							status = 19;
    						}else{
    							String updateSql = "update HrmResource set sumpasswordwrong=? where loginid=?";
								// log.writeLog("socialVerfylogin----sumpasswordwrong---updateSql="+updateSql);
    							try{
									statement.setStatementSql(updateSql);
									int setPasswd =sumpasswordwrong +1 ;
									statement.setInt(1,setPasswd);
									statement.setString(2,loginId);
									statement.executeUpdate();
								}catch(Exception e) {
									// log.writeLog("socialVerfylogin----sumpasswordwrong--\u66f4\u65b0\u5931\u8d25--");
    	    				  	}finally {
									try { 
										if(statement!=null) statement.close(); 
										// log.writeLog("socialVerfylogin----statement.close--");
									}catch(Exception ex) {}
								}
    							errorMsg = SystemEnv.getHtmlLabelName(24466,language) + (leftChance-1) + SystemEnv.getHtmlLabelName(24467,language);
    						}
    						
    					}
    			    }    
    			} 
    			// \u68c0\u67e5\u5bc6\u7801\u9501\u5b9a--end
    		    result.put("status", status);
        		result.put("errorMsg", errorMsg.isEmpty()?SocialIMService.getErrorMsg(status, 7):errorMsg);
        		if(status == 0){
        			result.put("validitySec", validitySec);
        		}
            }
        }
    }

        String callback = Util.null2String(request.getParameter("callback"));
        if(callback.isEmpty()) {
        	out.println(result);
        } else {
            out.println(callback + "(" + result.toString() + ")");
        }
    }
    
    // \u626b\u7801\u767b\u9646\u540e\uff0c\u83b7\u5f97\u7248\u672c\u548csessionkey
    else if("afterQRLogin".equals(method)) {
        JSONObject result = new JSONObject();
        User user = HrmUserVarify.checkUser(request, response);
        
        boolean forbitLogin = SocialImLogin.checkForbitLogin(user.getUID()+"");
		if(!forbitLogin){
			result.put("status", -1);  //\u7981\u6b62\u767b\u5f55
			result.put("errorMsg","\u5f53\u524d\u8d26\u53f7\u5df2\u88ab\u7981\u6b62\u767b\u5f55e-message");
		}else{
        
        if(user != null) {
            // \u6821\u9a8clicense\u662f\u5426\u6b63\u786e
            int checkLicense = SocialImLogin.checkLience();
            // \u6388\u6743\u4fe1\u606f\u4e0d\u6b63\u786e \u6216\u8005 \u4e0d\u662fpc\u5176\u4ed6\u5730\u70b9\u767b\u5f55\uff0c\u4e0d\u5141\u8bb8\u767b\u5f55
            if(checkLicense == 1 || (checkLicense == 6 && SocialImLogin.checkOnlineStatus(user.getUID(), SocialImLogin.CLIENT_TYPE_PC) == 1)) {
                int userid = user.getUID();
                SocialImLogin.recordSocialIMSessionkey(userid, session.getId(), SocialImLogin.CLIENT_TYPE_PC);
                SocialImLogin.updateLoginTime(user.getUID(), SocialImLogin.CLIENT_TYPE_PC);
                SocialImLogin.setSysLogInfo(request, response);
                
                //\u68c0\u67e5\u7528\u6237\u662f\u5426\u9700\u8981\u4fee\u6539OA\u5bc6\u7801
                //if(SocialImLogin.checkIsNeedResetPassword(userid)) {
                //    result.put("status", -2);  //\u9700\u8981\u7528\u6237\u4fee\u6539\u5bc6\u7801\u540e\u624d\u80fd\u767b\u9646
            	//	result.put("errorMsg", "\u8bf7\u60a8\u63d0\u9ad8\u5bc6\u7801\u5f3a\u5ea6\uff0c\u5bc6\u7801\u4e0d\u5c11\u4e8e8\u4f4d\uff08\u5e76\u9700\u542b\u5b57\u6bcd\uff0c\u6570\u5b57\u53ca\u7279\u6b8a\u5b57\u7b26\uff09\uff01");
            	//	result.put("url", "/hrm/HrmTab.jsp?_fromURL=HrmResourcePassword");
            	//	result.put("sessionkey", session.getId());
                //} else {
                    //String userHead=ResourceComInfo.getMessagerUrls(String.valueOf(userid));
                    String userHead = SocialUtil.getUserHeadImage(String.valueOf(userid));
                    String userName = ResourceComInfo.getLastname(String.valueOf(userid));
                    boolean isAllowNewWin = SocialImLogin.checkAllowWindowDepart(String.valueOf(userid));
                    int isAllowNewWinNum = (isAllowNewWin==true?1:0);
                    result.put("userName",userName);
            		result.put("userHead",userHead);
            		result.put("status", 1);
            		result.put("errorMsg", SocialIMService.getErrorMsg(1, 7));
            		result.put("sessionkey", session.getId());
            		result.put("isAllowNewWin", isAllowNewWinNum);
                //}
            } else {
                result.put("status", -1);  //license\u9519\u8bef
        		result.put("errorMsg",SocialImLogin.getCheckLienceMsg(checkLicense, 7));
            }
        } else {
            result.put("status", 999);
    		result.put("errorMsg", "\u670d\u52a1\u5668\u5904\u7406\u626b\u7801\u767b\u5f55\u5f02\u5e38");
        }
		}
        Map<String, String> map = SocialImLogin.getBuildVersion();
    	result.put("buildversion", map.get("buildversion"));
    	result.put("osxBuildVersion", map.get("osxBuildVersion"));
    	result.put("xpbuildVersion", map.get("xpbuildVersion"));
    	result.put("runtimeVersion", map.get("runtimeVersion"));
    	String callback = Util.null2String(request.getParameter("callback"));
        if(callback.isEmpty()) {
        	out.println(result);
        } else {
            out.println(callback + "(" + result.toString() + ")");
        }
    }else if("getLanguage".equals(method)){
    	RecordSet recordSet = new RecordSet();
    	recordSet.execute("select language, id from syslanguage where activable = 1");
    	JSONArray lanAry = new JSONArray();
    	JSONObject lanObj = null;
    	while(recordSet.next()){
    		lanObj = new JSONObject();
    		lanObj.put("value",recordSet.getString("id"));
    		lanObj.put("text",recordSet.getString("language"));
    		lanAry.add(lanObj);
    	}
    	out.write(lanAry.toString());
    }else if("checkPwd".equals(method)){
    	FileUpload fu = new FileUpload(request);
        String loginId = Util.null2String(fu.getParameter("loginid"));
    	String sessionKey = Util.null2String(fu.getParameter("sessionKey"));
    	
        HrmResourceService hrs = new HrmResourceService();
        //\u83b7\u53d6\u5230oa\u7684id,\u8fd9\u4e2a\u65b9\u6cd5\u4e0d\u80fd\u518d\u6807\u51c6\u5b9e\u73b0
        /*
		String Oaloginid=hrs.getOaloginid();
        if(!loginId.equals(Oaloginid))
        	loginId = Oaloginid;
		*/
		int id = hrs.getUserId(loginId);
    	User user = hrs.getUserById(id);
    	//int id = user.getUID;
    	String userid = "" + id;
    	JSONObject result = new JSONObject();
       	ChgPasswdReminder reminder=new ChgPasswdReminder();
    	RemindSettings settings=reminder.getRemindSettings();
    	
    	String loginMustUpPswd = Util.null2String(settings.getLoginMustUpPswd());
    	String PasswordChangeReminderstr = Util.null2String(settings.getPasswordChangeReminder());
    	// log.writeLog("===========================loginMustUpPswd===="+loginMustUpPswd);
    	// log.writeLog("===========================PasswordChangeReminderstr===="+PasswordChangeReminderstr);
    	boolean PasswordChangeReminder = false;
    	if("1".equals(PasswordChangeReminderstr)){
    		PasswordChangeReminder = true;
    	}
    	int passwdReminder = 0;
    	if(PasswordChangeReminder){
    		passwdReminder = 1;
    	}
    	result.put("passwdReminder",passwdReminder+"");
    	String ChangePasswordDays = settings.getChangePasswordDays();
    	String DaysToRemind = settings.getDaysToRemind();
    	//User user= new User(id);
    	//\u8bbe\u7f6esession
    	//request.getSession(true).setAttribute("weaver_user@bean",user);
    	//\u8bbe\u7f6esessionKey
    	//SocialImLogin.recordSocialIMSessionkey(id,sessionKey,1);
    	String passwdchgdate = "";
    	int passwdchgeddate = 0;
    	int passwdreminddatenum = 0;
    	int passwdelse = 0;
    	String passwdreminddate = "";
    	String canpass = "0";
    	String canremind = "0";
    	
    	boolean isUpPswd = false;
    	RecordSet recordSet = new RecordSet();
    	//\u5224\u65ad\u662f\u5426\u5f00\u542f\u5f3a\u5236\u4fee\u6539\u5bc6\u7801
    	if("1".equals(loginMustUpPswd)){
    		//String loginSql="select COUNT(id) from HrmSysMaintenanceLog where relatedid = "+id+" and operatetype = 6 and operateitem = 60 and exists (select 1 from HrmResource where id = "+id+") and CAST(operatedesc as varchar"+(recordSet.getDBType().equals("oracle")?"2":"")+"(100)) = 'y'";
    		String loginSql = "select count(*) from hrmresource where haschangepwd = 'y' and id = "+id;
    		// log.writeLog("===========================loginSql===="+loginSql);
    		recordSet.executeSql(loginSql);
    		if(recordSet.next()) isUpPswd = recordSet.getInt(1) <= 0;
    	}
    	
    	if(isUpPswd){
    		result.put("isUpPswd","1");	
    	}else
    	{
    		result.put("isUpPswd","0");
    	}

    	if(user.isAdmin()){
    		result.put("isAdmin","1");
    	}else{
    		result.put("isAdmin","0");	
    	}
    	
    	String isadaccount="";
    	RecordSet recordSet1 = new RecordSet();
    	recordSet1.executeSql("select isadaccount from HrmResource where id = "+id);
    	if(recordSet1.next()){
    		isadaccount=Util.null2String(recordSet1.getString("isadaccount"));
    	}
    	if(isadaccount.equals("1")){  //ad\u7528\u6237 \u4e0d\u7528\u63d0\u9192
    		result.put("isAdaccount","1");
    	}else{
    		result.put("isAdaccount","0");
    	}
    	
    	if(!isUpPswd){
    		if(PasswordChangeReminder){
    			RecordSet recordSet2 = new RecordSet();
    			recordSet2.executeSql("select passwdchgdate from hrmresource where id = "+id);
    			if(recordSet2.next()){
    				passwdchgdate = recordSet2.getString(1);
    				passwdchgeddate = TimeUtil.dateInterval(passwdchgdate,TimeUtil.getCurrentDateString());
    				
    				if(passwdchgeddate < Integer.parseInt(ChangePasswordDays)){
    					canpass = "1";
    					result.put("canpass","1");
    				}
    				passwdreminddate = TimeUtil.dateAdd(passwdchgdate,Integer.parseInt(ChangePasswordDays)-Integer.parseInt(DaysToRemind));
    				try {
    					passwdreminddatenum = TimeUtil.dateInterval(passwdreminddate,TimeUtil.getCurrentDateString());
    				} catch(Exception ex) {
    					passwdreminddatenum = 0;
    				}
    				passwdelse = Integer.parseInt(DaysToRemind) - passwdreminddatenum;
    				result.put("passwdelse",passwdelse);
    				if(passwdreminddatenum >= 0){
    					canremind = "1";
    					result.put("canremind","1");				
    				}
    			}else{
    				result.put("canremind","0");
    				result.put("canpass","0");
    				result.put("passwdelse","0");
    			}
    		}else{
    			result.put("canremind","0");
    			result.put("canpass","0");
    			result.put("passwdelse","0");
    		}
    	}
    	out.println(result);  	
    }

      out.write(_jsp_string1, 0, _jsp_string1.length);
    } catch (java.lang.Throwable _jsp_e) {
      pageContext.handlePageException(_jsp_e);
    } finally {
      _jsp_application.getJspApplicationContext().freePageContext(pageContext);
    }
  }

  private java.util.ArrayList _caucho_depends = new java.util.ArrayList();

  public java.util.ArrayList _caucho_getDependList()
  {
    return _caucho_depends;
  }

  public void _caucho_addDepend(com.caucho.vfs.PersistentDependency depend)
  {
    super._caucho_addDepend(depend);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  public boolean _caucho_isModified()
  {
    if (_caucho_isDead)
      return true;
    if (com.caucho.server.util.CauchoSystem.getVersionId() != 1886798272571451039L)
      return true;
    for (int i = _caucho_depends.size() - 1; i >= 0; i--) {
      com.caucho.vfs.Dependency depend;
      depend = (com.caucho.vfs.Dependency) _caucho_depends.get(i);
      if (depend.isModified())
        return true;
    }
    return false;
  }

  public long _caucho_lastModified()
  {
    return 0;
  }

  public java.util.HashMap<String,java.lang.reflect.Method> _caucho_getFunctionMap()
  {
    return _jsp_functionMap;
  }

  public void init(ServletConfig config)
    throws ServletException
  {
    com.caucho.server.webapp.WebApp webApp
      = (com.caucho.server.webapp.WebApp) config.getServletContext();
    super.init(config);
    com.caucho.jsp.TaglibManager manager = webApp.getJspApplicationContext().getTaglibManager();
    com.caucho.jsp.PageContextImpl pageContext = new com.caucho.jsp.PageContextImpl(webApp, this);
  }

  public void destroy()
  {
      _caucho_isDead = true;
      super.destroy();
  }

  public void init(com.caucho.vfs.Path appDir)
    throws javax.servlet.ServletException
  {
    com.caucho.vfs.Path resinHome = com.caucho.server.util.CauchoSystem.getResinHome();
    com.caucho.vfs.MergePath mergePath = new com.caucho.vfs.MergePath();
    mergePath.addMergePath(appDir);
    mergePath.addMergePath(resinHome);
    com.caucho.loader.DynamicClassLoader loader;
    loader = (com.caucho.loader.DynamicClassLoader) getClass().getClassLoader();
    String resourcePath = loader.getResourcePathSpecificFirst();
    mergePath.addClassPath(resourcePath);
    com.caucho.vfs.Depend depend;
    depend = new com.caucho.vfs.Depend(appDir.lookup("social/SocialVerifyLogin.jsp"), -5947726523795808462L, false);
    com.caucho.jsp.JavaPage.addDepend(_caucho_depends, depend);
  }

  private final static char []_jsp_string2;
  private final static char []_jsp_string1;
  private final static char []_jsp_string0;
  static {
    _jsp_string2 = "\r\n\r\n\r\n\r\n".toCharArray();
    _jsp_string1 = "\r\n".toCharArray();
    _jsp_string0 = "\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n".toCharArray();
  }
}
